<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 10:12:42 -0700'>2018-06-22 10:12:42 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/lib/bosh/director /</small> agent_client.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">395</span><small> lines of codes</small></div>
              <div><span class="metric">42</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">6.5</span><small> complexity/method</small></div>
              <div><span class="metric">87</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">274.31</span><small> complexity</small></div>
              <div><span class="metric">0</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                49
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;bosh/director/agent_message_converter&#39;

module Bosh::Director
  class AgentClient<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient assumes too much for instance variable '@deadline'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Constants.md" target="_blank"><b>TooManyConstants</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient has 7 constants</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient has at least 8 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient has at least 41 methods</span>          </div>  </li></ol>

    PROTOCOL_VERSION = 3

    DEFAULT_POLL_INTERVAL = 1.0

    STOP_MESSAGE_TIMEOUT = 300 # 5 minutes
    SYNC_DNS_MESSAGE_TIMEOUT = 10

    # in case of timeout errors
    GET_TASK_MAX_RETRIES = 2

    # get_task should retry at least once because some long running tasks
    # (e.g. configure_networks) will restart the agent (current implementation)
    # which most likely will result in first get_task message being lost
    # because agent was not listening on NATS and second retry message
    # will probably be received because agent came back up.
    GET_STATE_MAX_RETRIES = 2

    UPLOAD_BLOB_MAX_RETRIES = 3

    attr_accessor :id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#id is a writable attribute</span>          </div>  </li></ol>

    def self.with_agent_id(agent_id, options = {})
      defaults = {
        retry_methods: {
          get_state: GET_STATE_MAX_RETRIES,
          get_task: GET_TASK_MAX_RETRIES,
          upload_blob: UPLOAD_BLOB_MAX_RETRIES,
        }
      }

      self.new(&#39;agent&#39;, agent_id, defaults.merge(options))
    end

    def initialize(service_name, client_id, options = {})
      @service_name = service_name
      @client_id = client_id
      @nats_rpc = Config.nats_rpc
      @timeout = options[:timeout] || 45
      @logger = Config.logger
      @retry_methods = options[:retry_methods] || {}
      @resource_manager = Api::ResourceManager.new
    end

    def method_missing(method_name, *args)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li></ol>
      handle_message_with_retry(method_name, *args)
    end

    def get_state(*args, &amp;blk)
      send_message(:get_state, *args, &amp;blk)
    end

    def cancel_task(*args)
      send_message(:cancel_task, *args)
    end

    def list_disk(*args)
      send_message(:list_disk, *args)
    end

    def associate_disks(*args)
      send_message(:associate_disks, *args)
    end

    def start(*args)
      send_message(:start, *args)
    end

    def prepare(*args)
      send_message(:prepare, *args)
    end

    def apply(*args)
      send_message(:apply, *args)
    end

    def compile_package(*args, &amp;blk)
      send_message(:compile_package, *args, &amp;blk)
    end

    def drain(*args)
      send_cancellable_message(:drain, *args)
    end

    def fetch_logs(*args)
      send_message(:fetch_logs, *args)
    end

    def migrate_disk(*args)
      send_message(:migrate_disk, *args)
    end

    def mount_disk(*args)
      send_message(:mount_disk, *args)
    end

    def unmount_disk(*args)
      send_message(:unmount_disk, *args)
    end

    def shutdown
      fire_and_forget(:shutdown)
    end

    def info(*args)
      begin
        send_message(:info, *args)
      rescue RpcRemoteException =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#info has the variable name 'e'</span>          </div>  </li></ol>
        if e.message =~ /unknown message/<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient tests 'e.message =~ /unknown message/' at least 4 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L113" class="js-smell-location">0</a>                  <a href="agent_client.html#L142" class="js-smell-location">1</a>                  <a href="agent_client.html#L158" class="js-smell-location">2</a>                  <a href="agent_client.html#L170" class="js-smell-location">3</a>                  </div>  </li></ol>
          @logger.warn(&quot;Ignoring info &#39;unknown message&#39; error from the agent: #{e.inspect}&quot;)
          { &#39;api_version&#39; =&gt; 0 }
        else
          raise
        end
      end
    end

    def delete_arp_entries(*args)
      fire_and_forget(:delete_arp_entries, *args)
    end

    def sync_dns(*args, &amp;blk)
      send_nats_request_quietly(:sync_dns, args, &amp;blk)
    end

    def cancel_sync_dns(request_id)
      @nats_rpc.cancel_request(request_id)
    end

    def upload_blob(blob_id, payload_checksum, encoded_payload)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#upload_blob has approx 7 statements</span>          </div>  </li></ol>
      begin
        send_message(:upload_blob, {
          &#39;blob_id&#39; =&gt; blob_id,
          &#39;checksum&#39; =&gt; payload_checksum,
          &#39;payload&#39; =&gt; encoded_payload,
        })
      rescue RpcRemoteException =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#upload_blob has the variable name 'e'</span>          </div>  </li></ol>
        if e.message =~ /unknown message/<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#upload_blob calls 'e.message' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L142" class="js-smell-location">0</a>                  <a href="agent_client.html#L145" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient tests 'e.message =~ /unknown message/' at least 4 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L113" class="js-smell-location">0</a>                  <a href="agent_client.html#L142" class="js-smell-location">1</a>                  <a href="agent_client.html#L158" class="js-smell-location">2</a>                  <a href="agent_client.html#L170" class="js-smell-location">3</a>                  </div>  </li></ol>
          @logger.warn(&quot;&#39;upload_blob&#39; &#39;unknown message&#39; error from the agent: #{e.inspect}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#upload_blob calls 'e.inspect' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L143" class="js-smell-location">0</a>                  <a href="agent_client.html#L146" class="js-smell-location">1</a>                  </div>  </li></ol>
          raise Bosh::Director::AgentUnsupportedAction, &#39;Unsupported action: upload_blob&#39;
        elsif e.message =~ /Opening blob store file: open \\var\\vcap\\data\\blobs.*: The system cannot find the path specified/<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#upload_blob calls 'e.message' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L142" class="js-smell-location">0</a>                  <a href="agent_client.html#L145" class="js-smell-location">1</a>                  </div>  </li></ol>
          @logger.warn(&quot;&#39;upload_blob&#39; error from the agent: #{e.inspect}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#upload_blob calls 'e.inspect' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L143" class="js-smell-location">0</a>                  <a href="agent_client.html#L146" class="js-smell-location">1</a>                  </div>  </li></ol>
          raise Bosh::Director::AgentUploadBlobUnableToOpenFile, &quot;&#39;Upload blob&#39; action: failed to open blob&quot;
        else
          raise
        end
      end
    end

    def update_settings(certs, disk_associations)
      begin
        send_message(:update_settings, {&#39;trusted_certs&#39; =&gt; certs, &#39;disk_associations&#39; =&gt; disk_associations })
      rescue RpcRemoteException =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#update_settings has the variable name 'e'</span>          </div>  </li></ol>
        if e.message =~ /unknown message/<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient tests 'e.message =~ /unknown message/' at least 4 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L113" class="js-smell-location">0</a>                  <a href="agent_client.html#L142" class="js-smell-location">1</a>                  <a href="agent_client.html#L158" class="js-smell-location">2</a>                  <a href="agent_client.html#L170" class="js-smell-location">3</a>                  </div>  </li></ol>
          @logger.warn(&quot;Ignoring update_settings &#39;unknown message&#39; error from the agent: #{e.inspect}&quot;)
        else
          raise
        end
      end
    end

    def run_script(script_name, options)
      begin
        send_message(:run_script, script_name, options)
      rescue RpcRemoteException =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#run_script has the variable name 'e'</span>          </div>  </li></ol>
        if e.message =~ /unknown message/<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient tests 'e.message =~ /unknown message/' at least 4 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L113" class="js-smell-location">0</a>                  <a href="agent_client.html#L142" class="js-smell-location">1</a>                  <a href="agent_client.html#L158" class="js-smell-location">2</a>                  <a href="agent_client.html#L170" class="js-smell-location">3</a>                  </div>  </li></ol>
          @logger.warn(&quot;Ignoring run_script &#39;unknown message&#39; error from the agent: #{e.inspect}. Received while trying to run: #{script_name}&quot;)
        else
          raise
        end
      end
    end

    def stop(*args)
      timeout = Timeout.new(STOP_MESSAGE_TIMEOUT)
      begin
        send_message_with_timeout(:stop, timeout, *args)
      rescue Exception =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#stop has the variable name 'e'</span>          </div>  </li></ol>
        if e.message.include? &#39;Timed out waiting for service&#39;
          @logger.warn(&quot;Ignoring stop timeout error from the agent: #{e.inspect}&quot;)
        else
          raise
        end
      end
    end

    def run_errand(*args)
      start_task(:run_errand, *args)
    end

    def wait_for_task(agent_task_id, timeout = nil, &amp;blk)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_for_task has approx 7 statements</span>          </div>  </li></ol>
      task = get_task_status(agent_task_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_for_task calls 'get_task_status(agent_task_id)' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L196" class="js-smell-location">0</a>                  <a href="agent_client.html#L202" class="js-smell-location">1</a>                  </div>  </li></ol>
      timed_out = false

      until task[&#39;state&#39;] != &#39;running&#39; || (timeout &amp;&amp; timed_out = timeout.timed_out?)
        blk.call if block_given?
        sleep(DEFAULT_POLL_INTERVAL)
        task = get_task_status(agent_task_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_for_task calls 'get_task_status(agent_task_id)' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L196" class="js-smell-location">0</a>                  <a href="agent_client.html#L202" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      @logger.debug(&quot;Task #{agent_task_id} timed out&quot;) if timed_out

      task[&#39;value&#39;]
    end

    def wait_until_ready(deadline = Config.agent_wait_timeout)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready has a flog score of 28</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready has approx 13 statements</span>          </div>  </li></ol>
      old_timeout = @timeout
      @timeout = 1.0
      @deadline = Time.now.to_i + deadline<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'Time.now' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L213" class="js-smell-location">0</a>                  <a href="agent_client.html#L222" class="js-smell-location">1</a>                  <a href="agent_client.html#L225" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'Time.now.to_i' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L213" class="js-smell-location">0</a>                  <a href="agent_client.html#L222" class="js-smell-location">1</a>                  <a href="agent_client.html#L225" class="js-smell-location">2</a>                  </div>  </li></ol>

      begin
        Config.job_cancelled?
        ping
      rescue TaskCancelled =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready has the variable name 'e'</span>              <span>Locations:</span>                  <a href="agent_client.html#L218" class="js-smell-location">0</a>                  <a href="agent_client.html#L224" class="js-smell-location">1</a>                  </div>  </li></ol>
        @logger.debug(&#39;Task was cancelled. Stop waiting response from vm&#39;)
        raise e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'raise e' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L220" class="js-smell-location">0</a>                  <a href="agent_client.html#L226" class="js-smell-location">1</a>                  </div>  </li></ol>
      rescue RpcTimeout
        retry if @deadline - Time.now.to_i &gt; 0<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls '@deadline - Time.now.to_i > 0' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L222" class="js-smell-location">0</a>                  <a href="agent_client.html#L225" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls '@deadline - Time.now.to_i' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L222" class="js-smell-location">0</a>                  <a href="agent_client.html#L225" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'Time.now' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L213" class="js-smell-location">0</a>                  <a href="agent_client.html#L222" class="js-smell-location">1</a>                  <a href="agent_client.html#L225" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'Time.now.to_i' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L213" class="js-smell-location">0</a>                  <a href="agent_client.html#L222" class="js-smell-location">1</a>                  <a href="agent_client.html#L225" class="js-smell-location">2</a>                  </div>  </li></ol>
        raise RpcTimeout, &quot;Timed out pinging to #{@client_id} after #{deadline} seconds&quot;
      rescue RpcRemoteException =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready has the variable name 'e'</span>              <span>Locations:</span>                  <a href="agent_client.html#L218" class="js-smell-location">0</a>                  <a href="agent_client.html#L224" class="js-smell-location">1</a>                  </div>  </li></ol>
        retry if e.message =~ /^restarting agent/ &amp;&amp; @deadline - Time.now.to_i &gt; 0<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls '@deadline - Time.now.to_i > 0' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L222" class="js-smell-location">0</a>                  <a href="agent_client.html#L225" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls '@deadline - Time.now.to_i' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L222" class="js-smell-location">0</a>                  <a href="agent_client.html#L225" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'Time.now' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L213" class="js-smell-location">0</a>                  <a href="agent_client.html#L222" class="js-smell-location">1</a>                  <a href="agent_client.html#L225" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'Time.now.to_i' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L213" class="js-smell-location">0</a>                  <a href="agent_client.html#L222" class="js-smell-location">1</a>                  <a href="agent_client.html#L225" class="js-smell-location">2</a>                  </div>  </li></ol>
        raise e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#wait_until_ready calls 'raise e' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L220" class="js-smell-location">0</a>                  <a href="agent_client.html#L226" class="js-smell-location">1</a>                  </div>  </li></ol>
      ensure
        @timeout = old_timeout
      end
    end

    def send_nats_request_with_options(method_name, args, options, &amp;callback)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li></ol>
      request = { :protocol =&gt; PROTOCOL_VERSION, :method =&gt; method_name, :arguments =&gt; args }
      recipient = &quot;#{@service_name}.#{@client_id}&quot;
      @nats_rpc.send_request(recipient, @client_id, request, options, &amp;callback)
    end

    def send_nats_request_quietly(method_name, args, &amp;callback)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li></ol>
      send_nats_request_with_options(method_name, args, { &#39;logging&#39; =&gt; false }, &amp;callback)
    end

    def send_nats_request(method_name, args, &amp;callback)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li></ol>
      send_nats_request_with_options(method_name, args, { &#39;logging&#39; =&gt; true }, &amp;callback)
    end

    def handle_method(method_name, args, &amp;blk)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method has a flog score of 43</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method has approx 20 statements</span>          </div>  </li></ol>
      result = {}
      result.extend(MonitorMixin)

      cond = result.new_cond
      timeout_time = Time.now.to_f + @timeout<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L251" class="js-smell-location">0</a>                  <a href="agent_client.html#L263" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls 'Time.now.to_f' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L251" class="js-smell-location">0</a>                  <a href="agent_client.html#L263" class="js-smell-location">1</a>                  </div>  </li></ol>

      request_id = send_nats_request(method_name, args) do |response|
        result.synchronize do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls 'result.synchronize' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L254" class="js-smell-location">0</a>                  <a href="agent_client.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
          inject_compile_log(response)
          result.merge!(response)
          cond.signal
        end
      end

      result.synchronize do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls 'result.synchronize' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L254" class="js-smell-location">0</a>                  <a href="agent_client.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
        while result.empty?
          timeout = timeout_time - Time.now.to_f<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L251" class="js-smell-location">0</a>                  <a href="agent_client.html#L263" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls 'Time.now.to_f' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L251" class="js-smell-location">0</a>                  <a href="agent_client.html#L263" class="js-smell-location">1</a>                  </div>  </li></ol>
          begin
            blk.call if block_given?
          rescue TaskCancelled =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method has the variable name 'e'</span>          </div>  </li></ol>
            @nats_rpc.cancel_request(request_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls '@nats_rpc.cancel_request(request_id)' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L267" class="js-smell-location">0</a>                  <a href="agent_client.html#L271" class="js-smell-location">1</a>                  </div>  </li></ol>
            raise e
          end
          if timeout &lt;= 0
            @nats_rpc.cancel_request(request_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#handle_method calls '@nats_rpc.cancel_request(request_id)' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L267" class="js-smell-location">0</a>                  <a href="agent_client.html#L271" class="js-smell-location">1</a>                  </div>  </li></ol>
            raise RpcTimeout,
              &quot;Timed out sending &#39;#{method_name}&#39; to #{@client_id} &quot; +
                &quot;after #{@timeout} seconds&quot;
          end
          cond.wait(timeout)
        end
      end

      if result.has_key?(&#39;exception&#39;)
        raise RpcRemoteException, format_exception(result[&#39;exception&#39;])
      end

      result[&#39;value&#39;]
    end

    # Returns formatted exception information
    # @param [Hash|#to_s] exception Serialized exception
    # @return [String]
    def format_exception(exception)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception has approx 8 statements</span>          </div>  </li></ol>
      return exception.to_s unless exception.is_a?(Hash)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception refers to 'exception' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L291" class="js-smell-location">0</a>                  <a href="agent_client.html#L293" class="js-smell-location">1</a>                  <a href="agent_client.html#L295" class="js-smell-location">2</a>                  <a href="agent_client.html#L297" class="js-smell-location">3</a>                  <a href="agent_client.html#L300" class="js-smell-location">4</a>                  <a href="agent_client.html#L301" class="js-smell-location">5</a>                  </div>  </li></ol>

      msg = exception[&#39;message&#39;].to_s<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception refers to 'exception' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L291" class="js-smell-location">0</a>                  <a href="agent_client.html#L293" class="js-smell-location">1</a>                  <a href="agent_client.html#L295" class="js-smell-location">2</a>                  <a href="agent_client.html#L297" class="js-smell-location">3</a>                  <a href="agent_client.html#L300" class="js-smell-location">4</a>                  <a href="agent_client.html#L301" class="js-smell-location">5</a>                  </div>  </li></ol>

      if exception[&#39;backtrace&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception calls 'exception['backtrace']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L295" class="js-smell-location">0</a>                  <a href="agent_client.html#L297" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception refers to 'exception' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L291" class="js-smell-location">0</a>                  <a href="agent_client.html#L293" class="js-smell-location">1</a>                  <a href="agent_client.html#L295" class="js-smell-location">2</a>                  <a href="agent_client.html#L297" class="js-smell-location">3</a>                  <a href="agent_client.html#L300" class="js-smell-location">4</a>                  <a href="agent_client.html#L301" class="js-smell-location">5</a>                  </div>  </li></ol>
        msg += &quot;\n&quot;
        msg += Array(exception[&#39;backtrace&#39;]).join(&quot;\n&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception calls 'exception['backtrace']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L295" class="js-smell-location">0</a>                  <a href="agent_client.html#L297" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception refers to 'exception' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L291" class="js-smell-location">0</a>                  <a href="agent_client.html#L293" class="js-smell-location">1</a>                  <a href="agent_client.html#L295" class="js-smell-location">2</a>                  <a href="agent_client.html#L297" class="js-smell-location">3</a>                  <a href="agent_client.html#L300" class="js-smell-location">4</a>                  <a href="agent_client.html#L301" class="js-smell-location">5</a>                  </div>  </li></ol>
      end

      if exception[&#39;blobstore_id&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception calls 'exception['blobstore_id']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L300" class="js-smell-location">0</a>                  <a href="agent_client.html#L301" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception refers to 'exception' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L291" class="js-smell-location">0</a>                  <a href="agent_client.html#L293" class="js-smell-location">1</a>                  <a href="agent_client.html#L295" class="js-smell-location">2</a>                  <a href="agent_client.html#L297" class="js-smell-location">3</a>                  <a href="agent_client.html#L300" class="js-smell-location">4</a>                  <a href="agent_client.html#L301" class="js-smell-location">5</a>                  </div>  </li></ol>
        blob = download_and_delete_blob(exception[&#39;blobstore_id&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception calls 'exception['blobstore_id']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L300" class="js-smell-location">0</a>                  <a href="agent_client.html#L301" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#format_exception refers to 'exception' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L291" class="js-smell-location">0</a>                  <a href="agent_client.html#L293" class="js-smell-location">1</a>                  <a href="agent_client.html#L295" class="js-smell-location">2</a>                  <a href="agent_client.html#L297" class="js-smell-location">3</a>                  <a href="agent_client.html#L300" class="js-smell-location">4</a>                  <a href="agent_client.html#L301" class="js-smell-location">5</a>                  </div>  </li></ol>
        msg += &quot;\n&quot;
        msg += blob.to_s
      end

      msg
    end

    private

    # the blob is removed from the blobstore once we have fetched it,
    # but if there is a crash before it is injected into the response
    # and then logged, there is a chance that we lose it
    def inject_compile_log(response)
      if response[&#39;value&#39;] &amp;&amp; response[&#39;value&#39;].is_a?(Hash) &amp;&amp;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log calls 'response['value']' 5 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log refers to 'response' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li></ol>
        response[&#39;value&#39;][&#39;result&#39;].is_a?(Hash) &amp;&amp;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log calls 'response['value']' 5 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log calls 'response['value']['result']' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L316" class="js-smell-location">0</a>                  <a href="agent_client.html#L317" class="js-smell-location">1</a>                  <a href="agent_client.html#L319" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log refers to 'response' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li></ol>
        blob_id = response[&#39;value&#39;][&#39;result&#39;][&#39;compile_log_id&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log calls 'response['value']' 5 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log calls 'response['value']['result']' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L316" class="js-smell-location">0</a>                  <a href="agent_client.html#L317" class="js-smell-location">1</a>                  <a href="agent_client.html#L319" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log refers to 'response' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li></ol>
        compile_log = download_and_delete_blob(blob_id)
        response[&#39;value&#39;][&#39;result&#39;][&#39;compile_log&#39;] = compile_log<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log calls 'response['value']' 5 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log calls 'response['value']['result']' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L316" class="js-smell-location">0</a>                  <a href="agent_client.html#L317" class="js-smell-location">1</a>                  <a href="agent_client.html#L319" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#inject_compile_log refers to 'response' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L315" class="js-smell-location">0</a>                  <a href="agent_client.html#L316" class="js-smell-location">1</a>                  <a href="agent_client.html#L317" class="js-smell-location">2</a>                  <a href="agent_client.html#L319" class="js-smell-location">3</a>                  </div>  </li></ol>
      end
    end

    # Downloads blob and ensures it&#39;s deleted from the blobstore
    # @param [String] blob_id Blob id
    # @return [String] Blob contents
    def download_and_delete_blob(blob_id)
      blob = @resource_manager.get_resource(blob_id)
      blob
    ensure
      @resource_manager.delete_resource(blob_id)
    end

    def handle_message_with_retry(message_name, *args, &amp;blk)
      retries = @retry_methods[message_name] || 0
      begin
        handle_method(message_name, args, &amp;blk)
      rescue RpcTimeout
        if retries &gt; 0
          retries -= 1
          retry
        end
        raise
      end
    end

    def fire_and_forget(message_name, *args)
      request_id = send_nats_request_quietly(message_name, args)
      @nats_rpc.cancel_request(request_id)
    rescue =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#fire_and_forget has the variable name 'e'</span>          </div>  </li></ol>
      @logger.warn(&quot;Ignoring &#39;#{e.message}&#39; error from the agent: #{e.inspect}. Received while trying to run: #{message_name} on client: &#39;#{@client_id}&#39;&quot;)
    end

    def send_message(method_name, *args, &amp;blk)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li></ol>
      task = start_task(method_name, *args, &amp;blk)
      if task[&#39;agent_task_id&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message calls 'task['agent_task_id']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L356" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message refers to 'task' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L356" class="js-smell-location">1</a>                  <a href="agent_client.html#L358" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient tests 'task['agent_task_id']' at least 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L365" class="js-smell-location">1</a>                  <a href="agent_client.html#L374" class="js-smell-location">2</a>                  </div>  </li></ol>
        wait_for_task(task[&#39;agent_task_id&#39;], &amp;blk)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message calls 'task['agent_task_id']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L356" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message refers to 'task' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L356" class="js-smell-location">1</a>                  <a href="agent_client.html#L358" class="js-smell-location">2</a>                  </div>  </li></ol>
      else
        task[&#39;value&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message refers to 'task' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L356" class="js-smell-location">1</a>                  <a href="agent_client.html#L358" class="js-smell-location">2</a>                  </div>  </li></ol>
      end
    end

    def send_message_with_timeout(method_name, timeout, *args, &amp;blk)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li></ol>
      task = start_task(method_name, *args)

      if task[&#39;agent_task_id&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message_with_timeout calls 'task['agent_task_id']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L365" class="js-smell-location">0</a>                  <a href="agent_client.html#L366" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message_with_timeout refers to 'task' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L365" class="js-smell-location">0</a>                  <a href="agent_client.html#L366" class="js-smell-location">1</a>                  <a href="agent_client.html#L368" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient tests 'task['agent_task_id']' at least 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L365" class="js-smell-location">1</a>                  <a href="agent_client.html#L374" class="js-smell-location">2</a>                  </div>  </li></ol>
        wait_for_task(task[&#39;agent_task_id&#39;], timeout, &amp;blk)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message_with_timeout calls 'task['agent_task_id']' 2 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L365" class="js-smell-location">0</a>                  <a href="agent_client.html#L366" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message_with_timeout refers to 'task' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L365" class="js-smell-location">0</a>                  <a href="agent_client.html#L366" class="js-smell-location">1</a>                  <a href="agent_client.html#L368" class="js-smell-location">2</a>                  </div>  </li></ol>
      else
        task[&#39;value&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_message_with_timeout refers to 'task' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="agent_client.html#L365" class="js-smell-location">0</a>                  <a href="agent_client.html#L366" class="js-smell-location">1</a>                  <a href="agent_client.html#L368" class="js-smell-location">2</a>                  </div>  </li></ol>
      end
    end

    def send_cancellable_message(method_name, *args)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_cancellable_message has approx 7 statements</span>          </div>  </li></ol>
      task = start_task(method_name, *args)
      if task[&#39;agent_task_id&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_cancellable_message calls 'task['agent_task_id']' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L374" class="js-smell-location">0</a>                  <a href="agent_client.html#L376" class="js-smell-location">1</a>                  <a href="agent_client.html#L378" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient tests 'task['agent_task_id']' at least 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L355" class="js-smell-location">0</a>                  <a href="agent_client.html#L365" class="js-smell-location">1</a>                  <a href="agent_client.html#L374" class="js-smell-location">2</a>                  </div>  </li></ol>
        begin
          wait_for_task(task[&#39;agent_task_id&#39;]) { Config.job_cancelled? }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_cancellable_message calls 'task['agent_task_id']' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L374" class="js-smell-location">0</a>                  <a href="agent_client.html#L376" class="js-smell-location">1</a>                  <a href="agent_client.html#L378" class="js-smell-location">2</a>                  </div>  </li></ol>
        rescue TaskCancelled =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_cancellable_message has the variable name 'e'</span>          </div>  </li></ol>
          cancel_task(task[&#39;agent_task_id&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient#send_cancellable_message calls 'task['agent_task_id']' 3 times</span>              <span>Locations:</span>                  <a href="agent_client.html#L374" class="js-smell-location">0</a>                  <a href="agent_client.html#L376" class="js-smell-location">1</a>                  <a href="agent_client.html#L378" class="js-smell-location">2</a>                  </div>  </li></ol>
          raise e
        end
      else
        task[&#39;value&#39;]
      end
    end


    def start_task(method_name, *args, &amp;blk)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Data-Clump.md" target="_blank"><b>DataClump</b></a>        </span>      </div>      <span>Bosh::Director::AgentClient takes parameters ['args', 'method_name'] to 9 methods</span>              <span>Locations:</span>                  <a href="agent_client.html#L49" class="js-smell-location">0</a>                  <a href="agent_client.html#L232" class="js-smell-location">1</a>                  <a href="agent_client.html#L238" class="js-smell-location">2</a>                  <a href="agent_client.html#L242" class="js-smell-location">3</a>                  <a href="agent_client.html#L246" class="js-smell-location">4</a>                  <a href="agent_client.html#L353" class="js-smell-location">5</a>                  <a href="agent_client.html#L362" class="js-smell-location">6</a>                  <a href="agent_client.html#L372" class="js-smell-location">7</a>                  <a href="agent_client.html#L387" class="js-smell-location">8</a>                  </div>  </li></ol>
      AgentMessageConverter.convert_old_message_to_new(handle_message_with_retry(method_name, *args, &amp;blk))
    end

    def get_task_status(agent_task_id)
      AgentMessageConverter.convert_old_message_to_new(get_task(agent_task_id))
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
