<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-02-27 10:16:57 -0500'>2018-02-27 10:16:57 -0500</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec /</small> spec_helper.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">362</span><small> lines of codes</small></div>
              <div><span class="metric">23</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">14.3</span><small> complexity/method</small></div>
              <div><span class="metric">131</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">329.22</span><small> complexity</small></div>
              <div><span class="metric">199</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                41
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">$: &lt;&lt; File.expand_path(&#39;..&#39;, __FILE__)

require File.expand_path(&#39;../../../spec/shared/spec_helper&#39;, __FILE__)
require File.expand_path(&#39;../../../spec/support/new_deployments.rb&#39;, __FILE__)

require &#39;digest/sha1&#39;
require &#39;fileutils&#39;
require &#39;logging&#39;
require &#39;pg&#39;
require &#39;tempfile&#39;
require &#39;tmpdir&#39;
require &#39;zlib&#39;
require &#39;timecop&#39;

require &#39;archive/tar/minitar&#39;
require &#39;machinist/sequel&#39;
require &#39;sham&#39;
require &#39;support/buffered_logger&#39;

Dir.glob(File.expand_path(&#39;../support/**/*.rb&#39;, __FILE__)).each { |f| require(f) }

DIRECTOR_TEST_CERTS=&quot;these\nare\nthe\ncerts&quot;
DIRECTOR_TEST_CERTS_SHA1=::Digest::SHA1.hexdigest DIRECTOR_TEST_CERTS

RSpec.configure do |config|
  config.include Bosh::Director::Test::TaskHelpers
end

module SpecHelper<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>SpecHelper has no descriptive comment</span>          </div>  </li></ol>
  class &lt;&lt; self
    include BufferedLogger

    attr_accessor :temp_dir<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>SpecHelper#temp_dir is a writable attribute</span>          </div>  </li></ol>

    def init<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>SpecHelper#init has approx 6 statements</span>          </div>  </li></ol>
      ENV[&#39;RACK_ENV&#39;] = &#39;test&#39;
      configure_init_logger
      configure_temp_dir

      require &#39;bosh/director&#39;

      init_database

      require &#39;blueprints&#39;
    end

    # init_logger is only used before the tests start.
    # Inside each test BufferedLogger will be used.
    def configure_init_logger
      file_path = File.expand_path(&#39;/tmp/spec.log&#39;, __FILE__)

      @init_logger = Logging::Logger.new(&#39;TestLogger&#39;)
      @init_logger.add_appenders(
        Logging.appenders.file(
          &#39;TestLogFile&#39;,
          filename: file_path,
          layout: ThreadFormatter.layout
        )
      )
      @init_logger.level = :debug
    end

    def configure_temp_dir
      @temp_dir = Bosh::Director::Config.generate_temp_dir
    end

    def spec_get_director_config<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>SpecHelper::spec_get_director_config has a flog score of 43</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config has approx 11 statements</span>          </div>  </li></ol>
      config = YAML.load_file(File.expand_path(&#39;assets/test-director-config.yml&#39;, File.dirname(__FILE__)))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'File.dirname(__FILE__)' 4 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L68" class="js-smell-location">0</a>                  <a href="spec_helper.html#L70" class="js-smell-location">1</a>                  <a href="spec_helper.html#L71" class="js-smell-location">2</a>                  <a href="spec_helper.html#L72" class="js-smell-location">3</a>                  </div>  </li></ol>

      config[&#39;nats&#39;][&#39;server_ca_path&#39;] = File.expand_path(&#39;assets/nats/nats_ca.pem&#39;, File.dirname(__FILE__))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'File.dirname(__FILE__)' 4 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L68" class="js-smell-location">0</a>                  <a href="spec_helper.html#L70" class="js-smell-location">1</a>                  <a href="spec_helper.html#L71" class="js-smell-location">2</a>                  <a href="spec_helper.html#L72" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['nats']' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L70" class="js-smell-location">0</a>                  <a href="spec_helper.html#L71" class="js-smell-location">1</a>                  <a href="spec_helper.html#L72" class="js-smell-location">2</a>                  </div>  </li></ol>
      config[&#39;nats&#39;][&#39;client_ca_certificate_path&#39;] = File.expand_path(&#39;assets/nats/nats_ca_certificate.pem&#39;, File.dirname(__FILE__))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'File.dirname(__FILE__)' 4 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L68" class="js-smell-location">0</a>                  <a href="spec_helper.html#L70" class="js-smell-location">1</a>                  <a href="spec_helper.html#L71" class="js-smell-location">2</a>                  <a href="spec_helper.html#L72" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['nats']' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L70" class="js-smell-location">0</a>                  <a href="spec_helper.html#L71" class="js-smell-location">1</a>                  <a href="spec_helper.html#L72" class="js-smell-location">2</a>                  </div>  </li></ol>
      config[&#39;nats&#39;][&#39;client_ca_private_key_path&#39;] = File.expand_path(&#39;assets/nats/nats_ca_private_key.pem&#39;, File.dirname(__FILE__))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'File.dirname(__FILE__)' 4 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L68" class="js-smell-location">0</a>                  <a href="spec_helper.html#L70" class="js-smell-location">1</a>                  <a href="spec_helper.html#L71" class="js-smell-location">2</a>                  <a href="spec_helper.html#L72" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['nats']' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L70" class="js-smell-location">0</a>                  <a href="spec_helper.html#L71" class="js-smell-location">1</a>                  <a href="spec_helper.html#L72" class="js-smell-location">2</a>                  </div>  </li></ol>
      config[&#39;db&#39;][&#39;adapter&#39;] = @director_db_helper.adapter<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['db']' 6 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L73" class="js-smell-location">0</a>                  <a href="spec_helper.html#L74" class="js-smell-location">1</a>                  <a href="spec_helper.html#L75" class="js-smell-location">2</a>                  <a href="spec_helper.html#L76" class="js-smell-location">3</a>                  <a href="spec_helper.html#L77" class="js-smell-location">4</a>                  <a href="spec_helper.html#L78" class="js-smell-location">5</a>                  </div>  </li></ol>
      config[&#39;db&#39;][&#39;host&#39;] = @director_db_helper.host<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['db']' 6 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L73" class="js-smell-location">0</a>                  <a href="spec_helper.html#L74" class="js-smell-location">1</a>                  <a href="spec_helper.html#L75" class="js-smell-location">2</a>                  <a href="spec_helper.html#L76" class="js-smell-location">3</a>                  <a href="spec_helper.html#L77" class="js-smell-location">4</a>                  <a href="spec_helper.html#L78" class="js-smell-location">5</a>                  </div>  </li></ol>
      config[&#39;db&#39;][&#39;database&#39;] = @director_db_helper.db_name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['db']' 6 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L73" class="js-smell-location">0</a>                  <a href="spec_helper.html#L74" class="js-smell-location">1</a>                  <a href="spec_helper.html#L75" class="js-smell-location">2</a>                  <a href="spec_helper.html#L76" class="js-smell-location">3</a>                  <a href="spec_helper.html#L77" class="js-smell-location">4</a>                  <a href="spec_helper.html#L78" class="js-smell-location">5</a>                  </div>  </li></ol>
      config[&#39;db&#39;][&#39;user&#39;] = @director_db_helper.username<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['db']' 6 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L73" class="js-smell-location">0</a>                  <a href="spec_helper.html#L74" class="js-smell-location">1</a>                  <a href="spec_helper.html#L75" class="js-smell-location">2</a>                  <a href="spec_helper.html#L76" class="js-smell-location">3</a>                  <a href="spec_helper.html#L77" class="js-smell-location">4</a>                  <a href="spec_helper.html#L78" class="js-smell-location">5</a>                  </div>  </li></ol>
      config[&#39;db&#39;][&#39;password&#39;] = @director_db_helper.password<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['db']' 6 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L73" class="js-smell-location">0</a>                  <a href="spec_helper.html#L74" class="js-smell-location">1</a>                  <a href="spec_helper.html#L75" class="js-smell-location">2</a>                  <a href="spec_helper.html#L76" class="js-smell-location">3</a>                  <a href="spec_helper.html#L77" class="js-smell-location">4</a>                  <a href="spec_helper.html#L78" class="js-smell-location">5</a>                  </div>  </li></ol>
      config[&#39;db&#39;][&#39;port&#39;] = @director_db_helper.port<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#spec_get_director_config calls 'config['db']' 6 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L73" class="js-smell-location">0</a>                  <a href="spec_helper.html#L74" class="js-smell-location">1</a>                  <a href="spec_helper.html#L75" class="js-smell-location">2</a>                  <a href="spec_helper.html#L76" class="js-smell-location">3</a>                  <a href="spec_helper.html#L77" class="js-smell-location">4</a>                  <a href="spec_helper.html#L78" class="js-smell-location">5</a>                  </div>  </li></ol>

      config
    end

    def init_database<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>SpecHelper::init_database has a flog score of 74</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>SpecHelper#init_database has approx 24 statements</span>          </div>  </li></ol>
      @db_name = SecureRandom.uuid.gsub(&#39;-&#39;, &#39;&#39;)

      db_options = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="db_spec_helper.html#L27" class="js-smell-location">0</a>                  <a href="spec_helper.html#L86" class="js-smell-location">1</a>                  </div>  </li></ol>
        username: ENV[&#39;DB_USER&#39;],
        password: ENV[&#39;DB_PASSWORD&#39;],
        host: ENV[&#39;DB_HOST&#39;] || &#39;127.0.0.1&#39;,
      }.compact

      case ENV.fetch(&#39;DB&#39;, &#39;sqlite&#39;)
        when &#39;postgresql&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="spec_helper.html#L93" class="js-smell-location">0</a>                  <a href="spec_helper.html#L99" class="js-smell-location">1</a>                  </div>  </li></ol>
          require File.expand_path(&#39;../../bosh-dev/lib/bosh/dev/sandbox/postgresql&#39;, File.dirname(__FILE__))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#init_database calls 'File.dirname(__FILE__)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L94" class="js-smell-location">0</a>                  <a href="spec_helper.html#L100" class="js-smell-location">1</a>                  <a href="spec_helper.html#L106" class="js-smell-location">2</a>                  </div>  </li></ol>
          db_options[:port] = 5432

          @director_db_helper = Bosh::Dev::Sandbox::Postgresql.new(&quot;#{@db_name}_director&quot;, Bosh::Core::Shell.new, @init_logger, db_options)
          @dns_db_helper = Bosh::Dev::Sandbox::Postgresql.new(&quot;#{@db_name}_dns&quot;, Bosh::Core::Shell.new, @init_logger, db_options)
        when &#39;mysql&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="spec_helper.html#L93" class="js-smell-location">0</a>                  <a href="spec_helper.html#L99" class="js-smell-location">1</a>                  </div>  </li></ol>
          require File.expand_path(&#39;../../bosh-dev/lib/bosh/dev/sandbox/mysql&#39;, File.dirname(__FILE__))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#init_database calls 'File.dirname(__FILE__)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L94" class="js-smell-location">0</a>                  <a href="spec_helper.html#L100" class="js-smell-location">1</a>                  <a href="spec_helper.html#L106" class="js-smell-location">2</a>                  </div>  </li></ol>
          db_options[:port] = 3306

          @director_db_helper = Bosh::Dev::Sandbox::Mysql.new(&quot;#{@db_name}_director&quot;,  Bosh::Core::Shell.new, @init_logger, db_options)
          @dns_db_helper = Bosh::Dev::Sandbox::Mysql.new(&quot;#{@db_name}_dns&quot;,  Bosh::Core::Shell.new, @init_logger, db_options)
        when &#39;sqlite&#39;
          require File.expand_path(&#39;../../bosh-dev/lib/bosh/dev/sandbox/sqlite&#39;, File.dirname(__FILE__))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#init_database calls 'File.dirname(__FILE__)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L94" class="js-smell-location">0</a>                  <a href="spec_helper.html#L100" class="js-smell-location">1</a>                  <a href="spec_helper.html#L106" class="js-smell-location">2</a>                  </div>  </li></ol>
          @director_db_helper = Bosh::Dev::Sandbox::Sqlite.new(File.join(@temp_dir, &quot;#{@db_name}_director.sqlite&quot;), @init_logger)
          @dns_db_helper = Bosh::Dev::Sandbox::Sqlite.new(File.join(@temp_dir, &quot;#{@db_name}_dns.sqlite&quot;), @init_logger)
        else
          raise &quot;Unsupported DB value: #{ENV[&#39;DB&#39;]}&quot;
      end

      @director_db_helper.create_db
      @dns_db_helper.create_db

      @dns_migrations = File.expand_path(&#39;../../db/migrations/dns&#39;, __FILE__)
      @director_migrations = File.expand_path(&#39;../../db/migrations/director&#39;, __FILE__)
      Sequel.extension :migration

      connect_database

      Sequel::Deprecation.output = false
      Delayed::Worker.backend = :sequel
      Sequel::Deprecation.output = $stderr

      run_migrations
    end

    def connect_database<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>SpecHelper#connect_database has approx 10 statements</span>          </div>  </li></ol>
      db_opts = {:max_connections =&gt; 32, :pool_timeout =&gt; 10}

      Sequel.default_timezone = :utc
      @director_db = Sequel.connect(@director_db_helper.connection_string, db_opts)
      @director_db.loggers &lt;&lt; (logger || @init_logger)
      @director_db.log_connection_info = true
      Bosh::Director::Config.db = @director_db

      @dns_db = Sequel.connect(@dns_db_helper.connection_string, db_opts)
      @dns_db.loggers &lt;&lt; (logger || @init_logger)
      @dns_db.log_connection_info = true
      Bosh::Director::Config.dns_db = @dns_db
    end

    def disconnect_database<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>SpecHelper#disconnect_database has approx 8 statements</span>          </div>  </li></ol>
      if @director_db
        @director_db.disconnect
        @director_db_helper.drop_db

        @director_db = nil
        @director_db_helper = nil
      end

      if @dns_db
        @dns_db.disconnect
        @dns_db_helper.drop_db

        @dns_db = nil
        @dns_db_helper = nil
      end
    end

    def run_migrations
      Sequel::Migrator.apply(@dns_db, @dns_migrations, nil)
      Sequel::Migrator.apply(@director_db, @director_migrations, nil)
    end

    def reset(logger)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>SpecHelper::reset has a flog score of 66</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>SpecHelper#reset has approx 15 statements</span>          </div>  </li></ol>
      Bosh::Director::Config.clear
      Bosh::Director::Config.db = @director_db
      Bosh::Director::Config.dns_db = @dns_db
      Bosh::Director::Config.logger = logger
      Bosh::Director::Config.trusted_certs = &#39;&#39;
      Bosh::Director::Config.max_threads = 1

      Bosh::Director::Models.constants.each do |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="spec_helper.html#L175" class="js-smell-location">0</a>                  <a href="spec_helper.html#L180" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>SpecHelper#reset has the variable name 'e'</span>              <span>Locations:</span>                  <a href="spec_helper.html#L175" class="js-smell-location">0</a>                  <a href="spec_helper.html#L180" class="js-smell-location">1</a>                  <a href="spec_helper.html#L185" class="js-smell-location">2</a>                  </div>  </li></ol>
        c = Bosh::Director::Models.const_get(e)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>SpecHelper#reset has the variable name 'c'</span>              <span>Locations:</span>                  <a href="spec_helper.html#L176" class="js-smell-location">0</a>                  <a href="spec_helper.html#L181" class="js-smell-location">1</a>                  <a href="spec_helper.html#L186" class="js-smell-location">2</a>                  </div>  </li></ol>
        c.dataset = @director_db[c.simple_table.gsub(/[`&quot;]/, &#39;&#39;).to_sym] if c.kind_of?(Class) &amp;&amp; c.ancestors.include?(Sequel::Model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls '@director_db[c.simple_table.gsub(/[`"]/, '').to_sym]' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.ancestors' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.ancestors.include?(Sequel::Model)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.dataset = @director_db[c.simple_table.gsub(/[`"]/, '').to_sym]' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.kind_of?(Class)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table.gsub(/[`"]/, '')' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table.gsub(/[`"]/, '').to_sym' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li></ol>
      end

      Delayed::Backend::Sequel.constants.each do |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="spec_helper.html#L175" class="js-smell-location">0</a>                  <a href="spec_helper.html#L180" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>SpecHelper#reset has the variable name 'e'</span>              <span>Locations:</span>                  <a href="spec_helper.html#L175" class="js-smell-location">0</a>                  <a href="spec_helper.html#L180" class="js-smell-location">1</a>                  <a href="spec_helper.html#L185" class="js-smell-location">2</a>                  </div>  </li></ol>
        c = Delayed::Backend::Sequel.const_get(e)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>SpecHelper#reset has the variable name 'c'</span>              <span>Locations:</span>                  <a href="spec_helper.html#L176" class="js-smell-location">0</a>                  <a href="spec_helper.html#L181" class="js-smell-location">1</a>                  <a href="spec_helper.html#L186" class="js-smell-location">2</a>                  </div>  </li></ol>
        c.dataset = @director_db[c.simple_table.gsub(/[`&quot;]/, &#39;&#39;).to_sym] if c.kind_of?(Class) &amp;&amp; c.ancestors.include?(Sequel::Model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls '@director_db[c.simple_table.gsub(/[`"]/, '').to_sym]' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.ancestors' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.ancestors.include?(Sequel::Model)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.dataset = @director_db[c.simple_table.gsub(/[`"]/, '').to_sym]' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.kind_of?(Class)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table.gsub(/[`"]/, '')' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table.gsub(/[`"]/, '').to_sym' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li></ol>
      end

      Bosh::Director::Models::Dns.constants.each do |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>SpecHelper#reset has the variable name 'e'</span>              <span>Locations:</span>                  <a href="spec_helper.html#L175" class="js-smell-location">0</a>                  <a href="spec_helper.html#L180" class="js-smell-location">1</a>                  <a href="spec_helper.html#L185" class="js-smell-location">2</a>                  </div>  </li></ol>
        c = Bosh::Director::Models::Dns.const_get(e)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>SpecHelper#reset has the variable name 'c'</span>              <span>Locations:</span>                  <a href="spec_helper.html#L176" class="js-smell-location">0</a>                  <a href="spec_helper.html#L181" class="js-smell-location">1</a>                  <a href="spec_helper.html#L186" class="js-smell-location">2</a>                  </div>  </li></ol>
        c.dataset = @dns_db[c.simple_table.gsub(/[`&quot;]/, &#39;&#39;).to_sym] if c.kind_of?(Class) &amp;&amp; c.ancestors.include?(Sequel::Model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.ancestors' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.ancestors.include?(Sequel::Model)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.kind_of?(Class)' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table.gsub(/[`"]/, '')' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset calls 'c.simple_table.gsub(/[`"]/, '').to_sym' 3 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L177" class="js-smell-location">0</a>                  <a href="spec_helper.html#L182" class="js-smell-location">1</a>                  <a href="spec_helper.html#L187" class="js-smell-location">2</a>                  </div>  </li></ol>
      end
    end

    def reset_database(example)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>SpecHelper#reset_database has approx 6 statements</span>          </div>  </li></ol>
      if example.metadata[:truncation]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'example.metadata' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L192" class="js-smell-location">0</a>                  <a href="spec_helper.html#L209" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'example.metadata[:truncation]' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L192" class="js-smell-location">0</a>                  <a href="spec_helper.html#L209" class="js-smell-location">1</a>                  </div>  </li></ol>
        example.run<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'example.run' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L193" class="js-smell-location">0</a>                  <a href="spec_helper.html#L196" class="js-smell-location">1</a>                  </div>  </li></ol>
      else
        Sequel.transaction([@director_db, @dns_db], :rollback=&gt;:always, :auto_savepoint=&gt;true) do
          example.run<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'example.run' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L193" class="js-smell-location">0</a>                  <a href="spec_helper.html#L196" class="js-smell-location">1</a>                  </div>  </li></ol>
        end
      end

      if Bosh::Director::Config.db != nil; then<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'Bosh::Director::Config.db' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L200" class="js-smell-location">0</a>                  <a href="spec_helper.html#L201" class="js-smell-location">1</a>                  </div>  </li></ol>
        Bosh::Director::Config.db.disconnect<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'Bosh::Director::Config.db' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L200" class="js-smell-location">0</a>                  <a href="spec_helper.html#L201" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      @director_db_helper.truncate_db

      # when truncating, we must be sure to trash the dns db. for everything else,
      # leaving this commented doesn&#39;t seem to impact our tests and
      # has the benefit of avoiding the extra time for shelling out
      if example.metadata[:truncation]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'example.metadata' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L192" class="js-smell-location">0</a>                  <a href="spec_helper.html#L209" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>SpecHelper#reset_database calls 'example.metadata[:truncation]' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L192" class="js-smell-location">0</a>                  <a href="spec_helper.html#L209" class="js-smell-location">1</a>                  </div>  </li></ol>
        @dns_db_helper.truncate_db
      end
    end
  end
end

SpecHelper.init

BD = Bosh::Director

RSpec.configure do |rspec|
  rspec.around(:each) do |example|
    SpecHelper.reset_database(example)
  end

  rspec.before(:each) do
    SpecHelper.reset(logger)
    @event_buffer = StringIO.new
    @event_log = Bosh::Director::EventLog::Log.new(@event_buffer)
    Bosh::Director::Config.event_log = @event_log

    threadpool = instance_double(Bosh::Director::ThreadPool)
    allow(Bosh::Director::ThreadPool).to receive(:new).and_return(threadpool)
    allow(threadpool).to receive(:wrap).and_yield(threadpool)
    allow(threadpool).to receive(:process).and_yield
    allow(threadpool).to receive(:wait)
  end

  rspec.after(:each) { Timecop.return }

  rspec.after(:suite) do
    SpecHelper.disconnect_database
  end
end

def gzip(string)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="spec_helper.html#L245" class="js-smell-location">0</a>                  <a href="../../bosh-director-core/spec/bosh/director/core/templates/job_template_loader_spec.html#L13" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>gzip has approx 6 statements</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>gzip doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
  result = StringIO.new
  zio = Zlib::GzipWriter.new(result, nil, nil)
  zio.mtime = 1
  zio.write(string)
  zio.close
  result.string
end

def check_event_log(task_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>check_event_log doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
  unless Bosh::Director::Models::Task.first(id: task_id).event_output.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>check_event_log calls 'Bosh::Director::Models::Task.first(id: task_id)' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L255" class="js-smell-location">0</a>                  <a href="spec_helper.html#L256" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>check_event_log calls 'Bosh::Director::Models::Task.first(id: task_id).event_output' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L255" class="js-smell-location">0</a>                  <a href="spec_helper.html#L256" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>check_event_log performs a nil-check</span>          </div>  </li></ol>
    events = Bosh::Director::Models::Task.first(id: task_id).event_output.split(&quot;\n&quot;).map do |line|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>check_event_log calls 'Bosh::Director::Models::Task.first(id: task_id)' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L255" class="js-smell-location">0</a>                  <a href="spec_helper.html#L256" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>check_event_log calls 'Bosh::Director::Models::Task.first(id: task_id).event_output' 2 times</span>              <span>Locations:</span>                  <a href="spec_helper.html#L255" class="js-smell-location">0</a>                  <a href="spec_helper.html#L256" class="js-smell-location">1</a>                  </div>  </li></ol>
      JSON.parse(line)
    end

    yield events
  else
    nil
  end
end

def linted_rack_app(app)
  Rack::Builder.new do
    use Rack::Lint
    run app
  end
end

module ManifestHelper<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>ManifestHelper has no descriptive comment</span>          </div>  </li></ol>
  class &lt;&lt; self
    def default_deployment_manifest(overrides = {})
      {
        &#39;name&#39; =&gt; &#39;deployment-name&#39;,
        &#39;releases&#39; =&gt; [release],
        &#39;update&#39; =&gt; {
          &#39;max_in_flight&#39; =&gt; 10,
          &#39;canaries&#39; =&gt; 2,
          &#39;canary_watch_time&#39; =&gt; 1000,
          &#39;update_watch_time&#39; =&gt; 1000,
        },
      }.merge(overrides)
    end

    def default_legacy_manifest(overrides = {})
      (default_deployment_manifest.merge(default_iaas_manifest)).merge(overrides)
    end

    def default_iaas_manifest(overrides = {})
      {
      &#39;networks&#39; =&gt; [ManifestHelper::network],
      &#39;resource_pools&#39; =&gt; [ManifestHelper::resource_pool],
      &#39;compilation&#39; =&gt; {
        &#39;workers&#39; =&gt; 1,
        &#39;network&#39;=&gt;&#39;network-name&#39;,
        &#39;cloud_properties&#39; =&gt; {},
        },
      }.merge(overrides)
    end

    def default_manifest_with_jobs(overrides = {})
      {
        &#39;name&#39; =&gt; &#39;deployment-name&#39;,
        &#39;releases&#39; =&gt; [release],
        &#39;jobs&#39; =&gt; [job],
        &#39;update&#39; =&gt; {
            &#39;max_in_flight&#39; =&gt; 10,
            &#39;canaries&#39; =&gt; 2,
            &#39;canary_watch_time&#39; =&gt; 1000,
            &#39;update_watch_time&#39; =&gt; 1000,
        },
      }.merge(overrides)
    end

    def release(overrides = {})
      {
        &#39;name&#39; =&gt; &#39;release-name&#39;,
        &#39;version&#39; =&gt; &#39;latest&#39;,
      }.merge(overrides)
    end

    def network(overrides = {})
      { &#39;name&#39; =&gt; &#39;network-name&#39;, &#39;subnets&#39; =&gt; [] }.merge(overrides)
    end

    def manual_network(overrides = {})
      ManifestHelper::network({
          &#39;type&#39; =&gt; &#39;manual&#39;,
          &#39;subnets&#39; =&gt; [{
              &#39;range&#39; =&gt; &#39;10.0.0.1/24&#39;,
              &#39;gateway&#39; =&gt; &#39;10.0.0.1&#39;
            }]
        }).merge(overrides)
    end

    def disk_pool(name=&#39;dp-name&#39;)
      {&#39;name&#39; =&gt; name, &#39;disk_size&#39; =&gt; 10000}
    end

    def job(overrides = {})
      {
        &#39;name&#39; =&gt; &#39;job-name&#39;,
        &#39;resource_pool&#39; =&gt; &#39;rp-name&#39;,
        &#39;instances&#39; =&gt; 1,
        &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;network-name&#39;}],
        &#39;templates&#39; =&gt; [{&#39;name&#39; =&gt; &#39;template-name&#39;, &#39;release&#39; =&gt; &#39;release-name&#39;}]
      }.merge(overrides)
    end

    def resource_pool(overrides = {})
      {
        &#39;name&#39; =&gt; &#39;rp-name&#39;,
        &#39;network&#39;=&gt;&#39;network-name&#39;,
        &#39;stemcell&#39;=&gt; {&#39;name&#39; =&gt; &#39;default&#39;,&#39;version&#39;=&gt;&#39;1&#39;},
        &#39;cloud_properties&#39;=&gt;{}
      }.merge(overrides)
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
