<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-01-11 17:04:59 -0800'>2018-01-11 17:04:59 -0800</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/models /</small> deployment_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">406</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">21</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1193.18</span><small> complexity</small></div>
              <div><span class="metric">417</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                36
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;bosh/director/models/deployment&#39;

module Bosh::Director::Models<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::Models has no descriptive comment</span>          </div>  </li></ol>
  describe Deployment do
    subject(:deployment) { described_class.make(manifest: manifest, name: &#39;dep1&#39;) }
    let(:db_is_mysql) { ENV[&#39;DB&#39;] == &#39;mysql&#39; }
    let(:deadlock_exception) { Sequel::DatabaseError.new(&quot;Mysql2::Error: Deadlock found when trying to get lock&quot;) }

    describe &#39;#tags&#39; do

      context &#39;when manifest is nil&#39; do
        let(:manifest) { nil }

        it &#39;returns empty list&#39; do
          expect(deployment.tags).to eq({})
        end
      end

      context &#39;when manifest is not nil&#39; do

        context &#39;when tags are present&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(#tags)::context(when manifest is not nil)::context#when tags are present has a flog score of 38</span>          </div>  </li></ol>

          let(:mock_client) { instance_double(Bosh::Director::ConfigServer::ConfigServerClient) }
          let(:mock_client_factory) { double(Bosh::Director::ConfigServer::ClientFactory) }

          before do
            allow(Bosh::Director::ConfigServer::ClientFactory).to receive(:create).and_return(mock_client_factory)
            allow(mock_client_factory).to receive(:create_client).and_return(mock_client)
            allow(mock_client).to receive(:interpolate_with_versioning).and_return(interpolated_tags)
          end

          context &#39;when tags do NOT use variables&#39; do
            let(:manifest) do
              %(---
                tags:
                  tag1: value1
                  tag2: value2
              )
            end

            let(:interpolated_tags) do
              {
                &#39;tag1&#39; =&gt; &#39;value1&#39;,
                &#39;tag2&#39; =&gt; &#39;value2&#39;
              }
            end

            it &#39;returns the tags in deployment manifest&#39; do
              expect(deployment.tags).to eq({
                &#39;tag1&#39; =&gt; &#39;value1&#39;,
                &#39;tag2&#39; =&gt; &#39;value2&#39;,
              })
            end
          end

          context &#39;when tags use variables&#39; do
            let(:manifest) do
              %(---
                tags:
                  tagA: ((tag-var1))
                  tagO: ((/tag-var2))
              )
            end

            let(:tags) do
              {
                &#39;tagA&#39; =&gt; &#39;((tag-var1))&#39;,
                &#39;tagO&#39;=&gt; &#39;((/tag-var2))&#39;
              }
            end

            let(:interpolated_tags) do
              {
                &#39;tagA&#39; =&gt; &#39;apples&#39;,
                &#39;tagO&#39; =&gt; &#39;oranges&#39;
              }
            end

            before do
              VariableSet.make(id: 1, deployment: deployment)
            end

            it &#39;substitutes the variables in the tags section&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(#tags)::context(when manifest is not nil)::context(when tags are present)::context(when tags use variables)::it#substitutes the variables in the tags section has a flog score of 37</span>          </div>  </li></ol>
              expect(mock_client).to receive(:interpolate_with_versioning).with(tags, deployment.current_variable_set).and_return(interpolated_tags)
              expect(deployment.tags).to eq(interpolated_tags)
            end
          end
        end

        context &#39;when tags are NOT present&#39; do
          let(:manifest) { &#39;---{}&#39; }

          it &#39;returns empty list&#39; do
            expect(deployment.tags).to eq({})
          end
        end
      end
    end

    describe &#39;#variables&#39; do
      let(:deployment_1) { Deployment.make(manifest: &#39;test&#39;) }
      let(:deployment_2) { Deployment.make(manifest: &#39;vroom&#39;) }
      let(:deployment_3) { Deployment.make(manifest: &#39;hello&#39;) }
      let(:variable_set_1) { VariableSet.make(id: 1, deployment: deployment_1) }
      let(:variable_set_2) { VariableSet.make(id: 2, deployment: deployment_1) }
      let(:variable_set_3) { VariableSet.make(id: 12, deployment: deployment_2) }
      let(:variable_set_4) { VariableSet.make(id: 13, deployment: deployment_2) }

      it &#39;returns the variables associated with a deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(#variables)::it#returns the variables associated with a deployment has a flog score of 67</span>          </div>  </li></ol>
        dep_1_variables = [
          Variable.make(id: 1, variable_id: &#39;var_id_1&#39;, variable_name: &#39;var_name_1&#39;, variable_set_id: variable_set_1.id),
          Variable.make(id: 2, variable_id: &#39;var_id_2&#39;, variable_name: &#39;var_name_2&#39;, variable_set_id: variable_set_1.id),
          Variable.make(id: 3, variable_id: &#39;var_id_3&#39;, variable_name: &#39;var_name_3&#39;, variable_set_id: variable_set_2.id)
        ]

        dep_2_variables = [
          Variable.make(id: 4, variable_id: &#39;var_id_1&#39;, variable_name: &#39;var_name_1&#39;, variable_set_id: variable_set_3.id),
          Variable.make(id: 5, variable_id: &#39;var_id_2&#39;, variable_name: &#39;var_name_2&#39;, variable_set_id: variable_set_3.id),
          Variable.make(id: 6, variable_id: &#39;var_id_3&#39;, variable_name: &#39;var_name_3&#39;, variable_set_id: variable_set_4.id),
          Variable.make(id: 7, variable_id: &#39;var_id_4&#39;, variable_name: &#39;var_name_4&#39;, variable_set_id: variable_set_4.id)
        ]

        expect(deployment_1.variables).to match_array(dep_1_variables)
        expect(deployment_2.variables).to match_array(dep_2_variables)
        expect(deployment_3.variables).to be_empty
      end
    end

    describe &#39;#current_variable_set&#39; do
      let(:deployment_1) { Deployment.make(manifest: &#39;test&#39;) }
      let(:deployment_2) { Deployment.make(manifest: &#39;vroom&#39;) }

      before do
        time = Time.now
        VariableSet.make(id: 1, deployment: deployment_1, created_at: time + 1)
        VariableSet.make(id: 2, deployment: deployment_1, created_at: time + 2)
        VariableSet.make(id: 3, deployment: deployment_1, created_at: time + 3)
      end

      it &#39;returns the deployment current variable set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L141" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L160" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect(deployment_1.current_variable_set.id).to eq(3)
        expect(deployment_2.current_variable_set).to be_nil
      end
    end

    describe &#39;#last_successful_variable_set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe##last_successful_variable_set has a flog score of 35</span>          </div>  </li></ol>
      let(:deployment_1) { Deployment.make(manifest: &#39;test&#39;) }
      let(:deployment_2) { Deployment.make(manifest: &#39;vroom&#39;) }

      before do
        time = Time.now
        VariableSet.make(id: 1, deployment: deployment_1, created_at: time + 1, deployed_successfully: true)
        VariableSet.make(id: 2, deployment: deployment_1, created_at: time + 2, deployed_successfully: true)
        VariableSet.make(id: 3, deployment: deployment_1, created_at: time + 3, deployed_successfully: true)
        VariableSet.make(id: 4, deployment: deployment_1, created_at: time + 4, deployed_successfully: true)
        VariableSet.make(id: 5, deployment: deployment_1, created_at: time + 5, deployed_successfully: false)
      end

      it &#39;returns the deployment current variable set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L141" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L160" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect(deployment_1.last_successful_variable_set.id).to eq(4)
        expect(deployment_2.last_successful_variable_set).to be_nil
      end
    end

    describe &#39;#cleanup_variable_sets&#39; do
      let(:deployment_1) { Deployment.make(manifest: &#39;test&#39;) }
      let(:deployment_2) { Deployment.make(manifest: &#39;vroom&#39;) }
      let(:time) { Time.now }

      it &#39;deletes variable sets not referenced in the list provided&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(#cleanup_variable_sets)::it#deletes variable sets not referenced in the list provided has a flog score of 117</span>          </div>  </li></ol>
        time = Time.now

        dep_1_variable_sets_to_keep = [
          VariableSet.make(id: 1, deployment: deployment_1, created_at: time + 1, deployed_successfully: true),
          VariableSet.make(id: 2, deployment: deployment_1, created_at: time + 2, deployed_successfully: true),
          VariableSet.make(id: 3, deployment: deployment_1, created_at: time + 3, deployed_successfully: true),
          VariableSet.make(id: 4, deployment: deployment_1, created_at: time + 4, deployed_successfully: true),
          VariableSet.make(id: 5, deployment: deployment_1, created_at: time + 5, deployed_successfully: false)
        ]

        dep_1_variable_sets_to_be_deleted = [
          VariableSet.make(id: 6, deployment: deployment_1, created_at: time + 6, deployed_successfully: true),
          VariableSet.make(id: 7, deployment: deployment_1, created_at: time + 7, deployed_successfully: true),
          VariableSet.make(id: 8, deployment: deployment_1, created_at: time + 8, deployed_successfully: true),
          VariableSet.make(id: 9, deployment: deployment_1, created_at: time + 9, deployed_successfully: false)
        ]

        dep_2_control_variable_sets = [
          VariableSet.make(id: 10, deployment: deployment_2, created_at: time + 10, deployed_successfully: false),
          VariableSet.make(id: 11, deployment: deployment_2, created_at: time + 11, deployed_successfully: true),
          VariableSet.make(id: 12, deployment: deployment_2, created_at: time + 12, deployed_successfully: false)
        ]

        expect(VariableSet.all).to match_array(dep_1_variable_sets_to_keep + dep_1_variable_sets_to_be_deleted + dep_2_control_variable_sets)

        deployment_1.cleanup_variable_sets(dep_1_variable_sets_to_keep)
        expect(VariableSet.all).to match_array(dep_1_variable_sets_to_keep + dep_2_control_variable_sets)

        deployment_2.cleanup_variable_sets(dep_2_control_variable_sets)
        expect(VariableSet.all).to match_array(dep_1_variable_sets_to_keep + dep_2_control_variable_sets)

        deployment_2.cleanup_variable_sets([])
        expect(VariableSet.all).to match_array(dep_1_variable_sets_to_keep)
      end
    end

    describe &#39;cloud_configs&#39; do
      let(:manifest) { &#39;---{}&#39; }
      let(:cc1) { Bosh::Director::Models::Config.create(type: &#39;cloud&#39;, content: &#39;cc1-prop&#39;, name: &#39;cc1&#39;) }
      let(:cc2) { Bosh::Director::Models::Config.create(type: &#39;cloud&#39;, content: &#39;cc2-prop&#39;, name: &#39;cc2&#39;) }

      before do
        cc3 = Bosh::Director::Models::Config.create(type: &#39;cloud&#39;, content: &#39;cc3-prop&#39;, name: &#39;cc3&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'cc3'</span>          </div>  </li></ol>

        deployment.add_cloud_config(cc1)
        deployment.add_cloud_config(cc2)
        deployment.add_cloud_config(cc3)
      end

      it &#39;retries deadlocks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(cloud_configs)::it#retries deadlocks has a flog score of 40</span>          </div>  </li></ol>
        expect(deployment).to receive(:remove_all_cloud_configs).and_raise(deadlock_exception).once
        expect(deployment).to receive(:remove_all_cloud_configs).and_call_original

        deployment.cloud_configs = [cc1, cc2]
        expect(deployment.cloud_configs).to eq([cc1, cc2])
      end

      it &#39;raises original deadlock exception on subsequent, non-retryable failures&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(cloud_configs)::it#raises original deadlock exception on subsequent, non-retryable failures has a flog score of 37</span>          </div>  </li></ol>
        expect(deployment).to receive(:remove_all_cloud_configs).and_raise(deadlock_exception).once
        expect(deployment).to receive(:remove_all_cloud_configs).and_raise(Sequel::DatabaseError, &#39;fake foreign key constraint&#39;).once

        expect { deployment.cloud_configs = [cc1, cc2] }.to raise_error(deadlock_exception)
      end

      it &#39;#add_cloud_config rejects adding other config types&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(cloud_configs)::it##add_cloud_config rejects adding other config types has a flog score of 26</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        expect {
          deployment.add_cloud_config(config)
        }.to raise_error Bosh::Director::ConfigTypeMismatch, &quot;Expected config type &#39;cloud&#39;, but was &#39;fake_type&#39;&quot;
        expect( Bosh::Director::Config.db[:deployments_configs].map(:config_id)).to_not include(config.id)
      end

      it &#39;#remove_cloud_config rejects removing other config types&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L244" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L312" class="js-smell-location">1</a>                  <a href="deployment_spec.html#L322" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(cloud_configs)::it##remove_cloud_config rejects removing other config types has a flog score of 37</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        Bosh::Director::Config.db[:deployments_configs].insert({deployment_id:deployment.id, config_id:config.id})
        expect {
          deployment.remove_cloud_config(config)
        }.to raise_error Bosh::Director::ConfigTypeMismatch, &quot;Expected config type &#39;cloud&#39;, but was &#39;fake_type&#39;&quot;
        expect( Bosh::Director::Config.db[:deployments_configs].map(:config_id)).to include(config.id)
      end

      it &quot;#remove_all_cloud_configs removes only configs associations of type &#39;cloud&#39;&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(cloud_configs)::it##remove_all_cloud_configs removes only configs associations of type 'cloud' has a flog score of 78</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        Bosh::Director::Config.db[:deployments_configs].insert({deployment_id:deployment.id, config_id:config.id})

        deployment.remove_all_cloud_configs

        expect(deployment.cloud_configs.size).to eq(0)
        expect( Bosh::Director::Config.db[:deployments_configs].count).to eq(1)
        expect( Bosh::Director::Config.db[:deployments_configs].map(:config_id)).to include(config.id)
        expect(Bosh::Director::Models::Config.where(type: &#39;fake_type&#39;).all.size).to eq 1
        expect(Bosh::Director::Models::Config.where(type: &#39;cloud&#39;).all.size).to eq 3
      end

      it &#39;#cloud_configs= removes existing records &amp; assigns the new cloud config records&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L266" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L345" class="js-smell-location">1</a>                  </div>  </li></ol>
        cc4 = Bosh::Director::Models::Config.create(type: &#39;cloud&#39;, content: &#39;cc4-prop&#39;, name: &#39;cc4&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'cc4'</span>          </div>  </li></ol>
        cc5 = Bosh::Director::Models::Config.create(type: &#39;cloud&#39;, content: &#39;cc5-prop&#39;, name: &#39;cc5&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'cc5'</span>          </div>  </li></ol>

        deployment.cloud_configs = [cc4, cc5]

        expect(Bosh::Director::Models::Deployment[id: deployment.id].cloud_configs).to contain_exactly(cc4, cc5)
      end

      it &quot;#cloud_configs filters configs of type &#39;cloud&#39;&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(cloud_configs)::it##cloud_configs filters configs of type 'cloud' has a flog score of 36</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        Bosh::Director::Config.db[:deployments_configs].insert({deployment_id:deployment.id, config_id: config.id})

        expect(deployment.cloud_configs.size).to eq 3
        expect(deployment.cloud_configs).not_to include(config)
      end
    end

    describe &#39;runtime_configs&#39; do
      let(:manifest) { &#39;---{}&#39; }
      let(:rc1) { Bosh::Director::Models::Config.create(type: &#39;runtime&#39;, content: &#39;rc1-prop&#39;, name: &#39;rc1&#39;) }

      before do
        rc2 = Bosh::Director::Models::Config.create(type: &#39;runtime&#39;, content: &#39;rc2-prop&#39;, name: &#39;rc2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'rc2'</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L289" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L386" class="js-smell-location">1</a>                  </div>  </li></ol>
        rc3 = Bosh::Director::Models::Config.create(type: &#39;runtime&#39;, content: &#39;rc3-prop&#39;, name: &#39;rc3&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'rc3'</span>          </div>  </li></ol>

        deployment.add_runtime_config(rc1)
        deployment.add_runtime_config(rc2)
        deployment.add_runtime_config(rc3)
      end

      it &#39;retries deadlocks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L297" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L367" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(runtime_configs)::it#retries deadlocks has a flog score of 37</span>          </div>  </li></ol>
        expect(deployment).to receive(:remove_all_runtime_configs).and_raise(deadlock_exception).once
        expect(deployment).to receive(:remove_all_runtime_configs).and_call_original

        deployment.runtime_configs = [rc1]
        expect(deployment.runtime_configs).to eq([rc1])
      end

      it &#39;raises original deadlock exception on subsequent, non-retryable failures&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L305" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L375" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(runtime_configs)::it#raises original deadlock exception on subsequent, non-retryable failures has a flog score of 36</span>          </div>  </li></ol>
        expect(deployment).to receive(:remove_all_runtime_configs).and_raise(deadlock_exception).once
        expect(deployment).to receive(:remove_all_runtime_configs).and_raise(Sequel::DatabaseError, &#39;fake foreign key constraint&#39;).once

        expect { deployment.runtime_configs = [rc1] }.to raise_error(deadlock_exception)
      end

      it &#39;#add_runtime_config rejects adding other config types&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L244" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L312" class="js-smell-location">1</a>                  <a href="deployment_spec.html#L322" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(runtime_configs)::it##add_runtime_config rejects adding other config types has a flog score of 37</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        Bosh::Director::Config.db[:deployments_configs].insert({deployment_id:deployment.id, config_id:config.id})
        expect {
          deployment.add_runtime_config(config)
        }.to raise_error Bosh::Director::ConfigTypeMismatch, &quot;Expected config type &#39;runtime&#39;, but was &#39;fake_type&#39;&quot;
        expect( Bosh::Director::Config.db[:deployments_configs].map(:config_id)).to include(config.id)

      end

      it &#39;#remove_runtime_config rejects removing other config types&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L244" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L312" class="js-smell-location">1</a>                  <a href="deployment_spec.html#L322" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(runtime_configs)::it##remove_runtime_config rejects removing other config types has a flog score of 37</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        Bosh::Director::Config.db[:deployments_configs].insert({deployment_id:deployment.id, config_id:config.id})
        expect {
          deployment.remove_runtime_config(config)
        }.to raise_error Bosh::Director::ConfigTypeMismatch, &quot;Expected config type &#39;runtime&#39;, but was &#39;fake_type&#39;&quot;

        expect( Bosh::Director::Config.db[:deployments_configs].map(:config_id)).to include(config.id)
      end

      it &quot;#remove_all_runtime_configs removes only configs associations of type &#39;runtime&#39;&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(runtime_configs)::it##remove_all_runtime_configs removes only configs associations of type 'runtime' has a flog score of 66</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        Bosh::Director::Config.db[:deployments_configs].insert({deployment_id:deployment.id, config_id:config.id})

        deployment.remove_all_runtime_configs

        expect( Bosh::Director::Config.db[:deployments_configs].count).to eq(1)
        expect( Bosh::Director::Config.db[:deployments_configs].map(:config_id)).to include(config.id)

        expect(Bosh::Director::Models::Config.where(type: &#39;fake_type&#39;).all.size).to eq 1
        expect(Bosh::Director::Models::Config.where(type: &#39;runtime&#39;).all.size).to eq 3
      end

      it &#39;#runtime_configs= removes existing records &amp; assigns the new runtime config records&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L266" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L345" class="js-smell-location">1</a>                  </div>  </li></ol>
        rc4 = Bosh::Director::Models::Config.create(type: &#39;runtime&#39;, content: &#39;rc4-prop&#39;, name: &#39;rc4&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'rc4'</span>          </div>  </li></ol>
        rc5 = Bosh::Director::Models::Config.create(type: &#39;runtime&#39;, content: &#39;rc5-prop&#39;, name: &#39;rc5&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'rc5'</span>          </div>  </li></ol>

        deployment.runtime_configs = [rc4, rc5]

        expect(Bosh::Director::Models::Deployment[id: deployment.id].runtime_configs).to contain_exactly(rc4, rc5)
      end

      it &quot;#runtime_configs filters configs of type &#39;runtime&#39;&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(runtime_configs)::it##runtime_configs filters configs of type 'runtime' has a flog score of 40</span>          </div>  </li></ol>
        config = Bosh::Director::Models::Config.create(type: &#39;fake_type&#39;, content: &#39;fake_content&#39;, name: &#39;fake_name&#39;)
        Bosh::Director::Config.db[:deployments_configs].insert({deployment_id:deployment.id, config_id:config.id})

        expect(deployment.runtime_configs.size).to eq 3
        expect(Bosh::Director::Models::Deployment[id: deployment.id].runtime_configs).not_to include(config)
      end
    end

    describe &#39;#teams=&#39; do
      let(:manifest) { nil }
      let(:team1) { Bosh::Director::Models::Team.create(name: &#39;team1&#39;) }

      it &#39;retries deadlocks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L297" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L367" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(#teams=)::it#retries deadlocks has a flog score of 37</span>          </div>  </li></ol>
        expect(deployment).to receive(:remove_all_teams).and_raise(deadlock_exception).once
        expect(deployment).to receive(:remove_all_teams).and_call_original

        deployment.teams = [team1]
        expect(deployment.teams).to eq([team1])
      end

      it &#39;raises original deadlock exception on subsequent, non-retryable failures&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L305" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L375" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(#teams=)::it#raises original deadlock exception on subsequent, non-retryable failures has a flog score of 36</span>          </div>  </li></ol>
        expect(deployment).to receive(:remove_all_teams).and_raise(deadlock_exception).once
        expect(deployment).to receive(:remove_all_teams).and_raise(Sequel::DatabaseError, &#39;fake foreign key constraint&#39;).once

        expect { deployment.teams = [team1] }.to raise_error(deadlock_exception)
      end
    end

    describe &#39;#create_with_teams&#39; do
      it &#39;saves attributes including teams &amp; runtime_configs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Models::describe(#create_with_teams)::it#saves attributes including teams & runtime_configs has a flog score of 30</span>          </div>  </li></ol>
        rc1 = Bosh::Director::Models::Config.create(type: &#39;runtime&#39;, content: &#39;rc1-prop&#39;, name: &#39;rc1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'rc1'</span>          </div>  </li></ol>
        rc2 = Bosh::Director::Models::Config.create(type: &#39;runtime&#39;, content: &#39;rc2-prop&#39;, name: &#39;rc2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'rc2'</span>              <span>Locations:</span>                  <a href="deployment_spec.html#L289" class="js-smell-location">0</a>                  <a href="deployment_spec.html#L386" class="js-smell-location">1</a>                  </div>  </li></ol>

        team1 = Bosh::Director::Models::Team.new( name: &#39;team1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'team1'</span>          </div>  </li></ol>
        team2 = Bosh::Director::Models::Team.new( name: &#39;team2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Models has the variable name 'team2'</span>          </div>  </li></ol>

        attr = {
          :name =&gt; &#39;some-deploy&#39;,
          :teams =&gt; [team1, team2],
          :runtime_configs =&gt; [rc1, rc2]
        }

        deployment =  Bosh::Director::Models::Deployment.create_with_teams(attr)

        saved_deployment = Bosh::Director::Models::Deployment[id: deployment.id ]
        expect(saved_deployment).to eq(deployment)
        expect(saved_deployment.teams).to contain_exactly(team1, team2)
        expect(saved_deployment.runtime_configs).to contain_exactly(rc1, rc2)
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
