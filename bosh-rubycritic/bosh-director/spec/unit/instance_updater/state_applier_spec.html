<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/instance_updater /</small> state_applier_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">339</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">48</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">856.31</span><small> complexity</small></div>
              <div><span class="metric">311</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                21
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe InstanceUpdater::StateApplier do
    include Support::StemcellHelpers

    subject(:state_applier) do
      InstanceUpdater::StateApplier.new(instance_plan, agent_client, rendered_job_templates_cleaner, logger, options)
    end

    let(:options) do
      {}
    end
    let(:instance_plan) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="state_applier_spec.html#L14" class="js-smell-location">0</a>                  <a href="../job_renderer_spec.html#L15" class="js-smell-location">1</a>                  </div>  </li></ol>
      DeploymentPlan::InstancePlan.new(
        existing_instance: instance_model,
        desired_instance: DeploymentPlan::DesiredInstance.new(instance_group),
        instance: instance,
      )
    end

    let(:network_spec) do
      { &#39;name&#39; =&gt; &#39;default&#39;, &#39;subnets&#39; =&gt; [{ &#39;cloud_properties&#39; =&gt; { &#39;foo&#39; =&gt; &#39;bar&#39; }, &#39;az&#39; =&gt; &#39;foo-az&#39; }] }
    end
    let(:network) { DeploymentPlan::DynamicNetwork.parse(network_spec, [availability_zone], logger) }

    let(:instance_group) do
      instance_double(
        &#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;,
        name: &#39;fake-job&#39;,
        spec: { &#39;name&#39; =&gt; &#39;job&#39; },
        canonical_name: &#39;job&#39;,
        instances: [&#39;instance0&#39;],
        default_network: { &#39;gateway&#39; =&gt; &#39;default&#39; },
        vm_type: DeploymentPlan::VmType.new(&#39;name&#39; =&gt; &#39;fake-vm-type&#39;),
        vm_extensions: [],
        stemcell: make_stemcell(name: &#39;fake-stemcell-name&#39;, version: &#39;1.0&#39;),
        env: DeploymentPlan::Env.new(&#39;key&#39; =&gt; &#39;value&#39;),
        package_spec: {},
        persistent_disk_collection: DeploymentPlan::PersistentDiskCollection.new(logger),
        errand?: false,
        compilation?: false,
        jobs: [],
        update_spec: update_config.to_hash,
        properties: {},
        vm_resources: DeploymentPlan::VmResources.new(&#39;cpu&#39; =&gt; 1, &#39;ephemeral_disk_size&#39; =&gt; 1, &#39;ram&#39; =&gt; 1),
        lifecycle: DeploymentPlan::InstanceGroup::DEFAULT_LIFECYCLE_PROFILE,
        vm_strategy: &#39;fake-strat&#39;,
      )
    end
    let(:update_config) do
      DeploymentPlan::UpdateConfig.new(
        &#39;canaries&#39; =&gt; 1,
        &#39;max_in_flight&#39; =&gt; 1,
        &#39;canary_watch_time&#39; =&gt; &#39;1000-2000&#39;,
        &#39;update_watch_time&#39; =&gt; update_watch_time,
      )
    end
    let(:plan) do
      instance_double(&#39;Bosh::Director::DeploymentPlan::Planner&#39;,
                      name: &#39;fake-deployment&#39;,
                      model: deployment)
    end
    let(:deployment) { Bosh::Director::Models::Deployment.make(name: &#39;fake-deployment&#39;) }
    let(:availability_zone) { Bosh::Director::DeploymentPlan::AvailabilityZone.new(&#39;foo-az&#39;, &#39;a&#39; =&gt; &#39;b&#39;) }
    let(:instance) do
      DeploymentPlan::Instance.create_from_instance_group(instance_group, 0, instance_state, plan, {}, availability_zone, logger)
    end
    let(:instance_model) { Models::Instance.make(deployment: deployment, state: instance_model_state, uuid: &#39;uuid-1&#39;) }
    let(:blobstore) { instance_double(Bosh::Blobstore::Client) }
    let(:agent_client) { instance_double(AgentClient) }
    let(:rendered_job_templates_cleaner) { instance_double(RenderedJobTemplatesCleaner) }
    let(:instance_state) { &#39;started&#39; }
    let(:instance_model_state) { &#39;stopped&#39; }
    let(:job_state) { &#39;running&#39; }
    let(:update_watch_time) { &#39;1000-2000&#39; }

    before do
      reservation = Bosh::Director::DesiredNetworkReservation.new_dynamic(instance_model, network)
      reservation.resolve_ip(&#39;192.168.0.10&#39;)

      instance_plan.network_plans &lt;&lt; DeploymentPlan::NetworkPlanner::Plan.new(reservation: reservation)
      instance.bind_existing_instance_model(instance_model)

      allow(AgentClient).to receive(:with_agent_id).with(instance_model.agent_id).and_return(agent_client)
      allow(agent_client).to receive(:apply)
      allow(agent_client).to receive(:run_script)
      allow(agent_client).to receive(:start)
      allow(agent_client).to receive(:get_state).and_return(&#39;job_state&#39; =&gt; job_state)
      allow(rendered_job_templates_cleaner).to receive(:clean)
      allow(state_applier).to receive(:sleep)
    end

    it &#39;runs the pre-start, start and post-start scripts in order&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::it#runs the pre-start, start and post-start scripts in order has a flog score of 35</span>          </div>  </li></ol>
      expect(agent_client).to receive(:run_script).with(&#39;pre-start&#39;, {}).ordered
      expect(agent_client).to receive(:start).ordered
      expect(agent_client).to receive(:run_script).with(&#39;post-start&#39;, {}).ordered

      state_applier.apply(update_config)
    end

    it &#39;updates instance spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::it#updates instance spec has a flog score of 35</span>          </div>  </li></ol>
      expect(agent_client).to receive(:apply).with(instance_plan.spec.as_apply_spec)
      state_applier.apply(update_config)
      expect(instance_model.spec).to eq(instance_plan.spec.full_spec)
    end

    it &#39;can skip post start if run_post_start is false&#39; do
      expect(agent_client).to_not receive(:run_script).with(&#39;post-start&#39;, {})
      state_applier.apply(update_config, false)
    end

    it &#39;runs post start by default&#39; do
      expect(agent_client).to receive(:run_script).with(&#39;post-start&#39;, {})
      state_applier.apply(update_config)
    end

    it &#39;cleans rendered templates after applying&#39; do
      expect(agent_client).to receive(:apply).ordered
      expect(rendered_job_templates_cleaner).to receive(:clean).ordered
      state_applier.apply(update_config)
    end

    it &#39;should stop execution if task was canceled&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::it#should stop execution if task was canceled has a flog score of 71</span>          </div>  </li></ol>
      task = Bosh::Director::Models::Task.make(id: 42, state: &#39;cancelling&#39;)
      base_job = Jobs::BaseJob.new
      allow(base_job).to receive(:task_id).and_return(task.id)
      allow(Config).to receive(:current_job).and_return(base_job)
      Config.instance_variable_set(:@current_job, base_job)
      expect(logger).to receive(:info).with(&#39;Applying VM state&#39;).ordered
      expect(logger).to receive(:info).with(&#39;Running pre-start for fake-job/uuid-1 (0)&#39;).ordered
      expect(logger).to receive(:info).with(&#39;Starting instance fake-job/uuid-1 (0)&#39;).ordered
      expect(logger).to receive(:debug).with(&#39;Task was cancelled. Stop waiting for the desired state&#39;).ordered

      expect { state_applier.apply(update_config) }.to raise_error Bosh::Director::TaskCancelled, &#39;Task 42 cancelled&#39;
    end

    context &#39;when instance state is stopped&#39; do
      let(:instance_state) { &#39;stopped&#39; }
      let(:job_state) { &#39;stopped&#39; }

      it &#39;does not run the start script&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="../config_old_spec.html#L149" class="js-smell-location">0</a>                  <a href="../config_old_spec.html#L161" class="js-smell-location">1</a>                  <a href="../disk_manager_spec.html#L623" class="js-smell-location">2</a>                  <a href="state_applier_spec.html#L142" class="js-smell-location">3</a>                  <a href="../instance_updater_spec.html#L131" class="js-smell-location">4</a>                  </div>  </li></ol>
        expect(agent_client).to_not receive(:run_script)
        expect(agent_client).to_not receive(:start)
        state_applier.apply(update_config)
      end
    end

    describe &#39;waiting for job to be running&#39; do
      let(:job_state) { &#39;stopped&#39; }

      context &#39;scheduling&#39; do
        let(:update_watch_time) { &#39;1000-91000&#39; }

        it &#39;divides the range into 10 equal steps&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(scheduling)::it#divides the range into 10 equal steps has a flog score of 27</span>          </div>  </li></ol>
          expect(state_applier).to receive(:sleep).with(10.0).exactly(9).times
          expect { state_applier.apply(update_config) }.to raise_error
        end

        context &#39;when the interval length is less than 10 seconds&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="state_applier_spec.html#L160" class="js-smell-location">0</a>                  <a href="state_applier_spec.html#L169" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:update_watch_time) { &#39;1000-8000&#39; }

          it &#39;divides the interval into 1 second steps&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(scheduling)::context(when the interval length is less than 10 seconds)::it#divides the interval into 1 second steps has a flog score of 29</span>          </div>  </li></ol>
            expect(state_applier).to receive(:sleep).with(1.0).exactly(8).times
            expect { state_applier.apply(update_config) }.to raise_error
          end
        end

        context &#39;when the interval length is longer than 150 seconds&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="state_applier_spec.html#L160" class="js-smell-location">0</a>                  <a href="state_applier_spec.html#L169" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:update_watch_time) { &#39;1000-301000&#39; }

          it &#39;divides the interval into 15 seconds steps&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(scheduling)::context(when the interval length is longer than 150 seconds)::it#divides the interval into 15 seconds steps has a flog score of 29</span>          </div>  </li></ol>
            expect(state_applier).to receive(:sleep).with(15.0).exactly(20).times
            expect { state_applier.apply(update_config) }.to raise_error
          end
        end
      end

      context &#39;when trying to start a job&#39; do
        context &#39;when job does not start within max_watch_time&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="state_applier_spec.html#L180" class="js-smell-location">0</a>                  <a href="state_applier_spec.html#L282" class="js-smell-location">1</a>                  </div>  </li></ol>
          before do
            allow(agent_client).to receive(:get_state)
              .and_return(
                {
                  &#39;job_state&#39; =&gt; &#39;stopped&#39;,
                  &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;failing&#39;, &#39;name&#39; =&gt; &#39;broken_template&#39; }],
                },
                {
                  &#39;job_state&#39; =&gt; &#39;stopped&#39;,
                  &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;failing&#39;, &#39;name&#39; =&gt; &#39;broken_template&#39; }],
                },
              )
          end

          it &#39;raises AgentJobNotRunning&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when job does not start within max_watch_time)::it#raises AgentJobNotRunning has a flog score of 35</span>          </div>  </li></ol>
            expect(state_applier).to receive(:sleep).with(1.0).twice
            expect(agent_client).to_not receive(:run_script).with(&#39;post-start&#39;, {})

            expect { state_applier.apply(update_config) }.to raise_error(
              AgentJobNotRunning,
              &quot;&#39;fake-job/uuid-1 (0)&#39; is not running after update. Review logs for failed jobs: broken_template&quot;,
            )
          end

          it &#39;does not update state on the instance model&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when job does not start within max_watch_time)::it#does not update state on the instance model has a flog score of 38</span>          </div>  </li></ol>
            expect(instance.model.state).to eq(&#39;stopped&#39;)

            expect { state_applier.apply(update_config) }.to raise_error AgentJobNotRunning
            expect(instance.model.state).to eq(&#39;stopped&#39;)
          end
        end

        context &#39;when a stopped job does not have processes defined&#39; do
          before do
            allow(agent_client).to receive(:get_state).and_return(&#39;job_state&#39; =&gt; &#39;stopped&#39;)
          end

          it &#39;raises AgentJobNotRunning with no failing jobs&#39; do
            expect { state_applier.apply(update_config) }.to raise_error(
              AgentJobNotRunning,
              &quot;&#39;fake-job/uuid-1 (0)&#39; is not running after update.&quot;,
            )
          end
        end

        context &#39;when the job successfully starts&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context#when the job successfully starts has a flog score of 29</span>          </div>  </li></ol>
          before do
            allow(agent_client).to receive(:get_state)
              .and_return(
                {
                  &#39;job_state&#39; =&gt; &#39;stopped&#39;,
                  &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;failing&#39;, &#39;name&#39; =&gt; &#39;broken_template&#39; }],
                },
                {
                  &#39;job_state&#39; =&gt; &#39;running&#39;,
                  &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;starting&#39;, &#39;name&#39; =&gt; &#39;template&#39; }],
                },
              )
            allow(state_applier).to receive(:sleep)
            allow(agent_client).to receive(:run_script)
          end

          it &#39;runs the post-start script after instance is in desired state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="state_applier_spec.html#L243" class="js-smell-location">0</a>                  <a href="state_applier_spec.html#L328" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when the job successfully starts)::it#runs the post-start script after instance is in desired state has a flog score of 29</span>          </div>  </li></ol>
            expect(state_applier).to receive(:sleep).with(1.0).twice
            expect(agent_client).to receive(:run_script).with(&#39;post-start&#39;, {})

            state_applier.apply(update_config)
          end

          it &#39;logs while waiting until instance is in desired state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when the job successfully starts)::it#logs while waiting until instance is in desired state has a flog score of 103</span>          </div>  </li></ol>
            expect(logger).to receive(:info).with(&#39;Applying VM state&#39;).ordered
            expect(logger).to receive(:info).with(&#39;Running pre-start for fake-job/uuid-1 (0)&#39;).ordered
            expect(logger).to receive(:info).with(&#39;Starting instance fake-job/uuid-1 (0)&#39;).ordered
            expect(logger).to receive(:info).with(&#39;Waiting for 1.0 seconds to check fake-job/uuid-1 (0) status&#39;).ordered
            expect(logger).to receive(:info).with(&#39;Checking if fake-job/uuid-1 (0) has been updated after 1.0 seconds&#39;).ordered
            expect(logger).to receive(:info).with(&#39;Waiting for 1.0 seconds to check fake-job/uuid-1 (0) status&#39;).ordered
            expect(logger).to receive(:info).with(&#39;Checking if fake-job/uuid-1 (0) has been updated after 1.0 seconds&#39;).ordered
            expect(logger).to receive(:info).with(&#39;Running post-start for fake-job/uuid-1 (0)&#39;).ordered

            state_applier.apply(update_config)
          end

          it &#39;updates state on the instance model after agent reports that job is in desired state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when the job successfully starts)::it#updates state on the instance model after agent reports that job is in desired state has a flog score of 43</span>          </div>  </li></ol>
            allow(agent_client).to receive(:run_script)
            allow(agent_client).to receive(:get_state)
              .and_return(
                &#39;job_state&#39; =&gt; &#39;running&#39;,
                &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;starting&#39;, &#39;name&#39; =&gt; &#39;template&#39; }],
              ).ordered
            expect do
              state_applier.apply(update_config)
            end.to change(instance.model, :state)
              .from(&#39;stopped&#39;)
              .to(&#39;started&#39;)
          end
        end

        context &#39;when trying to stop a job&#39; do
          let(:instance_state) { &#39;stopped&#39; }
          let(:instance_model_state) { &#39;started&#39; }

          context &#39;when job does not stop within max_watch_time&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="state_applier_spec.html#L180" class="js-smell-location">0</a>                  <a href="state_applier_spec.html#L282" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              allow(agent_client).to receive(:get_state)
                .and_return(
                  {
                    &#39;job_state&#39; =&gt; &#39;running&#39;,
                    &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;starting&#39;, &#39;name&#39; =&gt; &#39;template&#39; }],
                  },
                  {
                    &#39;job_state&#39; =&gt; &#39;running&#39;,
                    &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;starting&#39;, &#39;name&#39; =&gt; &#39;template&#39; }],
                  },
                )
            end

            it &#39;raises AgentJobNotStopped&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when trying to stop a job)::context(when job does not stop within max_watch_time)::it#raises AgentJobNotStopped has a flog score of 37</span>          </div>  </li></ol>
              expect(state_applier).to receive(:sleep).with(1.0).twice
              expect(agent_client).to_not receive(:run_script).with(&#39;post-start&#39;, {})

              expect { state_applier.apply(update_config) }.to raise_error(
                AgentJobNotStopped,
                &quot;&#39;fake-job/uuid-1 (0)&#39; is still running despite the stop command&quot;,
              )
            end

            it &#39;does not update state on the instance model&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when trying to stop a job)::context(when job does not stop within max_watch_time)::it#does not update state on the instance model has a flog score of 40</span>          </div>  </li></ol>
              expect(instance.model.state).to eq(&#39;started&#39;)

              expect { state_applier.apply(update_config) }.to raise_error AgentJobNotStopped
              expect(instance.model.state).to eq(&#39;started&#39;)
            end
          end

          context &#39;when the job successfully stops&#39; do
            before do
              allow(agent_client).to receive(:get_state).and_return(
                {
                  &#39;job_state&#39; =&gt; &#39;running&#39;,
                  &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;starting&#39;, &#39;name&#39; =&gt; &#39;template&#39; }],
                }, {
                  &#39;job_state&#39; =&gt; &#39;stopped&#39;,
                  &#39;processes&#39; =&gt; [{ &#39;state&#39; =&gt; &#39;failing&#39;, &#39;name&#39; =&gt; &#39;broken_template&#39; }],
                }
              )
            end

            it &#39;does not run the post-start script after instance is in desired state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="state_applier_spec.html#L243" class="js-smell-location">0</a>                  <a href="state_applier_spec.html#L328" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(waiting for job to be running)::context(when trying to start a job)::context(when trying to stop a job)::context(when the job successfully stops)::it#does not run the post-start script after instance is in desired state has a flog score of 30</span>          </div>  </li></ol>
              expect(state_applier).to receive(:sleep).with(1.0).twice
              expect(agent_client).to_not receive(:run_script).with(&#39;post-start&#39;, {})

              state_applier.apply(update_config)
            end
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
