<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit /</small> metadata_updater_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">204</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">37</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">550.62</span><small> complexity</small></div>
              <div><span class="metric">344</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                10
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;logger&#39;
require &#39;timecop&#39;

describe Bosh::Director::MetadataUpdater do
  subject(:metadata_updater) { described_class.new(director_metadata, logger) }
  let(:director_metadata) do
    {}
  end
  let(:vm) do
    BD::Models::Vm.make(cid: &#39;fake-vm-cid&#39;, instance_id: instance.id, cpi: &#39;cpi1&#39;)
  end
  let(:instance) do
    BD::Models::Instance.make(
      deployment: deployment,
      uuid: &#39;some_instance_id&#39;,
      job: &#39;job-value&#39;,
      index: 12_345,
      availability_zone: &#39;az1&#39;,
    )
  end
  let(:deployment) { BD::Models::Deployment.make(name: &#39;deployment-value&#39;) }
  let(:cloud) { instance_double(Bosh::Clouds::ExternalCpi) }

  before do
    instance.active_vm = vm
    instance.save
  end

  describe &#39;.build&#39; do
    it &#39;returns metadata updater&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(.build)::it#returns metadata updater has a flog score of 27</span>          </div>  </li></ol>
      logger = double(&#39;logger&#39;)
      allow(Bosh::Director::Config).to receive_messages(name: &#39;fake-director-name&#39;, logger: logger)

      updater = instance_double(&#39;Bosh::Director::MetadataUpdater&#39;)
      expect(described_class).to receive(:new).with(
          {&#39;director&#39; =&gt; &#39;fake-director-name&#39;}, logger).and_return(updater)

      expect(described_class.build).to eq(updater)
    end
  end

  describe &#39;#update_vm_metadata&#39; do
    let(:cloud_factory) { instance_double(Bosh::Director::CloudFactory) }

    context &#39;with existing cloud factory&#39; do
      it &#39;uses passed in factory&#39; do
        expect(cloud_factory).to receive(:get).with(&#39;cpi1&#39;).and_return(cloud)
        metadata_updater.update_vm_metadata(instance, vm, {}, cloud_factory)
      end
    end

    context &#39;with global cloud factory&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#update_vm_metadata)::context#with global cloud factory has a flog score of 34</span>          </div>  </li></ol>
      before do
        allow(Bosh::Director::CloudFactory).to receive(:create).and_return(cloud_factory)
        expect(cloud_factory).to receive(:get).with(instance.active_vm.cpi).and_return(cloud)
      end

      context &#39;when CPI supports setting vm metadata&#39; do
        it &#39;updates vm metadata with provided metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L60" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L172" class="js-smell-location">1</a>                  </div>  </li></ol>
          expected_vm_metadata = {&#39;fake-custom-key1&#39; =&gt; &#39;fake-custom-value1&#39;}
          expect(cloud).to receive(:set_vm_metadata).with(&#39;fake-vm-cid&#39;, hash_including(expected_vm_metadata))
          metadata_updater.update_vm_metadata(instance, vm, expected_vm_metadata)
        end

        it &#39;updates vm metadata with director metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L66" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L139" class="js-smell-location">1</a>                  </div>  </li></ol>
          expected_vm_metadata = {&#39;fake-director-key1&#39; =&gt; &#39;fake-director-value1&#39;}
          director_metadata.merge!(expected_vm_metadata)
          expect(cloud).to receive(:set_vm_metadata).with(&#39;fake-vm-cid&#39;, hash_including(expected_vm_metadata))
          metadata_updater.update_vm_metadata(instance, vm, {})
        end

        it &#39;updates vm metadata with creation time&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L73" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L178" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#update_vm_metadata)::context(with global cloud factory)::context(when CPI supports setting vm metadata)::it#updates vm metadata with creation time has a flog score of 29</span>          </div>  </li></ol>
          Timecop.freeze do
            expected_vm_metadata = {&#39;created_at&#39; =&gt; Time.new.getutc.strftime(&#39;%Y-%m-%dT%H:%M:%SZ&#39;)}
            expect(cloud).to receive(:set_vm_metadata).with(&#39;fake-vm-cid&#39;, hash_including(expected_vm_metadata))
            metadata_updater.update_vm_metadata(instance, vm, {})
          end
        end

        it &#39;updates vm metadata with deployment specific metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L81" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L99" class="js-smell-location">1</a>                  <a href="metadata_updater_spec.html#L146" class="js-smell-location">2</a>                  <a href="metadata_updater_spec.html#L167" class="js-smell-location">3</a>                  </div>  </li></ol>
          expect(cloud).to receive(:set_vm_metadata)
                             .with(&#39;fake-vm-cid&#39;, hash_including(&#39;deployment&#39; =&gt; &#39;deployment-value&#39;))
          metadata_updater.update_vm_metadata(instance, vm, {})
        end

        it &#39;updates vm metadata with instance specific metadata&#39; do
          expected_vm_metadata = {
            &#39;id&#39; =&gt; &#39;some_instance_id&#39;,
            &#39;job&#39; =&gt; &#39;job-value&#39;,
            &#39;index&#39; =&gt; &#39;12345&#39;,
            &#39;name&#39; =&gt; &#39;job-value/some_instance_id&#39;,
            &#39;instance_group&#39; =&gt; &#39;job-value&#39;,
          }
          expect(cloud).to receive(:set_vm_metadata).with(&#39;fake-vm-cid&#39;, hash_including(expected_vm_metadata))
          metadata_updater.update_vm_metadata(instance, vm, {})
        end

        it &#39;turns job index metadata into a string&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L81" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L99" class="js-smell-location">1</a>                  <a href="metadata_updater_spec.html#L146" class="js-smell-location">2</a>                  <a href="metadata_updater_spec.html#L167" class="js-smell-location">3</a>                  </div>  </li></ol>
          expect(cloud).to receive(:set_vm_metadata).with(&#39;fake-vm-cid&#39;, hash_including(&#39;index&#39; =&gt; &#39;12345&#39;))
          metadata_updater.update_vm_metadata(instance, vm, {})
        end
      end

      context &#39;when CPI does not support setting vm metadata&#39; do
        it &#39;does not mutate passed metadata&#39; do
          passed_in_metadata = {}
          metadata_updater.update_vm_metadata(instance, vm, passed_in_metadata)
          expect(passed_in_metadata).to eq({})
        end
      end

      context &#39;when set_vm_metadata is not part of CPI&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L113" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L187" class="js-smell-location">1</a>                  </div>  </li></ol>
        before { allow(cloud).to receive(:respond_to?).with(:set_vm_metadata).and_return(false) }

        it &#39;does not set vm metadata&#39; do
          expect(cloud).not_to receive(:set_vm_metadata)
          metadata_updater.update_vm_metadata(instance, vm, {})
        end
      end

      context &#39;when set_vm_metadata raises not implemented error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L122" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L196" class="js-smell-location">1</a>                  </div>  </li></ol>
        before { allow(cloud).to receive(:set_vm_metadata).and_raise(Bosh::Clouds::NotImplemented) }

        it &#39;does not propagate raised error&#39; do
          expect { metadata_updater.update_vm_metadata(instance, vm, {}) }.to_not raise_error
        end
      end
    end
  end

  describe &#39;#update_disk_metadata&#39; do
    let(:disk) { BD::Models::PersistentDisk.make(instance: instance, disk_cid: &#39;fake-disk-cid&#39;)}
    before do
      instance.add_persistent_disk(disk) if disk
    end

    context &#39;when CPI supports setting disk metadata&#39; do
      it &#39;adds director metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L66" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L139" class="js-smell-location">1</a>                  </div>  </li></ol>
        expected_disk_metadata = {&#39;fake-director-key1&#39; =&gt; &#39;fake-director-value1&#39;}
        director_metadata.merge!(expected_disk_metadata)
        expect(cloud).to receive(:set_disk_metadata).with(&#39;fake-disk-cid&#39;, hash_including(expected_disk_metadata))
        metadata_updater.update_disk_metadata(cloud, disk, {})
      end

      it &#39;adds deployment specific metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L81" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L99" class="js-smell-location">1</a>                  <a href="metadata_updater_spec.html#L146" class="js-smell-location">2</a>                  <a href="metadata_updater_spec.html#L167" class="js-smell-location">3</a>                  </div>  </li></ol>
        expect(cloud).to receive(:set_disk_metadata).with(&#39;fake-disk-cid&#39;,
          hash_including({&#39;deployment&#39; =&gt; &#39;deployment-value&#39;}))
        metadata_updater.update_disk_metadata(cloud, disk, {})
      end

      it &#39;adds instance specific metadata&#39; do
        expected_disk_metadata = {
          &#39;instance_id&#39; =&gt; &#39;some_instance_id&#39;,
          &#39;instance_index&#39; =&gt; &#39;12345&#39;,
          &#39;instance_group&#39; =&gt; &#39;job-value&#39;,
        }
        expect(cloud).to receive(:set_disk_metadata).with(&#39;fake-disk-cid&#39;, hash_including(expected_disk_metadata))
        metadata_updater.update_disk_metadata(cloud, disk, {})
      end

      it &#39;does not include job in disk metadata&#39; do
        expect(cloud).to receive(:set_disk_metadata).with(&#39;fake-disk-cid&#39;, hash_excluding(&#39;job&#39;))
        metadata_updater.update_disk_metadata(cloud, disk, {})
      end

      it &#39;turns job index metadata into a string&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L81" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L99" class="js-smell-location">1</a>                  <a href="metadata_updater_spec.html#L146" class="js-smell-location">2</a>                  <a href="metadata_updater_spec.html#L167" class="js-smell-location">3</a>                  </div>  </li></ol>
        expect(cloud).to receive(:set_disk_metadata).with(&#39;fake-disk-cid&#39;, hash_including({&#39;instance_index&#39; =&gt; &#39;12345&#39;}))
        metadata_updater.update_disk_metadata(cloud, disk, {})
      end

      it &#39;updates disk metadata with provided metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L60" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L172" class="js-smell-location">1</a>                  </div>  </li></ol>
        expected_disk_metadata = {&#39;fake-custom-key1&#39; =&gt; &#39;fake-custom-value1&#39;}
        expect(cloud).to receive(:set_disk_metadata).with(&#39;fake-disk-cid&#39;, hash_including(expected_disk_metadata))
        metadata_updater.update_disk_metadata(cloud, disk, expected_disk_metadata)
      end

      it &#39;updates disk metadata with attachment time&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L73" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L178" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#update_disk_metadata)::context(when CPI supports setting disk metadata)::it#updates disk metadata with attachment time has a flog score of 28</span>          </div>  </li></ol>
        Timecop.freeze do
          expected_disk_metadata = {&#39;attached_at&#39; =&gt; Time.new.getutc.strftime(&#39;%Y-%m-%dT%H:%M:%SZ&#39;)}
          expect(cloud).to receive(:set_disk_metadata).with(&#39;fake-disk-cid&#39;, hash_including(expected_disk_metadata))
          metadata_updater.update_disk_metadata(cloud, disk, {})
        end
      end
    end

    context &#39;when set_disk_metadata is not part of CPI&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L113" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L187" class="js-smell-location">1</a>                  </div>  </li></ol>
      before { allow(cloud).to receive(:respond_to?).with(:set_disk_metadata).and_return(false) }

      it &#39;does not set disk metadata&#39; do
        expect(cloud).not_to receive(:set_disk_metadata)
        metadata_updater.update_disk_metadata(cloud, disk, {})
      end
    end

    context &#39;when set_disk_metadata raises not implemented error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="metadata_updater_spec.html#L122" class="js-smell-location">0</a>                  <a href="metadata_updater_spec.html#L196" class="js-smell-location">1</a>                  </div>  </li></ol>
      before { allow(cloud).to receive(:set_disk_metadata).and_raise(Bosh::Clouds::NotImplemented) }

      it &#39;does not propagate raised error&#39; do
        expect { metadata_updater.update_disk_metadata(cloud, disk, {}) }.to_not raise_error
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
