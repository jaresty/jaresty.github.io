<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:37:13 -0700'>2018-05-31 11:37:13 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/jobs /</small> update_release_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">1283</span><small> lines of codes</small></div>
              <div><span class="metric">1</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2396.1</span><small> complexity/method</small></div>
              <div><span class="metric">101</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2396.09</span><small> complexity</small></div>
              <div><span class="metric">1094</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                57
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;support/release_helper&#39;
require &#39;digest&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe Jobs::UpdateRelease do
    before do
      allow(Bosh::Director::Config).to receive(:verify_multidigest_path).and_return(&#39;some/path&#39;)
      allow(App).to receive_message_chain(:instance, :blobstores, :blobstore).and_return(blobstore)
    end
    let(:blobstore) { instance_double(&#39;Bosh::Blobstore::BaseClient&#39;) }
    let(:task) { Models::Task.make(id: 42) }
    let(:task_writer) {Bosh::Director::TaskDBWriter.new(:event_output, task.id)}
    let(:event_log) {Bosh::Director::EventLog::Log.new(task_writer)}

    before {
      allow(Config).to receive(:event_log).and_return(event_log)
    }

    describe &#39;DJ job class expectations&#39; do
      let(:job_type) { :update_release }
      let(:queue) { :normal }
      it_behaves_like &#39;a DJ job&#39;
    end

    describe &#39;Compiled release upload&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe#Compiled release upload has a flog score of 36</span>          </div>  </li></ol>
      subject(:job) { Jobs::UpdateRelease.new(release_path, job_options) }

      let(:release_dir) { Test::ReleaseHelper.new.create_release_tarball(manifest) }
      let(:release_path) { File.join(release_dir, &#39;release.tgz&#39;) }
      let(:release_version) { &#39;42+dev.6&#39; }
      let(:release) { Models::Release.make(name: &#39;appcloud&#39;) }

      let(:manifest_jobs) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L34" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L414" class="js-smell-location">1</a>                  </div>  </li></ol>
        [
            {
                &#39;name&#39; =&gt; &#39;fake-job-1&#39;,
                &#39;version&#39; =&gt; &#39;fake-version-1&#39;,
                &#39;sha1&#39; =&gt; &#39;fakesha11&#39;,
                &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-1&#39;,
                &#39;templates&#39; =&gt; {}
            },
            {
                &#39;name&#39; =&gt; &#39;fake-job-2&#39;,
                &#39;version&#39; =&gt; &#39;fake-version-2&#39;,
                &#39;sha1&#39; =&gt; &#39;fake-sha1-2&#39;,
                &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-2&#39;,
                &#39;templates&#39; =&gt; {}
            }
        ]
      end
      let(:manifest_compiled_packages) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L365" class="js-smell-location">1</a>                  </div>  </li></ol>
        [
            {
                &#39;sha1&#39; =&gt; &#39;fakesha1&#39;,
                &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-1&#39;,
                &#39;name&#39; =&gt; &#39;fake-name-1&#39;,
                &#39;version&#39; =&gt; &#39;fake-version-1&#39;
            },
            {
                &#39;sha1&#39; =&gt; &#39;fakesha2&#39;,
                &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-2&#39;,
                &#39;name&#39; =&gt; &#39;fake-name-2&#39;,
                &#39;version&#39; =&gt; &#39;fake-version-2&#39;
            }
        ]
      end
      let(:manifest) do
        {
            &#39;name&#39; =&gt; &#39;appcloud&#39;,
            &#39;version&#39; =&gt; release_version,
            &#39;jobs&#39; =&gt; manifest_jobs,
            &#39;compiled_packages&#39; =&gt; manifest_compiled_packages,
        }
      end

      let(:job_options) do
        { &#39;remote&#39; =&gt; false }
      end

      before do
        allow(Dir).to receive(:mktmpdir).and_return(release_dir)
        allow(job).to receive(:with_release_lock).and_yield
        allow(blobstore).to receive(:create)
        allow(job).to receive(:register_package)
      end

      it &#39;should process packages for compiled release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(Compiled release upload)::it#should process packages for compiled release has a flog score of 42</span>          </div>  </li></ol>
          expect(job).to receive(:create_packages)
          expect(job).to receive(:use_existing_packages)
          expect(job).to receive(:create_compiled_packages)
          expect(job).to receive(:register_template).twice
          expect(job).to receive(:create_job).twice

          job.perform
        end
    end

    describe &#39;#perform&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe##perform has a flog score of 31</span>          </div>  </li></ol>
      subject(:job) { Jobs::UpdateRelease.new(release_path, job_options) }
      let(:job_options) do
        {}
      end

      let(:release_dir) { Test::ReleaseHelper.new.create_release_tarball(manifest) }
      before { allow(Dir).to receive(:mktmpdir).and_return(release_dir) }

      let(:release_path) { File.join(release_dir, &#39;release.tgz&#39;) }

      let(:manifest) do
        {
          &#39;name&#39; =&gt; &#39;appcloud&#39;,
          &#39;version&#39; =&gt; release_version,
          &#39;commit_hash&#39; =&gt; &#39;12345678&#39;,
          &#39;uncommitted_changes&#39; =&gt; true,
          &#39;jobs&#39; =&gt; manifest_jobs,
          &#39;packages&#39; =&gt; manifest_packages,
        }
      end
      let(:release_version) { &#39;42+dev.6&#39; }
      let(:release) { Models::Release.make(name: &#39;appcloud&#39;) }
      let(:manifest_packages) { nil }
      let(:manifest_jobs) { nil }
      let(:status) { instance_double(Process::Status, exitstatus: 0)}

      before do
        allow(Open3).to receive(:capture3).and_return([nil, &#39;some error&#39;, status])
        allow(job).to receive(:with_release_lock).and_yield
      end

      context &#39;when release is local&#39; do
        let(:job_options) do
          {}
        end

        it &#39;with a local release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L136" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L150" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when release is local)::it#with a local release has a flog score of 34</span>          </div>  </li></ol>
          expect(job).not_to receive(:download_remote_release)
          expect(job).to receive(:extract_release)
          expect(job).to receive(:verify_manifest)
          expect(job).to receive(:process_release)
          job.perform
        end
      end

      context &#39;when release is remote&#39; do
        let(:job_options) do
          { &#39;remote&#39; =&gt; true, &#39;location&#39; =&gt; &#39;release_location&#39; }
        end

        it &#39;with a remote release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L136" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L150" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when release is remote)::it#with a remote release has a flog score of 34</span>          </div>  </li></ol>
          expect(job).to receive(:download_remote_release)
          expect(job).to receive(:extract_release)
          expect(job).to receive(:verify_manifest)
          expect(job).to receive(:process_release)

          job.perform
        end

        context &#39;with multiple digests&#39; do
          context &#39;when the digest matches&#39; do
            let(:job_options) do
              {
                &#39;remote&#39; =&gt; true,
                &#39;location&#39; =&gt; &#39;release_location&#39;,
                &#39;sha1&#39; =&gt; &quot;sha1:#{::Digest::SHA1.file(release_path).hexdigest}&quot;,
              }
            end

            it &#39;verifies that the digest matches the release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when release is remote)::context(with multiple digests)::context(when the digest matches)::it#verifies that the digest matches the release has a flog score of 34</span>          </div>  </li></ol>
              allow(job).to receive(:release_path).and_return(release_path)

              expect(job).to receive(:download_remote_release)
              expect(job).to receive(:process_release)

              job.perform
            end
          end

          context &#39;when the digest does not match&#39; do
            let(:status) { instance_double(Process::Status, exitstatus: 1)}
            let(:job_options) do
              { &#39;remote&#39; =&gt; true, &#39;location&#39; =&gt; &#39;release_location&#39;, &#39;sha1&#39; =&gt; &#39;sha1:potato&#39; }
            end

            it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when release is remote)::context(with multiple digests)::context(when the digest does not match)::it#raises an error has a flog score of 32</span>          </div>  </li></ol>
              allow(job).to receive(:release_path).and_return(release_path)
              expect(job).to receive(:download_remote_release)

              expect {
                job.perform
              }.to raise_exception(Bosh::Director::ReleaseSha1DoesNotMatch, &#39;some error&#39;)
            end
          end

        end
      end

      context &#39;when commit_hash and uncommitted changes flag are present&#39; do
        let(:manifest) do
          {
            &#39;name&#39; =&gt; &#39;appcloud&#39;,
            &#39;version&#39; =&gt; &#39;42.6-dev&#39;,
            &#39;commit_hash&#39; =&gt; &#39;12345678&#39;,
            &#39;uncommitted_changes&#39; =&gt; &#39;true&#39;,
            &#39;jobs&#39; =&gt; [],
            &#39;packages&#39; =&gt; [],
          }
        end

        it &#39;sets commit_hash and uncommitted changes flag on release_version&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when commit_hash and uncommitted changes flag are present)::it#sets commit_hash and uncommitted changes flag on release_version has a flog score of 28</span>          </div>  </li></ol>
          job.perform

          rv = Models::ReleaseVersion.filter(version: &#39;42+dev.6&#39;).first
          expect(rv).not_to be_nil
          expect(rv.commit_hash).to eq(&#39;12345678&#39;)
          expect(rv.uncommitted_changes).to be(true)
        end
      end

      context &#39;when commit_hash and uncommitted_changes flag are missing&#39; do
        let(:manifest) do
          {
            &#39;name&#39; =&gt; &#39;appcloud&#39;,
            &#39;version&#39; =&gt; &#39;42.6-dev&#39;,
            &#39;jobs&#39; =&gt; [],
            &#39;packages&#39; =&gt; []
          }
        end

        it &#39;sets default commit_hash and uncommitted changes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when commit_hash and uncommitted_changes flag are missing)::it#sets default commit_hash and uncommitted changes has a flog score of 28</span>          </div>  </li></ol>
          job.perform

          rv = Models::ReleaseVersion.filter(version: &#39;42+dev.6&#39;).first
          expect(rv).not_to be_nil
          expect(rv.commit_hash).to eq(&#39;unknown&#39;)
          expect(rv.uncommitted_changes).to be(false)
        end
      end

      context &#39;when extracting release fails&#39; do
        before do
          result = Bosh::Exec::Result.new(&#39;cmd&#39;, &#39;output&#39;, 1)
          expect(Bosh::Exec).to receive(:sh).and_return(result)
        end

        it &#39;raises an error&#39; do
          expect {
            job.perform
          }.to raise_exception(Bosh::Director::ReleaseInvalidArchive)
        end

        it &#39;deletes release archive and the release dir&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when extracting release fails)::it#deletes release archive and the release dir has a flog score of 29</span>          </div>  </li></ol>
          expect(FileUtils).to receive(:rm_rf).with(release_dir)
          expect(FileUtils).to receive(:rm_rf).with(release_path)

          expect {
            job.perform
          }.to raise_exception(Bosh::Director::ReleaseInvalidArchive)
        end
      end

      it &#39;saves release version&#39; do
        job.perform

        rv = Models::ReleaseVersion.filter(version: &#39;42+dev.6&#39;).first
        expect(rv).to_not be_nil
      end

      it &#39;resolves package dependencies&#39; do
        expect(job).to receive(:resolve_package_dependencies)
        job.perform
      end

      it &#39;deletes release archive and extraction directory&#39; do
        expect(FileUtils).to receive(:rm_rf).with(release_dir)
        expect(FileUtils).to receive(:rm_rf).with(release_path)

        job.perform
      end

      context &#39;release already exists&#39; do
        before { Models::ReleaseVersion.make(release: release, version: &#39;42+dev.6&#39;, commit_hash: &#39;12345678&#39;, uncommitted_changes: true) }

        context &#39;when rebase is passed&#39; do
          let(:job_options) do
            { &#39;rebase&#39; =&gt; true }
          end

          context &#39;when there are package changes&#39; do
            let(:manifest_packages) do
              [
                {
                  &#39;sha1&#39; =&gt; &#39;fakesha1&#39;,
                  &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-1&#39;,
                  &#39;name&#39; =&gt; &#39;fake-name-1&#39;,
                  &#39;version&#39; =&gt; &#39;fake-version-1&#39;
                }
              ]
            end

            it &#39;sets a next release version&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(release already exists)::context(when rebase is passed)::context(when there are package changes)::it#sets a next release version has a flog score of 31</span>          </div>  </li></ol>
              expect(job).to receive(:create_package)
              expect(job).to receive(:register_package)
              job.perform

              rv = Models::ReleaseVersion.filter(version: &#39;42+dev.7&#39;).first
              expect(rv).to_not be_nil
            end
          end

          context &#39;when there are no job and package changes&#39; do
            it &#39;still can pass and set a next release version&#39; do
              # it just generate the next release version without creating/registering package
              expect {
                job.perform
              }.to_not raise_error

              rv = Models::ReleaseVersion.filter(version: &#39;42+dev.7&#39;).first
              expect(rv).to_not be_nil
            end
          end
        end

        context &#39;when skip_if_exists is passed&#39; do
          let(:job_options) do
            { &#39;skip_if_exists&#39; =&gt; true }
          end

          it &#39;does not create a release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="../deployment_plan/assembler_spec.html#L310" class="js-smell-location">0</a>                  <a href="../deployment_plan/stages/update_errands_stage_spec.html#L33" class="js-smell-location">1</a>                  <a href="run_errand_spec.html#L281" class="js-smell-location">2</a>                  <a href="scheduled_backup_spec.html#L47" class="js-smell-location">3</a>                  <a href="update_release_spec.html#L329" class="js-smell-location">4</a>                  </div>  </li></ol>
            expect(job).not_to receive(:create_package)
            expect(job).not_to receive(:create_job)
            job.perform
          end
        end
      end

      context &#39;when the same release is uploaded with different commit hash&#39; do
        before { Models::ReleaseVersion.make(release: release, version: &#39;42+dev.6&#39;, commit_hash: &#39;bad123&#39;, uncommitted_changes: true) }

        it &#39;fails with a ReleaseVersionCommitHashMismatch exception&#39; do
          expect {
            job.perform
          }.to raise_exception(Bosh::Director::ReleaseVersionCommitHashMismatch)
        end
      end

      context &#39;when the release version does not match database valid format&#39; do
        before do
          # We only want to verify that the proper error is raised
          # If version can not be validated because it has wrong model format
          # Currently SemiSemantic Version validates version that matches the model format
          stub_const(&quot;Bosh::Director::Models::VALID_ID&quot;, /^[a-z0-9]+$/i)
        end

        let(:release_version) { &#39;bad-version&#39; }

        it &#39;raises an error ReleaseVersionInvalid&#39; do
          expect {
            job.perform
          }.to raise_error(Sequel::ValidationFailed)
        end
      end

      context &#39;when there are packages in manifest&#39; do
        let(:manifest_packages) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L365" class="js-smell-location">1</a>                  </div>  </li></ol>
          [
            {
              &#39;sha1&#39; =&gt; &#39;fakesha1&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-1&#39;,
              &#39;name&#39; =&gt; &#39;fake-name-1&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-1&#39;
            },
            {
              &#39;sha1&#39; =&gt; &#39;fakesha2&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-2&#39;,
              &#39;name&#39; =&gt; &#39;fake-name-2&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-2&#39;
            }
          ]
        end

        before do
          Models::Package.make(release: release, name: &#39;fake-name-1&#39;, version: &#39;fake-version-1&#39;, fingerprint: &#39;fake-fingerprint-1&#39;)
        end

        it &quot;creates packages that don&#39;t already exist&quot; do
          expect(job).to receive(:create_packages).with([
            {
              &#39;sha1&#39; =&gt; &#39;fakesha2&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-2&#39;,
              &#39;name&#39; =&gt; &#39;fake-name-2&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-2&#39;,
              &#39;dependencies&#39; =&gt; [],
              &#39;compiled_package_sha1&#39; =&gt; &#39;fakesha2&#39;,
            }
          ], release_dir)
          job.perform
        end

        it &#39;raises an error if a different fingerprint was detected for an already existing package&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L400" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L448" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when there are packages in manifest)::it#raises an error if a different fingerprint was detected for an already existing package has a flog score of 27</span>          </div>  </li></ol>
          pkg = Models::Package.make(release: release, name: &#39;fake-name-2&#39;, version: &#39;fake-version-2&#39;, fingerprint: &#39;different-finger-print&#39;, sha1: &#39;fakesha2&#39;)
          release_version = Models::ReleaseVersion.make(release: release, version: &#39;42+dev.6&#39;, commit_hash: &#39;12345678&#39;, uncommitted_changes: true)
          release_version.add_package(pkg)

          allow(job).to receive(:create_packages)

          expect {
            job.perform
          }.to raise_exception(Bosh::Director::ReleaseInvalidPackage, /package &#39;fake-name-2&#39; had different fingerprint in previously uploaded release &#39;appcloud\/42\+dev.6&#39;/)
        end
      end

      context &#39;when manifest contains jobs&#39; do
        let(:manifest_jobs) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L34" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L414" class="js-smell-location">1</a>                  </div>  </li></ol>
          [
            {
              &#39;name&#39; =&gt; &#39;fake-job-1&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-1&#39;,
              &#39;sha1&#39; =&gt; &#39;fakesha11&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-1&#39;,
              &#39;templates&#39; =&gt; {}
            },
            {
              &#39;name&#39; =&gt; &#39;fake-job-2&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-2&#39;,
              &#39;sha1&#39; =&gt; &#39;fake-sha1-2&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-2&#39;,
              &#39;templates&#39; =&gt; {}
            }
          ]
        end

        it &#39;creates job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when manifest contains jobs)::it#creates job has a flog score of 67</span>          </div>  </li></ol>
          expect(blobstore).to receive(:create) do |file|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L434" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L438" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(file.path).to eq(File.join(release_dir, &#39;jobs&#39;, &#39;fake-job-1.tgz&#39;))
          end

          expect(blobstore).to receive(:create) do |file|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L434" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L438" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(file.path).to eq(File.join(release_dir, &#39;jobs&#39;, &#39;fake-job-2.tgz&#39;))
          end

          job.perform

          expect(Models::Template.all.size).to eq(2)
          expect(Models::Template.all.map(&amp;:name)).to match_array([&#39;fake-job-1&#39;, &#39;fake-job-2&#39;])
        end

        it &#39;raises an error if a different fingerprint was detected for an already existing job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L400" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L448" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when manifest contains jobs)::it#raises an error if a different fingerprint was detected for an already existing job has a flog score of 27</span>          </div>  </li></ol>
          corrupted_job = Models::Template.make(release: release, name: &#39;fake-job-1&#39;, version: &#39;fake-version-1&#39;, fingerprint: &#39;different-finger-print&#39;, sha1: &#39;fakesha11&#39;)
          release_version = Models::ReleaseVersion.make(release: release, version: &#39;42+dev.6&#39;, commit_hash: &#39;12345678&#39;, uncommitted_changes: true)
          release_version.add_template(corrupted_job)

          allow(job).to receive(:process_packages)

          expect {
            job.perform
          }.to raise_exception(Bosh::Director::ReleaseExistingJobFingerprintMismatch, /job &#39;fake-job-1&#39; had different fingerprint in previously uploaded release &#39;appcloud\/42\+dev.6&#39;/)
        end

        it &quot;creates jobs that don&#39;t already exist&quot; do
          Models::Template.make(
              release: release,
              name: &#39;fake-job-1&#39;,
              version: &#39;fake-version-1&#39;,
              fingerprint: &#39;fake-fingerprint-1&#39;
          )
          expect(job).to receive(:create_jobs).with([
              {
                  &#39;sha1&#39; =&gt; &#39;fake-sha1-2&#39;,
                  &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-2&#39;,
                  &#39;name&#39; =&gt; &#39;fake-job-2&#39;,
                  &#39;version&#39; =&gt; &#39;fake-version-2&#39;,
                  &#39;templates&#39; =&gt; {},
              }
          ], release_dir)
          job.perform
        end

        context &#39;when the release contains no packages&#39; do
          before do
            manifest.delete(&#39;packages&#39;)
          end
          it &#39;should not error&#39; do
            allow(job).to receive(:create_jobs)
            expect { job.perform }.to_not raise_error
          end
        end
      end

      context &#39;when manifest contains packages and jobs&#39; do
        let(:manifest_jobs) do [
            {
                &#39;name&#39; =&gt; &#39;zbz&#39;,
                &#39;version&#39; =&gt; &#39;666&#39;,
                &#39;templates&#39; =&gt; {},
                &#39;packages&#39; =&gt; %w(zbb),
                &#39;fingerprint&#39; =&gt; &#39;job-fingerprint-3&#39;
            }
        ]
        end
        let(:manifest_packages) do [
            {
                &#39;name&#39; =&gt; &#39;foo&#39;,
                &#39;version&#39; =&gt; &#39;2.33-dev&#39;,
                &#39;dependencies&#39; =&gt; %w(bar),
                &#39;fingerprint&#39; =&gt; &#39;package-fingerprint-1&#39;,
                &#39;sha1&#39; =&gt; &#39;packagesha11&#39;
            },
            {
                &#39;name&#39; =&gt; &#39;bar&#39;,
                &#39;version&#39; =&gt; &#39;3.14-dev&#39;,
                &#39;dependencies&#39; =&gt; [],
                &#39;fingerprint&#39; =&gt; &#39;package-fingerprint-2&#39;,
                &#39;sha1&#39; =&gt; &#39;packagesha12&#39;
            },
            {
                &#39;name&#39; =&gt; &#39;zbb&#39;,
                &#39;version&#39; =&gt; &#39;333&#39;,
                &#39;dependencies&#39; =&gt; [],
                &#39;fingerprint&#39; =&gt; &#39;package-fingerprint-3&#39;,
                &#39;sha1&#39; =&gt; &#39;packagesha13&#39;
            }
        ]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L523" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L596" class="js-smell-location">1</a>                  </div>  </li></ol>
        end

        it &#39;process packages should include all packages from the manifest in the packages array, even previously existing ones&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#perform)::context(when manifest contains packages and jobs)::it#process packages should include all packages from the manifest in the packages array, even previously existing ones has a flog score of 38</span>          </div>  </li></ol>
          pkg_foo = Models::Package.make(release: release, name: &#39;foo&#39;, version: &#39;2.33-dev&#39;, fingerprint: &#39;package-fingerprint-1&#39;, sha1: &#39;packagesha11&#39;, blobstore_id: &#39;bs1&#39;)
          pkg_bar = Models::Package.make(release: release, name: &#39;bar&#39;, version: &#39;3.14-dev&#39;, fingerprint: &#39;package-fingerprint-2&#39;, sha1: &#39;packagesha12&#39;, blobstore_id: &#39;bs2&#39;)
          pkg_zbb = Models::Package.make(release: release, name: &#39;zbb&#39;, version: &#39;333&#39;, fingerprint: &#39;package-fingerprint-3&#39;, sha1: &#39;packagesha13&#39;, blobstore_id: &#39;bs3&#39;)
          release_version = Models::ReleaseVersion.make(release: release, version: &#39;42+dev.6&#39;, commit_hash: &#39;12345678&#39;, uncommitted_changes: true)
          release_version.add_package(pkg_foo)
          release_version.add_package(pkg_bar)
          release_version.add_package(pkg_zbb)

          expect(BlobUtil).to receive(:create_blob).and_return(&#39;blob_id&#39;)
          allow(blobstore).to receive(:create)

          job.perform
        end
      end
    end

    describe &#39;rebasing release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe#rebasing release has a flog score of 50</span>          </div>  </li></ol>
      let(:manifest) do
        {
          &#39;name&#39; =&gt; &#39;appcloud&#39;,
          &#39;version&#39; =&gt; &#39;42.6-dev&#39;,
          &#39;jobs&#39; =&gt; [
            {
              &#39;name&#39; =&gt; &#39;baz&#39;,
              &#39;version&#39; =&gt; &#39;33&#39;,
              &#39;templates&#39; =&gt; {
                &#39;bin/test.erb&#39; =&gt; &#39;bin/test&#39;,
                &#39;config/zb.yml.erb&#39; =&gt; &#39;config/zb.yml&#39;
              },
              &#39;packages&#39; =&gt; %w(foo bar),
              &#39;fingerprint&#39; =&gt; &#39;job-fingerprint-1&#39;
            },
            {
              &#39;name&#39; =&gt; &#39;zaz&#39;,
              &#39;version&#39; =&gt; &#39;0.2-dev&#39;,
              &#39;templates&#39; =&gt; {},
              &#39;packages&#39; =&gt; %w(bar),
              &#39;fingerprint&#39; =&gt; &#39;job-fingerprint-2&#39;
            },
            {
              &#39;name&#39; =&gt; &#39;zbz&#39;,
              &#39;version&#39; =&gt; &#39;666&#39;,
              &#39;templates&#39; =&gt; {},
              &#39;packages&#39; =&gt; %w(zbb),
              &#39;fingerprint&#39; =&gt; &#39;job-fingerprint-3&#39;
            }
          ],
          &#39;packages&#39; =&gt; [
            {
              &#39;name&#39; =&gt; &#39;foo&#39;,
              &#39;version&#39; =&gt; &#39;2.33-dev&#39;,
              &#39;dependencies&#39; =&gt; %w(bar),
              &#39;fingerprint&#39; =&gt; &#39;package-fingerprint-1&#39;,
              &#39;sha1&#39; =&gt; &#39;packagesha11&#39;
            },
            {
              &#39;name&#39; =&gt; &#39;bar&#39;,
              &#39;version&#39; =&gt; &#39;3.14-dev&#39;,
              &#39;dependencies&#39; =&gt; [],
              &#39;fingerprint&#39; =&gt; &#39;package-fingerprint-2&#39;,
              &#39;sha1&#39; =&gt; &#39;packagesha12&#39;
            },
            {
              &#39;name&#39; =&gt; &#39;zbb&#39;,
              &#39;version&#39; =&gt; &#39;333&#39;,
              &#39;dependencies&#39; =&gt; [],
              &#39;fingerprint&#39; =&gt; &#39;package-fingerprint-3&#39;,
              &#39;sha1&#39; =&gt; &#39;packagesha13&#39;
            }
          ]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L523" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L596" class="js-smell-location">1</a>                  </div>  </li></ol>
        }
      end

      before do
        @release_dir = Test::ReleaseHelper.new.create_release_tarball(manifest)
        @release_path = File.join(@release_dir, &#39;release.tgz&#39;)

        @job = Jobs::UpdateRelease.new(@release_path, &#39;rebase&#39; =&gt; true)

        @release = Models::Release.make(name: &#39;appcloud&#39;)
        @rv = Models::ReleaseVersion.make(release: @release, version: &#39;37&#39;)

        Models::Package.make(release: @release, name: &#39;foo&#39;, version: &#39;2.7-dev&#39;)
        Models::Package.make(release: @release, name: &#39;bar&#39;, version: &#39;42&#39;)

        Models::Template.make(release: @release, name: &#39;baz&#39;, version: &#39;33.7-dev&#39;)
        Models::Template.make(release: @release, name: &#39;zaz&#39;, version: &#39;17&#39;)

        # create up to 6 new blobs (3*job + 3*package)
        allow(blobstore).to receive(:create).at_most(6).and_return(&#39;b1&#39;, &#39;b2&#39;, &#39;b3&#39;, &#39;b4&#39;, &#39;b5&#39;, &#39;b6&#39;)
        # get is only called when a blob is copied
        allow(blobstore).to receive(:get)
        allow(@job).to receive(:with_release_lock).with(&#39;appcloud&#39;).and_yield
      end

      it &#39;rebases the release version&#39; do
        @job.perform

        # No previous release exists with the same release version (42).
        # So the default dev post-release version is used (semi-semantic format).
        rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.1&#39;).first

        expect(rv).to_not be_nil
      end

      context &#39;when the package fingerprint matches one in the database&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L632" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L699" class="js-smell-location">1</a>                  </div>  </li></ol>
        before do
          Models::Package.make(
            release: @release,
            name: &#39;zbb&#39;,
            version: &#39;25&#39;,
            fingerprint: &#39;package-fingerprint-3&#39;,
            sha1: &#39;packagesha1old&#39;,
          )
        end

        it &#39;creates new package (version) with copied blob (sha1)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the package fingerprint matches one in the database)::it(creates new package (version) with copied blob (sha1))#creates new package (version) with copied blob (sha1) has a flog score of 67</span>          </div>  </li></ol>
          expect(blobstore).to receive(:create).exactly(6).times # creates new blobs for each package &amp; job
          expect(blobstore).to receive(:get).exactly(1).times # copies the existing &#39;zbb&#39; package
          @job.perform

          zbbs = Models::Package.filter(release_id: @release.id, name: &#39;zbb&#39;).all
          expect(zbbs.map(&amp;:version)).to match_array(%w(25 333))

          # Fingerprints are the same because package contents did not change
          expect(zbbs.map(&amp;:fingerprint)).to match_array(%w(package-fingerprint-3 package-fingerprint-3))

          # SHA1s are the same because first blob was copied
          expect(zbbs.map(&amp;:sha1)).to match_array(%w(packagesha1old packagesha1old))
        end

        it &#39;associates newly created packages to the release version&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the package fingerprint matches one in the database)::it#associates newly created packages to the release version has a flog score of 50</span>          </div>  </li></ol>
          @job.perform

          rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.1&#39;).first
          expect(rv.packages.map(&amp;:version)).to match_array(%w(2.33-dev 3.14-dev 333))
          expect(rv.packages.map(&amp;:fingerprint)).to match_array(%w(package-fingerprint-1 package-fingerprint-2 package-fingerprint-3))
          expect(rv.packages.map(&amp;:sha1)).to match_array(%w(packagesha11 packagesha12 packagesha1old))
        end
      end

      context &#39;when the package fingerprint matches multiple in the database&#39; do
        before do
          Models::Package.make(release: @release, name: &#39;zbb&#39;, version: &#39;25&#39;, fingerprint: &#39;package-fingerprint-3&#39;, sha1: &#39;packagesha125&#39;)
          Models::Package.make(release: @release, name: &#39;zbb&#39;, version: &#39;26&#39;, fingerprint: &#39;package-fingerprint-3&#39;, sha1: &#39;packagesha126&#39;)
        end

        it &#39;creates new package (version) with copied blob (sha1)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the package fingerprint matches multiple in the database)::it(creates new package (version) with copied blob (sha1))#creates new package (version) with copied blob (sha1) has a flog score of 67</span>          </div>  </li></ol>
          expect(blobstore).to receive(:create).exactly(6).times # creates new blobs for each package &amp; job
          expect(blobstore).to receive(:get).exactly(1).times # copies the existing &#39;zbb&#39; package
          @job.perform

          zbbs = Models::Package.filter(release_id: @release.id, name: &#39;zbb&#39;).all
          expect(zbbs.map(&amp;:version)).to match_array(%w(26 25 333))

          # Fingerprints are the same because package contents did not change
          expect(zbbs.map(&amp;:fingerprint)).to match_array(%w(package-fingerprint-3 package-fingerprint-3 package-fingerprint-3))

          # SHA1s are the same because first blob was copied
          expect(zbbs.map(&amp;:sha1)).to match_array(%w(packagesha125 packagesha125 packagesha126))
        end

        it &#39;associates newly created packages to the release version&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the package fingerprint matches multiple in the database)::it#associates newly created packages to the release version has a flog score of 50</span>          </div>  </li></ol>
          @job.perform

          rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.1&#39;).first
          expect(rv.packages.map(&amp;:version)).to match_array(%w(2.33-dev 3.14-dev 333))
          expect(rv.packages.map(&amp;:fingerprint)).to match_array(%w(package-fingerprint-1 package-fingerprint-2 package-fingerprint-3))
          expect(rv.packages.map(&amp;:sha1)).to match_array(%w(packagesha11 packagesha12 packagesha125))
        end
      end

      context &#39;when the package fingerprint is new&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L632" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L699" class="js-smell-location">1</a>                  </div>  </li></ol>
        before do
          Models::Package.make(release: @release, name: &#39;zbb&#39;, version: &#39;25&#39;, fingerprint: &#39;package-fingerprint-old&#39;, sha1: &#39;packagesha125&#39;)
        end

        it &#39;creates new package (version) with new blob (sha1)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the package fingerprint is new)::it(creates new package (version) with new blob (sha1))#creates new package (version) with new blob (sha1) has a flog score of 67</span>          </div>  </li></ol>
          expect(blobstore).to receive(:create).exactly(6).times # creates new blobs for each package &amp; job
          expect(blobstore).to receive(:get).exactly(0).times # does not copy any existing packages or jobs
          @job.perform

          zbbs = Models::Package.filter(release_id: @release.id, name: &#39;zbb&#39;).all
          expect(zbbs.map(&amp;:version)).to match_array(%w(25 333))

          # Fingerprints are different because package contents are different
          expect(zbbs.map(&amp;:fingerprint)).to match_array(%w(package-fingerprint-old package-fingerprint-3))

          # SHA1s are different because package tars are different
          expect(zbbs.map(&amp;:sha1)).to match_array(%w(packagesha125 packagesha13))
        end

        it &#39;associates newly created packages to the release version&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the package fingerprint is new)::it#associates newly created packages to the release version has a flog score of 50</span>          </div>  </li></ol>
          @job.perform

          rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.1&#39;).first
          expect(rv.packages.map(&amp;:version)).to match_array(%w(2.33-dev 3.14-dev 333))
          expect(rv.packages.map(&amp;:fingerprint)).to match_array(%w(package-fingerprint-1 package-fingerprint-2 package-fingerprint-3))
          expect(rv.packages.map(&amp;:sha1)).to match_array(%w(packagesha11 packagesha12 packagesha13))
        end
      end

      context &#39;when the job fingerprint matches one in the database&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L729" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L748" class="js-smell-location">1</a>                  </div>  </li></ol>
        before do
          Models::Template.make(release: @release, name: &#39;zbz&#39;, version: &#39;28&#39;, fingerprint: &#39;job-fingerprint-3&#39;)
        end

        it &#39;uses the new job blob&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the job fingerprint matches one in the database)::it#uses the new job blob has a flog score of 74</span>          </div>  </li></ol>
          expect(blobstore).to receive(:create).exactly(6).times # creates new blobs for each package &amp; job
          expect(blobstore).to receive(:get).exactly(0).times # does not copy any existing packages or jobs
          @job.perform

          zbzs = Models::Template.filter(release_id: @release.id, name: &#39;zbz&#39;).all
          expect(zbzs.map(&amp;:version)).to match_array(%w(28 666))
          expect(zbzs.map(&amp;:fingerprint)).to match_array(%w(job-fingerprint-3 job-fingerprint-3))

          rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.1&#39;).first
          expect(rv.templates.map(&amp;:fingerprint)).to match_array(%w(job-fingerprint-1 job-fingerprint-2 job-fingerprint-3))
        end
      end

      context &#39;when the job fingerprint is new&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L729" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L748" class="js-smell-location">1</a>                  </div>  </li></ol>
        before do
          Models::Template.make(release: @release, name: &#39;zbz&#39;, version: &#39;28&#39;, fingerprint: &#39;job-fingerprint-old&#39;)
        end

        it &#39;uses the new job blob&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::context(when the job fingerprint is new)::it#uses the new job blob has a flog score of 74</span>          </div>  </li></ol>
          expect(blobstore).to receive(:create).exactly(6).times # creates new blobs for each package &amp; job
          expect(blobstore).to receive(:get).exactly(0).times # does not copy any existing packages or jobs
          @job.perform

          zbzs = Models::Template.filter(release_id: @release.id, name: &#39;zbz&#39;).all
          expect(zbzs.map(&amp;:version)).to match_array(%w(28 666))
          expect(zbzs.map(&amp;:fingerprint)).to match_array(%w(job-fingerprint-old job-fingerprint-3))

          rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.1&#39;).first
          expect(rv.templates.map(&amp;:fingerprint)).to match_array(%w(job-fingerprint-1 job-fingerprint-2 job-fingerprint-3))
        end
      end

      it &#39;uses major+dev.1 version for initial rebase if no version exists&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::it#uses major+dev.1 version for initial rebase if no version exists has a flog score of 95</span>          </div>  </li></ol>
        @rv.destroy
        Models::Package.each { |p| p.destroy }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'p'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L769" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L788" class="js-smell-location">1</a>                  </div>  </li></ol>
        Models::Template.each { |t| t.destroy }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 't'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L770" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L789" class="js-smell-location">1</a>                  </div>  </li></ol>

        @job.perform

        foos = Models::Package.filter(release_id: @release.id, name: &#39;foo&#39;).all
        bars = Models::Package.filter(release_id: @release.id, name: &#39;bar&#39;).all

        expect(foos.map { |foo| foo.version }).to match_array(%w(2.33-dev))
        expect(bars.map { |bar| bar.version }).to match_array(%w(3.14-dev))

        bazs = Models::Template.filter(release_id: @release.id, name: &#39;baz&#39;).all
        zazs = Models::Template.filter(release_id: @release.id, name: &#39;zaz&#39;).all

        expect(bazs.map { |baz| baz.version }).to match_array(%w(33))
        expect(zazs.map { |zaz| zaz.version }).to match_array(%w(0.2-dev))

        rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.1&#39;).first

        expect(rv.packages.map { |p| p.version }).to match_array(%w(2.33-dev 3.14-dev 333))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'p'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L769" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L788" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect(rv.templates.map { |t| t.version }).to match_array(%w(0.2-dev 33 666))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 't'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L770" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L789" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      it &#39;performs the rebase if same release is being rebased twice&#39;, truncation: true, :if =&gt; ENV.fetch(&#39;DB&#39;, &#39;sqlite&#39;) != &#39;sqlite&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(rebasing release)::it#performs the rebase if same release is being rebased twice has a flog score of 52</span>          </div>  </li></ol>
        allow(Config).to receive_message_chain(:current_job, :username).and_return(&#39;username&#39;)
        task = Models::Task.make(state: &#39;processing&#39;)
        allow(Config).to receive_message_chain(:current_job, :task_id).and_return(task.id)

        Config.configure(SpecHelper.spec_get_director_config)
        @job.perform

        @release_dir = Test::ReleaseHelper.new.create_release_tarball(manifest)
        @release_path = File.join(@release_dir, &#39;release.tgz&#39;)
        @job = Jobs::UpdateRelease.new(@release_path, &#39;rebase&#39; =&gt; true)

        expect {
          @job.perform
        }.to_not raise_error

        rv = Models::ReleaseVersion.filter(release_id: @release.id, version: &#39;42+dev.2&#39;).first
        expect(rv).to_not be_nil
      end
    end

    describe &#39;uploading release with --fix&#39; do
      subject(:job) { Jobs::UpdateRelease.new(release_path, &#39;fix&#39; =&gt; true) }
      let(:release_dir) { Test::ReleaseHelper.new.create_release_tarball(manifest) }
      let(:release_path) { File.join(release_dir, &#39;release.tgz&#39;) }
      let!(:release) { Models::Release.make(name: &#39;appcloud&#39;) }

      let!(:release_version_model) do
        Models::ReleaseVersion.make(
          release: release,
          version: &#39;42+dev.1&#39;,
          commit_hash: &#39;12345678&#39;,
          uncommitted_changes: true,
        )
      end
      before do
        allow(Dir).to receive(:mktmpdir).and_return(release_dir)
        allow(job).to receive(:with_release_lock).and_yield
      end

      context &#39;when uploading source release&#39; do
        let(:manifest) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L833" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1001" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &#39;name&#39; =&gt; &#39;appcloud&#39;,
            &#39;version&#39; =&gt; &#39;42+dev.1&#39;,
            &#39;commit_hash&#39; =&gt; &#39;12345678&#39;,
            &#39;uncommitted_changes&#39; =&gt; true,
            &#39;jobs&#39; =&gt; manifest_jobs,
            &#39;packages&#39; =&gt; manifest_packages,
          }
        end
        let(:manifest_jobs) do
          [
            {
              &#39;sha1&#39; =&gt; &#39;fakesha2&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-2&#39;,
              &#39;name&#39; =&gt; &#39;fake-name-2&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-2&#39;,
              &#39;packages&#39; =&gt; [
                &#39;fake-name-1&#39;,
              ],
              &#39;templates&#39; =&gt; {},
            },
          ]
        end
        let(:manifest_packages) do
          [
            {
              &#39;sha1&#39; =&gt; &#39;fakesha1&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-1&#39;,
              &#39;name&#39; =&gt; &#39;fake-name-1&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-1&#39;,
              &#39;dependencies&#39; =&gt; []
            }
          ]
        end

        context &#39;when release already exists&#39; do
          let!(:package) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L870" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L883" class="js-smell-location">1</a>                  <a href="update_release_spec.html#L949" class="js-smell-location">2</a>                  </div>  </li></ol>
            package = Models::Package.make(
              release: release,
              name: &#39;fake-name-1&#39;,
              version: &#39;fake-version-1&#39;,
              fingerprint: &#39;fake-fingerprint-1&#39;,
              blobstore_id: &#39;fake-pkg-blobstore-id-1&#39;,
              sha1: &#39;fakesha1&#39;
            )
            release_version_model.add_package(package)
            package
          end

          let!(:template) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L870" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L883" class="js-smell-location">1</a>                  <a href="update_release_spec.html#L949" class="js-smell-location">2</a>                  </div>  </li></ol>
            template = Models::Template.make(
              release: release,
              name: &#39;fake-name-2&#39;,
              version: &#39;fake-version-2&#39;,
              fingerprint: &#39;fake-fingerprint-2&#39;,
              blobstore_id: &#39;fake-job-blobstore-id-2&#39;,
              sha1: &#39;fakesha2&#39;,
            )
            release_version_model.add_template(template)
            template
          end

          it &#39;re-uploads all blobs to replace old ones&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(uploading release with --fix)::context(when uploading source release)::context(when release already exists)::it#re-uploads all blobs to replace old ones has a flog score of 62</span>          </div>  </li></ol>
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-pkg-blobstore-id-1&#39;)
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-job-blobstore-id-2&#39;)

            expect(BlobUtil).to receive(:create_blob).with(
              File.join(release_dir, &#39;packages&#39;, &#39;fake-name-1.tgz&#39;)
            ).and_return(&#39;new-blobstore-id-after-fix&#39;)

            expect(BlobUtil).to receive(:create_blob).with(
              File.join(release_dir, &#39;jobs&#39;, &#39;fake-name-2.tgz&#39;)
            ).and_return(&#39;new-job-blobstore-id-after-fix&#39;)

            job.perform

            expect(template.reload.blobstore_id).to eq(&#39;new-job-blobstore-id-after-fix&#39;)
          end
        end

        context &#39;when re-using existing packages&#39; do
          let!(:another_release) { Models::Release.make(name: &#39;foocloud&#39;) }
          let!(:old_release_version_model) do
            Models::ReleaseVersion.make(
              release: another_release,
              version: &#39;41+dev.1&#39;,
              commit_hash: &#39;23456789&#39;,
              uncommitted_changes: true
            )
          end

          let!(:existing_pkg) do
            package = Models::Package.make(
              release: another_release,
              name: &#39;fake-name-1&#39;,
              version: &#39;fake-version-1&#39;,
              fingerprint: &#39;fake-fingerprint-1&#39;,
              blobstore_id: &#39;fake-blobstore-id-1&#39;,
              sha1: &#39;fakesha1&#39;
            ).save

            old_release_version_model.add_package(package)
            package
          end

          it &#39;replaces existing packages and copy blobs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(uploading release with --fix)::context(when uploading source release)::context(when re-using existing packages)::it#replaces existing packages and copy blobs has a flog score of 52</span>          </div>  </li></ol>
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-blobstore-id-1&#39;)
            expect(BlobUtil).to receive(:create_blob).with(File.join(release_dir, &#39;packages&#39;, &#39;fake-name-1.tgz&#39;)).and_return(&#39;new-blobstore-id-after-fix&#39;)
            expect(BlobUtil).to receive(:create_blob).with(File.join(release_dir, &#39;jobs&#39;, &#39;fake-name-2.tgz&#39;)).and_return(&#39;new-job-blobstore-id-after-fix&#39;)
            expect(BlobUtil).to receive(:copy_blob).with(&#39;new-blobstore-id-after-fix&#39;).and_return(&#39;new-blobstore-id&#39;)
            job.perform
          end
        end

        context &#39;eliminates compiled packages&#39; do
          let!(:package) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L870" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L883" class="js-smell-location">1</a>                  <a href="update_release_spec.html#L949" class="js-smell-location">2</a>                  </div>  </li></ol>
            package = Models::Package.make(
              release: release,
              name: &#39;fake-name-1&#39;,
              version: &#39;fake-version-1&#39;,
              fingerprint: &#39;fake-fingerprint-1&#39;,
              blobstore_id: &#39;fake-pkg-blobstore-id-1&#39;,
              sha1: &#39;fakepkgsha1&#39;
            )
            release_version_model.add_package(package)
            package
          end
          let!(:compiled_package) do
            Models::CompiledPackage.make(
              package: package,
              sha1: &#39;fakecompiledsha1&#39;,
              blobstore_id: &#39;fake-compiled-pkg-blobstore-id-1&#39;,
              dependency_key: &#39;fake-dep-key-1&#39;,
              stemcell_os: &#39;windows me&#39;,
              stemcell_version: &#39;4.5&#39;,
            )
          end

          it &#39;eliminates package when broken or missing&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(uploading release with --fix)::context(when uploading source release)::context(eliminates compiled packages)::it#eliminates package when broken or missing has a flog score of 66</span>          </div>  </li></ol>
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-pkg-blobstore-id-1&#39;)
            expect(BlobUtil).to receive(:create_blob).with(
              File.join(release_dir, &#39;packages&#39;, &#39;fake-name-1.tgz&#39;)
            ).and_return(&#39;new-pkg-blobstore-id-1&#39;)
            expect(BlobUtil).to receive(:create_blob).with(
              File.join(release_dir, &#39;jobs&#39;, &#39;fake-name-2.tgz&#39;)
            ).and_return(&#39;new-job-blobstore-id-1&#39;)
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-compiled-pkg-blobstore-id-1&#39;)
            expect {
              job.perform
            }.to change { Models::CompiledPackage.dataset.count }.from(1).to(0)
          end
        end
      end

      context &#39;when uploading compiled release&#39; do
        let(:manifest_jobs) { [] }
        let(:manifest_compiled_packages) do
          [
            {
              &#39;sha1&#39; =&gt; &#39;fakesha1&#39;,
              &#39;fingerprint&#39; =&gt; &#39;fake-fingerprint-1&#39;,
              &#39;name&#39; =&gt; &#39;fake-name-1&#39;,
              &#39;version&#39; =&gt; &#39;fake-version-1&#39;,
              &#39;stemcell&#39; =&gt; &#39;macintosh os/7.1&#39;
            }
          ]
        end
        let(:manifest) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L833" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1001" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &#39;name&#39; =&gt; &#39;appcloud&#39;,
            &#39;version&#39; =&gt; &#39;42+dev.1&#39;,
            &#39;commit_hash&#39; =&gt; &#39;12345678&#39;,
            &#39;uncommitted_changes&#39; =&gt; true,
            &#39;jobs&#39; =&gt; manifest_jobs,
            &#39;compiled_packages&#39; =&gt; manifest_compiled_packages,
          }
        end

        context &#39;when release already exists&#39; do
          let!(:package) do
            package = Models::Package.make(
              release: release,
              name: &#39;fake-name-1&#39;,
              version: &#39;fake-version-1&#39;,
              fingerprint: &#39;fake-fingerprint-1&#39;,
            )
            release_version_model.add_package(package)
            package
          end
          let!(:existing_compiled_package_with_different_dependencies) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1023" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1034" class="js-smell-location">1</a>                  <a href="update_release_spec.html#L1089" class="js-smell-location">2</a>                  </div>  </li></ol>
            compiled_package = Models::CompiledPackage.make(
              blobstore_id: &#39;fake-compiled-blobstore-id-2&#39;,
              dependency_key: &#39;blarg&#39;,
              sha1: &#39;fakecompiledsha1&#39;,
              stemcell_os: &#39;macintosh os&#39;,
              stemcell_version: &#39;7.1&#39;
            )
            package.add_compiled_package compiled_package
            compiled_package
          end
          let!(:compiled_package) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1023" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1034" class="js-smell-location">1</a>                  <a href="update_release_spec.html#L1089" class="js-smell-location">2</a>                  </div>  </li></ol>
            compiled_package = Models::CompiledPackage.make(
              blobstore_id: &#39;fake-compiled-blobstore-id-1&#39;,
              dependency_key: &#39;[]&#39;,
              sha1: &#39;fakecompiledsha1&#39;,
              stemcell_os: &#39;macintosh os&#39;,
              stemcell_version: &#39;7.1&#39;
            )
            package.add_compiled_package compiled_package
            compiled_package
          end

          it &#39;re-uploads all compiled packages to replace old ones&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(uploading release with --fix)::context(when uploading compiled release)::context(when release already exists)::it#re-uploads all compiled packages to replace old ones has a flog score of 46</span>          </div>  </li></ol>
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-compiled-blobstore-id-1&#39;)
            expect(BlobUtil).to receive(:create_blob).with(
              File.join(release_dir, &#39;compiled_packages&#39;, &#39;fake-name-1.tgz&#39;)
            ).and_return(&#39;new-compiled-blobstore-id-after-fix&#39;)
            expect{
              job.perform
            }.to change { compiled_package.reload.blobstore_id }.from(&#39;fake-compiled-blobstore-id-1&#39;).to(&#39;new-compiled-blobstore-id-after-fix&#39;)
          end
        end

        context &#39;when re-using existing compiled packages from other releases&#39; do
          let!(:another_release) { Models::Release.make(name: &#39;foocloud&#39;) }
          let!(:old_release_version_model) do
            Models::ReleaseVersion.make(
              release: another_release,
              version: &#39;41+dev.1&#39;,
              commit_hash: &#39;23456789&#39;,
              uncommitted_changes: true
            )
          end
          let!(:existing_package) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1067" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1078" class="js-smell-location">1</a>                  </div>  </li></ol>
            package = Models::Package.make(
              release: another_release,
              name: &#39;fake-name-1&#39;,
              version: &#39;fake-version-1&#39;,
              fingerprint: &#39;fake-fingerprint-1&#39;
            ).save

            old_release_version_model.add_package(package)
            package
          end
          let!(:existing_package_with_same_fingerprint) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1067" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1078" class="js-smell-location">1</a>                  </div>  </li></ol>
            package = Models::Package.make(
              release: another_release,
              name: &#39;fake-name-2&#39;,
              version: &#39;fake-version-2&#39;,
              fingerprint: &#39;fake-fingerprint-1&#39;
            ).save

            old_release_version_model.add_package(package)
            package
          end
          let!(:existing_compiled_package_with_different_dependencies) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1023" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1034" class="js-smell-location">1</a>                  <a href="update_release_spec.html#L1089" class="js-smell-location">2</a>                  </div>  </li></ol>
            existing_compiled_package = Models::CompiledPackage.make(
                blobstore_id: &#39;fake-existing-compiled-blobstore-id-2&#39;,
                dependency_key: &#39;fake-existing-compiled-dependency-key-1-other&#39;,
                sha1: &#39;fakeexistingcompiledsha1&#39;,
                stemcell_os: &#39;macintosh os&#39;,
                stemcell_version: &#39;7.1&#39;,
            )
            existing_package.add_compiled_package existing_compiled_package
            existing_compiled_package
          end

          let!(:existing_compiled_package) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1101" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1111" class="js-smell-location">1</a>                  </div>  </li></ol>
            Models::CompiledPackage.make(
              blobstore_id: &#39;fake-existing-compiled-blobstore-id-1&#39;,
              dependency_key: &#39;[]&#39;,
              sha1: &#39;fakeexistingcompiledsha1&#39;,
              stemcell_os: &#39;macintosh os&#39;,
              stemcell_version: &#39;7.1&#39;
            ).tap {|c| existing_package.add_compiled_package(c) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'c'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1108" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1118" class="js-smell-location">1</a>                  </div>  </li></ol>
          end

          let!(:matching_existing_compiled_package_from_same_release_version) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1101" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1111" class="js-smell-location">1</a>                  </div>  </li></ol>
            Models::CompiledPackage.make(
                blobstore_id: &#39;fake-existing-compiled-blobstore-id-A&#39;,
                dependency_key: &#39;[]&#39;,
                sha1: &#39;fakeexistingcompiledsha1&#39;,
                stemcell_os: &#39;macintosh os&#39;,
                stemcell_version: &#39;7.1&#39;
            ).tap {|c| existing_package_with_same_fingerprint.add_compiled_package(c) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'c'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1108" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1118" class="js-smell-location">1</a>                  </div>  </li></ol>
          end
          it &#39;replaces existing compiled packages and copy blobs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(uploading release with --fix)::context(when uploading compiled release)::context(when re-using existing compiled packages from other releases)::it#replaces existing compiled packages and copy blobs has a flog score of 95</span>          </div>  </li></ol>
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-existing-compiled-blobstore-id-1&#39;)
            expect(BlobUtil).to receive(:delete_blob).with(&#39;fake-existing-compiled-blobstore-id-A&#39;)
            expect(BlobUtil).to receive(:create_blob).with(
              File.join(release_dir, &#39;compiled_packages&#39;, &#39;fake-name-1.tgz&#39;)
            ).and_return(&#39;new-existing-compiled-blobstore-id-after-fix&#39;, &#39;new-existing-compiled-blobstore-id-A-after-fix&#39;)
            expect(BlobUtil).to receive(:copy_blob).with(
               &#39;new-existing-compiled-blobstore-id-after-fix&#39;).and_return(&#39;new-compiled-blobstore-id&#39;)
            expect(existing_compiled_package.reload.blobstore_id).to eq(&#39;fake-existing-compiled-blobstore-id-1&#39;)
            expect(matching_existing_compiled_package_from_same_release_version.reload.blobstore_id).to eq(&#39;fake-existing-compiled-blobstore-id-A&#39;)
            job.perform
            expect(existing_compiled_package.reload.blobstore_id).to eq(&#39;new-existing-compiled-blobstore-id-after-fix&#39;)
            expect(matching_existing_compiled_package_from_same_release_version.reload.blobstore_id).to eq(&#39;new-existing-compiled-blobstore-id-A-after-fix&#39;)
          end
        end
      end
    end

    describe &#39;create_package_for_compiled_release&#39; do
      let(:release_dir) { Dir.mktmpdir }
      after { FileUtils.rm_rf(release_dir) }

      before do
        @release = Models::Release.make
        @job = Jobs::UpdateRelease.new(release_dir)
        @job.release_model = @release
        @job.instance_variable_set(:@compiled_release, true)
      end

      it &#39;should create simple packages without blobstore_id or sha1&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(create_package_for_compiled_release)::it#should create simple packages without blobstore_id or sha1 has a flog score of 45</span>          </div>  </li></ol>
        @job.create_package({
                                &#39;name&#39; =&gt; &#39;test_package&#39;,
                                &#39;version&#39; =&gt; &#39;1.0&#39;,
                                &#39;sha1&#39; =&gt; nil,
                                &#39;dependencies&#39; =&gt; %w(foo_package bar_package)
                            }, release_dir)

        package = Models::Package[name: &#39;test_package&#39;, version: &#39;1.0&#39;]
        expect(package).not_to be_nil
        expect(package.name).to eq(&#39;test_package&#39;)
        expect(package.version).to eq(&#39;1.0&#39;)
        expect(package.release).to eq(@release)
        expect(package.sha1).to be_nil
        expect(package.blobstore_id).to be_nil
      end
    end

    describe &#39;create_package&#39; do
      let(:release_dir) { Dir.mktmpdir }
      after { FileUtils.rm_rf(release_dir) }

      before do
        @release = Models::Release.make
        @job = Jobs::UpdateRelease.new(release_dir)
        @job.release_model = @release
      end

      it &#39;should create simple packages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(create_package)::it#should create simple packages has a flog score of 76</span>          </div>  </li></ol>
        FileUtils.mkdir_p(File.join(release_dir, &#39;packages&#39;))
        package_path = File.join(release_dir, &#39;packages&#39;, &#39;test_package.tgz&#39;)

        File.open(package_path, &#39;w&#39;) do |f|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'f'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1181" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1209" class="js-smell-location">1</a>                  </div>  </li></ol>
          f.write(create_package(&#39;test&#39; =&gt; &#39;test contents&#39;))
        end

        expect(blobstore).to receive(:create).
          with(satisfy { |obj| obj.path == package_path }).
          and_return(&#39;blob_id&#39;)

        @job.create_package({
          &#39;name&#39; =&gt; &#39;test_package&#39;,
          &#39;version&#39; =&gt; &#39;1.0&#39;,
          &#39;sha1&#39; =&gt; &#39;some-sha&#39;,
          &#39;dependencies&#39; =&gt; %w(foo_package bar_package)
        }, release_dir)

        package = Models::Package[name: &#39;test_package&#39;, version: &#39;1.0&#39;]
        expect(package).not_to be_nil
        expect(package.name).to eq(&#39;test_package&#39;)
        expect(package.version).to eq(&#39;1.0&#39;)
        expect(package.release).to eq(@release)
        expect(package.sha1).to eq(&#39;some-sha&#39;)
        expect(package.blobstore_id).to eq(&#39;blob_id&#39;)
      end

      it &#39;should copy package blob&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(create_package)::it#should copy package blob has a flog score of 65</span>          </div>  </li></ol>
        expect(BlobUtil).to receive(:copy_blob).and_return(&#39;blob_id&#39;)
        FileUtils.mkdir_p(File.join(release_dir, &#39;packages&#39;))
        package_path = File.join(release_dir, &#39;packages&#39;, &#39;test_package.tgz&#39;)
        File.open(package_path, &#39;w&#39;) do |f|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'f'</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1181" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1209" class="js-smell-location">1</a>                  </div>  </li></ol>
          f.write(create_package(&#39;test&#39; =&gt; &#39;test contents&#39;))
        end

        @job.create_package({
          &#39;name&#39; =&gt; &#39;test_package&#39;,
          &#39;version&#39; =&gt; &#39;1.0&#39;, &#39;sha1&#39; =&gt; &#39;some-sha&#39;,
          &#39;dependencies&#39; =&gt; [&#39;foo_package&#39;, &#39;bar_package&#39;],
          &#39;blobstore_id&#39; =&gt; &#39;blah&#39;,
        }, release_dir)

        package = Models::Package[name: &#39;test_package&#39;, version: &#39;1.0&#39;]
        expect(package).not_to be_nil
        expect(package.name).to eq(&#39;test_package&#39;)
        expect(package.version).to eq(&#39;1.0&#39;)
        expect(package.release).to eq(@release)
        expect(package.sha1).to eq(&#39;some-sha&#39;)
        expect(package.blobstore_id).to eq(&#39;blob_id&#39;)
      end

      it &#39;should fail if cannot extract package archive&#39; do
        result = Bosh::Exec::Result.new(&#39;cmd&#39;, &#39;output&#39;, 1)
        expect(Bosh::Exec).to receive(:sh).and_return(result)

        expect {
          @job.create_package({
            &#39;name&#39; =&gt; &#39;test_package&#39;,
            &#39;version&#39; =&gt; &#39;1.0&#39;,
            &#39;sha1&#39; =&gt; &#39;some-sha&#39;,
            &#39;dependencies&#39; =&gt; %w(foo_package bar_package),
          }, release_dir)
        }.to raise_exception(Bosh::Director::PackageInvalidArchive)
      end

      def create_package(files)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe#create_package has a flog score of 26</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director#create_package has approx 7 statements</span>          </div>  </li></ol>
        io = StringIO.new

        Archive::Tar::Minitar::Writer.open(io) do |tar|
          files.each do |key, value|
            tar.add_file(key, {:mode =&gt; &quot;0644&quot;, :mtime =&gt; 0}) { |os, _| os.write(value) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director#create_package contains iterators nested 3 deep</span>          </div>  </li></ol>
          end
        end

        io.close<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#create_package refers to 'io' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1252" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1253" class="js-smell-location">1</a>                  </div>  </li></ol>
        gzip(io.string)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#create_package refers to 'io' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release_spec.html#L1252" class="js-smell-location">0</a>                  <a href="update_release_spec.html#L1253" class="js-smell-location">1</a>                  </div>  </li></ol>
      end
    end

    describe &#39;resolve_package_dependencies&#39; do
      before do
        @job = Jobs::UpdateRelease.new(&#39;fake-release-path&#39;)
      end

      it &#39;should normalize nil dependencies&#39; do
        packages = [
          {&#39;name&#39; =&gt; &#39;A&#39;},
          {&#39;name&#39; =&gt; &#39;B&#39;, &#39;dependencies&#39; =&gt; [&#39;A&#39;]}
        ]
        @job.resolve_package_dependencies(packages)
        expect(packages).to eql([
          {&#39;name&#39; =&gt; &#39;A&#39;, &#39;dependencies&#39; =&gt; []},
          {&#39;name&#39; =&gt; &#39;B&#39;, &#39;dependencies&#39; =&gt; [&#39;A&#39;]}
        ])
      end

      it &#39;should not allow cycles&#39; do
        packages = [
          {&#39;name&#39; =&gt; &#39;A&#39;, &#39;dependencies&#39; =&gt; [&#39;B&#39;]},
          {&#39;name&#39; =&gt; &#39;B&#39;, &#39;dependencies&#39; =&gt; [&#39;A&#39;]}
        ]
        expect { @job.resolve_package_dependencies(packages) }.to raise_exception
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
