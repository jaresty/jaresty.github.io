<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-21 16:21:12 -0400'>2018-06-21 16:21:12 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/links /</small> links_manager_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">3168</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">42</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">5524.15</span><small> complexity</small></div>
              <div><span class="metric">3641</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                118
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

describe Bosh::Director::Links::LinksManager do
  subject { Bosh::Director::Links::LinksManager.new(serial_id, logger, event_logger) }

  let(:logger) { Logging::Logger.new(&#39;TestLogger&#39;) }
  let(:event_logger) { Bosh::Director::EventLog::Log.new }

  let(:serial_id) { 42 }
  let(:event_manager) { Bosh::Director::Api::EventManager.new(true) }
  let(:task) { Bosh::Director::Models::Task.make(username: &#39;user&#39;) }
  let(:update_job) { instance_double(Bosh::Director::Jobs::UpdateDeployment, username: &#39;user&#39;, task_id: task.id, event_manager: event_manager) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="../deployment_plan/stages/package_compile_stage_spec.html#L67" class="js-smell-location">0</a>                  <a href="../jobs/cleanup_artifacts_spec.html#L8" class="js-smell-location">1</a>                  <a href="../jobs/delete_orphan_disks_spec.html#L7" class="js-smell-location">2</a>                  <a href="../jobs/delete_vm_spec.html#L21" class="js-smell-location">3</a>                  <a href="../jobs/orphan_disk_spec.html#L18" class="js-smell-location">4</a>                  <a href="../jobs/scheduled_orphaned_disk_cleanup_spec.html#L26" class="js-smell-location">5</a>                  <a href="links_manager_spec.html#L12" class="js-smell-location">6</a>                  <a href="../orphan_disk_manager_spec.html#L30" class="js-smell-location">7</a>                  <a href="../problem_resolver_spec.html#L6" class="js-smell-location">8</a>                  </div>  </li></ol>
  let(:use_dns_addresses) { true }

  let(:deployment_model) do
    Bosh::Director::Models::Deployment.create(
      name: &#39;test_deployment&#39;,
      links_serial_id: serial_id,
    )
  end

  before do
    allow(Bosh::Director::Config).to receive(:current_job).and_return(update_job)
  end

  describe &#39;#find_or_create_provider&#39; do
    it &#39;returns the existing provider&#39; do
      expected_provider = Bosh::Director::Models::Links::LinkProvider.create(
        deployment: deployment_model,
        instance_group: &#39;control_instance_group&#39;,
        name: &#39;control_owner_object_name&#39;,
        type: &#39;control_owner_object_type&#39;,
        serial_id: serial_id,
      )

      actual_provider = subject.find_or_create_provider(
        deployment_model: deployment_model,
        instance_group_name: &#39;control_instance_group&#39;,
        name: &#39;control_owner_object_name&#39;,
        type: &#39;control_owner_object_type&#39;,
      )

      expect(actual_provider).to eq(expected_provider)
    end

    context &#39;link provider does not exist&#39; do
      it &#39;creates a new provider&#39; do
        expected_provider = subject.find_or_create_provider(
          deployment_model: deployment_model,
          instance_group_name: &#39;new_instance_group&#39;,
          name: &#39;new_owner_object_name&#39;,
          type: &#39;new_owner_object_type&#39;,
        )

        actual_provider = Bosh::Director::Models::Links::LinkProvider.find(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="../api/controllers/links_controller_spec.html#L217" class="js-smell-location">0</a>                  <a href="../api/link_manager_spec.html#L61" class="js-smell-location">1</a>                  <a href="../api/link_manager_spec.html#L341" class="js-smell-location">2</a>                  <a href="links_error_builder_spec.html#L9" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L55" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L243" class="js-smell-location">5</a>                  <a href="links_manager_spec.html#L3039" class="js-smell-location">6</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;new_instance_group&#39;,
          name: &#39;new_owner_object_name&#39;,
          type: &#39;new_owner_object_type&#39;,
        )

        expect(actual_provider).to eq(expected_provider)
        expect(actual_provider.serial_id).to_not be_nil
      end
    end
  end

  describe &#39;#find_provider&#39; do
    context &#39;link provider exists&#39; do
      let(:serial_id) { 55 }

      it &#39;returns the existing provider&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L72" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L337" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_provider)::context(link provider exists)::it#returns the existing provider has a flog score of 26</span>          </div>  </li></ol>
        expected_provider = Bosh::Director::Models::Links::LinkProvider.create(
          deployment: deployment_model,
          instance_group: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
          serial_id: serial_id,
        )

        actual_provider = subject.find_provider(
          deployment_model: deployment_model,
          instance_group_name: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
        )

        expect(actual_provider).to eq(expected_provider)
        expect(actual_provider.serial_id).to eq(serial_id)
      end
    end

    context &#39;link provider does not exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L93" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L357" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &#39;does not return a provider&#39; do
        actual_provider = subject.find_provider(
          deployment_model: deployment_model,
          instance_group_name: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
        )
        expect(actual_provider).to be_nil
      end
    end

    context &#39;when link provider with wrong serial_id exist&#39; do
      let(:serial_id) { 55 }

      it &#39;returns nothing&#39; do
        Bosh::Director::Models::Links::LinkProvider.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L109" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L372" class="js-smell-location">1</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
          serial_id: 42,
        )

        actual_provider = subject.find_provider(
          deployment_model: deployment_model,
          instance_group_name: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
        )

        expect(actual_provider).to be_nil
      end
    end
  end

  describe &#39;#find_or_create_provider_intent&#39; do
    let(:link_provider) do
      Bosh::Director::Models::Links::LinkProvider.create(
        deployment: deployment_model,
        name: &#39;test_deployment&#39;,
        type: &#39;test_deployment_type&#39;,
        instance_group: &#39;test_instance_group&#39;,
        serial_id: serial_id,
      )
    end

    context &#39;intent already exists&#39; do
      it &#39;returns the existing link_provider_intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_provider_intent)::context(intent already exists)::it#returns the existing link_provider_intent has a flog score of 26</span>          </div>  </li></ol>
        expected_intent = Bosh::Director::Models::Links::LinkProviderIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L142" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L164" class="js-smell-location">1</a>                  </div>  </li></ol>
          link_provider: link_provider,
          original_name: &#39;test_original_link_name&#39;,
          type: &#39;test_link_type&#39;,
          name: &#39;test_link_alias&#39;,
          content: &#39;test_link_content&#39;,
          shared: false,
          consumable: true,
          serial_id: serial_id,
        )

        actual_intent = subject.find_or_create_provider_intent(
          link_provider: link_provider,
          link_original_name: &#39;test_original_link_name&#39;,
          link_type: &#39;test_link_type&#39;,
        )

        expect(actual_intent).to eq(expected_intent)
        expect(actual_intent.serial_id).to eq(serial_id)
      end

      it &#39;updates the link type of the intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_provider_intent)::context(intent already exists)::it#updates the link type of the intent has a flog score of 28</span>          </div>  </li></ol>
        expected_intent = Bosh::Director::Models::Links::LinkProviderIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L142" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L164" class="js-smell-location">1</a>                  </div>  </li></ol>
          link_provider: link_provider,
          original_name: &#39;test_original_link_name&#39;,
          type: &#39;test_link_type&#39;,
          name: &#39;test_link_alias&#39;,
          content: &#39;test_link_content&#39;,
          shared: false,
          consumable: true,
          serial_id: serial_id,
        )

        actual_intent = subject.find_or_create_provider_intent(
          link_provider: link_provider,
          link_original_name: &#39;test_original_link_name&#39;,
          link_type: &#39;my_new_link_type&#39;,
        )

        expect(actual_intent.id).to eq(expected_intent.id)
        expect(actual_intent.type).to eq(&#39;my_new_link_type&#39;)
      end
    end

    context &#39;intent is missing&#39; do
      it &#39;creates a new link_provider_intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_provider_intent)::context(intent is missing)::it#creates a new link_provider_intent has a flog score of 37</span>          </div>  </li></ol>
        expect(Bosh::Director::Models::Links::LinkProviderIntent.count).to eq(0)

        actual_intent = subject.find_or_create_provider_intent(
          link_provider: link_provider,
          link_original_name: &#39;test_original_link_name&#39;,
          link_type: &#39;test_link_type&#39;,
        )

        expected_intent = Bosh::Director::Models::Links::LinkProviderIntent.find(
          link_provider: link_provider,
          original_name: &#39;test_original_link_name&#39;,
          type: &#39;test_link_type&#39;,
          shared: false,
          consumable: true,
        )

        expect(Bosh::Director::Models::Links::LinkProviderIntent.count).to eq(1)
        expect(actual_intent).to eq(expected_intent)
        expect(actual_intent.serial_id).to eq(serial_id)
      end
    end
  end

  describe &#39;#find_or_create_consumer&#39; do
    let!(:control_consumer) do
      Bosh::Director::Models::Links::LinkConsumer.create(
        deployment: deployment_model,
        instance_group: &#39;control_instance_group&#39;,
        name: &#39;control_owner_object_name&#39;,
        type: &#39;control_owner_object_type&#39;,
        serial_id: serial_id,
      )
    end

    it &#39;finds the consumer&#39; do
      actual_consumer = subject.find_or_create_consumer(
        deployment_model: deployment_model,
        instance_group_name: &#39;control_instance_group&#39;,
        name: &#39;control_owner_object_name&#39;,
        type: &#39;control_owner_object_type&#39;,
      )

      expect(actual_consumer).to eq(control_consumer)
      expect(actual_consumer.serial_id).to eq(serial_id)
    end

    context &#39;consumer does not exist&#39; do
      it &#39;creates a new consumer&#39; do
        expected_consumer = subject.find_or_create_consumer(
          deployment_model: deployment_model,
          instance_group_name: &#39;my_instance_group&#39;,
          name: &#39;my_owner_object_name&#39;,
          type: &#39;my_owner_object_type&#39;,
        )

        actual_consumer = Bosh::Director::Models::Links::LinkConsumer.find(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="../api/controllers/links_controller_spec.html#L217" class="js-smell-location">0</a>                  <a href="../api/link_manager_spec.html#L61" class="js-smell-location">1</a>                  <a href="../api/link_manager_spec.html#L341" class="js-smell-location">2</a>                  <a href="links_error_builder_spec.html#L9" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L55" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L243" class="js-smell-location">5</a>                  <a href="links_manager_spec.html#L3039" class="js-smell-location">6</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;my_instance_group&#39;,
          name: &#39;my_owner_object_name&#39;,
          type: &#39;my_owner_object_type&#39;,
        )

        expect(actual_consumer).to eq(expected_consumer)
        expect(actual_consumer.serial_id).to eq(serial_id)
      end
    end
  end

  describe &#39;#find_or_create_consumer_intent&#39; do
    let(:link_consumer) do
      Bosh::Director::Models::Links::LinkConsumer.create(
        deployment: deployment_model,
        name: &#39;test_deployment&#39;,
        type: &#39;test_deployment_type&#39;,
        instance_group: &#39;test_instance_group&#39;,
        serial_id: serial_id,
      )
    end

    context &#39;intent already exist&#39; do
      it &#39;returns the existing link_consumer_intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_consumer_intent)::context(intent already exist)::it#returns the existing link_consumer_intent has a flog score of 26</span>          </div>  </li></ol>
        expected_link_consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L269" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L290" class="js-smell-location">1</a>                  </div>  </li></ol>
          link_consumer: link_consumer,
          original_name: &#39;test_original_link_name&#39;,
          type: &#39;test_link_type&#39;,
          optional: false,
          blocked: false,
          serial_id: serial_id,
        )

        actual_link_consumer_intent = subject.find_or_create_consumer_intent(
          link_consumer: link_consumer,
          link_original_name: &#39;test_original_link_name&#39;,
          link_type: &#39;test_link_type&#39;,
          new_intent_metadata: nil,
        )

        expect(actual_link_consumer_intent).to eq(expected_link_consumer_intent)
        expect(actual_link_consumer_intent.serial_id).to eq(serial_id)
      end

      it &#39;updates the link type of the intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_consumer_intent)::context(intent already exist)::it#updates the link type of the intent has a flog score of 28</span>          </div>  </li></ol>
        expected_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L269" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L290" class="js-smell-location">1</a>                  </div>  </li></ol>
          link_consumer: link_consumer,
          original_name: &#39;test_original_link_name&#39;,
          type: &#39;test_link_type&#39;,
          optional: false,
          blocked: false,
          serial_id: serial_id,
        )

        actual_intent = subject.find_or_create_consumer_intent(
          link_consumer: link_consumer,
          link_original_name: &#39;test_original_link_name&#39;,
          link_type: &#39;my_new_link_type&#39;,
          new_intent_metadata: nil,
        )

        expect(actual_intent.id).to eq(expected_intent.id)
        expect(actual_intent.type).to eq(&#39;my_new_link_type&#39;)
      end
    end

    context &#39;intent is missing&#39; do
      it &#39;creates a new link_consumer_intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_consumer_intent)::context(intent is missing)::it#creates a new link_consumer_intent has a flog score of 32</span>          </div>  </li></ol>
        expected_intent = subject.find_or_create_consumer_intent(
          link_consumer: link_consumer,
          link_original_name: &#39;test_original_link_name&#39;,
          link_type: &#39;test_link_type&#39;,
          new_intent_metadata: { &#39;abc&#39;: &#39;def&#39; },
        )

        actual_intent = Bosh::Director::Models::Links::LinkConsumerIntent.find(
          link_consumer: link_consumer,
          original_name: &#39;test_original_link_name&#39;,
          type: &#39;test_link_type&#39;,
          optional: false,
          blocked: false,
        )

        expect(actual_intent).to eq(expected_intent)
        expect(actual_intent.serial_id).to eq(serial_id)
        expect(actual_intent.metadata).to eq({ &#39;abc&#39; =&gt; &#39;def&#39; }.to_json)
      end
    end
  end

  describe &#39;#find_consumer&#39; do
    context &#39;link consumer exists&#39; do
      it &#39;returns the existing consumer&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L72" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L337" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_consumer)::context(link consumer exists)::it#returns the existing consumer has a flog score of 25</span>          </div>  </li></ol>
        expected_consumer = Bosh::Director::Models::Links::LinkConsumer.create(
          deployment: deployment_model,
          instance_group: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
          serial_id: serial_id,
        )

        actual_consumer = subject.find_consumer(
          deployment_model: deployment_model,
          instance_group_name: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
        )
        expect(actual_consumer).to eq(expected_consumer)
        expect(actual_consumer.serial_id).to eq(serial_id)
      end
    end

    context &#39;link consumer does not exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L93" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L357" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &#39;does not return a consumer&#39; do
        actual_consumer = subject.find_consumer(
          deployment_model: deployment_model,
          instance_group_name: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;job&#39;,
        )
        expect(actual_consumer).to be_nil
      end
    end

    context &#39;when link consumer with wrong serial_id exists&#39; do
      let(:serial_id) { 55 }
      it &#39;fails returns the existing consumer&#39; do
        expected_consumer = Bosh::Director::Models::Links::LinkConsumer.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L109" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L372" class="js-smell-location">1</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
          serial_id: 42,
        )

        actual_consumer = subject.find_consumer(
          deployment_model: deployment_model,
          instance_group_name: &#39;control_instance_group&#39;,
          name: &#39;control_owner_object_name&#39;,
          type: &#39;control_owner_object_type&#39;,
        )
        expect(actual_consumer).to be_nil
      end
    end
  end

  describe &#39;#find_or_create_link&#39; do
    let(:link_provider) do
      Bosh::Director::Models::Links::LinkProvider.create(
        deployment: deployment_model,
        name: &#39;test_deployment&#39;,
        type: &#39;test_deployment_type&#39;,
        instance_group: &#39;test_instance_group&#39;,
        serial_id: serial_id,
      )
    end
    let(:link_consumer) do
      Bosh::Director::Models::Links::LinkConsumer.create(
        deployment: deployment_model,
        name: &#39;test_deployment&#39;,
        type: &#39;test_deployment_type&#39;,
        instance_group: &#39;test_instance_group&#39;,
        serial_id: serial_id,
      )
    end
    let(:provider_intent) do
      Bosh::Director::Models::Links::LinkProviderIntent.create(
        link_provider: link_provider,
        original_name: &#39;test_original_link_name&#39;,
        type: &#39;test_link_type&#39;,
        name: &#39;test_link_alias&#39;,
        content: &#39;test_link_content&#39;,
        shared: false,
        consumable: true,
        serial_id: serial_id,
      )
    end
    let(:consumer_intent) do
      Bosh::Director::Models::Links::LinkConsumerIntent.create(
        link_consumer: link_consumer,
        original_name: &#39;test_original_link_name&#39;,
        type: &#39;test_link_type&#39;,
        optional: false,
        blocked: false,
        serial_id: serial_id,
      )
    end

    context &#39;when link do not exist&#39; do
      it &#39;creates a new link&#39; do
        expected_link = subject.find_or_create_link(
          name: &#39;test_link_name&#39;,
          provider_intent: provider_intent,
          consumer_intent: consumer_intent,
          link_content: &#39;{}&#39;,
        )

        actual_link = Bosh::Director::Models::Links::Link.find(
          name: &#39;test_link_name&#39;,
        )

        expect(actual_link).to eq(expected_link)
      end
    end

    context &#39;when link already exists&#39; do
      let(:link_content_1) do
        {
          &#39;deployment_name&#39; =&gt; &#39;simple&#39;,
          &#39;domain&#39; =&gt; &#39;bosh&#39;,
          &#39;default_network&#39; =&gt; &#39;a&#39;,
          &#39;networks&#39; =&gt; %w[b a],
          &#39;instance_group&#39; =&gt; &#39;foobar&#39;,
          &#39;properties&#39; =&gt; {
            &#39;a&#39; =&gt; &#39;default_a&#39;,
            &#39;b&#39; =&gt; nil,
            &#39;c&#39; =&gt; &#39;default_c&#39;,
            &#39;nested&#39; =&gt; {
              &#39;one&#39; =&gt; &#39;default_nested.one&#39;,
              &#39;two&#39; =&gt; &#39;default_nested.two&#39;,
              &#39;three&#39; =&gt; nil,
            },
          },
          &#39;instances&#39; =&gt; [
            {
              &#39;name&#39; =&gt; &#39;foobar&#39;,
              &#39;id&#39; =&gt; &#39;e836f635-cece-4531-a519-0bc857b190e8&#39;,
              &#39;index&#39; =&gt; 0,
              &#39;bootstrap&#39; =&gt; true,
              &#39;az&#39; =&gt; nil,
              &#39;address&#39; =&gt; &#39;192.168.1.2&#39;,
            },
          ],
        }
      end

      before do
        @expected_link_1 = subject.find_or_create_link(
          name: &#39;test_link_name&#39;,
          provider_intent: provider_intent,
          consumer_intent: consumer_intent,
          link_content: link_content_1.to_json,
        )

        actual_link = Bosh::Director::Models::Links::Link.find(
          name: &#39;test_link_name&#39;,
        )
        expect(actual_link).to_not be_nil
      end

      context &#39;when content matches&#39; do
        context &#39;when single link for provider anc consumer exists&#39; do
          it &#39;should return existing link&#39; do
            expected_link_2 = subject.find_or_create_link(
              name: &#39;test_link_name&#39;,
              provider_intent: provider_intent,
              consumer_intent: consumer_intent,
              link_content: link_content_1.to_json,
            )

            expect(expected_link_2).to eq(@expected_link_1)
          end
        end

        context &#39;when multiple links for provider and consumer exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_link)::context(when link already exists)::context(when content matches)::context#when multiple links for provider and consumer exist has a flog score of 40</span>          </div>  </li></ol>
          before do
            @expected_link_with_different_content = Bosh::Director::Models::Links::Link.create(
              name: &#39;test_link_name_1&#39;,
              link_provider_intent_id: provider_intent[:id],
              link_consumer_intent_id: consumer_intent[:id],
              link_content: &#39;{&quot;d&quot;:&quot;e&quot;, &quot;f&quot;:&quot;g&quot;}&#39;,
            )

            actual_links = Bosh::Director::Models::Links::Link.where(
              link_provider_intent_id: provider_intent[:id],
              link_consumer_intent_id: consumer_intent[:id],
            )
            expect(actual_links).to_not be_nil
            expect(actual_links.count).to eq(2)
          end

          it &#39;should return correct link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_link)::context(when link already exists)::context(when content matches)::context(when multiple links for provider and consumer exist)::it#should return correct link has a flog score of 36</span>          </div>  </li></ol>
            expected_link_2 = subject.find_or_create_link(
              name: &#39;test_link_name_1&#39;,
              provider_intent: provider_intent,
              consumer_intent: consumer_intent,
              link_content: &#39;{&quot;d&quot;:&quot;e&quot;, &quot;f&quot;:&quot;g&quot;}&#39;,
            )

            expect(expected_link_2).to eq(@expected_link_with_different_content)
            expect(expected_link_2[:link_content]).to eq(@expected_link_with_different_content[:link_content])
            expect(Bosh::Director::Models::Links::Link.all.count).to eq(2)
          end
        end
      end

      context &#39;when content hash elements are in different order&#39; do
        context &#39;when properties are in different order&#39; do
          before do
            link_content_1[&#39;properties&#39;][&#39;nested&#39;] = {
              &#39;two&#39; =&gt; &#39;default_nested.two&#39;,
              &#39;one&#39; =&gt; &#39;default_nested.one&#39;,
              &#39;three&#39; =&gt; nil,
            }
          end

          it &#39;should return existing link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L551" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L569" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_link)::context(when link already exists)::context(when content hash elements are in different order)::context(when properties are in different order)::it#should return existing link has a flog score of 44</span>          </div>  </li></ol>
            expected_link_2 = subject.find_or_create_link(
              name: &#39;test_link_name&#39;,
              provider_intent: provider_intent,
              consumer_intent: consumer_intent,
              link_content: link_content_1.to_json,
            )

            expect(expected_link_2[:id]).to eq(@expected_link_1[:id])
            expect(JSON.parse(expected_link_2[:link_content]).sort).to eq(JSON.parse(@expected_link_1[:link_content]).sort)
          end
        end

        context &#39;when networks are in different order&#39; do
          before do
            link_content_1[&#39;networks&#39;] = %w[a b]
          end

          it &#39;should return existing link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L551" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L569" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_link)::context(when link already exists)::context(when content hash elements are in different order)::context(when networks are in different order)::it#should return existing link has a flog score of 44</span>          </div>  </li></ol>
            expected_link_2 = subject.find_or_create_link(
              name: &#39;test_link_name&#39;,
              provider_intent: provider_intent,
              consumer_intent: consumer_intent,
              link_content: link_content_1.to_json,
            )

            expect(expected_link_2[:id]).to eq(@expected_link_1[:id])
            expect(JSON.parse(expected_link_2[:link_content]).sort).to eq(JSON.parse(@expected_link_1[:link_content]).sort)
          end
        end
      end

      context &#39;when content does not match&#39; do
        context &#39;when new network is added&#39; do
          before do
            link_content_1[&#39;networks&#39;] = %w[a b c]
          end

          it &#39;should return new link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L589" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L607" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L629" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_link)::context(when link already exists)::context(when content does not match)::context(when new network is added)::it#should return new link has a flog score of 42</span>          </div>  </li></ol>
            expected_link_2 = subject.find_or_create_link(
              name: &#39;test_link_name&#39;,
              provider_intent: provider_intent,
              consumer_intent: consumer_intent,
              link_content: link_content_1.to_json,
            )

            expect(expected_link_2[:id]).to_not eq(@expected_link_1[:id])
            expect(JSON.parse(expected_link_2[:link_content]).sort).to eq(link_content_1.sort)
          end
        end

        context &#39;when there is new default network&#39; do
          before do
            link_content_1[&#39;default_network&#39;] = &#39;b&#39;
          end

          it &#39;should return new link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L589" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L607" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L629" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_link)::context(when link already exists)::context(when content does not match)::context(when there is new default network)::it#should return new link has a flog score of 42</span>          </div>  </li></ol>
            expected_link_2 = subject.find_or_create_link(
              name: &#39;test_link_name&#39;,
              provider_intent: provider_intent,
              consumer_intent: consumer_intent,
              link_content: link_content_1.to_json,
            )

            expect(expected_link_2[:id]).to_not eq(@expected_link_1[:id])
            expect(JSON.parse(expected_link_2[:link_content]).sort).to eq(link_content_1.sort)
          end
        end

        context &#39;when properties change&#39; do
          before do
            link_content_1[&#39;properties&#39;][&#39;nested&#39;] = {
              &#39;two&#39; =&gt; &#39;default_nested.two.changed&#39;,
              &#39;one&#39; =&gt; &#39;default_nested.one.changed&#39;,
              &#39;three&#39; =&gt; &#39;new.default_nested.three&#39;,
            }
          end

          it &#39;should return new link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L589" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L607" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L629" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#find_or_create_link)::context(when link already exists)::context(when content does not match)::context(when properties change)::it#should return new link has a flog score of 42</span>          </div>  </li></ol>
            expected_link_2 = subject.find_or_create_link(
              name: &#39;test_link_name&#39;,
              provider_intent: provider_intent,
              consumer_intent: consumer_intent,
              link_content: link_content_1.to_json,
            )

            expect(expected_link_2[:id]).to_not eq(@expected_link_1[:id])
            expect(JSON.parse(expected_link_2[:link_content]).sort).to eq(link_content_1.sort)
          end
        end
      end
    end
  end

  describe &#39;#resolve_deployment_links&#39; do
    let(:global_use_dns_entry) { true }

    let(:options) do
      {
        global_use_dns_entry: global_use_dns_entry,
        dry_run: dry_run,
      }
    end

    context &#39;when dry_run flag is true&#39; do
      let(:dry_run) { true }

      context &#39;when it is an explicit consumer&#39; do
        let(:consumer) do
          Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            serial_id: serial_id,
          )
        end

        let(:metadata) do
          { &#39;explicit_link&#39; =&gt; true }
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L673" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L908" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1126" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L1747" class="js-smell-location">3</a>                  </div>  </li></ol>
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;ci1&#39;,
            name: &#39;provider_alias&#39;,
            type: &#39;foo&#39;,
            metadata: metadata.to_json,
            serial_id: serial_id,
          )
        end

        context &#39;and the provider exists&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L684" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L919" class="js-smell-location">1</a>                  </div>  </li></ol>
          before do
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              instance_group: &#39;ig1&#39;,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
            )
          end

          it &#39;does not create a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context(and the provider exists)::it#does not create a link has a flog score of 33</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0
            subject.resolve_deployment_links(deployment_model, options)
            expect(Bosh::Director::Models::Links::Link.count).to eq(0)
          end
        end

        context &#39;and the provider does NOT exist&#39; do
          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context(and the provider does NOT exist)::it#raises an error has a flog score of 54</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expect {
              subject.resolve_deployment_links(deployment_model, options)
            }.to raise_error do |e|
              expect(e.message).to include(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:&quot;)
              expect(e.message).to include(&#39;No link providers found&#39;)
            end
          end

          context &#39;when link consumer intent is optional&#39; do
            before do
              link_consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.find(
                link_consumer: consumer,
                original_name: &#39;ci1&#39;,
                type: &#39;foo&#39;,
              )

              link_consumer_intent.optional = true
              link_consumer_intent.save
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context(and the provider does NOT exist)::context(when link consumer intent is optional)::it#should raise an error has a flog score of 74</span>          </div>  </li></ol>
              expect(consumer.find_intent_by_name(&#39;ci1&#39;).optional).to eq(true)

              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error do |error|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L739" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1971" class="js-smell-location">1</a>                  </div>  </li></ol>
                expect(error.message).to include(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:&quot;)
                expect(error.message).to include(&quot;- Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:&quot;)
                expect(error.message).to include(&#39;- No link providers found&#39;)
              end

              expect(Bosh::Director::Models::Links::Link.count).to eq(0)
            end
          end
        end

        context &#39;when provider serial_id do not match deployment links_serial_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context#when provider serial_id do not match deployment links_serial_id has a flog score of 26</span>          </div>  </li></ol>
          before do
            provider = Bosh::Director::Models::Links::LinkProvider.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L752" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2363" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2923" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L3011" class="js-smell-location">3</a>                  </div>  </li></ol>
              deployment: deployment_model,
              instance_group: &#39;ig1&#39;,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              serial_id: serial_id - 1 # different serial id than deployment
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id - 1 # different serial id than deployment
            )
            link_consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.find(
              link_consumer: consumer,
              original_name: &#39;ci1&#39;,
              type: &#39;foo&#39;,
            )

            link_consumer_intent.optional = true
            link_consumer_intent.save
          end

          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context(when provider serial_id do not match deployment links_serial_id)::it#should raise an error has a flog score of 38</span>          </div>  </li></ol>
            expect(consumer.find_intent_by_name(&#39;ci1&#39;).optional).to eq(true)

            expect do
              subject.resolve_deployment_links(deployment_model, options)
            end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)

            expect(Bosh::Director::Models::Links::Link.count).to eq(0)
          end
        end

        context &#39;and the providers are ambiguous&#39; do
          let(:provider_intent_1_content) { nil }
          let(:provider_intent_2_content) { nil }

          before do
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              instance_group: &#39;ig1&#39;,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L801" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L810" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L988" class="js-smell-location">2</a>                  </div>  </li></ol>
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              content: provider_intent_1_content,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L801" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L810" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L988" class="js-smell-location">2</a>                  </div>  </li></ol>
              link_provider: provider,
              original_name: &#39;pi2&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              content: provider_intent_2_content,
              serial_id: serial_id,
            )
          end

          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L820" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L849" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1006" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context(and the providers are ambiguous)::it#raises an error has a flog score of 60</span>          </div>  </li></ol>
            expect {
              expect(deployment_model.link_consumers.count).to be &gt; 0
              subject.resolve_deployment_links(deployment_model, options)
            }.to raise_error do |error|
              message = error.message
              expect(message).to include(&quot;Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Multiple link providers found:&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi1&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi2&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
            end
          end

          context &#39;when the providers are from different networks&#39; do
            let(:provider_intent_1_content) do
              { networks: [&#39;foo&#39;], instances: [] }.to_json
            end

            let(:provider_intent_2_content) do
              { networks: [&#39;bar&#39;], instances: [] }.to_json
            end

            context &#39;and the consumer is requesting for a specific network&#39; do
              let(:metadata) do
                {
                  &#39;explicit_link&#39; =&gt; true,
                  &#39;network&#39; =&gt; &#39;bar&#39;,
                }
              end

              it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L820" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L849" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1006" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context(and the providers are ambiguous)::context(when the providers are from different networks)::context(and the consumer is requesting for a specific network)::it#should raise an error has a flog score of 66</span>          </div>  </li></ol>
                expect {
                  expect(deployment_model.link_consumers.count).to be &gt; 0
                  subject.resolve_deployment_links(deployment_model, options)
                }.to raise_error do |error|
                  message = error.message
                  expect(message).to include(&quot;Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Multiple link providers found:&quot;)
                  expect(message).to include(&quot;- Link provider &#39;pi1&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
                  expect(message).to include(&quot;- Link provider &#39;pi2&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
                end
              end
            end
          end

          context &#39;when link consumer intent is optional&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L863" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1029" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              link_consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.find(
                link_consumer: consumer,
                original_name: &#39;ci1&#39;,
                type: &#39;foo&#39;,
              )

              link_consumer_intent.optional = true
              link_consumer_intent.save
            end

            it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an explicit consumer)::context(and the providers are ambiguous)::context(when link consumer intent is optional)::it#raises an error has a flog score of 69</span>          </div>  </li></ol>
              expect(consumer.find_intent_by_name(&#39;ci1&#39;).optional).to eq(true)

              expect {
                subject.resolve_deployment_links(deployment_model, options)
              }.to raise_error do |error|
                message = error.message
                expect(message).to include(&quot;Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Multiple link providers found:&quot;)
                expect(message).to include(&quot;- Link provider &#39;pi1&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
                expect(message).to include(&quot;- Link provider &#39;pi2&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
              end

              expect(Bosh::Director::Models::Links::Link.count).to eq(0)
            end
          end
        end
      end

      context &#39;when it is an implicit consumer&#39; do
        let(:consumer) do
          Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            serial_id: serial_id,
          )
        end

        let(:metadata) do
          { &#39;explicit_link&#39; =&gt; false }
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L673" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L908" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1126" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L1747" class="js-smell-location">3</a>                  </div>  </li></ol>
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;ci1&#39;,
            name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
            metadata: metadata.to_json,
            serial_id: serial_id,
          )
        end

        context &#39;and the provider exists&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L684" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L919" class="js-smell-location">1</a>                  </div>  </li></ol>
          before do
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              instance_group: &#39;ig1&#39;,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
            )
          end

          it &#39;does not create a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an implicit consumer)::context(and the provider exists)::it#does not create a link has a flog score of 33</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0
            subject.resolve_deployment_links(deployment_model, options)
            expect(Bosh::Director::Models::Links::Link.count).to eq(0)
          end
        end

        context &#39;and the provider does NOT exist&#39; do
          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an implicit consumer)::context(and the provider does NOT exist)::it#raises an error has a flog score of 34</span>          </div>  </li></ol>
            expect do
              expect(deployment_model.link_consumers.count).to be &gt; 0
              subject.resolve_deployment_links(deployment_model, options)
            end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)
          end

          context &#39;when link consumer intent is optional&#39; do
            before do
              link_consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.find(
                link_consumer: consumer,
                original_name: &#39;ci1&#39;,
                type: &#39;foo&#39;,
              )

              link_consumer_intent.optional = true
              link_consumer_intent.save
            end

            it &#39;should NOT raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an implicit consumer)::context(and the provider does NOT exist)::context(when link consumer intent is optional)::it#should NOT raise an error has a flog score of 39</span>          </div>  </li></ol>
              expect(consumer.find_intent_by_name(&#39;ci1&#39;).optional).to eq(true)

              expect {
                subject.resolve_deployment_links(deployment_model, options)
              }.to_not raise_error

              expect(Bosh::Director::Models::Links::Link.count).to eq(0)
            end
          end
        end

        context &#39;and the providers are ambiguous&#39; do
          let(:consumable) { true }
          before do
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              instance_group: &#39;ig1&#39;,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L801" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L810" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L988" class="js-smell-location">2</a>                  </div>  </li></ol>
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
              consumable: consumable,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi2&#39;,
              name: &#39;provider_alias2&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
            )
          end

          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L820" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L849" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1006" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an implicit consumer)::context(and the providers are ambiguous)::it#raises an error has a flog score of 60</span>          </div>  </li></ol>
            expect {
              expect(deployment_model.link_consumers.count).to be &gt; 0
              subject.resolve_deployment_links(deployment_model, options)
            }.to raise_error do |error|
              message = error.message
              expect(message).to include(&quot;Failed to resolve link &#39;ci1&#39; with type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Multiple link providers found:&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi1&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi2&#39; with alias &#39;provider_alias2&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
            end
          end

          context &#39;when one of the providers is not consumable&#39; do
            let(:consumable) { false }
            let(:dry_run) { false }

            it &#39;resolves the consumer&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an implicit consumer)::context(and the providers are ambiguous)::context(when one of the providers is not consumable)::it#resolves the consumer has a flog score of 42</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0
              expect { subject.resolve_deployment_links(deployment_model, options) }.to_not raise_error
              expect(Bosh::Director::Models::Links::Link.count).to eq(1)
            end
          end

          context &#39;when link consumer intent is optional&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L863" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1029" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              link_consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.find(
                link_consumer: consumer,
                original_name: &#39;ci1&#39;,
                type: &#39;foo&#39;,
              )

              link_consumer_intent.optional = true
              link_consumer_intent.save
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is an implicit consumer)::context(and the providers are ambiguous)::context(when link consumer intent is optional)::it#should raise an error has a flog score of 69</span>          </div>  </li></ol>
              expect(consumer.find_intent_by_name(&#39;ci1&#39;).optional).to eq(true)

              expect {
                subject.resolve_deployment_links(deployment_model, options)
              }.to raise_error do |error|
                message = error.message
                expect(message).to include(&quot;Failed to resolve link &#39;ci1&#39; with type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Multiple link providers found:&quot;)
                expect(message).to include(&quot;- Link provider &#39;pi1&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
                expect(message).to include(&quot;- Link provider &#39;pi2&#39; with alias &#39;provider_alias2&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
              end
              expect(Bosh::Director::Models::Links::Link.count).to eq(0)
            end
          end
        end
      end

      context &#39;when it is a manual link&#39; do
        let(:consumer) do
          Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            serial_id: serial_id,
          )
        end

        let(:metadata) do
          { &#39;explicit_link&#39; =&gt; false }
        end

        before do
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
            metadata: metadata.to_json,
            serial_id: serial_id,
          )

          provider = Bosh::Director::Models::Links::LinkProvider.create(
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;manual&#39;,
            serial_id: serial_id,
          )

          Bosh::Director::Models::Links::LinkProviderIntent.create(
            link_provider: provider,
            original_name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
            serial_id: serial_id,
          )
        end

        it &#39;does not create a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is true)::context(when it is a manual link)::it#does not create a link has a flog score of 31</span>          </div>  </li></ol>
          expect(deployment_model.link_consumers.count).to be &gt; 0
          subject.resolve_deployment_links(deployment_model, options)
          expect(Bosh::Director::Models::Links::Link.count).to eq(0)
        end
      end
    end

    context &#39;when dry_run flag is false&#39; do
      let(:dry_run) { false }

      context &#39;when it is an explicit consumer&#39; do
        let(:consumer) do
          Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            instance_group: &#39;ig1&#39;,
            serial_id: serial_id,
          )
        end

        let(:metadata) do
          {
            &#39;explicit_link&#39; =&gt; true,
          }
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L673" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L908" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1126" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L1747" class="js-smell-location">3</a>                  </div>  </li></ol>
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;ci1&#39;,
            name: &#39;provider_alias&#39;,
            type: &#39;foo&#39;,
            metadata: metadata.to_json,
            serial_id: serial_id,
          )
        end

        context &#39;and a provider exists&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1137" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1842" class="js-smell-location">1</a>                  </div>  </li></ol>
          let!(:provider) do
            Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )
          end

          context &#39;and the provider intent has matching &quot;type&quot; and &quot;name&quot;&#39; do
            before do
              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;pi1&#39;,
                name: &#39;provider_alias&#39;,
                type: &#39;foo&#39;,
                content: { use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }] }.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;creates a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and a provider exists)::context(and the provider intent has matching "type" and "name")::it#creates a link has a flog score of 51</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0
              subject.resolve_deployment_links(deployment_model, options)
              expect(Bosh::Director::Models::Links::Link.count).to eq(1)
              expect(Bosh::Director::Models::Links::Link.first.link_content).to eq({ use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ address: &#39;dns2&#39; }] }.to_json)
            end
          end

          context &#39;and the provider intent has matching &quot;type&quot; but not &quot;name&quot;&#39; do
            before do
              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;pi1&#39;,
                name: &#39;non-matching-alias&#39;,
                type: &#39;foo&#39;,
                content: { use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }] }.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;should raise an error&#39; do
              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)
            end
          end
        end

        context &#39;and a provider does NOT exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1188" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1327" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1894" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2017" class="js-smell-location">3</a>                  </div>  </li></ol>
          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and a provider does NOT exist)::it#raises an error has a flog score of 30</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expect do
              subject.resolve_deployment_links(deployment_model, options)
            end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)
          end
        end

        context &#39;and the providers are ambiguous&#39; do
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1199" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1905" class="js-smell-location">1</a>                  </div>  </li></ol>
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi2&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
            )
          end

          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and the providers are ambiguous)::it#raises an error has a flog score of 60</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expect {
              subject.resolve_deployment_links(deployment_model, options)
            }.to raise_error do |error|
              message = error.message
              expect(message).to include(&quot;Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Multiple link providers found:&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi1&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi2&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
            end

            &quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Multiple providers of name/alias &#39;provider_alias&#39; found for job &#39;c1&#39; in instance group &#39;ig1&#39;. All of these match:
   pi1 aliased as &#39;provider_alias&#39; (job: p1, instance group: ig1)
   pi2 aliased as &#39;provider_alias&#39; (job: p1, instance group: ig1)&quot;
          end
        end

        context &#39;and requesting provider from different deployment&#39; do
          let!(:second_deployment_model) do
            Bosh::Director::Models::Deployment.create(
              name: &#39;second_deployment&#39;,
              links_serial_id: serial_id,
            )
          end

          let(:metadata) do
            {
              &#39;explicit_link&#39; =&gt; true,
              &#39;from_deployment&#39; =&gt; &#39;second_deployment&#39;,
            }
          end

          context &#39;and the specified deployment has a matching shared provider intent&#39; do
            before do
              provider = Bosh::Director::Models::Links::LinkProvider.create(
                deployment: second_deployment_model,
                name: &#39;p2&#39;,
                type: &#39;job&#39;,
                instance_group: &#39;ig2&#39;,
                serial_id: serial_id,
              )

              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;pi2&#39;,
                name: &#39;provider_alias&#39;,
                type: &#39;foo&#39;,
                shared: true,
                content: { use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }] }.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;should create a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting provider from different deployment)::context(and the specified deployment has a matching shared provider intent)::it#should create a link has a flog score of 51</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0
              subject.resolve_deployment_links(deployment_model, options)
              expect(Bosh::Director::Models::Links::Link.count).to eq(1)
              expect(Bosh::Director::Models::Links::Link.first.link_content).to eq({ use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ address: &#39;dns2&#39; }] }.to_json)
            end

            context &#39;when use_dns_address is FALSE on provider&#39; do
              let(:use_dns_addresses) { false }
              it &#39;should create a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting provider from different deployment)::context(and the specified deployment has a matching shared provider intent)::context(when use_dns_address is FALSE on provider)::it#should create a link has a flog score of 53</span>          </div>  </li></ol>
                expect(deployment_model.link_consumers.count).to be &gt; 0
                subject.resolve_deployment_links(deployment_model, options)
                expect(Bosh::Director::Models::Links::Link.count).to eq(1)
                expect(Bosh::Director::Models::Links::Link.first.link_content).to eq({ use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ address: &#39;ip2&#39; }] }.to_json)
              end
            end
          end

          context &#39;and the specified deployment has a matching non-shared provider intent&#39; do
            before do
              provider = Bosh::Director::Models::Links::LinkProvider.create(
                deployment: second_deployment_model,
                name: &#39;p2&#39;,
                type: &#39;job&#39;,
                instance_group: &#39;ig2&#39;,
                serial_id: serial_id,
              )

              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;pi2&#39;,
                name: &#39;provider_alias&#39;,
                type: &#39;foo&#39;,
                shared: false,
                content: { use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }] }.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting provider from different deployment)::context(and the specified deployment has a matching non-shared provider intent)::it#should raise an error has a flog score of 33</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0

              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)
            end
          end

          context &#39;and the specified deployment has no providers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1188" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1327" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1894" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2017" class="js-smell-location">3</a>                  </div>  </li></ol>
            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting provider from different deployment)::context(and the specified deployment has no providers)::it#should raise an error has a flog score of 32</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0

              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with alias &#39;provider_alias&#39; and type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)
            end
          end

          context &#39;and the specified deployment is not found&#39; do
            let(:metadata) do
              {
                &#39;explicit_link&#39; =&gt; true,
                &#39;from_deployment&#39; =&gt; &#39;not_found_deployment&#39;,
              }
            end

            it &#39;raises an error&#39; do
              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Can&#39;t find deployment &#39;not_found_deployment&#39;&quot;)
            end
          end
        end

        context &#39;and requesting for ip addresses only&#39; do
          let(:metadata) do
            {
              &#39;explicit_link&#39; =&gt; true,
              &#39;ip_addresses&#39; =&gt; true,
            }
          end

          let(:provider_intent_content) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1361" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1501" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1736" class="js-smell-location">2</a>                  </div>  </li></ol>
            {
              use_dns_addresses: use_dns_addresses,
              default_network: &#39;netb&#39;,
              networks: %w[neta netb],
              instances: [
                {
                  dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; },
                  addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; },
                },
              ],
            }
          end

          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1375" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1510" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1642" class="js-smell-location">2</a>                  </div>  </li></ol>
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              content: provider_intent_content.to_json,
              serial_id: serial_id,
            )
          end

          it &#39;creates a link where &quot;address&quot; is an IP address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting for ip addresses only)::it#creates a link where "address" is an IP address has a flog score of 50</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expected_hash = {
              &#39;use_dns_addresses&#39; =&gt; use_dns_addresses,
              &#39;default_network&#39; =&gt; &#39;netb&#39;,
              &#39;networks&#39; =&gt; %w[neta netb],
              &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;ip2&#39; }],
            }

            subject.resolve_deployment_links(deployment_model, options)
            links = Bosh::Director::Models::Links::Link.all
            expect(links.size).to eq(1)
            expect(JSON.parse(links.first.link_content)).to eq(expected_hash)
          end

          context &#39;and &quot;default_network&quot; is not defined in the provider content&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1410" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1538" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:provider_intent_content) do
              {
                networks: %w[neta netb],
                instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }],
              }
            end

            it &#39;should raise an error&#39; do
              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Unable to retrieve default network from provider. Please redeploy provider deployment&quot;)
            end
          end

          context &#39;and requesting a specific network&#39; do
            let(:metadata) do
              {
                &#39;explicit_link&#39; =&gt; true,
                &#39;ip_addresses&#39; =&gt; true,
                &#39;network&#39; =&gt; &#39;neta&#39;,
              }
            end

            context &#39;and the provider intent has the requested network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1434" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1562" class="js-smell-location">1</a>                  </div>  </li></ol>
              it &#39;creates a link where &quot;address&quot; is from the specified network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting for ip addresses only)::context(and requesting a specific network)::context(and the provider intent has the requested network)::it#creates a link where "address" is from the specified network has a flog score of 55</span>          </div>  </li></ol>
                expect(deployment_model.link_consumers.count).to be &gt; 0
                expected_hash = {
                  &#39;use_dns_addresses&#39; =&gt; use_dns_addresses,
                  &#39;default_network&#39; =&gt; &#39;neta&#39;,
                  &#39;networks&#39; =&gt; %w[neta netb],
                  &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;ip1&#39; }],
                }
                subject.resolve_deployment_links(deployment_model, options)
                links = Bosh::Director::Models::Links::Link.all
                expect(links.size).to eq(1)
                expect(JSON.parse(links.first.link_content)).to eq(expected_hash)
              end

              context &#39;and an instance in the provider does not contain the preferred network&#39; do
                let(:provider_intent_content) do
                  {
                    use_dns_addresses: use_dns_addresses,
                    default_network: &#39;netb&#39;,
                    networks: %w[neta netb],
                    instances: [
                      { dns_addresses: { netb: &#39;dns2&#39; }, addresses: { netb: &#39;ip2&#39; } },
                    ],
                  }
                end

                it &#39;should raise an error&#39; do
                  expect do
                    subject.resolve_deployment_links(deployment_model, options)
                  end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Provider link does not have network: &#39;neta&#39;&quot;)
                end
              end
            end

            context &#39;and the provider intent does not have the requested network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1469" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1598" class="js-smell-location">1</a>                  </div>  </li></ol>
              let(:provider_intent_content) do
                {
                  use_dns_addresses: use_dns_addresses,
                  default_network: &#39;netb&#39;,
                  networks: [&#39;netb&#39;],
                  instances: [
                    {
                      dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; },
                      addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; },
                    },
                  ],
                }
              end

              it &#39;raises an error&#39; do
                expect do
                  subject.resolve_deployment_links(deployment_model, options)
                end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Can&#39;t resolve link &#39;provider_alias&#39; in instance group &#39;ig1&#39; on job &#39;c1&#39; in deployment &#39;test_deployment&#39; with network &#39;neta&#39;&quot;)
              end
            end
          end
        end

        context &#39;and requesting for DNS entries&#39; do
          let(:metadata) do
            {
              &#39;explicit_link&#39; =&gt; true,
              &#39;ip_addresses&#39; =&gt; false,
            }
          end

          let(:provider_intent_content) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1361" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1501" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1736" class="js-smell-location">2</a>                  </div>  </li></ol>
            {
              use_dns_addresses: use_dns_addresses,
              default_network: &#39;netb&#39;,
              networks: %w[neta netb],
              instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }],
            }
          end

          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1375" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1510" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1642" class="js-smell-location">2</a>                  </div>  </li></ol>
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              content: provider_intent_content.to_json,
              serial_id: serial_id,
            )
          end

          it &#39;creates a link where &quot;address&quot; is a DNS entry&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting for DNS entries)::it#creates a link where "address" is a DNS entry has a flog score of 50</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0
            subject.resolve_deployment_links(deployment_model, options)

            links = Bosh::Director::Models::Links::Link.all
            expect(links.size).to eq(1)
            expect(JSON.parse(links.first.link_content)).to eq(&#39;use_dns_addresses&#39; =&gt; use_dns_addresses, &#39;default_network&#39; =&gt; &#39;netb&#39;, &#39;networks&#39; =&gt; %w[neta netb], &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;dns2&#39; }])
          end

          context &#39;and &quot;default_network&quot; is not defined in the provider content&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1410" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1538" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:provider_intent_content) do
              {
                networks: %w[neta netb],
                instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }],
              }
            end

            it &#39;should raise an error&#39; do
              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Unable to retrieve default network from provider. Please redeploy provider deployment&quot;)
            end
          end

          context &#39;and requesting a specific network&#39; do
            let(:metadata) do
              {
                &#39;explicit_link&#39; =&gt; true,
                &#39;ip_addresses&#39; =&gt; false,
                &#39;network&#39; =&gt; &#39;neta&#39;,
              }
            end

            context &#39;and the provider intent has the requested network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1434" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1562" class="js-smell-location">1</a>                  </div>  </li></ol>
              it &#39;creates a link where &quot;address&quot; is from the specified network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting for DNS entries)::context(and requesting a specific network)::context(and the provider intent has the requested network)::it#creates a link where "address" is from the specified network has a flog score of 55</span>          </div>  </li></ol>
                expect(deployment_model.link_consumers.count).to be &gt; 0

                expected_hash = {
                  &#39;use_dns_addresses&#39; =&gt; use_dns_addresses,
                  &#39;default_network&#39; =&gt; &#39;neta&#39;,
                  &#39;networks&#39; =&gt; %w[neta netb],
                  &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;dns1&#39; }],
                }
                subject.resolve_deployment_links(deployment_model, options)
                links = Bosh::Director::Models::Links::Link.all
                expect(links.size).to eq(1)
                expect(JSON.parse(links.first.link_content)).to eq(expected_hash)
              end

              context &#39;and an instance in the provider does not contain the preferred network&#39; do
                let(:provider_intent_content) do
                  {
                    use_dns_addresses: use_dns_addresses,
                    default_network: &#39;netb&#39;,
                    networks: %w[neta netb],
                    instances: [
                      { dns_addresses: { netb: &#39;dns2&#39; }, addresses: { netb: &#39;ip2&#39; } },
                    ],
                  }
                end

                it &#39;should raise an error&#39; do
                  expect do
                    subject.resolve_deployment_links(deployment_model, options)
                  end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Provider link does not have network: &#39;neta&#39;&quot;)
                end
              end
            end

            context &#39;and the provider intent does not have the requested network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1469" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1598" class="js-smell-location">1</a>                  </div>  </li></ol>
              let(:provider_intent_content) do
                {
                  use_dns_addresses: use_dns_addresses,
                  default_network: &#39;netb&#39;,
                  networks: [&#39;netb&#39;],
                  instances: [
                    {
                      dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; },
                      addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; },
                    },
                  ],
                }
              end

              it &#39;raises an error&#39; do
                expect do
                  subject.resolve_deployment_links(deployment_model, options)
                end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Can&#39;t resolve link &#39;provider_alias&#39; in instance group &#39;ig1&#39; on job &#39;c1&#39; in deployment &#39;test_deployment&#39; with network &#39;neta&#39;&quot;)
              end
            end
          end
        end

        context &#39;and ip_addresses is not defined in the consumer options in the manifest&#39; do
          let(:metadata) do
            {
              &#39;explicit_link&#39; =&gt; true,
              &#39;ip_addresses&#39; =&gt; nil,
            }
          end
          let(:provider_intent_content) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1629" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1689" class="js-smell-location">1</a>                  </div>  </li></ol>
            {
              use_dns_addresses: use_dns_addresses,
              default_network: &#39;netb&#39;,
              instances: [
                {
                  dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; },
                  addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; },
                },
              ],
            }
          end

          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1375" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1510" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1642" class="js-smell-location">2</a>                  </div>  </li></ol>
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              content: provider_intent_content.to_json,
              serial_id: serial_id,
            )
          end

          context &#39;and the global_use_dns setting is TRUE&#39; do
            let(:global_use_dns_entry) { true }

            it &#39;should honor the global setting&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and ip_addresses is not defined in the consumer options in the manifest)::context(and the global_use_dns setting is TRUE)::it#should honor the global setting has a flog score of 37</span>          </div>  </li></ol>
              subject.resolve_deployment_links(deployment_model, options)
              links = Bosh::Director::Models::Links::Link.all
              expect(links.size).to eq(1)
              expect(JSON.parse(links.first.link_content)).to eq(&#39;use_dns_addresses&#39; =&gt; use_dns_addresses, &#39;default_network&#39; =&gt; &#39;netb&#39;, &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;dns2&#39; }])
            end
          end

          context &#39;and the global_use_dns setting is FALSE (or consumer use_dns_addresses=false)&#39; do
            context &#39;when provider intent has DNS enabled&#39; do
              it &#39;creates a link with a DNS address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1674" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1702" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and ip_addresses is not defined in the consumer options in the manifest)::context(and the global_use_dns setting is FALSE (or consumer use_dns_addresses=false))::context(when provider intent has DNS enabled)::it#creates a link with a DNS address has a flog score of 37</span>          </div>  </li></ol>
                expected_link_content_with_dns = {
                  &#39;use_dns_addresses&#39; =&gt; use_dns_addresses,
                  &#39;default_network&#39; =&gt; &#39;netb&#39;,
                  &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;dns2&#39; }],
                }
                subject.resolve_deployment_links(deployment_model, options)
                links = Bosh::Director::Models::Links::Link.all
                expect(links.size).to eq(1)
                expect(JSON.parse(links.first.link_content)).to eq(expected_link_content_with_dns)
              end
            end

            context &#39;when provider intent has DNS disabled&#39; do
              let(:use_dns_addresses) { false }
              let(:provider_intent_content) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1629" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1689" class="js-smell-location">1</a>                  </div>  </li></ol>
                {
                  use_dns_addresses: use_dns_addresses,
                  default_network: &#39;netb&#39;,
                  instances: [
                    {
                      dns_addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; },
                      addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; },
                    },
                  ],
                }
              end

              it &#39;creates a link with an IP address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1674" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1702" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and ip_addresses is not defined in the consumer options in the manifest)::context(and the global_use_dns setting is FALSE (or consumer use_dns_addresses=false))::context(when provider intent has DNS disabled)::it#creates a link with an IP address has a flog score of 38</span>          </div>  </li></ol>
                expected_link_content_with_dns = {
                  &#39;use_dns_addresses&#39; =&gt; use_dns_addresses,
                  &#39;default_network&#39; =&gt; &#39;netb&#39;,
                  &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;ip2&#39; }],
                }
                subject.resolve_deployment_links(deployment_model, options)
                links = Bosh::Director::Models::Links::Link.all
                expect(links.size).to eq(1)
                expect(JSON.parse(links.first.link_content)).to eq(expected_link_content_with_dns)
              end
            end
          end
        end

        context &#39;and requesting a specific network&#39; do
          let(:metadata) do
            {
              explicit_link: true,
              network: &#39;neta&#39;,
            }
          end

          let(:provider) do
            Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )
          end

          context &#39;and the provider intent has the requested network&#39; do
            let(:link_provider_content) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1361" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1501" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1736" class="js-smell-location">2</a>                  </div>  </li></ol>
              {
                use_dns_addresses: use_dns_addresses,
                default_network: &#39;netb&#39;,
                networks: %w[neta netb],
                instances: [
                  { dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } },
                ],
              }
            end

            before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L673" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L908" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1126" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L1747" class="js-smell-location">3</a>                  </div>  </li></ol>
              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;pi1&#39;,
                name: &#39;provider_alias&#39;,
                type: &#39;foo&#39;,
                content: link_provider_content.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;creates a link where &quot;address&quot; is from the specified network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an explicit consumer)::context(and requesting a specific network)::context(and the provider intent has the requested network)::it#creates a link where "address" is from the specified network has a flog score of 52</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0

              expected_link_content_with_dns = {
                &#39;use_dns_addresses&#39; =&gt; use_dns_addresses,
                &#39;default_network&#39; =&gt; &#39;neta&#39;,
                &#39;networks&#39; =&gt; %w[neta netb],
                &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;dns1&#39; }],
              }

              subject.resolve_deployment_links(deployment_model, options)
              links = Bosh::Director::Models::Links::Link.all
              expect(links.size).to eq(1)
              expect(JSON.parse(links.first.link_content)).to eq(expected_link_content_with_dns)
            end

            context &#39;and an instance in the provider does not contain the preferred network&#39; do
              let(:link_provider_content) do
                {
                  networks: %w[neta netb],
                  instances: [
                    { dns_addresses: { netb: &#39;dns2&#39; }, addresses: { netb: &#39;ip2&#39; } },
                  ],
                }
              end

              it &#39;should raise an error&#39; do
                expect do
                  subject.resolve_deployment_links(deployment_model, options)
                end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Provider link does not have network: &#39;neta&#39;&quot;)
              end
            end
          end

          context &#39;and the provider intent does not have the requested network&#39; do
            before do
              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;pi1&#39;,
                name: &#39;provider_alias&#39;,
                type: &#39;foo&#39;,
                content: {
                  use_dns_addresses: use_dns_addresses,
                  default_network: &#39;netb&#39;,
                  networks: [],
                  instances: [
                    { dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } },
                  ],
                }.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;raises an error&#39; do
              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Can&#39;t resolve link &#39;provider_alias&#39; in instance group &#39;ig1&#39; on job &#39;c1&#39; in deployment &#39;test_deployment&#39; with network &#39;neta&#39;&quot;)
            end
          end
        end
      end

      context &#39;when it is an implicit consumer&#39; do
        let(:consumer) do
          Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            instance_group: &#39;ig1&#39;,
            serial_id: serial_id,
          )
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1831" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1957" class="js-smell-location">1</a>                  </div>  </li></ol>
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;ci1&#39;,
            name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
            metadata: { explicit_link: false }.to_json,
            serial_id: serial_id,
          )
        end

        context &#39;and the provider exists&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1137" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1842" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:provider) do
            Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )
          end

          context &#39;and the provider intent has matching &quot;type&quot;&#39; do
            before do
              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;pi1&#39;,
                name: &#39;provider_alias&#39;,
                type: &#39;foo&#39;,
                content: { use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }] }.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;creates a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an implicit consumer)::context(and the provider exists)::context(and the provider intent has matching "type")::it#creates a link has a flog score of 51</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0

              subject.resolve_deployment_links(deployment_model, options)
              expect(Bosh::Director::Models::Links::Link.count).to eq(1)
              expect(Bosh::Director::Models::Links::Link.first.link_content).to eq({ use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ address: &#39;dns2&#39; }] }.to_json)
            end
          end

          context &#39;and the provider intent has non-matching &quot;type&quot;&#39; do
            before do
              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: provider,
                original_name: &#39;ci1&#39;,
                name: &#39;ci1&#39;,
                type: &#39;non-matching-type&#39;,
                content: { use_dns_addresses: use_dns_addresses, default_network: &#39;netb&#39;, instances: [{ dns_addresses: { neta: &#39;dns1&#39;, netb: &#39;dns2&#39; }, addresses: { neta: &#39;ip1&#39;, netb: &#39;ip2&#39; } }] }.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;should raise an error&#39; do
              expect do
                subject.resolve_deployment_links(deployment_model, options)
              end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)
            end
          end
        end

        context &#39;and the provider does NOT exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1188" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1327" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1894" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2017" class="js-smell-location">3</a>                  </div>  </li></ol>
          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an implicit consumer)::context(and the provider does NOT exist)::it#raises an error has a flog score of 30</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expect do
              subject.resolve_deployment_links(deployment_model, options)
            end.to raise_error(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to resolve link &#39;ci1&#39; with type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Details below:\n    - No link providers found&quot;)
          end
        end

        context &#39;and the providers are ambiguous&#39; do
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1199" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1905" class="js-smell-location">1</a>                  </div>  </li></ol>
            provider = Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              name: &#39;p1&#39;,
              type: &#39;job&#39;,
              instance_group: &#39;ig1&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi1&#39;,
              name: &#39;provider_alias&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::LinkProviderIntent.create(
              link_provider: provider,
              original_name: &#39;pi2&#39;,
              name: &#39;provider_alias2&#39;,
              type: &#39;foo&#39;,
              serial_id: serial_id,
            )
          end

          it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is an implicit consumer)::context(and the providers are ambiguous)::it#raises an error has a flog score of 60</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expect {
              subject.resolve_deployment_links(deployment_model, options)
            }.to raise_error do |error|
              message = error.message
              expect(message).to include(&quot;Failed to resolve link &#39;ci1&#39; with type &#39;foo&#39; from job &#39;c1&#39; in instance group &#39;ig1&#39;. Multiple link providers found:&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi1&#39; with alias &#39;provider_alias&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
              expect(message).to include(&quot;- Link provider &#39;pi2&#39; with alias &#39;provider_alias2&#39; from job &#39;p1&#39; in instance group &#39;ig1&#39; in deployment &#39;test_deployment&#39;&quot;)
            end
          end
        end
      end

      context &#39;when the consumer does not include an instance group&#39; do
        let(:consumer) do
          Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            instance_group: &#39;&#39;,
            serial_id: serial_id,
          )
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1831" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1957" class="js-smell-location">1</a>                  </div>  </li></ol>
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;ci1&#39;,
            name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
            metadata: { explicit_link: false }.to_json,
            serial_id: serial_id,
          )
        end

        it &#39;should not include empty instance group in error messages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when the consumer does not include an instance group)::it#should not include empty instance group in error messages has a flog score of 45</span>          </div>  </li></ol>
          expect do
            subject.resolve_deployment_links(deployment_model, options)
          end.to raise_error do |error|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L739" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1971" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(error.message).to include(&quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:&quot;)
            expect(error.message).to include(&quot;- Failed to resolve link &#39;ci1&#39; with type &#39;foo&#39; from job &#39;c1&#39;. Details below:&quot;)
            expect(error.message).to include(&#39;- No link providers found&#39;)
          end
        end
      end

      context &#39;when it is a manual link&#39; do
        let(:consumer) do
          Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            serial_id: serial_id,
          )
        end

        let(:metadata) do
          {
            explicit_link: true,
            manual_link: true,
          }
        end

        let(:manual_link_contents) do
          {
            deployment_name: &#39;meow-deployment&#39;,
            properties: {
              port: 6,
            },
            instances: %w[a b],
          }
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2007" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2047" class="js-smell-location">1</a>                  </div>  </li></ol>
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
            metadata: metadata.to_json,
            serial_id: serial_id,
          )
        end

        context &#39;when there is no manual link provider&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L1188" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L1327" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L1894" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2017" class="js-smell-location">3</a>                  </div>  </li></ol>
          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is a manual link)::context(when there is no manual link provider)::it#should raise an error has a flog score of 30</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expect do
              subject.resolve_deployment_links(deployment_model, options)
            end.to raise_error &quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to find manual link provider for consumer &#39;ci1&#39; in job &#39;c1&#39; in instance group &#39;ci1&#39;&quot;
          end
        end

        context &#39;when there is a manual link provider&#39; do
          let!(:manual_link_provider) do
            Bosh::Director::Models::Links::LinkProvider.create(
              deployment: deployment_model,
              instance_group: &#39;ig1&#39;,
              name: &#39;c1&#39;,
              type: &#39;manual&#39;,
              serial_id: serial_id,
            )
          end

          it &#39;should raise an error when there is no satisfying provider intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is a manual link)::context(when there is a manual link provider)::it#should raise an error when there is no satisfying provider intent has a flog score of 32</span>          </div>  </li></ol>
            expect(deployment_model.link_consumers.count).to be &gt; 0

            expect do
              subject.resolve_deployment_links(deployment_model, options)
            end.to raise_error &quot;Failed to resolve links from deployment &#39;test_deployment&#39;. See errors below:\n  - Failed to find manual link provider for consumer &#39;ci1&#39; in job &#39;c1&#39; in instance group &#39;ci1&#39;&quot;
          end

          context &#39;when there is a manual link provider intent that satisfies the manual consumer&#39; do
            before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2007" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2047" class="js-smell-location">1</a>                  </div>  </li></ol>
              Bosh::Director::Models::Links::LinkProviderIntent.create(
                link_provider: manual_link_provider,
                original_name: &#39;ci1&#39;,
                type: &#39;foo&#39;,
                content: manual_link_contents.to_json,
                serial_id: serial_id,
              )
            end

            it &#39;creates a link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#resolve_deployment_links)::context(when dry_run flag is false)::context(when it is a manual link)::context(when there is a manual link provider)::context(when there is a manual link provider intent that satisfies the manual consumer)::it#creates a link has a flog score of 53</span>          </div>  </li></ol>
              expect(deployment_model.link_consumers.count).to be &gt; 0
              subject.resolve_deployment_links(deployment_model, options)

              links_created = Bosh::Director::Models::Links::Link.all

              expect(links_created.size).to eq(1)
              expect(links_created.first.link_content).to eq(manual_link_contents.to_json)
            end
          end
        end
      end
    end
  end

  describe &#39;#bind_links_to_instance&#39; do
    let(:instance_model) do
      Bosh::Director::Models::Instance.make(deployment: deployment_model)
    end

    let(:instance) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#bind_links_to_instance)::let#instance has a flog score of 30</span>          </div>  </li></ol>
      instance_double(Bosh::Director::DeploymentPlan::Instance).tap do |mock|
        allow(mock).to receive(:instance_group_name).and_return(&#39;instance-group-name&#39;)
        allow(mock).to receive(:deployment_model).and_return(deployment_model)
        allow(mock).to receive(:model).and_return(instance_model)
      end
    end

    context &#39;when an instance does not use links&#39; do
      it &#39;should not create an association between any links to the instance&#39; do
        subject.bind_links_to_instance(instance)

        expect(instance_model.links).to be_empty
      end
    end

    context &#39;when an instance uses links&#39; do
      before do
        # Create consumer
        consumer = Bosh::Director::Models::Links::LinkConsumer.create(
          deployment: deployment_model,
          instance_group: &#39;instance-group-name&#39;,
          name: &#39;job-1&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )

        consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2104" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2337" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2414" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer,
          original_name: &#39;foo&#39;,
          type: &#39;bar&#39;,
          name: &#39;foo-alias&#39;,
          serial_id: serial_id,
        )

        @link = Bosh::Director::Models::Links::Link.create(
          link_consumer_intent: consumer_intent,
          name: &#39;foo&#39;,
          link_content: &#39;{}&#39;,
        )
      end

      it &#39;should create an association between the instance and the links&#39; do
        subject.bind_links_to_instance(instance)
        expect(instance_model.links.size).to eq(1)
      end

      it &#39;should updated intance_link with current serial_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#bind_links_to_instance)::context(when an instance uses links)::it#should updated intance_link with current serial_id has a flog score of 40</span>          </div>  </li></ol>
        subject.bind_links_to_instance(instance)
        expect(instance_model.links.size).to eq(1)
        instance_link = Bosh::Director::Models::Links::InstancesLink.where(instance_id: instance.model.id, link_id: @link.id)
        expect(instance_link.first.serial_id).to eq(serial_id)
      end

      context &#39;when consumer_intent serial_id do NOT match deployment links_serial_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#bind_links_to_instance)::context(when an instance uses links)::context#when consumer_intent serial_id do NOT match deployment links_serial_id has a flog score of 41</span>          </div>  </li></ol>
        before do
          # Create consumer
          consumer = Bosh::Director::Models::Links::LinkConsumer.find(
            deployment: deployment_model,
            instance_group: &#39;instance-group-name&#39;,
            name: &#39;job-1&#39;,
            type: &#39;job&#39;,
            serial_id: serial_id,
          )

          consumer_intent_2 = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2142" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2371" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L3019" class="js-smell-location">2</a>                  </div>  </li></ol>
            link_consumer: consumer,
            original_name: &#39;foo2&#39;,
            type: &#39;bar2&#39;,
            name: &#39;foo-alias2&#39;,
            serial_id: serial_id - 1 # different from current deployment links_serial_id
          )

          @link2 = Bosh::Director::Models::Links::Link.create(
            link_consumer_intent: consumer_intent_2,
            name: &#39;foo&#39;,
            link_content: &#39;{}&#39;,
          )

          instance_model.add_link(@link2)
          instance_link = Bosh::Director::Models::Links::InstancesLink.where(instance_id: instance.model.id, link_id: @link2.id).first
          instance_link.serial_id = serial_id - 1 # different from current deployment links_serial_id
          instance_link.save
        end

        it &#39;should not update links which do NOT match links_serial_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#bind_links_to_instance)::context(when an instance uses links)::context(when consumer_intent serial_id do NOT match deployment links_serial_id)::it#should not update links which do NOT match links_serial_id has a flog score of 45</span>          </div>  </li></ol>
          subject.bind_links_to_instance(instance)
          expect(instance_model.links.size).to eq(2)

          instance_link = Bosh::Director::Models::Links::InstancesLink.where(instance_id: instance.model.id, link_id: @link2.id)
          expect(instance_link.first.serial_id).to eq(serial_id - 1)
        end
      end
    end
  end

  describe &#39;#get_links_for_instance_group&#39; do
    let(:instance_group_name) { &#39;instance-group-name&#39; }

    context &#39;when an instance does not use links&#39; do
      it &#39;returns an empty hash&#39; do
        links = subject.get_links_for_instance_group(deployment_model, instance_group_name)

        expect(links).to be_empty
      end
    end

    context &#39;when there is a consumer&#39; do
      let(:control_consumer) do
        Bosh::Director::Models::Links::LinkConsumer.create(
          deployment: deployment_model,
          instance_group: &#39;control-instance-group-name&#39;,
          name: &#39;control-job-1&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )
      end

      context &#39;when the consumer has an intent&#39; do
        let(:control_consumer_intent) do
          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: control_consumer,
            original_name: &#39;control-foo&#39;,
            type: &#39;control-bar&#39;,
            name: &#39;control-foo-alias&#39;,
            serial_id: serial_id,
          )
        end

        context &#39;when the consumer has a link&#39; do
          let!(:control_link) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="../api/controllers/link_address_controller_spec.html#L28" class="js-smell-location">0</a>                  <a href="../api/controllers/link_address_controller_spec.html#L36" class="js-smell-location">1</a>                  <a href="../api/link_manager_spec.html#L323" class="js-smell-location">2</a>                  <a href="../api/link_manager_spec.html#L331" class="js-smell-location">3</a>                  <a href="../api/link_manager_spec.html#L469" class="js-smell-location">4</a>                  <a href="links_error_builder_spec.html#L184" class="js-smell-location">5</a>                  <a href="links_error_builder_spec.html#L243" class="js-smell-location">6</a>                  <a href="links_manager_spec.html#L2207" class="js-smell-location">7</a>                  <a href="links_manager_spec.html#L2235" class="js-smell-location">8</a>                  </div>  </li></ol>
            Bosh::Director::Models::Links::Link.create(
              link_consumer_intent: control_consumer_intent,
              name: &#39;control-foo&#39;,
              link_content: &#39;{}&#39;,
            )
          end

          let(:consumer) do
            Bosh::Director::Models::Links::LinkConsumer.create(
              deployment: deployment_model,
              instance_group: &#39;instance-group-name&#39;,
              name: &#39;job-1&#39;,
              type: &#39;job&#39;,
              serial_id: serial_id,
            )
          end

          let(:consumer_intent) do
            Bosh::Director::Models::Links::LinkConsumerIntent.create(
              link_consumer: consumer,
              original_name: &#39;foo&#39;,
              type: &#39;bar&#39;,
              name: &#39;foo-alias&#39;,
              serial_id: serial_id,
            )
          end

          let!(:link) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="../api/controllers/link_address_controller_spec.html#L28" class="js-smell-location">0</a>                  <a href="../api/controllers/link_address_controller_spec.html#L36" class="js-smell-location">1</a>                  <a href="../api/link_manager_spec.html#L323" class="js-smell-location">2</a>                  <a href="../api/link_manager_spec.html#L331" class="js-smell-location">3</a>                  <a href="../api/link_manager_spec.html#L469" class="js-smell-location">4</a>                  <a href="links_error_builder_spec.html#L184" class="js-smell-location">5</a>                  <a href="links_error_builder_spec.html#L243" class="js-smell-location">6</a>                  <a href="links_manager_spec.html#L2207" class="js-smell-location">7</a>                  <a href="links_manager_spec.html#L2235" class="js-smell-location">8</a>                  </div>  </li></ol>
            Bosh::Director::Models::Links::Link.create(
              link_consumer_intent: consumer_intent,
              name: &#39;foo&#39;,
              link_content: &#39;{&quot;properties&quot;: {&quot;fizz&quot;: &quot;buzz&quot;}}&#39;,
            )
          end

          before do
            new_consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(
              link_consumer: consumer,
              original_name: &#39;meow&#39;,
              type: &#39;bar&#39;,
              name: &#39;meow-alias&#39;,
              serial_id: serial_id,
            )

            Bosh::Director::Models::Links::Link.create(
              link_consumer_intent: new_consumer_intent,
              name: &#39;meow&#39;,
              link_content: &#39;{&quot;properties&quot;: {&quot;snoopy&quot;: &quot;dog&quot;}}&#39;,
            )
          end

          it &#39;returns the links associated with the instance groups namespaced by job name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#get_links_for_instance_group)::context(when there is a consumer)::context(when the consumer has an intent)::context(when the consumer has a link)::it#returns the links associated with the instance groups namespaced by job name has a flog score of 48</span>          </div>  </li></ol>
            links = subject.get_links_for_instance_group(deployment_model, &#39;instance-group-name&#39;)
            expect(links.size).to eq(1)
            expect(links[&#39;job-1&#39;].size).to eq(2)

            expect(links[&#39;job-1&#39;][&#39;foo&#39;]).to eq(&#39;properties&#39; =&gt; { &#39;fizz&#39; =&gt; &#39;buzz&#39; })
            expect(links[&#39;job-1&#39;][&#39;meow&#39;]).to eq(&#39;properties&#39; =&gt; { &#39;snoopy&#39; =&gt; &#39;dog&#39; })
          end

          context &#39;when the consumer intent serial id does not match the consumer serial id&#39; do
            before do
              consumer_intent.serial_id = serial_id + 1
              consumer_intent.save
            end

            it &#39;should not return the link whose consumer intent serial id did not match&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#get_links_for_instance_group)::context(when there is a consumer)::context(when the consumer has an intent)::context(when the consumer has a link)::context(when the consumer intent serial id does not match the consumer serial id)::it#should not return the link whose consumer intent serial id did not match has a flog score of 39</span>          </div>  </li></ol>
              links = subject.get_links_for_instance_group(deployment_model, &#39;instance-group-name&#39;)
              expect(links.size).to eq(1)
              expect(links[&#39;job-1&#39;].size).to eq(1)
              expect(links[&#39;job-1&#39;][&#39;meow&#39;]).to eq(&#39;properties&#39; =&gt; { &#39;snoopy&#39; =&gt; &#39;dog&#39; })
            end
          end

          context &#39;when there are multiple links with the same name associated with the consumer_intent&#39; do
            before do
              first_link = Bosh::Director::Models::Links::Link.find(name: &#39;foo&#39;)

              Bosh::Director::Models::Links::Link.create(
                link_consumer_intent: consumer_intent,
                name: &#39;foo&#39;,
                link_content: &#39;{&quot;different&quot;:&quot;content&quot;}&#39;,
              )

              first_link.created_at = Time.now
              first_link.save
            end

            it &#39;should return the latest created link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#get_links_for_instance_group)::context(when there is a consumer)::context(when the consumer has an intent)::context(when the consumer has a link)::context(when there are multiple links with the same name associated with the consumer_intent)::it#should return the latest created link has a flog score of 30</span>          </div>  </li></ol>
              links = subject.get_links_for_instance_group(deployment_model, &#39;instance-group-name&#39;)
              expect(links.size).to eq(1)
              expect(links[&#39;job-1&#39;][&#39;foo&#39;]).to eq(JSON.parse(&#39;{&quot;properties&quot;: {&quot;fizz&quot;: &quot;buzz&quot;}}&#39;))
            end
          end
        end
      end
    end
  end

  describe &#39;#get_links_for_instance&#39; do
    let(:instance_model) do
      Bosh::Director::Models::Instance.make(deployment: deployment_model)
    end

    let(:is_deploying) do
      true
    end

    let(:instance) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#get_links_for_instance)::let#instance has a flog score of 39</span>          </div>  </li></ol>
      instance_double(Bosh::Director::DeploymentPlan::Instance).tap do |mock|
        allow(mock).to receive(:instance_group_name).and_return(&#39;instance-group-name&#39;)
        allow(mock).to receive(:deployment_model).and_return(deployment_model)
        allow(mock).to receive(:model).and_return(instance_model)
        allow(mock).to receive(:is_deploy_action?).and_return(is_deploying)
      end
    end

    context &#39;when there are links for the current serial id&#39; do
      let(:serial_id) { 1 }

      before do
        consumer = Bosh::Director::Models::Links::LinkConsumer.create(
          deployment: deployment_model,
          instance_group: &#39;instance-group-name&#39;,
          name: &#39;consumer&#39;,
          type: &#39;control_owner_object_type&#39;,
          serial_id: serial_id,
        )

        consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2104" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2337" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2414" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer,
          original_name: &#39;foo2&#39;,
          type: &#39;bar2&#39;,
          name: &#39;foo-alias2&#39;,
          serial_id: serial_id,
        )

        Bosh::Director::Models::Links::Link.create(
          link_consumer_intent: consumer_intent,
          name: &#39;tweet&#39;,
          link_content: &#39;{&quot;properties&quot;: {&quot;puddy&quot;: &quot;tat&quot;}}&#39;,
        )
      end

      it &#39;returns the current links&#39; do
        links = subject.get_links_for_instance(instance)
        expect(links.length).to eq(1)
        expect(links[&#39;consumer&#39;][&#39;tweet&#39;]).to_not be_nil
      end
    end

    context &#39;when there are no links for the specified serial id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#get_links_for_instance)::context#when there are no links for the specified serial id has a flog score of 34</span>          </div>  </li></ol>
      let(:serial_id) { 2 }

      before do
        consumer = Bosh::Director::Models::Links::LinkConsumer.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L752" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2363" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2923" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L3011" class="js-smell-location">3</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;instance-group-name&#39;,
          name: &#39;consumer&#39;,
          type: &#39;control_owner_object_type&#39;,
          serial_id: serial_id - 1,
        )

        consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2142" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2371" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L3019" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer,
          original_name: &#39;foo2&#39;,
          type: &#39;bar2&#39;,
          name: &#39;foo-alias2&#39;,
          serial_id: serial_id - 1,
        )

        link = Bosh::Director::Models::Links::Link.create(
          link_consumer_intent: consumer_intent,
          name: &#39;tweet&#39;,
          link_content: &#39;{&quot;properties&quot;: {&quot;puddy&quot;: &quot;tat&quot;}}&#39;,
        )

        Bosh::Director::Models::Links::InstancesLink.create(
          instance_id: instance.model.id,
          link_id: link.id,
          serial_id: serial_id - 1,
        )
      end

      it &#39;should return an empty hash&#39; do
        links = subject.get_links_for_instance(instance)
        expect(links.length).to eq(0)
      end
    end

    context &#39;when the instance is not deploying (recreate, etc)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#get_links_for_instance)::context(when the instance is not deploying (recreate, etc))#when the instance is not deploying (recreate, etc) has a flog score of 28</span>          </div>  </li></ol>
      let(:serial_id) { 1 }

      let(:is_deploying) do
        false
      end

      before do
        consumer = Bosh::Director::Models::Links::LinkConsumer.create(
          deployment: deployment_model,
          instance_group: &#39;instance-group-name&#39;,
          name: &#39;consumer&#39;,
          type: &#39;control_owner_object_type&#39;,
          serial_id: serial_id,
        )

        consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2104" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2337" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2414" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer,
          original_name: &#39;foo2&#39;,
          type: &#39;bar2&#39;,
          name: &#39;foo-alias2&#39;,
          serial_id: serial_id,
        )

        link = Bosh::Director::Models::Links::Link.create(
          link_consumer_intent: consumer_intent,
          name: &#39;tweet&#39;,
          link_content: &#39;{&quot;properties&quot;: {&quot;puddy&quot;: &quot;tat&quot;}}&#39;,
        )

        Bosh::Director::Models::Links::InstancesLink.create(
          instance_id: instance.model.id,
          link_id: link.id,
          serial_id: serial_id,
        )

        Bosh::Director::Models::Links::Link.create(
          link_consumer_intent: consumer_intent,
          name: &#39;tweet&#39;,
          link_content: &#39;{&quot;properties&quot;: {&quot;Rubber&quot;: &quot;Band&quot;}}&#39;,
        )
      end

      it &#39;should use the links associated to the instance from instance&lt;-&gt;link table&#39; do
        links = subject.get_links_for_instance(instance)
        expect(links.length).to eq(1)
        expect(links[&#39;consumer&#39;][&#39;foo2&#39;]).to eq(&#39;properties&#39; =&gt; { &#39;puddy&#39; =&gt; &#39;tat&#39; })
      end
    end
  end

  describe &#39;#get_links_from_deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##get_links_from_deployment has a flog score of 26</span>          </div>  </li></ol>
    before do
      consumer = Bosh::Director::Models::Links::LinkConsumer.create(
        deployment: deployment_model,
        instance_group: &#39;ig1&#39;,
        name: &#39;c1&#39;,
        type: &#39;job&#39;,
        serial_id: serial_id,
      )

      consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2459" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2954" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2995" class="js-smell-location">2</a>                  </div>  </li></ol>
        link_consumer: consumer,
        original_name: &#39;ci1&#39;,
        type: &#39;foo&#39;,
        metadata: { explicit_link: true }.to_json,
        serial_id: serial_id,
      )

      provider = Bosh::Director::Models::Links::LinkProvider.create(
        deployment: deployment_model,
        instance_group: &#39;ig1&#39;,
        name: &#39;c1&#39;,
        type: &#39;manual&#39;,
        serial_id: serial_id,
      )

      provider_intent = Bosh::Director::Models::Links::LinkProviderIntent.create(
        link_provider: provider,
        original_name: &#39;ci1&#39;,
        type: &#39;foo&#39;,
        serial_id: serial_id,
      )

      Bosh::Director::Models::Links::Link.create(
        link_provider_intent: provider_intent,
        link_consumer_intent: consumer_intent,
        name: consumer_intent.original_name,
        link_content: &#39;{&quot;foo&quot;: &quot;bar&quot;}&#39;,
      )
    end

    it &#39;should return a JSON string with the links encoded within it.&#39; do
      result = subject.get_links_from_deployment(deployment_model)
      expected_result = {
        &#39;c1&#39; =&gt; {
          &#39;ci1&#39; =&gt; {
            &#39;foo&#39; =&gt; &#39;bar&#39;,
          },
        },
      }
      expect(result).to match(expected_result)
    end
  end

  describe &#39;#update_provider_intents_contents&#39; do
    let(:deployment_model) { BD::Models::Deployment.make(links_serial_id: serial_id) }
    let(:link_providers) { [] }
    let(:deployment_plan) { instance_double(Bosh::Director::DeploymentPlan::Planner) }

    context &#39;when the provider type is a job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#update_provider_intents_contents)::context#when the provider type is a job has a flog score of 138</span>          </div>  </li></ol>
      let(:provider_1) do
        Bosh::Director::Models::Links::LinkProvider.make(
          deployment: deployment_model,
          instance_group: &#39;foo-ig&#39;,
          name: &#39;foo-provider&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )
      end

      let(:provider_1_intent_1) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2519" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2533" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2557" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2571" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L2819" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L2832" class="js-smell-location">5</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_1,
          original_name: &#39;link_original_name_1&#39;,
          name: &#39;link_name_1&#39;,
          type: &#39;link_type_1&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;1&#39; } }.to_json,
          serial_id: serial_id,
        )
      end

      let(:provider_1_intent_2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2519" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2533" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2557" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2571" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L2819" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L2832" class="js-smell-location">5</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_1,
          original_name: &#39;link_original_name_2&#39;,
          name: &#39;link_name_2&#39;,
          type: &#39;link_type_2&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;b&#39; =&gt; &#39;2&#39; } }.to_json,
          serial_id: serial_id,
        )
      end

      let(:provider_2) do
        Bosh::Director::Models::Links::LinkProvider.make(
          deployment: deployment_model,
          instance_group: &#39;foo-ig&#39;,
          name: &#39;foo-provider-2&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )
      end

      let(:provider_2_intent_1) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2519" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2533" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2557" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2571" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L2819" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L2832" class="js-smell-location">5</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_2,
          original_name: &#39;link_original_name_3&#39;,
          name: &#39;link_name_3&#39;,
          type: &#39;link_type_3&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;c&#39; =&gt; &#39;1&#39; } }.to_json,
          serial_id: serial_id,
        )
      end

      let(:provider_2_intent_2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2519" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2533" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2557" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2571" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L2819" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L2832" class="js-smell-location">5</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_2,
          original_name: &#39;link_original_name_4&#39;,
          name: &#39;link_name_4&#39;,
          type: &#39;link_type_4&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;d&#39; =&gt; &#39;2&#39; } }.to_json,
          serial_id: serial_id,
        )
      end
      let(:provider_2_intent_3) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2584" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2782" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2795" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2845" class="js-smell-location">3</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_2,
          original_name: &#39;link_original_name_5&#39;,
          name: &#39;link_name_5&#39;,
          type: &#39;link_type_5&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;e&#39; =&gt; &#39;5&#39; } }.to_json,
          serial_id: serial_id - 1 # different from current deployment links_serial_id
        )
      end
      let(:link_providers) do
        [provider_1, provider_2]
      end

      let(:instance_group) do
        instance_double(Bosh::Director::DeploymentPlan::InstanceGroup)
      end

      let(:link_1) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_2) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_3) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_4) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_5) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:use_short_dns_addresses) { false }
      let(:use_dns_addresses) { false }

      before do
        allow(provider_1).to receive(:intents).and_return([provider_1_intent_1, provider_1_intent_2])
        allow(provider_2).to receive(:intents).and_return([provider_2_intent_1, provider_2_intent_2])
        allow(deployment_model).to receive(:link_providers).and_return(link_providers)

        allow(link_1).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_1&#39;:&#39;bar_1&#39;}&quot;)
        allow(link_2).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_2&#39;:&#39;bar_2&#39;}&quot;)
        allow(link_3).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_3&#39;:&#39;bar_3&#39;}&quot;)
        allow(link_4).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_4&#39;:&#39;bar_4&#39;}&quot;)
        allow(link_5).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_5&#39;:&#39;bar_5&#39;}&quot;)
        allow(deployment_plan).to receive(:instance_group).and_return(instance_group)
        allow(deployment_plan).to receive(:model).and_return(deployment_model)
        allow(deployment_plan).to receive(:use_short_dns_addresses?).and_return(use_short_dns_addresses)
        allow(deployment_plan).to receive(:use_dns_addresses?).and_return(use_dns_addresses)
      end

      context &#39;and use_short_dns_addresses is enabled&#39; do
        let(:use_short_dns_addresses) { true }
        let(:use_dns_addresses) { true }

        it &#39;updates the contents field of the provider intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2648" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2668" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#update_provider_intents_contents)::context(when the provider type is a job)::context(and use_short_dns_addresses is enabled)::it#updates the contents field of the provider intents has a flog score of 174</span>          </div>  </li></ol>
          expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;a&#39; =&gt; &#39;1&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_1)
          expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;b&#39; =&gt; &#39;2&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_2)
          expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;c&#39; =&gt; &#39;1&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_3)
          expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;d&#39; =&gt; &#39;2&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_4)

          expect(provider_1_intent_1).to receive(:save)
          expect(provider_1_intent_2).to receive(:save)
          expect(provider_2_intent_1).to receive(:save)
          expect(provider_2_intent_2).to receive(:save)

          subject.update_provider_intents_contents(link_providers, deployment_plan)

          expect(provider_1_intent_1.content).to eq(&quot;{&#39;foo_1&#39;:&#39;bar_1&#39;}&quot;)
          expect(provider_1_intent_2.content).to eq(&quot;{&#39;foo_2&#39;:&#39;bar_2&#39;}&quot;)
          expect(provider_2_intent_1.content).to eq(&quot;{&#39;foo_3&#39;:&#39;bar_3&#39;}&quot;)
          expect(provider_2_intent_2.content).to eq(&quot;{&#39;foo_4&#39;:&#39;bar_4&#39;}&quot;)
        end
      end

      it &#39;updates the contents field of the provider intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2648" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2668" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#update_provider_intents_contents)::context(when the provider type is a job)::it#updates the contents field of the provider intents has a flog score of 165</span>          </div>  </li></ol>
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;b&#39; =&gt; &#39;2&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_2)
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;a&#39; =&gt; &#39;1&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_1)
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;c&#39; =&gt; &#39;1&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_3)
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;d&#39; =&gt; &#39;2&#39; }, use_dns_addresses, use_short_dns_addresses).and_return(link_4)

        expect(provider_1_intent_1).to receive(:save)
        expect(provider_1_intent_2).to receive(:save)
        expect(provider_2_intent_1).to receive(:save)
        expect(provider_2_intent_2).to receive(:save)

        subject.update_provider_intents_contents(link_providers, deployment_plan)

        expect(provider_1_intent_1.content).to eq(&quot;{&#39;foo_1&#39;:&#39;bar_1&#39;}&quot;)
        expect(provider_1_intent_2.content).to eq(&quot;{&#39;foo_2&#39;:&#39;bar_2&#39;}&quot;)
        expect(provider_2_intent_1.content).to eq(&quot;{&#39;foo_3&#39;:&#39;bar_3&#39;}&quot;)
        expect(provider_2_intent_2.content).to eq(&quot;{&#39;foo_4&#39;:&#39;bar_4&#39;}&quot;)
      end

      it &#39;should only update contents of provider_intents with matching provider serial_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#update_provider_intents_contents)::context(when the provider type is a job)::it#should only update contents of provider_intents with matching provider serial_id has a flog score of 164</span>          </div>  </li></ol>
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;a&#39; =&gt; &#39;1&#39; }, false, false).and_return(link_1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2688" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2689" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2690" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2691" class="js-smell-location">3</a>                  </div>  </li></ol>
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;b&#39; =&gt; &#39;2&#39; }, false, false).and_return(link_2)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2688" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2689" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2690" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2691" class="js-smell-location">3</a>                  </div>  </li></ol>
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;c&#39; =&gt; &#39;1&#39; }, false, false).and_return(link_3)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2688" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2689" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2690" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2691" class="js-smell-location">3</a>                  </div>  </li></ol>
        expect(Bosh::Director::DeploymentPlan::Link).to receive(:new).with(deployment_model.name, instance_group, { &#39;d&#39; =&gt; &#39;2&#39; }, false, false).and_return(link_4)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2688" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2689" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2690" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2691" class="js-smell-location">3</a>                  </div>  </li></ol>
        expect(Bosh::Director::DeploymentPlan::Link).to_not receive(:new).with(deployment_model.name, instance_group, { &#39;e&#39; =&gt; &#39;5&#39; }, false, false)

        expect(provider_2_intent_3).to_not receive(:save)
        allow(provider_2).to receive(:intents).and_return([provider_2_intent_1, provider_2_intent_2, provider_2_intent_3])

        subject.update_provider_intents_contents(link_providers, deployment_plan)
        expect(provider_1_intent_1.content).to eq(&quot;{&#39;foo_1&#39;:&#39;bar_1&#39;}&quot;)
        expect(provider_1_intent_2.content).to eq(&quot;{&#39;foo_2&#39;:&#39;bar_2&#39;}&quot;)
        expect(provider_2_intent_1.content).to eq(&quot;{&#39;foo_3&#39;:&#39;bar_3&#39;}&quot;)
        expect(provider_2_intent_2.content).to eq(&quot;{&#39;foo_4&#39;:&#39;bar_4&#39;}&quot;)
        expect(provider_2_intent_3.content).to eq(&#39;{}&#39;)
      end
    end

    shared_examples_for &#39;non-job providers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#update_provider_intents_contents)::shared_examples_for#non-job providers has a flog score of 38</span>          </div>  </li></ol>
      before do
        allow(provider).to receive(:intents).and_return([provider_intent])
        allow(deployment_model).to receive(:link_providers).and_return(link_providers)
        allow(deployment_plan).to receive(:model).and_return(deployment_model)
      end

      let(:provider) do
        Bosh::Director::Models::Links::LinkProvider.make(
          deployment: deployment_model,
          instance_group: &#39;ig&#39;,
          name: &#39;some-provider&#39;,
          type: provider_type,
        )
      end

      let(:provider_intent) do
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider,
          original_name: &#39;link_original_name_1&#39;,
          name: &#39;link_name_1&#39;,
          type: &#39;link_type_1&#39;,
          shared: true,
          consumable: true,
          content: &#39;some link content&#39;,
        )
      end

      let(:link_providers) do
        [provider]
      end

      it &#39;does not modify the contents field of the provider intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#update_provider_intents_contents)::shared_examples_for(non-job providers)::it#does not modify the contents field of the provider intents has a flog score of 25</span>          </div>  </li></ol>
        expect(provider_intent).to_not receive(:save)

        subject.update_provider_intents_contents(link_providers, deployment_plan)
        expect(provider_intent.content).to eq(&#39;some link content&#39;)
      end
    end

    context &#39;when the provider type is manual&#39; do
      let(:provider_type) { &#39;manual&#39; }

      it_behaves_like &#39;non-job providers&#39;
    end

    context &#39;when the provider type is disk&#39; do
      let(:provider_type) { &#39;disk&#39; }

      it_behaves_like &#39;non-job providers&#39;
    end

    context &#39;when the provider type is somthing else&#39; do
      let(:provider_type) { &#39;meow&#39; }

      it_behaves_like &#39;non-job providers&#39;
    end
  end

  describe &#39;#remove_unused_links&#39; do
    let(:deployment_model) { BD::Models::Deployment.make(links_serial_id: serial_id) }
    let(:link_providers) { [] }
    let(:deployment_plan) { instance_double(Bosh::Director::DeploymentPlan::Planner) }
    let(:instance_model) { Bosh::Director::Models::Instance.make(deployment: deployment_model) }

    context &#39;cleanup providers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context#cleanup providers has a flog score of 115</span>          </div>  </li></ol>
      let(:provider_1) do
        Bosh::Director::Models::Links::LinkProvider.make(
          deployment: deployment_model,
          instance_group: &#39;foo-ig&#39;,
          name: &#39;foo-provider&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id - 1,
        )
      end

      let(:provider_1_intent_1) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2584" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2782" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2795" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2845" class="js-smell-location">3</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_1,
          original_name: &#39;link_original_name_1&#39;,
          name: &#39;link_name_1&#39;,
          type: &#39;link_type_1&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;1&#39; } }.to_json,
          serial_id: serial_id - 1,
        )
      end
      let(:provider_1_intent_2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2584" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2782" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2795" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2845" class="js-smell-location">3</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_1,
          original_name: &#39;link_original_name_2&#39;,
          name: &#39;link_name_2&#39;,
          type: &#39;link_type_2&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;b&#39; =&gt; &#39;2&#39; } }.to_json,
          serial_id: serial_id - 1,
        )
      end

      let(:provider_2) do
        Bosh::Director::Models::Links::LinkProvider.make(
          deployment: deployment_model,
          instance_group: &#39;foo-ig&#39;,
          name: &#39;foo-provider-2&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )
      end

      let(:provider_2_intent_1) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2519" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2533" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2557" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2571" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L2819" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L2832" class="js-smell-location">5</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_2,
          original_name: &#39;link_original_name_3&#39;,
          name: &#39;link_name_3&#39;,
          type: &#39;link_type_3&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;c&#39; =&gt; &#39;1&#39; } }.to_json,
          serial_id: serial_id,
        )
      end
      let(:provider_2_intent_2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2519" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2533" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2557" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2571" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L2819" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L2832" class="js-smell-location">5</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_2,
          original_name: &#39;link_original_name_4&#39;,
          name: &#39;link_name_4&#39;,
          type: &#39;link_type_4&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;d&#39; =&gt; &#39;2&#39; } }.to_json,
          serial_id: serial_id,
        )
      end
      let(:provider_2_intent_3) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2584" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2782" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2795" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L2845" class="js-smell-location">3</a>                  </div>  </li></ol>
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_2,
          original_name: &#39;link_original_name_5&#39;,
          name: &#39;link_name_5&#39;,
          type: &#39;link_type_5&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          metadata: { &#39;mapped_properties&#39; =&gt; { &#39;e&#39; =&gt; &#39;5&#39; } }.to_json,
          serial_id: serial_id - 1 # different from current deployment links_serial_id
        )
      end

      let(:link_providers) do
        [provider_1, provider_2]
      end

      let(:instance_group) do
        instance_double(Bosh::Director::DeploymentPlan::InstanceGroup)
      end

      let(:link_1) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_2) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_3) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_4) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      let(:link_5) do
        instance_double(Bosh::Director::DeploymentPlan::Link)
      end

      before do
        allow(provider_1).to receive(:intents).and_return([provider_1_intent_1, provider_1_intent_2])
        allow(provider_2).to receive(:intents).and_return([provider_2_intent_1, provider_2_intent_2])
        allow(deployment_model).to receive(:link_providers).and_return(link_providers)

        allow(link_1).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_1&#39;:&#39;bar_1&#39;}&quot;)
        allow(link_2).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_2&#39;:&#39;bar_2&#39;}&quot;)
        allow(link_3).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_3&#39;:&#39;bar_3&#39;}&quot;)
        allow(link_4).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_4&#39;:&#39;bar_4&#39;}&quot;)
        allow(link_5).to receive_message_chain(:spec, :to_json).and_return(&quot;{&#39;foo_5&#39;:&#39;bar_5&#39;}&quot;)
        allow(deployment_plan).to receive(:instance_group).and_return(instance_group)
        allow(deployment_plan).to receive(:model).and_return(deployment_model)
      end

      it &#39;removes job providers with old serial_ids&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2901" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2969" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context(cleanup providers)::it#removes job providers with old serial_ids has a flog score of 29</span>          </div>  </li></ol>
        subject.remove_unused_links(deployment_model)
        providers = Bosh::Director::Models::Links::LinkProvider.where(deployment: deployment_model)
        expect(providers.count).to eq(1)
        expect(providers.first.serial_id).to eq(serial_id)
      end

      it &#39;removes job provider_intents with old serial_ids&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2908" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2976" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context(cleanup providers)::it#removes job provider_intents with old serial_ids has a flog score of 30</span>          </div>  </li></ol>
        subject.remove_unused_links(deployment_model)
        providers = Bosh::Director::Models::Links::LinkProvider.where(deployment: deployment_model)
        expect(providers.count).to eq(1)
        expect(providers.first.intents.count).to eq(2)
      end

      # TODO: LINKS: add it later
      xit &#39;removes unused disk providers&#39; do
        subject.remove_unused_links(deployment_model)
      end
    end

    context &#39;cleanup consumers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context#cleanup consumers has a flog score of 48</span>          </div>  </li></ol>
      before do
        consumer_1 = Bosh::Director::Models::Links::LinkConsumer.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L752" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2363" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2923" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L3011" class="js-smell-location">3</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;ig1&#39;,
          name: &#39;c1&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id - 1,
        )

        consumer_1_intent_1 = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2931" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2938" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2961" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer_1,
          original_name: &#39;ci1-1&#39;,
          type: &#39;foo&#39;,
          metadata: { explicit_link: true }.to_json,
          serial_id: serial_id - 1 # different from current deployment links_serial_id
        )
        consumer_1_intent_2 = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2931" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2938" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2961" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer_1,
          original_name: &#39;ci1-2&#39;,
          type: &#39;foo&#39;,
          metadata: { explicit_link: true }.to_json,
          serial_id: serial_id - 1 # different from current deployment links_serial_id
        )

        consumer_2 = Bosh::Director::Models::Links::LinkConsumer.create(
          deployment: deployment_model,
          instance_group: &#39;ig1&#39;,
          name: &#39;c1-2&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )

        consumer_2_intent_1 = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2459" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2954" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2995" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer_2,
          original_name: &#39;ci2-1&#39;,
          type: &#39;foo&#39;,
          metadata: { explicit_link: true }.to_json,
          serial_id: serial_id,
        )
        consumer_2_intent_2 = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2931" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2938" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2961" class="js-smell-location">2</a>                  </div>  </li></ol>
          link_consumer: consumer_2,
          original_name: &#39;ci2-2&#39;,
          type: &#39;foo&#39;,
          metadata: { explicit_link: true }.to_json,
          serial_id: serial_id - 1 # different from current deployment links_serial_id
        )
      end
      it &#39;removes consumers with old serial_ids&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2901" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2969" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context(cleanup consumers)::it#removes consumers with old serial_ids has a flog score of 29</span>          </div>  </li></ol>
        subject.remove_unused_links(deployment_model)
        consumers = Bosh::Director::Models::Links::LinkConsumer.where(deployment: deployment_model)
        expect(consumers.count).to eq(1)
        expect(consumers.first.serial_id).to eq(serial_id)
      end

      it &#39;removes consumer_intents with old serial_ids&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2908" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2976" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context(cleanup consumers)::it#removes consumer_intents with old serial_ids has a flog score of 30</span>          </div>  </li></ol>
        subject.remove_unused_links(deployment_model)
        consumers = Bosh::Director::Models::Links::LinkConsumer.where(deployment: deployment_model)
        expect(consumers.count).to eq(1)
        expect(consumers.first.intents.count).to eq(1)
      end
    end

    context &#39;cleanup links&#39; do
      context &#39;when there are old links&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context(cleanup links)::context#when there are old links has a flog score of 89</span>          </div>  </li></ol>
        before do
          consumer_1 = Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            serial_id: serial_id,
          )

          consumer_1_intent_1 = Bosh::Director::Models::Links::LinkConsumerIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2459" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2954" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2995" class="js-smell-location">2</a>                  </div>  </li></ol>
            link_consumer: consumer_1,
            original_name: &#39;ci1-1&#39;,
            type: &#39;foo&#39;,
            metadata: { explicit_link: true }.to_json,
            serial_id: serial_id,
          )

          Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer_1,
            original_name: &#39;ci1-2&#39;,
            type: &#39;foo&#39;,
            metadata: { explicit_link: true }.to_json,
            serial_id: serial_id,
          )

          provider = Bosh::Director::Models::Links::LinkProvider.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L752" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2363" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L2923" class="js-smell-location">2</a>                  <a href="links_manager_spec.html#L3011" class="js-smell-location">3</a>                  </div>  </li></ol>
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;manual&#39;,
            serial_id: serial_id - 1,
          )

          provider_intent = Bosh::Director::Models::Links::LinkProviderIntent.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L2142" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L2371" class="js-smell-location">1</a>                  <a href="links_manager_spec.html#L3019" class="js-smell-location">2</a>                  </div>  </li></ol>
            link_provider: provider,
            original_name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
            content: &#39;{}&#39;,
            serial_id: serial_id - 1,
          )

          link_1 = Bosh::Director::Models::Links::Link.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L3027" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L3057" class="js-smell-location">1</a>                  </div>  </li></ol>
            link_provider_intent: provider_intent,
            link_consumer_intent: consumer_1_intent_1,
            name: consumer_1_intent_1.original_name,
            link_content: &#39;{}&#39;,
          )

          instance_model.add_link(link_1)
          instance_link = Bosh::Director::Models::Links::InstancesLink.where(link_id: link_1.id).first
          instance_link.serial_id = serial_id - 1
          instance_link.save

          provider_2 = Bosh::Director::Models::Links::LinkProvider.find_or_create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="../api/controllers/links_controller_spec.html#L217" class="js-smell-location">0</a>                  <a href="../api/link_manager_spec.html#L61" class="js-smell-location">1</a>                  <a href="../api/link_manager_spec.html#L341" class="js-smell-location">2</a>                  <a href="links_error_builder_spec.html#L9" class="js-smell-location">3</a>                  <a href="links_manager_spec.html#L55" class="js-smell-location">4</a>                  <a href="links_manager_spec.html#L243" class="js-smell-location">5</a>                  <a href="links_manager_spec.html#L3039" class="js-smell-location">6</a>                  </div>  </li></ol>
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;manual&#39;,
          )
          provider_2.serial_id = serial_id
          provider_2.save

          provider_2_intent_1 = Bosh::Director::Models::Links::LinkProviderIntent.find_or_create(
            link_provider: provider_2,
            original_name: &#39;ci1&#39;,
            type: &#39;foo&#39;,
          )
          provider_2_intent_1.content = &#39;{&quot;foo&quot;: &quot;bar&quot;}&#39;
          provider_2_intent_1.serial_id = serial_id
          provider_2_intent_1.save

          link_2 = Bosh::Director::Models::Links::Link.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_manager_spec.html#L3027" class="js-smell-location">0</a>                  <a href="links_manager_spec.html#L3057" class="js-smell-location">1</a>                  </div>  </li></ol>
            link_provider_intent: provider_intent,
            link_consumer_intent: consumer_1_intent_1,
            name: consumer_1_intent_1.original_name,
            link_content: &#39;{&quot;foo&quot;: &quot;bar&quot;}&#39;,
          )

          instance_model.add_link(link_2)
          instance_link = Bosh::Director::Models::Links::InstancesLink.where(link_id: link_2.id).first
          instance_link.serial_id = serial_id
          instance_link.save
        end

        it &#39;removes links with instances_link with old serial_ids&#39; do
          subject.remove_unused_links(deployment_model)
          links = Bosh::Director::Models::Links::Link.all
          expect(links.first.link_content).to eq(&#39;{&quot;foo&quot;: &quot;bar&quot;}&#39;)
        end

        it &#39;removes instances_links with old serial_ids&#39; do
          subject.remove_unused_links(deployment_model)
          expect(Bosh::Director::Models::Links::InstancesLink.count).to eq(1)
        end
      end

      context &#39;when the link type external or variable&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context(cleanup links)::context#when the link type external or variable has a flog score of 29</span>          </div>  </li></ol>
        before do
          consumer = Bosh::Director::Models::Links::LinkConsumer.create(
            deployment: deployment_model,
            instance_group: &#39;&#39;,
            name: &#39;c1&#39;,
            type: consumer_type,
            serial_id: serial_id,
          )

          @consumer_intent = Bosh::Director::Models::Links::LinkConsumerIntent.create(
            link_consumer: consumer,
            original_name: &#39;consumer_intent&#39;,
            type: &#39;address&#39;,
            metadata: { explicit_link: true }.to_json,
            serial_id: serial_id,
          )

          provider = Bosh::Director::Models::Links::LinkProvider.create(
            deployment: deployment_model,
            instance_group: &#39;ig1&#39;,
            name: &#39;c1&#39;,
            type: &#39;job&#39;,
            serial_id: serial_id,
          )

          @provider_intent = Bosh::Director::Models::Links::LinkProviderIntent.create(
            link_provider: provider,
            original_name: &#39;ci2&#39;,
            type: &#39;address&#39;,
            content: &#39;{}&#39;,
            serial_id: serial_id,
          )

          Bosh::Director::Models::Links::Link.create(
            link_provider_intent: @provider_intent,
            link_consumer_intent: @consumer_intent,
            name: &#39;link&#39;,
            link_content: &#39;{}&#39;,
          )
        end

        context &#39;when the consumer is a variable&#39; do
          let(:consumer_type) { &#39;variable&#39; }

          before do
            Bosh::Director::Models::Links::Link.create(
              link_provider_intent: @provider_intent,
              link_consumer_intent: @consumer_intent,
              name: &#39;link3&#39;,
              link_content: &#39;{&quot;b&quot;: &quot;4&quot;}&#39;,
            )

            Bosh::Director::Models::Links::Link.create(
              link_provider_intent: @provider_intent,
              link_consumer_intent: @consumer_intent,
              name: &#39;link2&#39;,
              link_content: &#39;{&quot;a&quot;: &quot;2&quot;}&#39;,
            )
          end

          it &#39;should delete the old link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#remove_unused_links)::context(cleanup links)::context(when the link type external or variable)::context(when the consumer is a variable)::it#should delete the old link has a flog score of 53</span>          </div>  </li></ol>
            link = Bosh::Director::Models::Links::Link.where(link_consumer_intent_id: @consumer_intent.id)
            expect(link.count).to eq(3)
            subject.remove_unused_links(deployment_model)
            link = Bosh::Director::Models::Links::Link.where(name: &#39;link&#39;)
            expect(link.count).to eq(0)
            link = Bosh::Director::Models::Links::Link.where(link_consumer_intent_id: @consumer_intent.id)
            expect(link.count).to eq(1)
            link = Bosh::Director::Models::Links::Link.where(name: &#39;link2&#39;)
            expect(link.count).to eq(1)
          end
        end

        context &#39;when the consumer is external&#39; do
          let(:consumer_type) { &#39;external&#39; }

          it &#39;should not delete the link&#39; do
            subject.remove_unused_links(deployment_model)
            link = Bosh::Director::Models::Links::Link.where(name: &#39;link&#39;)
            expect(link.count).to eq(1)
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
