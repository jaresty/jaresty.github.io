<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../../../overview.html"><img src="../../../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/db/migrations/director /</small> 20171113000000_add_links_api_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">932</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">16</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2069.26</span><small> complexity</small></div>
              <div><span class="metric">1510</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                45
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require_relative &#39;../../../../db_spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe &#39;During migrations&#39; do
    let(:db) {DBSpecHelper.db}
    let(:migration_file) {&#39;20171113000000_add_links_api.rb&#39;}

    before do
      DBSpecHelper.migrate_all_before(migration_file)
    end

    context &#39;verify table columns&#39; do
      it &#39;creates the appropriate tables&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(verify table columns)::it#creates the appropriate tables has a flog score of 55</span>          </div>  </li></ol>
        DBSpecHelper.migrate(migration_file)
        expect(db.table_exists? :link_providers).to be_truthy
        expect(db.table_exists? :link_provider_intents).to be_truthy
        expect(db.table_exists? :link_consumers).to be_truthy
        expect(db.table_exists? :link_consumer_intents).to be_truthy
        expect(db.table_exists? :links).to be_truthy
        expect(db.table_exists? :instances_links).to be_truthy
      end

      it &#39;adds the link_serial_id to deployment&#39; do
        db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 42}
        DBSpecHelper.migrate(migration_file)

        expect(db[:deployments].first[:links_serial_id]).to eq(0)
      end

      it &#39;adds the has_stale_errand_links column to deployment and migrates it to TRUE&#39; do
        db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 43}
        DBSpecHelper.migrate(migration_file)

        expect(db[:deployments].first[:has_stale_errand_links]).to be_truthy
      end

      it &#39;adds the has_stale_errand_links column to deployment and defaults to FALSE&#39; do
        DBSpecHelper.migrate(migration_file)
        db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 43}

        expect(db[:deployments].first[:has_stale_errand_links]).to be_falsey
      end
    end

    context &#39;providers migration&#39; do
      context &#39;when link_spec_json is populated in the deployments table&#39; do
        let(:link_spec_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L47" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L694" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &#39;provider_instance_group_1&#39;: {
              &#39;provider_job_1&#39;: {
                &#39;link_name_1&#39;: {
                  &#39;link_type_1&#39;: {&#39;my_val&#39;: &#39;hello&#39;}
                },
                &#39;link_name_2&#39;: {
                  &#39;link_type_2&#39;: {&#39;foo&#39;: &#39;bar&#39;}
                }
              }
            },
            &#39;provider_instance_group_2&#39;: {
              &#39;provider_job_1&#39;: {
                &#39;link_name_3&#39;: {
                  &#39;link_type_1&#39;: {&#39;bar&#39;: &#39;baz&#39;}
                },
              },
              &#39;provider_job_2&#39;: {
                &#39;link_name_4&#39;: {
                  &#39;link_type_2&#39;: {&#39;foobar&#39;: &#39;bazbaz&#39;}
                }
              }
            }
          }
        end

        before do
          db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 42, link_spec_json: link_spec_json.to_json}
          DBSpecHelper.migrate(migration_file)
        end

        it &#39;will create correct links providers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(providers migration)::context(when link_spec_json is populated in the deployments table)::it#will create correct links providers has a flog score of 68</span>          </div>  </li></ol>
          expect(db[:link_providers].count).to eq(3)

          expected_links_providers = [
            {instance_group: &#39;provider_instance_group_1&#39;, deployment_id: 42, type: &#39;job&#39;, name: &#39;provider_job_1&#39;, serial_id: 0},
            {instance_group: &#39;provider_instance_group_2&#39;, deployment_id: 42, type: &#39;job&#39;, name: &#39;provider_job_1&#39;, serial_id: 0},
            {instance_group: &#39;provider_instance_group_2&#39;, deployment_id: 42, type: &#39;job&#39;, name: &#39;provider_job_2&#39;, serial_id: 0},
          ]

          db[:link_providers].order(:id).each_with_index do |provider, index|
            output = expected_links_providers[index]
            expect(provider[:name]).to eq(output[:name])
            expect(provider[:deployment_id]).to eq(output[:deployment_id])
            expect(provider[:instance_group]).to eq(output[:instance_group])
            expect(provider[:type]).to eq(output[:type])
            expect(provider[:serial_id]).to eq(output[:serial_id])
          end
        end

        it &#39;will create correct links providers intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(providers migration)::context(when link_spec_json is populated in the deployments table)::it#will create correct links providers intents has a flog score of 110</span>          </div>  </li></ol>
          provider_1_id = db[:link_providers].where(instance_group: &#39;provider_instance_group_1&#39;, deployment_id: 42, type: &#39;job&#39;, name: &#39;provider_job_1&#39;, serial_id: 0).first[:id]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L99" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L100" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L101" class="js-smell-location">2</a>                  </div>  </li></ol>
          provider_2_id = db[:link_providers].where(instance_group: &#39;provider_instance_group_2&#39;, deployment_id: 42, type: &#39;job&#39;, name: &#39;provider_job_1&#39;, serial_id: 0).first[:id]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L99" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L100" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L101" class="js-smell-location">2</a>                  </div>  </li></ol>
          provider_3_id = db[:link_providers].where(instance_group: &#39;provider_instance_group_2&#39;, deployment_id: 42, type: &#39;job&#39;, name: &#39;provider_job_2&#39;, serial_id: 0).first[:id]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L99" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L100" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L101" class="js-smell-location">2</a>                  </div>  </li></ol>

          expected_link_providers_intents = [
            {link_provider_id: provider_1_id, original_name: &#39;link_name_1&#39;, type: &#39;link_type_1&#39;, name: &#39;link_name_1&#39;, content: &#39;{&quot;my_val&quot;:&quot;hello&quot;}&#39;, serial_id: 0},
            {link_provider_id: provider_1_id, original_name: &#39;link_name_2&#39;, type: &#39;link_type_2&#39;, name: &#39;link_name_2&#39;, content: &#39;{&quot;foo&quot;:&quot;bar&quot;}&#39;, serial_id: 0},
            {link_provider_id: provider_2_id, original_name: &#39;link_name_3&#39;, type: &#39;link_type_1&#39;, name: &#39;link_name_3&#39;, content: &#39;{&quot;bar&quot;:&quot;baz&quot;}&#39;, serial_id: 0},
            {link_provider_id: provider_3_id, original_name: &#39;link_name_4&#39;, type: &#39;link_type_2&#39;, name: &#39;link_name_4&#39;, content: &#39;{&quot;foobar&quot;:&quot;bazbaz&quot;}&#39;, serial_id: 0},
          ]

          expect(db[:link_provider_intents].count).to eq(4)
          db[:link_provider_intents].order(:id).each_with_index do |provider_intent, index|
            output = expected_link_providers_intents[index]
            expect(provider_intent[:link_provider_id]).to eq(output[:link_provider_id])
            expect(provider_intent[:original_name]).to eq(output[:original_name])
            expect(provider_intent[:type]).to eq(output[:type])
            expect(provider_intent[:name]).to eq(output[:name])
            expect(provider_intent[:shared]).to eq(true)
            expect(provider_intent[:consumable]).to eq(true)
            expect(provider_intent[:serial_id]).to eq(output[:serial_id])
          end
        end
      end
    end

    context &#39;consumer migration&#39; do
      context &#39;when spec_json is populated with consumed links in the instances table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(consumer migration)::context#when spec_json is populated with consumed links in the instances table has a flog score of 26</span>          </div>  </li></ol>
        let(:instance_spec_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L127" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L272" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L720" class="js-smell-location">2</a>                  </div>  </li></ol>
          {
            &quot;deployment&quot;: &quot;fake-deployment&quot;,
            &quot;name&quot;: &quot;provider_instance_group_1&quot;,
            &quot;job&quot;: {
              &quot;name&quot;: &quot;provider_instance_group_1&quot;,
              &quot;templates&quot;: [
                {
                  &quot;name&quot;: &quot;http_proxy_with_requires&quot;,
                  &quot;version&quot;: &quot;760680c4a796a2ffca24026c561c06dd5bdef6b3&quot;,
                  &quot;sha1&quot;: &quot;fdf0d8acd01055f32fb28caee3b5a2d383848e53&quot;,
                  &quot;blobstore_id&quot;: &quot;e6a084ab-541c-4f9e-8132-573627bded5a&quot;,
                  &quot;logs&quot;: []
                }
              ]
            },
            &quot;links&quot;: {
              &quot;http_proxy_with_requires&quot;: {
                &quot;proxied_http_endpoint&quot;: {
                  &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
                  &quot;instances&quot;: [
                    {
                      &quot;name&quot;: &quot;provider_deployment_node&quot;,
                      &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                      &quot;index&quot;: 0,
                      &quot;bootstrap&quot;: true,
                      &quot;az&quot;: &quot;z1&quot;,
                      &quot;address&quot;: &quot;192.168.1.10&quot;
                    }
                  ],
                  &quot;properties&quot;: {
                    &quot;listen_port&quot;: 15672,
                    &quot;name_space&quot;: {
                      &quot;fibonacci&quot;: &quot;((fibonacci_placeholder))&quot;,
                      &quot;prop_a&quot;: &quot;default&quot;
                    }
                  }
                },
                &quot;proxied_http_endpoint2&quot;: {
                  &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
                  &quot;instances&quot;: [
                    {
                      &quot;name&quot;: &quot;provider_deployment_node&quot;,
                      &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                      &quot;index&quot;: 0,
                      &quot;bootstrap&quot;: true,
                      &quot;az&quot;: &quot;z1&quot;,
                      &quot;address&quot;: &quot;192.168.1.10&quot;
                    }
                  ],
                  &quot;properties&quot;: {
                    &quot;a&quot;: 1,
                    &quot;name_space&quot;: {
                      &quot;asdf&quot;: &quot;((fibonacci_placeholder))&quot;,
                      &quot;dbxcv&quot;: &quot;default&quot;
                    }
                  }
                }
              }
            }
          }
        end
        let(:expected_owner_object_info) do
          { instance_group_name: &#39;provider_instance_group_1&#39; }
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L193" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L335" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L521" class="js-smell-location">2</a>                  </div>  </li></ol>
          db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 42, link_spec_json: &quot;{}&quot;}
          db[:variable_sets] &lt;&lt; {id: 1, deployment_id: 42, created_at: Time.now}
          db[:instances] &lt;&lt; {
            job: &#39;provider_instance_group_1&#39;,
            id: 22,
            index: 0,
            deployment_id: 42,
            state: &quot;started&quot;,
            variable_set_id: 1,
            spec_json: instance_spec_json.to_json
          }
        end

        it &#39;will create one consumer per consuming job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(consumer migration)::context(when spec_json is populated with consumed links in the instances table)::it#will create one consumer per consuming job has a flog score of 81</span>          </div>  </li></ol>
          DBSpecHelper.migrate(migration_file)
          expect(db[:link_consumers].count).to eq(1)

          expect(db[:link_consumers].first[:deployment_id]).to eq(42)
          expect(db[:link_consumers].first[:instance_group]).to eq(&#39;provider_instance_group_1&#39;)
          expect(db[:link_consumers].first[:name]).to eq(&#39;http_proxy_with_requires&#39;)
          expect(db[:link_consumers].first[:type]).to eq(&#39;job&#39;)
          expect(db[:link_consumers].first[:serial_id]).to eq(0)
        end

        it &#39;will create the correct link_consumers_intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L218" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L255" class="js-smell-location">1</a>                  </div>  </li></ol>
          DBSpecHelper.migrate(migration_file)
          consumer_id = db[:link_consumers].first[:id]

          expected_links_consumers_intents = [
            {:id=&gt;Integer, :link_consumer_id=&gt;consumer_id, :original_name=&gt;&#39;proxied_http_endpoint&#39;, :type=&gt;&#39;undefined-migration&#39;, :name =&gt; &#39;proxied_http_endpoint&#39;, :optional=&gt;false, :blocked=&gt;false, :metadata=&gt; nil, serial_id: 0},
            {:id=&gt;Integer, :link_consumer_id=&gt;consumer_id, :original_name=&gt;&#39;proxied_http_endpoint2&#39;, :type=&gt;&#39;undefined-migration&#39;, :name =&gt; &#39;proxied_http_endpoint2&#39;, :optional=&gt;false, :blocked=&gt;false, :metadata=&gt; nil, serial_id: 0}
          ]

          expect(db[:link_consumer_intents].all).to match_array(expected_links_consumers_intents)
        end

        context &#39;multiple instances consume same link&#39; do
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L231" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L537" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L635" class="js-smell-location">2</a>                  </div>  </li></ol>
            db[:instances] &lt;&lt; {
              job: &#39;provider_instance_group_1&#39;,
              id: 23,
              index: 0,
              deployment_id: 42,
              state: &quot;started&quot;,
              variable_set_id: 1,
              spec_json: instance_spec_json.to_json
            }
          end

          it &#39;will not create duplicate consumers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(consumer migration)::context(when spec_json is populated with consumed links in the instances table)::context(multiple instances consume same link)::it#will not create duplicate consumers has a flog score of 97</span>          </div>  </li></ol>
            expect(db[:instances].count).to eq(2)
            DBSpecHelper.migrate(migration_file)
            expect(db[:link_consumers].count).to eq(1)

            expect(db[:link_consumers].first[:deployment_id]).to eq(42)
            expect(db[:link_consumers].first[:instance_group]).to eq(&#39;provider_instance_group_1&#39;)
            expect(db[:link_consumers].first[:name]).to eq(&#39;http_proxy_with_requires&#39;)
            expect(db[:link_consumers].first[:type]).to eq(&#39;job&#39;)
            expect(db[:link_consumers].first[:serial_id]).to eq(0)
          end

          it &#39;will create the correct link_consumers_intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L218" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L255" class="js-smell-location">1</a>                  </div>  </li></ol>
            DBSpecHelper.migrate(migration_file)
            consumer_id = db[:link_consumers].first[:id]

            expected_links_consumers_intents = [
              {:id=&gt;Integer, :link_consumer_id=&gt;consumer_id, :original_name=&gt;&#39;proxied_http_endpoint&#39;, :type=&gt;&#39;undefined-migration&#39;, :name =&gt; &#39;proxied_http_endpoint&#39;, :optional=&gt;false, :blocked=&gt;false, :metadata=&gt;nil, serial_id: 0},
              {:id=&gt;Integer, :link_consumer_id=&gt;consumer_id, :original_name=&gt;&#39;proxied_http_endpoint2&#39;, :type=&gt;&#39;undefined-migration&#39;, :name =&gt; &#39;proxied_http_endpoint2&#39;, :optional=&gt;false, :blocked=&gt;false, :metadata=&gt;nil, serial_id: 0}
            ]

            expect(db[:link_consumer_intents].all).to match_array(expected_links_consumers_intents)
          end
        end
      end
    end

    context &#39;link migration&#39; do
      context &#39;when spec_json is populated with consumed links in the instances table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context#when spec_json is populated with consumed links in the instances table has a flog score of 27</span>          </div>  </li></ol>
        let(:instance_spec_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L127" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L272" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L720" class="js-smell-location">2</a>                  </div>  </li></ol>
          {
            &quot;deployment&quot;: &quot;fake-deployment&quot;,
            &quot;name&quot;: &quot;provider_instance_group_1&quot;,
            &quot;job&quot;: {
              &quot;name&quot;: &quot;provider_instance_group_1&quot;,
              &quot;templates&quot;: [
                {
                  &quot;name&quot;: &quot;http_proxy_with_requires&quot;,
                  &quot;version&quot;: &quot;760680c4a796a2ffca24026c561c06dd5bdef6b3&quot;,
                  &quot;sha1&quot;: &quot;fdf0d8acd01055f32fb28caee3b5a2d383848e53&quot;,
                  &quot;blobstore_id&quot;: &quot;e6a084ab-541c-4f9e-8132-573627bded5a&quot;,
                  &quot;logs&quot;: []
                }
              ]
            },
            &quot;links&quot;: {
              &quot;http_proxy_with_requires&quot;: {
                &quot;proxied_http_endpoint&quot;: {
                  &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
                  &quot;instances&quot;: [
                    {
                      &quot;name&quot;: &quot;provider_deployment_node&quot;,
                      &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                      &quot;index&quot;: 0,
                      &quot;bootstrap&quot;: true,
                      &quot;az&quot;: &quot;z1&quot;,
                      &quot;address&quot;: &quot;192.168.1.10&quot;
                    }
                  ],
                  &quot;properties&quot;: {
                    &quot;listen_port&quot;: 15672,
                    &quot;name_space&quot;: {
                      &quot;fibonacci&quot;: &quot;((fibonacci_placeholder))&quot;,
                      &quot;prop_a&quot;: &quot;default&quot;
                    }
                  }
                },
                &quot;proxied_http_endpoint2&quot;: {
                  &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
                  &quot;instances&quot;: [
                    {
                      &quot;name&quot;: &quot;provider_deployment_node&quot;,
                      &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                      &quot;index&quot;: 0,
                      &quot;bootstrap&quot;: true,
                      &quot;az&quot;: &quot;z1&quot;,
                      &quot;address&quot;: &quot;192.168.1.10&quot;
                    }
                  ],
                  &quot;properties&quot;: {
                    &quot;a&quot;: 1,
                    &quot;name_space&quot;: {
                      &quot;asdf&quot;: &quot;((fibonacci_placeholder))&quot;,
                      &quot;dbxcv&quot;: &quot;default&quot;
                    }
                  }
                }
              }
            }
          }
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L193" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L335" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L521" class="js-smell-location">2</a>                  </div>  </li></ol>
          db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 42, link_spec_json: &quot;{}&quot;}
          db[:variable_sets] &lt;&lt; {id: 1, deployment_id: 42, created_at: Time.now}
          db[:instances] &lt;&lt; {
            job: &#39;provider_instance_group_1&#39;,
            id: 22,
            index: 0,
            deployment_id: 42,
            state: &quot;started&quot;,
            variable_set_id: 1,
            spec_json: instance_spec_json.to_json
          }
        end

        it &#39;will create one link per consuming instance group/job/link name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when spec_json is populated with consumed links in the instances table)::it#will create one link per consuming instance group/job/link name has a flog score of 148</span>          </div>  </li></ol>
          before = Time.now
          DBSpecHelper.migrate(migration_file)
          after = Time.now

          link_consumer_intent_1 = db[:link_consumer_intents].where(original_name: &#39;proxied_http_endpoint&#39;).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'link_consumer_intent_1'</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L354" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L445" class="js-smell-location">1</a>                  </div>  </li></ol>
          link_consumer_intent_2 = db[:link_consumer_intents].where(original_name: &#39;proxied_http_endpoint2&#39;).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'link_consumer_intent_2'</span>          </div>  </li></ol>

          expect(db[:links].count).to eq(2)

          link_1_expected_content = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L359" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L387" class="js-smell-location">1</a>                  </div>  </li></ol>
            &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
            &quot;instances&quot;: [
              {
                &quot;name&quot;: &quot;provider_deployment_node&quot;,
                &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                &quot;index&quot;: 0,
                &quot;bootstrap&quot;: true,
                &quot;az&quot;: &quot;z1&quot;,
                &quot;address&quot;: &quot;192.168.1.10&quot;
              }
            ],
            &quot;properties&quot;: {
              &quot;listen_port&quot;: 15672,
              &quot;name_space&quot;: {
                &quot;fibonacci&quot;: &quot;((fibonacci_placeholder))&quot;,
                &quot;prop_a&quot;: &quot;default&quot;
              }
            }
          }.to_json

          links_1 = db[:links].where(name: &#39;proxied_http_endpoint&#39;).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'links_1'</span>          </div>  </li></ol>
          expect(links_1[:link_provider_intent_id]).to be_nil
          expect(links_1[:link_consumer_intent_id]).to eq(link_consumer_intent_1[:id])
          expect(links_1[:link_content]).to eq(link_1_expected_content)
          expect(links_1[:created_at].to_i).to be &gt;= before.to_i
          expect(links_1[:created_at].to_i).to be &lt;= after.to_i

          link_2_expected_content = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L359" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L387" class="js-smell-location">1</a>                  </div>  </li></ol>
            &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
            &quot;instances&quot;: [
              {
                &quot;name&quot;: &quot;provider_deployment_node&quot;,
                &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                &quot;index&quot;: 0,
                &quot;bootstrap&quot;: true,
                &quot;az&quot;: &quot;z1&quot;,
                &quot;address&quot;: &quot;192.168.1.10&quot;
              }
            ],
            &quot;properties&quot;: {
              &quot;a&quot;: 1,
              &quot;name_space&quot;: {
                &quot;asdf&quot;: &quot;((fibonacci_placeholder))&quot;,
                &quot;dbxcv&quot;: &quot;default&quot;
              }
            }
          }.to_json

          links_2 = db[:links].where(name: &#39;proxied_http_endpoint2&#39;).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'links_2'</span>          </div>  </li></ol>
          expect(links_2[:link_provider_intent_id]).to be_nil
          expect(links_2[:link_consumer_intent_id]).to eq(link_consumer_intent_2[:id])
          expect(links_2[:link_content]).to eq(link_2_expected_content)
          expect(links_2[:created_at].to_i).to be &gt;= before.to_i
          expect(links_2[:created_at].to_i).to be &lt;= after.to_i
        end

        it &#39;will create one instance_link per job per consuming instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L416" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L568" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L676" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when spec_json is populated with consumed links in the instances table)::it#will create one instance_link per job per consuming instance has a flog score of 78</span>          </div>  </li></ol>
          DBSpecHelper.migrate(migration_file)
          expect(db[:instances_links].count).to eq(2)

          dataset = db[:instances_links].all
          expect(dataset[0][:instance_id]).to eq(22)
          expect(dataset[0][:link_id]).to eq(1)
          expect(dataset[0][:serial_id]).to eq(0)

          expect(dataset[1][:instance_id]).to eq(22)
          expect(dataset[1][:link_id]).to eq(2)
          expect(dataset[1][:serial_id]).to eq(0)
        end

        it &#39;will remove the links key from spec_json&#39; do
          DBSpecHelper.migrate(migration_file)

          db[:instances].all.each do |instance|
            spec_json = instance[:spec_json]
            spec = JSON.load(spec_json)
            expect(spec.has_key?(&#39;links&#39;)).to be_falsey
          end
        end

        context &#39;when link_consumer is deleted: #cascade relationship&#39; do
          it &#39;should delete associated link_consumer_intents and links&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when spec_json is populated with consumed links in the instances table)::context(when link_consumer is deleted: #cascade relationship)::it#should delete associated link_consumer_intents and links has a flog score of 74</span>          </div>  </li></ol>
            DBSpecHelper.migrate(migration_file)

            link_consumer_1 = db[:link_consumers].where(name: &#39;http_proxy_with_requires&#39;).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'link_consumer_1'</span>          </div>  </li></ol>
            link_consumer_intent_1 = db[:link_consumer_intents].where(original_name: &#39;proxied_http_endpoint&#39;).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'link_consumer_intent_1'</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L354" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L445" class="js-smell-location">1</a>                  </div>  </li></ol>
            link_1 = db[:links].where(name: &#39;proxied_http_endpoint&#39;).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'link_1'</span>          </div>  </li></ol>

            expect{db[:link_consumers].where(id: link_consumer_1[:id]).delete}.to_not raise_error

            expect(db[:link_consumer_intents].where(id: link_consumer_intent_1[:id]).first).to be_nil
            expect(db[:links].where(link_consumer_intent_id: link_consumer_intent_1[:id]).count).to eq(0)
          end
        end

        context &#39;when deployment is deleted&#39; do
          before do
            DBSpecHelper.migrate(migration_file)
            db[:instances].delete
          end

          it &#39;should delete all links, providers, consumers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when spec_json is populated with consumed links in the instances table)::context(when deployment is deleted)::it#should delete all links, providers, consumers has a flog score of 87</span>          </div>  </li></ol>
            expect{db[:deployments].where(id: 42).delete}.to_not raise_error
            expect(db[:links].count).to eq(0)
            expect(db[:link_consumers].count).to eq(0)
            expect(db[:link_providers].count).to eq(0)
            expect(db[:link_provider_intents].count).to eq(0)
            expect(db[:link_consumer_intents].count).to eq(0)
            expect(db[:instances_links].count).to eq(0)
          end
        end
      end

      context &#39;when multiple instances contain the same link key&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context#when multiple instances contain the same link key has a flog score of 27</span>          </div>  </li></ol>
        let(:instance_spec_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L474" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L588" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &quot;deployment&quot;: &quot;fake-deployment&quot;,
            &quot;name&quot;: &quot;provider_instance_group_1&quot;,
            &quot;job&quot;: {
              &quot;name&quot;: &quot;provider_instance_group_1&quot;,
              &quot;templates&quot;: [
                {
                  &quot;name&quot;: &quot;http_proxy_with_requires&quot;,
                  &quot;version&quot;: &quot;760680c4a796a2ffca24026c561c06dd5bdef6b3&quot;,
                  &quot;sha1&quot;: &quot;fdf0d8acd01055f32fb28caee3b5a2d383848e53&quot;,
                  &quot;blobstore_id&quot;: &quot;e6a084ab-541c-4f9e-8132-573627bded5a&quot;,
                  &quot;logs&quot;: []
                }
              ]
            },
            &quot;links&quot;: {
              &quot;http_proxy_with_requires&quot;: {
                &quot;proxied_http_endpoint&quot;: link_content
              }
            }
          }
        end

        let(:link_content) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L498" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L612" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
            &quot;instances&quot;: [
              {
                &quot;name&quot;: &quot;provider_deployment_node&quot;,
                &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                &quot;index&quot;: 0,
                &quot;bootstrap&quot;: true,
                &quot;az&quot;: &quot;z1&quot;,
                &quot;address&quot;: &quot;192.168.1.10&quot;
              }
            ],
            &quot;properties&quot;: {
              &quot;listen_port&quot;: 15672,
              &quot;name_space&quot;: {
                &quot;fibonacci&quot;: &quot;((fibonacci_placeholder))&quot;,
                &quot;prop_a&quot;: &quot;default&quot;
              }
            }
          }
        end

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L193" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L335" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L521" class="js-smell-location">2</a>                  </div>  </li></ol>
          db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 42, link_spec_json: &quot;{}&quot;}
          db[:variable_sets] &lt;&lt; {id: 1, deployment_id: 42, created_at: Time.now}
          db[:instances] &lt;&lt; {
            job: &#39;provider_instance_group_1&#39;,
            id: 22,
            index: 0,
            deployment_id: 42,
            state: &#39;started&#39;,
            variable_set_id: 1,
            spec_json: instance_spec_json.to_json
          }
        end

        # having 2 links with same contents should be ok as well, test for it
        context &#39;and contents are the same&#39; do
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L231" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L537" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L635" class="js-smell-location">2</a>                  </div>  </li></ol>
            db[:instances] &lt;&lt; {
              job: &#39;provider_instance_group_1&#39;,
              id: 23,
              index: 1,
              deployment_id: 42,
              state: &#39;started&#39;,
              variable_set_id: 1,
              spec_json: instance_spec_json.to_json
            }
          end

          it &#39;should create only one link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when multiple instances contain the same link key)::context(and contents are the same)::it#should create only one link has a flog score of 150</span>          </div>  </li></ol>
            before = Time.now
            DBSpecHelper.migrate(migration_file)
            after = Time.now

            link_consumers_1_id = db[:link_consumers].where(name: &#39;http_proxy_with_requires&#39;).first[:id]
            link_consumers_intent_1_id = db[:link_consumer_intents].where(original_name: &#39;proxied_http_endpoint&#39;, link_consumer_id: link_consumers_1_id).first[:id]

            expect(link_consumers_intent_1_id).to_not be_nil
            expect(db[:links].count).to eq(1)

            expect(db[:links].first[:name]).to eq(&#39;proxied_http_endpoint&#39;)
            expect(db[:links].first[:link_provider_intent_id]).to be_nil
            expect(db[:links].first[:link_consumer_intent_id]).to eq(link_consumers_intent_1_id)
            expect(db[:links].first[:link_content]).to eq(link_content.to_json)
            expect(db[:links].first[:created_at].to_i).to be &gt;= before.to_i
            expect(db[:links].first[:created_at].to_i).to be &lt;= after.to_i
          end

          it &#39;will create one instance_link per consuming instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L416" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L568" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L676" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when multiple instances contain the same link key)::context(and contents are the same)::it#will create one instance_link per consuming instance has a flog score of 83</span>          </div>  </li></ol>
            DBSpecHelper.migrate(migration_file)
            expect(db[:instances_links].count).to eq(2)

            dataset = db[:instances_links].all
            expect(dataset[0][:instance_id]).to eq(22)
            expect(dataset[0][:link_id]).to eq(1)
            expect(dataset[0][:serial_id]).to eq(0)

            expect(dataset[1][:instance_id]).to eq(23)
            expect(dataset[1][:link_id]).to eq(1)
            expect(dataset[1][:serial_id]).to eq(0)
          end
        end

        # multiple links attached to the same consumer intent???
        # how we do the equality of the links contents, need to validate it is correct ???
        # the order of the hash contents and keys should be ok

        context &#39;and contents are different&#39; do
          let(:instance_spec_json2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L474" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L588" class="js-smell-location">1</a>                  </div>  </li></ol>
            {
              &quot;deployment&quot;: &quot;fake-deployment&quot;,
              &quot;name&quot;: &quot;provider_instance_group_1&quot;,
              &quot;job&quot;: {
                &quot;name&quot;: &quot;provider_instance_group_1&quot;,
                &quot;templates&quot;: [
                  {
                    &quot;name&quot;: &quot;http_proxy_with_requires&quot;,
                    &quot;version&quot;: &quot;760680c4a796a2ffca24026c561c06dd5bdef6b3&quot;,
                    &quot;sha1&quot;: &quot;fdf0d8acd01055f32fb28caee3b5a2d383848e53&quot;,
                    &quot;blobstore_id&quot;: &quot;e6a084ab-541c-4f9e-8132-573627bded5a&quot;,
                    &quot;logs&quot;: []
                  }
                ]
              },
              &quot;links&quot;: {
                &quot;http_proxy_with_requires&quot;: {
                  &quot;proxied_http_endpoint&quot;: link_content2
                }
              }
            }
          end

          let(:link_content2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L498" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L612" class="js-smell-location">1</a>                  </div>  </li></ol>
            {
              &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
              &quot;instances&quot;: [
                {
                  &quot;name&quot;: &quot;provider_deployment_node&quot;,
                  &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                  &quot;index&quot;: 0,
                  &quot;bootstrap&quot;: true,
                  &quot;az&quot;: &quot;z1&quot;,
                  &quot;address&quot;: &quot;192.168.1.10&quot;
                }
              ],
              &quot;properties&quot;: {
                &quot;listen_port&quot;: 1111,
                &quot;name_space&quot;: {
                  &quot;fibonacci&quot;: &quot;1 2 3 5 8 13 21 34 55 89 144&quot;,
                  &quot;prop_a&quot;: &quot;ALPHABET!&quot;
                }
              }
            }
          end

          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L231" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L537" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L635" class="js-smell-location">2</a>                  </div>  </li></ol>
            db[:instances] &lt;&lt; {
              job: &#39;provider_instance_group_1&#39;,
              id: 23,
              index: 1,
              deployment_id: 42,
              state: &quot;started&quot;,
              variable_set_id: 1,
              spec_json: instance_spec_json2.to_json
            }
          end

          it &#39;should create two distinct link rows&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when multiple instances contain the same link key)::context(and contents are different)::it#should create two distinct link rows has a flog score of 217</span>          </div>  </li></ol>
            before = Time.now
            DBSpecHelper.migrate(migration_file)
            after = Time.now

            link_consumers_1_id = db[:link_consumers].where(name: &#39;http_proxy_with_requires&#39;).first[:id]
            link_consumers_intent_1_id = db[:link_consumer_intents].where(original_name: &#39;proxied_http_endpoint&#39;, link_consumer_id: link_consumers_1_id).first[:id]
            expect(link_consumers_intent_1_id).to_not be_nil

            links_dataset = db[:links]
            expect(links_dataset.count).to eq(2)

            link_rows = links_dataset.all

            expect(link_rows[0][:name]).to eq(&#39;proxied_http_endpoint&#39;)
            expect(link_rows[0][:link_provider_intent_id]).to be_nil
            expect(link_rows[0][:link_consumer_intent_id]).to eq(link_consumers_intent_1_id)
            expect(link_rows[0][:link_content]).to eq(link_content.to_json)
            expect(db[:links].first[:created_at].to_i).to be &gt;= before.to_i
            expect(db[:links].first[:created_at].to_i).to be &lt;= after.to_i

            expect(link_rows[1][:name]).to eq(&#39;proxied_http_endpoint&#39;)
            expect(link_rows[1][:link_provider_intent_id]).to be_nil
            expect(link_rows[1][:link_consumer_intent_id]).to eq(link_consumers_intent_1_id)
            expect(link_rows[1][:link_content]).to eq(link_content2.to_json)
            expect(db[:links].first[:created_at].to_i).to be &gt;= before.to_i
            expect(db[:links].first[:created_at].to_i).to be &lt;= after.to_i
          end

          it &#39;will create one instance_link per consuming instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L416" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L568" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L676" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(link migration)::context(when multiple instances contain the same link key)::context(and contents are different)::it#will create one instance_link per consuming instance has a flog score of 83</span>          </div>  </li></ol>
            DBSpecHelper.migrate(migration_file)
            expect(db[:instances_links].count).to eq(2)

            dataset = db[:instances_links].all
            expect(dataset[0][:instance_id]).to eq(22)
            expect(dataset[0][:link_id]).to eq(1)
            expect(dataset[0][:serial_id]).to eq(0)

            expect(dataset[1][:instance_id]).to eq(23)
            expect(dataset[1][:link_id]).to eq(2)
            expect(dataset[1][:serial_id]).to eq(0)
          end
        end
      end
    end

    context &#39;verify all unique constraints&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context#verify all unique constraints has a flog score of 32</span>          </div>  </li></ol>
      let(:link_spec_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L47" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L694" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          &#39;provider_instance_group_1&#39;: {
            &#39;provider_job_1&#39;: {
              &#39;link_name_1&#39;: {
                &#39;link_type_1&#39;: {&#39;my_val&#39;: &#39;hello&#39;}
              },
              &#39;link_name_2&#39;: {
                &#39;link_type_2&#39;: {&#39;foo&#39;: &#39;bar&#39;}
              }
            }
          },
          &#39;provider_instance_group_2&#39;: {
            &#39;provider_job_1&#39;: {
              &#39;link_name_3&#39;: {
                &#39;link_type_1&#39;: {&#39;bar&#39;: &#39;baz&#39;}
              },
            },
            &#39;provider_job_2&#39;: {
              &#39;link_name_4&#39;: {
                &#39;link_type_2&#39;: {&#39;foobar&#39;: &#39;bazbaz&#39;}
              }
            }
          }
        }
      end
      let(:instance_spec_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L127" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L272" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L720" class="js-smell-location">2</a>                  </div>  </li></ol>
        {
          &quot;deployment&quot;: &quot;fake-deployment&quot;,
          &quot;name&quot;: &quot;provider_instance_group_1&quot;,
          &quot;job&quot;: {
            &quot;name&quot;: &quot;provider_instance_group_1&quot;,
            &quot;templates&quot;: [
              {
                &quot;name&quot;: &quot;http_proxy_with_requires&quot;,
                &quot;version&quot;: &quot;760680c4a796a2ffca24026c561c06dd5bdef6b3&quot;,
                &quot;sha1&quot;: &quot;fdf0d8acd01055f32fb28caee3b5a2d383848e53&quot;,
                &quot;blobstore_id&quot;: &quot;e6a084ab-541c-4f9e-8132-573627bded5a&quot;,
                &quot;logs&quot;: []
              }
            ]
          },
          &quot;links&quot;: {
            &quot;http_proxy_with_requires&quot;: {
              &quot;proxied_http_endpoint&quot;: {
                &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
                &quot;instances&quot;: [
                  {
                    &quot;name&quot;: &quot;provider_deployment_node&quot;,
                    &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                    &quot;index&quot;: 0,
                    &quot;bootstrap&quot;: true,
                    &quot;az&quot;: &quot;z1&quot;,
                    &quot;address&quot;: &quot;192.168.1.10&quot;
                  }
                ],
                &quot;properties&quot;: {
                  &quot;listen_port&quot;: 15672,
                  &quot;name_space&quot;: {
                    &quot;fibonacci&quot;: &quot;((fibonacci_placeholder))&quot;,
                    &quot;prop_a&quot;: &quot;default&quot;
                  }
                }
              },
              &quot;proxied_http_endpoint2&quot;: {
                &quot;instance_group&quot;: &quot;provider_deployment_node&quot;,
                &quot;instances&quot;: [
                  {
                    &quot;name&quot;: &quot;provider_deployment_node&quot;,
                    &quot;id&quot;: &quot;19dea4c6-c25f-478c-893e-db29ba7042b5&quot;,
                    &quot;index&quot;: 0,
                    &quot;bootstrap&quot;: true,
                    &quot;az&quot;: &quot;z1&quot;,
                    &quot;address&quot;: &quot;192.168.1.10&quot;
                  }
                ],
                &quot;properties&quot;: {
                  &quot;a&quot;: 1,
                  &quot;name_space&quot;: {
                    &quot;asdf&quot;: &quot;((fibonacci_placeholder))&quot;,
                    &quot;dbxcv&quot;: &quot;default&quot;
                  }
                }
              }
            }
          }
        }
      end
      before do
        db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 42, link_spec_json: link_spec_json.to_json}
        db[:variable_sets] &lt;&lt; {id: 1, deployment_id: 42, created_at: Time.now}
        db[:instances] &lt;&lt; {
          job: &#39;provider_instance_group_1&#39;,
          id: 22,
          index: 0,
          deployment_id: 42,
          state: &quot;started&quot;,
          variable_set_id: 1,
          spec_json: instance_spec_json.to_json
        }
        DBSpecHelper.migrate(migration_file)
      end

      context &#39;link_providers table&#39; do
        context &#39;when all constraint columns are the same&#39; do
          it &#39;should raise an error&#39; do
            expect { db[:link_providers] &lt;&lt; {instance_group: &#39;provider_instance_group_1&#39;, deployment_id: 42, type: &#39;job&#39;, name: &#39;provider_job_1&#39;} }.to raise_error<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L800" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L806" class="js-smell-location">1</a>                  </div>  </li></ol>
          end
        end

        context &#39;when existing record gets updated to violate constraint&#39; do
          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(verify all unique constraints)::context(link_providers table)::context(when existing record gets updated to violate constraint)::it#should raise an error has a flog score of 25</span>          </div>  </li></ol>
            expect { db[:link_providers] &lt;&lt; {instance_group: &#39;provider_instance_group_2&#39;, deployment_id: 42, type: &#39;test&#39;, name: &#39;provider_job_1&#39;} }.to_not raise_error<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L800" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L806" class="js-smell-location">1</a>                  </div>  </li></ol>
            link_provider = db[:link_providers].where(instance_group: &#39;provider_instance_group_2&#39;, deployment_id: 42, type: &#39;test&#39;, name: &#39;provider_job_1&#39;)
            expect { link_provider.update(type: &#39;job&#39;) }.to raise_error
          end
        end
      end

      context &#39;link_consumers table&#39; do
        context &#39;when all constraint columns are the same&#39; do
          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(verify all unique constraints)::context(link_consumers table)::context(when all constraint columns are the same)::it#should raise an error has a flog score of 26</span>          </div>  </li></ol>
            link_consumer = db[:link_consumers].first
            expect { db[:link_consumers] &lt;&lt; {deployment_id: link_consumer[:deployment_id], instance_group: link_consumer[:instance_group], name: link_consumer[:name], type: link_consumer[:type]} }.to raise_error
          end
        end

        context &#39;when existing record gets updated to violate constraint&#39; do
          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(verify all unique constraints)::context(link_consumers table)::context(when existing record gets updated to violate constraint)::it#should raise an error has a flog score of 39</span>          </div>  </li></ol>
            original_link_consumer = db[:link_consumers].first
            expect { db[:link_consumers] &lt;&lt; {deployment_id: original_link_consumer[:deployment_id], instance_group: original_link_consumer[:instance_group], name: &#39;test&#39;, type: &#39;job&#39;} }.to_not raise_error<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L824" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L825" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L878" class="js-smell-location">2</a>                  </div>  </li></ol>
            new_link_consumer = db[:link_consumers].where(deployment_id: original_link_consumer[:deployment_id], instance_group: original_link_consumer[:instance_group], name: &#39;test&#39;, type: &#39;job&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L824" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L825" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L878" class="js-smell-location">2</a>                  </div>  </li></ol>
            expect { new_link_consumer.update(name: original_link_consumer[:name]) }.to raise_error
          end
        end
      end

      context &#39;link_provider_intents table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L831" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L849" class="js-smell-location">1</a>                  </div>  </li></ol>
        context &#39;when all constraint columns are the same&#39; do
          it &#39;should raise an error&#39; do
            link_provider_intent = db[:link_provider_intents].first
            expect { db[:link_provider_intents] &lt;&lt; {link_provider_id: link_provider_intent[:link_provider_id], original_name: link_provider_intent[:original_name], type: &#39;job&#39;} }.to raise_error
          end
        end

        context &#39;when existing record gets updated to violate constraint&#39; do
          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(verify all unique constraints)::context(link_provider_intents table)::context(when existing record gets updated to violate constraint)::it#should raise an error has a flog score of 35</span>          </div>  </li></ol>
            original_link_provider_intents = db[:link_provider_intents].first
            expect { db[:link_provider_intents] &lt;&lt; {link_provider_id: original_link_provider_intents[:link_provider_id], original_name: &#39;test-original-name&#39;, type: &#39;test&#39;} }.to_not raise_error
            new_link_provider_intents = db[:link_provider_intents].where(link_provider_id: original_link_provider_intents[:link_provider_id], original_name: &#39;test-original-name&#39;, type: &#39;test&#39;)
            expect { new_link_provider_intents.update(original_name: original_link_provider_intents[:name]) }.to raise_error
          end
        end
      end

      context &#39;link_consumer_intents table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L831" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L849" class="js-smell-location">1</a>                  </div>  </li></ol>
        context &#39;when all constraint columns are the same&#39; do
          it &#39;should raise an error&#39; do
            link_consumer_intent = db[:link_consumer_intents].first
            expect { db[:link_consumer_intents] &lt;&lt; {link_consumer_id: link_consumer_intent[:link_consumer_id], original_name: link_consumer_intent[:original_name], type: &#39;job&#39;} }.to raise_error
          end
        end

        context &#39;when existing record gets updated to violate constraint&#39; do
          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(verify all unique constraints)::context(link_consumer_intents table)::context(when existing record gets updated to violate constraint)::it#should raise an error has a flog score of 35</span>          </div>  </li></ol>
            original_link_consumer_intents = db[:link_consumer_intents].first
            expect { db[:link_consumer_intents] &lt;&lt; {link_consumer_id: original_link_consumer_intents[:link_consumer_id], original_name: &#39;test-original-name&#39;, type: &#39;job&#39;} }.to_not raise_error
            new_link_consumer_intents = db[:link_consumer_intents].where(link_consumer_id: original_link_consumer_intents[:link_consumer_id], original_name: &#39;test-original-name&#39;, type: &#39;job&#39;)
            expect { new_link_consumer_intents.update(original_name: original_link_consumer_intents[:name]) }.to raise_error
          end
        end
      end

      context &#39;instances_links table&#39; do
        context &#39;when all constraint columns are the same&#39; do
          it &#39;should raise an error&#39; do
            instance_link = db[:instances_links].first
            expect { db[:instances_links] &lt;&lt; {link_id: instance_link[:link_id], instance_id: instance_link[:instance_id]} }.to raise_error<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L871" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L882" class="js-smell-location">1</a>                  </div>  </li></ol>
          end
        end

        context &#39;when existing record gets updated to violate constraint&#39; do
          it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(During migrations)::context(verify all unique constraints)::context(instances_links table)::context(when existing record gets updated to violate constraint)::it#should raise an error has a flog score of 60</span>          </div>  </li></ol>
            existing_link = db[:links].first
            db[:links] &lt;&lt; {link_provider_intent_id: existing_link[:link_provider_intent_id], link_consumer_intent_id: existing_link[:link_consumer_intent_id], name: &#39;test&#39;, link_content: &#39;test&#39;}<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L824" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L825" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L878" class="js-smell-location">2</a>                  </div>  </li></ol>
            new_link = db[:links].where(name: &#39;test&#39;, link_content: &#39;test&#39;).first

            original_instances_link = db[:instances_links].first
            expect { db[:instances_links] &lt;&lt; {link_id: new_link[:id], instance_id: original_instances_link[:instance_id]} }.to_not raise_error<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L871" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L882" class="js-smell-location">1</a>                  </div>  </li></ol>
            new_instances_link = db[:instances_links].where(link_id: new_link[:id], instance_id: original_instances_link[:instance_id])
            expect { new_instances_link.update(link_id: original_instances_link[:link_id]) }.to raise_error
          end
        end
      end
    end

    context &#39;verify unique constraints are named&#39; do
      before do
        db[:deployments] &lt;&lt; {name: &#39;fake-deployment&#39;, id: 42}
        DBSpecHelper.migrate(migration_file)
      end

      context &#39;link_providers table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L896" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L903" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L910" class="js-smell-location">2</a>                  <a href="20171113000000_add_links_api_spec.html#L917" class="js-smell-location">3</a>                  <a href="20171113000000_add_links_api_spec.html#L924" class="js-smell-location">4</a>                  </div>  </li></ol>
        it &#39;has named unique constraint&#39; do
          indices = db.indexes(:link_providers)
          expect(indices.has_key?(:link_providers_constraint)).to be_truthy
        end
      end

      context &#39;link_provider_intents table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L896" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L903" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L910" class="js-smell-location">2</a>                  <a href="20171113000000_add_links_api_spec.html#L917" class="js-smell-location">3</a>                  <a href="20171113000000_add_links_api_spec.html#L924" class="js-smell-location">4</a>                  </div>  </li></ol>
        it &#39;has named unique constraint&#39; do
          indices = db.indexes(:link_provider_intents)
          expect(indices.has_key?(:link_provider_intents_constraint)).to be_truthy
        end
      end

      context &#39;link_consumers table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L896" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L903" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L910" class="js-smell-location">2</a>                  <a href="20171113000000_add_links_api_spec.html#L917" class="js-smell-location">3</a>                  <a href="20171113000000_add_links_api_spec.html#L924" class="js-smell-location">4</a>                  </div>  </li></ol>
        it &#39;has named unique constraint&#39; do
          indices = db.indexes(:link_consumers)
          expect(indices.has_key?(:link_consumers_constraint)).to be_truthy
        end
      end

      context &#39;link_consumer_intents table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L896" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L903" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L910" class="js-smell-location">2</a>                  <a href="20171113000000_add_links_api_spec.html#L917" class="js-smell-location">3</a>                  <a href="20171113000000_add_links_api_spec.html#L924" class="js-smell-location">4</a>                  </div>  </li></ol>
        it &#39;has named unique constraint&#39; do
          indices = db.indexes(:link_consumer_intents)
          expect(indices.has_key?(:link_consumer_intents_constraint)).to be_truthy
        end
      end

      context &#39;instances_links table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="20171113000000_add_links_api_spec.html#L896" class="js-smell-location">0</a>                  <a href="20171113000000_add_links_api_spec.html#L903" class="js-smell-location">1</a>                  <a href="20171113000000_add_links_api_spec.html#L910" class="js-smell-location">2</a>                  <a href="20171113000000_add_links_api_spec.html#L917" class="js-smell-location">3</a>                  <a href="20171113000000_add_links_api_spec.html#L924" class="js-smell-location">4</a>                  </div>  </li></ol>
        it &#39;has named unique constraint&#39; do
          indices = db.indexes(:instances_links)
          expect(indices.has_key?(:instances_links_constraint)).to be_truthy
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../../../assets/javascripts/application.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
