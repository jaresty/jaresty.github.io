<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 10:12:42 -0700'>2018-06-22 10:12:42 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit /</small> config_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">975</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">86</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1588.76</span><small> complexity</small></div>
              <div><span class="metric">785</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                26
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

#
# This supplants the config_old_spec.rb behavior. We are
# moving class behavior to instance behavior.
#

describe Bosh::Director::Config do
  let(:test_config) { YAML.load(spec_asset(&#39;test-director-config.yml&#39;)) }
  let(:temp_dir) { Dir.mktmpdir }
  let(:base_config) do
    blobstore_dir = File.join(temp_dir, &#39;blobstore&#39;)
    FileUtils.mkdir_p(blobstore_dir)

    config = YAML.load(spec_asset(&#39;test-director-config.yml&#39;))
    config[&#39;dir&#39;] = temp_dir
    config[&#39;blobstore&#39;] = {
        &#39;provider&#39; =&gt; &#39;local&#39;,
        &#39;options&#39; =&gt; {
            &#39;blobstore_path&#39; =&gt; blobstore_dir,
        }
    }
    config[&#39;snapshots&#39;][&#39;enabled&#39;] = true
    config
  end

  before do
    allow(File).to receive(:read).and_call_original
    allow(File).to receive(:read).with(&#39;/path/to/server_ca_path&#39;).and_return(&#39;whatever makes you happy&#39;)
  end

  describe &#39;initialization&#39; do
    it &#39;loads config from a yaml file&#39; do
      config = described_class.load_file(asset(&#39;test-director-config.yml&#39;))
      expect(config.name).to eq(&#39;Test Director&#39;)
    end

    it &#39;loads config from a hash&#39; do
      config = described_class.load_hash(test_config)
      expect(config.name).to eq(&#39;Test Director&#39;)
    end
  end

  describe &#39;director ips&#39; do
    before do
      allow(Socket).to receive(:ip_address_list).and_return([
        instance_double(Addrinfo, ip_address: &#39;127.0.0.1&#39;,   ip?: true, ipv4_loopback?: true,  ipv6_loopback?: false, ipv6_linklocal?: false),
        instance_double(Addrinfo, ip_address: &#39;10.10.0.6&#39;,   ip?: true, ipv4_loopback?: false, ipv6_loopback?: false, ipv6_linklocal?: false),
        instance_double(Addrinfo, ip_address: &#39;10.11.0.16&#39;,  ip?: true, ipv4_loopback?: false, ipv6_loopback?: false, ipv6_linklocal?: false),
        instance_double(Addrinfo, ip_address: &#39;::1&#39;,         ip?: true, ipv4_loopback?: false, ipv6_loopback?: true,  ipv6_linklocal?: false),
        instance_double(Addrinfo, ip_address: &#39;fe80::%eth0&#39;, ip?: true, ipv4_loopback?: false, ipv6_loopback?: false, ipv6_linklocal?: true),
        instance_double(Addrinfo, ip_address: &#39;fd7a::&#39;,      ip?: true, ipv4_loopback?: false, ipv6_loopback?: false, ipv6_linklocal?: false),
      ])
    end

    it &#39;should select the non-loopback ips off of the the Socket class&#39; do
      described_class.configure(test_config)
      expect(described_class.director_ips).to eq([&#39;10.10.0.6&#39;, &#39;10.11.0.16&#39;, &#39;fd7a::&#39;])
    end
  end

  describe &#39;#max_create_vm_retries&#39; do
    context &#39;when hash has value set&#39; do
      it &#39;returns the configuration value&#39; do
        test_config[&#39;max_vm_create_tries&#39;] = 3
        described_class.configure(test_config)
        expect(described_class.max_vm_create_tries).to eq(3)
      end
    end

    context &#39;when hash does not have value set&#39; do
      it &#39;returns default value of five as per previous behavior&#39; do
        # our fixture does not have this set so this is a no-op
        # i&#39;m doing this because i want to be more explicit
        test_config.delete(&#39;max_vm_create_tries&#39;)
        described_class.configure(test_config)
        expect(described_class.max_vm_create_tries).to eq(5)
      end
    end

    context &#39;when hash contains a non integral value&#39; do
      it &#39;raises an error&#39; do
        test_config[&#39;max_vm_create_tries&#39;] = &#39;bad number&#39;
        expect{
          described_class.configure(test_config)
        }.to raise_error(ArgumentError)
      end
    end
  end

  describe &#39;#flush_arp&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L91" class="js-smell-location">0</a>                  <a href="config_spec.html#L134" class="js-smell-location">1</a>                  </div>  </li></ol>
    context &#39;when hash has value set&#39; do
      it &#39;returns the configuration value&#39; do
        test_config[&#39;flush_arp&#39;] = true
        described_class.configure(test_config)
        expect(described_class.flush_arp).to eq(true)
      end
    end

    context &#39;when hash does not have value set&#39; do
      it &#39;returns default value of false&#39; do
        # our fixture does not have this set so this is a no-op
        # i&#39;m doing this because the test we copied did it
        test_config.delete(&#39;flush_arp&#39;)
        described_class.configure(test_config)
        expect(described_class.flush_arp).to eq(false)
      end
    end
  end

  describe &#39;#local_dns&#39; do
    context &#39;when hash has value set&#39; do
      it &#39;returns the configuration value&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#local_dns)::context(when hash has value set)::it#returns the configuration value has a flog score of 43</span>          </div>  </li></ol>
        test_config[&#39;local_dns&#39;][&#39;enabled&#39;] = true
        test_config[&#39;local_dns&#39;][&#39;include_index&#39;] = true
        test_config[&#39;local_dns&#39;][&#39;use_dns_addresses&#39;] = true
        described_class.configure(test_config)
        expect(described_class.local_dns_enabled?).to eq(true)
        expect(described_class.local_dns_include_index?).to eq(true)
        expect(described_class.local_dns_use_dns_addresses?).to eq(true)
      end
    end

    context &#39;when hash does not have value set&#39; do
      it &#39;returns default value of false&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#local_dns)::context(when hash does not have value set)::it#returns default value of false has a flog score of 33</span>          </div>  </li></ol>
        described_class.configure(test_config)
        expect(described_class.local_dns_enabled?).to eq(false)
        expect(described_class.local_dns_include_index?).to eq(false)
        expect(described_class.local_dns_use_dns_addresses?).to eq(false)
      end
    end
  end

  describe &#39;#keep_unreachable_vms&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L91" class="js-smell-location">0</a>                  <a href="config_spec.html#L134" class="js-smell-location">1</a>                  </div>  </li></ol>
    context &#39;when hash has value set&#39; do
      it &#39;returns the configuration value&#39; do
        test_config[&#39;keep_unreachable_vms&#39;] = true
        described_class.configure(test_config)
        expect(described_class.keep_unreachable_vms).to eq(true)
      end
    end

    context &#39;when hash does not have value set&#39; do
      it &#39;returns default value of false&#39; do
        test_config.delete(&#39;keep_unreachable_vms&#39;)
        described_class.configure(test_config)
        expect(described_class.keep_unreachable_vms).to eq(false)
      end
    end
  end

  describe &#39;#cpi_task_log&#39; do
    before do
      described_class.configure(test_config)
      described_class.cloud_options[&#39;properties&#39;][&#39;cpi_log&#39;] = &#39;fake-cpi-log&#39;
    end

    it &#39;returns cpi task log&#39; do
      expect(described_class.cpi_task_log).to eq(&#39;fake-cpi-log&#39;)
    end
  end

  describe &#39;#configure&#39; do
    context &#39;logger&#39; do
      let(:log_dir) { Dir.mktmpdir }
      let(:log_file) { File.join(log_dir,&#39;logfile&#39;) }
      after { FileUtils.rm_rf(log_dir) }

      context &#39;when the config specifies a file logger&#39; do
        before { test_config[&#39;logging&#39;][&#39;file&#39;] = &#39;fake-file&#39; }

        it &#39;configures the logger with a file appender&#39; do
          appender = Logging::Appender.new(&#39;file&#39;)
          expect(Logging.appenders).to receive(:file).with(
            &#39;Director&#39;,
            hash_including(filename: &#39;fake-file&#39;)
          ).and_return(appender)
          described_class.configure(test_config)
        end
      end

      it &#39;filters out log message that are SELECT NULL&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L182" class="js-smell-location">0</a>                  <a href="config_spec.html#L199" class="js-smell-location">1</a>                  <a href="config_spec.html#L218" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#configure)::context(logger)::it#filters out log message that are SELECT NULL has a flog score of 56</span>          </div>  </li></ol>
        test_config[&#39;logging&#39;][&#39;file&#39;] = log_file
        test_config[&#39;logging&#39;][&#39;level&#39;] = &#39;debug&#39;

        described_class.configure(test_config)

        described_class.logger.debug(&#39;before&#39;)
        described_class.logger.debug(&#39;(10.01s) (conn: 123456789) SELECT NULL&#39;)
        described_class.logger.debug(&#39;after&#39;)

        log_contents = File.read(log_file)

        expect(log_contents).to include(&#39;before&#39;)
        expect(log_contents).to include(&#39;after&#39;)
        expect(log_contents).not_to include(&#39;SELECT NULL&#39;)
      end

      it &#39;redacts log messages containing INSERT queries&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L182" class="js-smell-location">0</a>                  <a href="config_spec.html#L199" class="js-smell-location">1</a>                  <a href="config_spec.html#L218" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#configure)::context(logger)::it#redacts log messages containing INSERT queries has a flog score of 56</span>          </div>  </li></ol>
        test_config[&#39;logging&#39;][&#39;file&#39;] = log_file
        test_config[&#39;logging&#39;][&#39;level&#39;] = &#39;debug&#39;

        described_class.configure(test_config)

        described_class.logger.debug(&#39;before&#39;)
        described_class.logger.debug(
          %((10.01s) (conn: 123456789) INSERT INTO &quot;potatoface&quot; (&quot;diggity&quot;, &quot;column2&quot;) VALUES (&#39;alice&#39;, &#39;bob&#39;)),
        )
        described_class.logger.debug(&#39;after&#39;)

        log_contents = File.read(log_file)

        expect(log_contents).to include(&#39;before&#39;)
        expect(log_contents).to include(&#39;after&#39;)
        expect(log_contents).to include(&#39;INSERT INTO &quot;potatoface&quot; &lt;redacted&gt;&#39;)
      end

      it &#39;redacts log messages containing UPDATE queries&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L182" class="js-smell-location">0</a>                  <a href="config_spec.html#L199" class="js-smell-location">1</a>                  <a href="config_spec.html#L218" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#configure)::context(logger)::it#redacts log messages containing UPDATE queries has a flog score of 56</span>          </div>  </li></ol>
        test_config[&#39;logging&#39;][&#39;file&#39;] = log_file
        test_config[&#39;logging&#39;][&#39;level&#39;] = &#39;debug&#39;

        described_class.configure(test_config)

        described_class.logger.debug(&#39;before&#39;)
        described_class.logger.debug(
          %((10.01s) (conn: 123456789) UPDATE &quot;potatoface&quot; SET &quot;diggity&quot; = &#39;bob&#39;, &quot;column2&quot; = &#39;alice&#39;, &#39;bob&#39;),
        )
        described_class.logger.debug(&#39;after&#39;)

        log_contents = File.read(log_file)

        expect(log_contents).to include(&#39;before&#39;)
        expect(log_contents).to include(&#39;after&#39;)
        expect(log_contents).to include(&#39;UPDATE &quot;potatoface&quot; &lt;redacted&gt;&#39;)
      end
    end

    context &#39;when agent env specified&#39; do
      let(:expected_agent_env) do
        {
          &#39;blobstores&#39; =&gt; [
            {
              &#39;provider&#39; =&gt; &#39;local&#39;,
              &#39;options&#39; =&gt; {
                &#39;blobstore_path&#39; =&gt; &#39;/path/to/blobstore&#39;
              }
            },
            {
              &#39;provider&#39; =&gt; &#39;local&#39;,
              &#39;options&#39; =&gt; {
                &#39;blobstore_path&#39; =&gt; &#39;/path/to/blobstore&#39;
              }
            }
          ]
        }
      end

      it &#39;parses agent env correctly&#39; do
        described_class.configure(base_config)
        expect(described_class.agent_env).to eq(expected_agent_env)
      end
    end

    context &#39;config server&#39; do
      context &#39;when enabled&#39; do
        before {
          test_config[&#39;config_server&#39;] = {
              &#39;enabled&#39; =&gt; true,
              &#39;url&#39; =&gt; &#39;https://127.0.0.1:8080&#39;,
              &#39;ca_cert_path&#39; =&gt; &#39;/var/vcap/jobs/director/config/config_server_ca.cert&#39;
          }

          test_config[&#39;config_server&#39;][&#39;uaa&#39;] = {
              &#39;url&#39; =&gt; &#39;fake-uaa-url&#39;,
              &#39;client_id&#39; =&gt; &#39;fake-client-id&#39;,
              &#39;client_secret&#39; =&gt; &#39;fake-client-secret&#39;,
              &#39;ca_cert_path&#39; =&gt; &#39;fake-uaa-ca-cert-path&#39;
          }
        }

        it &#39;should have parsed out config server values&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#configure)::context(config server)::context(when enabled)::it#should have parsed out config server values has a flog score of 92</span>          </div>  </li></ol>
          described_class.configure(test_config)

          expect(described_class.config_server[&#39;url&#39;]).to eq(&#39;https://127.0.0.1:8080&#39;)
          expect(described_class.config_server[&#39;ca_cert_path&#39;]).to eq(&#39;/var/vcap/jobs/director/config/config_server_ca.cert&#39;)

          expect(described_class.config_server[&#39;uaa&#39;][&#39;url&#39;]).to eq(&#39;fake-uaa-url&#39;)
          expect(described_class.config_server[&#39;uaa&#39;][&#39;client_id&#39;]).to eq(&#39;fake-client-id&#39;)
          expect(described_class.config_server[&#39;uaa&#39;][&#39;client_secret&#39;]).to eq(&#39;fake-client-secret&#39;)
          expect(described_class.config_server[&#39;uaa&#39;][&#39;ca_cert_path&#39;]).to eq(&#39;fake-uaa-ca-cert-path&#39;)
        end

        context &#39;config server urls&#39; do
          it &#39;should return an array of urls&#39; do
            described_class.configure(test_config)
            config = Bosh::Director::Config.new(test_config)
            expect(config.config_server_urls).to eq([&#39;https://127.0.0.1:8080&#39;])
          end
        end

        context &#39;when url is not https&#39; do
          before {
            test_config[&quot;config_server&quot;][&quot;url&quot;] = &quot;http://127.0.0.1:8080&quot;
          }

          it &#39;errors&#39; do
            expect {  described_class.configure(test_config) }.to raise_error(ArgumentError, &#39;Config Server URL should always be https. Currently it is http://127.0.0.1:8080&#39;)
          end
        end
      end

      context &#39;when disabled&#39; do
        before {
          test_config[&quot;config_server_enabled&quot;] = false
        }

        it &#39;should not have parsed out the values&#39; do
          described_class.configure(test_config)

          expect(described_class.config_server).to eq({&quot;enabled&quot;=&gt;false})
        end
      end
    end

    describe &#39;enable_nats_delivered_templates&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L325" class="js-smell-location">0</a>                  <a href="config_spec.html#L584" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &#39;defaults to false&#39; do
        described_class.configure(test_config)
        expect(described_class.enable_nats_delivered_templates).to be_falsey
      end

      context &#39;when explicitly set&#39; do
        context &#39;when set to true&#39; do
          before { test_config[&#39;enable_nats_delivered_templates&#39;] = true }

          it &#39;resolves to true&#39; do
            described_class.configure(test_config)
            expect(described_class.enable_nats_delivered_templates).to be_truthy
          end
        end

        context &#39;when set to false&#39; do
          before { test_config[&#39;enable_nats_delivered_templates&#39;] = false }

          it &#39;resolves to false&#39; do
            described_class.configure(test_config)
            expect(described_class.enable_nats_delivered_templates).to be_falsey
          end
        end
      end
    end

    describe &#39;director version&#39; do
      it &#39;sets the expected version/revision&#39; do
        described_class.configure(test_config)
        expect(described_class.revision).to match /^[0-9a-f]{8}$/
        expect(described_class.version).to eq(&#39;0.0.2&#39;)
      end
    end
  end

  describe &#39;#identity_provider&#39; do
    subject(:config) { Bosh::Director::Config.new(test_config) }
    let(:provider_options) do
      { &#39;blobstore_path&#39; =&gt; blobstore_dir }
    end

    after { FileUtils.rm_rf(temp_dir) }

    describe &#39;authentication configuration&#39; do
      let(:test_config) { base_config.merge({&#39;user_management&#39; =&gt; {&#39;provider&#39; =&gt; provider}}) }

      context &#39;when no user_management config is specified&#39; do
        let(:test_config) { base_config }

        it &#39;uses LocalIdentityProvider&#39; do
          expect(config.identity_provider).to be_a(Bosh::Director::Api::LocalIdentityProvider)
        end
      end

      context &#39;when local provider is supplied&#39; do
        let(:provider) { &#39;local&#39; }

        it &#39;uses LocalIdentityProvider&#39; do
          expect(config.identity_provider).to be_a(Bosh::Director::Api::LocalIdentityProvider)
        end
      end

      context &#39;when a bogus provider is supplied&#39; do
        let(:provider) { &#39;wrong&#39; }

        it &#39;should raise an error&#39; do
          expect { config.identity_provider }.to raise_error(ArgumentError)
        end
      end

      context &#39;when uaa provider is supplied&#39; do
        let(:provider) { &#39;uaa&#39; }
        let(:provider_options) do
          { &#39;symmetric_key&#39; =&gt; &#39;some-key&#39;, &#39;url&#39; =&gt; &#39;some-url&#39; }
        end
        let(:token) { CF::UAA::TokenCoder.new(skey: &#39;some-key&#39;).encode(payload) }
        let(:payload) do
          { &#39;user_name&#39; =&gt; &#39;larry&#39;, &#39;aud&#39; =&gt; [&#39;bosh_cli&#39;], &#39;scope&#39; =&gt; [&#39;bosh.admin&#39;] }
        end
        before { test_config[&#39;user_management&#39;][&#39;uaa&#39;] = provider_options }

        it &#39;creates a UAAIdentityProvider&#39; do
          expect(config.identity_provider).to be_a(Bosh::Director::Api::UAAIdentityProvider)
        end

        it &#39;creates the UAAIdentityProvider with the configured key&#39; do
          request_env = {&#39;HTTP_AUTHORIZATION&#39; =&gt; &quot;bearer #{token}&quot;}
          user = config.identity_provider.get_user(request_env, {})
          expect(user.username).to eq(&#39;larry&#39;)
        end
      end
    end
  end

  describe &#39;#root_domain&#39; do
    context &#39;when no dns_domain is set in config&#39; do
      let(:test_config) { base_config.merge({&#39;dns&#39; =&gt; {}}) }
      it &#39;returns bosh&#39; do
        described_class.configure(test_config)
        expect(described_class.root_domain).to eq(&#39;bosh&#39;)
      end
    end

    context &#39;when dns_domain is set in config&#39; do
      let(:test_config) { base_config.merge({&#39;dns&#39; =&gt; {&#39;domain_name&#39; =&gt; &#39;test-domain-name&#39;}}) }
      it &#39;returns the DNS domain&#39; do
        described_class.configure(test_config)
        expect(described_class.root_domain).to eq(&#39;test-domain-name&#39;)
      end
    end
  end

  describe &#39;#name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L438" class="js-smell-location">0</a>                  <a href="config_spec.html#L454" class="js-smell-location">1</a>                  </div>  </li></ol>
    subject(:config) { Bosh::Director::Config.new(test_config) }

    it &#39;returns the name specified in the config&#39; do
      expect(config.name).to eq(&#39;Test Director&#39;)
    end
  end

  describe &#39;#port&#39; do
    subject(:config) { Bosh::Director::Config.new(test_config) }

    it &#39;returns the port specified in the config&#39; do
      expect(config.port).to eq(8081)
    end
  end

  describe &#39;#version&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L438" class="js-smell-location">0</a>                  <a href="config_spec.html#L454" class="js-smell-location">1</a>                  </div>  </li></ol>
    subject(:config) { Bosh::Director::Config.new(test_config) }

    it &#39;returns the version specified in the config&#39; do
      expect(config.version).to eq(&#39;0.0.2&#39;)
    end
  end

  describe &#39;#agent_wait_timeout&#39; do
    before { Bosh::Director::Config.configure(test_config) }

    it &#39;returns the version specified in the config&#39; do
      expect(Bosh::Director::Config.agent_wait_timeout).to eq(1234)
    end
  end

  describe &#39;#nats_rpc&#39; do
    let(:some_client) { instance_double(Bosh::Director::NatsRpc)}

    before do
      described_class.configure(test_config)
    end

    it &#39;initializes a new nats rpc client with the appropriate params&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#nats_rpc)::it#initializes a new nats rpc client with the appropriate params has a flog score of 48</span>          </div>  </li></ol>
      expect(Bosh::Director::NatsRpc).to receive(:new)
                                           .with(test_config[&#39;mbus&#39;],
                                                 test_config[&#39;nats&#39;][&#39;server_ca_path&#39;],
                                                 test_config[&#39;nats&#39;][&#39;client_private_key_path&#39;],
                                                 test_config[&#39;nats&#39;][&#39;client_certificate_path&#39;])
                                           .and_return(some_client)
      expect(described_class.nats_rpc).to eq(some_client)
    end
  end

  describe &#39;nats&#39; do
    before do
      described_class.configure(test_config)
    end

    it &#39;should return nats mbus url&#39; do
      expect(described_class.nats_uri).to eq(&#39;nats://some-user:some-pass@some-nats-uri:1234&#39;)
    end

    context &#39;when nats_ca is specified&#39; do
      it &#39;returns non-nil&#39; do
        expect(described_class.nats_server_ca).to eq(&quot;whatever makes you happy&quot;)
      end
    end

    context &#39;when nats_tls is specified&#39; do
      context &#39;when ca certificate is specified&#39; do
        it &#39;returns non-nil&#39; do
          expect(described_class.nats_client_ca_certificate_path).to eq(&quot;/path/to/client_ca_certificate_path&quot;)
        end
      end
      context &#39;when ca private_key is specified&#39; do
        it &#39;returns non-nil&#39; do
          expect(described_class.nats_client_ca_private_key_path).to eq(&quot;/path/to/client_ca_private_key_path&quot;)
        end
      end
      context &#39;when private_key is specified&#39; do
        it &#39;returns non-nil&#39; do
          expect(described_class.nats_client_private_key_path).to eq(&quot;/path/to/director_private_key_path&quot;)
        end
      end
      context &#39;when certificate is specified&#39; do
        it &#39;returns non-nil&#39; do
          expect(described_class.nats_client_certificate_path).to eq(&quot;/path/to/director_certificate_path&quot;)
        end
      end
    end
  end

  describe &#39;log_director_start_event&#39; do
    it &#39;stores an event&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(log_director_start_event)::it#stores an event has a flog score of 61</span>          </div>  </li></ol>
      described_class.configure(test_config)

      expect {
        described_class.log_director_start_event(&#39;custom-type&#39;, &#39;custom-name&#39;, {&#39;custom&#39; =&gt; &#39;context&#39;})
      }.to change {
        Bosh::Director::Models::Event.count
      }.from(0).to(1)

      expect(Bosh::Director::Models::Event.count).to eq(1)
      event = Bosh::Director::Models::Event.first
      expect(event.user).to eq(&#39;_director&#39;)
      expect(event.action).to eq(&#39;start&#39;)
      expect(event.object_type).to eq(&#39;custom-type&#39;)
      expect(event.object_name).to eq(&#39;custom-name&#39;)
      expect(event.context).to eq({&#39;custom&#39; =&gt; &#39;context&#39;})
    end
  end  

  context &#39;multiple digest&#39; do
    context &#39;when verify multidigest is provided&#39; do
      it &#39;allows access to multidigest path&#39; do
        described_class.configure(base_config)
        expect(described_class.verify_multidigest_path).to eq(&#39;/some/path&#39;)
      end
    end

    context &#39;when verify multidigest is not provided&#39; do
      before do
        base_config[&#39;verify_multidigest_path&#39;] = nil
      end

      it &#39;raises an error&#39; do
        expect{ described_class.configure(base_config) }.to raise_error(ArgumentError)
      end
    end
  end

  context &#39;when director starts&#39; do
    it &#39;stores start event&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>context(when director starts)::it#stores start event has a flog score of 67</span>          </div>  </li></ol>
      allow(SecureRandom).to receive(:uuid).and_return(&#39;director-uuid&#39;)
      described_class.configure(test_config)
      expect {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L570" class="js-smell-location">0</a>                  <a href="jobs/delete_deployment_spec.html#L48" class="js-smell-location">1</a>                  </div>  </li></ol>
        described_class.log_director_start
      }.to change {
        Bosh::Director::Models::Event.count }.from(0).to(1)
      expect(Bosh::Director::Models::Event.count).to eq(1)
      event = Bosh::Director::Models::Event.first
      expect(event.user).to eq(&#39;_director&#39;)
      expect(event.action).to eq(&#39;start&#39;)
      expect(event.object_type).to eq(&#39;director&#39;)
      expect(event.object_name).to eq(&#39;director-uuid&#39;)
      expect(event.context).to eq({&#39;version&#39; =&gt; &#39;0.0.2&#39;})
    end
  end

  describe &#39;enable_cpi_resize_disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L325" class="js-smell-location">0</a>                  <a href="config_spec.html#L584" class="js-smell-location">1</a>                  </div>  </li></ol>
    it &#39;defaults to false&#39; do
      described_class.configure(test_config)
      expect(described_class.enable_cpi_resize_disk).to be_falsey
    end

    context &#39;when explicitly set&#39; do
      context &#39;when set to true&#39; do
        before { test_config[&#39;enable_cpi_resize_disk&#39;] = true }

        it &#39;resolves to true&#39; do
          described_class.configure(test_config)
          expect(described_class.enable_cpi_resize_disk).to be_truthy
        end
      end

      context &#39;when set to false&#39; do
        before { test_config[&#39;enable_cpi_resize_disk&#39;] = false }

        it &#39;resolves to false&#39; do
          described_class.configure(test_config)
          expect(described_class.enable_cpi_resize_disk).to be_falsey
        end
      end
    end
  end

  describe &#39;#configure_db&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##configure_db has a flog score of 48</span>          </div>  </li></ol>
    let(:database) { instance_double(Sequel::Database) }

    before do
      allow(Sequel).to receive(:connect).and_return(database)
      allow(database).to receive(:extension)
      allow(database).to receive_message_chain(:pool, :connection_validation_timeout=)
      allow(database).to receive(:logger=)
      allow(database).to receive(:sql_log_level=)
      allow(database).to receive(:log_connection_info=)
    end

    context &#39;when db config has empty entries&#39; do
      it &#39;prunes empty entries before passing it to sequel&#39; do
        parameters = {
          &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
          &#39;port&#39; =&gt; 5432,
          &#39;nil_value&#39; =&gt; nil,
          &#39;empty_value&#39; =&gt; &#39;&#39;
        }

        expect(Sequel).to receive(:connect).with({&#39;host&#39; =&gt; &#39;127.0.0.1&#39;, &#39;port&#39; =&gt; 5432}).and_return(database)
        described_class.configure_db(parameters)
      end
    end

    context &#39;when connection_options is defined&#39; do
      it &#39;will add all entries to top level config&#39; do
        parameters = {
          &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
          &#39;port&#39; =&gt; 5432,
          &#39;connection_options&#39; =&gt; {
            &#39;max_connections&#39; =&gt; 100,
            &#39;foo&#39; =&gt; &#39;bar&#39;
          }
        }

        expect(Sequel).to receive(:connect).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L648" class="js-smell-location">0</a>                  <a href="config_spec.html#L667" class="js-smell-location">1</a>                  </div>  </li></ol>
          {&#39;host&#39; =&gt; &#39;127.0.0.1&#39;, &#39;port&#39; =&gt; 5432, &#39;max_connections&#39; =&gt;100, &#39;foo&#39; =&gt; &#39;bar&#39;}
        ).and_return(database)

        described_class.configure_db(parameters)
      end

      it &#39;will overide default options&#39; do
        parameters = {
          &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
          &#39;port&#39; =&gt; 5432,
          &#39;connection_options&#39; =&gt; {
            &#39;host&#39; =&gt; &#39;rds-somewhere&#39;,
            &#39;port&#39; =&gt; 7000,
            &#39;max_connections&#39; =&gt; 100,
            &#39;foo&#39; =&gt; &#39;bar&#39;
          }
        }

        expect(Sequel).to receive(:connect).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L648" class="js-smell-location">0</a>                  <a href="config_spec.html#L667" class="js-smell-location">1</a>                  </div>  </li></ol>
          {&#39;host&#39; =&gt; &#39;rds-somewhere&#39;, &#39;port&#39; =&gt; 7000, &#39;max_connections&#39; =&gt;100, &#39;foo&#39; =&gt; &#39;bar&#39;}
        ).and_return(database)

        described_class.configure_db(parameters)
      end
    end

    context &#39;when TLS is requested&#39; do
      shared_examples_for &#39;db connects with custom parameters&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L676" class="js-smell-location">0</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L220" class="js-smell-location">1</a>                  </div>  </li></ol>
        it &#39;connects with TLS enabled for database&#39; do
          expect(Sequel).to receive(:connect).with(connection_parameters).and_return(database)
          described_class.configure_db(config)
        end
      end

      context &#39;postgres&#39; do
        it_behaves_like &#39;db connects with custom parameters&#39; do
            let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L685" class="js-smell-location">0</a>                  <a href="config_spec.html#L829" class="js-smell-location">1</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L228" class="js-smell-location">2</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L371" class="js-smell-location">3</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;tls&#39; =&gt; {
                  &#39;enabled&#39; =&gt; true,
                  &#39;cert&#39; =&gt; {
                    &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                    &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                    &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                  },
                  &#39;bosh_internal&#39; =&gt; {
                    &#39;ca_provided&#39; =&gt; true,
                    &#39;mutual_tls_enabled&#39; =&gt; false,
                  }
                }
              }
            end

            let(:connection_parameters) do
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;sslmode&#39; =&gt; &#39;verify-full&#39;,
                &#39;sslrootcert&#39; =&gt; &#39;/path/to/root/ca&#39;,
              }
            end
        end

        context &#39;when user defines TLS options in connection_options&#39; do
          it_behaves_like &#39;db connects with custom parameters&#39; do
            let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L718" class="js-smell-location">0</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;tls&#39; =&gt; {
                  &#39;enabled&#39; =&gt; true,
                  &#39;cert&#39; =&gt; {
                    &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                    &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                    &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                  },
                  &#39;bosh_internal&#39; =&gt; {
                    &#39;ca_provided&#39; =&gt; true,
                    &#39;mutual_tls_enabled&#39; =&gt; false,
                  }
                },
                &#39;connection_options&#39; =&gt; {
                  &#39;sslmode&#39; =&gt; &#39;something-custom&#39;,
                  &#39;sslrootcert&#39; =&gt; &#39;/some/unknow/path&#39;
                }
              }
            end

            let(:connection_parameters) do
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;sslmode&#39; =&gt; &#39;something-custom&#39;,
                &#39;sslrootcert&#39; =&gt; &#39;/some/unknow/path&#39;
              }
            end
          end
        end

        context &#39;when user does not pass CA property&#39; do
          it_behaves_like &#39;db connects with custom parameters&#39; do
            let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L756" class="js-smell-location">0</a>                  <a href="config_spec.html#L903" class="js-smell-location">1</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L299" class="js-smell-location">2</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L445" class="js-smell-location">3</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;tls&#39; =&gt; {
                  &#39;enabled&#39; =&gt; true,
                  &#39;cert&#39; =&gt; {
                    &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                    &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                    &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                  },
                  &#39;bosh_internal&#39; =&gt; {
                    &#39;ca_provided&#39; =&gt; false,
                    &#39;mutual_tls_enabled&#39; =&gt; false,
                  }
                }
              }
            end

            let(:connection_parameters) do
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;sslmode&#39; =&gt; &#39;verify-full&#39;,
              }
            end
          end
        end

        context &#39;when mutual tls is enabled&#39; do
          it_behaves_like &#39;db connects with custom parameters&#39; do
            let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L789" class="js-smell-location">0</a>                  <a href="config_spec.html#L937" class="js-smell-location">1</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L332" class="js-smell-location">2</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L479" class="js-smell-location">3</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;tls&#39; =&gt; {
                  &#39;enabled&#39; =&gt; true,
                  &#39;cert&#39; =&gt; {
                    &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                    &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                    &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                  },
                  &#39;bosh_internal&#39; =&gt; {
                    &#39;ca_provided&#39; =&gt; true,
                    &#39;mutual_tls_enabled&#39; =&gt; true
                  }
                }
              }
            end

            let(:connection_parameters) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L809" class="js-smell-location">0</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L352" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;postgres&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 5432,
                &#39;sslmode&#39; =&gt; &#39;verify-full&#39;,
                &#39;sslrootcert&#39; =&gt; &#39;/path/to/root/ca&#39;,
                &#39;driver_options&#39; =&gt; {
                  &#39;sslcert&#39; =&gt;  &#39;/path/to/client/certificate&#39;,
                  &#39;sslkey&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                },
              }
            end
          end

        end
      end

      context &#39;mysql2&#39; do
        it_behaves_like &#39;db connects with custom parameters&#39; do
          let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L685" class="js-smell-location">0</a>                  <a href="config_spec.html#L829" class="js-smell-location">1</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L228" class="js-smell-location">2</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L371" class="js-smell-location">3</a>                  </div>  </li></ol>
            {
              &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
              &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
              &#39;port&#39; =&gt; 3306,
              &#39;tls&#39; =&gt; {
                &#39;enabled&#39; =&gt; true,
                &#39;cert&#39; =&gt; {
                  &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                  &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                  &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                },
                &#39;bosh_internal&#39; =&gt; {
                  &#39;ca_provided&#39; =&gt; true,
                  &#39;mutual_tls_enabled&#39; =&gt; false,
                }
              }
            }
          end

          let(:connection_parameters) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L849" class="js-smell-location">0</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L391" class="js-smell-location">1</a>                  </div>  </li></ol>
            {
              &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
              &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
              &#39;port&#39; =&gt; 3306,
              &#39;ssl_mode&#39; =&gt; &#39;verify_identity&#39;,
              &#39;sslca&#39; =&gt; &#39;/path/to/root/ca&#39;,
              &#39;sslverify&#39; =&gt; true,
            }
          end
        end

        context &#39;when user defines TLS options in connection_options&#39; do
          it_behaves_like &#39;db connects with custom parameters&#39; do
            let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L863" class="js-smell-location">0</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L405" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 3306,
                &#39;tls&#39; =&gt; {
                  &#39;enabled&#39; =&gt; true,
                  &#39;cert&#39; =&gt; {
                    &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                    &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                    &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                  },
                  &#39;bosh_internal&#39; =&gt; {
                    &#39;ca_provided&#39; =&gt; true,
                    &#39;mutual_tls_enabled&#39; =&gt; false,
                  }
                },
                &#39;connection_options&#39; =&gt; {
                  &#39;ssl_mode&#39; =&gt; &#39;something-custom&#39;,
                  &#39;sslca&#39; =&gt; &#39;/some/unknow/path&#39;,
                  &#39;sslverify&#39; =&gt; false,
                }
              }
            end

            let(:connection_parameters) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L888" class="js-smell-location">0</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L430" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 3306,
                &#39;ssl_mode&#39; =&gt; &#39;something-custom&#39;,
                &#39;sslca&#39; =&gt; &#39;/some/unknow/path&#39;,
                &#39;sslverify&#39; =&gt; false,
              }
            end
          end
        end

        context &#39;when user does not pass CA property&#39; do
          it_behaves_like &#39;db connects with custom parameters&#39; do
            let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L756" class="js-smell-location">0</a>                  <a href="config_spec.html#L903" class="js-smell-location">1</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L299" class="js-smell-location">2</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L445" class="js-smell-location">3</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 3306,
                &#39;tls&#39; =&gt; {
                  &#39;enabled&#39; =&gt; true,
                  &#39;cert&#39; =&gt; {
                    &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                    &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                    &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                  },
                  &#39;bosh_internal&#39; =&gt; {
                    &#39;ca_provided&#39; =&gt; false,
                    &#39;mutual_tls_enabled&#39; =&gt; false,
                  }
                }
              }
            end

            let(:connection_parameters) do
              {
                &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 3306,
                &#39;ssl_mode&#39; =&gt; &#39;verify_identity&#39;,
                &#39;sslverify&#39; =&gt; true,
              }
            end
          end
        end

        context &#39;when mutual tls is enabled&#39; do
          it_behaves_like &#39;db connects with custom parameters&#39; do
            let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L789" class="js-smell-location">0</a>                  <a href="config_spec.html#L937" class="js-smell-location">1</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L332" class="js-smell-location">2</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L479" class="js-smell-location">3</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 3306,
                &#39;tls&#39; =&gt; {
                  &#39;enabled&#39; =&gt; true,
                  &#39;cert&#39; =&gt; {
                    &#39;ca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                    &#39;certificate&#39; =&gt; &#39;/path/to/client/certificate&#39;,
                    &#39;private_key&#39; =&gt; &#39;/path/to/client/private_key&#39;,
                  },
                  &#39;bosh_internal&#39; =&gt; {
                    &#39;ca_provided&#39; =&gt; true,
                    &#39;mutual_tls_enabled&#39; =&gt; true
                  }
                }
              }
            end

            let(:connection_parameters) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_spec.html#L957" class="js-smell-location">0</a>                  <a href="../../../bosh-registry/spec/unit/bosh/registry/config_spec.html#L499" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;adapter&#39; =&gt; &#39;mysql2&#39;,
                &#39;host&#39; =&gt; &#39;127.0.0.1&#39;,
                &#39;port&#39; =&gt; 3306,
                &#39;ssl_mode&#39; =&gt; &#39;verify_identity&#39;,
                &#39;sslca&#39; =&gt; &#39;/path/to/root/ca&#39;,
                &#39;sslverify&#39; =&gt; true,
                &#39;sslcert&#39; =&gt;  &#39;/path/to/client/certificate&#39;,
                &#39;sslkey&#39; =&gt; &#39;/path/to/client/private_key&#39;,
              }
            end
          end

        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
