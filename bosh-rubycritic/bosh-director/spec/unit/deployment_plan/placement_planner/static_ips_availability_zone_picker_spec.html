<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../../overview.html"><img src="../../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2017-12-04 14:57:07 -0800'>2017-12-04 14:57:07 -0800</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/deployment_plan/placement_planner /</small> static_ips_availability_zone_picker_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">926</span><small> lines of codes</small></div>
              <div><span class="metric">3</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1095.3</span><small> complexity/method</small></div>
              <div><span class="metric">55</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">3285.84</span><small> complexity</small></div>
              <div><span class="metric">1277</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                38
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director::DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
  describe PlacementPlanner::StaticIpsAvailabilityZonePicker do
    include Bosh::Director::IpUtil

    subject(:zone_picker) { PlacementPlanner::StaticIpsAvailabilityZonePicker.new(instance_plan_factory, network_planner, job.networks, &#39;fake-job&#39;, availability_zones, logger) }

    let(:availability_zones) { job.availability_zones }
    let(:cloud_configs) { [Bosh::Director::Models::Config.make(:cloud, content: YAML.dump(cloud_config_hash))] }
    let!(:deployment_model) { Bosh::Director::Models::Deployment.make(manifest: YAML.dump(manifest_hash), name: manifest_hash[&#39;name&#39;]) }
    let(:deployment_manifest_migrator) { instance_double(ManifestMigrator) }
    let(:deployment_repo) { DeploymentRepo.new }
    let(:desired_instances) { [].tap { |a| desired_instance_count.times { a &lt;&lt; new_desired_instance } } }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'a'</span>          </div>  </li></ol>
    let(:desired_instance_count) { 3 }
    let(:event_log) { Bosh::Director::EventLog::Log.new(StringIO.new(&#39;&#39;)) }
    let(:index_assigner) { PlacementPlanner::IndexAssigner.new(deployment_model) }
    let(:instance_repo) { Bosh::Director::DeploymentPlan::InstanceRepository.new(network_reservation_repository, logger) }
    let(:instance_plans) { zone_picker.place_and_match_in(desired_instances, existing_instances) }
    let(:instance_plan_factory) { InstancePlanFactory.new(instance_repo, {}, SkipDrain.new(true), index_assigner, network_reservation_repository) }
    let(:network_planner) { NetworkPlanner::Planner.new(logger) }
    let(:network_reservation_repository) { BD::DeploymentPlan::NetworkReservationRepository.new(planner, logger) }
    let(:planner) { planner_factory.create_from_manifest(manifest, cloud_configs, [], {}) }
    let(:planner_factory) { PlannerFactory.new(deployment_manifest_migrator, manifest_validator, deployment_repo, logger) }
    let(:manifest_validator) { Bosh::Director::DeploymentPlan::ManifestValidator.new }
    let(:manifest) { Bosh::Director::Manifest.new(manifest_hash, YAML.dump(manifest_hash), cloud_config_hash, nil) }
    let(:job) { planner.instance_groups.first }
    let(:job_availability_zones) { %w[zone1 zone2] }
    let(:job_networks) { [{ &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; static_ips }] }

    let(:new_instance_plans) { instance_plans.select(&amp;:new?) }
    let(:existing_instance_plans) { instance_plans.reject(&amp;:new?).reject(&amp;:obsolete?) }
    let(:obsolete_instance_plans) { instance_plans.select(&amp;:obsolete?) }

    def make_subnet_spec(range, static_ips, zone_names)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#make_subnet_spec doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      spec = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L36" class="js-smell-location">0</a>                  <a href="../../../../../spec/gocli/integration/global_networking/failing_deploy_spec.html#L4" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;range&#39; =&gt; range,
        &#39;gateway&#39; =&gt; NetAddr::CIDR.create(range)[1].ip,
        &#39;dns&#39; =&gt; [&#39;8.8.8.8&#39;],
        &#39;static&#39; =&gt; static_ips,
        &#39;reserved&#39; =&gt; [],
        &#39;cloud_properties&#39; =&gt; {}
      }
      spec[&#39;azs&#39;] = zone_names if zone_names
      spec
    end
    let(:networks_spec) do
      [
        { &#39;name&#39; =&gt; &#39;a&#39;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L49" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L54" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;subnets&#39; =&gt; [
            make_subnet_spec(&#39;192.168.1.0/24&#39;, [&#39;192.168.1.10 - 192.168.1.14&#39;], [&#39;zone1&#39;]),
            make_subnet_spec(&#39;192.168.2.0/24&#39;, [&#39;192.168.2.10 - 192.168.2.14&#39;], [&#39;zone2&#39;])
          ] },
        { &#39;name&#39; =&gt; &#39;b&#39;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L49" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L54" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;subnets&#39; =&gt; [
            make_subnet_spec(&#39;10.10.1.0/24&#39;, [&#39;10.10.1.10 - 10.10.1.14&#39;], [&#39;zone1&#39;]),
            make_subnet_spec(&#39;10.10.2.0/24&#39;, [&#39;10.10.2.10 - 10.10.2.14&#39;], [&#39;zone2&#39;])
          ] }
      ]
    end

    let(:cloud_config_hash) do
      {
        &#39;networks&#39; =&gt; networks_spec,
        &#39;compilation&#39; =&gt; { &#39;workers&#39; =&gt; 1, &#39;network&#39; =&gt; &#39;a&#39;, &#39;cloud_properties&#39; =&gt; {}, &#39;az&#39; =&gt; cloud_config_availability_zones.first[&#39;name&#39;] },
        &#39;resource_pools&#39; =&gt; [
          {
            &#39;name&#39; =&gt; &#39;a&#39;,
            &#39;size&#39; =&gt; 3,
            &#39;cloud_properties&#39; =&gt; {},
            &#39;network&#39; =&gt; &#39;a&#39;,
            &#39;stemcell&#39; =&gt; { &#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;1&#39; }
          }
        ],<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L74" class="js-smell-location">0</a>                  <a href="../../../../../spec/gocli/integration/errand/run_errand_success_spec.html#L289" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;azs&#39; =&gt; cloud_config_availability_zones
      }
    end
    let(:cloud_config_availability_zones) do
      [
        { &#39;name&#39; =&gt; &#39;zone1&#39;, &#39;cloud_properties&#39; =&gt; { foo: &#39;bar&#39; } },
        { &#39;name&#39; =&gt; &#39;zone2&#39;, &#39;cloud_properties&#39; =&gt; { foo: &#39;baz&#39; } }
      ]
    end
    let(:manifest_hash) do
      {
        &#39;name&#39; =&gt; &#39;simple&#39;,
        &#39;director_uuid&#39; =&gt; &#39;deadbeef&#39;,
        &#39;releases&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;bosh-release&#39;, &#39;version&#39; =&gt; &#39;0.1-dev&#39; }],
        &#39;update&#39; =&gt; { &#39;canaries&#39; =&gt; 2, &#39;canary_watch_time&#39; =&gt; 4000, &#39;max_in_flight&#39; =&gt; 1, &#39;update_watch_time&#39; =&gt; 20 },
        &#39;jobs&#39; =&gt; [
          {
            &#39;name&#39; =&gt; &#39;fake-job&#39;,
            &#39;templates&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;foobar&#39; }],
            &#39;resource_pool&#39; =&gt; &#39;a&#39;,
            &#39;instances&#39; =&gt; desired_instance_count,
            &#39;networks&#39; =&gt; job_networks,
            &#39;properties&#39; =&gt; {},
            &#39;azs&#39; =&gt; job_availability_zones
          }
        ]
      }
    end

    before do
      fake_job
      allow(deployment_manifest_migrator).to receive(:migrate) { |deployment_manifest, cloud_config| [deployment_manifest, cloud_config] }

      Bosh::Director::Models::VariableSet.make(deployment: deployment_model)
      release = Bosh::Director::Models::Release.make(name: &#39;bosh-release&#39;)
      template = Bosh::Director::Models::Template.make(name: &#39;foobar&#39;, release: release)
      release_version = Bosh::Director::Models::ReleaseVersion.make(version: &#39;0.1-dev&#39;, release: release)
      release_version.add_template(template)
    end

    describe &#39;#place_and_match_in&#39; do
      context &#39;with no existing instances&#39; do
        let(:existing_instances) { [] }
        let(:static_ips) { [&#39;192.168.1.10 - 192.168.1.12&#39;] }

        context &#39;when the subnets and the jobs do not specify availability zones&#39; do
          let(:networks_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L121" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L714" class="js-smell-location">1</a>                  </div>  </li></ol>
            [
              { &#39;name&#39; =&gt; &#39;a&#39;,
                &#39;subnets&#39; =&gt; [
                  make_subnet_spec(&#39;192.168.1.0/24&#39;, [&#39;192.168.1.10 - 192.168.1.14&#39;], nil),
                  make_subnet_spec(&#39;192.168.2.0/24&#39;, [&#39;192.168.2.10 - 192.168.2.14&#39;], nil)
                ] },
              { &#39;name&#39; =&gt; &#39;b&#39;,
                &#39;subnets&#39; =&gt; [
                  make_subnet_spec(&#39;10.10.1.0/24&#39;, [&#39;10.10.1.10 - 10.10.1.14&#39;], nil),
                  make_subnet_spec(&#39;10.10.2.0/24&#39;, [&#39;10.10.2.10 - 10.10.2.14&#39;], nil)
                ] }
            ]
          end
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L135" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L729" class="js-smell-location">1</a>                  </div>  </li></ol>
            manifest_hash[&#39;jobs&#39;].each { |entry| entry.delete(&#39;azs&#39;) }
            cloud_config_hash[&#39;compilation&#39;].delete(&#39;az&#39;)
          end

          it &#39;does not assign AZs&#39; do
            expect(instance_plans.map(&amp;:desired_instance).map(&amp;:az)).to eq([nil, nil, nil])
          end
        end

        context &#39;when the job specifies a single network with all static IPs from a single AZ&#39; do
          let(:static_ips) { [&#39;192.168.1.10 - 192.168.1.12&#39;] }

          it &#39;assigns instances to the AZ&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(with no existing instances)::context(when the job specifies a single network with all static IPs from a single AZ)::it#assigns instances to the AZ has a flog score of 97</span>          </div>  </li></ol>
            expect(new_instance_plans.size).to eq(3)
            expect(existing_instance_plans).to eq([])
            expect(obsolete_instance_plans).to eq([])
            expect(new_instance_plans.map(&amp;:desired_instance).map(&amp;:az).map(&amp;:name)).to eq(%w[zone1 zone1 zone1])
            expect(new_instance_plans.map(&amp;:network_plans).flatten.map(&amp;:reservation).map(&amp;:ip)).to eq(
              [ip_to_i(&#39;192.168.1.10&#39;), ip_to_i(&#39;192.168.1.11&#39;), ip_to_i(&#39;192.168.1.12&#39;)]
            )
          end
        end

        context &#39;when a job specifies a static ip that belongs to no subnet&#39; do
          let(:static_ips) { [&#39;192.168.3.5&#39;] }
          let(:desired_instance_count) { 1 }

          it &#39;raises an exception&#39; do
            expect { instance_plans }.to raise_error(Bosh::Director::InstanceGroupNetworkInstanceIpMismatch, &quot;Instance group &#39;fake-job&#39; with network &#39;a&#39; declares static ip &#39;192.168.3.5&#39;, which belongs to no subnet&quot;)
          end
        end

        context &#39;when the job specifies a single network with static IPs from different AZs&#39; do
          let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;, &#39;192.168.2.10&#39;] }

          it &#39;assigns instances to the AZs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L171" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L197" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(with no existing instances)::context(when the job specifies a single network with static IPs from different AZs)::it#assigns instances to the AZs has a flog score of 83</span>          </div>  </li></ol>
            expect(new_instance_plans.size).to eq(3)
            expect(existing_instance_plans).to eq([])
            expect(obsolete_instance_plans).to eq([])

            expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(new_instance_plans[1].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(new_instance_plans[2].desired_instance.az.name).to eq(&#39;zone2&#39;)
          end
        end

        context &#39;when job specifies a single network with static IP spanning multiple AZs&#39; do
          let(:job_availability_zones) { [&#39;zone1&#39;] }
          let(:networks_spec) do
            [
              { &#39;name&#39; =&gt; &#39;a&#39;,
                &#39;subnets&#39; =&gt; [
                  make_subnet_spec(&#39;192.168.1.0/24&#39;,
                                   [&#39;192.168.1.10 - 192.168.1.14&#39;],
                                   %w[zone1 zone2])
                ] }
            ]
          end

          let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;, &#39;192.168.1.12&#39;] }

          it &#39;picks az that is specified on a job and static IP belongs to&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L171" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L197" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(with no existing instances)::context(when job specifies a single network with static IP spanning multiple AZs)::it#picks az that is specified on a job and static IP belongs to has a flog score of 83</span>          </div>  </li></ol>
            expect(new_instance_plans.size).to eq(3)
            expect(existing_instance_plans).to eq([])
            expect(obsolete_instance_plans).to eq([])

            expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(new_instance_plans[1].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(new_instance_plans[2].desired_instance.az.name).to eq(&#39;zone1&#39;)
          end
        end

        context &#39;when the job specifies multiple networks with static IPs from the same AZ&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L208" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L234" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:desired_instance_count) { 2 }
          let(:job_networks) do
            [
              { &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; [&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;], &#39;default&#39; =&gt; %w[dns gateway] },
              { &#39;name&#39; =&gt; &#39;b&#39;, &#39;static_ips&#39; =&gt; [&#39;10.10.1.10&#39;, &#39;10.10.1.11&#39;] }
            ]
          end

          it &#39;assigns instances to the AZ&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(with no existing instances)::context(when the job specifies multiple networks with static IPs from the same AZ)::it#assigns instances to the AZ has a flog score of 128</span>          </div>  </li></ol>
            expect(new_instance_plans.size).to eq(2)
            expect(existing_instance_plans).to eq([])
            expect(obsolete_instance_plans).to eq([])

            expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(new_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq(
              [ip_to_i(&#39;192.168.1.10&#39;), ip_to_i(&#39;10.10.1.10&#39;)]
            )

            expect(new_instance_plans[1].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(new_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq(
              [ip_to_i(&#39;192.168.1.11&#39;), ip_to_i(&#39;10.10.1.11&#39;)]
            )
          end
        end

        context &#39;when the job specifies multiple networks with static IPs from different non-overlapping AZs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L208" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L234" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:desired_instance_count) { 2 }
          let(:job_networks) do
            [
              { &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;], &#39;default&#39; =&gt; %w[dns gateway] },
              { &#39;name&#39; =&gt; &#39;b&#39;, &#39;static_ips&#39; =&gt; [&#39;10.10.1.10&#39;, &#39;10.10.2.10&#39;] }
            ]
          end

          it &#39;assigns instances to different AZs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(with no existing instances)::context(when the job specifies multiple networks with static IPs from different non-overlapping AZs)::it#assigns instances to different AZs has a flog score of 128</span>          </div>  </li></ol>
            expect(new_instance_plans.size).to eq(2)
            expect(existing_instance_plans).to eq([])
            expect(obsolete_instance_plans).to eq([])

            expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(new_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq(
              [ip_to_i(&#39;192.168.1.10&#39;), ip_to_i(&#39;10.10.1.10&#39;)]
            )

            expect(new_instance_plans[1].desired_instance.az.name).to eq(&#39;zone2&#39;)
            expect(new_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq(
              [ip_to_i(&#39;192.168.2.10&#39;), ip_to_i(&#39;10.10.2.10&#39;)]
            )
          end
        end

        context &#39;when job specifies multiple networks with static IPs from different overlapping AZs&#39; do
          let(:desired_instance_count) { 4 }
          let(:job_networks) do
            [
              { &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; [&#39;192.168.1.10-192.168.1.12&#39;, &#39;192.168.2.10&#39;], &#39;default&#39; =&gt; %w[dns gateway] },
              { &#39;name&#39; =&gt; &#39;b&#39;, &#39;static_ips&#39; =&gt; [&#39;10.10.1.10 - 10.10.1.11&#39;, &#39;10.10.2.10-10.10.2.11&#39;] },
              { &#39;name&#39; =&gt; &#39;c&#39;, &#39;static_ips&#39; =&gt; [&#39;172.16.1.10&#39;, &#39;172.16.2.10-172.16.2.12&#39;] },
              { &#39;name&#39; =&gt; &#39;d&#39;, &#39;static_ips&#39; =&gt; [&#39;64.8.1.10&#39;, &#39;64.8.2.10&#39;, &#39;64.8.3.10-64.8.3.11&#39;] }
            ]
          end
          let(:job_availability_zones) { %w[z1 z2 z3 z4] }
          let(:networks_spec) do
            [
              { &#39;name&#39; =&gt; &#39;a&#39;,
                &#39;subnets&#39; =&gt; [
                  make_subnet_spec(&#39;192.168.1.0/24&#39;, [&#39;192.168.1.10 - 192.168.1.14&#39;], %w[z1 z2 z3]),
                  make_subnet_spec(&#39;192.168.2.0/24&#39;, [&#39;192.168.2.10 - 192.168.2.14&#39;], [&#39;z4&#39;])
                ] },
              { &#39;name&#39; =&gt; &#39;b&#39;,
                &#39;subnets&#39; =&gt; [
                  make_subnet_spec(&#39;10.10.1.0/24&#39;, [&#39;10.10.1.10 - 10.10.1.14&#39;], %w[z1 z2]),
                  make_subnet_spec(&#39;10.10.2.0/24&#39;, [&#39;10.10.2.10 - 10.10.2.14&#39;], %w[z3 z4])
                ] },
              { &#39;name&#39; =&gt; &#39;c&#39;,
                &#39;subnets&#39; =&gt; [
                  make_subnet_spec(&#39;172.16.1.0/24&#39;, [&#39;172.16.1.10 - 172.16.1.14&#39;], [&#39;z1&#39;]),
                  make_subnet_spec(&#39;172.16.2.0/24&#39;, [&#39;172.16.2.10 - 172.16.2.14&#39;], %w[z2 z3 z4])
                ] },
              { &#39;name&#39; =&gt; &#39;d&#39;,
                &#39;subnets&#39; =&gt; [
                  make_subnet_spec(&#39;64.8.1.0/24&#39;, [&#39;64.8.1.10 - 64.8.1.14&#39;], [&#39;z1&#39;]),
                  make_subnet_spec(&#39;64.8.2.0/24&#39;, [&#39;64.8.2.10 - 64.8.2.14&#39;], [&#39;z2&#39;]),
                  make_subnet_spec(&#39;64.8.3.0/24&#39;, [&#39;64.8.3.10 - 64.8.3.14&#39;], %w[z3 z4])
                ] }
            ]
          end
          let(:cloud_config_availability_zones) do
            [{ &#39;name&#39; =&gt; &#39;z1&#39; }, { &#39;name&#39; =&gt; &#39;z2&#39; }, { &#39;name&#39; =&gt; &#39;z3&#39; }, { &#39;name&#39; =&gt; &#39;z4&#39; }]
          end

          it &#39;picks AZs for instances to fit all instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(with no existing instances)::context(when job specifies multiple networks with static IPs from different overlapping AZs)::it#picks AZs for instances to fit all instances has a flog score of 125</span>          </div>  </li></ol>
            expect(new_instance_plans.size).to eq(4)
            expect(existing_instance_plans).to eq([])
            expect(obsolete_instance_plans).to eq([])

            network_plans = {}
            new_instance_plans.map(&amp;:network_plans).flatten.each do |network_plan|
              network_plans[network_plan.reservation.network.name] ||= []
              network_plans[network_plan.reservation.network.name] &lt;&lt; format_ip(network_plan.reservation.ip)
            end

            expect(network_plans[&#39;a&#39;]).to match_array([&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;, &#39;192.168.1.12&#39;, &#39;192.168.2.10&#39;])
            expect(network_plans[&#39;b&#39;]).to match_array([&#39;10.10.1.10&#39;, &#39;10.10.1.11&#39;, &#39;10.10.2.10&#39;, &#39;10.10.2.11&#39;])
            expect(network_plans[&#39;c&#39;]).to match_array([&#39;172.16.1.10&#39;, &#39;172.16.2.12&#39;, &#39;172.16.2.10&#39;, &#39;172.16.2.11&#39;])
            expect(network_plans[&#39;d&#39;]).to match_array([&#39;64.8.1.10&#39;, &#39;64.8.2.10&#39;, &#39;64.8.3.10&#39;, &#39;64.8.3.11&#39;])

            expect(new_instance_plans.map(&amp;:desired_instance).map(&amp;:az).map(&amp;:name)).to match_array(%w[z1 z2 z3 z4])
          end
        end

        context &#39;when job static IP counts for each AZ in networks do not match&#39; do
          let(:desired_instance_count) { 2 }
          let(:job_networks) do
            [
              { &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;], &#39;default&#39; =&gt; %w[dns gateway] },
              { &#39;name&#39; =&gt; &#39;b&#39;, &#39;static_ips&#39; =&gt; [&#39;10.10.1.10&#39;, &#39;10.10.1.11&#39;] }
            ]
          end

          it &#39;raises an error&#39; do
            expect { instance_plans }.to raise_error(
              Bosh::Director::InstanceGroupNetworkInstanceIpMismatch,
              &quot;Failed to evenly distribute static IPs between zones for instance group &#39;fake-job&#39;&quot;
            )
          end
        end
      end

      context &#39;when there are existing instances&#39; do
        context &#39;with one network&#39; do
          context &#39;when all existing instances match static IPs and AZs&#39; do
            let(:desired_instance_count) { 2 }
            let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;] }
            let(:existing_instances) do
              [
                existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;]),
                existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;])
              ]
            end

            it &#39;reuses existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L350" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L398" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L883" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with one network)::context(when all existing instances match static IPs and AZs)::it#reuses existing instances has a flog score of 130</span>          </div>  </li></ol>
              expect(new_instance_plans).to eq([])
              expect(obsolete_instance_plans).to eq([])
              expect(existing_instance_plans.size).to eq(2)
              expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
              expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.1.10&#39;)])
              expect(existing_instance_plans[1].desired_instance.az.name).to eq(&#39;zone2&#39;)
              expect(existing_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.2.10&#39;)])
            end
          end

          context &#39;when existing instance static IP was moved to another AZ&#39; do
            let(:desired_instance_count) { 2 }
            let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;] }
            let(:existing_instances) do
              [
                existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;]),
                existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;])
              ]
            end
            let(:job_availability_zones) { [&#39;zone1&#39;] }

            before do
              cloud_config_hash[&#39;networks&#39;].first[&#39;subnets&#39;][1][&#39;azs&#39;] = [&#39;zone1&#39;]
            end

            it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L376" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L479" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L758" class="js-smell-location">2</a>                  </div>  </li></ol>
              expect do
                new_instance_plans
              end.to raise_error(
                Bosh::Director::NetworkReservationError,
                &quot;Existing instance &#39;fake-job/#{existing_instances[1].index}&#39; is using IP &#39;192.168.2.10&#39; in availability zone &#39;zone2&#39;&quot;
              )
            end
          end

          context &#39;when existing instance static IP is no longer in the list of job static ips&#39; do
            let(:desired_instance_count) { 2 }
            let(:static_ips) { [&#39;192.168.1.14&#39;, &#39;192.168.2.14&#39;] }
            let(:existing_instances) do
              [
                existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;]),
                existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;])
              ]
            end
            let(:job_availability_zones) { %w[zone1 zone2] }

            context &#39;when AZ is the same&#39; do
              it &#39;picks new IP for instance that is not used by other instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L350" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L398" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L883" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with one network)::context(when existing instance static IP is no longer in the list of job static ips)::context(when AZ is the same)::it#picks new IP for instance that is not used by other instances has a flog score of 135</span>          </div>  </li></ol>
                expect(new_instance_plans).to eq([])
                expect(obsolete_instance_plans).to eq([])
                expect(existing_instance_plans.size).to eq(2)
                expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.1.14&#39;)])
                expect(existing_instance_plans[1].desired_instance.az.name).to eq(&#39;zone2&#39;)
                expect(existing_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.2.14&#39;)])
              end

              context &#39;when the instance that was assigned that ip is in ignore state&#39; do
                let(:desired_instance_count) { 1 }
                let(:static_ips) { [&#39;192.168.1.14&#39;] }

                it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L412" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L440" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L522" class="js-smell-location">2</a>                  <a href="static_ips_availability_zone_picker_spec.html#L858" class="js-smell-location">3</a>                  <a href="static_ips_availability_zone_picker_spec.html#L893" class="js-smell-location">4</a>                  </div>  </li></ol>
                  existing_instances.each do |instance|
                    instance.update(ignore: true)
                  end
                  expect do
                    instance_plans
                  end.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification, &quot;In instance group &#39;fake-job&#39;, an attempt was made to remove a static ip &quot; \
                                                                                             &#39;that is used by an ignored instance. This operation is not allowed.&#39;
                end
              end
            end

            context &#39;when static IP and AZ were changed&#39; do
              let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.1.14&#39;] }

              it &#39;recreates instance in new AZ with new IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with one network)::context(when existing instance static IP is no longer in the list of job static ips)::context(when static IP and AZ were changed)::it#recreates instance in new AZ with new IP has a flog score of 159</span>          </div>  </li></ol>
                expect(new_instance_plans.size).to eq(1)
                expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(new_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.1.14&#39;)])

                expect(obsolete_instance_plans.size).to eq(1)
                expect(obsolete_instance_plans.first.existing_instance).to eq(existing_instances[1])

                expect(existing_instance_plans.size).to eq(1)
                expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.1.10&#39;)])
              end

              it &#39;raises error if removed IP belonged to an ignored instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L412" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L440" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L522" class="js-smell-location">2</a>                  <a href="static_ips_availability_zone_picker_spec.html#L858" class="js-smell-location">3</a>                  <a href="static_ips_availability_zone_picker_spec.html#L893" class="js-smell-location">4</a>                  </div>  </li></ol>
                existing_instances.each do |instance|
                  instance.update(ignore: true)
                end
                expect do
                  instance_plans
                end.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification, &quot;In instance group &#39;fake-job&#39;, an attempt was made to remove a static ip &quot; \
                                                                                           &#39;that is used by an ignored instance. This operation is not allowed.&#39;
              end
            end
          end

          context &#39;when subnet specifies several AZs (static IP belongs to several AZs)&#39; do
            let(:desired_instance_count) { 1 }
            let(:networks_spec) do
              [
                { &#39;name&#39; =&gt; &#39;a&#39;,
                  &#39;subnets&#39; =&gt; [
                    make_subnet_spec(&#39;192.168.1.0/24&#39;, [&#39;192.168.1.10 - 192.168.1.14&#39;], new_subnet_azs)
                  ] }
              ]
            end
            let(:new_subnet_azs) { %w[zone2 zone1] }
            let(:static_ips) { [&#39;192.168.1.10&#39;] }
            let(:existing_instances) { [existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;])] }

            it &#39;reuses AZ that existing instance with static IP belongs to&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with one network)::context(when subnet specifies several AZs (static IP belongs to several AZs))::it#reuses AZ that existing instance with static IP belongs to has a flog score of 78</span>          </div>  </li></ol>
              expect(new_instance_plans).to eq([])
              expect(obsolete_instance_plans).to eq([])
              expect(existing_instance_plans.size).to eq(1)
              expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
              expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.1.10&#39;)])
            end

            context &#39;when AZ to which instance belongs is removed&#39; do
              let(:new_subnet_azs) { [&#39;zone2&#39;] }
              let(:job_availability_zones) { [&#39;zone2&#39;] }
              before { cloud_config_hash[&#39;compilation&#39;][&#39;az&#39;] = &#39;zone2&#39; }

              it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L376" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L479" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L758" class="js-smell-location">2</a>                  </div>  </li></ol>
                expect do
                  new_instance_plans
                end.to raise_error(
                  Bosh::Director::NetworkReservationError,
                  &quot;Existing instance &#39;fake-job/#{existing_instances[0].index}&#39; is using IP &#39;192.168.1.10&#39; in availability zone &#39;zone1&#39;&quot;
                )
              end
            end

            context &#39;when adding more instances&#39; do
              let(:desired_instance_count) { 4 }
              let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;, &#39;192.168.1.12&#39;, &#39;192.168.1.13&#39;] }
              let(:existing_instances) do
                [
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.12&#39;])
                ]
              end
              it &#39;should distribute the instances across the azs taking into account the existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with one network)::context(when subnet specifies several AZs (static IP belongs to several AZs))::context(when adding more instances)::it#should distribute the instances across the azs taking into account the existing instances has a flog score of 113</span>          </div>  </li></ol>
                expect(obsolete_instance_plans).to eq([])

                expect(existing_instance_plans.size).to eq(2)
                expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[1].desired_instance.az.name).to eq(&#39;zone1&#39;)

                expect(new_instance_plans.size).to eq(2)
                expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone2&#39;)
                expect(new_instance_plans[1].desired_instance.az.name).to eq(&#39;zone2&#39;)
              end
            end
          end

          context &#39;when a static IP was replaced by another static IP&#39; do
            let(:desired_instance_count) { 2 }
            let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.11&#39;] }
            let(:existing_instances) do
              [
                existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;]),
                existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;])
              ]
            end

            it &#39;will fail if the original static IP was assigned to an ignored VM&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L412" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L440" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L522" class="js-smell-location">2</a>                  <a href="static_ips_availability_zone_picker_spec.html#L858" class="js-smell-location">3</a>                  <a href="static_ips_availability_zone_picker_spec.html#L893" class="js-smell-location">4</a>                  </div>  </li></ol>
              existing_instances.each do |instance|
                instance.update(ignore: true)
              end
              expect do
                instance_plans
              end.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification,
                                 &quot;In instance group &#39;fake-job&#39;, an attempt was made to remove a static ip that is used by an ignored instance. This operation is not allowed.&quot;
            end
          end
        end

        context &#39;with multiple networks&#39; do
          let(:desired_instance_count) { 4 }
          let(:job_networks) do
            [
              { &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; a_static_ips, &#39;default&#39; =&gt; %w[dns gateway] },
              { &#39;name&#39; =&gt; &#39;b&#39;, &#39;static_ips&#39; =&gt; b_static_ips }
            ]
          end

          context &#39;when all networks have static ips&#39; do
            let(:a_static_ips) { [&#39;192.168.1.10 - 192.168.1.11&#39;, &#39;192.168.2.10 -192.168.2.11&#39;] }
            let(:b_static_ips) { [&#39;10.10.1.10 - 10.10.1.11&#39;, &#39;10.10.2.10 - 10.10.2.11&#39;] }

            context &#39;when all existing instances match specified static ips&#39; do
              let(:existing_instances) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L548" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L585" class="js-smell-location">1</a>                  </div>  </li></ol>
                [
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;10.10.1.10&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;, &#39;10.10.2.10&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.11&#39;, &#39;10.10.1.11&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.11&#39;, &#39;10.10.2.11&#39;])
                ]
              end

              it &#39;reuses existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L557" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L597" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when all networks have static ips)::context(when all existing instances match specified static ips)::it#reuses existing instances has a flog score of 252</span>          </div>  </li></ol>
                expect(new_instance_plans).to eq([])
                expect(obsolete_instance_plans).to eq([])
                expect(existing_instance_plans.size).to eq(4)

                expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.1.10&#39;), ip_to_i(&#39;10.10.1.10&#39;)]
                )

                expect(existing_instance_plans[1].desired_instance.az.name).to eq(&#39;zone2&#39;)
                expect(existing_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.2.10&#39;), ip_to_i(&#39;10.10.2.10&#39;)]
                )

                expect(existing_instance_plans[2].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[2].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.1.11&#39;), ip_to_i(&#39;10.10.1.11&#39;)]
                )

                expect(existing_instance_plans[3].desired_instance.az.name).to eq(&#39;zone2&#39;)
                expect(existing_instance_plans[3].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.2.11&#39;), ip_to_i(&#39;10.10.2.11&#39;)]
                )
              end
            end

            context &#39;when some existing instances have IPs that are different from job static IPs&#39; do
              let(:existing_instances) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L548" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L585" class="js-smell-location">1</a>                  </div>  </li></ol>
                [
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;10.10.1.10&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.14&#39;, &#39;10.10.2.14&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.14&#39;, &#39;10.10.1.14&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.11&#39;, &#39;10.10.2.11&#39;])
                ]
              end

              let(:a_static_ips) { [&#39;192.168.1.10 - 192.168.1.11&#39;, &#39;192.168.2.10 -192.168.2.11&#39;] }
              let(:b_static_ips) { [&#39;10.10.1.10&#39;, &#39;10.10.1.12&#39;, &#39;10.10.2.10 - 10.10.2.11&#39;] }

              it &#39;keeps instances that match static IPs, and assigns new static IPs to instances with different IPs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L557" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L597" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when all networks have static ips)::context(when some existing instances have IPs that are different from job static IPs)::it#keeps instances that match static IPs, and assigns new static IPs to instances with different IPs has a flog score of 252</span>          </div>  </li></ol>
                expect(new_instance_plans).to eq([])
                expect(obsolete_instance_plans).to eq([])
                expect(existing_instance_plans.size).to eq(4)

                expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.1.10&#39;), ip_to_i(&#39;10.10.1.10&#39;)]
                )

                expect(existing_instance_plans[1].desired_instance.az.name).to eq(&#39;zone2&#39;)
                expect(existing_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.2.11&#39;), ip_to_i(&#39;10.10.2.11&#39;)]
                )

                expect(existing_instance_plans[2].desired_instance.az.name).to eq(&#39;zone2&#39;)
                expect(existing_instance_plans[2].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.2.10&#39;), ip_to_i(&#39;10.10.2.10&#39;)]
                )

                expect(existing_instance_plans[3].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[3].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.1.11&#39;), ip_to_i(&#39;10.10.1.12&#39;)]
                )
              end
            end

            context &#39;when existing instance static IPs no longer belong to one AZ&#39; do
              let(:desired_instance_count) { 1 }
              let(:existing_instances) do
                [
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;10.10.2.10&#39;])
                ]
              end
              let(:a_static_ips) { [&#39;192.168.1.10&#39;] }
              let(:b_static_ips) { [&#39;10.10.1.10&#39;] }

              it &#39;keeps static IP in the same AZ and picks new IP from same AZ&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when all networks have static ips)::context(when existing instance static IPs no longer belong to one AZ)::it#keeps static IP in the same AZ and picks new IP from same AZ has a flog score of 84</span>          </div>  </li></ol>
                expect(new_instance_plans).to eq([])
                expect(obsolete_instance_plans).to eq([])
                expect(existing_instance_plans.size).to eq(1)

                expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
                expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                  [ip_to_i(&#39;192.168.1.10&#39;), ip_to_i(&#39;10.10.1.10&#39;)]
                )
              end

              context &#39;when increasing number of instances&#39; do
                let(:desired_instance_count) { 3 }
                let(:existing_instances) do
                  [
                    existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;10.10.1.10&#39;]),
                    existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.11&#39;, &#39;10.10.1.11&#39;])
                  ]
                end
                let(:a_static_ips) { [&#39;192.168.1.10 - 192.168.1.11&#39;, &#39;192.168.2.10&#39;] }
                let(:b_static_ips) { [&#39;10.10.1.10 - 10.10.1.11&#39;, &#39;10.10.2.10&#39;] }

                it &#39;creates new instances in AZ with least instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when all networks have static ips)::context(when existing instance static IPs no longer belong to one AZ)::context(when increasing number of instances)::it#creates new instances in AZ with least instances has a flog score of 91</span>          </div>  </li></ol>
                  expect(new_instance_plans.size).to eq(1)
                  expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone2&#39;)
                  expect(new_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                    [ip_to_i(&#39;192.168.2.10&#39;), ip_to_i(&#39;10.10.2.10&#39;)]
                  )
                  expect(obsolete_instance_plans).to eq([])
                  expect(existing_instance_plans.size).to eq(2)
                end
              end

              context &#39;when decreasing number of instances (number of static IPs is also decreased)&#39; do
                let(:desired_instance_count) { 2 }
                let(:existing_instances) do
                  [
                    existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;10.10.1.10&#39;]),
                    existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.11&#39;, &#39;10.10.1.11&#39;]),
                    existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;, &#39;10.10.2.10&#39;])
                  ]
                end
                let(:a_static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;] }
                let(:b_static_ips) { [&#39;10.10.1.10&#39;, &#39;10.10.2.10&#39;] }

                it &#39;deletes instances with associated static ips&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when all networks have static ips)::context(when existing instance static IPs no longer belong to one AZ)::context(when decreasing number of instances (number of static IPs is also decreased))::it#deletes instances with associated static ips has a flog score of 82</span>          </div>  </li></ol>
                  expect(new_instance_plans).to eq([])
                  expect(existing_instance_plans.size).to eq(2)
                  expect(existing_instance_plans.map(&amp;:existing_instance)).to match_array([
                                                                                            existing_instances[0],
                                                                                            existing_instances[2]
                                                                                          ])

                  expect(obsolete_instance_plans.size).to eq(1)
                  expect(obsolete_instance_plans.first.existing_instance).to eq(existing_instances[1])
                end
              end
            end

            context &#39;when existing instance uses IPs needed by new instance&#39; do
              let(:desired_instance_count) { 2 }

              let(:existing_instances) do
                [
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;10.10.2.10&#39;]),
                  existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;, &#39;10.10.2.11&#39;])
                ]
              end
              let(:a_static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;] }
              let(:b_static_ips) { [&#39;10.10.1.10&#39;, &#39;10.10.2.10&#39;] }

              it &#39;raises an error&#39; do
                expect do
                  instance_plans
                end.to raise_error Bosh::Director::NetworkReservationError,
                                   &#39;Failed to distribute static IPs to satisfy existing instance reservations&#39;
              end
            end

            context &#39;when job does not specify azs&#39; do
              let(:networks_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L121" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L714" class="js-smell-location">1</a>                  </div>  </li></ol>
                [
                  { &#39;name&#39; =&gt; &#39;a&#39;,
                    &#39;subnets&#39; =&gt; [
                      make_subnet_spec(&#39;192.168.1.0/24&#39;, [&#39;192.168.1.10 - 192.168.1.14&#39;], nil),
                      make_subnet_spec(&#39;192.168.2.0/24&#39;, [&#39;192.168.2.10 - 192.168.2.14&#39;], nil)
                    ] },
                  { &#39;name&#39; =&gt; &#39;b&#39;,
                    &#39;subnets&#39; =&gt; [
                      make_subnet_spec(&#39;10.10.1.0/24&#39;, [&#39;10.10.1.10 - 10.10.1.14&#39;], nil),
                      make_subnet_spec(&#39;10.10.2.0/24&#39;, [&#39;10.10.2.10 - 10.10.2.14&#39;], nil)
                    ] }
                ]
              end

              before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L135" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L729" class="js-smell-location">1</a>                  </div>  </li></ol>
                manifest_hash[&#39;jobs&#39;].each { |entry| entry.delete(&#39;azs&#39;) }
                cloud_config_hash[&#39;compilation&#39;].delete(&#39;az&#39;)
              end

              context &#39;when existing instances do not have AZs&#39; do
                let(:desired_instance_count) { 2 }
                let(:existing_instances) do
                  [
                    existing_instance_with_az_and_ips(nil, [&#39;192.168.1.10&#39;, &#39;10.10.1.10&#39;]),
                    existing_instance_with_az_and_ips(nil, [&#39;192.168.2.10&#39;, &#39;10.10.2.11&#39;])
                  ]
                end
                let(:a_static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;] }
                let(:b_static_ips) { [&#39;10.10.1.10&#39;, &#39;10.10.2.10&#39;] }

                it &#39;does not assign AZs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when all networks have static ips)::context(when job does not specify azs)::context(when existing instances do not have AZs)::it#does not assign AZs has a flog score of 26</span>          </div>  </li></ol>
                  expect(existing_instance_plans.map(&amp;:desired_instance).map(&amp;:az)).to eq([nil, nil])
                end
              end

              context &#39;when existing instances have AZs&#39; do
                let(:existing_instances) do
                  [
                    existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;10.10.1.10&#39;]),
                    existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;, &#39;10.10.2.11&#39;])
                  ]
                end

                it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L376" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L479" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L758" class="js-smell-location">2</a>                  </div>  </li></ol>
                  expect do
                    new_instance_plans
                  end.to raise_error(
                    Bosh::Director::NetworkReservationError,
                    &quot;Existing instance &#39;fake-job/#{existing_instances[0].index}&#39; is using IP &#39;192.168.1.10&#39; in availability zone &#39;zone1&#39;&quot;
                  )
                end
              end
            end
          end

          context &#39;when instance IPs do not match at all&#39; do
            let(:networks_spec) do
              [
                { &#39;name&#39; =&gt; &#39;a&#39;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L773" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L778" class="js-smell-location">1</a>                  </div>  </li></ol>
                  &#39;subnets&#39; =&gt; [
                    make_subnet_spec(&#39;192.168.1.0/24&#39;, [&#39;192.168.1.10 - 192.168.1.14&#39;], [&#39;zone1&#39;]),
                    make_subnet_spec(&#39;192.168.2.0/24&#39;, [&#39;192.168.2.10 - 192.168.2.14&#39;], %w[zone1 zone2])
                  ] },
                { &#39;name&#39; =&gt; &#39;b&#39;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L773" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L778" class="js-smell-location">1</a>                  </div>  </li></ol>
                  &#39;subnets&#39; =&gt; [
                    make_subnet_spec(&#39;10.10.1.0/24&#39;, [&#39;10.10.1.10 - 10.10.1.14&#39;], [&#39;zone1&#39;]),
                    make_subnet_spec(&#39;10.10.2.0/24&#39;, [&#39;10.10.2.10 - 10.10.2.14&#39;], %w[zone1 zone2])
                  ] }
              ]
            end
            let(:desired_instance_count) { 2 }
            let(:existing_instances) do
              [
                existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.5.10&#39;, &#39;10.10.5.10&#39;]),
                existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.6.10&#39;, &#39;10.10.6.11&#39;])
              ]
            end
            let(:a_static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;] }
            let(:b_static_ips) { [&#39;10.10.1.10&#39;, &#39;10.10.2.10&#39;] }

            it &#39;it reuses existing instances with new IPs in their AZs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when instance IPs do not match at all)::it#it reuses existing instances with new IPs in their AZs has a flog score of 126</span>          </div>  </li></ol>
              expect(new_instance_plans).to eq([])
              expect(existing_instance_plans.size).to eq(2)
              expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
              expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                [ip_to_i(&#39;192.168.1.10&#39;), ip_to_i(&#39;10.10.1.10&#39;)]
              )

              expect(existing_instance_plans[1].desired_instance.az.name).to eq(&#39;zone1&#39;)
              expect(existing_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to match_array(
                [ip_to_i(&#39;192.168.2.10&#39;), ip_to_i(&#39;10.10.2.10&#39;)]
              )
            end
          end

          context &#39;when some networks do not have static ips&#39; do
            let(:desired_instance_count) { 2 }
            let(:job_networks) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L812" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L844" class="js-smell-location">1</a>                  </div>  </li></ol>
              [
                { &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; a_static_ips, &#39;default&#39; =&gt; %w[dns gateway] },
                { &#39;name&#39; =&gt; &#39;b&#39; }
              ]
            end
            let(:existing_instances) do
              [
                existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;])
              ]
            end
            let(:a_static_ips) { [&#39;192.168.1.10 - 192.168.1.11&#39;] }

            it &#39;creates network plans with dynamic reservations on network without static IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(with multiple networks)::context(when some networks do not have static ips)::it#creates network plans with dynamic reservations on network without static IP has a flog score of 206</span>          </div>  </li></ol>
              expect(new_instance_plans.size).to eq(1)
              expect(new_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)

              expect(new_instance_plans[0].network_plans.map(&amp;:reservation).find(&amp;:static?).ip).to eq(ip_to_i(&#39;192.168.1.11&#39;))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L829" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L836" class="js-smell-location">1</a>                  </div>  </li></ol>
              expect(new_instance_plans[0].network_plans.map(&amp;:reservation).select(&amp;:dynamic?).size).to eq(1)

              expect(obsolete_instance_plans).to eq([])

              expect(existing_instance_plans.size).to eq(1)
              expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
              expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).find(&amp;:static?).ip).to eq(ip_to_i(&#39;192.168.1.10&#39;))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L829" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L836" class="js-smell-location">1</a>                  </div>  </li></ol>
              expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).select(&amp;:dynamic?).size).to eq(1)
            end
          end

          context &#39;when networks are added or removed&#39; do
            context &#39;when there are ignored instances&#39; do
              let(:desired_instance_count) { 2 }
              let(:job_networks) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L812" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L844" class="js-smell-location">1</a>                  </div>  </li></ol>
                [
                  { &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; a_static_ips, &#39;default&#39; =&gt; %w[dns gateway] },
                  { &#39;name&#39; =&gt; &#39;b&#39; }
                ]
              end
              let(:a_static_ips) { [&#39;192.168.1.10 - 192.168.1.11&#39;] }

              let(:existing_instances) do
                [
                  existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;])
                ]
              end

              it &#39;fails when attempting to add a network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L412" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L440" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L522" class="js-smell-location">2</a>                  <a href="static_ips_availability_zone_picker_spec.html#L858" class="js-smell-location">3</a>                  <a href="static_ips_availability_zone_picker_spec.html#L893" class="js-smell-location">4</a>                  </div>  </li></ol>
                existing_instances.each do |instance|
                  instance.update(ignore: true)
                end

                expect do
                  instance_plans
                end.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification,
                                   &quot;In instance group &#39;fake-job&#39;, which contains ignored vms, an attempt was made to modify the networks. This operation is not allowed.&quot;
              end
            end
          end
        end

        context &#39;when network name was changed&#39; do
          let(:desired_instance_count) { 2 }
          let(:job_networks) { [{ &#39;name&#39; =&gt; &#39;a&#39;, &#39;static_ips&#39; =&gt; static_ips }] }
          let(:static_ips) { [&#39;192.168.1.10&#39;, &#39;192.168.2.10&#39;] }
          let(:existing_instances) do
            [
              existing_instance_with_az_and_ips(&#39;zone1&#39;, [&#39;192.168.1.10&#39;], &#39;old-network-name&#39;),
              existing_instance_with_az_and_ips(&#39;zone2&#39;, [&#39;192.168.2.10&#39;], &#39;old-network-name&#39;)
            ]
          end

          it &#39;assigns azs based on IP addresses regardless&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L350" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L398" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L883" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#place_and_match_in)::context(when there are existing instances)::context(when network name was changed)::it#assigns azs based on IP addresses regardless has a flog score of 124</span>          </div>  </li></ol>
            expect(new_instance_plans).to eq([])
            expect(obsolete_instance_plans).to eq([])
            expect(existing_instance_plans.size).to eq(2)
            expect(existing_instance_plans[0].desired_instance.az.name).to eq(&#39;zone1&#39;)
            expect(existing_instance_plans[0].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.1.10&#39;)])
            expect(existing_instance_plans[1].desired_instance.az.name).to eq(&#39;zone2&#39;)
            expect(existing_instance_plans[1].network_plans.map(&amp;:reservation).map(&amp;:ip)).to eq([ip_to_i(&#39;192.168.2.10&#39;)])
          end

          it &#39;should fail if ignored instances belonged to that network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="static_ips_availability_zone_picker_spec.html#L412" class="js-smell-location">0</a>                  <a href="static_ips_availability_zone_picker_spec.html#L440" class="js-smell-location">1</a>                  <a href="static_ips_availability_zone_picker_spec.html#L522" class="js-smell-location">2</a>                  <a href="static_ips_availability_zone_picker_spec.html#L858" class="js-smell-location">3</a>                  <a href="static_ips_availability_zone_picker_spec.html#L893" class="js-smell-location">4</a>                  </div>  </li></ol>
            existing_instances.each do |instance|
              instance.update(ignore: true)
            end

            expect do
              instance_plans
            end.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification,
                               &quot;In instance group &#39;fake-job&#39;, which contains ignored vms, an attempt was made to modify the networks. This operation is not allowed.&quot;
          end
        end
      end
    end

    def new_desired_instance
      DesiredInstance.new(job, planner)
    end

    def existing_instance_with_az_and_ips(az, ips, network_name = &#39;a&#39;)
      instance = Bosh::Director::Models::Instance.make(
        availability_zone: az, deployment: deployment_model, job: job.name
      )
      ips.each do |ip|
        instance.add_ip_address(
          Bosh::Director::Models::IpAddress.make(
            address_str: NetAddr::CIDR.create(ip).to_i.to_s,
            network_name: network_name
          )
        )
      end
      instance
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../../assets/javascripts/application.js'></script>
    <script src='../../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
