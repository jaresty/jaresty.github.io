<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../../overview.html"><img src="../../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/deployment_plan/placement_planner /</small> availability_zone_picker_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">628</span><small> lines of codes</small></div>
              <div><span class="metric">2</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1259.8</span><small> complexity/method</small></div>
              <div><span class="metric">26</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2519.67</span><small> complexity</small></div>
              <div><span class="metric">326</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                45
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director::DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
  describe PlacementPlanner::AvailabilityZonePicker do
    subject(:zone_picker) { PlacementPlanner::AvailabilityZonePicker.new(instance_plan_factory, network_planner, job_networks, desired_azs, random_tie_strategy: test_random_tie_strategy ) }

    let(:network_planner) { NetworkPlanner::Planner.new(logger) }
    let(:network_reservation_repository) { BD::DeploymentPlan::NetworkReservationRepository.new(instance_double(Bosh::Director::DeploymentPlan::Planner), logger) }
    let(:skip_drain_decider) { SkipDrain.new(true) }
    let(:instance_plan_factory) { InstancePlanFactory.new(instance_repo, {}, skip_drain_decider, index_assigner, network_reservation_repository, { &#39;randomize_az_placement&#39; =&gt; randomize_az_placement }) }
    let(:index_assigner) { PlacementPlanner::IndexAssigner.new(deployment_model) }
    let(:deployment_model) { Bosh::Director::Models::Deployment.make }
    let(:test_random_tie_strategy) { PlacementPlanner::TieStrategy::RandomWins }
    let(:randomize_az_placement) { false }
    let(:deployment_subnets) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../network_planner/planner_spec.html#L16" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L15" class="js-smell-location">1</a>                  </div>  </li></ol>
      [
        ManualNetworkSubnet.new(
          &#39;network_A&#39;,
          NetAddr::CIDR.create(&#39;192.168.1.0/24&#39;),
          nil, nil, nil, nil, [&#39;zone_1&#39;], [],
          [&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;, &#39;192.168.1.12&#39;, &#39;192.168.1.13&#39;, &#39;192.168.1.14&#39;])
      ]
    end
    let(:deployment_network) { ManualNetwork.new(&#39;network_A&#39;, deployment_subnets, nil) }
    let(:job_networks) { [JobNetwork.new(&#39;network_A&#39;, nil, [], deployment_network)] }

    # we don&#39;t care about instances in this test, it is hard to make them, because they need deployment plan
    let(:instance_repo) do
      instance_double(InstanceRepository,
        fetch_existing: instance_double(Instance, uuid: &#39;existing-uuid&#39;, update_description: nil, model: Bosh::Director::Models::Instance.make),
        fetch_obsolete_existing: instance_double(Instance, update_description: nil, model: Bosh::Director::Models::Instance.make),
        create: instance_double(Instance, uuid: &#39;create-uuid&#39;, model: Bosh::Director::Models::Instance.make)
      )
    end
    let(:az1) { AvailabilityZone.new(&#39;1&#39;, {}) }
    let(:az2) { AvailabilityZone.new(&#39;2&#39;, {}) }
    let(:az3) { AvailabilityZone.new(&#39;3&#39;, {}) }

    let(:deployment) { nil }
    let(:job) { instance_double(InstanceGroup, name: &#39;fake-job&#39;) }

    def desired_instance(zone = nil)
      DesiredInstance.new(job, deployment, zone, 0)
    end

    def existing_instance_with_az(index, az, persistent_disks=[])
      instance_model = Bosh::Director::Models::Instance.make(index: index, availability_zone: az, deployment: deployment_model)
      allow(instance_model).to receive(:persistent_disks).and_return(persistent_disks)
      instance_model
    end
    let(:desired_azs) { [] }

    describe &#39;placing and matching&#39; do
      it &#39;a job in no zones with 3 instances, we expect two existing instances are reused and one new instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::it#a job in no zones with 3 instances, we expect two existing instances are reused and one new instance has a flog score of 97</span>          </div>  </li></ol>
        unmatched_desired_instances = [desired_instance, desired_instance, desired_instance]
        existing_0 = existing_instance_with_az(0, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
        existing_1 = existing_instance_with_az(1, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L57" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L78" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L169" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
        unmatched_existing_instances = [existing_0, existing_1]

        results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
        existing = results.select(&amp;:existing?)
        expect(existing.size).to eq(2)
        expect(existing[0].existing_instance).to eq(existing_0)
        expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])
        expect(existing[1].existing_instance).to eq(existing_1)
        expect(existing[1].desired_instance).to eq(unmatched_desired_instances[1])

        expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to match_array([unmatched_desired_instances[2]])
        expect(results.select(&amp;:obsolete?)).to eq([])
      end

      context &#39;when a job in nil zones with 3 instances&#39; do
        let(:desired_azs) { nil }

        it &#39;we expect two existing instances are reused and one new instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::context(when a job in nil zones with 3 instances)::it#we expect two existing instances are reused and one new instance has a flog score of 103</span>          </div>  </li></ol>
          unmatched_desired_instances = [desired_instance, desired_instance, desired_instance]
          existing_0 = existing_instance_with_az(0, nil, [&#39;disk-blah&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
          existing_1 = existing_instance_with_az(1, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L57" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L78" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L169" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
          unmatched_existing_instances = [existing_0, existing_1]

          results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
          existing = results.select(&amp;:existing?)
          expect(existing.size).to eq(2)
          expect(existing[0].existing_instance).to eq(existing_0)
          expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])
          expect(existing[1].existing_instance).to eq(existing_1)
          expect(existing[1].desired_instance).to eq(unmatched_desired_instances[1])

          expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to match_array([unmatched_desired_instances[2]])
          expect(results.select(&amp;:obsolete?)).to eq([])
        end
      end

      context &#39;with randomize_az_placement turned on, and a fake random tie strategy&#39; do
        let(:randomize_az_placement) { true }
        let(:test_random_tie_strategy) do
          ts = double(:random_tie_strategy)
          allow(ts).to receive(:new).and_return fake_tie_strategy
          ts
        end

        let(:fake_tie_strategy) { double(:random_tie_strategy_instance) }

        context &#39;when a job is in 2 zones with 3 instances&#39; do
          let(:desired_azs) { [az1, az2] }

          it &#39;we expect all instances will be new, with leftovers assigned to azs at random&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::context(with randomize_az_placement turned on, and a fake random tie strategy)::context(when a job is in 2 zones with 3 instances)::it#we expect all instances will be new, with leftovers assigned to azs at random has a flog score of 114</span>          </div>  </li></ol>
            unmatched_desired_instances = [desired_instance, desired_instance, desired_instance]
            unmatched_existing_instances = []

            expect(fake_tie_strategy).to receive(:call).twice.with([az1, az2]).and_return(az1)

            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:existing?)).to eq([])

            new_plans = results.select(&amp;:new?)
            expect(new_plans.size).to eq(3)
            expect(new_plans[0].desired_instance).to eq(desired_instance(az1))
            expect(new_plans[1].desired_instance).to eq(desired_instance(az2))
            expect(new_plans[2].desired_instance).to eq(desired_instance(az1))

            expect(results.select(&amp;:obsolete?)).to eq([])
          end
        end

        context &#39;when a job is in 3 zones with 5 instances&#39; do
          let(:desired_azs) { [az1, az2, az3] }

          it &#39;we expect all instances will be new, with leftovers assigned to azs at random&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::context(with randomize_az_placement turned on, and a fake random tie strategy)::context(when a job is in 3 zones with 5 instances)::it#we expect all instances will be new, with leftovers assigned to azs at random has a flog score of 172</span>          </div>  </li></ol>
            unmatched_desired_instances = [desired_instance, desired_instance, desired_instance, desired_instance, desired_instance]
            unmatched_existing_instances = []

            expect(fake_tie_strategy).to receive(:call).with([az1, az2, az3]).and_return(az2).twice
            expect(fake_tie_strategy).to receive(:call).with([az1, az3]).and_return(az1).twice

            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:existing?)).to eq([])

            new_plans = results.select(&amp;:new?)
            expect(new_plans.size).to eq(5)
            expect(new_plans[0].desired_instance).to eq(desired_instance(az2))
            expect(new_plans[1].desired_instance).to eq(desired_instance(az1))
            expect(new_plans[2].desired_instance).to eq(desired_instance(az3))
            expect(new_plans[3].desired_instance).to eq(desired_instance(az2))
            expect(new_plans[4].desired_instance).to eq(desired_instance(az1))

            expect(results.select(&amp;:obsolete?)).to eq([])
          end
        end

        context &#39;when the randomize azs feature flag is turned off&#39; do
          let(:desired_azs) { [az1, az2] }
          let(:randomize_az_placement) { false }

          it &#39;should not randomize the az picking&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::context(with randomize_az_placement turned on, and a fake random tie strategy)::context(when the randomize azs feature flag is turned off)::it#should not randomize the az picking has a flog score of 39</span>          </div>  </li></ol>
            unmatched_desired_instances = [desired_instance]
            unmatched_existing_instances = []
            expect(fake_tie_strategy).not_to receive(:call)
            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az1)])
          end
        end
      end

      describe &#39;scaling down&#39; do
        it &#39;prefers to preserve lower-indexed existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(scaling down)::it#prefers to preserve lower-indexed existing instances has a flog score of 71</span>          </div>  </li></ol>
          unmatched_desired_instances = [desired_instance]
          existing_0 = existing_instance_with_az(0, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
          existing_1 = existing_instance_with_az(1, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L57" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L78" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L169" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
          unmatched_existing_instances = [existing_1, existing_0]

          results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
          expect(results.select(&amp;:new?)).to eq([])

          existing = results.select(&amp;:existing?)
          expect(existing.size).to eq(1)
          expect(existing[0].existing_instance).to eq(existing_0)
          expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])

          expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_1])
        end
      end

      describe &#39;scaling down azs&#39; do
        let(:desired_azs) { [az1, az2] }

        it &#39;rebalances obsolete instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L187" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L211" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(scaling down azs)::it#rebalances obsolete instances has a flog score of 114</span>          </div>  </li></ol>
          unmatched_desired_instances = [desired_instance, desired_instance, desired_instance]
          existing_0 = existing_instance_with_az(0, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
          existing_1 = existing_instance_with_az(1, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L57" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L78" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L169" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
          existing_2 = existing_instance_with_az(2, &#39;3&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_2'</span>          </div>  </li></ol>
          unmatched_existing_instances = [existing_1, existing_0, existing_2]

          results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
          expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az1)])

          existing = results.select(&amp;:existing?)
          expect(existing.size).to eq(2)
          expect(existing[0].existing_instance).to eq(existing_0)
          expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])
          expect(existing[1].existing_instance).to eq(existing_1)
          expect(existing[1].desired_instance).to eq(unmatched_desired_instances[1])

          expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_2])
        end
      end

      describe &#39;when a job is deployed in 2 zones with 3 existing instances, and re-deployed into one zone&#39; do
        let(:desired_azs) { [az1] }

        it &#39;should match the 2 existing instances from the desired zone to 2 of the desired instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L187" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L211" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when a job is deployed in 2 zones with 3 existing instances, and re-deployed into one zone)::it#should match the 2 existing instances from the desired zone to 2 of the desired instances has a flog score of 114</span>          </div>  </li></ol>
          unmatched_desired_instances = [desired_instance, desired_instance, desired_instance]

          existing_zone1_2 = existing_instance_with_az(2, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_2'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L214" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L247" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L284" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L602" class="js-smell-location">3</a>                  </div>  </li></ol>
          existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
          existing_zone2_1 = existing_instance_with_az(1, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_1'</span>          </div>  </li></ol>
          unmatched_existing_instances = [existing_zone1_0, existing_zone1_2, existing_zone2_1]

          results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
          expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az1)])

          existing = results.select(&amp;:existing?)
          expect(existing.size).to eq(2)
          expect(existing[0].existing_instance).to eq(existing_zone1_0)
          expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])
          expect(existing[1].existing_instance).to eq(existing_zone1_2)
          expect(existing[1].desired_instance).to eq(unmatched_desired_instances[1])

          expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_zone2_1])
        end
      end

      describe &#39;when a job is deployed in 2 zones with 5 existing instances, and re-deployed into 3 zones&#39; do
        let(:desired_azs) { [az1, az2, az3] }

        it &#39;should match the 2 existing instances from the 2 desired zones&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when a job is deployed in 2 zones with 5 existing instances, and re-deployed into 3 zones)::it#should match the 2 existing instances from the 2 desired zones has a flog score of 166</span>          </div>  </li></ol>
          unmatched_desired_instances = [
            desired_instance,
            desired_instance,
            desired_instance,
            desired_instance,
            desired_instance,
          ]

          existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
          existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>
          existing_zone1_2 = existing_instance_with_az(2, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_2'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L214" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L247" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L284" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L602" class="js-smell-location">3</a>                  </div>  </li></ol>
          existing_zone2_3 = existing_instance_with_az(3, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_3'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L248" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L467" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L576" class="js-smell-location">2</a>                  </div>  </li></ol>
          existing_zone2_4 = existing_instance_with_az(4, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_4'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L249" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L286" class="js-smell-location">1</a>                  </div>  </li></ol>

          unmatched_existing_instances = [existing_zone1_0, existing_zone1_1, existing_zone1_2, existing_zone2_3, existing_zone2_4]

          results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
          expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az3)])

          existing = results.select(&amp;:existing?)
          expect(existing.size).to eq(4)
          expect(existing[0].existing_instance).to eq(existing_zone1_0)
          expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])
          expect(existing[1].existing_instance).to eq(existing_zone2_3)
          expect(existing[1].desired_instance).to eq(unmatched_desired_instances[1])
          expect(existing[2].existing_instance).to eq(existing_zone1_1)
          expect(existing[2].desired_instance).to eq(unmatched_desired_instances[3])
          expect(existing[3].existing_instance).to eq(existing_zone2_4)
          expect(existing[3].desired_instance).to eq(unmatched_desired_instances[4])

          expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_zone1_2])
        end

        describe &#39;when a job is deployed in 2 zones with 4 existing instances in one zone and 1 in the second and then re-deployed into 3 zones&#39; do
          let(:desired_azs) { [az1, az2, az3] }

          it &#39;should match the 2 existing instances from the 2 desired zones&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when a job is deployed in 2 zones with 5 existing instances, and re-deployed into 3 zones)::describe(when a job is deployed in 2 zones with 4 existing instances in one zone and 1 in the second and then re-deployed into 3 zones)::it#should match the 2 existing instances from the 2 desired zones has a flog score of 87</span>          </div>  </li></ol>
            unmatched_desired_instances = [
              desired_instance,
              desired_instance,
              desired_instance,
              desired_instance,
              desired_instance,
            ]

            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>
            existing_zone1_2 = existing_instance_with_az(2, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_2'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L214" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L247" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L284" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L602" class="js-smell-location">3</a>                  </div>  </li></ol>
            existing_zone1_3 = existing_instance_with_az(3, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_3'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L285" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L603" class="js-smell-location">1</a>                  </div>  </li></ol>
            existing_zone2_4 = existing_instance_with_az(4, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_4'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L249" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L286" class="js-smell-location">1</a>                  </div>  </li></ol>

            unmatched_existing_instances = [existing_zone1_0, existing_zone1_1, existing_zone1_2, existing_zone1_3, existing_zone2_4]

            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az3), desired_instance(az2)])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(3)

            expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_zone1_2, existing_zone1_3])
          end
        end
      end

      describe &#39;when a job is deployed in 2 zones with 3 existing instances, and re-deployed into 3 zones with 4 instances&#39; do
        let(:desired_azs) { [az1, az2, az3] }

        it &#39;uses the zone with 2 existing instances as the zone with the extra instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when a job is deployed in 2 zones with 3 existing instances, and re-deployed into 3 zones with 4 instances)::it#uses the zone with 2 existing instances as the zone with the extra instance has a flog score of 131</span>          </div>  </li></ol>
          unmatched_desired_instances = [
            desired_instance,
            desired_instance,
            desired_instance,
            desired_instance,
          ]

          existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
          existing_zone2_0 = existing_instance_with_az(1, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_0'</span>          </div>  </li></ol>
          existing_zone2_2 = existing_instance_with_az(2, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_2'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L314" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L466" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L575" class="js-smell-location">2</a>                  </div>  </li></ol>

          unmatched_existing_instances = [existing_zone1_0, existing_zone2_0, existing_zone2_2]

          results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
          expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az3)])

          existing = results.select(&amp;:existing?)
          expect(existing.size).to eq(3)
          expect(existing[0].existing_instance).to eq(existing_zone2_0)
          expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])
          expect(existing[1].existing_instance).to eq(existing_zone1_0)
          expect(existing[1].desired_instance).to eq(unmatched_desired_instances[1])
          expect(existing[2].existing_instance).to eq(existing_zone2_2)
          expect(existing[2].desired_instance).to eq(unmatched_desired_instances[3])

          expect(results.select(&amp;:obsolete?)).to eq([])
        end
      end

      describe &#39;when existing instances have persistent disk&#39; do
        describe &#39;when existing instances have no az, and desired have no azs&#39; do
          let(:desired_azs) { [] }
          it &#39;should not recreate the instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(when existing instances have no az, and desired have no azs)::it#should not recreate the instances has a flog score of 82</span>          </div>  </li></ol>
            existing_0 = existing_instance_with_az(0, nil, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
            unmatched_desired_instances = [desired_instance, desired_instance]
            results = zone_picker.place_and_match_in(unmatched_desired_instances, [existing_0])
            expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([unmatched_desired_instances[1]])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(1)
            expect(existing[0].existing_instance).to eq(existing_0)
            expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])

            expect(results.select(&amp;:obsolete?)).to eq([])
          end
        end

        describe &#39;with the same number of desired instances both in the same zone&#39; do
          let(:desired_azs) { [az1, az2] }

          it &#39;should not move existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(with the same number of desired instances both in the same zone)::it#should not move existing instances has a flog score of 100</span>          </div>  </li></ol>
            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>

            desired_instances = [desired_instance, desired_instance]
            results = zone_picker.place_and_match_in(desired_instances, [existing_zone1_0, existing_zone1_1])
            expect(results.select(&amp;:new?)).to eq([])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(2)
            expect(existing[0].existing_instance).to eq(existing_zone1_0)
            expect(existing[0].desired_instance).to eq(desired_instances[0])
            expect(existing[1].existing_instance).to eq(existing_zone1_1)
            expect(existing[1].desired_instance).to eq(desired_instances[1])

            expect(results.select(&amp;:obsolete?)).to eq([])
          end
        end

        describe &#39;when the existing instance is not in the set of desired azs&#39; do
          let(:desired_azs) { [az1, az2] }

          it &#39;should not reuse the existing instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(when the existing instance is not in the set of desired azs)::it#should not reuse the existing instance has a flog score of 93</span>          </div>  </li></ol>
            unmatched_desired_instances = [desired_instance, desired_instance]

            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;, [&#39;disk0&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone66_1 = existing_instance_with_az(1, &#39;66&#39;, [&#39;disk1&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone66_1'</span>          </div>  </li></ol>
            unmatched_existing_instances = [existing_zone1_0, existing_zone66_1]

            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az2)])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(1)
            expect(existing[0].existing_instance).to eq(existing_zone1_0)
            expect(existing[0].desired_instance).to eq(unmatched_desired_instances[1])

            expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_zone66_1])
          end
        end

        describe &quot;when none of instances&#39; persistent disks are active&quot; do
          let(:desired_azs) { [az1, az2] }

          it &#39;should not destroy/remove/re-balance them, should do nothing&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(when none of instances' persistent disks are active)::it#should not destroy/remove/re-balance them, should do nothing has a flog score of 100</span>          </div>  </li></ol>
            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make(active: false)])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make(active: false)])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>

            unmatched_desired_instances = [desired_instance, desired_instance]
            results = zone_picker.place_and_match_in(unmatched_desired_instances, [existing_zone1_0, existing_zone1_1])
            expect(results.select(&amp;:new?)).to eq([])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(2)
            expect(existing[0].existing_instance).to eq(existing_zone1_0)
            expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])
            expect(existing[1].existing_instance).to eq(existing_zone1_1)
            expect(existing[1].desired_instance).to eq(unmatched_desired_instances[1])

            expect(results.select(&amp;:obsolete?)).to eq([])
          end
        end

        describe &#39;and some existing instances have no persistent disks&#39; do
          let(:desired_azs) { [az1, az2] }

          it &#39;should re-balance the instance that never had persistent disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(and some existing instances have no persistent disks)::it#should re-balance the instance that never had persistent disk has a flog score of 94</span>          </div>  </li></ol>
            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make(active: false)])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>

            unmatched_desired_instances = [desired_instance, desired_instance]
            results = zone_picker.place_and_match_in(unmatched_desired_instances, [existing_zone1_0, existing_zone1_1])
            expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az2)])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(1)
            expect(existing[0].existing_instance).to eq(existing_zone1_1)
            expect(existing[0].desired_instance).to eq(unmatched_desired_instances[1])

            expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_zone1_0])
          end
        end

        describe &#39;where 2 or more existing instances are in the same AZ with persistent disk and we scale down to 1&#39; do
          let(:desired_azs) { [az1] }

          it &#39;should eliminate one of the instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(where 2 or more existing instances are in the same AZ with persistent disk and we scale down to 1)::it#should eliminate one of the instances has a flog score of 82</span>          </div>  </li></ol>
            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make(active: true)])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make(active: false)])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>

            unmatched_desired_instances = [desired_instance]
            unmatched_existing_instances = [existing_zone1_0, existing_zone1_1]

            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:new?)).to eq([])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(1)
            expect(existing[0].existing_instance).to eq(existing_zone1_0)
            expect(existing[0].desired_instance).to eq(unmatched_desired_instances[0])

            expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_zone1_1])
          end
        end

        describe &#39;when an az that has instances with persistent disks is removed&#39; do
          let(:desired_azs) { [az1, az2] }

          it &#39;should re-balance the instances across the remaining azs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(when an az that has instances with persistent disks is removed)::it#should re-balance the instances across the remaining azs has a flog score of 143</span>          </div>  </li></ol>
            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>
            existing_zone2_2 = existing_instance_with_az(2, &#39;2&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_2'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L314" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L466" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L575" class="js-smell-location">2</a>                  </div>  </li></ol>
            existing_zone2_3 = existing_instance_with_az(3, &#39;2&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_3'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L248" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L467" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L576" class="js-smell-location">2</a>                  </div>  </li></ol>
            existing_zone3_4 = existing_instance_with_az(4, &#39;3&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone3_4'</span>          </div>  </li></ol>
            existing_zone3_5 = existing_instance_with_az(5, &#39;3&#39;, [Bosh::Director::Models::PersistentDisk.make])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone3_5'</span>          </div>  </li></ol>

            unmatched_desired_instances = [desired_instance, desired_instance, desired_instance, desired_instance, desired_instance, desired_instance]
            unmatched_existing_instances = [existing_zone1_0, existing_zone1_1, existing_zone2_2, existing_zone2_3, existing_zone3_4, existing_zone3_5]
            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az1), desired_instance(az2)])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(4)
            expect(existing[0].existing_instance).to eq(existing_zone1_0)
            expect(existing[1].existing_instance).to eq(existing_zone1_1)
            expect(existing[2].existing_instance).to eq(existing_zone2_2)
            expect(existing[3].existing_instance).to eq(existing_zone2_3)

            expect(results.select(&amp;:obsolete?).map(&amp;:existing_instance)).to eq([existing_zone3_4, existing_zone3_5])
          end
        end

        describe &#39;with one additional desired instance and one new az&#39; do
          let(:desired_azs) { [az1, az2] }

          it &#39;should add the instance to the additional az&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when existing instances have persistent disk)::describe(with one additional desired instance and one new az)::it#should add the instance to the additional az has a flog score of 85</span>          </div>  </li></ol>
            unmatched_desired_instances = [desired_instance, desired_instance, desired_instance]

            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;, [&#39;disk0&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;, [&#39;disk1&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>
            unmatched_existing_instances = [existing_zone1_0, existing_zone1_1]

            results = zone_picker.place_and_match_in(unmatched_desired_instances, unmatched_existing_instances)
            expect(results.select(&amp;:new?).map(&amp;:desired_instance)).to eq([desired_instance(az2)])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(2)
            expect(existing[0].existing_instance).to eq(existing_zone1_0)
            expect(existing[1].existing_instance).to eq(existing_zone1_1)

            expect(results.select(&amp;:obsolete?)).to eq([])
          end
        end
      end

      describe &#39;when some existing instances have ignore flag as true&#39; do

        describe &#39;when removing an az that has ignored instances&#39; do
          let(:desired_azs) { [az2] }

          it &#39;should raise&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L515" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L526" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when some existing instances have ignore flag as true)::describe(when removing an az that has ignored instances)::it#should raise has a flog score of 27</span>          </div>  </li></ol>
            existing_0 = existing_instance_with_az(0, az1.name, [])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
            Bosh::Director::Models::IpAddress.make(instance_id: existing_0.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567890&quot;, network_name: &quot;network_A&quot;)
            existing_0.update(ignore: true)
            expect {
              zone_picker.place_and_match_in([desired_instance], [existing_0])
            }.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification, &quot;Instance Group &#39;#{existing_0.job}&#39; no longer contains AZs [\&quot;1\&quot;] where ignored instance(s) exist.&quot;
          end
        end

        describe &#39;when adding/removing networks for instance groups with ignored vms&#39; do
          it &#39;should raise&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L515" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L526" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when some existing instances have ignore flag as true)::describe(when adding/removing networks for instance groups with ignored vms)::it#should raise has a flog score of 25</span>          </div>  </li></ol>
            existing_0 = existing_instance_with_az(0, az1.name, [])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
            Bosh::Director::Models::IpAddress.make(instance_id: existing_0.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567890&quot;, network_name: &quot;old-network&quot;)
            existing_0.update(ignore: true)
            expect {
              zone_picker.place_and_match_in([desired_instance], [existing_0])
            }.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification, &quot;In instance group &#39;#{existing_0.job}&#39;, which contains ignored vms, an attempt was made to modify the networks. This operation is not allowed.&quot;
          end
        end

        describe &#39;when not using AZs and keeping enough desired instances&#39; do
          let(:desired_azs) { nil }

          it &#39;should place and match existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when some existing instances have ignore flag as true)::describe(when not using AZs and keeping enough desired instances)::it#should place and match existing instances has a flog score of 62</span>          </div>  </li></ol>
            existing_0 = existing_instance_with_az(0, nil, [])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
            existing_0.update(ignore: true)
            Bosh::Director::Models::IpAddress.make(instance_id: existing_0.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567890&quot;, network_name: &quot;network_A&quot;)
            results = zone_picker.place_and_match_in([desired_instance], [existing_0])

            existing = results.select(&amp;:existing?)
            expect(existing.size).to eq(1)
            expect(existing[0].existing_instance).to eq(existing_0)

            expect(results.select(&amp;:new?)).to be_empty
            expect(results.select(&amp;:obsolete?)).to eq([])
          end
        end

        describe &#39;when the desired instance count drops below the number of ignored instances&#39; do
          let(:desired_azs) { nil }
          it &#39;should raise&#39; do
            existing_0 = existing_instance_with_az(0, nil, [])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L56" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L77" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L168" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L189" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L338" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L516" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L527" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L540" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L557" class="js-smell-location">8</a>                  </div>  </li></ol>
            existing_0.update(ignore: true)
            Bosh::Director::Models::IpAddress.make(instance_id: existing_0.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567890&quot;, network_name: &quot;network_A&quot;)

            desired_instances = []
            expect {
              zone_picker.place_and_match_in(desired_instances, [existing_0])
            }.to raise_error Bosh::Director::DeploymentIgnoredInstancesModification,
                             &quot;Instance Group &#39;#{existing_0.job}&#39; has 1 ignored instance(s). 0 instance(s) of that &quot; +
                                 &quot;instance group were requested. Deleting ignored instances is not allowed.&quot;
          end
        end

        describe &#39;when scaling down the instance count to the number of ignored instances and all ignored instances are in the same az&#39; do
          let(:desired_azs) { [az1,az2] }
          it &#39;should not rebalance ignored instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when some existing instances have ignore flag as true)::describe(when scaling down the instance count to the number of ignored instances and all ignored instances are in the same az)::it#should not rebalance ignored instances has a flog score of 69</span>          </div>  </li></ol>
            existing_zone1_0 = existing_instance_with_az(0, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_0'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L215" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L245" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L282" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L312" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L356" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L380" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L400" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L422" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L442" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L464" class="js-smell-location">9</a>                  <a href="availability_zone_picker_spec.html#L493" class="js-smell-location">10</a>                  <a href="availability_zone_picker_spec.html#L573" class="js-smell-location">11</a>                  </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>
            existing_zone2_2 = existing_instance_with_az(2, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_2'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L314" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L466" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L575" class="js-smell-location">2</a>                  </div>  </li></ol>
            existing_zone2_3 = existing_instance_with_az(3, &#39;2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone2_3'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L248" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L467" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L576" class="js-smell-location">2</a>                  </div>  </li></ol>

            Bosh::Director::Models::IpAddress.make(instance_id: existing_zone1_0.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567890&quot;, network_name: &quot;network_A&quot;)
            Bosh::Director::Models::IpAddress.make(instance_id: existing_zone1_1.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567891&quot;, network_name: &quot;network_A&quot;)

            existing_zone1_0.update(ignore: true)
            existing_zone1_1.update(ignore: true)

            existing_instances = [existing_zone1_0, existing_zone1_1, existing_zone2_2, existing_zone2_3]

            results = zone_picker.place_and_match_in([desired_instance, desired_instance], existing_instances)
            existing = results.select(&amp;:existing?)
            expect(results.size).to eq(4)
            expect(existing.size).to eq(2)

            obsoletes = results.select(&amp;:obsolete?)
            expect(obsoletes.map(&amp;:existing_instance)).to match_array([existing_zone2_2, existing_zone2_3])
          end
        end

        describe &#39;when scaling down the instance count to above the number of ignored instances and no az has been provided&#39; do
          let(:desired_azs) { nil }

          it &#39;should not delete ignored instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(placing and matching)::describe(when some existing instances have ignore flag as true)::describe(when scaling down the instance count to above the number of ignored instances and no az has been provided)::it#should not delete ignored instances has a flog score of 85</span>          </div>  </li></ol>
            ignored_existing_zone1_0 = existing_instance_with_az(0, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'ignored_existing_zone1_0'</span>          </div>  </li></ol>
            existing_zone1_1 = existing_instance_with_az(1, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_1'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L246" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L283" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L357" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L401" class="js-smell-location">3</a>                  <a href="availability_zone_picker_spec.html#L423" class="js-smell-location">4</a>                  <a href="availability_zone_picker_spec.html#L443" class="js-smell-location">5</a>                  <a href="availability_zone_picker_spec.html#L465" class="js-smell-location">6</a>                  <a href="availability_zone_picker_spec.html#L494" class="js-smell-location">7</a>                  <a href="availability_zone_picker_spec.html#L574" class="js-smell-location">8</a>                  <a href="availability_zone_picker_spec.html#L601" class="js-smell-location">9</a>                  </div>  </li></ol>
            existing_zone1_2 = existing_instance_with_az(2, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_2'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L214" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L247" class="js-smell-location">1</a>                  <a href="availability_zone_picker_spec.html#L284" class="js-smell-location">2</a>                  <a href="availability_zone_picker_spec.html#L602" class="js-smell-location">3</a>                  </div>  </li></ol>
            existing_zone1_3 = existing_instance_with_az(3, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'existing_zone1_3'</span>              <span>Locations:</span>                  <a href="availability_zone_picker_spec.html#L285" class="js-smell-location">0</a>                  <a href="availability_zone_picker_spec.html#L603" class="js-smell-location">1</a>                  </div>  </li></ol>
            ignored_existing_zone1_4 = existing_instance_with_az(4, nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'ignored_existing_zone1_4'</span>          </div>  </li></ol>

            Bosh::Director::Models::IpAddress.make(instance_id: ignored_existing_zone1_0.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567890&quot;, network_name: &quot;network_A&quot;)
            Bosh::Director::Models::IpAddress.make(instance_id: ignored_existing_zone1_4.id, task_id: &quot;my-ip-address-task-id&quot;, address_str: &quot;1234567891&quot;, network_name: &quot;network_A&quot;)

            ignored_existing_zone1_0.update(ignore: true)
            ignored_existing_zone1_4.update(ignore: true)

            existing_instances = [ignored_existing_zone1_0, existing_zone1_1, existing_zone1_2, existing_zone1_3, ignored_existing_zone1_4]

            results = zone_picker.place_and_match_in([desired_instance, desired_instance, desired_instance], existing_instances)
            existing = results.select(&amp;:existing?)

            expect(results.size).to eq(5)
            expect(existing.size).to eq(3)
            expect(existing.map(&amp;:existing_instance)).to match_array([ignored_existing_zone1_0, existing_zone1_1, ignored_existing_zone1_4])

            obsoletes = results.select(&amp;:obsolete?)
            expect(obsoletes.map(&amp;:existing_instance)).to match_array([existing_zone1_3, existing_zone1_2])
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../../assets/javascripts/application.js'></script>
    <script src='../../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
