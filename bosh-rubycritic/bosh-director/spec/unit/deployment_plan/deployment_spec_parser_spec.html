<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/deployment_plan /</small> deployment_spec_parser_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">607</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">55</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1267.8</span><small> complexity</small></div>
              <div><span class="metric">419</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                25
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe DeploymentPlan::DeploymentSpecParser do
    subject(:parser) { described_class.new(deployment, event_log, logger) }
    let(:deployment) { DeploymentPlan::Planner.new(planner_attributes, manifest_hash, YAML.dump(manifest_hash), cloud_config, runtime_configs, deployment_model, planner_options) }
    let(:planner_options) do
      {}
    end
    let(:event_log) { Config.event_log }
    let(:cloud_config) { Models::Config.make(:cloud) }
    let(:runtime_configs) { [Models::Config.make(:runtime)] }

    describe &#39;#parse&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe##parse has a flog score of 30</span>          </div>  </li></ol>
      let(:options) do
        { &#39;is_deploy_action&#39; =&gt; true }
      end
      let(:parsed_deployment) { subject.parse(manifest_hash, options) }
      let(:deployment_model) { Models::Deployment.make }
      let(:manifest_hash) do
        {
          &#39;name&#39; =&gt; &#39;deployment-name&#39;,
          &#39;releases&#39; =&gt; [],
          &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;network-name&#39; }],
          &#39;compilation&#39; =&gt; {},
          &#39;update&#39; =&gt; {},
          &#39;resource_pools&#39; =&gt; [],
        }
      end
      let(:planner_attributes) do
        {
          name: manifest_hash[&#39;name&#39;],
          properties: manifest_hash[&#39;properties&#39;] || {},
        }
      end

      before { allow(DeploymentPlan::CompilationConfig).to receive(:new).and_return(compilation_config) }
      let(:compilation_config) { instance_double(&#39;Bosh::Director::DeploymentPlan::CompilationConfig&#39;) }

      before { allow(DeploymentPlan::UpdateConfig).to receive(:new).and_return(update_config) }
      let(:update_config) { instance_double(&#39;Bosh::Director::DeploymentPlan::UpdateConfig&#39;) }

      before { allow(CloudFactory).to receive(:create).and_return(:cloud) }
      let(:cloud) {instance_double(CloudFactory)}

      describe &#39;name key&#39; do
        it &#39;parses name&#39; do
          manifest_hash.merge!(&#39;name&#39; =&gt; &#39;Name with spaces&#39;)
          expect(parsed_deployment.name).to eq(&#39;Name with spaces&#39;)
        end

        it &#39;sets canonical name&#39; do
          manifest_hash.merge!(&#39;name&#39; =&gt; &#39;Name with spaces&#39;)
          expect(parsed_deployment.canonical_name).to eq(&#39;namewithspaces&#39;)
        end
      end

      describe &#39;stemcells&#39; do
        context &#39;when no top level stemcells&#39; do
          before do
            manifest_hash.delete(&#39;stemcells&#39;)
          end

          it &#39;should not error out&#39; do
            expect(parsed_deployment.stemcells).to eq({})
          end
        end

        context &#39;when there 1 stemcell&#39; do
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L70" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L116" class="js-smell-location">1</a>                  </div>  </li></ol>
            stemcell_hash1 = {&#39;alias&#39; =&gt; &#39;stemcell1&#39;, &#39;name&#39; =&gt; &#39;bosh-aws-xen-hvm-ubuntu-trusty-go_agent&#39;, &#39;version&#39; =&gt; &#39;1234&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'stemcell_hash1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L71" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L91" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L104" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L117" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L129" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L143" class="js-smell-location">5</a>                  </div>  </li></ol>
            manifest_hash[&#39;stemcells&#39;] = [stemcell_hash1]
          end

          it &#39;should not error out&#39; do
            expect(parsed_deployment.stemcells.count).to eq(1)
          end

          it &#39;should error out if stemcell hash does not have alias&#39; do
            manifest_hash[&#39;stemcells&#39;].first.delete(&#39;alias&#39;)
            expect {
              parsed_deployment.stemcells
            }.to raise_error Bosh::Director::ValidationMissingField,
                &quot;Required property &#39;alias&#39; was not specified in object &quot; +
                  &#39;({&quot;name&quot;=&gt;&quot;bosh-aws-xen-hvm-ubuntu-trusty-go_agent&quot;, &quot;version&quot;=&gt;&quot;1234&quot;})&#39;
          end
        end

        context &#39;when there are stemcells with duplicate alias&#39; do
          before do
            stemcell_hash1 = {&#39;alias&#39; =&gt; &#39;stemcell1&#39;, &#39;name&#39; =&gt; &#39;bosh-aws-xen-hvm-ubuntu-trusty-go_agent&#39;, &#39;version&#39; =&gt; &#39;1234&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'stemcell_hash1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L71" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L91" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L104" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L117" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L129" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L143" class="js-smell-location">5</a>                  </div>  </li></ol>
            manifest_hash[&#39;stemcells&#39;] = [stemcell_hash1, stemcell_hash1]
          end

          it &#39;errors out when alias of stemcells are not unique&#39; do
            expect {
              parsed_deployment.stemcells
            }.to raise_error Bosh::Director::StemcellAliasAlreadyExists, &quot;Duplicate stemcell alias &#39;stemcell1&#39;&quot;
          end
        end

        context &#39;when there are stemcells with no OS nor name&#39; do
          before do
            stemcell_hash1 = {&#39;alias&#39; =&gt; &#39;stemcell1&#39;, &#39;version&#39; =&gt; &#39;1234&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'stemcell_hash1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L71" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L91" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L104" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L117" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L129" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L143" class="js-smell-location">5</a>                  </div>  </li></ol>
            manifest_hash[&#39;stemcells&#39;] = [stemcell_hash1]
          end

          it &#39;errors out&#39; do
            expect {
              parsed_deployment.stemcells
            }.to raise_error Bosh::Director::ValidationMissingField
          end
        end

        context &#39;when there are stemcells with OS&#39; do
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L70" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L116" class="js-smell-location">1</a>                  </div>  </li></ol>
            stemcell_hash1 = {&#39;alias&#39; =&gt; &#39;stemcell1&#39;, &#39;os&#39; =&gt; &#39;ubuntu-trusty&#39;, &#39;version&#39; =&gt; &#39;1234&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'stemcell_hash1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L71" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L91" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L104" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L117" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L129" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L143" class="js-smell-location">5</a>                  </div>  </li></ol>
            manifest_hash[&#39;stemcells&#39;] = [stemcell_hash1]
          end

          it &#39;should not errors out&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::describe(stemcells)::context(when there are stemcells with OS)::it#should not errors out has a flog score of 30</span>          </div>  </li></ol>
            expect(parsed_deployment.stemcells.count).to eq(1)
            expect(parsed_deployment.stemcells[&#39;stemcell1&#39;].os).to eq(&#39;ubuntu-trusty&#39;)
          end
        end

        context &#39;when there are stemcells with both name and OS&#39; do
          before do
            stemcell_hash1 = {&#39;alias&#39; =&gt; &#39;stemcell1&#39;, &#39;name&#39; =&gt; &#39;bosh-aws-xen-hvm-ubuntu-trusty-go_agent&#39;, &#39;os&#39; =&gt; &#39;ubuntu-trusty&#39;, &#39;version&#39; =&gt; &#39;1234&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'stemcell_hash1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L71" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L91" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L104" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L117" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L129" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L143" class="js-smell-location">5</a>                  </div>  </li></ol>
            manifest_hash[&#39;stemcells&#39;] = [stemcell_hash1]
          end

          it &#39;errors out&#39; do
            expect {
              parsed_deployment.stemcells
            }.to raise_error Bosh::Director::StemcellBothNameAndOS
          end
        end

        context &#39;when there are 2 stemcells&#39; do
          before do
            stemcell_hash0 = {&#39;alias&#39; =&gt; &#39;stemcell0&#39;, &#39;name&#39; =&gt; &#39;bosh-aws-xen-hvm-ubuntu-trusty-go_agent&#39;, &#39;version&#39; =&gt; &#39;1234&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'stemcell_hash0'</span>          </div>  </li></ol>
            stemcell_hash1 = {&#39;alias&#39; =&gt; &#39;stemcell1&#39;, &#39;name&#39; =&gt; &#39;bosh-aws-xen-hvm-ubuntu-trusty-go_agent&#39;, &#39;version&#39; =&gt; &#39;1234&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'stemcell_hash1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L71" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L91" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L104" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L117" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L129" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L143" class="js-smell-location">5</a>                  </div>  </li></ol>
            manifest_hash[&#39;stemcells&#39;] = [stemcell_hash0, stemcell_hash1]
          end

          it &#39;should add stemcells to deployment plan&#39; do
            expect(parsed_deployment.stemcells.count).to eq(2)
          end
        end
      end

      describe &#39;properties key&#39; do
        it &#39;parses basic properties&#39; do
          manifest_hash.merge!(&#39;properties&#39; =&gt; { &#39;foo&#39; =&gt; &#39;bar&#39; })
          expect(parsed_deployment.properties).to eq(&#39;foo&#39; =&gt; &#39;bar&#39;)
        end

        it &#39;allows to not include properties key&#39; do
          manifest_hash.delete(&#39;properties&#39;)
          expect(parsed_deployment.properties).to eq({})
        end
      end

      describe &#39;releases/release key&#39; do
        let(:releases_spec) do
          [
            { &#39;name&#39; =&gt; &#39;foo&#39;, &#39;version&#39; =&gt; &#39;27&#39; },
            { &#39;name&#39; =&gt; &#39;bar&#39;, &#39;version&#39; =&gt; &#39;42&#39; },
          ]
        end

        context &quot;when &#39;release&#39; section is specified&quot; do
          before do
            manifest_hash.delete(&#39;releases&#39;)
            manifest_hash.merge!(&#39;release&#39; =&gt; {&#39;name&#39; =&gt; &#39;rv-name&#39;, &#39;version&#39; =&gt; &#39;abc&#39;})
          end

          it &#39;delegates to ReleaseVersion&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::describe(releases/release key)::context(when 'release' section is specified)::it#delegates to ReleaseVersion has a flog score of 33</span>          </div>  </li></ol>
            expect(parsed_deployment.releases.size).to eq(1)
            release_version = parsed_deployment.releases.first
            expect(release_version).to be_a(DeploymentPlan::ReleaseVersion)
            expect(release_version.name).to eq(&#39;rv-name&#39;)
          end

          it &#39;allows to look up release by name&#39; do
            release_version = parsed_deployment.release(&#39;rv-name&#39;)
            expect(release_version).to be_a(DeploymentPlan::ReleaseVersion)
            expect(release_version.name).to eq(&#39;rv-name&#39;)
          end
        end

        context &quot;when &#39;releases&#39; section is specified&quot; do
          before { manifest_hash.delete(&#39;release&#39;) }

          context &#39;when non-duplicate releases are included&#39; do
            before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L197" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L232" class="js-smell-location">1</a>                  </div>  </li></ol>
              manifest_hash.merge!(&#39;releases&#39; =&gt; [
                {&#39;name&#39; =&gt; &#39;rv1-name&#39;, &#39;version&#39; =&gt; &#39;abc&#39;},
                {&#39;name&#39; =&gt; &#39;rv2-name&#39;, &#39;version&#39; =&gt; &#39;def&#39;},
              ])
            end

            it &#39;delegates to ReleaseVersion&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::describe(releases/release key)::context(when 'releases' section is specified)::context(when non-duplicate releases are included)::it#delegates to ReleaseVersion has a flog score of 71</span>          </div>  </li></ol>
              expect(parsed_deployment.releases.size).to eq(2)

              rv1 = parsed_deployment.releases.first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'rv1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L207" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L219" class="js-smell-location">1</a>                  </div>  </li></ol>
              expect(rv1).to be_a(DeploymentPlan::ReleaseVersion)
              expect(rv1.name).to eq(&#39;rv1-name&#39;)
              expect(rv1.version).to eq(&#39;abc&#39;)

              rv2 = parsed_deployment.releases.last<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'rv2'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L212" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L224" class="js-smell-location">1</a>                  </div>  </li></ol>
              expect(rv2).to be_a(DeploymentPlan::ReleaseVersion)
              expect(rv2.name).to eq(&#39;rv2-name&#39;)
              expect(rv2.version).to eq(&#39;def&#39;)
            end

            it &#39;allows to look up release by name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::describe(releases/release key)::context(when 'releases' section is specified)::context(when non-duplicate releases are included)::it#allows to look up release by name has a flog score of 53</span>          </div>  </li></ol>
              rv1 = parsed_deployment.release(&#39;rv1-name&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'rv1'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L207" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L219" class="js-smell-location">1</a>                  </div>  </li></ol>
              expect(rv1).to be_a(DeploymentPlan::ReleaseVersion)
              expect(rv1.name).to eq(&#39;rv1-name&#39;)
              expect(rv1.version).to eq(&#39;abc&#39;)

              rv2 = parsed_deployment.release(&#39;rv2-name&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'rv2'</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L212" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L224" class="js-smell-location">1</a>                  </div>  </li></ol>
              expect(rv2).to be_a(DeploymentPlan::ReleaseVersion)
              expect(rv2.name).to eq(&#39;rv2-name&#39;)
              expect(rv2.version).to eq(&#39;def&#39;)
            end
          end

          context &#39;when duplicate releases are included&#39; do
            before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L197" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L232" class="js-smell-location">1</a>                  </div>  </li></ol>
              manifest_hash.merge!(&#39;releases&#39; =&gt; [
                {&#39;name&#39; =&gt; &#39;same-name&#39;, &#39;version&#39; =&gt; &#39;abc&#39;},
                {&#39;name&#39; =&gt; &#39;same-name&#39;, &#39;version&#39; =&gt; &#39;def&#39;},
              ])
            end

            it &#39;raises an error&#39; do
              expect {
                parsed_deployment
              }.to raise_error(/duplicate release name/i)
            end
          end
        end

        context &quot;when both &#39;releases&#39; and &#39;release&#39; sections are specified&quot; do
          before { manifest_hash.merge!(&#39;releases&#39; =&gt; []) }
          before { manifest_hash.merge!(&#39;release&#39; =&gt; {}) }

          it &#39;raises an error&#39; do
            expect {
              parsed_deployment
            }.to raise_error(/use one of the two/)
          end
        end

        context &quot;when neither &#39;releases&#39; or &#39;release&#39; section is specified&quot; do
          before { manifest_hash.delete(&#39;releases&#39;) }
          before { manifest_hash.delete(&#39;release&#39;) }

          it &#39;raises an error&#39; do
            expect {
              parsed_deployment
            }.to raise_error(
              ValidationMissingField,
              /Required property &#39;releases&#39; was not specified in object .+/,
            )
          end
        end
      end

      describe &#39;update key&#39; do
        context &#39;when update section is specified&#39; do
          before { manifest_hash.merge!(&#39;update&#39; =&gt; { &#39;foo&#39; =&gt; &#39;bar&#39; }) }

          it &#39;delegates parsing to UpdateConfig&#39; do
            update = instance_double(&#39;Bosh::Director::DeploymentPlan::UpdateConfig&#39;)

            expect(DeploymentPlan::UpdateConfig).to receive(:new).
              with(&#39;foo&#39; =&gt; &#39;bar&#39;, &#39;is_deploy_action&#39; =&gt; true).
              and_return(update)

            expect(parsed_deployment.update).to eq(update)
          end

          context &#39;when canaries value is present in options&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L287" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L298" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:options) do
              { &#39;is_deploy_action&#39; =&gt; true, &#39;canaries&#39; =&gt; &#39;42&#39; }
            end
              it &quot;replaces canaries value from job&#39;s update section with option&#39;s value&quot; do
                expect(DeploymentPlan::UpdateConfig).to receive(:new)
                  .with( {&#39;foo&#39;=&gt; &#39;bar&#39;, &#39;is_deploy_action&#39; =&gt; true, &#39;canaries&#39; =&gt; &#39;42&#39;} )
                  .and_return(update_config)
                parsed_deployment.update
              end
          end
          context &#39;when max_in_flight value is present in options&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L287" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L298" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:options) do
              { &#39;is_deploy_action&#39; =&gt; true, &#39;max_in_flight&#39; =&gt; &#39;42&#39; }
            end
            it &quot;replaces max_in_flight value from job&#39;s update section with option&#39;s value&quot; do
              expect(DeploymentPlan::UpdateConfig).to receive(:new)
                .with( {&#39;foo&#39;=&gt; &#39;bar&#39;, &#39;is_deploy_action&#39; =&gt; true, &#39;max_in_flight&#39; =&gt; &#39;42&#39;} )
                .and_return(update_config)
              parsed_deployment.update
            end
          end
        end

        context &#39;when update section is not specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="cloud_manifest_parser_spec.html#L71" class="js-smell-location">0</a>                  <a href="cloud_manifest_parser_spec.html#L282" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L311" class="js-smell-location">2</a>                  </div>  </li></ol>
          before { manifest_hash.delete(&#39;update&#39;) }

          it &#39;raises an error&#39; do
            expect {
              parsed_deployment
            }.to raise_error(
              ValidationMissingField,
              /Required property &#39;update&#39; was not specified in object .+/,
            )
          end
        end
      end

      shared_examples_for &#39;jobs/instance_groups key&#39; do
        context &#39;when there is at least one job&#39; do
          before { manifest_hash.merge!(keyword =&gt; []) }

          let(:event_log) { instance_double(&#39;Bosh::Director::EventLog::Log&#39;) }

          context &#39;when job names are unique&#39; do
            before do
              manifest_hash.merge!(keyword =&gt; [
                { &#39;name&#39; =&gt; &#39;instance-group-1-name&#39; },
                { &#39;name&#39; =&gt; &#39;instance-group-2-name&#39; },
              ])
            end

            let(:instance_group_1) do
              instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;, {
                name: &#39;instance-group-1-name&#39;,
                canonical_name: &#39;instance-group-1-canonical-name&#39;,
                jobs: []
              })
            end

            let(:instance_group_2) do
              instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;, {
                name: &#39;instance-group-2-name&#39;,
                canonical_name: &#39;instance-group-2-canonical-name&#39;,
                jobs: []
              })
            end

            it &#39;delegates to Job to parse job specs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::shared_examples_for(jobs/instance_groups key)::context(when there is at least one job)::context(when job names are unique)::it#delegates to Job to parse job specs has a flog score of 56</span>          </div>  </li></ol>
              expect(DeploymentPlan::InstanceGroup).to receive(:parse).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L356" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L360" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L402" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L406" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L441" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L445" class="js-smell-location">5</a>                  </div>  </li></ol>
                with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-1-name&#39;}, event_log, logger, {&#39;is_deploy_action&#39; =&gt; true}).
                and_return(instance_group_1)

              expect(DeploymentPlan::InstanceGroup).to receive(:parse).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L356" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L360" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L402" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L406" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L441" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L445" class="js-smell-location">5</a>                  </div>  </li></ol>
                with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-2-name&#39;}, event_log, logger, {&#39;is_deploy_action&#39; =&gt; true}).
                and_return(instance_group_2)

              expect(parsed_deployment.instance_groups).to eq([instance_group_1, instance_group_2])
            end

            context &#39;when canaries value is present in options&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L367" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L384" class="js-smell-location">1</a>                  </div>  </li></ol>
              let(:options) do
                { &#39;is_deploy_action&#39; =&gt; true, &#39;canaries&#39; =&gt; &#39;42&#39; }
              end
              it &quot;replaces canaries value from job&#39;s update section with option&#39;s value&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::shared_examples_for(jobs/instance_groups key)::context(when there is at least one job)::context(when job names are unique)::context(when canaries value is present in options)::it#replaces canaries value from job's update section with option's value has a flog score of 52</span>          </div>  </li></ol>
                expect(DeploymentPlan::InstanceGroup).to receive(:parse)
                  .with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-1-name&#39;}, event_log, logger, options)
                  .and_return(instance_group_1)

                expect(DeploymentPlan::InstanceGroup).to receive(:parse).
                  with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-2-name&#39;}, event_log, logger, options).
                  and_return(instance_group_2)

                parsed_deployment.instance_groups
              end
            end

            context &#39;when max_in_flight value is present in options&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L367" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L384" class="js-smell-location">1</a>                  </div>  </li></ol>
              let(:options) do
                { &#39;is_deploy_action&#39; =&gt; true, &#39;max_in_flight&#39; =&gt; &#39;42&#39; }
              end
              it &quot;replaces max_in_flight value from job&#39;s update section with option&#39;s value&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::shared_examples_for(jobs/instance_groups key)::context(when there is at least one job)::context(when job names are unique)::context(when max_in_flight value is present in options)::it#replaces max_in_flight value from job's update section with option's value has a flog score of 52</span>          </div>  </li></ol>
                expect(DeploymentPlan::InstanceGroup).to receive(:parse)
                   .with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-1-name&#39;}, event_log, logger, options)
                   .and_return(instance_group_1)

                expect(DeploymentPlan::InstanceGroup).to receive(:parse).
                  with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-2-name&#39;}, event_log, logger, options).
                  and_return(instance_group_2)

                parsed_deployment.instance_groups
              end
            end

            it &#39;allows to look up job by name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::shared_examples_for(jobs/instance_groups key)::context(when there is at least one job)::context(when job names are unique)::it#allows to look up job by name has a flog score of 67</span>          </div>  </li></ol>
              allow(DeploymentPlan::InstanceGroup).to receive(:parse).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L356" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L360" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L402" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L406" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L441" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L445" class="js-smell-location">5</a>                  </div>  </li></ol>
                with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-1-name&#39;}, event_log, logger, {&#39;is_deploy_action&#39; =&gt; true}).
                and_return(instance_group_1)

              allow(DeploymentPlan::InstanceGroup).to receive(:parse).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L356" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L360" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L402" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L406" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L441" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L445" class="js-smell-location">5</a>                  </div>  </li></ol>
                with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-2-name&#39;}, event_log, logger, {&#39;is_deploy_action&#39; =&gt; true}).
                and_return(instance_group_2)


              expect(parsed_deployment.instance_group(&#39;instance-group-1-name&#39;)).to eq(instance_group_1)
              expect(parsed_deployment.instance_group(&#39;instance-group-2-name&#39;)).to eq(instance_group_2)
            end
          end

          context &#39;when more than one instance group have the same canonical name&#39; do
            before do
              manifest_hash.merge!(keyword =&gt; [
                { &#39;name&#39; =&gt; &#39;instance-group-1-name&#39; },
                { &#39;name&#39; =&gt; &#39;instance-group-2-name&#39; },
              ])
            end

            let(:instance_group_1) do
              instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;, {
                name: &#39;instance-group-1-name&#39;,
                vm_type: &#39;default&#39;,
                canonical_name: &#39;same-canonical-name&#39;,
              })
            end

            let(:instance_group_2) do
              instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;, {
                name: &#39;instance-group-2-name&#39;,
                vm_type: &#39;default&#39;,
                canonical_name: &#39;same-canonical-name&#39;,
              })
            end

            it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::shared_examples_for(jobs/instance_groups key)::context(when there is at least one job)::context(when more than one instance group have the same canonical name)::it#raises an error has a flog score of 49</span>          </div>  </li></ol>
              allow(DeploymentPlan::InstanceGroup).to receive(:parse).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L356" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L360" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L402" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L406" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L441" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L445" class="js-smell-location">5</a>                  </div>  </li></ol>
                with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-1-name&#39;}, event_log, logger, {&#39;is_deploy_action&#39; =&gt; true}).
                and_return(instance_group_1)

              allow(DeploymentPlan::InstanceGroup).to receive(:parse).<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L356" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L360" class="js-smell-location">1</a>                  <a href="deployment_spec_parser_spec.html#L402" class="js-smell-location">2</a>                  <a href="deployment_spec_parser_spec.html#L406" class="js-smell-location">3</a>                  <a href="deployment_spec_parser_spec.html#L441" class="js-smell-location">4</a>                  <a href="deployment_spec_parser_spec.html#L445" class="js-smell-location">5</a>                  </div>  </li></ol>
                with(be_a(DeploymentPlan::Planner), {&#39;name&#39; =&gt; &#39;instance-group-2-name&#39;}, event_log, logger, {&#39;is_deploy_action&#39; =&gt; true}).
                and_return(instance_group_2)

              expect {
                parsed_deployment
              }.to raise_error(
                DeploymentCanonicalJobNameTaken,
                &quot;Invalid instance group name &#39;instance-group-2-name&#39;, canonical name already taken&quot;,
              )
            end
          end
        end

        context &#39;when there are no jobs&#39; do
          before { manifest_hash.merge!(keyword =&gt; []) }

          it &#39;parses jobs and return empty array&#39; do
            expect(parsed_deployment.instance_groups).to eq([])
          end
        end

        context &#39;when jobs key is not specified&#39; do
          before { manifest_hash.delete(keyword) }

          it &#39;parses jobs and return empty array&#39; do
            expect(parsed_deployment.instance_groups).to eq([])
          end
        end
      end

      describe &#39;jobs key&#39; do
        let(:keyword) { &quot;jobs&quot; }
        it_behaves_like &quot;jobs/instance_groups key&quot;
      end

      describe &#39;instance_group key&#39; do
        let(:keyword) { &quot;instance_groups&quot; }
        it_behaves_like &quot;jobs/instance_groups key&quot;

        context &#39;when there are both jobs and instance_groups&#39; do
          before do
            manifest_hash.merge!(&#39;jobs&#39; =&gt; [
                                     { &#39;name&#39; =&gt; &#39;instance-group-1-name&#39; },
                                     { &#39;name&#39; =&gt; &#39;instance-group-2-name&#39; },
                                 ],
                                 &#39;instance_groups&#39; =&gt; [
                                     { &#39;name&#39; =&gt; &#39;instance-group-1-name&#39; },
                                     { &#39;name&#39; =&gt; &#39;instance-group-2-name&#39; },
                                 ])
          end

          it &#39;throws an error&#39; do
            expect {parsed_deployment}.to raise_error(JobBothInstanceGroupAndJob, &quot;Deployment specifies both jobs and instance_groups keys, only one is allowed&quot;)
          end
        end
      end

      describe &#39;variables key&#39; do
        context &#39;when variables spec is valid&#39; do
          it &#39;parses provided variables&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::describe(variables key)::context(when variables spec is valid)::it#parses provided variables has a flog score of 36</span>          </div>  </li></ol>
            variables_spec = [{&#39;name&#39; =&gt; &#39;var_a&#39;, &#39;type&#39; =&gt; &#39;a&#39;}, {&#39;name&#39; =&gt; &#39;var_b&#39;, &#39;type&#39; =&gt; &#39;b&#39;, &#39;options&#39; =&gt; {&#39;x&#39; =&gt; 2}}]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployment_spec_parser_spec.html#L506" class="js-smell-location">0</a>                  <a href="../runtime_config/runtime_manifest_parser_spec.html#L141" class="js-smell-location">1</a>                  </div>  </li></ol>
            manifest_hash.merge!(&#39;variables&#39; =&gt; variables_spec)

            result_obj = parsed_deployment.variables

            expect(result_obj.spec.count).to eq(2)
            expect(result_obj.get_variable(&#39;var_a&#39;)).to eq({&#39;name&#39; =&gt; &#39;var_a&#39;, &#39;type&#39; =&gt; &#39;a&#39;})
            expect(result_obj.get_variable(&#39;var_b&#39;)).to eq({&#39;name&#39; =&gt; &#39;var_b&#39;, &#39;type&#39; =&gt; &#39;b&#39;, &#39;options&#39; =&gt; {&#39;x&#39; =&gt; 2}})
          end

          it &#39;allows to not include variables key&#39; do
            result_obj = parsed_deployment.variables

            expect(result_obj.spec.count).to eq(0)
          end
        end

        context &#39;when variables spec is NOT valid&#39; do
          it &#39;throws an error&#39; do
            variables_spec = [{&#39;name&#39; =&gt; &#39;var_a&#39;, &#39;value&#39; =&gt; &#39;a&#39;}]
            manifest_hash.merge!(&#39;variables&#39; =&gt; variables_spec)

            expect{ parsed_deployment.variables }.to raise_error Bosh::Director::VariablesInvalidFormat
          end
        end
      end

      describe &#39;features key&#39; do
        context &#39;when features spec is valid&#39; do
          it &#39;parses provided features&#39; do
            features_spec = {&#39;use_dns_addresses&#39; =&gt; true}
            manifest_hash.merge!(&#39;features&#39; =&gt; features_spec)

            features_obj = parsed_deployment.features
            expect(features_obj.use_dns_addresses).to eq(true)
          end
        end

        context &#39;when features spec is NOT valid&#39; do
          it &#39;throws an error&#39; do
            features_spec = {&#39;use_dns_addresses&#39; =&gt; 6}
            manifest_hash.merge!(&#39;features&#39; =&gt; features_spec)

            expect{ parsed_deployment.features }.to raise_error Bosh::Director::FeaturesInvalidFormat
          end
        end

        context &#39;when features spec is NOT specified&#39; do
          it &#39;defaults features object&#39; do
            features_obj = parsed_deployment.features
            expect(features_obj.use_dns_addresses).to be_nil
          end
        end
      end

      describe &#39;addons&#39; do
        context &#39;when addon spec is valid&#39; do
          it &#39;parses provided addons&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#parse)::describe(addons)::context(when addon spec is valid)::it#parses provided addons has a flog score of 49</span>          </div>  </li></ol>
            addon_spec = [
                {
                  &#39;name&#39; =&gt; &#39;addon1&#39;,
                  &#39;jobs&#39; =&gt; [{&#39;name&#39; =&gt; &#39;dummy_with_properties&#39;, &#39;release&#39; =&gt; &#39;dummy2&#39;}, {&#39;name&#39; =&gt; &#39;dummy_with_package&#39;, &#39;release&#39; =&gt; &#39;dummy2&#39;}],
                  &#39;properties&#39; =&gt; {&#39;dummy_with_properties&#39; =&gt; {&#39;echo_value&#39; =&gt; &#39;addon_prop_value&#39;}}
                }
            ]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="../addon/parser_spec.html#L18" class="js-smell-location">0</a>                  <a href="deployment_spec_parser_spec.html#L570" class="js-smell-location">1</a>                  <a href="../../../../spec/support/deployments.html#L260" class="js-smell-location">2</a>                  </div>  </li></ol>
            manifest_hash.merge!(&#39;releases&#39; =&gt; [{&#39;name&#39; =&gt; &#39;dummy2&#39;, &#39;version&#39; =&gt; &#39;2&#39;}]).merge!(&#39;addons&#39; =&gt; addon_spec)

            result_obj = parsed_deployment.addons

            expect(result_obj.count).to eq(1)
            expect(result_obj.first.name).to eq(&#39;addon1&#39;)
            expect(result_obj.first.jobs).to eq([{&#39;name&#39; =&gt; &#39;dummy_with_properties&#39;, &#39;release&#39; =&gt; &#39;dummy2&#39;, &#39;provides&#39; =&gt; {}, &#39;consumes&#39; =&gt; {}, &#39;properties&#39; =&gt; nil},
              {&#39;name&#39; =&gt; &#39;dummy_with_package&#39;, &#39;release&#39; =&gt; &#39;dummy2&#39;, &#39;provides&#39; =&gt; {}, &#39;consumes&#39; =&gt; {}, &#39;properties&#39; =&gt; nil}])
            expect(result_obj.first.properties).to eq({&#39;dummy_with_properties&#39; =&gt; {&#39;echo_value&#39; =&gt; &#39;addon_prop_value&#39;}})
          end

          it &#39;allows to not include addons&#39; do
            result_obj = parsed_deployment.addons

            expect(result_obj.count).to eq(0)
          end
        end

        context &#39;when addon spec is NOT valid&#39; do
          it &#39;throws an error&#39; do
            addon_spec = [
              {
                &#39;name&#39; =&gt; &#39;addon1&#39;,
                &#39;jobs&#39; =&gt; [{&#39;name&#39; =&gt; &#39;dummy_with_properties&#39;, &#39;release&#39; =&gt; &#39;dummy2&#39;}, {&#39;name&#39; =&gt; &#39;dummy_with_package&#39;, &#39;release&#39; =&gt; &#39;dummy2&#39;}],
                &#39;properties&#39; =&gt; {&#39;dummy_with_properties&#39; =&gt; {&#39;echo_value&#39; =&gt; &#39;addon_prop_value&#39;}},
                &#39;include&#39; =&gt; {&#39;deployments&#39; =&gt; [&#39;dep1&#39;]},
              }
            ]
            manifest_hash.merge!(&#39;releases&#39; =&gt; [{&#39;name&#39; =&gt; &#39;dummy2&#39;, &#39;version&#39; =&gt; &#39;2&#39;}]).merge!(&#39;addons&#39; =&gt; addon_spec)

            expect{ parsed_deployment.addons }.to raise_error Bosh::Director::AddonDeploymentFilterNotAllowed
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
