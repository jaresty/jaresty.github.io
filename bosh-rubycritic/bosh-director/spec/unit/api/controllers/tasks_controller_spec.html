<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../../overview.html"><img src="../../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit/api/controllers /</small> tasks_controller_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">629</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">35</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1770.79</span><small> complexity</small></div>
              <div><span class="metric">473</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                33
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;rack/test&#39;

module Bosh::Director
  module Api<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::Api has no descriptive comment</span>          </div>  </li></ol>
    describe Controllers::TasksController do
      include Rack::Test::Methods

      subject(:app) { linted_rack_app(described_class.new(config)) }

      let(:temp_dir) { Dir.mktmpdir }

      let(:deployment_name_1) { &#39;deployment1&#39; }
      let(:deployment_name_2) { &#39;deployment2&#39; }
      let(:deployment_name_3) { &#39;deployment3&#39; }
      let(:team_rocket) { Models::Team.make(name: &#39;team-rocket&#39;) }
      let(:dev) { Models::Team.make(name: &#39;dev&#39;) }

      let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 15 nodes</span>              <span>Locations:</span>                  <a href="cloud_configs_controller_spec.html#L10" class="js-smell-location">0</a>                  <a href="configs_controller_spec.html#L10" class="js-smell-location">1</a>                  <a href="cpi_configs_controller_spec.html#L10" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L12" class="js-smell-location">3</a>                  <a href="jobs_controller_spec.html#L10" class="js-smell-location">4</a>                  <a href="link_address_controller_spec.html#L10" class="js-smell-location">5</a>                  <a href="link_consumers_controller_spec.html#L10" class="js-smell-location">6</a>                  <a href="link_providers_controller_spec.html#L10" class="js-smell-location">7</a>                  <a href="links_controller_spec.html#L10" class="js-smell-location">8</a>                  <a href="locks_controller_spec.html#L10" class="js-smell-location">9</a>                  <a href="releases_controller_spec.html#L10" class="js-smell-location">10</a>                  <a href="runtime_configs_controller_spec.html#L10" class="js-smell-location">11</a>                  <a href="stemcells_controller_spec.html#L9" class="js-smell-location">12</a>                  <a href="tasks_controller_spec.html#L19" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L9" class="js-smell-location">14</a>                  </div>  </li></ol>
        config = Config.load_hash(SpecHelper.spec_get_director_config)
        identity_provider = Support::TestIdentityProvider.new(config.get_uuid_provider)
        allow(config).to receive(:identity_provider).and_return(identity_provider)
        config
      end

      after { FileUtils.rm_rf(temp_dir) }

      it &#39;requires auth&#39; do
        get &#39;/&#39;
        expect(last_response.status).to eq(401)
      end

      it &#39;sets the date header&#39; do
        get &#39;/&#39;
        expect(last_response.headers[&#39;Date&#39;]).not_to be_nil
      end

      it &#39;allows Basic HTTP Auth with admin/admin credentials for &#39; +
          &quot;test purposes (even though user doesn&#39;t exist)&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="backups_controller_spec.html#L24" class="js-smell-location">0</a>                  <a href="info_controller_spec.html#L45" class="js-smell-location">1</a>                  <a href="releases_controller_spec.html#L30" class="js-smell-location">2</a>                  <a href="task_controller_spec.html#L23" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L39" class="js-smell-location">4</a>                  </div>  </li></ol>
        basic_authorize &#39;admin&#39;, &#39;admin&#39;
        get &#39;/&#39;
        expect(last_response.status).to eq(200)
      end

      it &quot;allows Basic HTTP Auth with admin/admin credentials for test purposes (even though user doesn&#39;t exist)&quot; do
        basic_authorize &#39;reader&#39;, &#39;reader&#39;
        get &#39;/&#39;
        expect(last_response.status).to eq(200)
      end

      it &quot;allows Basic HTTP Auth with team admin credentials for test purposes (even though user doesn&#39;t exist)&quot; do
        basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39;
        get &#39;/&#39;
        expect(last_response.status).to eq(200)
      end

      describe &#39;API calls&#39; do
        describe &#39;GET /&#39; do

          let(:parsed_body) { JSON.parse(last_response.body) }

          context &#39;when user has admin access&#39; do
            before(:each) { basic_authorize &#39;admin&#39;, &#39;admin&#39; }

            context &#39;collection of tasks associated with different deployments&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context#collection of tasks associated with different deployments has a flog score of 52</span>          </div>  </li></ol>
              before do
                make_task_with_team(type: &#39;attach_disk&#39;, deployment_name: deployment_name_1, teams: [team_rocket, dev])
                make_task_with_team(type: &#39;delete_deployment&#39;, deployment_name: deployment_name_1, teams: [team_rocket, dev])
                make_task_with_team(type: &#39;run_errand&#39;, deployment_name: deployment_name_2, teams: [team_rocket])
                make_task_with_team(type: &#39;snapshot_deployment&#39;, deployment_name: deployment_name_1, teams: [team_rocket, dev])
                make_task_with_team(type: &#39;update_deployment&#39;, deployment_name: deployment_name_2, teams: [team_rocket])
                Models::Task.make(type: &#39;create_snapshot&#39;)
                Models::Task.make(type: &#39;delete_release&#39;)
                Models::Task.make(type: &#39;delete_snapshot&#39;)
                Models::Task.make(type: &#39;delete_stemcell&#39;)
                Models::Task.make(type: &#39;update_release&#39;)
                Models::Task.make(type: &#39;update_stemcell&#39;)
              end

              context &#39;when deployment name 1 is used as a query parameter&#39; do
                it &#39;filters tasks with that deployment name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(collection of tasks associated with different deployments)::context(when deployment name 1 is used as a query parameter)::it#filters tasks with that deployment name has a flog score of 32</span>          </div>  </li></ol>
                  get &quot;/?deployment=#{deployment_name_1}&quot;
                  expect(last_response.status).to eq(200)
                  deployment_names = parsed_body.map { |attributes| attributes[&#39;deployment&#39;] }
                  expect(deployment_names.uniq).to match([deployment_name_1])
                end
              end
            end

            context &#39;when a state is passed&#39; do
              it &#39;filters all but tasks with that state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(when a state is passed)::it#filters all but tasks with that state has a flog score of 41</span>          </div>  </li></ol>
                expected_task = Models::Task.make(
                  type: :update_deployment, state: :queued
                )
                filtered_task = Models::Task.make(
                  type: :update_deployment, state: :processing
                )
                get &#39;/?state=queued&#39;
                expect(last_response.status).to eq(200)
                actual_ids = parsed_body.map { |attributes| attributes[&#39;id&#39;] }
                actual_tasks = Models::Task.filter(id: actual_ids).to_a
                expect(actual_tasks.map(&amp;:id)).to eq([expected_task.id])
              end
            end

            context &#39;when a limit is passed&#39; do
              before do
                (1..20).map { |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L108" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L200" class="js-smell-location">1</a>                  </div>  </li></ol>
                  Models::Task.make(
                    :type =&gt; :update_deployment,
                    :state =&gt; :queued,
                  )
                }
              end

              context &#39;when the limit is less than 1&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L116" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L124" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L259" class="js-smell-location">2</a>                  </div>  </li></ol>
                it &#39;limits the tasks returned to 1&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(when a limit is passed)::context(when the limit is less than 1)::it#limits the tasks returned to 1 has a flog score of 25</span>          </div>  </li></ol>
                  get &#39;/?limit=0&#39;
                  expect(last_response.status).to eq(200)
                  expect(parsed_body.size).to eq(1)
                end
              end

              context &#39;when the limit is greater than 1&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L116" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L124" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L259" class="js-smell-location">2</a>                  </div>  </li></ol>
                it &#39;limits the tasks returned to the limit provided&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(when a limit is passed)::context(when the limit is greater than 1)::it#limits the tasks returned to the limit provided has a flog score of 25</span>          </div>  </li></ol>
                  get &#39;/?limit=10&#39;
                  expect(last_response.status).to eq(200)
                  expect(parsed_body.size).to eq(10)
                end
              end
            end

            context &#39;verbose&#39; do
              let(:concise_task_types) do
                %w[
                  attach_disk
                  create_snapshot
                  delete_deployment
                  delete_release
                  delete_snapshot
                  delete_stemcell
                  run_errand
                  snapshot_deployment
                  update_deployment
                  update_release
                  update_stemcell
                ]
              end

              let!(:all_tasks) do # one task of every type<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(verbose)::let!#all_tasks has a flog score of 32</span>          </div>  </li></ol>
                (
                Bosh::Director::Jobs.constants.inject([]) { |memo, const|
                  klass = Bosh::Director::Jobs.const_get(const)
                  if klass.ancestors.include?(Bosh::Director::Jobs::BaseJob)
                    memo &lt;&lt; klass
                  end
                  memo
                } - [Bosh::Director::Jobs::BaseJob]
                ).map(&amp;:job_type).map { |job_type|
                  Models::Task.make(type: job_type)
                }
              end

              context &#39;when verbose is set to 1&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L164" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L184" class="js-smell-location">1</a>                  </div>  </li></ol>
                it &#39;filters all but the expected task types&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(verbose)::context(when verbose is set to 1)::it#filters all but the expected task types has a flog score of 42</span>          </div>  </li></ol>
                  get &#39;/?verbose=1&#39;
                  expect(last_response.status).to eq(200)
                  actual_ids = parsed_body.map { |attributes| attributes[&#39;id&#39;] }
                  actual_tasks = Models::Task.filter(id: actual_ids).order(:id)
                  expect(actual_tasks).to match(all_tasks.select { |task| concise_task_types.include?(task.type) })
                end
              end

              context &#39;when verbose is set to 2&#39; do
                it &#39;does not filter tasks by type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(verbose)::context(when verbose is set to 2)::it#does not filter tasks by type has a flog score of 32</span>          </div>  </li></ol>
                  get &#39;/?verbose=2&#39;
                  expect(last_response.status).to eq(200)
                  actual_ids = parsed_body.map { |attributes| attributes[&#39;id&#39;] }
                  actual_tasks = Models::Task.filter(id: actual_ids).order(:id)
                  expect(actual_tasks).to match(all_tasks)
                end
              end

              context &#39;when verbose is not set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L164" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L184" class="js-smell-location">1</a>                  </div>  </li></ol>
                it &#39;filters all but the expected task types&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has admin access)::context(verbose)::context(when verbose is not set)::it#filters all but the expected task types has a flog score of 42</span>          </div>  </li></ol>
                  get &#39;/&#39;
                  expect(last_response.status).to eq(200)
                  actual_ids = parsed_body.map { |attributes| attributes[&#39;id&#39;] }
                  actual_tasks = Models::Task.filter(id: actual_ids).order(:id)

                  expect(actual_tasks).to match(all_tasks.select { |task| concise_task_types.include?(task.type) })
                end
              end
            end
          end

          context &#39;when user has readonly access&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context#when user has readonly access has a flog score of 25</span>          </div>  </li></ol>
            before do
              team_a = Models::Team.make(name: &#39;team_a&#39;)
              (1..20).map { |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L108" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L200" class="js-smell-location">1</a>                  </div>  </li></ol>
                make_task_with_team(
                  :type =&gt; :update_deployment,
                  :state =&gt; :queued,
                  :deployment_name =&gt; &quot;deployment_dev#{i%2}&quot;,
                  :teams =&gt; i%2 == 0 ? [team_a, team_rocket] : [team_rocket, dev]
                )
              }

              basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39;
            end

            it &#39;provides list of tasks of deployments you have access to&#39; do
              get &#39;/&#39;
              expect(last_response.status).to eq(200)
              expect(parsed_body.size).to eq(10)
            end
          end

          context &#39;when user has team admin permissions&#39; do
            before do
              Models::Task.make(type: &#39;update_stemcell&#39;, deployment_name: nil, teams: nil)
              make_task_with_team(type: &#39;attach_disk&#39;, deployment_name: deployment_name_1, teams: [team_rocket, dev])
            end

            before do
              basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39;
            end

            context &#39;when user does not have access to all tasks&#39; do
              before do
                10.times do
                  make_task_with_team(type: &#39;attach_disk&#39;, deployment_name: deployment_name_2, teams: [team_rocket, dev])
                  make_task_with_team(type: &#39;attach_disk&#39;, deployment_name: deployment_name_3, teams: [team_rocket])
                end
              end
              it &#39;shows the limit amount of tasks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has team admin permissions)::context(when user does not have access to all tasks)::it#shows the limit amount of tasks has a flog score of 41</span>          </div>  </li></ol>
                get &#39;/?limit=10&#39;
                expect(last_response.status).to eq(200)
                expect(parsed_body.size).to eq(10)
                expect(parsed_body.all?{ |e| e[&#39;deployment&#39;] != &#39;deployment3&#39; }).to eq(true)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'e'</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L240" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L247" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L297" class="js-smell-location">2</a>                  </div>  </li></ol>
              end

              it &#39;shows the limit amount of tasks and filter by deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has team admin permissions)::context(when user does not have access to all tasks)::it#shows the limit amount of tasks and filter by deployment has a flog score of 43</span>          </div>  </li></ol>
                get &quot;/?deployment=#{deployment_name_2}&amp;limit=11&quot;
                expect(last_response.status).to eq(200)
                expect(parsed_body.size).to eq(10)
                expect(parsed_body.all?{ |e| e[&#39;deployment&#39;] == &#39;deployment2&#39; }).to eq(true)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'e'</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L240" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L247" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L297" class="js-smell-location">2</a>                  </div>  </li></ol>
              end
            end

            context &#39;if user has access to deployment&#39; do
              it &#39;filters tasks with that deployment name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has team admin permissions)::context(if user has access to deployment)::it#filters tasks with that deployment name has a flog score of 26</span>          </div>  </li></ol>
                get &quot;/?deployment=#{deployment_name_1}&quot;
                expect(last_response.status).to eq(200)
                expect(parsed_body.size).to eq(1)
              end
            end

            context &#39;when task has empty deployment_name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L116" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L124" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L259" class="js-smell-location">2</a>                  </div>  </li></ol>
              it &#39;does not show up in the response&#39; do
                get &#39;/&#39;
                expect(last_response.status).to eq(200)
                expect(parsed_body.size).to eq(1)
              end
            end

            context &#39;when task has a deployment associated with it and the deployment has already been deleted&#39; do
              let(:prod) { Models::Team.make(name: &#39;prod&#39;)}
              it &#39;should show up in the response&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when user has team admin permissions)::context(when task has a deployment associated with it and the deployment has already been deleted)::it#should show up in the response has a flog score of 37</span>          </div>  </li></ol>
                make_task_with_team(type: &#39;update_deployment&#39;, deployment_name: &#39;deleted_deployment&#39;, teams: [team_rocket, prod])
                make_task_with_team(type: &#39;delete_deployment&#39;, deployment_name: &#39;deleted_deployment&#39;, teams: [team_rocket, dev])
                get &#39;/&#39;
                expect(last_response.status).to eq(200)

                expect(parsed_body.size).to eq(2)
              end
            end
          end

          context &#39;when context id is passed&#39; do
            before do
              Models::Task.make(type: &#39;create_snapshot&#39;, context_id: &#39;example-context-id&#39;)
              Models::Task.make(type: &#39;delete_release&#39;, context_id: &#39;example-context-id&#39;)
              Models::Task.make(type: &#39;delete_snapshot&#39;)
              Models::Task.make(type: &#39;delete_stemcell&#39;, context_id: &#39;some-other-context-id&#39;)
            end

            before do
              basic_authorize &#39;admin&#39;, &#39;admin&#39;
            end

            it &#39;only returns tasks with the same context&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(GET /)::context(when context id is passed)::it#only returns tasks with the same context has a flog score of 39</span>          </div>  </li></ol>
              context_id = &#39;example-context-id&#39;
              get &quot;/?context_id=#{context_id}&quot;
              expect(last_response.status).to eq(200)
              expect(parsed_body.size).to eq(2)
              expect(parsed_body.all?{ |e| e[&#39;context_id&#39;] == context_id }).to eq(true)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'e'</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L240" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L247" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L297" class="js-smell-location">2</a>                  </div>  </li></ol>
            end
          end
        end

        describe &#39;get task by id&#39; do
          let(:task) { Models::Task.make(state: &#39;queued&#39;, description: &#39;fake-description&#39;) }

          context &#39;user has readonly access&#39; do
            before(:each) { basic_authorize &#39;reader&#39;, &#39;reader&#39; }

            it &#39;provides access if accessing task&#39; do
              get &quot;/#{task.id}&quot;
              expect(last_response.status).to eq(200)
            end
          end

          context &#39;user has admin access&#39; do
            before(:each) { basic_authorize &#39;admin&#39;, &#39;admin&#39; }

            it &#39;has API call that return task status&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task by id)::context(user has admin access)::it#has API call that return task status has a flog score of 93</span>          </div>  </li></ol>
              task = Models::Task.make(state: &#39;queued&#39;, description: &#39;fake-description&#39;)

              get &quot;/#{task.id}&quot;
              expect(last_response.status).to eq(200)
              task_json = JSON.parse(last_response.body)
              expect(task_json[&#39;id&#39;]).to eq(task.id)
              expect(task_json[&#39;state&#39;]).to eq(&#39;queued&#39;)
              expect(task_json[&#39;description&#39;]).to eq(&#39;fake-description&#39;)

              task.state = &#39;processed&#39;
              task.save

              get &quot;/#{task.id}&quot;
              expect(last_response.status).to eq(200)
              task_json = JSON.parse(last_response.body)
              expect(task_json[&#39;id&#39;]).to eq(1)
              expect(task_json[&#39;state&#39;]).to eq(&#39;processed&#39;)
              expect(task_json[&#39;description&#39;]).to eq(&#39;fake-description&#39;)
            end

            context &#39;when the task has a context id&#39; do
              it &#39;has API call that returns task context id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task by id)::context(user has admin access)::context(when the task has a context id)::it#has API call that returns task context id has a flog score of 31</span>          </div>  </li></ol>
                context_id = &#39;example-context-id&#39;
                task = Models::Task.make(context_id: context_id)

                get &quot;/#{task.id}&quot;
                expect(last_response.status).to eq(200)
                task_json = JSON.parse(last_response.body)
                expect(task_json[&#39;context_id&#39;]).to eq context_id
              end
            end

            context &#39;user has access to task&#39; do
              let(:task) { make_task_with_team(state: &#39;queued&#39;, deployment_name: deployment_name_1, teams: [team_rocket, dev]) }

              it &#39;returns task&#39; do
                get &quot;/#{task.id}&quot;
                expect(last_response.status).to eq(200)
              end
            end

            context &#39;user does not have access to task&#39; do
              let(:task) { make_task_with_team(state: &#39;queued&#39;, deployment_name: deployment_name_1, teams: [team_rocket]) }

              it &#39;returns task&#39; do
                get &quot;/#{task.id}&quot;
                expect(last_response.status).to eq(200)
              end
            end
          end

          context &#39;user has team admin access&#39; do
            context &quot;user doesn&#39;t have access to task&quot; do
              before do
                basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39;
              end

              let(:task) { make_task_with_team(state: &#39;queued&#39;, deployment_name: deployment_name_1, :teams =&gt;[team_rocket]) }
              it &#39;returns 401&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task by id)::context(user has team admin access)::context(user doesn't have access to task)::it#returns 401 has a flog score of 31</span>          </div>  </li></ol>
                get &quot;/#{task.id}&quot;
                expect(last_response.status).to eq(401)
                expect(last_response.body).to include(&#39;bosh.teams.team-rocket.admin&#39;)
              end
            end

            context &#39;user has access to task&#39; do
              before do
                basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39;
              end

              let(:task) { make_task_with_team(state: &#39;queued&#39;, deployment_name: deployment_name_1, :teams =&gt; [team_rocket, dev]) }
              it &#39;returns 200&#39; do
                get &quot;/#{task.id}&quot;
                expect(last_response.status).to eq(200)
              end
            end
          end
        end

        describe &#39;get task output&#39; do

          context &#39;user has admin access&#39; do
            before(:each) { basic_authorize &#39;admin&#39;, &#39;admin&#39; }

            let(:task) { Models::Task.make(output: temp_dir) }
            it &#39;has API call that return task output and task output with ranges&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task output)::context(user has admin access)::it#has API call that return task output and task output with ranges has a flog score of 38</span>          </div>  </li></ol>
              output_file = File.new(File.join(temp_dir, &#39;debug&#39;), &#39;w+&#39;)
              output_file.print(&#39;Test output&#39;)
              output_file.close

              task = Models::Task.make(output: temp_dir)

              get &quot;/#{task.id}/output&quot;
              expect(last_response.status).to eq(200)
              expect(last_response.body).to eq(&#39;Test output&#39;)
            end

            it &#39;has API call that return task output with ranges&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task output)::context(user has admin access)::it#has API call that return task output with ranges has a flog score of 112</span>          </div>  </li></ol>
              output_file = File.new(File.join(temp_dir, &#39;debug&#39;), &#39;w+&#39;)
              output_file.print(&#39;Test output&#39;)
              output_file.close

              # Range test
              get &quot;/#{task.id}/output&quot;, {}, {&#39;HTTP_RANGE&#39; =&gt; &#39;bytes=0-3&#39;}
              expect(last_response.status).to eq(206)
              expect(last_response.body).to eq(&#39;Test&#39;)
              expect(last_response.headers[&#39;Content-Length&#39;]).to eq(&#39;4&#39;)
              expect(last_response.headers[&#39;Content-Range&#39;]).to eq(&#39;bytes 0-3/11&#39;)

              # Range test
              get &quot;/#{task.id}/output&quot;, {}, {&#39;HTTP_RANGE&#39; =&gt; &#39;bytes=5-&#39;}
              expect(last_response.status).to eq(206)
              expect(last_response.body).to eq(&#39;output&#39;)
              expect(last_response.headers[&#39;Content-Length&#39;]).to eq(&#39;6&#39;)
              expect(last_response.headers[&#39;Content-Range&#39;]).to eq(&#39;bytes 5-10/11&#39;)
            end

            it &#39;has API call that return task output from db with ranges&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task output)::context(user has admin access)::it#has API call that return task output from db with ranges has a flog score of 101</span>          </div>  </li></ol>
              task1 = Models::Task.make(state: &#39;queued&#39;, description: &#39;fake-description&#39;, event_output: &quot;Test output&quot;, output: &quot;something&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'task1'</span>          </div>  </li></ol>

              # Range test
              get &quot;/#{task1.id}/output?type=event&quot;, {}, {&#39;HTTP_RANGE&#39; =&gt; &#39;bytes=0-3&#39;}
              expect(last_response.status).to eq(206)
              expect(last_response.body).to eq(&#39;Test&#39;)
              expect(last_response.headers[&#39;Content-Length&#39;]).to eq(&#39;4&#39;)
              expect(last_response.headers[&#39;Content-Range&#39;]).to eq(&#39;bytes 0-3/11&#39;)

              # Range test
              get &quot;/#{task1.id}/output?type=event&quot;, {}, {&#39;HTTP_RANGE&#39; =&gt; &#39;bytes=5-&#39;}
              expect(last_response.status).to eq(206)
              expect(last_response.body).to eq(&#39;output&#39;)
              expect(last_response.headers[&#39;Content-Length&#39;]).to eq(&#39;6&#39;)
              expect(last_response.headers[&#39;Content-Range&#39;]).to eq(&#39;bytes 5-10/11&#39;)
            end

            it &#39;supports returning different types of output (debug, cpi, event, result) from file&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task output)::context(user has admin access)::it(supports returning different types of output (debug, cpi, event, result) from file)#supports returning different types of output (debug, cpi, event, result) from file has a flog score of 73</span>          </div>  </li></ol>
              %w(debug event cpi result).each do |log_type|
                output_file = File.new(File.join(temp_dir, log_type), &#39;w+&#39;)
                output_file.print(&quot;Test output #{log_type}&quot;)
                output_file.close
              end

              task = Models::Task.new
              task.state = &#39;done&#39;
              task.type = :update_deployment
              task.timestamp = Time.now
              task.description = &#39;description&#39;
              task.output = temp_dir
              task.save

              %w(debug event cpi result).each do |log_type|
                get &quot;/#{task.id}/output?type=#{log_type}&quot;
                expect(last_response.status).to eq(200)
                expect(last_response.body).to eq(&quot;Test output #{log_type}&quot;)
              end

              # Default output is debug
              get &quot;/#{task.id}/output&quot;
              expect(last_response.status).to eq(200)
              expect(last_response.body).to eq(&#39;Test output debug&#39;)
            end

            it &#39;supports returning different types of output (event, result) from db&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(get task output)::context(user has admin access)::it(supports returning different types of output (event, result) from db)#supports returning different types of output (event, result) from db has a flog score of 39</span>          </div>  </li></ol>
              task = Models::Task.new
              task.state = &#39;done&#39;
              task.type = :update_deployment
              task.timestamp = Time.now
              task.description = &#39;description&#39;
              task.output = temp_dir
              task.result_output = &#39;Test output result from db&#39;
              task.event_output = &#39;Test output event from db&#39;
              task.save

              %w(event result).each do |log_type|
                get &quot;/#{task.id}/output?type=#{log_type}&quot;
                expect(last_response.status).to eq(200)
                expect(last_response.body).to eq(&quot;Test output #{log_type} from db&quot;)
              end
            end

            context &quot;task&#39;s deployment doesn&#39;t exist&quot; do
              let(:task) { Models::Task.make(output: temp_dir, deployment_name: &#39;deleted&#39;) }
              it &#39;gets task output&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
                get &quot;/#{task.id}/output&quot;
                expect(last_response.status).to eq(204)
              end
            end
            context &#39;task has no deployment&#39; do
              it &#39;gets task output&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
                get &quot;/#{task.id}/output&quot;
                expect(last_response.status).to eq(204)
              end
            end
          end

          context &#39;user has readonly access&#39; do

            before(:each) { basic_authorize &#39;reader&#39;, &#39;reader&#39; }

            let(:task) { Models::Task.make(state: &#39;queued&#39;, description: &#39;fake-description&#39;, event_output: &quot;Test output&quot;) }

            it &#39;returns 401 for empty output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
              get &quot;/#{task.id}/output&quot;
              expect(last_response.status).to eq(401)
            end

            it &#39;returns 401 for debug output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
              get &quot;/#{task.id}/output?type=debug&quot;
              expect(last_response.status).to eq(401)
            end

            it &#39;returns 401 for cpi output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
              get &quot;/#{task.id}/output?type=cpi&quot;
              expect(last_response.status).to eq(401)
            end

            it &#39;provides access for event output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
              get &quot;/#{task.id}/output?type=event&quot;
              expect(last_response.status).to eq(204)
            end

            it &#39;provides access for result output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
              get &quot;/#{task.id}/output?type=result&quot;
              expect(last_response.status).to eq(204)
            end
          end

          context &#39;user has team admin access&#39; do
            let(:task_1) do
              make_task_with_team(
                type: :update_deployment,
                state: :queued,
                deployment_name: deployment_name_1,
                teams: [team_rocket, dev],
              )
            end
            let(:task_2) do
              make_task_with_team(
                type: :update_deployment,
                state: :queued,
                deployment_name: deployment_name_2,
                teams: [team_rocket],
              )
            end
            let(:task_deleted) do
              Models::Task.make(type: :update_deployment, state: :queued, deployment_name: &#39;deleted&#39;,)
            end

            let(:task_no_deployment) { Models::Task.make(type: :update_deployment, state: :queued) }

            before(:each) do
              Models::Deployment.create_with_teams(:name =&gt; deployment_name_1,
                :teams =&gt; [team_rocket, dev]
              )
              Models::Deployment.create_with_teams(:name =&gt; deployment_name_2,
                :teams =&gt; [team_rocket]
              )
              basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39;
            end

            context &quot;user has access to task&#39;s deployment&quot; do
              it &#39;has access to debug output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
                get &quot;/#{task_1.id}/output?type=debug&quot;
                expect(last_response.status).to eq(204)
              end
              it &#39;has access to cpi output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
                get &quot;/#{task_1.id}/output?type=cpi&quot;
                expect(last_response.status).to eq(204)
              end
              it &#39;has access to event output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
                get &quot;/#{task_1.id}/output?type=event&quot;
                expect(last_response.status).to eq(204)
              end
              it &#39;has access to result output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
                get &quot;/#{task_1.id}/output?type=result&quot;
                expect(last_response.status).to eq(204)
              end
              it &#39;has access to no type output type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 12 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L500" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L506" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L519" class="js-smell-location">2</a>                  <a href="tasks_controller_spec.html#L524" class="js-smell-location">3</a>                  <a href="tasks_controller_spec.html#L529" class="js-smell-location">4</a>                  <a href="tasks_controller_spec.html#L534" class="js-smell-location">5</a>                  <a href="tasks_controller_spec.html#L539" class="js-smell-location">6</a>                  <a href="tasks_controller_spec.html#L579" class="js-smell-location">7</a>                  <a href="tasks_controller_spec.html#L583" class="js-smell-location">8</a>                  <a href="tasks_controller_spec.html#L587" class="js-smell-location">9</a>                  <a href="tasks_controller_spec.html#L591" class="js-smell-location">10</a>                  <a href="tasks_controller_spec.html#L595" class="js-smell-location">11</a>                  </div>  </li></ol>
                get &quot;/#{task_1.id}/output&quot;
                expect(last_response.status).to eq(204)
              end
            end
            context &quot;user doesn&#39;t have access to task&#39;s deployment&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L600" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L608" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L616" class="js-smell-location">2</a>                  </div>  </li></ol>
              it &#39;returns 401 for every task type&#39; do
                [&#39;debug&#39;, &#39;cpi&#39;, &#39;event&#39;, &#39;result&#39;, &#39;&#39;].each do |type|
                  get &quot;/#{task_2.id}/output?type=#{type}&quot;
                  expect(last_response.status).to eq(401)
                end
              end
            end
            context &#39;if deployment got deleted&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L600" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L608" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L616" class="js-smell-location">2</a>                  </div>  </li></ol>
              it &#39;returns 401 for every task type&#39; do
                [&#39;debug&#39;, &#39;cpi&#39;, &#39;event&#39;, &#39;result&#39;, &#39;&#39;].each do |type|
                  get &quot;/#{task_deleted.id}/output?type=#{type}&quot;
                  expect(last_response.status).to eq(401)
                end
              end
            end
            context &#39;if task has no deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="tasks_controller_spec.html#L600" class="js-smell-location">0</a>                  <a href="tasks_controller_spec.html#L608" class="js-smell-location">1</a>                  <a href="tasks_controller_spec.html#L616" class="js-smell-location">2</a>                  </div>  </li></ol>
              it &#39;returns 401 for every task type&#39; do
                [&#39;debug&#39;, &#39;cpi&#39;, &#39;event&#39;, &#39;result&#39;, &#39;&#39;].each do |type|
                  get &quot;/#{task_no_deployment.id}/output?type=#{type}&quot;
                  expect(last_response.status).to eq(401)
                end
              end
            end
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../../assets/javascripts/application.js'></script>
    <script src='../../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
