<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-director/spec/unit /</small> disk_manager_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">661</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">93</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2128.7</span><small> complexity</small></div>
              <div><span class="metric">290</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                39
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe Bosh::Director::DiskManager do
    subject(:disk_manager) { DiskManager.new(logger) }

    let(:cloud) { instance_double(Bosh::Clouds::ExternalCpi) }
    let(:enable_cpi_resize_disk) { false }
    let(:cloud_factory) { instance_double(CloudFactory) }
    let(:instance_plan) do
      DeploymentPlan::InstancePlan.new(existing_instance: instance_model,
                                       desired_instance: DeploymentPlan::DesiredInstance.new(instance_group),
                                       instance: instance,
                                       network_plans: [],
                                       tags: tags)
    end
    let(:tags) do
      { &#39;tags&#39; =&gt; { &#39;mytag&#39; =&gt; &#39;myvalue&#39; } }
    end

    let(:job_persistent_disk_size) { 1024 }
    let(:instance_group) do
      instance_group = DeploymentPlan::InstanceGroup.new(logger)
      instance_group.name = &#39;job-name&#39;
      instance_group.persistent_disk_collection = DeploymentPlan::PersistentDiskCollection.new(logger)
      instance_group.persistent_disk_collection.add_by_disk_type(disk_type)
      instance_group
    end
    let(:disk_type) { DeploymentPlan::DiskType.new(&#39;disk-name&#39;, job_persistent_disk_size, cloud_properties) }
    let(:deployment_model) { Models::Deployment.make(name: &#39;dep1&#39;) }
    let(:instance) { DeploymentPlan::Instance.create_from_instance_group(instance_group, 1, &#39;started&#39;, deployment_model, {}, nil, logger) }
    let(:instance_model) do
      instance = Models::Instance.make(uuid: &#39;my-uuid-1&#39;, availability_zone: &#39;az1&#39;, variable_set_id: 10)
      Models::Vm.make(cid: &#39;vm234&#39;, instance_id: instance.id, active: true, cpi: &#39;my-cpi&#39;)
      instance.add_persistent_disk(persistent_disk) if persistent_disk
      instance
    end

    let(:persistent_disk) { Models::PersistentDisk.make(disk_cid: &#39;disk123&#39;, size: 2048, name: disk_name, cloud_properties: cloud_properties, active: true, cpi: &#39;my-cpi&#39;) }
    let(:cloud_properties) do
      { &#39;cloud&#39; =&gt; &#39;properties&#39; }
    end
    let(:disk_name) { &#39;&#39; }
    let(:agent_client) { instance_double(Bosh::Director::AgentClient) }

    let(:event_manager) { Api::EventManager.new(true) }
    let(:task_id) { 42 }
    let(:update_job) { instance_double(Bosh::Director::Jobs::UpdateDeployment, username: &#39;user&#39;, task_id: task_id, event_manager: event_manager) }

    before do
      instance.bind_existing_instance_model(instance_model)
      allow(AgentClient).to receive(:with_agent_id).with(instance_model.agent_id).and_return(agent_client)
      allow(agent_client).to receive(:list_disk).and_return([&#39;disk123&#39;])
      allow(cloud).to receive(:create_disk).and_return(&#39;new-disk-cid&#39;)
      allow(cloud).to receive(:resize_disk)
      allow(cloud).to receive(:attach_disk)
      allow(cloud).to receive(:detach_disk)
      allow(agent_client).to receive(:stop)
      allow(agent_client).to receive(:mount_disk)
      allow(agent_client).to receive(:wait_until_ready)
      allow(agent_client).to receive(:migrate_disk)
      allow(agent_client).to receive(:unmount_disk)
      allow(agent_client).to receive(:update_settings)
      allow(Config).to receive(:current_job).and_return(update_job)
      allow(Config).to receive(:enable_cpi_resize_disk).and_return(enable_cpi_resize_disk)
      allow(CloudFactory).to receive(:create).and_return(cloud_factory)
    end

    describe &#39;#attach_disk&#39; do
      let(:attach_step) { instance_double(DeploymentPlan::Steps::AttachDiskStep, perform: nil) }
      let(:tags) do
        {}
      end

      before do
        allow(DeploymentPlan::Steps::AttachDiskStep).to receive(:new)
          .with(persistent_disk, tags).and_return(attach_step)
      end

      context &#39;managed disks&#39; do
        it &#39;attaches + mounts disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#attach_disk)::context(managed disks)::it#attaches + mounts disk has a flog score of 30</span>          </div>  </li></ol>
          expect(attach_step).to receive(:perform)
          expect(agent_client).to receive(:wait_until_ready)
          expect(agent_client).to receive(:mount_disk).with(&#39;disk123&#39;)
          disk_manager.attach_disk(persistent_disk, tags)
        end
      end

      context &#39;unmanaged disks&#39; do
        it &#39;attaches the disk without mounting&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#attach_disk)::context(unmanaged disks)::it#attaches the disk without mounting has a flog score of 25</span>          </div>  </li></ol>
          persistent_disk.update(name: &#39;chewbacca&#39;)
          expect(attach_step).to receive(:perform)
          expect(agent_client).to_not receive(:mount_disk)
          disk_manager.attach_disk(persistent_disk, tags)
        end
      end

      context &#39;when tags are set&#39; do
        let(:tags) do
          { &#39;mytag&#39; =&gt; &#39;myvalue&#39; }
        end

        it &#39;passes tags to attach step&#39; do
          expect(attach_step).to receive(:perform)
          disk_manager.attach_disk(persistent_disk, tags)
        end
      end
    end

    describe &#39;#detach_disk&#39; do
      context &#39;managed disks&#39; do
        it &#39;unmounts + detaches disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#detach_disk)::context(managed disks)::it#unmounts + detaches disk has a flog score of 44</span>          </div>  </li></ol>
          expect(cloud_factory).to receive(:get).with(persistent_disk.cpi, nil).once.and_return(cloud)
          expect(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
          expect(agent_client).to receive(:unmount_disk).with(&#39;disk123&#39;)
          disk_manager.detach_disk(persistent_disk)
        end
      end

      context &#39;unmanaged disks&#39; do
        it &#39;detaches the disk without unmounting&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#detach_disk)::context(unmanaged disks)::it#detaches the disk without unmounting has a flog score of 45</span>          </div>  </li></ol>
          persistent_disk.update(name: &#39;chewbacca&#39;)
          expect(cloud_factory).to receive(:get).with(persistent_disk.cpi, nil).at_least(:once).and_return(cloud)
          expect(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
          expect(agent_client).to_not receive(:unmount_disk)
          disk_manager.detach_disk(persistent_disk)
        end
      end
    end

    describe &#39;#update_persistent_disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe##update_persistent_disk has a flog score of 30</span>          </div>  </li></ol>
      before do
        allow(cloud_factory).to receive(:get).with(&#39;my-cpi&#39;, nil).and_return(cloud)
        allow(cloud_factory).to receive(:get).with(&#39;my-cpi&#39;).and_return(cloud)
      end

      it &#39;passes correct variable sets for comparing disks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::it#passes correct variable sets for comparing disks has a flog score of 33</span>          </div>  </li></ol>
        desired_variable_set = Models::VariableSet.make(deployment: deployment_model)
        instance_plan.instance.desired_variable_set = desired_variable_set

        expect(Bosh::Director::DeploymentPlan::PersistentDiskCollection).to receive(:changed_disk_pairs).with(
          anything,
          instance_plan.instance.previous_variable_set,
          anything,
          desired_variable_set,
        ).and_return([])

        disk_manager.update_persistent_disk(instance_plan)
      end

      context &#39;when `enable_cpi_disk_resize` is enabled&#39; do
        let(:enable_cpi_resize_disk) { true }
        let(:job_persistent_disk_size) { 4096 }

        context &#39;when only disk size has changed&#39; do
          context &#39;when it is a managed disk&#39; do
            it &#39;resizes the disk via CPI&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when `enable_cpi_disk_resize` is enabled)::context(when only disk size has changed)::context(when it is a managed disk)::it#resizes the disk via CPI has a flog score of 55</span>          </div>  </li></ol>
              disk_manager.update_persistent_disk(instance_plan)

              expect(agent_client).to have_received(:unmount_disk)
              expect(cloud).to have_received(:detach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
              expect(cloud).to have_received(:resize_disk).with(&#39;disk123&#39;, 4096)
              expect(cloud).to have_received(:attach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
              expect(agent_client).to have_received(:mount_disk)
            end

            it &#39;updates the old disk in the db&#39; do
              disk_manager.update_persistent_disk(instance_plan)

              model = Models::PersistentDisk.where(disk_cid: &#39;disk123&#39;).first
              expect(model.size).to eq(job_persistent_disk_size)
            end
          end

          context &#39;when the new disk is unmanaged&#39; do
            let(:instance_group) do
              instance_group = DeploymentPlan::InstanceGroup.new(logger)
              instance_group.name = &#39;job-name&#39;
              instance_group.persistent_disk_collection = DeploymentPlan::PersistentDiskCollection.new(logger)
              instance_group.persistent_disk_collection.add_by_disk_name_and_type(&#39;unmanaged-disk-name&#39;, disk_type)
              instance_group
            end

            context &#39;when the old disk is unmanaged&#39; do
              let(:disk_name) { &#39;unmanaged-disk-name&#39; }

              it &#39;does not use cpi resize_disk&#39; do
                disk_manager.update_persistent_disk(instance_plan)

                expect(cloud).to_not have_received(:resize_disk)
              end
            end

            context &#39;when the old disk is managed&#39; do
              let(:disk_name) { &#39;&#39; }

              it &#39;does not use cpi resize_disk&#39; do
                expect do
                  disk_manager.update_persistent_disk(instance_plan)
                end.not_to raise_error

                expect(cloud).to_not have_received(:resize_disk)
              end
            end
          end
        end

        context &#39;when resize_disk is not implemented&#39; do
          it &#39;falls back to manually copying disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L209" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L225" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when `enable_cpi_disk_resize` is enabled)::context(when resize_disk is not implemented)::it#falls back to manually copying disk has a flog score of 63</span>          </div>  </li></ol>
            allow(cloud).to receive(:resize_disk).and_raise(Bosh::Clouds::NotImplemented)

            disk_manager.update_persistent_disk(instance_plan)

            expect(cloud).to have_received(:detach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;).twice
            expect(cloud).to have_received(:resize_disk)
            expect(cloud).to have_received(:create_disk).with(4096, { &#39;cloud&#39; =&gt; &#39;properties&#39; }, &#39;vm234&#39;)
            expect(cloud).to have_received(:attach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
            expect(cloud).to have_received(:attach_disk).with(&#39;vm234&#39;, &#39;new-disk-cid&#39;)
          end
        end

        context &#39;when resize_disk is not supported&#39; do
          let(:job_persistent_disk_size) { 512 }

          it &#39;falls back to manually copying disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L209" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L225" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when `enable_cpi_disk_resize` is enabled)::context(when resize_disk is not supported)::it#falls back to manually copying disk has a flog score of 66</span>          </div>  </li></ol>
            allow(cloud).to receive(:resize_disk).and_raise(Bosh::Clouds::NotSupported)

            disk_manager.update_persistent_disk(instance_plan)

            expect(cloud).to have_received(:detach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;).twice
            expect(cloud).to have_received(:resize_disk)
            expect(cloud).to have_received(:create_disk).with(512, { &#39;cloud&#39; =&gt; &#39;properties&#39; }, &#39;vm234&#39;)
            expect(cloud).to have_received(:attach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
            expect(cloud).to have_received(:attach_disk).with(&#39;vm234&#39;, &#39;new-disk-cid&#39;)
          end
        end
      end

      context &#39;when disk creation fails&#39; do
        context &#39;with NoDiskSpaceError&#39; do
          let(:error) { Bosh::Clouds::NoDiskSpace.new(true) }

          it &#39;should raise the error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L243" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L255" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when disk creation fails)::context(with NoDiskSpaceError)::it#should raise the error has a flog score of 26</span>          </div>  </li></ol>
            expect(cloud).to receive(:create_disk).and_raise(error)
            expect do
              disk_manager.update_persistent_disk(instance_plan)
            end.to raise_error error
          end
        end
      end

      context &#39;when disk creation succeeds, but there is a NoDiskSpaceError during attach_disk&#39; do
        let(:error) { Bosh::Clouds::NoDiskSpace.new(false) }

        it &#39;orphans the disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L243" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L255" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when disk creation succeeds, but there is a NoDiskSpaceError during attach_disk)::it#orphans the disk has a flog score of 26</span>          </div>  </li></ol>
          expect(cloud).to receive(:attach_disk).and_raise(error)

          expect do
            disk_manager.update_persistent_disk(instance_plan)
          end.to raise_error error
        end
      end

      context &#39;when the agent reports a different disk cid from the model&#39; do
        before do
          allow(agent_client).to receive(:list_disk).and_return([&#39;random-disk-cid&#39;])
        end

        context &#39;when uuid has not been set&#39; do
          it &#39;raises&#39; do
            expect do
              disk_manager.update_persistent_disk(instance_plan)
            end.to raise_error AgentDiskOutOfSync, &quot;&#39;job-name/my-uuid-1 (1)&#39; has invalid disks: agent reports &#39;random-disk-cid&#39; while director record shows &#39;disk123&#39;&quot;
          end
        end

        context &#39;when uuid has been set&#39; do
          let(:instance_plan) do
            instance_model.uuid = &#39;123-456-789&#39;
            instance = DeploymentPlan::Instance.create_from_instance_group(instance_group, 1, &#39;started&#39;, nil, {}, nil, logger)
            instance.bind_existing_instance_model(instance_model)

            DeploymentPlan::InstancePlan.new(existing_instance: instance_model,
                                             desired_instance: DeploymentPlan::DesiredInstance.new(instance_group),
                                             instance: instance,
                                             network_plans: [])
          end

          it &#39;raises&#39; do
            expect do
              disk_manager.update_persistent_disk(instance_plan)
            end.to raise_error AgentDiskOutOfSync, &quot;&#39;job-name/123-456-789 (1)&#39; has invalid disks: agent reports &#39;random-disk-cid&#39; while director record shows &#39;disk123&#39;&quot;
          end
        end
      end

      context &#39;when the agent reports a disk cid consistent with the model&#39; do
        let!(:inactive_disk) do
          Models::PersistentDisk.make(
            disk_cid: &#39;inactive-disk&#39;,
            active: false,
            instance: instance_model,
            size: 54,
            cloud_properties: { &#39;cloud-props&#39; =&gt; &#39;something&#39; },
            cpi: &#39;my-cpi&#39;,
          )
        end

        it &#39;logs when the disks are inactive&#39; do
          expect(logger).to receive(:warn).with(&quot;&#39;job-name/my-uuid-1 (1)&#39; has inactive disk inactive-disk&quot;)
          disk_manager.update_persistent_disk(instance_plan)
        end

        it &#39;stores events&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::it#stores events has a flog score of 164</span>          </div>  </li></ol>
          expect do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="api/task_remover_spec.html#L159" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L315" class="js-smell-location">1</a>                  <a href="orphan_disk_manager_spec.html#L86" class="js-smell-location">2</a>                  </div>  </li></ol>
            disk_manager.update_persistent_disk(instance_plan)
          end.to change {
            Bosh::Director::Models::Event.count
          }.from(0).to(6)

          event1 = Bosh::Director::Models::Event.first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'event1'</span>          </div>  </li></ol>
          expect(event1.user).to eq(&#39;user&#39;)
          expect(event1.action).to eq(&#39;create&#39;)
          expect(event1.object_type).to eq(&#39;disk&#39;)
          expect(event1.object_name).to eq(nil)
          expect(event1.task).to eq(task_id.to_s)
          expect(event1.deployment).to eq(instance_model.deployment.name)
          expect(event1.instance).to eq(instance_model.name)

          event2 = Bosh::Director::Models::Event.order(:id)[2]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'event2'</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L330" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L347" class="js-smell-location">1</a>                  </div>  </li></ol>
          expect(event2.parent_id).to eq(1)
          expect(event2.user).to eq(&#39;user&#39;)
          expect(event2.action).to eq(&#39;create&#39;)
          expect(event2.object_type).to eq(&#39;disk&#39;)
          expect(event2.object_name).to eq(&#39;new-disk-cid&#39;)
          expect(event2.task).to eq(task_id.to_s)
          expect(event2.deployment).to eq(instance_model.deployment.name)
          expect(event2.instance).to eq(instance_model.name)
        end

        it &#39;stores events with error information&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::it#stores events with error information has a flog score of 33</span>          </div>  </li></ol>
          allow(cloud).to receive(:create_disk).and_raise(Exception, &#39;error&#39;)
          expect do
            disk_manager.update_persistent_disk(instance_plan)
          end.to raise_error Exception, &#39;error&#39;

          event2 = Bosh::Director::Models::Event.order(:id)[2]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'event2'</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L330" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L347" class="js-smell-location">1</a>                  </div>  </li></ol>
          expect(event2.error).to eq(&#39;error&#39;)
        end

        context &#39;when the persistent disk is changed&#39; do
          before { expect(instance_plan.persistent_disk_changed?).to be_truthy }

          context &#39;when the instance group has persistent disk type and the disk type is non zero&#39; do
            it &#39;calls to the cpi to create the disk specified by the job&#39; do
              expect(cloud).to receive(:create_disk).with(1024, { &#39;cloud&#39; =&gt; &#39;properties&#39; }, &#39;vm234&#39;).and_return(&#39;new-disk-cid&#39;)
              disk_manager.update_persistent_disk(instance_plan)
            end

            it &#39;creates a persistent disk record&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::it#creates a persistent disk record has a flog score of 32</span>          </div>  </li></ol>
              disk_manager.update_persistent_disk(instance_plan)
              model = Models::PersistentDisk.where(instance_id: instance_model.id, size: 1024).first
              expect(model.cloud_properties).to eq(&#39;cloud&#39; =&gt; &#39;properties&#39;)
              expect(model.cpi).to eq(&#39;my-cpi&#39;)
            end

            it &#39;attaches the disk to the vm&#39; do
              expect(cloud).to receive(:attach_disk).with(&#39;vm234&#39;, &#39;new-disk-cid&#39;)
              disk_manager.update_persistent_disk(instance_plan)
            end

            context &#39;when the new disk fails to attach with no disk space error&#39; do
              let(:no_space) { Bosh::Clouds::NoDiskSpace.new(true) }

              before do
                expect(cloud).to receive(:attach_disk).with(&#39;vm234&#39;, &#39;new-disk-cid&#39;).once.and_raise(no_space)
              end

              it &#39;raises the error&#39; do
                expect do
                  disk_manager.update_persistent_disk(instance_plan)
                end.to raise_error no_space
              end
            end

            context &#39;when the disk is managed&#39; do
              it &#39;does not associate managed disk models&#39; do
                expect(agent_client).to_not receive(:update_settings)
              end

              it &#39;mounts the new disk&#39; do
                expect(agent_client).to receive(:mount_disk).with(&#39;new-disk-cid&#39;)
                disk_manager.update_persistent_disk(instance_plan)
              end

              context &#39;where there is an old disk to migrate&#39; do
                it &#39;migrates the disk&#39; do
                  expect(agent_client).to receive(:migrate_disk).with(&#39;disk123&#39;, &#39;new-disk-cid&#39;)
                  disk_manager.update_persistent_disk(instance_plan)
                end
              end

              context &#39;when there is no old disk to migrate&#39; do
                let(:persistent_disk) { nil }

                before do
                  allow(agent_client).to receive(:list_disk).and_return([])
                end

                it &#39;does not attempt to migrate the disk&#39; do
                  expect(agent_client).to_not receive(:migrate_disk)
                  disk_manager.update_persistent_disk(instance_plan)
                end

                it &#39;mounts the new disk&#39; do
                  expect(agent_client).to receive(:mount_disk).with(&#39;new-disk-cid&#39;)
                  disk_manager.update_persistent_disk(instance_plan)
                end
              end

              context &#39;mounting and migrating to the new disk&#39; do
                let(:disk_error) { StandardError.new }

                context &#39;when mounting and migrating disks succeeds&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context#when mounting and migrating disks succeeds has a flog score of 28</span>          </div>  </li></ol>
                  before do
                    allow(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;new-disk-cid&#39;)
                    allow(agent_client).to receive(:list_disk).and_return([&#39;disk123&#39;, &#39;new-disk-cid&#39;])
                  end

                  it &#39;switches active disks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context(when mounting and migrating disks succeeds)::it#switches active disks has a flog score of 27</span>          </div>  </li></ol>
                    disk_manager.update_persistent_disk(instance_plan)
                    expect(Models::PersistentDisk.where(instance_id: instance_model.id, disk_cid: &#39;new-disk-cid&#39;, active: true).first).to_not be_nil
                  end

                  context &#39;when switching active disk succeeds&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context(when mounting and migrating disks succeeds)::context#when switching active disk succeeds has a flog score of 37</span>          </div>  </li></ol>
                    let(:snapshot) { Models::Snapshot.make }
                    before do
                      persistent_disk.add_snapshot(snapshot)
                      allow(agent_client).to receive(:unmount_disk).with(&#39;disk123&#39;)
                      allow(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
                    end

                    it &#39;orphans the old mounted disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context(when mounting and migrating disks succeeds)::context(when switching active disk succeeds)::it#orphans the old mounted disk has a flog score of 46</span>          </div>  </li></ol>
                      expect(agent_client).to receive(:unmount_disk).with(&#39;disk123&#39;)
                      expect(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)

                      disk_manager.update_persistent_disk(instance_plan)

                      expect(Models::PersistentDisk.where(disk_cid: &#39;disk123&#39;).first).to be_nil
                    end

                    it &#39;orphans additional inactive disks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context(when mounting and migrating disks succeeds)::context(when switching active disk succeeds)::it#orphans additional inactive disks has a flog score of 121</span>          </div>  </li></ol>
                      expect(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;inactive-disk&#39;)

                      disk_manager.update_persistent_disk(instance_plan)
                      expect(Models::PersistentDisk.where(disk_cid: &#39;inactive-disk&#39;).first).to be_nil

                      orphan_disk = Models::OrphanDisk.where(disk_cid: &#39;inactive-disk&#39;).first
                      expect(orphan_disk.size).to eq(54)
                      expect(orphan_disk.availability_zone).to eq(instance_model.availability_zone)
                      expect(orphan_disk.deployment_name).to eq(instance_model.deployment.name)
                      expect(orphan_disk.instance_name).to eq(&quot;#{instance_model.job}/#{instance_model.uuid}&quot;)
                      expect(orphan_disk.cloud_properties).to eq(&#39;cloud-props&#39; =&gt; &#39;something&#39;)
                      expect(orphan_disk.cpi).to eq(&#39;my-cpi&#39;)
                    end
                  end
                end

                context &#39;when mounting the disk raises&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context#when mounting the disk raises has a flog score of 34</span>          </div>  </li></ol>
                  before do
                    allow(agent_client).to receive(:list_disk).and_return([&#39;disk123&#39;])
                    expect(agent_client).to receive(:mount_disk).with(&#39;new-disk-cid&#39;).and_raise(disk_error)
                  end

                  it &#39;detaches the disk and re-raises the error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context(when mounting the disk raises)::it#detaches the disk and re-raises the error has a flog score of 40</span>          </div>  </li></ol>
                    expect(agent_client).to_not receive(:unmount_disk)
                    expect(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;new-disk-cid&#39;)
                    expect do
                      disk_manager.update_persistent_disk(instance_plan)
                    end.to raise_error disk_error
                  end
                end

                context &#39;when migrating the disk raises&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context#when migrating the disk raises has a flog score of 46</span>          </div>  </li></ol>
                  before do
                    allow(agent_client).to receive(:list_disk).and_return([&#39;disk123&#39;, &#39;new-disk-cid&#39;])
                    allow(agent_client).to receive(:mount_disk).with(&#39;new-disk-cid&#39;)
                    expect(agent_client).to receive(:migrate_disk).with(&#39;disk123&#39;, &#39;new-disk-cid&#39;).and_raise(disk_error)
                  end

                  it &#39;deletes the disk and re-raises the error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when the agent reports a disk cid consistent with the model)::context(when the persistent disk is changed)::context(when the instance group has persistent disk type and the disk type is non zero)::context(when the disk is managed)::context(mounting and migrating to the new disk)::context(when migrating the disk raises)::it#deletes the disk and re-raises the error has a flog score of 54</span>          </div>  </li></ol>
                    expect(agent_client).to receive(:unmount_disk).with(&#39;new-disk-cid&#39;)
                    expect(cloud).to receive(:detach_disk).with(&#39;vm234&#39;, &#39;new-disk-cid&#39;)
                    expect do
                      disk_manager.update_persistent_disk(instance_plan)
                    end.to raise_error disk_error
                    expect(Models::PersistentDisk.where(disk_cid: &#39;new-disk-cid&#39;).all).to eq([])
                  end
                end
              end
            end
          end
        end

        context &#39;when the persistent disk has not changed&#39; do
          let(:job_persistent_disk_size) { 2048 }

          before do
            expect(instance_plan.persistent_disk_changed?).to_not be_truthy
          end

          it &#39;does not migrate the disk&#39; do
            expect(cloud).to_not receive(:create_disk)
            disk_manager.update_persistent_disk(instance_plan)
          end
        end
      end

      context &#39;when agent reports no disks attached&#39; do
        before do
          allow(agent_client).to receive(:list_disk).and_return([])
        end

        context &#39;when we no longer need disk&#39; do
          let(:instance_group) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L525" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L647" class="js-smell-location">1</a>                  </div>  </li></ol>
            instance_group = DeploymentPlan::InstanceGroup.new(logger)
            instance_group.name = &#39;job-name&#39;
            instance_group.persistent_disk_collection = DeploymentPlan::PersistentDiskCollection.new(logger)
            instance_group
          end

          it &#39;orphans disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when agent reports no disks attached)::context(when we no longer need disk)::it#orphans disk has a flog score of 58</span>          </div>  </li></ol>
            expect(Models::PersistentDisk.all.size).to eq(1)
            expect(Models::OrphanDisk.all.size).to eq(0)

            disk_manager.update_persistent_disk(instance_plan)

            expect(Models::PersistentDisk.all.size).to eq(0)
            expect(Models::OrphanDisk.all.size).to eq(1)
            expect(Models::OrphanDisk.first.disk_cid).to eq(&#39;disk123&#39;)
          end
        end

        context &#39;when we still need disk&#39; do
          let(:job_persistent_disk_size) { 100 }

          it &#39;raises&#39; do
            expect do
              disk_manager.update_persistent_disk(instance_plan)
            end.to raise_error AgentDiskOutOfSync, &quot;&#39;job-name/my-uuid-1 (1)&#39; has invalid disks: agent reports &#39;&#39; while director record shows &#39;disk123&#39;&quot;
          end
        end
      end

      context &#39;when instance has no persistent disk&#39; do
        let(:persistent_disk) { nil }

        it &#39;does not raise&#39; do
          expect do
            disk_manager.update_persistent_disk(instance_plan)
          end.not_to raise_error
        end
      end

      context &#39;when cloud properties has placeholders&#39; do
        let(:client_factory) { double(Bosh::Director::ConfigServer::ClientFactory) }
        let(:config_server_client) { double(Bosh::Director::ConfigServer::ConfigServerClient) }

        let(:cloud_properties) do
          { &#39;cloud&#39; =&gt; &#39;((cloud_placeholder))&#39; }
        end
        let(:interpolated_cloud_properties) do
          { &#39;cloud&#39; =&gt; &#39;unicorns&#39; }
        end

        let(:desired_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="config_server/variables_interpolator_spec.html#L10" class="js-smell-location">0</a>                  <a href="disk/persistent_disk_comparators_spec.html#L8" class="js-smell-location">1</a>                  <a href="disk_manager_spec.html#L578" class="js-smell-location">2</a>                  </div>  </li></ol>
          allow(Bosh::Director::ConfigServer::ClientFactory).to receive(:create).and_return(client_factory)
          allow(client_factory).to receive(:create_client).and_return(config_server_client)
        end

        it &#39;uses the interpolated cloud config&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when cloud properties has placeholders)::it#uses the interpolated cloud config has a flog score of 93</span>          </div>  </li></ol>
          instance_plan.instance.desired_variable_set = desired_variable_set

          # 1 call to check if disks has changed, 1 to figure out the change, 1 to interpolate before we send to CPI
          expect(config_server_client).to receive(:interpolate_with_versioning).exactly(3).times.with(cloud_properties, desired_variable_set).and_return(interpolated_cloud_properties)

          # 1 call to check if disks has changed, 1 to figure out the change
          expect(config_server_client).to receive(:interpolate_with_versioning).exactly(2).times.with(cloud_properties, instance_plan.instance.previous_variable_set).and_return(interpolated_cloud_properties)

          expect(cloud).to receive(:create_disk).with(job_persistent_disk_size, interpolated_cloud_properties, instance_model.active_vm.cid).and_return(&#39;new-disk-cid&#39;)

          expect do
            disk_manager.update_persistent_disk(instance_plan)
          end.to_not raise_error
        end

        it &#39;does not save PersistentDisk model with the interpolated cloud config&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#update_persistent_disk)::context(when cloud properties has placeholders)::it#does not save PersistentDisk model with the interpolated cloud config has a flog score of 36</span>          </div>  </li></ol>
          allow(config_server_client).to receive(:interpolate_with_versioning).with(cloud_properties, anything).and_return(interpolated_cloud_properties)
          disk_manager.update_persistent_disk(instance_plan)
          expect(Models::PersistentDisk.first.cloud_properties).to eq(cloud_properties)
        end
      end
    end

    describe &#39;#delete_persistent_disks&#39; do
      let(:snapshot) { Models::Snapshot.make(persistent_disk: persistent_disk) }
      before { persistent_disk.add_snapshot(snapshot) }

      it &#39;deletes snapshots&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L611" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L617" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#delete_persistent_disks)::it#deletes snapshots has a flog score of 25</span>          </div>  </li></ol>
        expect(Models::Snapshot.all.size).to eq(1)
        disk_manager.delete_persistent_disks(instance_model)
        expect(Models::Snapshot.all.size).to eq(0)
      end

      it &#39;deletes disks for instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L611" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L617" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#delete_persistent_disks)::it#deletes disks for instance has a flog score of 25</span>          </div>  </li></ol>
        expect(Models::PersistentDisk.all.size).to eq(1)
        disk_manager.delete_persistent_disks(instance_model)
        expect(Models::PersistentDisk.all.size).to eq(0)
      end

      it &#39;does not delete disk and snapshots from cloud&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="config_old_spec.html#L149" class="js-smell-location">0</a>                  <a href="config_old_spec.html#L161" class="js-smell-location">1</a>                  <a href="disk_manager_spec.html#L623" class="js-smell-location">2</a>                  <a href="instance_updater/state_applier_spec.html#L142" class="js-smell-location">3</a>                  <a href="instance_updater_spec.html#L131" class="js-smell-location">4</a>                  </div>  </li></ol>
        expect(cloud).to_not receive(:delete_snapshot)
        expect(cloud).to_not receive(:delete_disk)

        disk_manager.delete_persistent_disks(instance_model)
      end
    end

    describe &#39;#attach_disks_if_needed&#39; do
      let(:cloud_for_set_disk_metadata) { instance_double(Bosh::Clouds::ExternalCpi) }

      context &#39;when instance desired job has disk&#39; do
        let(:job_persistent_disk_size) { 100 }

        it &#39;attaches current instance disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#attach_disks_if_needed)::context(when instance desired job has disk)::it#attaches current instance disk has a flog score of 71</span>          </div>  </li></ol>
          expect(cloud).to receive(:attach_disk).with(&#39;vm234&#39;, &#39;disk123&#39;)
          expect(cloud_for_set_disk_metadata).to receive(:set_disk_metadata).with(&#39;disk123&#39;, hash_including(tags))
          expect(cloud_factory).to receive(:get).with(persistent_disk.cpi, nil).at_least(:once).and_return(cloud)
          expect(cloud_factory).to receive(:get).with(persistent_disk.cpi).at_least(:once).and_return(cloud_for_set_disk_metadata)
          disk_manager.attach_disks_if_needed(instance_plan)
        end
      end

      context &#39;when instance desired job does not have disk&#39; do
        let(:instance_group) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="disk_manager_spec.html#L525" class="js-smell-location">0</a>                  <a href="disk_manager_spec.html#L647" class="js-smell-location">1</a>                  </div>  </li></ol>
          instance_group = DeploymentPlan::InstanceGroup.new(logger)
          instance_group.name = &#39;job-name&#39;
          instance_group.persistent_disk_collection = DeploymentPlan::PersistentDiskCollection.new(logger)
          instance_group
        end

        it &#39;does not attach current instance disk&#39; do
          expect(cloud).to_not receive(:attach_disk)
          disk_manager.attach_disks_if_needed(instance_plan)
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
