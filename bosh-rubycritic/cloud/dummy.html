<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../overview.html"><img src="../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 10:12:42 -0700'>2018-06-22 10:12:42 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>cloud /</small> dummy.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">801</span><small> lines of codes</small></div>
              <div><span class="metric">96</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">6.5</span><small> complexity/method</small></div>
              <div><span class="metric">137</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">627.17</span><small> complexity</small></div>
              <div><span class="metric">0</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                52
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;digest/sha1&#39;
require &#39;fileutils&#39;
require &#39;securerandom&#39;
require &#39;membrane&#39;
require &#39;netaddr&#39;
require_relative &#39;../cloud/errors&#39;

module Bosh
  module Clouds
    class Dummy<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Constants.md" target="_blank"><b>TooManyConstants</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy has 17 constants</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy has at least 12 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy has at least 56 methods</span>          </div>  </li></ol>
      class NotImplemented &lt; StandardError; end<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::NotImplemented has no descriptive comment</span>          </div>  </li></ol>

      attr_reader :commands
      attr_accessor :options<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#options is a writable attribute</span>          </div>  </li></ol>

      def initialize(options, context, request_api_version)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#initialize has a flog score of 30</span>          </div>  </li></ol>
        @options = options
        @context = context
        @api_version = options.fetch(&#39;api_version&#39;, nil)
        @request_api_version = request_api_version

        @supported_formats = context[&#39;formats&#39;] || [&#39;dummy&#39;]
        @base_dir = options[&#39;dir&#39;]
        if @base_dir.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#initialize performs a nil-check</span>          </div>  </li></ol>
          raise ArgumentError, &#39;Must specify dir&#39;
        end

        @running_vms_dir = File.join(@base_dir, &#39;running_vms&#39;)
        @vm_repo = VMRepo.new(@running_vms_dir)
        @tmp_dir = File.join(@base_dir, &#39;tmp&#39;)
        FileUtils.mkdir_p(@tmp_dir)

        @logger = Logging::Logger.new(&#39;DummyCPI&#39;)
        @logger.add_appenders(Logging.appenders.io(
            &#39;DummyCPIIO&#39;,
            options[&#39;log_buffer&#39;] || STDOUT
          ))

        @commands = CommandTransport.new(@base_dir, @logger)
        @inputs_recorder = InputsRecorder.new(@base_dir, @logger, @context)

        prepare
      rescue Errno::EACCES
        raise ArgumentError, &quot;cannot create dummy cloud base directory #{@base_dir}&quot;
      end

      CREATE_STEMCELL_SCHEMA = Membrane::SchemaParser.parse { {image_path: String, cloud_properties: Hash} }
      def create_stemcell(image_path, cloud_properties)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_stemcell has approx 7 statements</span>          </div>  </li></ol>
        validate_and_record_inputs(CREATE_STEMCELL_SCHEMA, __method__, image_path, cloud_properties)

        content = File.read(image_path)
        data = YAML.load(content)
        data.merge!(&#39;image&#39; =&gt; image_path)
        stemcell_id = SecureRandom.uuid

        File.write(stemcell_file(stemcell_id), YAML.dump(data))
        stemcell_id
      end

      DELETE_STEMCELL_SCHEMA = Membrane::SchemaParser.parse { {stemcell_id: String} }
      def delete_stemcell(stemcell_id)
        validate_and_record_inputs(DELETE_STEMCELL_SCHEMA, __method__, stemcell_id)
        FileUtils.rm(stemcell_file(stemcell_id))
      end

      CREATE_VM_SCHEMA = Membrane::SchemaParser.parse do
        {
          agent_id: String,
          stemcell_id: String,
          cloud_properties: Hash,
          networks: Hash,
          disk_cids: [String],
          env: Hash,
        }
      end

      # rubocop:disable ParameterLists
      def create_vm(agent_id, stemcell_id, cloud_properties, networks, disk_cids, env)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_vm has a flog score of 47</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_vm has 6 parameters</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_vm has approx 18 statements</span>          </div>  </li></ol>
        # rubocop:enable ParameterLists
        @logger.debug(&#39;Dummy: create_vm&#39;)
        validate_and_record_inputs(CREATE_VM_SCHEMA, __method__, agent_id, stemcell_id, cloud_properties, networks, disk_cids, env)

        ips = []
        cmd = commands.next_create_vm_cmd

        if cmd.failed?
          raise Bosh::Clouds::CloudError.new(&#39;Creating vm failed&#39;)
        end

        networks.each do |network_name, network|
          if network[&#39;type&#39;] != &#39;dynamic&#39;
            ips &lt;&lt; { &#39;network&#39; =&gt; network_name, &#39;ip&#39; =&gt; network.fetch(&#39;ip&#39;) }
          else
            if cmd.ip_address<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_vm calls 'cmd.ip_address' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L94" class="js-smell-location">0</a>                  <a href="dummy.html#L95" class="js-smell-location">1</a>                  </div>  </li></ol>
              ip_address = cmd.ip_address<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_vm calls 'cmd.ip_address' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L94" class="js-smell-location">0</a>                  <a href="dummy.html#L95" class="js-smell-location">1</a>                  </div>  </li></ol>
            elsif cloud_properties[&#39;az_name&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_vm calls 'cloud_properties['az_name']' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L96" class="js-smell-location">0</a>                  <a href="dummy.html#L97" class="js-smell-location">1</a>                  </div>  </li></ol>
              ip_address = cmd.ip_address_for_az(cloud_properties[&#39;az_name&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_vm calls 'cloud_properties['az_name']' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L96" class="js-smell-location">0</a>                  <a href="dummy.html#L97" class="js-smell-location">1</a>                  </div>  </li></ol>
            else
              ip_address =  NetAddr::CIDRv4.new(rand(0..4294967295)).ip #collisions?
            end

            if ip_address
              ips &lt;&lt; { &#39;network&#39; =&gt; network_name, &#39;ip&#39; =&gt; ip_address }
              write_agent_default_network(agent_id, ip_address)
            end
          end
        end

        allocate_ips(ips)

        write_agent_settings(agent_id, {
            agent_id: agent_id,
            blobstore: @options[&#39;agent&#39;][&#39;blobstore&#39;],
            ntp: [],
            disks: { persistent: {} },
            networks: networks,
            vm: { name: &quot;vm-#{agent_id}&quot; },
            cert: &#39;&#39;,
            env: env,
            mbus: @options[&#39;nats&#39;],
          })

        agent_pid = spawn_agent_process(agent_id, cloud_properties[&#39;legacy_agent_path&#39;])
        vm = VM.new(agent_pid.to_s, agent_id, cloud_properties, ips)

        @vm_repo.save(vm)

        vm.id
      end

      DELETE_VM_SCHEMA = Membrane::SchemaParser.parse { {vm_cid: String} }
      def delete_vm(vm_cid)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#delete_vm has approx 7 statements</span>          </div>  </li></ol>
        validate_and_record_inputs(DELETE_VM_SCHEMA, __method__, vm_cid)
        commands.wait_for_unpause_delete_vms
        detach_disks_attached_to_vm(vm_cid)
        agent_pid = vm_cid.to_i
        Process.kill(&#39;KILL&#39;, agent_pid)

          # rubocop:disable HandleExceptions
      rescue Errno::ESRCH
        raise Bosh::Clouds::VMNotFound if commands.raise_vmnotfound
        # rubocop:enable HandleExceptions
      ensure
        free_ips(vm_cid)
        FileUtils.rm_rf(File.join(@base_dir, &#39;running_vms&#39;, vm_cid))
      end

      REBOOT_VM_SCHEMA = Membrane::SchemaParser.parse { {vm_cid: String} }
      def reboot_vm(vm_cid)
        validate_and_record_inputs(__method__, vm_cid)
        raise NotImplemented, &#39;Dummy CPI does not implement reboot_vm&#39;
      end

      HAS_VM_SCHEMA = Membrane::SchemaParser.parse { {vm_cid: String} }
      def has_vm(vm_cid)
        validate_and_record_inputs(HAS_VM_SCHEMA, __method__, vm_cid)
        @vm_repo.exists?(vm_cid)
      end

      def info
        record_inputs(__method__, nil)
        {stemcell_formats: @supported_formats}
      end

      HAS_DISK_SCHEMA = Membrane::SchemaParser.parse { {disk_id: String} }
      def has_disk(disk_id)
        validate_and_record_inputs(HAS_DISK_SCHEMA, __method__, disk_id)
        File.exists?(disk_file(disk_id))
      end

      ATTACH_DISK_SCHEMA = Membrane::SchemaParser.parse { {vm_cid: String, disk_id: String} }
      def attach_disk(vm_cid, disk_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#attach_disk has approx 10 statements</span>          </div>  </li></ol>
        validate_and_record_inputs(ATTACH_DISK_SCHEMA, __method__, vm_cid, disk_id)
        if disk_attached?(disk_id)
          raise &quot;#{disk_id} is already attached to an instance&quot;
        end
        file = attachment_file(vm_cid, disk_id)
        FileUtils.mkdir_p(File.dirname(file))
        FileUtils.touch(file)

        @logger.debug(&quot;Attached disk: &#39;#{disk_id}&#39; to vm: &#39;#{vm_cid}&#39; at attachment file: #{file}&quot;)

        agent_id = agent_id_for_vm_id(vm_cid)
        settings = read_agent_settings(agent_id)
        settings[&#39;disks&#39;][&#39;persistent&#39;][disk_id] = &#39;attached&#39;
        write_agent_settings(agent_id, settings)
      end

      DETACH_DISK_SCHEMA = Membrane::SchemaParser.parse { {vm_cid: String, disk_id: String} }
      def detach_disk(vm_cid, disk_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#detach_disk has approx 8 statements</span>          </div>  </li></ol>
        validate_and_record_inputs(DETACH_DISK_SCHEMA, __method__, vm_cid, disk_id)

        raise Bosh::Clouds::NotImplemented, &#39;Bosh::Clouds::NotImplemented&#39; if commands.raise_detach_disk_not_implemented

        unless disk_attached_to_vm?(vm_cid, disk_id)
          raise Bosh::Clouds::DiskNotAttached, &quot;#{disk_id} is not attached to instance #{vm_cid}&quot;
        end
        FileUtils.rm_rf(attachment_path(disk_id))

        agent_id = agent_id_for_vm_id(vm_cid)
        settings = read_agent_settings(agent_id)
        settings[&#39;disks&#39;][&#39;persistent&#39;].delete(disk_id)
        write_agent_settings(agent_id, settings)
      end

      CREATE_DISK_SCHEMA = Membrane::SchemaParser.parse { {size: Integer, cloud_properties: Hash, vm_locality: String} }
      def create_disk(size, cloud_properties, vm_locality)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#create_disk has approx 7 statements</span>          </div>  </li></ol>
        validate_and_record_inputs(CREATE_DISK_SCHEMA, __method__, size, cloud_properties, vm_locality)
        disk_id = SecureRandom.hex
        file = disk_file(disk_id)
        FileUtils.mkdir_p(File.dirname(file))
        disk_info = JSON.generate({size: size, cloud_properties: cloud_properties, vm_locality: vm_locality})
        File.write(file, disk_info)
        disk_id
      end

      DELETE_DISK_SCHEMA = Membrane::SchemaParser.parse { {disk_id: String} }
      def delete_disk(disk_id)
        validate_and_record_inputs(DELETE_DISK_SCHEMA, __method__, disk_id)
        FileUtils.rm(disk_file(disk_id))
      end

      SNAPSHOT_DISK_SCHEMA = Membrane::SchemaParser.parse { {disk_id: String, metadata: Hash} }
      def snapshot_disk(disk_id, metadata)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#snapshot_disk has approx 6 statements</span>          </div>  </li></ol>
        validate_and_record_inputs(SNAPSHOT_DISK_SCHEMA, __method__, disk_id, metadata)
        snapshot_id = SecureRandom.hex
        file = snapshot_file(snapshot_id)
        FileUtils.mkdir_p(File.dirname(file))
        File.write(file, metadata.to_json)
        snapshot_id
      end

      DELETE_SNAPSHOT_SCHEMA = Membrane::SchemaParser.parse { {snapshot_id: String} }
      def delete_snapshot(snapshot_id)
        validate_and_record_inputs(DELETE_SNAPSHOT_SCHEMA, __method__, snapshot_id)
        FileUtils.rm(snapshot_file(snapshot_id))
      end

      RESIZE_DISK_SCHEMA = Membrane::SchemaParser.parse { {disk_id: String, new_size: Integer } }
      def resize_disk(disk_id, new_size)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#resize_disk has approx 6 statements</span>          </div>  </li></ol>
        validate_and_record_inputs(RESIZE_DISK_SCHEMA, __method__, disk_id, new_size)

        raise Bosh::Clouds::NotImplemented, &#39;Bosh::Clouds::NotImplemented&#39; if commands.raise_resize_disk_not_implemented

        disk_info_file = disk_file(disk_id)
        disk_info = JSON.parse(File.read(disk_info_file))
        disk_info[&#39;size&#39;] = new_size
        File.write(disk_info_file, JSON.generate(disk_info))
      end

      SET_VM_METADATA_SCHEMA = Membrane::SchemaParser.parse { {vm_cid: String, metadata: Hash} }
      def set_vm_metadata(vm_cid, metadata)
        raise &#39;Set VM metadata failed!!!&#39; if commands.set_vm_metadata_should_fail?
        validate_and_record_inputs(SET_VM_METADATA_SCHEMA, __method__, vm_cid, metadata)
      end

      SET_DISK_METADATA_SCHEMA = Membrane::SchemaParser.parse { {disk_cid: String, metadata: Hash} }
      def set_disk_metadata(disk_cid, metadata)
        validate_and_record_inputs(SET_DISK_METADATA_SCHEMA, __method__, disk_cid, metadata)
      end

      CALCULATE_VM_CLOUD_PROPERTIES_SCHEMA = Membrane::SchemaParser.parse { { vm_resources: {&#39;ram&#39; =&gt; Integer, &#39;cpu&#39; =&gt; Integer, &#39;ephemeral_disk_size&#39; =&gt; Integer} } }
      def calculate_vm_cloud_properties(vm_resources)
        validate_and_record_inputs(
          CALCULATE_VM_CLOUD_PROPERTIES_SCHEMA,
          __method__,
          vm_resources
        )
        instance_type = @context[&#39;cvcpkey&#39;].nil? ? &#39;dummy&#39; : @context[&#39;cvcpkey&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#calculate_vm_cloud_properties calls '@context['cvcpkey']' 2 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#calculate_vm_cloud_properties performs a nil-check</span>          </div>  </li></ol>
        {
          instance_type: instance_type,
          ephemeral_disk: { size: vm_resources[&#39;ephemeral_disk_size&#39;] }
        }
      end

      # Additional Dummy test helpers

      def prepare
        FileUtils.mkdir_p(@base_dir)
      end

      def reset
        FileUtils.rm_rf(@base_dir)
        prepare
      end

      def vm_cids
        # Shuffle so that no one relies on the order of VMs
        Dir.glob(File.join(@running_vms_dir, &#39;*&#39;)).map { |vm| File.basename(vm) }.shuffle
      end

      def disk_cids
        # Shuffle so that no one relies on the order of disks
        Dir.glob(disk_file(&#39;*&#39;)).map { |disk| File.basename(disk) }.shuffle
      end

      def kill_agents
        vm_cids.each do |agent_pid|
          begin
            Process.kill(&#39;KILL&#39;, agent_pid.to_i)
              # rubocop:disable HandleExceptions
          rescue Errno::ESRCH
            # rubocop:enable HandleExceptions
          end
        end
      end

      def agent_log_path(agent_id)
        &quot;#{@base_dir}/agent.#{agent_id}.log&quot;
      end

      def read_cloud_properties(vm_cid)
        @vm_repo.load(vm_cid).cloud_properties
      end

      def invocations
        @inputs_recorder.read_all
      end

      def invocations_for_method(method)
        @inputs_recorder.read(method)
      end

      def all_stemcells<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#all_stemcells has a flog score of 27</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#all_stemcells has approx 8 statements</span>          </div>  </li></ol>
        files = Dir.entries(@base_dir).select { |file| file.match /stemcell_./ }

        Dir.chdir(@base_dir) do
          [].tap do |results|
            files.each do |file|
              # data --&gt; [{ &#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39;: &#39;1&#39;, &#39;image&#39; =&gt; &lt;image path&gt; }]
              data = YAML.load(File.read(file))
              results &lt;&lt; { &#39;id&#39; =&gt; file.sub(/^stemcell_/, &#39;&#39;) }.merge(data)
            end
          end.sort { |a, b| a[:version].to_i &lt;=&gt; b[:version].to_i }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#all_stemcells has the variable name 'a'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#all_stemcells has the variable name 'b'</span>          </div>  </li></ol>
        end
      end

      def latest_stemcell
        all_stemcells.last
      end

      def all_snapshots
        if File.exists?(snapshot_file(&#39;&#39;))
          Dir.glob(snapshot_file(&#39;*&#39;))
        else
          []
        end
      end

      def all_ips
        Dir.glob(File.join(@base_dir, &#39;dummy_cpi_networks&#39;, &#39;*&#39;))
          .reject { |path| File.directory?(path) }
          .map { |path| File.basename(path) }
      end

      def agent_dir_for_vm_cid(vm_cid)
        agent_id = agent_id_for_vm_id(vm_cid)
        agent_base_dir(agent_id)
      end

      def disk_attached_to_vm?(vm_cid, disk_id)
        File.exist?(attachment_file(vm_cid, disk_id))
      end

      def current_apply_spec_for_vm(vm_cid)
        agent_base_dir = agent_dir_for_vm_cid(vm_cid)
        spec_file = File.join(agent_base_dir, &#39;bosh&#39;, &#39;spec.json&#39;)
        JSON.parse(File.read(spec_file))
      end

      def attached_disk_infos(vm_cid)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#attached_disk_infos has approx 10 statements</span>          </div>  </li></ol>
        agent_id = agent_id_for_vm_id(vm_cid)
        settings = read_agent_settings(agent_id)
        return [] unless settings.has_key?(&#39;disks&#39;) &amp;&amp; settings[&#39;disks&#39;].has_key?(&#39;persistent&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#attached_disk_infos calls 'settings['disks']' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L374" class="js-smell-location">0</a>                  <a href="dummy.html#L376" class="js-smell-location">1</a>                  </div>  </li></ol>

        settings[&#39;disks&#39;][&#39;persistent&#39;].inject([]) do |memo, disk_attachment|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#attached_disk_infos calls 'settings['disks']' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L374" class="js-smell-location">0</a>                  <a href="dummy.html#L376" class="js-smell-location">1</a>                  </div>  </li></ol>
          disk_cid = disk_attachment[0]
          device_path = disk_attachment[1]

          disk_info_hash = JSON.parse(File.read(disk_file(disk_cid)))
          disk_info_hash[&#39;disk_cid&#39;] = disk_cid
          disk_info_hash[&#39;device_path&#39;] = device_path

          memo &lt;&lt; disk_info_hash
        end
      end

      def spawn_agent_process(agent_id, legacy_agent_path = nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#spawn_agent_process has approx 10 statements</span>          </div>  </li></ol>
        root_dir = File.join(agent_base_dir(agent_id), &#39;root_dir&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#spawn_agent_process calls 'agent_base_dir(agent_id)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L389" class="js-smell-location">0</a>                  <a href="dummy.html#L399" class="js-smell-location">1</a>                  </div>  </li></ol>
        FileUtils.mkdir_p(File.join(root_dir, &#39;etc&#39;, &#39;logrotate.d&#39;))

        agent_cmd = agent_cmd(agent_id, legacy_agent_path)
        agent_log = agent_log_path(agent_id)

        agent_pid = Process.spawn(
          { &#39;TMPDIR&#39; =&gt; @tmp_dir },
          *agent_cmd,
          {
            chdir: agent_base_dir(agent_id),<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#spawn_agent_process calls 'agent_base_dir(agent_id)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L389" class="js-smell-location">0</a>                  <a href="dummy.html#L399" class="js-smell-location">1</a>                  </div>  </li></ol>
            out: agent_log,
            err: agent_log,
          }
        )

        begin
          Process.getpgid(agent_pid)
        rescue =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#spawn_agent_process has the variable name 'e'</span>          </div>  </li></ol>
          raise RuntimeError, &quot;Expected agent to be running: #{e}&quot;
        end

        Process.detach(agent_pid)

        agent_pid
      end

      private

      def allocate_ips(ips)
        ips.each do |ip|
          begin
            network_dir = File.join(@base_dir, &#39;dummy_cpi_networks&#39;)
            FileUtils.makedirs(network_dir)
            File.open(File.join(network_dir, ip[&#39;ip&#39;]), File::WRONLY|File::CREAT|File::EXCL).close<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#allocate_ips calls 'ip['ip']' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L423" class="js-smell-location">0</a>                  <a href="dummy.html#L427" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#allocate_ips refers to 'ip' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="dummy.html#L423" class="js-smell-location">0</a>                  <a href="dummy.html#L427" class="js-smell-location">1</a>                  </div>  </li></ol>
          rescue Errno::EEXIST
            # at this point we should actually free all the IPs we successfully allocated before the collision,
            # but in practice the tests only feed in one IP per VM so that cleanup code would never be exercised
            raise &quot;IP Address #{ip[&#39;ip&#39;]} in network &#39;#{ip[&#39;network&#39;]}&#39; is already in use&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#allocate_ips calls 'ip['ip']' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L423" class="js-smell-location">0</a>                  <a href="dummy.html#L427" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#allocate_ips refers to 'ip' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="dummy.html#L423" class="js-smell-location">0</a>                  <a href="dummy.html#L427" class="js-smell-location">1</a>                  </div>  </li></ol>
          end
        end
      end

      def free_ips(vm_cid)
        return unless @vm_repo.exists?(vm_cid)
        vm = @vm_repo.load(vm_cid)
        vm.ips.each do |ip|
          FileUtils.rm_rf(File.join(@base_dir, &#39;dummy_cpi_networks&#39;, ip[&#39;ip&#39;]))
        end
      end

      def agent_id_for_vm_id(vm_cid)
        @vm_repo.load(vm_cid).agent_id
      end

      def agent_settings_file(agent_id)
        # Even though dummy CPI has complete access to agent execution file system
        # it should never write directly to settings.json because
        # the agent is responsible for retrieving the settings from the CPI.
        File.join(agent_base_dir(agent_id), &#39;bosh&#39;, &#39;dummy-cpi-agent-env.json&#39;)
      end

      def agent_base_dir(agent_id)
        &quot;#{@base_dir}/agent-base-dir-#{agent_id}&quot;
      end

      def write_agent_settings(agent_id, settings)
        FileUtils.mkdir_p(File.dirname(agent_settings_file(agent_id)))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#write_agent_settings calls 'agent_settings_file(agent_id)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L456" class="js-smell-location">0</a>                  <a href="dummy.html#L457" class="js-smell-location">1</a>                  </div>  </li></ol>
        File.write(agent_settings_file(agent_id), JSON.generate(settings))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#write_agent_settings calls 'agent_settings_file(agent_id)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L456" class="js-smell-location">0</a>                  <a href="dummy.html#L457" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      def write_agent_default_network(agent_id, ip_address)
        # Agent looks for following file to resolve default network on dummy infrastructure
        path = File.join(agent_base_dir(agent_id), &#39;bosh&#39;, &#39;dummy-default-network-settings.json&#39;)
        FileUtils.mkdir_p(File.dirname(path))
        File.write(path, JSON.generate(&#39;ip&#39; =&gt; ip_address))
      end

      def agent_cmd(agent_id, legacy_agent_path)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#agent_cmd has approx 6 statements</span>          </div>  </li></ol>
        if legacy_agent_path.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#agent_cmd performs a nil-check</span>          </div>  </li></ol>
          go_agent_exe =  File.expand_path(&#39;../../../../go/src/github.com/cloudfoundry/bosh-agent/out/bosh-agent&#39;, __FILE__)
        else
          go_agent_exe = legacy_agent_path
        end

        agent_config_file = File.join(agent_base_dir(agent_id), &#39;agent.json&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#agent_cmd calls 'agent_base_dir(agent_id)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L474" class="js-smell-location">0</a>                  <a href="dummy.html#L490" class="js-smell-location">1</a>                  </div>  </li></ol>

        agent_config = {
          &#39;Infrastructure&#39; =&gt; {
            &#39;Settings&#39; =&gt; {
              &#39;Sources&#39; =&gt; [{
                  &#39;Type&#39; =&gt; &#39;File&#39;,
                  &#39;SettingsPath&#39; =&gt; agent_settings_file(agent_id)
                }],
              &#39;UseRegistry&#39; =&gt; true
            }
          }
        }

        File.write(agent_config_file, JSON.generate(agent_config))

        %W[#{go_agent_exe} -b #{agent_base_dir(agent_id)} -P dummy -M dummy-nats -C #{agent_config_file}]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy#agent_cmd calls 'agent_base_dir(agent_id)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L474" class="js-smell-location">0</a>                  <a href="dummy.html#L490" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      def read_agent_settings(agent_id)
        JSON.parse(File.read(agent_settings_file(agent_id)))
      end

      def stemcell_file(stemcell_id)
        File.join(@base_dir, &quot;stemcell_#{stemcell_id}&quot;)
      end

      def disk_file(disk_id)
        File.join(@base_dir, &#39;disks&#39;, disk_id)
      end

      def disk_attached?(disk_id)
        File.exist?(attachment_path(disk_id))
      end

      def detach_disks_attached_to_vm(vm_cid)
        @logger.debug(&quot;Detaching disks for vm #{vm_cid}&quot;)
        Dir.glob(attachment_file(vm_cid, &#39;*&#39;)) do |file_path|
          @logger.debug(&quot;Detaching found attachment #{file_path}&quot;)
          FileUtils.rm_rf(File.dirname(file_path))
        end
      end

      def attachment_file(vm_cid, disk_id)
        File.join(attachment_path(disk_id), vm_cid)
      end

      def attachment_path(disk_id)
        File.join(@base_dir, &#39;attachments&#39;, disk_id)
      end

      def snapshot_file(snapshot_id)
        File.join(@base_dir, &#39;snapshots&#39;, snapshot_id)
      end

      def validate_and_record_inputs(schema, the_method, *args)
        parameter_names_to_values = parameter_names_to_values(the_method, *args)
        begin
          schema.validate(parameter_names_to_values)
        rescue Membrane::SchemaValidationError =&gt; err
          raise ArgumentError, &quot;Invalid arguments sent to #{the_method}: #{err.message}&quot;
        end
        record_inputs(the_method, parameter_names_to_values)
      end

      def record_inputs(method, args)
        @inputs_recorder.record(method, args)
      end

      def parameter_names_to_values(the_method, *the_method_args)
        hash = {}
        method(the_method).parameters.each_with_index do |param, index|
          hash[param[1]] = the_method_args[index]
        end
        hash
      end

      # Example file system layout for arranging commands information.
      # Currently uses file system as transport but could be switch to use NATS.
      #   base_dir/cpi/create_vm/next -&gt; {&quot;something&quot;: true}
      class CommandTransport<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::CommandTransport has at least 27 methods</span>          </div>  </li></ol>
        def initialize(base_dir, logger)
          @cpi_commands = File.join(base_dir, &#39;cpi_commands&#39;)
          @logger = logger
        end

        def pause_delete_vms
          @logger.debug(&#39;Pausing delete_vms&#39;)
          path = File.join(@cpi_commands, &#39;pause_delete_vms&#39;)
          FileUtils.mkdir_p(File.dirname(path))
          File.write(path, &#39;marker&#39;)
        end

        def unpause_delete_vms
          @logger.debug(&#39;Unpausing delete_vms&#39;)
          FileUtils.rm_rf File.join(@cpi_commands, &#39;pause_delete_vms&#39;)
          FileUtils.rm_rf File.join(@cpi_commands, &#39;wait_for_unpause_delete_vms&#39;)
        end

        def wait_for_delete_vms
          @logger.debug(&#39;Wait for delete_vms&#39;)
          path = File.join(@cpi_commands, &#39;wait_for_unpause_delete_vms&#39;)
          sleep(0.1) until File.exists?(path)
        end

        def wait_for_unpause_delete_vms<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::CommandTransport#wait_for_unpause_delete_vms has approx 6 statements</span>          </div>  </li></ol>
          path = File.join(@cpi_commands, &#39;wait_for_unpause_delete_vms&#39;)
          FileUtils.mkdir_p(File.dirname(path))
          File.write(path, &#39;marker&#39;)

          path = File.join(@cpi_commands, &#39;pause_delete_vms&#39;)
          if File.exists?(path)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::CommandTransport#wait_for_unpause_delete_vms calls 'File.exists?(path)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L585" class="js-smell-location">0</a>                  <a href="dummy.html#L588" class="js-smell-location">1</a>                  </div>  </li></ol>
            @logger.debug(&#39;Wait for unpausing delete_vms&#39;)
          end
          sleep(0.1) while File.exists?(path)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::CommandTransport#wait_for_unpause_delete_vms calls 'File.exists?(path)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L585" class="js-smell-location">0</a>                  <a href="dummy.html#L588" class="js-smell-location">1</a>                  </div>  </li></ol>
        end

        def make_create_vm_always_use_dynamic_ip(ip_address)
          @logger.debug(&quot;Making create_vm method to set ip address #{ip_address}&quot;)
          FileUtils.mkdir_p(File.dirname(always_path))
          File.write(always_path, ip_address)
        end

        def set_dynamic_ips_for_azs(az_to_ips)
          @logger.debug(&quot;Making create_vm method to set #{az_to_ips.inspect}&quot;)
          FileUtils.mkdir_p(File.dirname(azs_path))
          File.write(azs_path, JSON.generate(az_to_ips))
        end

        def make_create_vm_always_fail
          @logger.debug(&#39;Making create_vm method always fail&#39;)
          FileUtils.mkdir_p(File.dirname(failed_path))
          File.write(failed_path, &#39;&#39;)
        end

        def allow_create_vm_to_succeed
          @logger.debug(&#39;Allowing create_vm method to succeed (removing any mandatory failures)&#39;)
          FileUtils.rm(failed_path)
        end

        def next_create_vm_cmd<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::CommandTransport#next_create_vm_cmd has approx 6 statements</span>          </div>  </li></ol>
          @logger.debug(&#39;Reading create_vm configuration&#39;)
          ip_address = File.read(always_path) if File.exists?(always_path)
          azs_to_ip = File.exists?(azs_path) ? JSON.load(File.read(azs_path)) : {}
          failed = File.exists?(failed_path)
          CreateVmCommand.new(ip_address, azs_to_ip, failed)
        end

        def make_set_vm_metadata_always_fail
          @logger.debug(&#39;Making set_vm_metadata method always fail&#39;)
          FileUtils.mkdir_p(File.dirname(set_vm_metadata_path_fail_path))
          File.write(set_vm_metadata_path_fail_path, &#39;&#39;)
        end

        def allow_set_vm_metadata_to_succeed
          @logger.debug(&#39;Allowing set_vm_metadata method to succeed (removing any mandatory failures)&#39;)
          FileUtils.rm(set_vm_metadata_path_fail_path)
        end

        def set_vm_metadata_should_fail?
          @logger.info(&#39;Reading set_vm_metadata configuration&#39;)
          File.exist?(set_vm_metadata_path_fail_path)
        end

        def make_delete_vm_to_raise_vmnotfound
          @logger.info(&#39;Making delete_vm method to raise VMNotFound exception&#39;)
          FileUtils.mkdir_p(File.dirname(raise_vmnotfound_path))
          File.write(raise_vmnotfound_path, &#39;&#39;)
        end

        def raise_vmnotfound
          @logger.info(&#39;Reading delete_vm configuration&#39;)
          File.exists?(raise_vmnotfound_path)
        end

        def allow_detach_disk_to_succeed
          @logger.debug(&#39;Allowing detach_disk method to succeed (removing any mandatory failures)&#39;)
          FileUtils.rm(raise_detach_disk_not_implemented_path)
        end

        def make_detach_disk_to_raise_not_implemented
          @logger.info(&#39;Making detach_disk method to raise NotImplemented exception&#39;)
          FileUtils.mkdir_p(File.dirname(raise_detach_disk_not_implemented_path))
          FileUtils.touch(raise_detach_disk_not_implemented_path)
        end

        def make_resize_disk_to_raise_not_implemented
          @logger.info(&#39;Making resize_disk method to raise NotImplemented exception&#39;)
          FileUtils.mkdir_p(File.dirname(raise_resize_disk_not_implemented_path))
          FileUtils.touch(raise_resize_disk_not_implemented_path)
        end

        def raise_detach_disk_not_implemented
          @logger.info(&#39;Reading detach_disk_not_implemented&#39;)
          File.exist?(raise_detach_disk_not_implemented_path)
        end

        def raise_resize_disk_not_implemented
          @logger.info(&#39;Reading resize_disk_not_implemented&#39;)
          File.exist?(raise_resize_disk_not_implemented_path)
        end

        private

        def azs_path
          File.join(@cpi_commands, &#39;create_vm&#39;, &#39;az_ips&#39;)
        end

        def always_path
          File.join(@cpi_commands, &#39;create_vm&#39;, &#39;always&#39;)
        end

        def failed_path
          File.join(@cpi_commands, &#39;create_vm&#39;, &#39;fail&#39;)
        end

        def set_vm_metadata_path_fail_path
          File.join(@cpi_commands, &#39;update_vm_metadata&#39;, &#39;fail&#39;)
        end

        def raise_vmnotfound_path
          File.join(@cpi_commands, &#39;delete_vm&#39;, &#39;fail&#39;)
        end

        def raise_detach_disk_not_implemented_path
          File.join(@cpi_commands, &#39;detach_disk&#39;, &#39;not_implemented&#39;)
        end

        def raise_resize_disk_not_implemented_path
          File.join(@cpi_commands, &#39;resize_disk&#39;, &#39;not_implemented&#39;)
        end

      end

      class ConfigureNetworksCommand &lt; Struct.new(:not_supported); end<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::ConfigureNetworksCommand has no descriptive comment</span>          </div>  </li></ol>
      class CreateVmCommand<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::CreateVmCommand has no descriptive comment</span>          </div>  </li></ol>
        attr_reader :ip_address, :failed

        def initialize(ip_address, azs_to_ip, failed)
          @ip_address = ip_address
          @azs_to_ip = azs_to_ip
          @failed = failed
        end

        def ip_address_for_az(az_name)
          @azs_to_ip[az_name]
        end

        def failed?
          failed
        end
      end

      class InputsRecorder<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::InputsRecorder has no descriptive comment</span>          </div>  </li></ol>
        def initialize(base_dir, logger, context)
          @cpi_inputs_dir = File.join(base_dir, &#39;cpi_inputs&#39;)
          @logger = logger
          @context = context
        end

        def record(method, args)
          FileUtils.mkdir_p(@cpi_inputs_dir)
          data = {method_name: method, inputs: args, context: @context}
          @logger.debug(&quot;Saving input for #{method} &lt;redacted&gt; #{ordered_file_path}&quot;)
          File.open(ordered_file_path, &#39;a&#39;) { |f| f.puts(JSON.dump(data)) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::InputsRecorder#record has the variable name 'f'</span>          </div>  </li></ol>
        end

        def read(method_name)
          @logger.debug(&quot;Reading input for #{method_name}&quot;)
          read_all.select do |invocation|
            invocation.method_name == method_name
          end
        end

        def read_all<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::InputsRecorder#read_all has approx 6 statements</span>          </div>  </li></ol>
          @logger.debug(&quot;Reading all inputs: #{File.read(ordered_file_path)}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::InputsRecorder#read_all calls 'File.read(ordered_file_path)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L749" class="js-smell-location">0</a>                  <a href="dummy.html#L751" class="js-smell-location">1</a>                  </div>  </li></ol>
          result = []
          File.read(ordered_file_path).split(&quot;\n&quot;).each do |request|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::InputsRecorder#read_all calls 'File.read(ordered_file_path)' 2 times</span>              <span>Locations:</span>                  <a href="dummy.html#L749" class="js-smell-location">0</a>                  <a href="dummy.html#L751" class="js-smell-location">1</a>                  </div>  </li></ol>
            data = JSON.parse(request)
            result &lt;&lt; CpiInvocation.new(data[&#39;method_name&#39;], data[&#39;inputs&#39;], data[&#39;context&#39;])
          end
          result
        end

        def ordered_file_path
          File.join(@cpi_inputs_dir, &#39;all_requests&#39;)
        end
      end

      class VM &lt; Struct.new(:id, :agent_id, :cloud_properties, :ips)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::VM has no descriptive comment</span>          </div>  </li></ol>
      end

      class VMRepo<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::VMRepo has no descriptive comment</span>          </div>  </li></ol>
        def initialize(running_vms_dir)
          @running_vms_dir = running_vms_dir
          FileUtils.mkdir_p(@running_vms_dir)
        end

        def load(id)
          attrs = JSON.parse(File.read(vm_file(id)))
          VM.new(id, attrs.fetch(&#39;agent_id&#39;), attrs.fetch(&#39;cloud_properties&#39;), attrs.fetch(&#39;ips&#39;))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::VMRepo#load refers to 'attrs' more than self (maybe move it to another class?)</span>          </div>  </li></ol>
        end

        def exists?(id)
          File.exists?(vm_file(id))
        end

        def save(vm)
          serialized_vm = JSON.dump({
              &#39;agent_id&#39; =&gt; vm.agent_id,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::VMRepo#save refers to 'vm' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="dummy.html#L783" class="js-smell-location">0</a>                  <a href="dummy.html#L784" class="js-smell-location">1</a>                  <a href="dummy.html#L785" class="js-smell-location">2</a>                  <a href="dummy.html#L788" class="js-smell-location">3</a>                  </div>  </li></ol>
              &#39;cloud_properties&#39; =&gt; vm.cloud_properties,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::VMRepo#save refers to 'vm' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="dummy.html#L783" class="js-smell-location">0</a>                  <a href="dummy.html#L784" class="js-smell-location">1</a>                  <a href="dummy.html#L785" class="js-smell-location">2</a>                  <a href="dummy.html#L788" class="js-smell-location">3</a>                  </div>  </li></ol>
              &#39;ips&#39; =&gt; vm.ips,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::VMRepo#save refers to 'vm' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="dummy.html#L783" class="js-smell-location">0</a>                  <a href="dummy.html#L784" class="js-smell-location">1</a>                  <a href="dummy.html#L785" class="js-smell-location">2</a>                  <a href="dummy.html#L788" class="js-smell-location">3</a>                  </div>  </li></ol>
            })

          File.write(vm_file(vm.id), serialized_vm)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::VMRepo#save refers to 'vm' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="dummy.html#L783" class="js-smell-location">0</a>                  <a href="dummy.html#L784" class="js-smell-location">1</a>                  <a href="dummy.html#L785" class="js-smell-location">2</a>                  <a href="dummy.html#L788" class="js-smell-location">3</a>                  </div>  </li></ol>
        end

        private

        def vm_file(vm_cid)
          File.join(@running_vms_dir, vm_cid)
        end
      end

      class CpiInvocation &lt; Struct.new(:method_name, :inputs, :context); end<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Clouds::Dummy::CpiInvocation has no descriptive comment</span>          </div>  </li></ol>
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../assets/javascripts/jquery.min.js'></script>
    <script src='../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../assets/javascripts/jquery.timeago.js'></script>
    <script src='../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../assets/javascripts/prettify.js'></script>
    <script src='../assets/javascripts/bootstrap.min.js'></script>
    <script src='../assets/javascripts/application.js'></script>
    <script src='../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
