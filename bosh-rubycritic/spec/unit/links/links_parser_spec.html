<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 15:27:04 -0400'>2018-06-22 15:27:04 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/links /</small> links_parser_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">2024</span><small> lines of codes</small></div>
              <div><span class="metric">1</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">3661.9</span><small> complexity/method</small></div>
              <div><span class="metric">14</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">3661.93</span><small> complexity</small></div>
              <div><span class="metric">1003</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                70
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;logging&#39;

describe Bosh::Director::Links::LinksParser do
  let(:subject) do
    allow(Bosh::Director::Links::LinksManager).to receive(:new).and_return(links_manager)
    Bosh::Director::Links::LinksParser.new
  end

  let(:links_manager) do
    instance_double(Bosh::Director::Links::LinksManager)
  end

  def create_release(release_name, version, provides: nil, consumes: nil, properties: nil)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>create_release has 5 parameters</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>create_release has approx 8 statements</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>create_release doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    release_model = Bosh::Director::Models::Release.make(name: release_name)
    release_version_model = Bosh::Director::Models::ReleaseVersion.make(version: version, release: release_model)

    release_spec = { properties: {} }
    release_spec[:properties] = properties if properties
    release_spec[:consumes] = consumes if consumes
    release_spec[:provides] = provides if provides

    # This is creating a job
    release_version_model.add_template(
      Bosh::Director::Models::Template.make(
        name: &quot;#{release_name}_job_name_1&quot;,
        release: release_model,
        spec: release_spec,
      ),
    )

    release_version_model
  end

  let(:deployment_plan) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../jobs/update_deployment_spec.html#L29" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L35" class="js-smell-location">1</a>                  </div>  </li></ol>
    instance_double(Bosh::Director::DeploymentPlan::Planner).tap do |mock|
      allow(mock).to receive(:model).and_return(deployment_model)
    end
  end

  let(:deployment_model) do
    Bosh::Director::Models::Deployment.make
  end

  let(:release) do
    create_release(&#39;release1&#39;, &#39;1&#39;, provides: release_providers, consumes: release_consumers, properties: release_properties)
  end

  let(:template) do
    release.templates.first
  end

  let(:release_providers) { nil }
  let(:release_consumers) { nil }
  let(:release_properties) { nil }

  let(:logger) do
    double(Logging::Logger)
  end

  before do
    allow(Bosh::Director::Config).to receive(:logger).and_return(logger)
  end

  describe &#39;#parse_migrated_from_providers_from_job&#39; do
    let(:provider) { instance_double(Bosh::Director::Models::Links::LinkProvider) }
    let(:provider_intent) { instance_double(Bosh::Director::Models::Links::LinkProviderIntent) }

    let(:job_properties) do
      {}
    end

    let(:release_providers) do
      [{ name: &#39;link_1_name&#39;, type: &#39;link_1_type&#39; }]
    end

    let(:job_spec) do
      {
        &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
        &#39;release&#39; =&gt; &#39;release1&#39;,
        &#39;provides&#39; =&gt; {
          &#39;link_1_name&#39; =&gt; {
            &#39;as&#39; =&gt; &#39;link_1_name_alias&#39;,
            &#39;shared&#39; =&gt; true,
            &#39;properties&#39; =&gt; {},
          },
        },
      }
    end

    context &#39;when the job belongs to an instance group that is being migrated&#39; do
      let(:release_providers) do
        [
          {
            name: &#39;chocolate&#39;,
            type: &#39;flavour&#39;,
          },
        ]
      end

      let(:deployment_model) { BD::Models::Deployment.make(links_serial_id: serial_id) }
      let(:deployment_plan) { instance_double(Bosh::Director::DeploymentPlan::Planner) }
      let(:instance_model) { Bosh::Director::Models::Instance.make(deployment: deployment_model) }
      let(:serial_id) { 1 }
      let!(:provider_1) do
        Bosh::Director::Models::Links::LinkProvider.make(
          deployment: deployment_model,
          instance_group: &#39;old-ig1&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )
      end

      let!(:provider_1_intent) do
        Bosh::Director::Models::Links::LinkProviderIntent.make(
          link_provider: provider_1,
          original_name: &#39;chocolate&#39;,
          name: &#39;chocolate&#39;,
          type: &#39;flavour&#39;,
          shared: true,
          consumable: true,
          content: &#39;{}&#39;,
          serial_id: serial_id,
        )
      end

      let(:link_providers) do
        [provider_1]
      end

      let(:job_spec) do
        {
          &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
          &#39;release&#39; =&gt; &#39;release1&#39;,
          &#39;properties&#39; =&gt; job_properties,
          &#39;provides&#39; =&gt; {
            &#39;chocolate&#39; =&gt; {
              &#39;as&#39; =&gt; &#39;chocolate&#39;,
            },
          },
        }
      end

      let(:job_properties) do
        {
          &#39;street&#39; =&gt; &#39;Any Street&#39;,
        }
      end

      let(:migrated_from) do
        [
          { &#39;name&#39; =&gt; &#39;old_ig1&#39;, &#39;az&#39; =&gt; &#39;az1&#39; },
          { &#39;name&#39; =&gt; &#39;old_ig2&#39;, &#39;az&#39; =&gt; &#39;az2&#39; },
        ]
      end

      before do
        allow(deployment_model).to receive(:link_providers).and_return(link_providers)
      end

      it &#39;should update the instance_group name to match the existing provider&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_migrated_from_providers_from_job)::context(when the job belongs to an instance group that is being migrated)::it#should update the instance_group name to match the existing provider has a flog score of 70</span>          </div>  </li></ol>
        expect(Bosh::Director::Models::Links::LinkProvider).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L163" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L332" class="js-smell-location">1</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig1&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(provider_1)
        expect(Bosh::Director::Models::Links::LinkProvider).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L169" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L210" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L216" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L338" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L380" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L386" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig2&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(nil)
        expect(links_manager).to receive(:find_or_create_provider)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L175" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L222" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L344" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L392" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L887" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L1578" class="js-smell-location">5</a>                  </div>  </li></ol>
          .with(deployment_model: deployment_model, instance_group_name: &#39;old_ig1&#39;, name: &#39;release1_job_name_1&#39;, type: &#39;job&#39;)
          .and_return(provider_1)
        expect(links_manager).to receive(:find_or_create_provider_intent)
          .with(link_provider: provider_1, link_original_name: &#39;chocolate&#39;, link_type: &#39;flavour&#39;)
          .and_return(provider_1_intent)

        subject.parse_migrated_from_providers_from_job(
          job_spec,
          deployment_model,
          template,
          job_properties: job_properties,
          instance_group_name: &#39;new-ig&#39;,
          migrated_from: migrated_from,
        )
      end
    end

    context &#39;when there is a new job during a migrated_from deploy&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_migrated_from_providers_from_job)::context#when there is a new job during a migrated_from deploy has a flog score of 41</span>          </div>  </li></ol>
      let(:migrated_from) do
        [
          { &#39;name&#39; =&gt; &#39;old_ig1&#39;, &#39;az&#39; =&gt; &#39;az1&#39; },
          { &#39;name&#39; =&gt; &#39;old_ig2&#39;, &#39;az&#39; =&gt; &#39;az2&#39; },
        ]
      end

      before do
        allow(provider_intent).to receive(:name=)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../deployment_plan/stages/agenda_spec.html#L9" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L202" class="js-smell-location">1</a>                  </div>  </li></ol>
        allow(provider_intent).to receive(:metadata=)
        allow(provider_intent).to receive(:consumable=)
        allow(provider_intent).to receive(:shared=)
        allow(provider_intent).to receive(:save)
      end

      it &#39;chooses the new instance group name if there is no match&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_migrated_from_providers_from_job)::context(when there is a new job during a migrated_from deploy)::it#chooses the new instance group name if there is no match has a flog score of 70</span>          </div>  </li></ol>
        expect(Bosh::Director::Models::Links::LinkProvider).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L169" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L210" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L216" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L338" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L380" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L386" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig1&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(nil)
        expect(Bosh::Director::Models::Links::LinkProvider).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L169" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L210" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L216" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L338" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L380" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L386" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig2&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(nil)
        expect(links_manager).to receive(:find_or_create_provider).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L175" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L222" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L344" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L392" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L887" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L1578" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment_model: deployment_model,
          instance_group_name: &#39;instance-group-name&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(provider)
        expect(links_manager).to receive(:find_or_create_provider_intent)
          .with(link_provider: provider, link_original_name: &#39;link_1_name&#39;, link_type: &#39;link_1_type&#39;)
          .and_return(provider_intent)

        subject.parse_migrated_from_providers_from_job(
          job_spec,
          deployment_plan.model,
          template,
          job_properties: job_properties,
          instance_group_name: &#39;instance-group-name&#39;,
          migrated_from: migrated_from,
        )
      end
    end
  end

  describe &#39;#parse_migrated_from_consumers_from_job&#39; do
    let(:consumer) { instance_double(Bosh::Director::Models::Links::LinkConsumer) }
    let(:consumer_intent) { instance_double(Bosh::Director::Models::Links::LinkConsumerIntent) }

    let(:job_properties) do
      {}
    end

    let(:release_consumers) do
      [{ name: &#39;link_1_name&#39;, type: &#39;link_1_type&#39; }]
    end

    let(:job_spec) do
      {
        &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
        &#39;release&#39; =&gt; &#39;release1&#39;,
        &#39;consumes&#39; =&gt; {
          &#39;link_1_name&#39; =&gt; {
            &#39;from&#39; =&gt; &#39;link_1_name_alias&#39;,
          },
        },
      }
    end

    context &#39;when the job belongs to an instance group that is being migrated&#39; do
      let(:release_consumers) do
        [
          {
            name: &#39;chocolate&#39;,
            type: &#39;flavour&#39;,
          },
        ]
      end

      let(:deployment_model) { BD::Models::Deployment.make(links_serial_id: serial_id) }
      let(:deployment_plan) { instance_double(Bosh::Director::DeploymentPlan::Planner) }
      let(:instance_model) { Bosh::Director::Models::Instance.make(deployment: deployment_model) }
      let(:serial_id) { 1 }
      let!(:consumer) do
        Bosh::Director::Models::Links::LinkConsumer.make(
          deployment: deployment_model,
          instance_group: &#39;old-ig1&#39;,
          name: &#39;foobar&#39;,
          type: &#39;job&#39;,
          serial_id: serial_id,
        )
      end

      let!(:consumer_intent) do
        Bosh::Director::Models::Links::LinkConsumerIntent.make(
          link_consumer: consumer,
          original_name: &#39;chocolate&#39;,
          name: &#39;chocolate&#39;,
          type: &#39;flavour&#39;,
          blocked: false,
          serial_id: serial_id,
        )
      end

      let(:link_consumers) do
        [consumer]
      end

      let(:job_spec) do
        {
          &#39;name&#39; =&gt; &#39;foobar&#39;,
          &#39;release&#39; =&gt; &#39;release1&#39;,
          &#39;properties&#39; =&gt; {},
          &#39;consumes&#39; =&gt; {
            &#39;chocolate&#39; =&gt; {
              &#39;from&#39; =&gt; &#39;chocolate&#39;,
            },
          },
        }
      end

      let(:migrated_from) do
        [
          { &#39;name&#39; =&gt; &#39;old_ig1&#39;, &#39;az&#39; =&gt; &#39;az1&#39; },
          { &#39;name&#39; =&gt; &#39;old_ig2&#39;, &#39;az&#39; =&gt; &#39;az2&#39; },
        ]
      end

      before do
        allow(deployment_model).to receive(:link_consumers).and_return(link_consumers)
      end

      it &#39;should update the instance_group name to match the existing provider&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_migrated_from_consumers_from_job)::context(when the job belongs to an instance group that is being migrated)::it#should update the instance_group name to match the existing provider has a flog score of 69</span>          </div>  </li></ol>
        expect(Bosh::Director::Models::Links::LinkConsumer).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L163" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L332" class="js-smell-location">1</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig1&#39;,
          name: &#39;foobar&#39;,
          type: &#39;job&#39;,
        ).and_return(consumer)
        expect(Bosh::Director::Models::Links::LinkConsumer).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L169" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L210" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L216" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L338" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L380" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L386" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig2&#39;,
          name: &#39;foobar&#39;,
          type: &#39;job&#39;,
        ).and_return(nil)
        expect(links_manager).to receive(:find_or_create_consumer)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L175" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L222" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L344" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L392" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L887" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L1578" class="js-smell-location">5</a>                  </div>  </li></ol>
          .with(deployment_model: deployment_model, instance_group_name: &#39;old_ig1&#39;, name: &#39;foobar&#39;, type: &#39;job&#39;)
          .and_return(consumer)
        expect(links_manager).to receive(:find_or_create_consumer_intent)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L347" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L398" class="js-smell-location">1</a>                  </div>  </li></ol>
          .with(link_consumer: consumer, link_original_name: &#39;chocolate&#39;, link_type: &#39;flavour&#39;, new_intent_metadata: nil)
          .and_return(consumer_intent)

        subject.parse_migrated_from_consumers_from_job(
          job_spec,
          deployment_model,
          template,
          instance_group_name: &#39;new-ig&#39;,
          migrated_from: migrated_from,
        )
      end
    end

    context &#39;when there is a new job during a migrated_from deploy&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_migrated_from_consumers_from_job)::context#when there is a new job during a migrated_from deploy has a flog score of 56</span>          </div>  </li></ol>
      let(:migrated_from) do
        [
          { &#39;name&#39; =&gt; &#39;old_ig1&#39;, &#39;az&#39; =&gt; &#39;az1&#39; },
          { &#39;name&#39; =&gt; &#39;old_ig2&#39;, &#39;az&#39; =&gt; &#39;az2&#39; },
        ]
      end

      before do
        allow(consumer).to receive(:name)
        allow(consumer).to receive(:instance_group)
        allow(consumer_intent).to receive(:name=)
        allow(consumer_intent).to receive(:metadata=)
        allow(consumer_intent).to receive(:blocked=)
        allow(consumer_intent).to receive(:optional=)
        allow(consumer_intent).to receive(:save)
      end

      it &#39;chooses the new instance group name if there is no match&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_migrated_from_consumers_from_job)::context(when there is a new job during a migrated_from deploy)::it#chooses the new instance group name if there is no match has a flog score of 69</span>          </div>  </li></ol>
        expect(Bosh::Director::Models::Links::LinkConsumer).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L169" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L210" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L216" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L338" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L380" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L386" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig1&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(nil)
        expect(Bosh::Director::Models::Links::LinkConsumer).to receive(:find).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L169" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L210" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L216" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L338" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L380" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L386" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment: deployment_model,
          instance_group: &#39;old_ig2&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(nil)
        expect(links_manager).to receive(:find_or_create_consumer).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L175" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L222" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L344" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L392" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L887" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L1578" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment_model: deployment_model,
          instance_group_name: &#39;instance-group-name&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(consumer)
        expect(links_manager).to receive(:find_or_create_consumer_intent).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L347" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L398" class="js-smell-location">1</a>                  </div>  </li></ol>
          link_consumer: consumer,
          link_original_name: &#39;link_1_name&#39;,
          link_type: &#39;link_1_type&#39;,
          new_intent_metadata: nil,
        ).and_return(consumer_intent)

        subject.parse_migrated_from_consumers_from_job(
          job_spec,
          deployment_plan.model,
          template,
          instance_group_name: &#39;instance-group-name&#39;,
          migrated_from: migrated_from,
        )
      end
    end
  end

  describe &#39;#parse_providers_from_job&#39; do
    let(:provider) { instance_double(Bosh::Director::Models::Links::LinkProvider) }
    let(:provider_intent) { instance_double(Bosh::Director::Models::Links::LinkProviderIntent) }

    let(:job_properties) do
      {}
    end

    context &#39;when the job does NOT define any provider in its release spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L424" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1155" class="js-smell-location">1</a>                  </div>  </li></ol>
      context &#39;when the manifest does not specify any providers&#39; do
        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;job_1&#39;,
          }
        end

        it &#39;should not create any provider and intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when the job does NOT define any provider in its release spec)::context(when the manifest does not specify any providers)::it#should not create any provider and intents has a flog score of 27</span>          </div>  </li></ol>
          expect(links_manager).to_not receive(:find_or_create_provider)
          expect(links_manager).to_not receive(:find_or_create_provider_intent)

          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: {},
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end
      end
    end

    context &#39;when a job defines a provider in its release spec&#39; do
      let(:release_providers) do
        [{ name: &#39;link_1_name&#39;, type: &#39;link_1_type&#39; }]
      end

      context &#39;when the job exposes properties in the provided link&#39; do
        let(:release_properties) do
          {
            &#39;street&#39; =&gt; { &#39;default&#39; =&gt; &#39;Any Street&#39; },
            &#39;scope&#39; =&gt; {},
            &#39;division.router&#39; =&gt; { &#39;default&#39; =&gt; &#39;Canada&#39; },
            &#39;division.priority&#39; =&gt; { &#39;default&#39; =&gt; &#39;NOW!&#39; },
            &#39;division.sequence&#39; =&gt; {},
          }
        end

        let(:release_providers) do
          [
            {
              name: &#39;link_1_name&#39;,
              type: &#39;link_1_type&#39;,
              properties:
                [&#39;street&#39;, &#39;scope&#39;, &#39;division.priority&#39;, &#39;division.sequence&#39;],
            },
          ]
        end

        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
            &#39;release&#39; =&gt; &#39;release1&#39;,
            &#39;properties&#39; =&gt; job_properties,
          }
        end

        let(:job_properties) do
          {
            &#39;street&#39; =&gt; &#39;Any Street&#39;,
            &#39;division&#39; =&gt; {
              &#39;priority&#39; =&gt; &#39;LOW&#39;,
              &#39;sequence&#39; =&gt; &#39;FIFO&#39;,
            },
          }
        end

        it &#39;should update the provider intent metadata with the correct mapped properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when a job defines a provider in its release spec)::context(when the job exposes properties in the provided link)::it#should update the provider intent metadata with the correct mapped properties has a flog score of 97</span>          </div>  </li></ol>
          expected_provider_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;instance-group-name&#39;,
            name: &#39;release1_job_name_1&#39;,
            type: &#39;job&#39;,
          }

          expect(links_manager).to receive(:find_or_create_provider).with(expected_provider_params).and_return(provider)

          expected_provider_intent_params = {
            link_provider: provider,
            link_original_name: &#39;link_1_name&#39;,
            link_type: &#39;link_1_type&#39;,
          }
          expect(links_manager).to receive(:find_or_create_provider_intent)
            .with(expected_provider_intent_params)
            .and_return(provider_intent)

          mapped_properties = {
            &#39;street&#39; =&gt; &#39;Any Street&#39;,
            &#39;scope&#39; =&gt; nil,
            &#39;division&#39; =&gt; {
              &#39;priority&#39; =&gt; &#39;LOW&#39;,
              &#39;sequence&#39; =&gt; &#39;FIFO&#39;,
            },
          }

          expect(provider_intent).to receive(:name=).with(&#39;link_1_name&#39;)
          expect(provider_intent).to receive(:metadata=).with({ mapped_properties: mapped_properties, custom: false }.to_json)
          expect(provider_intent).to receive(:consumable=).with(true)
          expect(provider_intent).to receive(:shared=).with(false)
          expect(provider_intent).to receive(:save)
          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: job_properties,
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end

        context &#39;when the exposed property is not defined in the release&#39; do
          let(:release_properties) do
            {
              &#39;street&#39; =&gt; { &#39;default&#39; =&gt; &#39;Any Street&#39; },
              &#39;division.router&#39; =&gt; { &#39;default&#39; =&gt; &#39;Canada&#39; },
              &#39;division.priority&#39; =&gt; { &#39;default&#39; =&gt; &#39;NOW!&#39; },
              &#39;division.sequence&#39; =&gt; {},
            }
          end

          let(:job_properties) do
            {
              &#39;street&#39; =&gt; &#39;Any Street&#39;,
              &#39;division&#39; =&gt; {
                &#39;priority&#39; =&gt; &#39;LOW&#39;,
                &#39;sequence&#39; =&gt; &#39;FIFO&#39;,
              },
            }
          end

          it &#39;raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when a job defines a provider in its release spec)::context(when the job exposes properties in the provided link)::context(when the exposed property is not defined in the release)::it#raise an error has a flog score of 82</span>          </div>  </li></ol>
            expected_provider_params = {
              deployment_model: deployment_plan.model,
              instance_group_name: &#39;instance-group-name&#39;,
              name: &#39;release1_job_name_1&#39;,
              type: &#39;job&#39;,
            }

            expect(links_manager).to receive(:find_or_create_provider).with(expected_provider_params).and_return(provider)
            expect(links_manager).to_not receive(:find_or_create_provider_intent)
            expect(provider_intent).to_not receive(:metadata=)
            expect(provider_intent).to_not receive(:shared=)
            expect(provider_intent).to_not receive(:name=)
            expect(provider_intent).to_not receive(:save)

            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(RuntimeError, &#39;Link property scope in template release1_job_name_1 is not defined in release spec&#39;)
          end
        end
      end

      context &#39;when a job does NOT define a provides section in manifest&#39; do
        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
            &#39;release&#39; =&gt; &#39;release1&#39;,
          }
        end

        it &#39;should add correct link providers and link providers intent to the DB&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when a job defines a provider in its release spec)::context(when a job does NOT define a provides section in manifest)::it#should add correct link providers and link providers intent to the DB has a flog score of 97</span>          </div>  </li></ol>
          expected_provider_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;instance-group-name&#39;,
            name: &#39;release1_job_name_1&#39;,
            type: &#39;job&#39;,
          }

          expect(links_manager).to receive(:find_or_create_provider).with(expected_provider_params).and_return(provider)

          expected_provider_intent_params = {
            link_provider: provider,
            link_original_name: &#39;link_1_name&#39;,
            link_type: &#39;link_1_type&#39;,
          }
          expect(links_manager).to receive(:find_or_create_provider_intent)
            .with(expected_provider_intent_params)
            .and_return(provider_intent)

          expect(provider_intent).to receive(:name=).with(&#39;link_1_name&#39;)
          expect(provider_intent).to receive(:metadata=).with({ mapped_properties: {}, custom: false }.to_json)
          expect(provider_intent).to receive(:consumable=).with(true)
          expect(provider_intent).to receive(:shared=).with(false)
          expect(provider_intent).to receive(:save)

          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: job_properties,
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end
      end

      context &#39;when a job defines a provides section in manifest&#39; do
        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
            &#39;release&#39; =&gt; &#39;release1&#39;,
            &#39;provides&#39; =&gt; {
              &#39;link_1_name&#39; =&gt; {
                &#39;as&#39; =&gt; &#39;link_1_name_alias&#39;,
                &#39;shared&#39; =&gt; true,
              },
            },
          }
        end

        let(:job_properties) do
          {}
        end

        it &#39;should add correct link providers and link providers intent to the DB&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when a job defines a provider in its release spec)::context(when a job defines a provides section in manifest)::it#should add correct link providers and link providers intent to the DB has a flog score of 108</span>          </div>  </li></ol>
          original_job_spec = Bosh::Common::DeepCopy.copy(job_spec)

          expected_provider_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;instance-group-name&#39;,
            name: &#39;release1_job_name_1&#39;,
            type: &#39;job&#39;,
          }

          expect(links_manager).to receive(:find_or_create_provider).with(expected_provider_params).and_return(provider)

          expected_provider_intent_params = {
            link_provider: provider,
            link_original_name: &#39;link_1_name&#39;,
            link_type: &#39;link_1_type&#39;,
          }
          expect(links_manager).to receive(:find_or_create_provider_intent)
            .with(expected_provider_intent_params)
            .and_return(provider_intent)

          expect(provider_intent).to receive(:name=).with(&#39;link_1_name_alias&#39;)
          expect(provider_intent).to receive(:metadata=).with({ mapped_properties: {}, custom: false }.to_json)
          expect(provider_intent).to receive(:consumable=).with(true)
          expect(provider_intent).to receive(:shared=).with(true)
          expect(provider_intent).to receive(:save)
          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: job_properties,
            instance_group_name: &#39;instance-group-name&#39;,
          )
          expect(job_spec).to eq(original_job_spec)
        end
      end

      context &#39;when a job defines a nil provides section in the manifest&#39; do
        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
            &#39;release&#39; =&gt; &#39;release1&#39;,
            &#39;provides&#39; =&gt; {
              &#39;link_1_name&#39; =&gt; &#39;nil&#39;,
            },
          }
        end

        it &#39;should set the intent consumable to false&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when a job defines a provider in its release spec)::context(when a job defines a nil provides section in the manifest)::it#should set the intent consumable to false has a flog score of 97</span>          </div>  </li></ol>
          expected_provider_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;instance-group-name&#39;,
            name: &#39;release1_job_name_1&#39;,
            type: &#39;job&#39;,
          }
          expect(links_manager).to receive(:find_or_create_provider).with(expected_provider_params).and_return(provider)

          expected_provider_intent_params = {
            link_provider: provider,
            link_original_name: &#39;link_1_name&#39;,
            link_type: &#39;link_1_type&#39;,
          }
          expect(links_manager).to receive(:find_or_create_provider_intent)
            .with(expected_provider_intent_params)
            .and_return(provider_intent)

          expect(provider_intent).to receive(:name=).with(&#39;link_1_name&#39;)
          expect(provider_intent).to receive(:metadata=).with({ mapped_properties: {}, custom: false }.to_json)
          expect(provider_intent).to receive(:consumable=).with(false)
          expect(provider_intent).to receive(:shared=).with(false)
          expect(provider_intent).to receive(:save)
          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: job_properties,
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end
      end

      context &#39;provider validation&#39; do
        before do
          expect(links_manager).to receive(:find_or_create_provider)
          expect(links_manager).to_not receive(:find_or_create_provider_intent)
        end

        context &#39;when a manifest job explicitly defines name or type for a provider&#39; do
          it &#39;should fail if there is a name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L731" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L756" class="js-smell-location">1</a>                  </div>  </li></ol>
            job_spec = {
              &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
              &#39;release&#39; =&gt; &#39;release1&#39;,
              &#39;provides&#39; =&gt; {
                &#39;link_1_name&#39; =&gt; {
                  &#39;name&#39; =&gt; &#39;better_link_1_name&#39;,
                  &#39;shared&#39; =&gt; true,
                },
              },
            }

            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(RuntimeError, &quot;Cannot specify &#39;name&#39; or &#39;type&#39; properties in the manifest for link &#39;link_1_name&#39;&quot;\
                                             &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;\
                                             &#39; Please provide these keys in the release only.&#39;)
          end

          it &#39;should fail if there is a type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L731" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L756" class="js-smell-location">1</a>                  </div>  </li></ol>
            job_spec = {
              &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
              &#39;release&#39; =&gt; &#39;release1&#39;,
              &#39;provides&#39; =&gt; {
                &#39;link_1_name&#39; =&gt; {
                  &#39;type&#39; =&gt; &#39;better_link_1_type&#39;,
                  &#39;shared&#39; =&gt; true,
                },
              },
            }

            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(RuntimeError, &quot;Cannot specify &#39;name&#39; or &#39;type&#39; properties in the manifest for link &#39;link_1_name&#39;&quot;\
                                             &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;\
                                             &#39; Please provide these keys in the release only.&#39;)
          end

          # TODO: Should not fail if no properties in spec or manifest
        end

        context &#39;when the provides section is not a hash&#39; do
          it &#39;raise an error&#39; do
            job_spec = {
              &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
              &#39;release&#39; =&gt; &#39;release1&#39;,
              &#39;provides&#39; =&gt; {
                &#39;link_1_name&#39; =&gt; [&#39;invalid stuff&#39;],
              },
            }

            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(RuntimeError, &quot;Provider &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; in instance group&quot;\
                                &quot; &#39;instance-group-name&#39; specified in the manifest should only be a hash or string &#39;nil&#39;&quot;)
          end

          context &quot;when it is a string that is not &#39;nil&#39;&quot; do
            it &#39;raise an error&#39; do
              job_spec = {
                &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
                &#39;release&#39; =&gt; &#39;release1&#39;,
                &#39;provides&#39; =&gt; {
                  &#39;link_1_name&#39; =&gt; &#39;invalid stuff&#39;,
                },
              }

              expect do
                subject.parse_providers_from_job(
                  job_spec,
                  deployment_plan.model,
                  template,
                  job_properties: job_properties,
                  instance_group_name: &#39;instance-group-name&#39;,
                )
              end.to raise_error(RuntimeError, &quot;Provider &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; in instance group&quot;\
                                  &quot; &#39;instance-group-name&#39; specified in the manifest should only be a hash or string &#39;nil&#39;&quot;)
            end
          end
        end
      end

      context &#39;when a manifest job defines a provider which is not specified in the release&#39; do
        it &#39;should fail because it does not match the release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when a job defines a provider in its release spec)::context(when a manifest job defines a provider which is not specified in the release)::it#should fail because it does not match the release has a flog score of 90</span>          </div>  </li></ol>
          job_spec = {
            &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
            &#39;release&#39; =&gt; &#39;release1&#39;,
            &#39;provides&#39; =&gt; {
              &#39;new_link_name&#39; =&gt; {
                &#39;shared&#39; =&gt; &#39;false&#39;,
              },
            },
          }

          expect(links_manager).to receive(:find_or_create_provider).and_return(provider)
          expect(links_manager).to receive(:find_or_create_provider_intent).and_return(provider_intent)

          expect(provider_intent).to receive(:name=).with(&#39;link_1_name&#39;)
          expect(provider_intent).to receive(:consumable=).with(true)
          expect(provider_intent).to receive(:metadata=).with({ mapped_properties: {}, custom: false }.to_json)
          expect(provider_intent).to receive(:shared=).with(false)
          expect(provider_intent).to receive(:save)
          expect(logger).to receive(:warn).with(&quot;Manifest defines unknown providers:\n&quot;\
                                                &quot;  - Job &#39;release1_job_name_1&#39; does not define link provider &#39;new_link_name&#39;&quot;\
                                                &#39; in the release spec&#39;)

          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: job_properties,
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end
      end
    end

    context &#39;when custom_provider_definitions is defined&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context#when custom_provider_definitions is defined has a flog score of 35</span>          </div>  </li></ol>
      let(:job_spec) do
        {
          &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
          &#39;release&#39; =&gt; &#39;release1&#39;,
          &#39;custom_provider_definitions&#39; =&gt; custom_providers,
        }
      end

      let(:custom_providers) do
        [{ &#39;name&#39; =&gt; &#39;my_special_provider&#39;, &#39;type&#39; =&gt; &#39;address&#39; }]
      end

      before do
        allow(provider_intent).to receive(:name=).with(&#39;my_special_provider&#39;)
        allow(provider_intent).to receive(:shared=)
        allow(provider_intent).to receive(:consumable=)
        allow(provider_intent).to receive(:save)
      end

      it &#39;creates the appropriate provider and provider intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when custom_provider_definitions is defined)::it#creates the appropriate provider and provider intents has a flog score of 58</span>          </div>  </li></ol>
        expect(links_manager).to receive(:find_or_create_provider).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L175" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L222" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L344" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L392" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L887" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L1578" class="js-smell-location">5</a>                  </div>  </li></ol>
          deployment_model: deployment_model,
          instance_group_name: &#39;instance-group-name&#39;,
          name: &#39;release1_job_name_1&#39;,
          type: &#39;job&#39;,
        ).and_return(provider)

        expect(links_manager).to receive(:find_or_create_provider_intent).with(
          link_provider: provider,
          link_original_name: &#39;my_special_provider&#39;,
          link_type: &#39;address&#39;,
        ).and_return(provider_intent)

        expect(provider_intent).to receive(:metadata=) do |metadata|
          expect(metadata[&#39;custom&#39;]).to be_truthy
        end

        subject.parse_providers_from_job(
          job_spec,
          deployment_model,
          template,
          job_properties: job_properties,
          instance_group_name: &#39;instance-group-name&#39;,
        )
      end

      context &#39;but custom_provider_definitions is an empty array&#39; do
        let(:custom_providers) { [] }

        it &#39;should not create any providers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when custom_provider_definitions is defined)::context(but custom_provider_definitions is an empty array)::it#should not create any providers has a flog score of 30</span>          </div>  </li></ol>
          expect(links_manager).to_not receive(:find_or_create_provider)
          expect(links_manager).to_not receive(:find_or_create_provider_intent)

          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: job_properties,
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end
      end

      context &#39;when definition is invalid&#39; do
        context &#39;when the custom definition does not specify name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L931" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L978" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:custom_providers) do
            [
              {
                &#39;type&#39; =&gt; &#39;address&#39;,
              },
            ]
          end

          it &#39;should return an error&#39; do
            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(&quot;Name for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                               &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
          end
        end

        context &#39;when the custom definition specifies an empty name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L954" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1001" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:custom_providers) do
            [
              {
                &#39;name&#39; =&gt; &#39;&#39;,
                &#39;type&#39; =&gt; &#39;address&#39;,
              },
            ]
          end

          it &#39;should return an error&#39; do
            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(&quot;Name for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                               &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
          end
        end

        context &#39;when the custom definition does not specify a type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L931" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L978" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:custom_providers) do
            [
              {
                &#39;name&#39; =&gt; &#39;custom_link_name&#39;,
              },
            ]
          end

          it &#39;should return an error&#39; do
            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(&quot;Type for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                               &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
          end
        end

        context &#39;when the custom definition specifies an empty type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L954" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1001" class="js-smell-location">1</a>                  </div>  </li></ol>
          let(:custom_providers) do
            [
              {
                &#39;name&#39; =&gt; &#39;custom_link_name&#39;,
                &#39;type&#39; =&gt; &#39;&#39;,
              },
            ]
          end

          it &#39;should return an error&#39; do
            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error(&quot;Type for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                               &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
          end
        end

        context &#39;when the custom definition specifies an invalid name and type&#39; do
          let(:custom_providers) do
            [
              {
                &#39;name&#39; =&gt; &#39;&#39;,
                &#39;type&#39; =&gt; &#39;&#39;,
              },
            ]
          end

          # rubocop:disable Style/MultilineBlockChain
          it &#39;should return an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1036" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1059" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L1130" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when custom_provider_definitions is defined)::context(when definition is invalid)::context(when the custom definition specifies an invalid name and type)::it#should return an error has a flog score of 44</span>          </div>  </li></ol>
            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error do |e|
              expect(e.message).to include(&quot;Name for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                                           &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
              expect(e.message).to include(&quot;Type for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                                           &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
            end
          end
          # rubocop:enable Style/MultilineBlockChain
        end

        context &#39;when the custom definition is missing both name and type&#39; do
          let(:custom_providers) { [{}] }

          # rubocop:disable Style/MultilineBlockChain
          it &#39;should return an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1036" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1059" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L1130" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when custom_provider_definitions is defined)::context(when definition is invalid)::context(when the custom definition is missing both name and type)::it#should return an error has a flog score of 44</span>          </div>  </li></ol>
            expect do
              subject.parse_providers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                job_properties: job_properties,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error do |e|
              expect(e.message).to include(&quot;Name for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                                           &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
              expect(e.message).to include(&quot;Type for custom link provider definition in manifest in job &#39;release1_job_name_1&#39;&quot;\
                                           &quot; in instance group &#39;instance-group-name&#39; must be a valid non-empty string.&quot;)
            end
          end
          # rubocop:enable Style/MultilineBlockChain
        end
      end

      context &#39;when the custom definition has the same name as a provider from release definition&#39; do
        let(:release_providers) do
          [{ name: &#39;link_1_name&#39;, type: &#39;link_1_type&#39; }]
        end

        let(:custom_providers) do
          [
            {
              &#39;name&#39; =&gt; &#39;link_1_name&#39;,
              &#39;type&#39; =&gt; &#39;address&#39;,
            },
          ]
        end

        it &#39;should raise an error&#39; do
          expect do
            subject.parse_providers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              job_properties: job_properties,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end.to raise_error(&quot;Custom provider &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;&quot;\
                             &quot; is already defined in release &#39;release1&#39;&quot;)
        end
      end

      context &#39;when the custom definitions conflict with each other&#39; do
        let(:custom_providers) do
          [
            {
              &#39;name&#39; =&gt; &#39;link_1_name&#39;,
              &#39;type&#39; =&gt; &#39;address&#39;,
            },
            {
              &#39;name&#39; =&gt; &#39;link_1_name&#39;,
              &#39;type&#39; =&gt; &#39;smurf&#39;,
            },
            {
              &#39;name&#39; =&gt; &#39;link_2_name&#39;,
              &#39;type&#39; =&gt; &#39;address&#39;,
            },
            {
              &#39;name&#39; =&gt; &#39;link_2_name&#39;,
              &#39;type&#39; =&gt; &#39;smurf&#39;,
            },
          ]
        end

        # rubocop:disable Style/MultilineBlockChain
        it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1036" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1059" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L1130" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_providers_from_job)::context(when custom_provider_definitions is defined)::context(when the custom definitions conflict with each other)::it#should raise an error has a flog score of 38</span>          </div>  </li></ol>
          expect do
            subject.parse_providers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              job_properties: job_properties,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end.to raise_error do |e|
            expect(e.message).to match(&quot;Custom provider &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; in instance group&quot;\
                                       &quot; &#39;instance-group-name&#39; is defined multiple times in manifest.&quot;)
            expect(e.message).to match(&quot;Custom provider &#39;link_2_name&#39; in job &#39;release1_job_name_1&#39; in instance group&quot;\
                                       &quot; &#39;instance-group-name&#39; is defined multiple times in manifest.&quot;)
          end
        end
        # rubocop:enable Style/MultilineBlockChain
      end
    end
  end

  describe &#39;#parse_consumers_from_job&#39; do
    let(:consumer) { instance_double(Bosh::Director::Models::Links::LinkConsumer) }
    let(:consumer_intent) { instance_double(Bosh::Director::Models::Links::LinkConsumerIntent) }

    context &#39;when the job does NOT define any consumer in its release spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L424" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1155" class="js-smell-location">1</a>                  </div>  </li></ol>
      context &#39;when the manifest does not specify any providers&#39; do
        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;job_1&#39;,
          }
        end

        it &#39;should not create any provider and intents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when the job does NOT define any consumer in its release spec)::context(when the manifest does not specify any providers)::it#should not create any provider and intents has a flog score of 27</span>          </div>  </li></ol>
          expect(links_manager).to_not receive(:find_or_create_consumer)
          expect(links_manager).to_not receive(:find_or_create_consumer_intent)

          subject.parse_providers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            job_properties: {},
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end
      end
    end

    context &#39;when a job defines a consumer in its release spec&#39; do
      context &#39;when consumer is implicit (not specified in the deployment manifest)&#39; do
        let(:release_consumers) do
          [
            { name: &#39;link_1_name&#39;, type: &#39;link_1_type&#39; },
          ]
        end

        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
            &#39;release&#39; =&gt; &#39;release1&#39;,
          }
        end

        it &#39;should add the consumer and consumer intent to the DB&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is implicit (not specified in the deployment manifest))::it#should add the consumer and consumer intent to the DB has a flog score of 95</span>          </div>  </li></ol>
          expected_consumer_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;instance-group-name&#39;,
            name: &#39;release1_job_name_1&#39;,
            type: &#39;job&#39;,
          }

          expect(links_manager).to receive(:find_or_create_consumer).with(expected_consumer_params).and_return(consumer)

          expected_consumer_intent_params = {
            link_consumer: consumer,
            link_original_name: &#39;link_1_name&#39;,
            link_type: &#39;link_1_type&#39;,
            new_intent_metadata: nil,
          }

          expect(links_manager).to receive(:find_or_create_consumer_intent)
            .with(expected_consumer_intent_params)
            .and_return(consumer_intent)

          expect(consumer_intent).to receive(:name=).with(&#39;link_1_name&#39;)
          expect(consumer_intent).to receive(:blocked=).with(false)
          expect(consumer_intent).to receive(:optional=).with(false)
          expect(consumer_intent).to receive(:metadata=).with({ explicit_link: false }.to_json)
          expect(consumer_intent).to receive(:save)

          subject.parse_consumers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            instance_group_name: &#39;instance-group-name&#39;,
          )
        end

        context &#39;when the release spec defines the link as optional&#39; do
          let(:release_consumers) do
            [
              { name: &#39;link_1_name&#39;, type: &#39;link_1_type&#39;, optional: true },
            ]
          end

          it &#39;sets consumer intent optional field to true&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is implicit (not specified in the deployment manifest))::context(when the release spec defines the link as optional)::it#sets consumer intent optional field to true has a flog score of 90</span>          </div>  </li></ol>
            expect(links_manager).to receive(:find_or_create_consumer).and_return(consumer)
            expect(links_manager).to receive(:find_or_create_consumer_intent).and_return(consumer_intent)

            expect(consumer_intent).to receive(:metadata=).with({ explicit_link: false }.to_json)
            expect(consumer_intent).to receive(:name=).with(&#39;link_1_name&#39;)
            expect(consumer_intent).to receive(:blocked=).with(false)
            expect(consumer_intent).to receive(:optional=).with(true)
            expect(consumer_intent).to receive(:save)

            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end
        end
      end

      context &#39;when consumer is explicit (specified in the deployment manifest)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))#when consumer is explicit (specified in the deployment manifest) has a flog score of 44</span>          </div>  </li></ol>
        let(:release_consumers) do
          [{ name: &#39;link_1_name&#39;, type: &#39;link_1_type&#39; }]
        end
        let(:consumer_options) do
          { &#39;from&#39; =&gt; &#39;snoopy&#39; }
        end
        let(:manifest_link_consumers) do
          { &#39;link_1_name&#39; =&gt; consumer_options }
        end
        let(:job_spec) do
          {
            &#39;name&#39; =&gt; &#39;release1_job_name_1&#39;,
            &#39;release&#39; =&gt; &#39;release1&#39;,
            &#39;consumes&#39; =&gt; manifest_link_consumers,
          }
        end

        before do
          allow(consumer).to receive(:name)
          allow(consumer).to receive(:instance_group)
          allow(links_manager).to receive(:find_or_create_consumer).and_return(consumer)
          allow(links_manager).to receive(:find_or_create_consumer_intent).and_return(consumer_intent)
        end

        it &#39;should add the consumer and consumer intent to the DB&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::it#should add the consumer and consumer intent to the DB has a flog score of 106</span>          </div>  </li></ol>
          original_job_spec = Bosh::Common::DeepCopy.copy(job_spec)

          expected_consumer_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;instance-group-name&#39;,
            name: &#39;release1_job_name_1&#39;,
            type: &#39;job&#39;,
          }

          expect(links_manager).to receive(:find_or_create_consumer).with(expected_consumer_params).and_return(consumer)

          expected_consumer_intent_params = {
            link_consumer: consumer,
            link_original_name: &#39;link_1_name&#39;,
            link_type: &#39;link_1_type&#39;,
            new_intent_metadata: nil,
          }

          expect(links_manager).to receive(:find_or_create_consumer_intent)
            .with(expected_consumer_intent_params)
            .and_return(consumer_intent)

          expect(consumer_intent).to receive(:name=).with(&#39;snoopy&#39;)
          expect(consumer_intent).to receive(:blocked=).with(false)
          expect(consumer_intent).to receive(:metadata=).with({ explicit_link: true }.to_json)
          expect(consumer_intent).to receive(:optional=).with(false)
          expect(consumer_intent).to receive(:save)

          subject.parse_consumers_from_job(
            job_spec,
            deployment_plan.model,
            template,
            instance_group_name: &#39;instance-group-name&#39;,
          )
          expect(job_spec).to eq(original_job_spec)
        end

        context &#39;when the consumer alias is separated by &quot;.&quot;&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer alias is separated by "." has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) do
            { &#39;from&#39; =&gt; &#39;foo.bar.baz&#39; }
          end

          before do
            allow(consumer_intent).to receive(:blocked=)
            allow(consumer_intent).to receive(:metadata=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:save)
          end

          it &#39;should use the last segment in &quot;from&quot; as the alias&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1330" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1375" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(consumer_intent).to receive(:name=).with(&#39;baz&#39;)
            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end
        end

        context &#39;when the consumer is explicitly set to nil&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer is explicitly set to nil has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) { &#39;nil&#39; }

          before do
            allow(consumer_intent).to receive(:name=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:metadata=)
            allow(consumer_intent).to receive(:save)
          end

          it &#39;should set the consumer intent blocked&#39; do
            expect(consumer_intent).to receive(:blocked=).with(true)

            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end
        end

        context &#39;when the consumer does not have a from key&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer does not have a from key has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) do
            {}
          end

          before do
            allow(consumer_intent).to receive(:blocked=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:metadata=)
            allow(consumer_intent).to receive(:save)
          end

          it &#39;should set the consumer intent name to original name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1330" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1375" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(consumer_intent).to receive(:name=).with(&#39;link_1_name&#39;)

            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end
        end

        context &#39;when the consumer specifies a specific network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer specifies a specific network has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) do
            { &#39;network&#39; =&gt; &#39;charlie&#39; }
          end

          before do
            allow(consumer_intent).to receive(:name=)
            allow(consumer_intent).to receive(:blocked=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:save)
          end

          it &#39;will add specified network name to the metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(when the consumer specifies a specific network)::it#will add specified network name to the metadata has a flog score of 26</span>          </div>  </li></ol>
            allow(consumer_intent).to receive(:metadata=).with({ explicit_link: true, network: &#39;charlie&#39; }.to_json)
            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end
        end

        context &#39;when the consumer specifies to use ip addresses only&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer specifies to use ip addresses only has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) do
            { &#39;ip_addresses&#39; =&gt; true }
          end

          before do
            allow(consumer_intent).to receive(:name=)
            allow(consumer_intent).to receive(:blocked=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:save)
          end

          it &#39;will set the ip_addresses flag in the metadata to true&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(when the consumer specifies to use ip addresses only)::it#will set the ip_addresses flag in the metadata to true has a flog score of 26</span>          </div>  </li></ol>
            allow(consumer_intent).to receive(:metadata=).with({ explicit_link: true, ip_addresses: true }.to_json)
            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end
        end

        context &#39;when the consumer specifies to use a deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer specifies to use a deployment has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) do
            { &#39;deployment&#39; =&gt; &#39;some-other-deployment&#39; }
          end

          before do
            allow(consumer_intent).to receive(:name=)
            allow(consumer_intent).to receive(:blocked=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:save)
          end

          context &#39;when the provider deployment exists&#39; do
            before do
              Bosh::Director::Models::Deployment.make(name: &#39;some-other-deployment&#39;)
            end

            it &#39;will set the from_deployment flag in the metadata to the provider deployment name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(when the consumer specifies to use a deployment)::context(when the provider deployment exists)::it#will set the from_deployment flag in the metadata to the provider deployment name has a flog score of 27</span>          </div>  </li></ol>
              metadata_parameters = { explicit_link: true, from_deployment: &#39;some-other-deployment&#39; }.to_json
              allow(consumer_intent).to receive(:metadata=).with(metadata_parameters)
              subject.parse_consumers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end
          end

          context &#39;when the provider deployment exists&#39; do
            it &#39;raise an error&#39; do
              expect do
                subject.parse_consumers_from_job(
                  job_spec,
                  deployment_plan.model,
                  template,
                  instance_group_name: &#39;instance-group-name&#39;,
                )
              end.to raise_error &quot;Link &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; from instance group &#39;instance-group-name&#39;&quot;\
                                 &quot; consumes from deployment &#39;some-other-deployment&#39;, but the deployment does not exist.&quot;
            end
          end
        end

        context &#39;when the consumer specifies the name key in the consumes section of the manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1477" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1503" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer specifies the name key in the consumes section of the manifest has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) do
            { &#39;name&#39; =&gt; &#39;i should not be here&#39; }
          end

          before do
            allow(consumer_intent).to receive(:name=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:save)
            allow(consumer_intent).to receive(:metadata=)
          end

          it &#39;raise an error&#39; do
            expect do
              subject.parse_consumers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error &quot;Cannot specify &#39;name&#39; or &#39;type&#39; properties in the manifest for link &#39;link_1_name&#39;&quot;\
                               &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;\
                               &#39; Please provide these keys in the release only.&#39;
          end
        end

        context &#39;when the consumer specifies the type key in the consumes section of the manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1477" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1503" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when the consumer specifies the type key in the consumes section of the manifest has a flog score of 37</span>          </div>  </li></ol>
          let(:consumer_options) do
            { &#39;type&#39; =&gt; &#39;i should not be here&#39; }
          end

          before do
            allow(consumer_intent).to receive(:name=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:save)
            allow(consumer_intent).to receive(:metadata=)
          end

          it &#39;raise an error&#39; do
            expect do
              subject.parse_consumers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end.to raise_error &quot;Cannot specify &#39;name&#39; or &#39;type&#39; properties in the manifest for link &#39;link_1_name&#39;&quot;\
                               &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;\
                               &#39; Please provide these keys in the release only.&#39;
          end
        end

        context &#39;when processing manual links&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context#when processing manual links has a flog score of 137</span>          </div>  </li></ol>
          let(:manual_provider) { instance_double(Bosh::Director::Models::Links::LinkProvider) }
          let(:manual_provider_intent) { instance_double(Bosh::Director::Models::Links::LinkProviderIntent) }
          let(:consumer_options) do
            {
              &#39;instances&#39; =&gt; &#39;instances definition&#39;,
              &#39;properties&#39; =&gt; &#39;property definitions&#39;,
              &#39;address&#39; =&gt; &#39;address definition&#39;,
            }
          end

          before do
            allow(deployment_model).to receive(:name).and_return(&#39;charlie&#39;)

            allow(consumer_intent).to receive(:name=)
            allow(consumer_intent).to receive(:blocked=)
            allow(consumer_intent).to receive(:optional=)
            allow(consumer_intent).to receive(:metadata=)
            allow(consumer_intent).to receive(:save)

            allow(consumer_intent).to receive(:original_name).and_return(&#39;link_1_name&#39;)
            allow(consumer_intent).to receive(:type).and_return(&#39;link_1_type&#39;)

            allow(consumer).to receive(:deployment).and_return(deployment_model)
            allow(consumer).to receive(:instance_group).and_return(&#39;consumer_instance_group&#39;)
            allow(consumer).to receive(:name).and_return(&#39;consumer_name&#39;)

            allow(manual_provider_intent).to receive(:content=)
            allow(manual_provider_intent).to receive(:name=)
            expect(manual_provider_intent).to receive(:save)
          end

          it &#39;adds manual_link flag as true to the consumer intents metadata&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(when processing manual links)::it#adds manual_link flag as true to the consumer intents metadata has a flog score of 51</span>          </div>  </li></ol>
            allow(links_manager).to receive(:find_or_create_provider).and_return(manual_provider)
            allow(links_manager).to receive(:find_or_create_provider_intent).and_return(manual_provider_intent)

            expect(consumer_intent).to receive(:metadata=).with({ explicit_link: true, manual_link: true }.to_json)

            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end

          it &#39;creates a manual provider in the database&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(when processing manual links)::it#creates a manual provider in the database has a flog score of 43</span>          </div>  </li></ol>
            allow(links_manager).to receive(:find_or_create_provider_intent).and_return(manual_provider_intent)

            expect(links_manager).to receive(:find_or_create_provider).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L175" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L222" class="js-smell-location">1</a>                  <a href="links_parser_spec.html#L344" class="js-smell-location">2</a>                  <a href="links_parser_spec.html#L392" class="js-smell-location">3</a>                  <a href="links_parser_spec.html#L887" class="js-smell-location">4</a>                  <a href="links_parser_spec.html#L1578" class="js-smell-location">5</a>                  </div>  </li></ol>
              deployment_model: deployment_model,
              instance_group_name: &#39;consumer_instance_group&#39;,
              name: &#39;consumer_name&#39;,
              type: &#39;manual&#39;,
            ).and_return(manual_provider)

            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end

          it &#39;creates a manual provider intent in the database&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(when processing manual links)::it#creates a manual provider intent in the database has a flog score of 66</span>          </div>  </li></ol>
            allow(links_manager).to receive(:find_or_create_provider).and_return(manual_provider)

            expect(links_manager).to receive(:find_or_create_provider_intent).with(
              link_provider: manual_provider,
              link_original_name: &#39;link_1_name&#39;,
              link_type: &#39;link_1_type&#39;,
            ).and_return(manual_provider_intent)

            expected_content = {
              &#39;instances&#39; =&gt; &#39;instances definition&#39;,
              &#39;properties&#39; =&gt; &#39;property definitions&#39;,
              &#39;address&#39; =&gt; &#39;address definition&#39;,
              &#39;deployment_name&#39; =&gt; &#39;charlie&#39;,
            }

            expect(manual_provider_intent).to receive(:name=).with(&#39;link_1_name&#39;)
            expect(manual_provider_intent).to receive(:content=).with(expected_content.to_json)

            subject.parse_consumers_from_job(
              job_spec,
              deployment_plan.model,
              template,
              instance_group_name: &#39;instance-group-name&#39;,
            )
          end

          context &#39;when the manual link has keys that are not whitelisted&#39; do
            let(:consumer_options) do
              {
                &#39;instances&#39; =&gt; &#39;instances definition&#39;,
                &#39;properties&#39; =&gt; &#39;property definitions&#39;,
                &#39;address&#39; =&gt; &#39;address definition&#39;,
                &#39;foo&#39; =&gt; &#39;bar&#39;,
                &#39;baz&#39; =&gt; &#39;boo&#39;,
              }
            end

            it &#39;should only add whitelisted values&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(when processing manual links)::context(when the manual link has keys that are not whitelisted)::it#should only add whitelisted values has a flog score of 58</span>          </div>  </li></ol>
              allow(links_manager).to receive(:find_or_create_provider).and_return(manual_provider)

              expect(links_manager).to receive(:find_or_create_provider_intent).with(
                link_provider: manual_provider,
                link_original_name: &#39;link_1_name&#39;,
                link_type: &#39;link_1_type&#39;,
              ).and_return(manual_provider_intent)

              expected_content = {
                &#39;instances&#39; =&gt; &#39;instances definition&#39;,
                &#39;properties&#39; =&gt; &#39;property definitions&#39;,
                &#39;address&#39; =&gt; &#39;address definition&#39;,
                &#39;deployment_name&#39; =&gt; &#39;charlie&#39;,
              }

              expect(manual_provider_intent).to receive(:content=).with(expected_content.to_json)

              subject.parse_consumers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end
          end
        end

        context &#39;consumer validation&#39; do
          # rubocop:disable Style/MultilineBlockChain
          context &quot;when &#39;instances&#39; and &#39;from&#39; keywords are specified at the same time&quot; do
            let(:consumer_options) do
              { &#39;from&#39; =&gt; &#39;snoopy&#39;, &#39;instances&#39; =&gt; [&#39;1.2.3.4&#39;] }
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(consumer validation)::context(when 'instances' and 'from' keywords are specified at the same time)::it#should raise an error has a flog score of 32</span>          </div>  </li></ol>
              expect do
                subject.parse_consumers_from_job(
                  job_spec,
                  deployment_plan.model,
                  template,
                  instance_group_name: &#39;instance-group-name&#39;,
                )
              end.to raise_error do |e|
                expect(e.message).to include(&quot;Cannot specify both &#39;instances&#39; and &#39;from&#39; keys for link &#39;link_1_name&#39;&quot;\
                                             &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;)
              end
            end
          end

          context &quot;when &#39;properties&#39; and &#39;from&#39; keywords are specified at the same time&quot; do
            let(:consumer_options) do
              { &#39;from&#39; =&gt; &#39;snoopy&#39;, &#39;properties&#39; =&gt; { &#39;meow&#39; =&gt; &#39;cat&#39; } }
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(consumer validation)::context(when 'properties' and 'from' keywords are specified at the same time)::it#should raise an error has a flog score of 32</span>          </div>  </li></ol>
              expect do
                subject.parse_consumers_from_job(
                  job_spec,
                  deployment_plan.model,
                  template,
                  instance_group_name: &#39;instance-group-name&#39;,
                )
              end.to raise_error do |e|
                expect(e.message).to include(&quot;Cannot specify both &#39;properties&#39; and &#39;from&#39; keys for link &#39;link_1_name&#39;&quot;\
                                             &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;)
              end
            end
          end

          context &quot;when &#39;properties&#39; is defined but &#39;instances&#39; is not&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1701" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1721" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:consumer_options) do
              { &#39;properties&#39; =&gt; &#39;snoopy&#39; }
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(consumer validation)::context(when 'properties' is defined but 'instances' is not)::it#should raise an error has a flog score of 32</span>          </div>  </li></ol>
              expect do
                subject.parse_consumers_from_job(
                  job_spec,
                  deployment_plan.model,
                  template,
                  instance_group_name: &#39;instance-group-name&#39;,
                )
              end.to raise_error do |e|
                expect(e.message).to include(&quot;Cannot specify &#39;properties&#39; without &#39;instances&#39; for link &#39;link_1_name&#39;&quot;\
                                             &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;)
              end
            end
          end

          context &quot;when &#39;ip_addresses&#39; value is not a boolean&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1701" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L1721" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:consumer_options) do
              { &#39;ip_addresses&#39; =&gt; &#39;not a boolean&#39; }
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(consumer validation)::context(when 'ip_addresses' value is not a boolean)::it#should raise an error has a flog score of 32</span>          </div>  </li></ol>
              expect do
                subject.parse_consumers_from_job(
                  job_spec,
                  deployment_plan.model,
                  template,
                  instance_group_name: &#39;instance-group-name&#39;,
                )
              end.to raise_error do |e|
                expect(e.message).to include(&quot;Cannot specify non boolean values for &#39;ip_addresses&#39; field for link &#39;link_1_name&#39;&quot;\
                                             &quot; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;.&quot;)
              end
            end
          end
          # rubocop:enable Style/MultilineBlockChain

          context &#39;when the manifest specifies consumers that are not defined in the release spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(consumer validation)::context#when the manifest specifies consumers that are not defined in the release spec has a flog score of 52</span>          </div>  </li></ol>
            before do
              allow(consumer_intent).to receive(:name=)
              allow(consumer_intent).to receive(:blocked=)
              allow(consumer_intent).to receive(:optional=)
              allow(consumer_intent).to receive(:metadata=)
              allow(consumer_intent).to receive(:save)

              manifest_link_consumers[&#39;first_undefined&#39;] = {}
              manifest_link_consumers[&#39;second_undefined&#39;] = {}
            end

            it &#39;should raise an error for each undefined consumer&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_job)::context(when a job defines a consumer in its release spec)::context(when consumer is explicit (specified in the deployment manifest))::context(consumer validation)::context(when the manifest specifies consumers that are not defined in the release spec)::it#should raise an error for each undefined consumer has a flog score of 27</span>          </div>  </li></ol>
              expected_error = [
                &#39;Manifest defines unknown consumers:&#39;,
                &quot;  - Job &#39;release1_job_name_1&#39; does not define link consumer &#39;first_undefined&#39; in the release spec&quot;,
                &quot;  - Job &#39;release1_job_name_1&#39; does not define link consumer &#39;second_undefined&#39; in the release spec&quot;,
              ].join(&quot;\n&quot;)
              expect(logger).to receive(:warn).with(expected_error)

              subject.parse_consumers_from_job(
                job_spec,
                deployment_plan.model,
                template,
                instance_group_name: &#39;instance-group-name&#39;,
              )
            end
          end

          context &#39;when the manifest specifies consumers that are not hashes or &quot;nil&quot; string&#39; do
            context &#39;consumer is an array&#39; do
              let(:consumer_options) { [&#39;Unaccepted type array&#39;] }

              it &#39;should raise an error&#39; do
                expect do
                  subject.parse_consumers_from_job(
                    job_spec,
                    deployment_plan.model,
                    template,
                    instance_group_name: &#39;instance-group-name&#39;,
                  )
                end.to raise_error &quot;Consumer &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;&quot;\
                                   &quot; specified in the manifest should only be a hash or string &#39;nil&#39;&quot;
              end
            end

            context &#39;consumer is a string that is not &quot;nil&quot;&#39; do
              let(:consumer_options) { &#39;Unaccepted string value&#39; }

              it &#39;should raise an error&#39; do
                expect do
                  subject.parse_consumers_from_job(
                    job_spec,
                    deployment_plan.model,
                    template,
                    instance_group_name: &#39;instance-group-name&#39;,
                  )
                end.to raise_error &quot;Consumer &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;&quot;\
                                   &quot; specified in the manifest should only be a hash or string &#39;nil&#39;&quot;
              end
            end

            context &#39;consumer is empty or set to null&#39; do
              let(:consumer_options) { nil }

              it &#39;should raise an error&#39; do
                expect do
                  subject.parse_consumers_from_job(
                    job_spec,
                    deployment_plan.model,
                    template,
                    instance_group_name: &#39;instance-group-name&#39;,
                  )
                end.to raise_error &quot;Consumer &#39;link_1_name&#39; in job &#39;release1_job_name_1&#39; in instance group &#39;instance-group-name&#39;&quot;\
                                   &quot; specified in the manifest should only be a hash or string &#39;nil&#39;&quot;
              end
            end
          end
        end
      end
    end
  end

  describe &#39;#parse_provider_from_disk&#39; do
    let(:provider) { instance_double(Bosh::Director::Models::Links::LinkProvider) }
    let(:provider_intent) { instance_double(Bosh::Director::Models::Links::LinkProviderIntent) }

    context &#39;when persistent disks are well formatted&#39; do
      it &#39;parses successfully&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#parse_provider_from_disk)::context(when persistent disks are well formatted)::it#parses successfully has a flog score of 68</span>          </div>  </li></ol>
        expected_provider_params = {
          deployment_model: deployment_plan.model,
          instance_group_name: &#39;instance-group-name&#39;,
          name: &#39;instance-group-name&#39;,
          type: &#39;disk&#39;,
        }
        expect(links_manager).to receive(:find_or_create_provider).with(expected_provider_params).and_return(provider)
        expected_provider_intent_params = {
          link_provider: provider,
          link_original_name: &#39;my-disk&#39;,
          link_type: &#39;disk&#39;,
        }
        expect(links_manager).to receive(:find_or_create_provider_intent)
          .with(expected_provider_intent_params)
          .and_return(provider_intent)
        expect(provider_intent).to receive(:shared=)
        expect(provider_intent).to receive(:name=).with(&#39;my-disk&#39;)
        expect(provider_intent).to receive(:content=)
        expect(provider_intent).to receive(:save)
        #  expect not to raise an error
        disk_spec = { &#39;name&#39; =&gt; &#39;my-disk&#39;, &#39;type&#39; =&gt; &#39;disk-type-small&#39; }
        subject.parse_provider_from_disk(disk_spec, deployment_plan.model, &#39;instance-group-name&#39;)
      end
    end
  end

  describe &#39;#parse_consumers_from_variable&#39; do
    let(:consumer) { instance_double(Bosh::Director::Models::Links::LinkConsumer) }
    let(:consumer_intent) { instance_double(Bosh::Director::Models::Links::LinkConsumerIntent) }

    context &#39;when the variable defines &quot;alternative_name&quot; consumer&#39; do
      it &#39;makes consumer and consumer intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_variable)::context(when the variable defines "alternative_name" consumer)::it#makes consumer and consumer intent has a flog score of 57</span>          </div>  </li></ol>
        expected_consumer_params = {
          deployment_model: deployment_plan.model,
          instance_group_name: &#39;&#39;,
          name: &#39;bbs&#39;,
          type: &#39;variable&#39;,
        }
        expect(links_manager).to receive(:find_or_create_consumer).with(expected_consumer_params).and_return(consumer)
        expected_consumer_intent_params = {
          link_consumer: consumer,
          link_original_name: &#39;alternative_name&#39;,
          link_type: &#39;address&#39;,
          new_intent_metadata: { explicit_link: true },
        }
        expect(links_manager).to receive(:find_or_create_consumer_intent)
                                   .with(expected_consumer_intent_params)
                                   .and_return(consumer_intent)
        expect(consumer_intent).to receive(:name=).with(&#39;foo&#39;)
        expect(consumer_intent).to receive(:save)

        variable_spec = {
          &#39;name&#39; =&gt; &#39;bbs&#39;,
          &#39;type&#39; =&gt; &#39;certificate&#39;,
          &#39;consumes&#39; =&gt; {
            &#39;alternative_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; },
          },
        }
        subject.parse_consumers_from_variable(variable_spec, deployment_plan.model)
      end

      context &#39;and the `from` is not specified&#39; do
        it &#39;makes consumer and consumer intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_variable)::context(when the variable defines "alternative_name" consumer)::context(and the `from` is not specified)::it#makes consumer and consumer intent has a flog score of 57</span>          </div>  </li></ol>
          expected_consumer_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;&#39;,
            name: &#39;bbs&#39;,
            type: &#39;variable&#39;,
          }
          expect(links_manager).to receive(:find_or_create_consumer).with(expected_consumer_params).and_return(consumer)
          expected_consumer_intent_params = {
            link_consumer: consumer,
            link_original_name: &#39;alternative_name&#39;,
            link_type: &#39;address&#39;,
            new_intent_metadata: { explicit_link: true },
          }
          expect(links_manager).to receive(:find_or_create_consumer_intent)
                                     .with(expected_consumer_intent_params)
                                     .and_return(consumer_intent)
          expect(consumer_intent).to receive(:name=).with(&#39;alternative_name&#39;)
          expect(consumer_intent).to receive(:save)

          variable_spec = {
            &#39;name&#39; =&gt; &#39;bbs&#39;,
            &#39;type&#39; =&gt; &#39;certificate&#39;,
            &#39;consumes&#39; =&gt; {
              &#39;alternative_name&#39; =&gt; {},
            },
          }
          subject.parse_consumers_from_variable(variable_spec, deployment_plan.model)
        end
      end

      context &#39;and the `wildcard` is true&#39; do
        it &#39;makes consumer and consumer intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_variable)::context(when the variable defines "alternative_name" consumer)::context(and the `wildcard` is true)::it#makes consumer and consumer intent has a flog score of 57</span>          </div>  </li></ol>
          expected_consumer_params = {
            deployment_model: deployment_plan.model,
            instance_group_name: &#39;&#39;,
            name: &#39;bbs&#39;,
            type: &#39;variable&#39;,
          }
          expect(links_manager).to receive(:find_or_create_consumer).with(expected_consumer_params).and_return(consumer)
          expected_consumer_intent_params = {
            link_consumer: consumer,
            link_original_name: &#39;alternative_name&#39;,
            link_type: &#39;address&#39;,
            new_intent_metadata: { explicit_link: true, wildcard: true },
          }
          expect(links_manager).to receive(:find_or_create_consumer_intent)
            .with(expected_consumer_intent_params)
            .and_return(consumer_intent)
          expect(consumer_intent).to receive(:name=).with(&#39;foo&#39;)
          expect(consumer_intent).to receive(:save)

          variable_spec = {
            &#39;name&#39; =&gt; &#39;bbs&#39;,
            &#39;type&#39; =&gt; &#39;certificate&#39;,
            &#39;consumes&#39; =&gt; {
              &#39;alternative_name&#39; =&gt; {
                &#39;from&#39; =&gt; &#39;foo&#39;,
                &#39;properties&#39; =&gt; { &#39;wildcard&#39; =&gt; true },
              },
            },
          }
          subject.parse_consumers_from_variable(variable_spec, deployment_plan.model)
        end
      end
    end

    context &#39;when the variable does not define a consumes block&#39; do
      it &#39;should not create any implicit consumers or intents&#39; do
        expect(links_manager).to_not receive(:find_or_create_consumer)
        expect(links_manager).to_not receive(:find_or_create_consumer_intent)

        variable_spec = {
          &#39;name&#39; =&gt; &#39;bbs&#39;,
          &#39;type&#39; =&gt; &#39;certificate&#39;,
        }
        subject.parse_consumers_from_variable(variable_spec, deployment_plan.model)
      end
    end

    context &#39;when the variable does not define any consumers in the consumes block&#39; do
      it &#39;should not create any implicit consumers or intents&#39; do
        expect(links_manager).to_not receive(:find_or_create_consumer)
        expect(links_manager).to_not receive(:find_or_create_consumer_intent)

        variable_spec = {
          &#39;name&#39; =&gt; &#39;bbs&#39;,
          &#39;type&#39; =&gt; &#39;certificate&#39;,
          &#39;consumes&#39; =&gt; {},
        }
        subject.parse_consumers_from_variable(variable_spec, deployment_plan.model)
      end
    end

    context &#39;when the variable is not of type certificate&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1987" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L2005" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &#39;should raise an error if it defines consumers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_variable)::context(when the variable is not of type certificate)::it#should raise an error if it defines consumers has a flog score of 28</span>          </div>  </li></ol>
        expect(links_manager).to_not receive(:find_or_create_consumer)
        expect(links_manager).to_not receive(:find_or_create_consumer_intent)

        variable_spec = {
          &#39;name&#39; =&gt; &#39;bbs&#39;,
          &#39;type&#39; =&gt; &#39;foobar&#39;,
          &#39;consumes&#39; =&gt; {
            &#39;alternative_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; },
          },
        }
        expect do
          subject.parse_consumers_from_variable(variable_spec, deployment_plan.model)
        end.to raise_error &quot;Variable &#39;bbs&#39; can not define &#39;consumes&#39; key for type &#39;foobar&#39;&quot;
      end
    end

    context &#39;when the variable define non-acceptable consumers&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_parser_spec.html#L1987" class="js-smell-location">0</a>                  <a href="links_parser_spec.html#L2005" class="js-smell-location">1</a>                  </div>  </li></ol>
      it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#parse_consumers_from_variable)::context(when the variable define non-acceptable consumers)::it#should raise an error has a flog score of 28</span>          </div>  </li></ol>
        expect(links_manager).to_not receive(:find_or_create_consumer)
        expect(links_manager).to_not receive(:find_or_create_consumer_intent)

        variable_spec = {
          &#39;name&#39; =&gt; &#39;bbs&#39;,
          &#39;type&#39; =&gt; &#39;certificate&#39;,
          &#39;consumes&#39; =&gt; {
            &#39;foobar&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; },
          },
        }
        expect do
          subject.parse_consumers_from_variable(variable_spec, deployment_plan.model)
        end.to raise_error &quot;Consumer name &#39;foobar&#39; is not a valid consumer for variable &#39;bbs&#39;. Acceptable consumer types are:&quot;\
          &#39; alternative_name, common_name&#39;
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
