<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-20 14:05:19 -0400'>2018-06-20 14:05:19 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit /</small> instance_updater_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">575</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">74</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2175.2</span><small> complexity</small></div>
              <div><span class="metric">189</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                30
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe InstanceUpdater do
    let(:ip_repo) { DeploymentPlan::InMemoryIpRepo.new(logger) }
    let(:ip_provider) { DeploymentPlan::IpProvider.new(ip_repo, [], logger) }
    let(:template_blob_cache) { instance_double(Core::Templates::TemplateBlobCache) }
    let(:updater) { InstanceUpdater.new_instance_updater(ip_provider, template_blob_cache, dns_encoder) }
    let(:vm_creator) { instance_double(VmCreator) }
    let(:agent_client) { instance_double(AgentClient) }
    let(:credentials) do
      { &#39;user&#39; =&gt; &#39;secret&#39; }
    end
    let(:credentials_json) { JSON.generate(credentials) }
    let(:persistent_disk_model) { instance_double(Models::PersistentDisk, name: &#39;some-disk&#39;, disk_cid: &#39;some-cid&#39;) }
    let(:disk_collection_model) do
      instance_double(DeploymentPlan::PersistentDiskCollection::ModelPersistentDisk, model: persistent_disk_model)
    end
    let(:active_persistent_disks) do
      instance_double(DeploymentPlan::PersistentDiskCollection, collection: [disk_collection_model])
    end

    let!(:ip_address) { Models::IpAddress.make(vm: instance_model.active_vm, instance: instance_model) }
    let(:instance_model) do
      instance = Models::Instance.make(
        uuid: &#39;uuid-1&#39;,
        deployment: deployment_model,
        state: instance_model_state,
        job: &#39;job-1&#39;,
        spec: { &#39;stemcell&#39; =&gt; { &#39;name&#39; =&gt; &#39;ubunut_1&#39;, &#39;version&#39; =&gt; &#39;8&#39; } },
      )
      vm_model = Models::Vm.make(agent_id: &#39;scool&#39;, instance_id: instance.id)
      instance.active_vm = vm_model
      instance
    end
    let(:instance_model_state) { &#39;started&#39; }
    let(:deployment_model) { Models::Deployment.make(name: &#39;deployment&#39;) }
    let(:instance) do
      az = DeploymentPlan::AvailabilityZone.new(&#39;az-1&#39;, {})
      vm_type = DeploymentPlan::VmType.new(&#39;name&#39; =&gt; &#39;small_vm&#39;)
      stemcell = DeploymentPlan::Stemcell.new(&#39;ubuntu_stemcell&#39;, &#39;ubuntu_1&#39;, &#39;ubuntu&#39;, &#39;8&#39;)
      merged_cloud_properties = DeploymentPlan::MergedCloudProperties.new(az, vm_type, []).get
      instance = DeploymentPlan::Instance.new(
        &#39;job-1&#39;,
        0,
        instance_desired_state,
        merged_cloud_properties,
        stemcell,
        {},
        false,
        deployment_model,
        {},
        az,
        logger,
      )
      instance.bind_existing_instance_model(instance_model)

      instance
    end
    let(:instance_desired_state) { &#39;stopped&#39; }
    let(:job) { instance_double(DeploymentPlan::InstanceGroup, default_network: {}, should_create_swap_delete?: false) }
    let(:instance_plan) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::let#instance_plan has a flog score of 25</span>          </div>  </li></ol>
      desired_instance = DeploymentPlan::DesiredInstance.new(job)
      instance_plan = DeploymentPlan::InstancePlan.new(
        existing_instance: instance_model,
        instance: instance,
        desired_instance: desired_instance,
        tags: tags,
      )
      allow(instance_plan).to receive(:spec).and_return(DeploymentPlan::InstanceSpec.create_empty)
      allow(instance_plan).to receive(:needs_disk?).and_return(false)

      instance_plan
    end
    let(:tags) do
      { &#39;key1&#39; =&gt; &#39;value1&#39; }
    end
    let(:blobstore_client) { instance_double(Bosh::Blobstore::Client) }
    let(:rendered_templates_persistor) { instance_double(RenderedTemplatesPersister) }
    let(:disk_manager) { instance_double(DiskManager) }
    let(:dns_encoder) { instance_double(DnsEncoder) }
    let(:links_manager) do
      instance_double(Bosh::Director::Links::LinksManager)
    end

    before do
      Models::VariableSet.create(deployment: deployment_model)
      allow(Config).to receive_message_chain(:current_job, :username).and_return(&#39;user&#39;)
      allow(Config).to receive_message_chain(:current_job, :task_id).and_return(&#39;task-1&#39;, &#39;task-2&#39;)
      allow(Config).to receive_message_chain(:current_job, :event_manager).and_return(Api::EventManager.new({}))
      allow(Config).to receive(:enable_virtual_delete_vms).and_return true
      allow(App).to receive_message_chain(:instance, :blobstores, :blobstore).and_return(blobstore_client)
      allow(VmCreator).to receive(:new).and_return(vm_creator)
      allow(RenderedTemplatesPersister).to receive(:new).and_return(rendered_templates_persistor)
      allow(DiskManager).to receive(:new).and_return(disk_manager)
      allow(LocalDnsEncoderManager).to receive(:new_encoder_with_updated_index).and_return(dns_encoder)
      allow(rendered_templates_persistor).to receive(:persist)
      allow(instance_model).to receive(:active_persistent_disks).and_return(active_persistent_disks)
      allow(Bosh::Director::Links::LinksManager).to receive(:new).and_return(links_manager)
    end

    context &#39;for any state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context#for any state has a flog score of 78</span>          </div>  </li></ol>
      let(:state_applier) { instance_double(InstanceUpdater::StateApplier) }

      before do
        allow(InstanceUpdater::StateApplier).to receive(:new).and_return(state_applier)

        allow(state_applier).to receive(:apply)
        allow(instance_plan).to receive(:changes).and_return([:state])
        allow(instance_plan).to receive(:already_detached?).and_return(true)
        allow(AgentClient).to receive(:with_agent_id).and_return(agent_client)
        allow(updater).to receive(:needs_recreate?).and_return(false)
        allow(disk_manager).to receive(:update_persistent_disk)
        allow(instance).to receive(:update_instance_settings)
        allow(job).to receive(:update)
      end

      context &#39;when rendered templates persist fails&#39; do
        before do
          allow(rendered_templates_persistor).to receive(:persist).and_raise(&#39;random runtime error&#39;)
        end

        it &#39;does NOT update the variable set id for the instance&#39; do
          expect(instance).to_not receive(:update_variable_set)
          expect do
            updater.update(instance_plan)
          end.to raise_error
        end
      end

      it &#39;updates the variable_set_id on the instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="config_old_spec.html#L149" class="js-smell-location">0</a>                  <a href="config_old_spec.html#L161" class="js-smell-location">1</a>                  <a href="disk_manager_spec.html#L623" class="js-smell-location">2</a>                  <a href="instance_updater/state_applier_spec.html#L142" class="js-smell-location">3</a>                  <a href="instance_updater_spec.html#L131" class="js-smell-location">4</a>                  </div>  </li></ol>
        expect(links_manager).to receive(:bind_links_to_instance)

        expect(instance).to receive(:update_variable_set)
        updater.update(instance_plan)
      end
    end

    context &#39;when stopping instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context#when stopping instances has a flog score of 35</span>          </div>  </li></ol>
      before do
        allow(AgentClient).to receive(:with_agent_id).with(&#39;scool&#39;).and_return(agent_client)
        allow(instance_plan).to receive(:changes).and_return([:state])
        allow(links_manager).to receive(:bind_links_to_instance).with(instance)
      end

      context &#39;when instance is currently started&#39; do
        let(:instance_model_state) { &#39;started&#39; }

        it &#39;drains, stops, post-stops, snapshots, and persists rendered templates blobs but leaves DNS records unchanged&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when stopping instances)::context(when instance is currently started)::it#drains, stops, post-stops, snapshots, and persists rendered templates blobs but leaves DNS records unchanged has a flog score of 95</span>          </div>  </li></ol>
          expect(Api::SnapshotManager).to receive(:take_snapshot)
          expect(agent_client).not_to receive(:apply)
          expect(agent_client).to receive(:run_script).with(&#39;post-stop&#39;, {})
          expect(agent_client).to receive(:stop)
          expect(agent_client).to receive(:drain).and_return(0.1)
          expect(rendered_templates_persistor).to receive(:persist).with(instance_plan)

          instance_model.update(dns_record_names: [&#39;old.dns.record&#39;])

          updater.update(instance_plan)
          expect(instance_model.state).to eq(&#39;stopped&#39;)
          expect(instance_model.dns_record_names).to eq [&#39;old.dns.record&#39;]
          expect(instance_model.update_completed).to eq true
          expect(Models::Event.count).to eq 2
        end
      end

      context &#39;when instance is currently stopped&#39; do
        let(:instance_model_state) { &#39;stopped&#39; }

        it &#39;does not try to post-stop, stop, drain, or snapshot&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when stopping instances)::context(when instance is currently stopped)::it#does not try to post-stop, stop, drain, or snapshot has a flog score of 80</span>          </div>  </li></ol>
          expect(Api::SnapshotManager).not_to receive(:take_snapshot)
          expect(agent_client).not_to receive(:apply)
          expect(agent_client).not_to receive(:run_script).with(&#39;post-stop&#39;, {})
          expect(agent_client).not_to receive(:stop)
          expect(agent_client).not_to receive(:drain)
          allow(rendered_templates_persistor).to receive(:persist).with(instance_plan)

          updater.update(instance_plan)
          expect(instance_model.state).to eq(&#39;stopped&#39;)
          expect(instance_model.update_completed).to eq true
          expect(Models::Event.count).to eq 2
        end

        it &#39;persists rendered templates to the blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when stopping instances)::context(when instance is currently stopped)::it#persists rendered templates to the blobstore has a flog score of 29</span>          </div>  </li></ol>
          expect(rendered_templates_persistor).to receive(:persist).with(instance_plan)
          expect(links_manager).to receive(:bind_links_to_instance).with(instance)

          updater.update(instance_plan)
        end
      end

      context &#39;when desired instance state is detached&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when stopping instances)::context#when desired instance state is detached has a flog score of 56</span>          </div>  </li></ol>
        let(:instance_model_state) { &#39;started&#39; }
        let(:instance_desired_state) { &#39;detached&#39; }
        let(:director_state_updater) { instance_double(DirectorDnsStateUpdater) }
        let(:unmount_step) { instance_double(DeploymentPlan::Steps::UnmountInstanceDisksStep) }
        let(:delete_step) { instance_double(DeploymentPlan::Steps::DeleteVmStep) }

        before do
          allow(DirectorDnsStateUpdater).to receive(:new).and_return(director_state_updater)
          allow(instance_plan).to receive(:dns_changed?).and_return(true)
          allow(DeploymentPlan::Steps::UnmountInstanceDisksStep).to receive(:new)
            .with(instance_model).and_return(unmount_step)
          allow(DeploymentPlan::Steps::DeleteVmStep).to receive(:new)
            .with(true, false, true).and_return delete_step
          allow(links_manager).to receive(:bind_links_to_instance)
        end

        it &#39;should update dns&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when stopping instances)::context(when desired instance state is detached)::it#should update dns has a flog score of 102</span>          </div>  </li></ol>
          allow(instance_plan).to receive(:already_detached?).and_return(false)
          expect(instance_plan).to receive(:release_obsolete_network_plans).with(ip_provider)
          expect(unmount_step).to receive(:perform)
          expect(delete_step).to receive(:perform)
          expect(director_state_updater).to receive(:update_dns_for_instance)
            .with(instance_model, instance_plan.network_settings.dns_record_info)

          expect(agent_client).to receive(:run_script).with(&#39;post-stop&#39;, {})
          expect(agent_client).to receive(:stop)
          expect(agent_client).to receive(:drain).and_return(0)

          updater.update(instance_plan)
          expect(instance_model.update_completed).to eq true
          expect(Models::Event.count).to eq 2
        end

        context &#39;if instance is already detached&#39; do
          let(:instance_model_state) { &#39;detached&#39; }

          before do
            allow(instance_plan).to receive(:already_detached?).and_return(true)
          end

          it &#39;binds links to detached instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when stopping instances)::context(when desired instance state is detached)::context(if instance is already detached)::it#binds links to detached instance has a flog score of 27</span>          </div>  </li></ol>
            allow(director_state_updater).to receive(:update_dns_for_instance)
            expect(links_manager).to receive(:bind_links_to_instance).with(instance)
            updater.update(instance_plan)
          end

          it &#39;still updates dns&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when stopping instances)::context(when desired instance state is detached)::context(if instance is already detached)::it#still updates dns has a flog score of 44</span>          </div>  </li></ol>
            expect(director_state_updater).to receive(:update_dns_for_instance)
              .with(instance_model, instance_plan.network_settings.dns_record_info)

            updater.update(instance_plan)
            expect(instance_model.update_completed).to eq true
            expect(Models::Event.count).to eq 2
          end
        end
      end
    end

    context &#39;when starting instances&#39; do
      let(:instance_desired_state) { &#39;started&#39; }

      before do
        allow(AgentClient).to receive(:with_agent_id).with(&#39;scool&#39;).and_return(agent_client)
        allow(instance_plan).to receive(:changes).and_return([:state])
      end

      context &#39;when instance is currently stopped&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context#when instance is currently stopped has a flog score of 95</span>          </div>  </li></ol>
        let(:instance_model_state) { &#39;stopped&#39; }
        let(:disk_manager) { instance_double(DiskManager) }
        let(:state_applier) { instance_double(InstanceUpdater::StateApplier) }
        let(:unmount_step) { instance_double(DeploymentPlan::Steps::UnmountInstanceDisksStep, perform: nil) }
        let(:detach_step) { instance_double(DeploymentPlan::Steps::DetachInstanceDisksStep, perform: nil) }

        before do
          allow(DiskManager).to receive(:new).and_return(disk_manager)
          allow(InstanceUpdater::StateApplier).to receive(:new).and_return(state_applier)
          allow(DeploymentPlan::Steps::UnmountInstanceDisksStep).to receive(:new)
            .with(instance_model).and_return(unmount_step)
          allow(DeploymentPlan::Steps::DetachInstanceDisksStep).to receive(:new)
            .with(instance_model).and_return(detach_step)

          allow(updater).to receive(:needs_recreate?).and_return(false)
          allow(disk_manager).to receive(:update_persistent_disk)
          allow(job).to receive(:update)
          allow(instance).to receive(:update_instance_settings)

          expect(instance_plan).to receive(:release_obsolete_network_plans).with(ip_provider)
        end

        it &#39;does NOT drain, stop, post-stop, snapshot, but persists rendered templates to the blobstore, updates DNS and bind links&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::it#does NOT drain, stop, post-stop, snapshot, but persists rendered templates to the blobstore, updates DNS and bind links has a flog score of 122</span>          </div>  </li></ol>
          # https://www.pivotaltracker.com/story/show/121721619
          expect(Api::SnapshotManager).to_not receive(:take_snapshot)
          expect(agent_client).to_not receive(:run_script).with(&#39;post-stop&#39;, {})
          expect(agent_client).to_not receive(:stop)
          expect(agent_client).to_not receive(:drain)

          expect(state_applier).to receive(:apply)
          expect(rendered_templates_persistor).to receive(:persist).with(instance_plan).twice
          expect(links_manager).to receive(:bind_links_to_instance).with(instance)

          subnet_spec = {
            &#39;range&#39; =&gt; &#39;10.10.10.0/24&#39;,
            &#39;gateway&#39; =&gt; &#39;10.10.10.1&#39;,
          }
          subnet = DeploymentPlan::ManualNetworkSubnet.parse(&#39;my-network&#39;, subnet_spec, [&#39;az-1&#39;], [])
          network = DeploymentPlan::ManualNetwork.new(&#39;my-network&#39;, [subnet], logger)
          reservation = ExistingNetworkReservation.new(instance_model, network, &#39;10.10.10.10&#39;, :dynamic)
          instance_plan.network_plans = [
            DeploymentPlan::NetworkPlanner::Plan.new(reservation: reservation, existing: true),
          ]

          instance_model.update(dns_record_names: [&#39;old.dns.record&#39;])

          updater.update(instance_plan)

          expect(instance_model.update_completed).to eq true
          expect(instance_model.dns_record_names).to eq [
            &#39;old.dns.record&#39;,
            &#39;0.job-1.my-network.deployment.bosh&#39;,
            &#39;uuid-1.job-1.my-network.deployment.bosh&#39;,
          ]
          expect(Models::Event.count).to eq 2
          expect(Models::Event.all[1].error).to be_nil
        end

        context &#39;when an instance needs to be recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context#when an instance needs to be recreated has a flog score of 42</span>          </div>  </li></ol>
          let(:delete_step) { instance_double(DeploymentPlan::Steps::DeleteVmStep) }

          before do
            allow(updater).to receive(:needs_recreate?).and_return(true)
            allow(disk_manager).to receive(:update_persistent_disk)
            allow(job).to receive(:update)
            allow(DeploymentPlan::Steps::DeleteVmStep).to receive(:new)
              .with(true, false, true).and_return delete_step
          end

          it &#39;recreates correctly, and persists rendered templates to the blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_updater_spec.html#L329" class="js-smell-location">0</a>                  <a href="instance_updater_spec.html#L355" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::it#recreates correctly, and persists rendered templates to the blobstore has a flog score of 124</span>          </div>  </li></ol>
            expect(unmount_step).to receive(:perform)
            expect(detach_step).to receive(:perform)
            expect(delete_step).to receive(:perform) do |report|
              expect(report.vm).to eql(instance_model.active_vm)
            end
            expect(vm_creator).to receive(:create_for_instance_plan) do |i, ipp, disks, tags, use_existing|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'i'</span>              <span>Locations:</span>                  <a href="instance_updater_spec.html#L335" class="js-smell-location">0</a>                  <a href="instance_updater_spec.html#L361" class="js-smell-location">1</a>                  </div>  </li></ol>
              expect(instance_plan).to eq(i)
              expect(ipp).to eq(ip_provider)
              expect(disks).to eq([persistent_disk_model.disk_cid])
              expect(tags).to eq(tags)
              expect(use_existing).to eq(nil)
            end

            expect(state_applier).to receive(:apply)
            expect(rendered_templates_persistor).to receive(:persist).with(instance_plan).twice
            expect(links_manager).to receive(:bind_links_to_instance).with(instance)

            updater.update(instance_plan)
          end

          context &#39;and has unresponsive agent&#39; do
            before do
              allow(instance_plan).to receive(:unresponsive_agent?).and_return(true)
            end

            it &#39;does not unmount and detach disk, then recreates correctly and persists rendered templates to blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_updater_spec.html#L329" class="js-smell-location">0</a>                  <a href="instance_updater_spec.html#L355" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::context(and has unresponsive agent)::it#does not unmount and detach disk, then recreates correctly and persists rendered templates to blobstore has a flog score of 130</span>          </div>  </li></ol>
              expect(unmount_step).not_to receive(:perform)
              expect(detach_step).not_to receive(:perform)
              expect(delete_step).to receive(:perform) do |report|
                expect(report.vm).to eql(instance_model.active_vm)
              end
              expect(vm_creator).to receive(:create_for_instance_plan) do |i, ipp, disks, tags, use_existing|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'i'</span>              <span>Locations:</span>                  <a href="instance_updater_spec.html#L335" class="js-smell-location">0</a>                  <a href="instance_updater_spec.html#L361" class="js-smell-location">1</a>                  </div>  </li></ol>
                expect(instance_plan).to eq(i)
                expect(ipp).to eq(ip_provider)
                expect(disks).to eq([persistent_disk_model.disk_cid])
                expect(tags).to eq(tags)
                expect(use_existing).to eq(nil)
              end

              expect(state_applier).to receive(:apply)
              expect(rendered_templates_persistor).to receive(:persist).with(instance_plan).twice
              expect(links_manager).to receive(:bind_links_to_instance).with(instance)

              updater.update(instance_plan)
            end
          end

          context &#39;when the instance uses create-swap-delete strategy&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::context#when the instance uses create-swap-delete strategy has a flog score of 112</span>          </div>  </li></ol>
            let(:elect_active_vm_step) { instance_double(DeploymentPlan::Steps::ElectActiveVmStep, perform: nil) }
            let!(:inactive_vm_model) { Models::Vm.make(instance_id: instance_model.id) }
            let(:attach_step) { instance_double(DeploymentPlan::Steps::AttachInstanceDisksStep, perform: nil) }
            let(:mount_step) { instance_double(DeploymentPlan::Steps::MountInstanceDisksStep, perform: nil) }
            let(:apply_spec_step) { instance_double(DeploymentPlan::Steps::ApplyVmSpecStep, perform: nil) }
            let(:orphan_vm_step) { instance_double(DeploymentPlan::Steps::OrphanVmStep, perform: nil) }

            before do
              allow(instance_plan).to receive(:should_create_swap_delete?).and_return(true)
              allow(DeploymentPlan::Steps::ElectActiveVmStep).to receive(:new)
                .and_return(elect_active_vm_step)
              allow(DeploymentPlan::Steps::AttachInstanceDisksStep).to receive(:new)
                .with(instance_model, &#39;key1&#39; =&gt; &#39;value1&#39;).and_return(attach_step)
              allow(DeploymentPlan::Steps::MountInstanceDisksStep).to receive(:new)
                .with(instance_model).and_return(mount_step)
              allow(DeploymentPlan::Steps::ApplyVmSpecStep).to receive(:new)
                .with(instance_plan).and_return(apply_spec_step)
              allow(DeploymentPlan::Steps::OrphanVmStep).to receive(:new)
                .with(instance_model.active_vm).and_return(orphan_vm_step)
              allow(links_manager).to receive(:bind_links_to_instance).with(instance)

              allow(state_applier).to receive(:apply)
            end

            it &#39;activates the vm but does not delete the old one or create another vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::context(when the instance uses create-swap-delete strategy)::it#activates the vm but does not delete the old one or create another vm has a flog score of 81</span>          </div>  </li></ol>
              expect(unmount_step).to receive(:perform)
              expect(detach_step).to receive(:perform)
              expect(DeploymentPlan::Steps::DeleteVmStep).to_not receive(:new)
              expect(vm_creator).not_to receive(:create_for_instance_plan)

              expect(instance_model).to receive(:most_recent_inactive_vm).and_return(inactive_vm_model)
              expect(elect_active_vm_step).to receive(:perform)
              expect(state_applier).to receive(:apply)
              expect(rendered_templates_persistor).to receive(:persist).with(instance_plan).twice

              updater.update(instance_plan)
            end

            it &#39;orphans the old vm after activating the new one&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::context(when the instance uses create-swap-delete strategy)::it#orphans the old vm after activating the new one has a flog score of 46</span>          </div>  </li></ol>
              expect(elect_active_vm_step).to receive(:perform)
              expect(orphan_vm_step).to receive(:perform)

              expected_ips = instance_model.active_vm.ip_addresses.map(&amp;:address_str)
              expect(instance_plan).to receive(:remove_obsolete_network_plans_for_ips).with(expected_ips)

              updater.update(instance_plan)
            end

            context &#39;and has unresponsive agent&#39; do
              before do
                allow(instance_plan).to receive(:unresponsive_agent?).and_return(true)
              end

              it &#39;deletes the old vm and does NOT try to orphan it&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::context(when the instance uses create-swap-delete strategy)::context(and has unresponsive agent)::it#deletes the old vm and does NOT try to orphan it has a flog score of 109</span>          </div>  </li></ol>
                expect(unmount_step).not_to receive(:perform)
                expect(detach_step).not_to receive(:perform)
                expect(delete_step).to receive(:perform) do |report|
                  expect(report.vm).to eql(instance_model.active_vm)
                end
                expect(vm_creator).not_to receive(:create_for_instance_plan)

                expect(instance_model).to receive(:most_recent_inactive_vm).and_return(inactive_vm_model)
                expect(elect_active_vm_step).to receive(:perform)
                expect(orphan_vm_step).not_to receive(:perform)
                expect(state_applier).to receive(:apply)
                expect(rendered_templates_persistor).to receive(:persist).with(instance_plan).twice

                updater.update(instance_plan)
              end
            end

            context &#39;and has only one VM, which is currently active&#39; do
              before do
                inactive_vm_model.destroy
              end

              it &#39;does NOT orphan the active VM and synchrously recreates the vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::context(when the instance uses create-swap-delete strategy)::context(and has only one VM, which is currently active)::it#does NOT orphan the active VM and synchrously recreates the vm has a flog score of 92</span>          </div>  </li></ol>
                expect(elect_active_vm_step).not_to receive(:perform)
                expect(orphan_vm_step).not_to receive(:perform)
                expect(delete_step).to receive(:perform) do |report|
                  expect(report.vm).to eql(instance_model.active_vm)
                end
                expect(vm_creator).to receive(:create_for_instance_plan)
                expect(instance_model).to receive(:most_recent_inactive_vm).and_return(inactive_vm_model)
                expect(state_applier).to receive(:apply)
                expect(rendered_templates_persistor).to receive(:persist).with(instance_plan).twice

                updater.update(instance_plan)
              end
            end

            context &#39;when instance has persistent disks&#39; do
              before do
                allow(instance_plan).to receive(:needs_disk?).and_return(true)
              end

              it &#39;attaches and mounts persistent disks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when starting instances)::context(when instance is currently stopped)::context(when an instance needs to be recreated)::context(when the instance uses create-swap-delete strategy)::context(when instance has persistent disks)::it#attaches and mounts persistent disks has a flog score of 46</span>          </div>  </li></ol>
                expect(attach_step).to receive(:perform)
                expect(mount_step).to receive(:perform)
                expect(state_applier).to receive(:apply)
                expect(links_manager).to receive(:bind_links_to_instance).with(instance)

                updater.update(instance_plan)
              end
            end
          end
        end
      end
    end

    context &#39;when changing DNS&#39; do
      before do
        allow(instance_plan).to receive(:changes).and_return([:dns])
      end

      it &#39;exits early without interacting with the agent, and does NOT persist rendered templates to the blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when changing DNS)::it#exits early without interacting with the agent, and does NOT persist rendered templates to the blobstore has a flog score of 74</span>          </div>  </li></ol>
        instance_model.update(dns_record_names: [&#39;old.dns.record&#39;])
        expect(instance_model.state).to eq(&#39;started&#39;)
        expect(Models::Event.count).to eq 0

        expect(AgentClient).not_to receive(:with_agent_id)

        subnet_spec = {
          &#39;range&#39; =&gt; &#39;10.10.10.0/24&#39;,
          &#39;gateway&#39; =&gt; &#39;10.10.10.1&#39;,
        }
        subnet = DeploymentPlan::ManualNetworkSubnet.parse(&#39;my-network&#39;, subnet_spec, [&#39;az-1&#39;], [])
        network = DeploymentPlan::ManualNetwork.new(&#39;my-network&#39;, [subnet], logger)
        reservation = ExistingNetworkReservation.new(instance_model, network, &#39;10.10.10.10&#39;, :dynamic)
        instance_plan.network_plans = [
          DeploymentPlan::NetworkPlanner::Plan.new(reservation: reservation, existing: true),
        ]

        expect do
          updater.update(instance_plan)
        end.not_to(change { Models::RenderedTemplatesArchive.count })

        expect(instance_model.dns_record_names).to eq [
          &#39;old.dns.record&#39;,
          &#39;0.job-1.my-network.deployment.bosh&#39;,
          &#39;uuid-1.job-1.my-network.deployment.bosh&#39;,
        ]
        expect(instance_model.update_completed).to eq true
        expect(Models::Event.count).to eq 2
      end
    end

    context &#39;when the VM does not get recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context#when the VM does not get recreated has a flog score of 32</span>          </div>  </li></ol>
      let(:disk_manager) { instance_double(DiskManager) }
      let(:state_applier) { instance_double(InstanceUpdater::StateApplier) }

      before do
        allow(DiskManager).to receive(:new).and_return(disk_manager)
        allow(InstanceUpdater::StateApplier).to receive(:new).and_return(state_applier)

        expect(instance_plan).to receive(:release_obsolete_network_plans).with(ip_provider)
      end

      it &#39;updates the instance settings and bind links&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when the VM does not get recreated)::it#updates the instance settings and bind links has a flog score of 98</span>          </div>  </li></ol>
        allow(instance_plan).to receive(:changes).and_return([:trusted_certs])
        allow(AgentClient).to receive(:with_agent_id).with(&#39;scool&#39;).and_return(agent_client)

        allow(instance_plan).to receive(:needs_shutting_down?).and_return(false)

        allow(instance_plan).to receive(:already_detached?).and_return(true)
        allow(disk_manager).to receive(:update_persistent_disk)
        allow(state_applier).to receive(:apply)
        allow(job).to receive(:update)
        allow(rendered_templates_persistor).to receive(:persist).with(instance_plan)

        allow(logger).to receive(:debug)

        expect(links_manager).to receive(:bind_links_to_instance).with(instance)
        expect(instance).to receive(:update_instance_settings)
        updater.update(instance_plan)
      end
    end

    context &#39;when something goes wrong in the update procedure&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context#when something goes wrong in the update procedure has a flog score of 42</span>          </div>  </li></ol>
      before do
        allow(AgentClient).to receive(:with_agent_id).with(&#39;scool&#39;).and_return(agent_client)
        allow(instance_plan).to receive(:changes).and_return([:state])
        allow(rendered_templates_persistor).to receive(:persist)
        allow(links_manager).to receive(:bind_links_to_instance).with(instance)
      end

      it &#39;should always add an event recording the error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when something goes wrong in the update procedure)::it#should always add an event recording the error has a flog score of 40</span>          </div>  </li></ol>
        expect(Models::Event.count).to eq 0

        drain_error = RpcRemoteException.new(&#39;Oh noes!&#39;)
        expect(agent_client).to receive(:drain).and_raise(drain_error)

        expect { updater.update(instance_plan) }.to raise_error drain_error
        expect(Models::Event.map(&amp;:error)).to match_array([nil, &#39;Oh noes!&#39;])
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
