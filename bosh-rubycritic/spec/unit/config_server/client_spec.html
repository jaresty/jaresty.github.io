<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 15:27:04 -0400'>2018-06-22 15:27:04 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/config_server /</small> client_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">2028</span><small> lines of codes</small></div>
              <div><span class="metric">8</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">501.3</span><small> complexity/method</small></div>
              <div><span class="metric">90</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">4010.76</span><small> complexity</small></div>
              <div><span class="metric">1490</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                86
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director::ConfigServer<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has no descriptive comment</span>          </div>  </li></ol>
  describe ConfigServerClient do
    subject(:client) { ConfigServerClient.new(http_client, director_name, logger) }
    let(:director_name) { &#39;smurf_director_name&#39; }
    let(:deployment_name) { &#39;deployment_name&#39; }
    let(:deployment_attrs) do
      { id: 1, name: deployment_name }
    end
    let(:logger) { double(&#39;Logging::Logger&#39;) }
    let(:variables_set_id) { 2000 }
    let(:success_post_response) do
      generate_success_response({ :id =&gt; &#39;some_id1&#39;}.to_json)
    end
    let(:http_client) { double(&#39;Bosh::Director::ConfigServer::HTTPClient&#39;) }

    let(:event_manager) {Bosh::Director::Api::EventManager.new(true)}
    let(:task_id) {42}
    let(:update_job) {instance_double(Bosh::Director::Jobs::UpdateDeployment, username: &#39;user&#39;, task_id: task_id, event_manager: event_manager)}

    let(:success_response) do
      result = SampleSuccessResponse.new
      result.body = {&#39;id&#39;=&gt; 504}.to_json
      result
    end

    let(:deployment_model) { Bosh::Director::Models::Deployment.make(deployment_attrs) }

    def prepend_namespace(name)
      &quot;/#{director_name}/#{deployment_name}/#{name}&quot;
    end

    before do
      Bosh::Director::Models::VariableSet.make(id: variables_set_id, deployment: deployment_model, writable: true)

      allow(logger).to receive(:info)
      allow(Bosh::Director::Config).to receive(:current_job).and_return(update_job)
    end

    describe &#39;#interpolate&#39; do
      let(:deployment_name) { &#39;my_deployment_name&#39; }
      let(:raw_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L43" class="js-smell-location">0</a>                  <a href="client_spec.html#L410" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          &#39;properties&#39; =&gt; {
            &#39;integer_allowed&#39; =&gt; &#39;((/integer_placeholder))&#39;,
            &#39;nil_allowed&#39; =&gt; &#39;((/nil_placeholder))&#39;,
            &#39;empty_allowed&#39; =&gt; &#39;((/empty_placeholder))&#39;
          },
          &#39;i_am_a_hash&#39; =&gt; {
            &#39;i_am_an_array&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;test_job&#39;,
                &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;((/string_placeholder))&#39;}
              }
            ]
          },
          &#39;i_am_another_array&#39; =&gt; [
            {&#39;env&#39; =&gt; {&#39;env_prop&#39; =&gt; &#39;((/hash_placeholder))&#39;}}
          ],
          &#39;my_value_will_be_a_hash&#39; =&gt; &#39;((/hash_placeholder))&#39;
        }
      end
      let(:interpolated_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L64" class="js-smell-location">0</a>                  <a href="client_spec.html#L431" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          &#39;properties&#39; =&gt; {
            &#39;integer_allowed&#39; =&gt; 123,
            &#39;nil_allowed&#39; =&gt; nil,
            &#39;empty_allowed&#39; =&gt; &#39;&#39;
          },
          &#39;i_am_a_hash&#39; =&gt; {
            &#39;i_am_an_array&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;test_job&#39;,
                &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;i am a string&#39;}
              }
            ]
          },
          &#39;i_am_another_array&#39; =&gt; [
            {&#39;env&#39; =&gt; {&#39;env_prop&#39; =&gt; hash_placeholder_value}}
          ],
          &#39;my_value_will_be_a_hash&#39; =&gt; hash_placeholder_value
        }
      end
      let(:hash_placeholder_value) do
        {
          &#39;ca&#39; =&gt; {
            &#39;level_1&#39; =&gt; &#39;level_1_value&#39;,
            &#39;level_2&#39; =&gt; {
              &#39;level_2_1&#39; =&gt; &#39;level_2_1_value&#39;
            }
          },
          &#39;private_key&#39; =&gt; &#39;abc123&#39;
        }
      end

      before do
        allow(deployment_model).to receive(:name).and_return(deployment_name)
      end

      context &#39;when object to be interpolated is NOT nil&#39; do

        context &#39;when object to be interpolated is a hash&#39; do

          context &#39;when hash does NOT contain any placeholders&#39; do
            let(:raw_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L106" class="js-smell-location">0</a>                  <a href="client_spec.html#L553" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;properties&#39; =&gt; {
                  &#39;integer_allowed&#39; =&gt; &#39;1&#39;,
                  &#39;nil_allowed&#39; =&gt; nil,
                  &#39;empty_allowed&#39; =&gt; &#39;&#39;
                },
                &#39;i_am_a_hash&#39; =&gt; {
                  &#39;i_am_an_array&#39; =&gt; [
                    {
                      &#39;name&#39; =&gt; &#39;test_job&#39;,
                      &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;string&#39;}
                    }
                  ]
                },
                &#39;i_am_another_array&#39; =&gt; [
                  {&#39;env&#39; =&gt; {&#39;env_prop&#39; =&gt; {}}}
                ],
                &#39;my_value_will_be_a_hash&#39; =&gt; {}
              }
            end

            it &#39;does not raise an error&#39; do
              expect {
                client.interpolate(raw_hash)
              }.to_not raise_error
            end

            it &#39;returns an equivalent hash&#39; do
              interpolated_hash = client.interpolate(raw_hash)
              expect(interpolated_hash).to eq(raw_hash)
            end
          end

          context &#39;when all placeholders syntax is correct&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context#when all placeholders syntax is correct has a flog score of 47</span>          </div>  </li></ol>
            let(:integer_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;integer_placeholder&#39;).to_s, &#39;value&#39; =&gt; 123, &#39;id&#39; =&gt; &#39;1&#39; }] }
            end
            let(:nil_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;nil_placeholder&#39;).to_s, &#39;value&#39; =&gt; nil, &#39;id&#39; =&gt; &#39;2&#39; }] }
            end
            let(:empty_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;empty_placeholder&#39;).to_s, &#39;value&#39; =&gt; &#39;&#39;, &#39;id&#39; =&gt; &#39;3&#39; }] }
            end
            let(:string_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;string_placeholder&#39;).to_s, &#39;value&#39; =&gt; &#39;i am a string&#39;, &#39;id&#39; =&gt; &#39;4&#39; }] }
            end
            let(:hash_placeholder) do
              {
                &#39;data&#39; =&gt; [
                  {
                    &#39;name&#39; =&gt; prepend_namespace(&#39;hash_placeholder&#39;).to_s,
                    &#39;value&#39; =&gt; hash_placeholder_value,
                    &#39;id&#39; =&gt; &#39;5&#39;,
                  },
                ],
              }
            end

            let(:mock_config_store) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::let#mock_config_store has a flog score of 30</span>          </div>  </li></ol>
              {
                &#39;/integer_placeholder&#39; =&gt; generate_success_response(integer_placeholder.to_json),
                &#39;/nil_placeholder&#39; =&gt; generate_success_response(nil_placeholder.to_json),
                &#39;/empty_placeholder&#39; =&gt; generate_success_response(empty_placeholder.to_json),
                &#39;/string_placeholder&#39; =&gt; generate_success_response(string_placeholder.to_json),
                &#39;/hash_placeholder&#39; =&gt; generate_success_response(hash_placeholder.to_json),
              }
            end

            let(:variable_name) { &#39;/boo&#39; }
            let(:variable_id) { &#39;cfg-svr-id&#39; }
            let(:variable_value) { &#39;var_val&#39; }

            let(:response_body_id) do
              { &#39;name&#39; =&gt; variable_name, &#39;value&#39; =&gt; variable_value, &#39;id&#39; =&gt; variable_id }
            end
            let(:response_body_name) do
              { &#39;data&#39; =&gt; [response_body_id] }
            end
            let(:mock_response) { generate_success_response(response_body_name.to_json) }

            before do
              mock_config_store.each do |name, value|
                result_body = JSON.parse(value.body)
                allow(http_client).to receive(:get).with(name).and_return(generate_success_response(result_body.to_json))
              end
              allow(http_client).to receive(:get).with(&#39;/boo&#39;).and_return(mock_response)
            end

            it &#39;should use the latest variables from the config server&#39; do
              result = client.interpolate({&#39;key&#39; =&gt; &quot;((#{variable_name}))&quot;})
              expect(result[&#39;key&#39;]).to eq(&#39;var_val&#39;)
            end

            context &#39;when variable does not use an absolute name&#39; do
              let(:variable_name) { &#39;boo&#39; }

              it &#39;should error&#39; do
                expect {
                  client.interpolate({&#39;key&#39; =&gt; &quot;((#{variable_name}))&quot;})
                }.to raise_error Bosh::Director::ConfigServerIncorrectNameSyntax
              end
            end

            context &#39;when a variable has sub-keys&#39; do
              let(:variable_value) do
                { &#39;cert&#39; =&gt; &#39;my cert&#39;, &#39;key&#39; =&gt; &#39;my key&#39;, &#39;ca&#39; =&gt; &#39;my ca&#39; }
              end

              it &#39;should get the sub-value as needed&#39; do
                result = client.interpolate({&#39;key&#39; =&gt; &#39;((/boo.ca))&#39;})
                expect(result[&#39;key&#39;]).to eq(&#39;my ca&#39;)
              end
            end

            context &#39;when response received from server is not in the expected format&#39; do
              let(:manifest_hash) do
                {
                  &#39;name&#39; =&gt; &#39;deployment_name&#39;,
                  &#39;properties&#39; =&gt; {
                    &#39;name&#39; =&gt; &#39;((/bad))&#39;
                  }
                }
              end

              [
                {&#39;response&#39; =&gt; &#39;Invalid JSON response&#39;,
                 &#39;message&#39; =&gt; &#39;- Failed to fetch variable \&#39;/bad\&#39; from config server: Invalid JSON response&#39;},

                {&#39;response&#39; =&gt; &#39;{&quot;x&quot; : {}}&#39;,
                 &#39;message&#39; =&gt; &#39;- Failed to fetch variable \&#39;/bad\&#39; from config server: Expected data to be an array&#39;},

                {&#39;response&#39; =&gt; &#39;{&quot;data&quot; : {&quot;value&quot; : &quot;x&quot;}}&#39;,
                 &#39;message&#39; =&gt; &#39;- Failed to fetch variable \&#39;/bad\&#39; from config server: Expected data to be an array&#39;},

                {&#39;response&#39; =&gt; &#39;{&quot;data&quot; : []}&#39;,
                 &#39;message&#39; =&gt; &#39;- Failed to fetch variable \&#39;/bad\&#39; from config server: Expected data to be non empty array&#39;},

                {&#39;response&#39; =&gt; &#39;{&quot;data&quot; : [{&quot;name&quot; : &quot;name1&quot;, &quot;id&quot; : &quot;id1&quot;, &quot;val&quot; : &quot;x&quot;}]}&#39;,
                 &#39;message&#39; =&gt; &#39;- Failed to fetch variable \&#39;/bad\&#39; from config server: Expected data[0] to have key \&#39;value\&#39;&#39;},

                {&#39;response&#39; =&gt; &#39;{&quot;data&quot; : [{&quot;name&quot; : &quot;name1&quot;, &quot;value&quot; : &quot;x&quot;}]}&#39;,
                 &#39;message&#39; =&gt; &#39;- Failed to fetch variable \&#39;/bad\&#39; from config server: Expected data[0] to have key \&#39;id\&#39;&#39;},

              ].each do |entry|
                it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when response received from server is not in the expected format)::it#raises an error has a flog score of 58</span>          </div>  </li></ol>
                  allow(http_client).to receive(:get).with(&#39;/bad&#39;).and_return(generate_success_response(entry[&#39;response&#39;]))
                  expect {
                    client.interpolate(manifest_hash)
                  }.to raise_error { |error|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L255" class="js-smell-location">0</a>                  <a href="client_spec.html#L907" class="js-smell-location">1</a>                  </div>  </li></ol>
                    expect(error).to be_a(Bosh::Director::ConfigServerFetchError)
                    expect(error.message).to include(entry[&#39;message&#39;])
                  }
                end
              end
            end

            context &#39;when name is not found in the config_server&#39; do
              let(:manifest_hash) do
                {
                  &#39;name&#39; =&gt; &#39;deployment_name&#39;,
                  &#39;properties&#39; =&gt; {
                    &#39;name&#39; =&gt; &#39;((/missing_placeholder))&#39;
                  }
                }
              end

              it &#39;should raise a missing name error message&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when name is not found in the config_server)::it#should raise a missing name error message has a flog score of 50</span>          </div>  </li></ol>
                allow(http_client).to receive(:get).with(&#39;/missing_placeholder&#39;).and_return(SampleNotFoundResponse.new)

                expect {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L276" class="js-smell-location">0</a>                  <a href="client_spec.html#L342" class="js-smell-location">1</a>                  </div>  </li></ol>
                  client.interpolate(manifest_hash)
                }.to raise_error { |error|
                  expect(error).to be_a(Bosh::Director::ConfigServerFetchError)
                  expect(error.message).to include(&quot;- Failed to find variable &#39;/missing_placeholder&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;&quot;)
                }
              end
            end

            context &#39;when some placeholders have the dot syntax&#39; do
              before do
                raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((/hash_placeholder.private_key))&#39;
                interpolated_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;abc123&#39;
              end

              it &#39;extracts the variable name from placeholder name&#39; do
                expect(client.interpolate(raw_hash)).to eq(interpolated_hash)
              end

              context &#39;when placeholders have multiple dot levels&#39; do
                before do
                  raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((/hash_placeholder.ca.level_2.level_2_1))&#39;
                  interpolated_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;level_2_1_value&#39;
                end

                it &#39;extracts value from placeholder name&#39; do
                  expect(client.interpolate(raw_hash)).to eq(interpolated_hash)
                end
              end

              context &#39;when all parts of dot syntax are not found&#39; do
                before do
                  raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((/hash_placeholder.ca.level_n.level_n_1))&#39;
                end

                it &#39;fails to find values and throws formatting error&#39; do
                  expect {
                    client.interpolate(raw_hash)
                  }.to raise_error(&quot;- Failed to fetch variable &#39;/hash_placeholder&#39; &quot; +
                                     &quot;from config server: Expected parent &#39;/hash_placeholder.ca&#39; hash to have key &#39;level_n&#39;&quot;)
                end
              end

              context &#39;when multiple errors occur because parts of dot syntax is not found&#39; do
                before do
                  raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((/hash_placeholder.ca.level_n.level_n_1))&#39;
                  raw_hash[&#39;my_value_will_be_an_other_hash&#39;] = &#39;((/hash_placeholder.ca.level_m.level_m_1))&#39;
                end

                it &#39;fails to find all values and throws formatting error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when some placeholders have the dot syntax)::context(when multiple errors occur because parts of dot syntax is not found)::it#fails to find all values and throws formatting error has a flog score of 47</span>          </div>  </li></ol>
                  expect {
                    client.interpolate(raw_hash)
                  }.to raise_error { |error|
                    expect(error).to be_a(Bosh::Director::ConfigServerFetchError)
                    expect(error.message).to include(&quot;- Failed to fetch variable &#39;/hash_placeholder&#39; from config server: Expected parent &#39;/hash_placeholder.ca&#39; hash to have key &#39;level_n&#39;&quot;)
                    expect(error.message).to include(&quot;- Failed to fetch variable &#39;/hash_placeholder&#39; from config server: Expected parent &#39;/hash_placeholder.ca&#39; hash to have key &#39;level_m&#39;&quot;)
                  }
                end
              end

              context &#39;when placeholders use bad dot syntax&#39; do
                before do
                  raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca...level_1))&#39;
                end

                it &#39;fails to find value and throws formatting error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when some placeholders have the dot syntax)::context(when placeholders use bad dot syntax)::it#fails to find value and throws formatting error has a flog score of 35</span>          </div>  </li></ol>
                  expect {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L276" class="js-smell-location">0</a>                  <a href="client_spec.html#L342" class="js-smell-location">1</a>                  </div>  </li></ol>
                    client.interpolate(raw_hash)
                  }.to raise_error { |error|
                    expect(error).to be_a(Bosh::Director::ConfigServerIncorrectNameSyntax)
                    expect(error.message).to include(&quot;Variable name &#39;hash_placeholder.ca...level_1&#39; syntax error: Must not contain consecutive dots&quot;)
                  }
                end
              end

              it &#39;returns an error for non absolute path placeholders&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when some placeholders have the dot syntax)::it#returns an error for non absolute path placeholders has a flog score of 29</span>          </div>  </li></ol>
                raw_hash[&#39;properties&#39;][&#39;some-new-relative-key&#39;] = &#39;((some-relative-var))&#39;
                expect {
                  client.interpolate(raw_hash)
                }.to raise_error { |error|
                  expect(error.message).to eq(&quot;Relative paths are not allowed in this context. The following must be be switched to use absolute paths: &#39;some-relative-var&#39;&quot;)
                }
              end
            end
          end

          context &#39;when some placeholders have invalid name syntax&#39; do
            let(:provided_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L363" class="js-smell-location">0</a>                  <a href="client_spec.html#L989" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;properties&#39; =&gt; {
                  &#39;integer_allowed&#39; =&gt; &#39;((int&amp;&amp;&amp;&amp;eger_placeholder))&#39;,
                  &#39;nil_allowed&#39; =&gt; &#39;((nil_place holder))&#39;,
                  &#39;empty_allowed&#39; =&gt; &#39;((emp**ty_placeholder))&#39;
                },
                &#39;i_am_a_hash&#39; =&gt; {
                  &#39;i_am_an_array&#39; =&gt; [
                    {
                      &#39;name&#39; =&gt; &#39;test_job&#39;,
                      &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;((job_placeholder+++ ))&#39;}
                    }
                  ]
                }
              }
            end

            # TODO: make sure all the errors are displayed
            it &#39;should raise an error&#39; do
              expect {
                client.interpolate(provided_hash)
              }.to raise_error Bosh::Director::ConfigServerIncorrectNameSyntax,
                               &quot;Variable name &#39;int&amp;&amp;&amp;&amp;eger_placeholder&#39; must only contain alphanumeric, underscores, dashes, or forward slash characters&quot;
            end
          end
        end

        context &#39;when object to be interpolated is NOT a hash&#39; do
          it &#39;raises an error&#39; do
            expect {
              client.interpolate(&#39;i am not a hash&#39;)
            }.to raise_error &quot;Unable to interpolate provided object. Expected a &#39;Hash&#39;, got &#39;String&#39;&quot;
          end
        end
      end

      context &#39;when object to be interpolated in is nil&#39; do
          it &#39;should return nil&#39; do
            expect(client.interpolate(nil)).to be_nil
          end
      end
    end

    describe &#39;#interpolate_with_versioning&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe##interpolate_with_versioning has a flog score of 25</span>          </div>  </li></ol>
      let(:deployment_name) { &#39;my_deployment_name&#39; }
      let(:variable_set_model) { instance_double(Bosh::Director::Models::VariableSet) }
      let(:raw_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L43" class="js-smell-location">0</a>                  <a href="client_spec.html#L410" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          &#39;properties&#39; =&gt; {
            &#39;integer_allowed&#39; =&gt; &#39;((integer_placeholder))&#39;,
            &#39;nil_allowed&#39; =&gt; &#39;((nil_placeholder))&#39;,
            &#39;empty_allowed&#39; =&gt; &#39;((empty_placeholder))&#39;
          },
          &#39;i_am_a_hash&#39; =&gt; {
            &#39;i_am_an_array&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;test_job&#39;,
                &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;((string_placeholder))&#39;}
              }
            ]
          },
          &#39;i_am_another_array&#39; =&gt; [
            {&#39;env&#39; =&gt; {&#39;env_prop&#39; =&gt; &#39;((hash_placeholder))&#39;}}
          ],
          &#39;my_value_will_be_a_hash&#39; =&gt; &#39;((hash_placeholder))&#39;
        }
      end
      let(:interpolated_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L64" class="js-smell-location">0</a>                  <a href="client_spec.html#L431" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          &#39;properties&#39; =&gt; {
            &#39;integer_allowed&#39; =&gt; 123,
            &#39;nil_allowed&#39; =&gt; nil,
            &#39;empty_allowed&#39; =&gt; &#39;&#39;
          },
          &#39;i_am_a_hash&#39; =&gt; {
            &#39;i_am_an_array&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;test_job&#39;,
                &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;i am a string&#39;}
              }
            ]
          },
          &#39;i_am_another_array&#39; =&gt; [
            {&#39;env&#39; =&gt; {&#39;env_prop&#39; =&gt; hash_placeholder_value}}
          ],
          &#39;my_value_will_be_a_hash&#39; =&gt; hash_placeholder_value
        }
      end
      let(:hash_placeholder_value) do
        {
          &#39;ca&#39; =&gt; {
            &#39;level_1&#39; =&gt; &#39;level_1_value&#39;,
            &#39;level_2&#39; =&gt; {
              &#39;level_2_1&#39; =&gt; &#39;level_2_1_value&#39;
            }
          },
          &#39;private_key&#39; =&gt; &#39;abc123&#39;
        }
      end

      shared_examples :variable_name_dot_syntax do
        context &#39;when some placeholders have the dot syntax&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L465" class="js-smell-location">0</a>                  <a href="client_spec.html#L795" class="js-smell-location">1</a>                  </div>  </li></ol>
          before do
            raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.private_key))&#39;
            interpolated_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;abc123&#39;
          end

          it &#39;extracts the variable name from placeholder name&#39; do
            expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
          end

          context &#39;when placeholders have multiple dot levels&#39; do
            before do
              raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca.level_2.level_2_1))&#39;
              interpolated_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;level_2_1_value&#39;
            end

            it &#39;extracts value from placeholder name&#39; do
              expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
            end
          end

          context &#39;when all parts of dot syntax are not found&#39; do
            before do
              raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca.level_n.level_n_1))&#39;
            end

            it &#39;fails to find values and throws formatting error&#39; do
              expect {
                client.interpolate_with_versioning(raw_hash, variable_set_model)
              }.to raise_error(&quot;- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; &quot; +
                                 &quot;from config server: Expected parent &#39;/smurf_director_name/my_deployment_name/hash_placeholder.ca&#39; hash to have key &#39;level_n&#39;&quot;)
            end
          end

          context &#39;when multiple errors occur because parts of dot syntax is not found&#39; do
            before do
              raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca.level_n.level_n_1))&#39;
              raw_hash[&#39;my_value_will_be_an_other_hash&#39;] = &#39;((hash_placeholder.ca.level_m.level_m_1))&#39;
            end

            it &#39;fails to find all values and throws formatting error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::shared_examples(variable_name_dot_syntax)::context(when some placeholders have the dot syntax)::context(when multiple errors occur because parts of dot syntax is not found)::it#fails to find all values and throws formatting error has a flog score of 44</span>          </div>  </li></ol>
              expect {
                client.interpolate_with_versioning(raw_hash, variable_set_model)
              }.to raise_error { |error|
                expect(error).to be_a(Bosh::Director::ConfigServerFetchError)
                expect(error.message).to include(&quot;- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; from config server: Expected parent &#39;/smurf_director_name/my_deployment_name/hash_placeholder.ca&#39; hash to have key &#39;level_n&#39;&quot;)
                expect(error.message).to include(&quot;- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; from config server: Expected parent &#39;/smurf_director_name/my_deployment_name/hash_placeholder.ca&#39; hash to have key &#39;level_m&#39;&quot;)
              }
            end
          end

          context &#39;when placeholders use bad dot syntax&#39; do
            before do
              raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca...level_1))&#39;
            end

            it &#39;fails to find value and throws formatting error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::shared_examples(variable_name_dot_syntax)::context(when some placeholders have the dot syntax)::context(when placeholders use bad dot syntax)::it#fails to find value and throws formatting error has a flog score of 33</span>          </div>  </li></ol>
              expect {
                client.interpolate_with_versioning(raw_hash, variable_set_model)
              }.to raise_error { |error|
                expect(error).to be_a(Bosh::Director::ConfigServerIncorrectNameSyntax)
                expect(error.message).to include(&quot;Variable name &#39;hash_placeholder.ca...level_1&#39; syntax error: Must not contain consecutive dots&quot;)
              }
            end
          end

          context &#39;when absolute path is required&#39; do
            it &#39;returns an error for non absolute path placeholders&#39; do
              expect {
                client.interpolate_with_versioning(raw_hash, variable_set_model, {must_be_absolute_name: true})
              }.to raise_error { |error|
                expect(error.message).to eq(&quot;Relative paths are not allowed in this context. The following must be be switched to use absolute paths: &#39;integer_placeholder&#39;, &#39;nil_placeholder&#39;, &#39;empty_placeholder&#39;, &#39;string_placeholder&#39;, &#39;hash_placeholder&#39;, &#39;hash_placeholder.private_key&#39;&quot;)
              }
            end
          end
        end
      end

      before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L543" class="js-smell-location">0</a>                  <a href="../errand/parallel_step_spec.html#L47" class="js-smell-location">1</a>                  <a href="../jobs/run_errand_spec.html#L394" class="js-smell-location">2</a>                  <a href="../jobs/update_deployment_spec.html#L301" class="js-smell-location">3</a>                  </div>  </li></ol>
        allow(deployment_model).to receive(:name).and_return(deployment_name)
        allow(variable_set_model).to receive(:deployment).and_return(deployment_model)
      end

      context &#39;when object to be interpolated is NOT nil&#39; do

        context &#39;when object to be interpolated is a hash&#39; do

          context &#39;when hash does NOT contain any placeholders&#39; do
            let(:raw_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L106" class="js-smell-location">0</a>                  <a href="client_spec.html#L553" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;properties&#39; =&gt; {
                  &#39;integer_allowed&#39; =&gt; &#39;1&#39;,
                  &#39;nil_allowed&#39; =&gt; nil,
                  &#39;empty_allowed&#39; =&gt; &#39;&#39;
                },
                &#39;i_am_a_hash&#39; =&gt; {
                  &#39;i_am_an_array&#39; =&gt; [
                    {
                      &#39;name&#39; =&gt; &#39;test_job&#39;,
                      &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;string&#39;}
                    }
                  ]
                },
                &#39;i_am_another_array&#39; =&gt; [
                  {&#39;env&#39; =&gt; {&#39;env_prop&#39; =&gt; {}}}
                ],
                &#39;my_value_will_be_a_hash&#39; =&gt; {}
              }
            end

            it &#39;does not raise an error&#39; do
              expect {
                client.interpolate_with_versioning(raw_hash, variable_set_model)
              }.to_not raise_error
            end

            it &#39;returns an equivalent hash&#39; do
                interpolated_hash = client.interpolate_with_versioning(raw_hash, variable_set_model)
                expect(interpolated_hash).to eq(raw_hash)
            end
          end

          context &#39;when all placeholders syntax is correct&#39; do

            let(:integer_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;integer_placeholder&#39;).to_s, &#39;value&#39; =&gt; 123, &#39;id&#39; =&gt; &#39;1&#39; }] }
            end
            let(:nil_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;nil_placeholder&#39;).to_s, &#39;value&#39; =&gt; nil, &#39;id&#39; =&gt; &#39;2&#39; }] }
            end
            let(:empty_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;empty_placeholder&#39;).to_s, &#39;value&#39; =&gt; &#39;&#39;, &#39;id&#39; =&gt; &#39;3&#39; }] }
            end
            let(:string_placeholder) do
              { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_namespace(&#39;string_placeholder&#39;).to_s, &#39;value&#39; =&gt; &#39;i am a string&#39;, &#39;id&#39; =&gt; &#39;4&#39; }] }
            end
            let(:hash_placeholder) do
              {
                &#39;data&#39; =&gt; [
                  {
                    &#39;name&#39; =&gt; prepend_namespace(&#39;hash_placeholder&#39;).to_s,
                    &#39;value&#39; =&gt; hash_placeholder_value,
                    &#39;id&#39; =&gt; &#39;5&#39;,
                  },
                ],
              }
            end

            let(:mock_config_store) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::let#mock_config_store has a flog score of 39</span>          </div>  </li></ol>
              {
                prepend_namespace(&#39;integer_placeholder&#39;) =&gt; generate_success_response(integer_placeholder.to_json),
                prepend_namespace(&#39;nil_placeholder&#39;) =&gt; generate_success_response(nil_placeholder.to_json),
                prepend_namespace(&#39;empty_placeholder&#39;) =&gt; generate_success_response(empty_placeholder.to_json),
                prepend_namespace(&#39;string_placeholder&#39;) =&gt; generate_success_response(string_placeholder.to_json),
                prepend_namespace(&#39;hash_placeholder&#39;) =&gt; generate_success_response(hash_placeholder.to_json),
              }
            end

            context &#39;when there is no variable set&#39; do
              let(:variable_name) { &#39;/boo&#39; }
              let(:variable_id) { &#39;cfg-svr-id&#39; }
              let(:variable_value) { &#39;var_val&#39; }

              let(:response_body_id) do
                { &#39;name&#39; =&gt; variable_name, &#39;value&#39; =&gt; variable_value, &#39;id&#39; =&gt; variable_id }
              end
              let(:response_body_name) do
                { &#39;data&#39; =&gt; [response_body_id] }
              end
              let(:mock_response) { generate_success_response(response_body_name.to_json) }

              before do
                allow(http_client).to receive(:get).with(&#39;/boo&#39;).and_return(mock_response)
              end

              it &#39;should raise an error&#39; do
                expect {
                  client.interpolate_with_versioning({&#39;key&#39; =&gt; &quot;((#{variable_name}))&quot;}, nil)
                }.to raise_error &quot;Variable Set cannot be nil.&quot;
              end
            end

            context &#39;when all the variables to be fetched were already fetched within the provided variable set context&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context#when all the variables to be fetched were already fetched within the provided variable set context has a flog score of 76</span>          </div>  </li></ol>
              before do
                mock_config_store.each do |name, value|
                  result_data = JSON.parse(value.body)[&#39;data&#39;][0]
                  variable_id = result_data[&#39;id&#39;]

                  variable_model = instance_double(Bosh::Director::Models::Variable)
                  allow(variable_model).to receive(:variable_name).and_return(name)
                  allow(variable_model).to receive(:variable_id).and_return(variable_id)
                  allow(variable_set_model).to receive(:find_variable_by_name).with(name).and_return(variable_model)

                  allow(http_client).to receive(:get_by_id).with(variable_id).and_return(generate_success_response(result_data.to_json))
                end
              end

              it &#39;should request all variables by id and returns the interpolated hash&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L662" class="js-smell-location">0</a>                  <a href="client_spec.html#L783" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::it#should request all variables by id and returns the interpolated hash has a flog score of 55</span>          </div>  </li></ol>
                mock_config_store.each do |_, value|
                  result_data = JSON.parse(value.body)[&#39;data&#39;][0]
                  variable_id = result_data[&#39;id&#39;]

                  expect(http_client).to receive(:get_by_id).with(variable_id).and_return(generate_success_response(result_data.to_json))
                end

                expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
              end

              it &#39;should return a new copy of the original manifest&#39; do
                expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
              end

              context &#39;when an id is not found in the config server&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L677" class="js-smell-location">0</a>                  <a href="client_spec.html#L703" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context#when an id is not found in the config server has a flog score of 38</span>          </div>  </li></ol>
                before do
                  mock_config_store.each do |_, value|
                    result_data = JSON.parse(value.body)[&#39;data&#39;][0]
                    variable_id = result_data[&#39;id&#39;]
                    allow(http_client).to receive(:get_by_id).with(variable_id).and_return(SampleNotFoundResponse.new)
                  end
                end

                it &#39;returns all the errors correctly formatted&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when an id is not found in the config server)::it#returns all the errors correctly formatted has a flog score of 30</span>          </div>  </li></ol>
                  expected_error_msg = &lt;&lt;-EXPECTED.strip
- Failed to find variable &#39;/smurf_director_name/my_deployment_name/integer_placeholder&#39; with id &#39;1&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/my_deployment_name/nil_placeholder&#39; with id &#39;2&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/my_deployment_name/empty_placeholder&#39; with id &#39;3&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/my_deployment_name/string_placeholder&#39; with id &#39;4&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; with id &#39;5&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
                  EXPECTED

                  expect {
                    client.interpolate_with_versioning(raw_hash, variable_set_model)
                  }.to raise_error { |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'e'</span>              <span>Locations:</span>                  <a href="client_spec.html#L697" class="js-smell-location">0</a>                  <a href="client_spec.html#L723" class="js-smell-location">1</a>                  <a href="client_spec.html#L1222" class="js-smell-location">2</a>                  <a href="client_spec.html#L1253" class="js-smell-location">3</a>                  <a href="client_spec.html#L1332" class="js-smell-location">4</a>                  </div>  </li></ol>
                    expect(e.message).to eq(expected_error_msg)
                  }
                end
              end

              context &#39;when config server throws an error while fetching values&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L677" class="js-smell-location">0</a>                  <a href="client_spec.html#L703" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context#when config server throws an error while fetching values has a flog score of 38</span>          </div>  </li></ol>
                before do
                  mock_config_store.each do |_, value|
                    result_data = JSON.parse(value.body)[&#39;data&#39;][0]
                    variable_id = result_data[&#39;id&#39;]
                    allow(http_client).to receive(:get_by_id).with(variable_id).and_return(SampleForbiddenResponse.new)
                  end
                end

                it &#39;returns all the errors correctly formatted&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when config server throws an error while fetching values)::it#returns all the errors correctly formatted has a flog score of 30</span>          </div>  </li></ol>
                  expected_error_msg = &lt;&lt;-EXPECTED.strip
- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/integer_placeholder&#39; with id &#39;1&#39; from config server: HTTP Code &#39;403&#39;, Error: &#39;There was a problem&#39;
- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/nil_placeholder&#39; with id &#39;2&#39; from config server: HTTP Code &#39;403&#39;, Error: &#39;There was a problem&#39;
- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/empty_placeholder&#39; with id &#39;3&#39; from config server: HTTP Code &#39;403&#39;, Error: &#39;There was a problem&#39;
- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/string_placeholder&#39; with id &#39;4&#39; from config server: HTTP Code &#39;403&#39;, Error: &#39;There was a problem&#39;
- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; with id &#39;5&#39; from config server: HTTP Code &#39;403&#39;, Error: &#39;There was a problem&#39;
                  EXPECTED

                  expect {
                    client.interpolate_with_versioning(raw_hash, variable_set_model)
                  }.to raise_error { |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'e'</span>              <span>Locations:</span>                  <a href="client_spec.html#L697" class="js-smell-location">0</a>                  <a href="client_spec.html#L723" class="js-smell-location">1</a>                  <a href="client_spec.html#L1222" class="js-smell-location">2</a>                  <a href="client_spec.html#L1253" class="js-smell-location">3</a>                  <a href="client_spec.html#L1332" class="js-smell-location">4</a>                  </div>  </li></ol>
                    expect(e.message).to eq(expected_error_msg)
                  }
                end
              end

              context &#39;when options passed contain ignored subtrees&#39; do
                let(:ignored_subtrees) do
                  index_integer = Integer

                  ignored_subtrees = []
                  ignored_subtrees &lt;&lt; [&#39;properties&#39;, &#39;integer_allowed&#39;]
                  ignored_subtrees &lt;&lt; [&#39;i_am_a_hash&#39;, &#39;i_am_an_array&#39;, index_integer, &#39;properties&#39;]
                  ignored_subtrees
                end

                let(:interpolated_hash) do
                  {
                    &#39;properties&#39; =&gt; {
                      &#39;integer_allowed&#39; =&gt; &#39;((integer_placeholder))&#39;,
                      &#39;nil_allowed&#39; =&gt; nil,
                      &#39;empty_allowed&#39; =&gt; &#39;&#39;
                    },
                    &#39;i_am_a_hash&#39; =&gt; {
                      &#39;i_am_an_array&#39; =&gt; [
                        {
                          &#39;name&#39; =&gt; &#39;test_job&#39;,
                          &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;((string_placeholder))&#39;}
                        }
                      ]
                    },
                    &#39;i_am_another_array&#39; =&gt; [
                      {&#39;env&#39; =&gt; {&#39;env_prop&#39; =&gt; hash_placeholder_value}}
                    ],
                    &#39;my_value_will_be_a_hash&#39; =&gt; hash_placeholder_value
                  }
                end

                it &#39;does NOT replace values in ignored subtrees&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when options passed contain ignored subtrees)::it#does NOT replace values in ignored subtrees has a flog score of 46</span>          </div>  </li></ol>
                  expect(http_client).to_not receive(:get_by_id).with(&#39;1&#39;)
                  expect(http_client).to_not receive(:get_by_id).with(&#39;4&#39;)
                  expect(client.interpolate_with_versioning(raw_hash, variable_set_model, {subtrees_to_ignore: ignored_subtrees})).to eq(interpolated_hash)
                end
              end

              context &#39;when some placeholders begin with a !&#39; do
                before do
                  raw_hash[&#39;properties&#39;] = {
                    &#39;!integer_allowed&#39; =&gt; &#39;((integer_placeholder))&#39;,
                    &#39;!nil_allowed&#39; =&gt; &#39;((nil_placeholder))&#39;,
                    &#39;!empty_allowed&#39; =&gt; &#39;((empty_placeholder))&#39;
                  }

                  interpolated_hash[&#39;properties&#39;] =  {
                    &#39;!integer_allowed&#39; =&gt; 123,
                    &#39;!nil_allowed&#39; =&gt; nil,
                    &#39;!empty_allowed&#39; =&gt; &#39;&#39;
                  }
                end

                it &#39;should strip the exclamation mark&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L662" class="js-smell-location">0</a>                  <a href="client_spec.html#L783" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when some placeholders begin with a !)::it#should strip the exclamation mark has a flog score of 58</span>          </div>  </li></ol>
                  mock_config_store.each do |_, value|
                    result_data = JSON.parse(value.body)[&#39;data&#39;][0]
                    variable_id = result_data[&#39;id&#39;]

                    expect(http_client).to receive(:get_by_id).with(variable_id).and_return(generate_success_response(result_data.to_json))
                  end

                  expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
                end
              end

              context &#39;when some placeholders have the dot syntax&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L465" class="js-smell-location">0</a>                  <a href="client_spec.html#L795" class="js-smell-location">1</a>                  </div>  </li></ol>
                before do
                  raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.private_key))&#39;
                  interpolated_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;abc123&#39;
                end

                it &#39;extracts the variable name from placeholder name&#39; do
                  expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
                end

                context &#39;when placeholders have multiple dot levels&#39; do
                  before do
                    raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca.level_2.level_2_1))&#39;
                    interpolated_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;level_2_1_value&#39;
                  end

                  it &#39;extracts value from placeholder name&#39; do
                    expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
                  end
                end

                context &#39;when all parts of dot syntax are not found&#39; do
                  before do
                    raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca.level_n.level_n_1))&#39;
                  end

                  it &#39;fails to find values and throws formatting error&#39; do
                    expect {
                      client.interpolate_with_versioning(raw_hash, variable_set_model)
                    }.to raise_error(&quot;- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; &quot; +
                                       &quot;from config server: Expected parent &#39;/smurf_director_name/my_deployment_name/hash_placeholder.ca&#39; hash to have key &#39;level_n&#39;&quot;)
                  end
                end

                context &#39;when multiple errors occur because parts of dot syntax is not found&#39; do
                  before do
                    raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca.level_n.level_n_1))&#39;
                    raw_hash[&#39;my_value_will_be_an_other_hash&#39;] = &#39;((hash_placeholder.ca.level_m.level_m_1))&#39;
                  end

                  it &#39;fails to find all values and throws formatting error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when some placeholders have the dot syntax)::context(when multiple errors occur because parts of dot syntax is not found)::it#fails to find all values and throws formatting error has a flog score of 52</span>          </div>  </li></ol>
                    expect {
                      client.interpolate_with_versioning(raw_hash, variable_set_model)
                    }.to raise_error { |error|
                      expect(error).to be_a(Bosh::Director::ConfigServerFetchError)
                      expect(error.message).to include(&quot;- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; from config server: Expected parent &#39;/smurf_director_name/my_deployment_name/hash_placeholder.ca&#39; hash to have key &#39;level_n&#39;&quot;)
                      expect(error.message).to include(&quot;- Failed to fetch variable &#39;/smurf_director_name/my_deployment_name/hash_placeholder&#39; from config server: Expected parent &#39;/smurf_director_name/my_deployment_name/hash_placeholder.ca&#39; hash to have key &#39;level_m&#39;&quot;)
                    }
                  end
                end

                context &#39;when placeholders use bad dot syntax&#39; do
                  before do
                    raw_hash[&#39;my_value_will_be_a_hash&#39;] = &#39;((hash_placeholder.ca...level_1))&#39;
                  end

                  it &#39;fails to find value and throws formatting error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when some placeholders have the dot syntax)::context(when placeholders use bad dot syntax)::it#fails to find value and throws formatting error has a flog score of 39</span>          </div>  </li></ol>
                    expect {
                      client.interpolate_with_versioning(raw_hash, variable_set_model)
                    }.to raise_error { |error|
                      expect(error).to be_a(Bosh::Director::ConfigServerIncorrectNameSyntax)
                      expect(error.message).to include(&quot;Variable name &#39;hash_placeholder.ca...level_1&#39; syntax error: Must not contain consecutive dots&quot;)
                    }
                  end
                end

                context &#39;when absolute path is required&#39; do
                  it &#39;returns an error for non absolute path placeholders&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when some placeholders have the dot syntax)::context(when absolute path is required)::it#returns an error for non absolute path placeholders has a flog score of 27</span>          </div>  </li></ol>
                    expect {
                      client.interpolate_with_versioning(raw_hash, variable_set_model, {must_be_absolute_name: true})
                    }.to raise_error { |error|
                      expect(error.message).to eq(&quot;Relative paths are not allowed in this context. The following must be be switched to use absolute paths: &#39;integer_placeholder&#39;, &#39;nil_placeholder&#39;, &#39;empty_placeholder&#39;, &#39;string_placeholder&#39;, &#39;hash_placeholder&#39;, &#39;hash_placeholder.private_key&#39;&quot;)
                    }
                  end
                end
              end

              context &#39;when response received from server is not in the expected format&#39; do
                let(:raw_hash) do
                  {
                    &#39;name&#39; =&gt; &#39;deployment_name&#39;,
                    &#39;properties&#39; =&gt; {
                      &#39;name&#39; =&gt; &#39;((/bad))&#39;
                    }
                  }
                end

                [
                  {&#39;response&#39; =&gt; &#39;Invalid JSON response&#39;,
                   &#39;message&#39; =&gt; &quot;- Failed to fetch variable &#39;/bad&#39; with id &#39;20&#39; from config server: Invalid JSON response&quot;},

                  {&#39;response&#39; =&gt; &#39;{&quot;id&quot; : &quot;some-id&quot;}&#39;,
                   &#39;message&#39; =&gt; &quot;- Failed to fetch variable &#39;/bad&#39; from config server: Expected response to have key &#39;value&#39;&quot;},

                  {&#39;response&#39; =&gt; &#39;{&quot;value&quot; : &quot;some-value-foo&quot;}&#39;,
                   &#39;message&#39; =&gt; &quot;- Failed to fetch variable &#39;/bad&#39; from config server: Expected response to have key &#39;id&#39;&quot;},

                  {&#39;response&#39; =&gt; &#39;{}&#39;,
                   &#39;message&#39; =&gt; &quot;- Failed to fetch variable &#39;/bad&#39; from config server: Expected response to have key &#39;id&#39;&quot;},

                  {&#39;response&#39; =&gt; &#39;[{&quot;name&quot; : &quot;name1&quot;, &quot;id&quot; : &quot;id1&quot;, &quot;val&quot; : &quot;x&quot;}, {&quot;name&quot; : &quot;name2&quot;, &quot;id&quot; : &quot;id2&quot;, &quot;val&quot; : &quot;y&quot;}]&#39;,
                   &#39;message&#39; =&gt; &quot;- Failed to fetch variable &#39;/bad&#39; from config server: Expected response to be a hash, got &#39;Array&#39;&quot;},
                ].each do |entry|
                  it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched were already fetched within the provided variable set context)::context(when response received from server is not in the expected format)::it#raises an error has a flog score of 98</span>          </div>  </li></ol>
                    variable_model = instance_double(Bosh::Director::Models::Variable)
                    allow(variable_model).to receive(:variable_name).and_return(&#39;/bad&#39;)
                    allow(variable_model).to receive(:variable_id).and_return(&#39;20&#39;)
                    allow(variable_set_model).to receive(:find_variable_by_name).with(&#39;/bad&#39;).and_return(variable_model)
                    allow(http_client).to receive(:get_by_id).with(&#39;20&#39;).and_return(generate_success_response(entry[&#39;response&#39;]))

                    expect {
                      client.interpolate_with_versioning(raw_hash, variable_set_model)
                    }.to raise_error { |error|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L255" class="js-smell-location">0</a>                  <a href="client_spec.html#L907" class="js-smell-location">1</a>                  </div>  </li></ol>
                      expect(error).to be_a(Bosh::Director::ConfigServerFetchError)
                      expect(error.message).to include(entry[&#39;message&#39;])
                    }
                  end
                end
              end

              it_behaves_like :variable_name_dot_syntax
            end

            context &#39;when all the variables to be fetched are not in the current set&#39; do
              before do
                mock_config_store.each do |name, value|
                  allow(variable_set_model).to receive(:find_variable_by_name).with(name).and_return(nil)
                end
              end

              context &#39;when variable set is writable&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched are not in the current set)::context#when variable set is writable has a flog score of 68</span>          </div>  </li></ol>
                before do
                  allow(variable_set_model).to receive(:writable).and_return(true)

                  mock_config_store.each do |name, value|
                    result_body = JSON.parse(value.body)
                    variable_id = result_body[&#39;data&#39;][0][&#39;id&#39;]

                    allow(http_client).to receive(:get).with(name).and_return(generate_success_response(result_body.to_json))
                    allow(variable_set_model).to receive(:add_variable).with({:variable_name =&gt; name, :variable_id =&gt; variable_id})
                  end
                end

                it &#39;should add the name to id mapping for the current set to database&#39; do
                  expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
                end

                context &#39;when the variable was added to the current set by another thread&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched are not in the current set)::context(when variable set is writable)::context#when the variable was added to the current set by another thread has a flog score of 98</span>          </div>  </li></ol>
                  before do
                    mock_config_store.each do |name, value|
                      result_body = JSON.parse(value.body)
                      result_data = result_body[&#39;data&#39;][0]
                      variable_id = result_data[&#39;id&#39;]

                      variable_model = instance_double(Bosh::Director::Models::Variable)
                      allow(variable_model).to receive(:variable_name).and_return(name)
                      allow(variable_model).to receive(:variable_id).and_return(variable_id)

                      allow(variable_set_model).to receive(:find_variable_by_name).with(name).and_return(nil, variable_model)

                      allow(variable_set_model).to receive(:add_variable)
                                                     .with({:variable_name =&gt; name, :variable_id =&gt; variable_id})
                                                     .and_raise(Sequel::UniqueConstraintViolation.new)

                      allow(http_client).to receive(:get_by_id)
                                              .with(variable_id)
                                              .and_return(generate_success_response(result_data.to_json))
                    end
                  end
                  it &#39;should fetch by id from database&#39; do
                    expect(client.interpolate_with_versioning(raw_hash, variable_set_model)).to eq(interpolated_hash)
                  end
                end

                it_behaves_like :variable_name_dot_syntax
              end

              context &#39;when variable set is NOT writable&#39; do
                before do
                  allow(variable_set_model).to receive(:writable).and_return(false)
                end
                it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_with_versioning)::context(when object to be interpolated is NOT nil)::context(when object to be interpolated is a hash)::context(when all placeholders syntax is correct)::context(when all the variables to be fetched are not in the current set)::context(when variable set is NOT writable)::it#should raise an error has a flog score of 37</span>          </div>  </li></ol>
                  expect {
                    client.interpolate_with_versioning(raw_hash, variable_set_model)
                  }.to raise_error { |error|
                    expect(error).to be_a(Bosh::Director::ConfigServerInconsistentVariableState)
                    expect(error.message).to include(&quot;Expected variable &#39;/smurf_director_name/my_deployment_name/integer_placeholder&#39; to be already versioned in deployment &#39;my_deployment_name&#39;&quot;)
                  }
                end
              end
            end
          end

          context &#39;when some placeholders have invalid name syntax&#39; do
            let(:provided_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L363" class="js-smell-location">0</a>                  <a href="client_spec.html#L989" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;properties&#39; =&gt; {
                  &#39;integer_allowed&#39; =&gt; &#39;((int&amp;&amp;&amp;&amp;eger_placeholder))&#39;,
                  &#39;nil_allowed&#39; =&gt; &#39;((nil_place holder))&#39;,
                  &#39;empty_allowed&#39; =&gt; &#39;((emp**ty_placeholder))&#39;
                },
                &#39;i_am_a_hash&#39; =&gt; {
                  &#39;i_am_an_array&#39; =&gt; [
                    {
                      &#39;name&#39; =&gt; &#39;test_job&#39;,
                      &#39;properties&#39; =&gt; {&#39;job_prop&#39; =&gt; &#39;((job_placeholder+++ ))&#39;}
                    }
                  ]
                }
              }
            end

            # TODO: make sure all the errors are displayed
            it &#39;should raise an error&#39; do
              expect {
                client.interpolate_with_versioning(provided_hash, variable_set_model)
              }.to raise_error Bosh::Director::ConfigServerIncorrectNameSyntax,
                               &quot;Variable name &#39;int&amp;&amp;&amp;&amp;eger_placeholder&#39; must only contain alphanumeric, underscores, dashes, or forward slash characters&quot;
            end
          end
        end

        context &#39;when object to be interpolated is NOT a hash&#39; do
          it &#39;raises an error&#39; do
            expect {
              client.interpolate_with_versioning(&#39;i am not a hash&#39;, variable_set_model)
            }.to raise_error &quot;Unable to interpolate provided object. Expected a &#39;Hash&#39;, got &#39;String&#39;&quot;
          end
        end
      end

      context &#39;when object to be interpolated is nil&#39; do
        it &#39;should return nil&#39; do
          expect(client.interpolate_with_versioning(nil, variable_set_model)).to be_nil
        end
      end
    end

    describe &#39;#interpolate_cross_deployment_link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe##interpolate_cross_deployment_link has a flog score of 48</span>          </div>  </li></ol>
      def prepend_provider_namespace(name)
        &quot;/#{director_name}/#{provider_deployment_name}/#{name}&quot;
      end

      let(:integer_placeholder) do
        { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_provider_namespace(&#39;integer_placeholder&#39;).to_s, &#39;value&#39; =&gt; 123, &#39;id&#39; =&gt; &#39;1&#39; }] }
      end
      let(:cert_placeholder) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1041" class="js-smell-location">0</a>                  <a href="client_spec.html#L1068" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          &#39;data&#39; =&gt; [{
            &#39;name&#39; =&gt; prepend_provider_namespace(&#39;cert_placeholder&#39;).to_s,
            &#39;value&#39; =&gt; { &#39;ca&#39; =&gt; &#39;ca_value&#39;, &#39;private_key&#39; =&gt; &#39;abc123&#39; },
            &#39;id&#39; =&gt; &#39;2&#39;,
          }],
        }
      end
      let(:nil_placeholder) do
        {
          &#39;data&#39; =&gt; [{
            &#39;name&#39; =&gt; prepend_provider_namespace(&#39;nil_placeholder&#39;).to_s,
            &#39;value&#39; =&gt; nil,
            &#39;id&#39; =&gt; &#39;3&#39;,
          }],
        }
      end
      let(:empty_placeholder) do
        { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_provider_namespace(&#39;empty_placeholder&#39;).to_s, &#39;value&#39; =&gt; &#39;&#39;, &#39;id&#39; =&gt; &#39;4&#39; }] }
      end
      let(:string_placeholder) do
        { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; prepend_provider_namespace(&#39;instance_placeholder&#39;).to_s, &#39;value&#39; =&gt; &#39;test1&#39;, &#39;id&#39; =&gt; &#39;5&#39; }] }
      end
      let(:absolute_placeholder) do
        { &#39;data&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;/absolute_placeholder&#39;, &#39;value&#39; =&gt; &#39;I am absolute&#39;, &#39;id&#39; =&gt; &#39;6&#39; }] }
      end
      let(:hash_placeholder) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1041" class="js-smell-location">0</a>                  <a href="client_spec.html#L1068" class="js-smell-location">1</a>                  </div>  </li></ol>
        {
          &#39;data&#39; =&gt; [{
            &#39;name&#39; =&gt; prepend_provider_namespace(&#39;cert_placeholder&#39;).to_s,
            &#39;value&#39; =&gt; { &#39;cat&#39; =&gt; &#39;meow&#39;, &#39;dog&#39; =&gt; &#39;woof&#39; },
            &#39;id&#39; =&gt; &#39;7&#39;,
          }],
        }
      end

      let(:mock_config_store) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::let#mock_config_store has a flog score of 43</span>          </div>  </li></ol>
        {
          prepend_provider_namespace(&#39;integer_placeholder&#39;) =&gt; generate_success_response(integer_placeholder.to_json),
          prepend_provider_namespace(&#39;cert_placeholder&#39;) =&gt; generate_success_response(cert_placeholder.to_json),
          prepend_provider_namespace(&#39;nil_placeholder&#39;) =&gt; generate_success_response(nil_placeholder.to_json),
          prepend_provider_namespace(&#39;empty_placeholder&#39;) =&gt; generate_success_response(empty_placeholder.to_json),
          prepend_provider_namespace(&#39;string_placeholder&#39;) =&gt; generate_success_response(string_placeholder.to_json),
          &#39;/absolute_placeholder&#39; =&gt; generate_success_response(absolute_placeholder.to_json),
          prepend_provider_namespace(&#39;hash_placeholder&#39;) =&gt; generate_success_response(hash_placeholder.to_json)
        }
      end

      let(:links_properties_spec) do
        {
          &#39;age&#39; =&gt; &#39;((integer_placeholder))&#39;,
          &#39;hash_value&#39; =&gt; &#39;((cert_placeholder))&#39;,
          &#39;dots_allowed&#39; =&gt; &#39;((hash_placeholder.cat))&#39;,
          &#39;nil_allowed&#39; =&gt; &#39;((nil_placeholder))&#39;,
          &#39;empty_allowed&#39; =&gt; &#39;((empty_placeholder))&#39;,
          &#39;nested_allowed&#39; =&gt; {
            &#39;level_1&#39; =&gt; &#39;((!string_placeholder))&#39;
          },
          &#39;absolute_allowed&#39; =&gt; &#39;((/absolute_placeholder))&#39;
        }
      end

      let(:interpolated_links_properties_spec) do
        {
          &#39;age&#39; =&gt; 123,
          &#39;hash_value&#39; =&gt; {&#39;ca&#39; =&gt; &#39;ca_value&#39;, &#39;private_key&#39; =&gt; &#39;abc123&#39;},
          &#39;dots_allowed&#39; =&gt; &#39;meow&#39;,
          &#39;nil_allowed&#39; =&gt; nil,
          &#39;empty_allowed&#39; =&gt; &#39;&#39;,
          &#39;nested_allowed&#39; =&gt; {
            &#39;level_1&#39; =&gt; &#39;test1&#39;
          },
          &#39;absolute_allowed&#39; =&gt; &#39;I am absolute&#39;
        }
      end

      let(:consumer_deployment_name) { &#39;consumer_deployment_name&#39; }
      let(:provider_deployment_name) { &#39;provider_deployment_name&#39; }

      let(:consumer_deployment) { instance_double(Bosh::Director::Models::Deployment) }
      let(:provider_deployment) { instance_double(Bosh::Director::Models::Deployment) }

      let(:consumer_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }
      let(:provider_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

      before do
        allow(consumer_deployment).to receive(:name).and_return(consumer_deployment_name)
        allow(provider_deployment).to receive(:name).and_return(provider_deployment_name)
        allow(consumer_variable_set).to receive(:deployment).and_return(consumer_deployment)
        allow(provider_variable_set).to receive(:deployment).and_return(provider_deployment)
      end

      context &#39;when links spec passed is nil&#39; do
        it &#39;returns it as nil&#39; do
          actual_interpolated_link_spec = client.interpolate_cross_deployment_link(nil, consumer_variable_set, provider_variable_set)
          expect(actual_interpolated_link_spec).to be_nil
        end
      end

      context &#39;when links spec passed is NOT a hash&#39; do
        it &#39;throws an error&#39; do
          expect {
            client.interpolate_cross_deployment_link(&#39;vroooom&#39;, consumer_variable_set, provider_variable_set)
          }.to raise_error &quot;Unable to interpolate cross deployment link properties. Expected a &#39;Hash&#39;, got &#39;String&#39;&quot;
        end
      end

      context &#39;when links spec passed is a hash&#39; do

        context &#39;when links spec hash does NOT contain any placeholders&#39; do
          let(:links_properties_spec) do
            {
              &#39;age&#39; =&gt; 6,
              &#39;hash_value&#39; =&gt; &#39;0123456789&#39;,
              &#39;dots_allowed&#39; =&gt; true,
              &#39;nil_allowed&#39; =&gt; true,
              &#39;empty_allowed&#39; =&gt; true,
              &#39;nested_allowed&#39; =&gt; {
                &#39;level_1&#39; =&gt; &#39;&#39;
              },
              &#39;absolute_allowed&#39; =&gt; &#39;why?&#39;
            }
          end

          it &#39;does not raise an error&#39; do
            expect {
              client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
            }.to_not raise_error
          end

          it &#39;returns a hash equivalent to the links spec hash&#39; do
            interpolated_spec = client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
            expect(interpolated_spec).to eq(links_properties_spec)
          end
        end

        context &#39;when the consumer variable_set already has all the variables&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context#when the consumer variable_set already has all the variables has a flog score of 70</span>          </div>  </li></ol>
          before do
            mock_config_store.each do |name, value|
              result_data = JSON.parse(value.body)[&#39;data&#39;][0]
              variable_id = result_data[&#39;id&#39;]

              variable_model = instance_double(Bosh::Director::Models::Variable)
              allow(variable_model).to receive(:variable_name).and_return(name)
              allow(variable_model).to receive(:variable_id).and_return(variable_id)
              allow(consumer_variable_set).to receive(:find_provided_variable_by_name).with(name, provider_deployment_name).and_return(variable_model)

              allow(http_client).to receive(:get_by_id).with(variable_id).and_return(generate_success_response(result_data.to_json))
            end
          end

          it &#39;fetches the value from the config server with correct ID and return the interpolated hash&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set already has all the variables)::it#fetches the value from the config server with correct ID and return the interpolated hash has a flog score of 26</span>          </div>  </li></ol>
            actual_interpolated_link_spec = client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
            expect(actual_interpolated_link_spec).to eq(interpolated_links_properties_spec)
            expect(actual_interpolated_link_spec).to_not equal(interpolated_links_properties_spec)
          end

          context &#39;when an error occurs while requesting values from config server&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set already has all the variables)::context#when an error occurs while requesting values from config server has a flog score of 35</span>          </div>  </li></ol>
            before do
              mock_config_store.each do |_, value|
                result_data = JSON.parse(value.body)[&#39;data&#39;][0]
                variable_id = result_data[&#39;id&#39;]

                allow(http_client).to receive(:get_by_id).with(variable_id).and_return(SampleNotFoundResponse.new)
              end
            end

            it &#39;returns a formatted error message&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1209" class="js-smell-location">0</a>                  <a href="client_spec.html#L1240" class="js-smell-location">1</a>                  <a href="client_spec.html#L1319" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L117" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set already has all the variables)::context(when an error occurs while requesting values from config server)::it#returns a formatted error message has a flog score of 30</span>          </div>  </li></ol>
              expected_error_msg = &lt;&lt;-EXPECTED.strip
- Failed to find variable &#39;/smurf_director_name/provider_deployment_name/integer_placeholder&#39; with id &#39;1&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/provider_deployment_name/cert_placeholder&#39; with id &#39;2&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/provider_deployment_name/hash_placeholder&#39; with id &#39;7&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/provider_deployment_name/nil_placeholder&#39; with id &#39;3&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/provider_deployment_name/empty_placeholder&#39; with id &#39;4&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/smurf_director_name/provider_deployment_name/string_placeholder&#39; with id &#39;5&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
- Failed to find variable &#39;/absolute_placeholder&#39; with id &#39;6&#39; from config server: HTTP Code &#39;404&#39;, Error: &#39;Name not found&#39;
              EXPECTED

              expect {
                client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
              }.to raise_error { |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'e'</span>              <span>Locations:</span>                  <a href="client_spec.html#L697" class="js-smell-location">0</a>                  <a href="client_spec.html#L723" class="js-smell-location">1</a>                  <a href="client_spec.html#L1222" class="js-smell-location">2</a>                  <a href="client_spec.html#L1253" class="js-smell-location">3</a>                  <a href="client_spec.html#L1332" class="js-smell-location">4</a>                  </div>  </li></ol>
                expect(e.message).to eq(expected_error_msg)
              }
            end
          end
        end

        context &#39;when the consumer variable_set does not have all the variables&#39; do

          context &#39;when consumer variable set is NOT writable&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set does not have all the variables)::context#when consumer variable set is NOT writable has a flog score of 35</span>          </div>  </li></ol>
            before do
              allow(consumer_variable_set).to receive(:writable).and_return(false)

              mock_config_store.each do |name, _|
                allow(consumer_variable_set).to receive(:find_provided_variable_by_name).with(name, provider_deployment_name).and_return(nil)
              end
            end

            it &#39;should raise an exception with formatted error messages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1209" class="js-smell-location">0</a>                  <a href="client_spec.html#L1240" class="js-smell-location">1</a>                  <a href="client_spec.html#L1319" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L117" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set does not have all the variables)::context(when consumer variable set is NOT writable)::it#should raise an exception with formatted error messages has a flog score of 30</span>          </div>  </li></ol>
              expected_error_msg = &lt;&lt;-EXPECTED.strip
- Expected variable &#39;/smurf_director_name/provider_deployment_name/integer_placeholder&#39; to be already versioned in deployment &#39;consumer_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/cert_placeholder&#39; to be already versioned in deployment &#39;consumer_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/hash_placeholder&#39; to be already versioned in deployment &#39;consumer_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/nil_placeholder&#39; to be already versioned in deployment &#39;consumer_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/empty_placeholder&#39; to be already versioned in deployment &#39;consumer_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/string_placeholder&#39; to be already versioned in deployment &#39;consumer_deployment_name&#39;
- Expected variable &#39;/absolute_placeholder&#39; to be already versioned in deployment &#39;consumer_deployment_name&#39;
              EXPECTED

              expect {
                client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
              }.to raise_error { |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'e'</span>              <span>Locations:</span>                  <a href="client_spec.html#L697" class="js-smell-location">0</a>                  <a href="client_spec.html#L723" class="js-smell-location">1</a>                  <a href="client_spec.html#L1222" class="js-smell-location">2</a>                  <a href="client_spec.html#L1253" class="js-smell-location">3</a>                  <a href="client_spec.html#L1332" class="js-smell-location">4</a>                  </div>  </li></ol>
                expect(e.message).to eq(expected_error_msg)
              }
            end
          end

          context &#39;when consumer variable set is writable&#39; do
            before do
              allow(consumer_variable_set).to receive(:writable).and_return(true)
            end

            context &#39;when the provider variable set has the variable&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set does not have all the variables)::context(when consumer variable set is writable)::context#when the provider variable set has the variable has a flog score of 105</span>          </div>  </li></ol>
              before do
                mock_config_store.each do |name, value|
                  result_data = JSON.parse(value.body)[&#39;data&#39;][0]
                  variable_id = result_data[&#39;id&#39;]

                  variable_model = instance_double(Bosh::Director::Models::Variable)
                  allow(variable_model).to receive(:variable_name).and_return(name)
                  allow(variable_model).to receive(:variable_id).and_return(variable_id)

                  allow(consumer_variable_set).to receive(:find_provided_variable_by_name).with(name, provider_deployment_name).and_return(nil)
                  # expecting here because we can !
                  expect(consumer_variable_set).to receive(:add_variable).with({variable_name:name, variable_id: variable_id, is_local: false, provider_deployment: provider_deployment_name})
                  allow(provider_variable_set).to receive(:find_variable_by_name).with(name).and_return(variable_model)

                  allow(http_client).to receive(:get_by_id).with(variable_id).and_return(generate_success_response(result_data.to_json))
                end
              end

              it &#39;should copy the variable to the consumer variable set and fetches the values from config server&#39; do
                actual_interpolated_link_spec = client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
                expect(actual_interpolated_link_spec).to eq(interpolated_links_properties_spec)
              end

              context &#39;when the consumer variable_set throws unique constraint violation while copying variable to it (concurrency possibility)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set does not have all the variables)::context(when consumer variable set is writable)::context(when the provider variable set has the variable)::context(when the consumer variable_set throws unique constraint violation while copying variable to it (concurrency possibility))#when the consumer variable_set throws unique constraint violation while copying variable to it (concurrency possibility) has a flog score of 35</span>          </div>  </li></ol>
                before do
                  allow(consumer_variable_set).to receive(:add_variable)
                                                    .with({
                                                            variable_name: &#39;/smurf_director_name/provider_deployment_name/string_placeholder&#39;,
                                                            variable_id: &#39;5&#39;,
                                                            is_local: false,
                                                            provider_deployment: provider_deployment_name
                                                          })
                                                    .and_raise(Sequel::UniqueConstraintViolation.new)
                  allow(consumer_variable_set).to receive(:id).and_return(&#39;my_id&#39;)
                end

                it &#39;should catch the exception, log a debug message, and interpolates as correctly&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set does not have all the variables)::context(when consumer variable set is writable)::context(when the provider variable set has the variable)::context(when the consumer variable_set throws unique constraint violation while copying variable to it (concurrency possibility))::it#should catch the exception, log a debug message, and interpolates as correctly has a flog score of 43</span>          </div>  </li></ol>
                  expect(logger).to receive(:debug).with(&quot;Variable &#39;/smurf_director_name/provider_deployment_name/string_placeholder&#39; was already added to consumer variable set &#39;my_id&#39;&quot;)
                  expect {
                    actual_interpolated_link_spec = client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
                    expect(actual_interpolated_link_spec).to eq(interpolated_links_properties_spec)
                  }.to_not raise_error
                end
              end
            end

            context &#39;when the provider variable set does NOT have the variable&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set does not have all the variables)::context(when consumer variable set is writable)::context#when the provider variable set does NOT have the variable has a flog score of 39</span>          </div>  </li></ol>
              before do
                mock_config_store.each do |name, value|
                  allow(consumer_variable_set).to receive(:find_provided_variable_by_name).with(name, provider_deployment_name).and_return(nil)
                  allow(provider_variable_set).to receive(:find_variable_by_name).with(name).and_return(nil)
                end
              end

              it &#39;should raise an exception&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1209" class="js-smell-location">0</a>                  <a href="client_spec.html#L1240" class="js-smell-location">1</a>                  <a href="client_spec.html#L1319" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L117" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#interpolate_cross_deployment_link)::context(when links spec passed is a hash)::context(when the consumer variable_set does not have all the variables)::context(when consumer variable set is writable)::context(when the provider variable set does NOT have the variable)::it#should raise an exception has a flog score of 32</span>          </div>  </li></ol>
                expected_error_msg = &lt;&lt;-EXPECTED.strip
- Expected variable &#39;/smurf_director_name/provider_deployment_name/integer_placeholder&#39; to be already versioned in link provider deployment &#39;provider_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/cert_placeholder&#39; to be already versioned in link provider deployment &#39;provider_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/hash_placeholder&#39; to be already versioned in link provider deployment &#39;provider_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/nil_placeholder&#39; to be already versioned in link provider deployment &#39;provider_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/empty_placeholder&#39; to be already versioned in link provider deployment &#39;provider_deployment_name&#39;
- Expected variable &#39;/smurf_director_name/provider_deployment_name/string_placeholder&#39; to be already versioned in link provider deployment &#39;provider_deployment_name&#39;
- Expected variable &#39;/absolute_placeholder&#39; to be already versioned in link provider deployment &#39;provider_deployment_name&#39;
                EXPECTED

                expect {
                  client.interpolate_cross_deployment_link(links_properties_spec, consumer_variable_set, provider_variable_set)
                }.to raise_error { |e|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'e'</span>              <span>Locations:</span>                  <a href="client_spec.html#L697" class="js-smell-location">0</a>                  <a href="client_spec.html#L723" class="js-smell-location">1</a>                  <a href="client_spec.html#L1222" class="js-smell-location">2</a>                  <a href="client_spec.html#L1253" class="js-smell-location">3</a>                  <a href="client_spec.html#L1332" class="js-smell-location">4</a>                  </div>  </li></ol>
                  expect(e.message).to eq(expected_error_msg)
                }
              end
            end
          end
        end
      end
    end

    describe &#39;#generate_values&#39; do
      context &#39;when given a variables object&#39; do
        context &#39;when some variable names syntax are NOT correct&#39; do
          let(:variable_specs_list) do
            [
              [{&#39;name&#39; =&gt; &#39;p*laceholder_a&#39;, &#39;type&#39; =&gt; &#39;password&#39;}],
              [{&#39;name&#39; =&gt; &#39;placeholder_a/&#39;, &#39;type&#39; =&gt; &#39;password&#39;}],
              [{&#39;name&#39; =&gt; &#39;&#39;, &#39;type&#39; =&gt; &#39;password&#39;}],
              [{&#39;name&#39; =&gt; &#39; &#39;, &#39;type&#39; =&gt; &#39;password&#39;}],
              [{&#39;name&#39; =&gt; &#39;((vroom))&#39;, &#39;type&#39; =&gt; &#39;password&#39;}],
            ]
          end

          it &#39;should throw an error and log it&#39; do
            variable_specs_list.each do |variables_spec|
              expect {
                client.generate_values(Bosh::Director::DeploymentPlan::Variables.new(variables_spec), deployment_name)
              }.to raise_error Bosh::Director::ConfigServerIncorrectNameSyntax
            end
          end
        end

        context &#39;when ALL variable names syntax are correct&#39; do
          let(:variables_spec) do
            [
              {&#39;name&#39; =&gt; &#39;placeholder_a&#39;, &#39;type&#39; =&gt; &#39;password&#39;},
              {&#39;name&#39; =&gt; &#39;placeholder_b&#39;, &#39;type&#39; =&gt; &#39;certificate&#39;, &#39;options&#39; =&gt; {&#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; [&#39;a.bosh.io&#39;, &#39;b.bosh.io&#39;]}},
              {&#39;name&#39; =&gt; &#39;/placeholder_c&#39;, &#39;type&#39; =&gt; &#39;gold&#39;, &#39;options&#39; =&gt; {&#39;need&#39; =&gt; &#39;luck&#39;}}
            ]
          end

          let(:variables_obj) do
            Bosh::Director::DeploymentPlan::Variables.new(variables_spec)
          end

          it &#39;should generate all the variables in order&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::it#should generate all the variables in order has a flog score of 67</span>          </div>  </li></ol>
            expect(http_client).to receive(:post).with(
              {
                &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_a&#39;),
                &#39;type&#39; =&gt; &#39;password&#39;,
                &#39;parameters&#39; =&gt; {}
              }
            ).ordered.and_return(
              generate_success_response(
                {
                  &quot;id&quot;: &quot;some_id1&quot;,
                }.to_json)
            )

            expect(http_client).to receive(:post).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1391" class="js-smell-location">0</a>                  <a href="client_spec.html#L1456" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                &#39;type&#39; =&gt; &#39;certificate&#39;,
                &#39;parameters&#39; =&gt; {&#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; %w(a.bosh.io b.bosh.io)}
              }
            ).ordered.and_return(
              generate_success_response(
                {
                  &quot;id&quot;: &quot;some_id2&quot;,
                }.to_json)
            )

            expect(http_client).to receive(:post).with(
              {
                &#39;name&#39; =&gt; &#39;/placeholder_c&#39;,
                &#39;type&#39; =&gt; &#39;gold&#39;,
                &#39;parameters&#39; =&gt; {&#39;need&#39; =&gt; &#39;luck&#39;}
              }
            ).ordered.and_return(
              generate_success_response(
                {
                  &quot;id&quot;: &quot;some_id3&quot;,
                }.to_json)
            )

            client.generate_values(variables_obj, deployment_name)
          end

          it &#39;should save generated variables to variable table with correct associations&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::it#should save generated variables to variable table with correct associations has a flog score of 96</span>          </div>  </li></ol>
            allow(http_client).to receive(:post).and_return(
              generate_success_response({&#39;id&#39;: &#39;some_id1&#39;}.to_json),
              generate_success_response({&#39;id&#39;: &#39;some_id2&#39;}.to_json),
              generate_success_response({&#39;id&#39;: &#39;some_id3&#39;}.to_json),
            )

            expect(Bosh::Director::Models::Variable[variable_id: &#39;some_id1&#39;, variable_name: prepend_namespace(&#39;placeholder_a&#39;), variable_set_id: variables_set_id]).to be_nil<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1427" class="js-smell-location">0</a>                  <a href="client_spec.html#L1428" class="js-smell-location">1</a>                  <a href="client_spec.html#L1433" class="js-smell-location">2</a>                  <a href="client_spec.html#L1434" class="js-smell-location">3</a>                  </div>  </li></ol>
            expect(Bosh::Director::Models::Variable[variable_id: &#39;some_id2&#39;, variable_name: prepend_namespace(&#39;placeholder_b&#39;), variable_set_id: variables_set_id]).to be_nil<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1427" class="js-smell-location">0</a>                  <a href="client_spec.html#L1428" class="js-smell-location">1</a>                  <a href="client_spec.html#L1433" class="js-smell-location">2</a>                  <a href="client_spec.html#L1434" class="js-smell-location">3</a>                  </div>  </li></ol>
            expect(Bosh::Director::Models::Variable[variable_id: &#39;some_id3&#39;, variable_name: &#39;/placeholder_c&#39;, variable_set_id: variables_set_id]).to be_nil

            client.generate_values(variables_obj, deployment_name)

            expect(Bosh::Director::Models::Variable[variable_id: &#39;some_id1&#39;, variable_name: prepend_namespace(&#39;placeholder_a&#39;), variable_set_id: variables_set_id]).to_not be_nil<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1427" class="js-smell-location">0</a>                  <a href="client_spec.html#L1428" class="js-smell-location">1</a>                  <a href="client_spec.html#L1433" class="js-smell-location">2</a>                  <a href="client_spec.html#L1434" class="js-smell-location">3</a>                  </div>  </li></ol>
            expect(Bosh::Director::Models::Variable[variable_id: &#39;some_id2&#39;, variable_name: prepend_namespace(&#39;placeholder_b&#39;), variable_set_id: variables_set_id]).to_not be_nil<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1427" class="js-smell-location">0</a>                  <a href="client_spec.html#L1428" class="js-smell-location">1</a>                  <a href="client_spec.html#L1433" class="js-smell-location">2</a>                  <a href="client_spec.html#L1434" class="js-smell-location">3</a>                  </div>  </li></ol>
            expect(Bosh::Director::Models::Variable[variable_id: &#39;some_id3&#39;, variable_name: &#39;/placeholder_c&#39;, variable_set_id: variables_set_id]).to_not be_nil
          end

          it &#39;should record events&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::it#should record events has a flog score of 275</span>          </div>  </li></ol>
            success_response_1 = SampleSuccessResponse.new<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'success_response_1'</span>          </div>  </li></ol>
            success_response_1.body = {&#39;id&#39;=&gt;1, &#39;name&#39;=&gt;&#39;/smurf_director_name/deployment_name/placeholder_a&#39;, &#39;value&#39;=&gt;&#39;abc&#39;}.to_json

            success_response_2 = SampleSuccessResponse.new<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'success_response_2'</span>          </div>  </li></ol>
            success_response_2.body = {&#39;id&#39;=&gt;2, &#39;name&#39;=&gt;&#39;/smurf_director_name/deployment_name/placeholder_b&#39;, &#39;value&#39;=&gt;&#39;my_cert_value&#39;}.to_json

            success_response_3 = SampleSuccessResponse.new<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'success_response_3'</span>          </div>  </li></ol>
            success_response_3.body = {&#39;id&#39;=&gt;3, &#39;name&#39;=&gt;&#39;/placeholder_c&#39;, &#39;value&#39;=&gt;&#39;value_3&#39;}.to_json

            expect(http_client).to receive(:post).with(
              {
                &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_a&#39;),
                &#39;type&#39; =&gt; &#39;password&#39;,
                &#39;parameters&#39; =&gt; {}
              }
            ).ordered.and_return(success_response_1)

            expect(http_client).to receive(:post).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1391" class="js-smell-location">0</a>                  <a href="client_spec.html#L1456" class="js-smell-location">1</a>                  </div>  </li></ol>
              {
                &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                &#39;type&#39; =&gt; &#39;certificate&#39;,
                &#39;parameters&#39; =&gt; {&#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; %w(a.bosh.io b.bosh.io)}
              }
            ).ordered.and_return(success_response_2)

            expect(http_client).to receive(:post).with(
              {
                &#39;name&#39; =&gt; &#39;/placeholder_c&#39;,
                &#39;type&#39; =&gt; &#39;gold&#39;,
                &#39;parameters&#39; =&gt; { &#39;need&#39; =&gt; &#39;luck&#39; }
              }
            ).ordered.and_return(success_response_3)

            expect {
              client.generate_values(variables_obj, deployment_name)
            }.to change { Bosh::Director::Models::Event.count }.from(0).to(3)

            event_1 = Bosh::Director::Models::Event.first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'event_1'</span>          </div>  </li></ol>
            expect(event_1.user).to eq(&#39;user&#39;)
            expect(event_1.action).to eq(&#39;create&#39;)
            expect(event_1.object_type).to eq(&#39;variable&#39;)
            expect(event_1.object_name).to eq(&#39;/smurf_director_name/deployment_name/placeholder_a&#39;)
            expect(event_1.task).to eq(&quot;#{task_id}&quot;)
            expect(event_1.deployment).to eq(deployment_name)
            expect(event_1.instance).to eq(nil)
            expect(event_1.context).to eq({&#39;id&#39;=&gt;1,&#39;name&#39;=&gt;&#39;/smurf_director_name/deployment_name/placeholder_a&#39;})

            event_2 = Bosh::Director::Models::Event.order(:id)[2]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'event_2'</span>          </div>  </li></ol>
            expect(event_2.user).to eq(&#39;user&#39;)
            expect(event_2.action).to eq(&#39;create&#39;)
            expect(event_2.object_type).to eq(&#39;variable&#39;)
            expect(event_2.object_name).to eq(&#39;/smurf_director_name/deployment_name/placeholder_b&#39;)
            expect(event_2.task).to eq(&quot;#{task_id}&quot;)
            expect(event_2.deployment).to eq(deployment_name)
            expect(event_2.instance).to eq(nil)
            expect(event_2.context).to eq({&#39;id&#39;=&gt;2,&#39;name&#39;=&gt;&#39;/smurf_director_name/deployment_name/placeholder_b&#39;})

            event_3 = Bosh::Director::Models::Event.order(:id)[3]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer has the variable name 'event_3'</span>          </div>  </li></ol>
            expect(event_3.user).to eq(&#39;user&#39;)
            expect(event_3.action).to eq(&#39;create&#39;)
            expect(event_3.object_type).to eq(&#39;variable&#39;)
            expect(event_3.object_name).to eq(&#39;/placeholder_c&#39;)
            expect(event_3.task).to eq(&quot;#{task_id}&quot;)
            expect(event_3.deployment).to eq(deployment_name)
            expect(event_3.instance).to eq(nil)
            expect(event_3.context).to eq({&#39;id&#39;=&gt;3,&#39;name&#39;=&gt;&#39;/placeholder_c&#39;})
          end

          context &#39;when variable options contains a CA key&#39; do
            context &#39;when variable type is certificate&#39; do
              context &#39;and it consumes `alternative_names` link&#39; do
                let(:variables_spec) do
                  [
                    {
                      &#39;name&#39; =&gt; &#39;placeholder_b&#39;,
                      &#39;type&#39; =&gt; &#39;certificate&#39;,
                      &#39;consumes&#39; =&gt; {
                        &#39;alternative_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; },
                      },
                      &#39;options&#39; =&gt; {
                        &#39;ca&#39; =&gt; &#39;my_ca&#39;,
                        &#39;common_name&#39; =&gt; &#39;bosh.io&#39;,
                        &#39;alternative_names&#39; =&gt; [&#39;a.bosh.io&#39;, &#39;b.bosh.io&#39;],
                      },
                    },
                  ]
                end

                let(:deployment_attrs) do
                  { id: 1, name: deployment_name, links_serial_id: link_serial_id }
                end

                let(:link_serial_id) { 8080 }

                let(:consumer) do
                  Bosh::Director::Models::Links::LinkConsumer.create(
                    deployment: deployment_model,
                    instance_group: &#39;&#39;,
                    type: &#39;variable&#39;,
                    name: &#39;placeholder_b&#39;,
                    serial_id: link_serial_id,
                  )
                end

                let(:consumer_intent) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1543" class="js-smell-location">0</a>                  <a href="client_spec.html#L1555" class="js-smell-location">1</a>                  </div>  </li></ol>
                  Bosh::Director::Models::Links::LinkConsumerIntent.create(
                    link_consumer: consumer,
                    original_name: &#39;alternative_name&#39;,
                    type: &#39;address&#39;,
                    name: &#39;foo&#39;,
                    optional: false,
                    blocked: false,
                    serial_id: link_serial_id,
                  )
                end

                let(:consumer_intent2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1543" class="js-smell-location">0</a>                  <a href="client_spec.html#L1555" class="js-smell-location">1</a>                  </div>  </li></ol>
                  Bosh::Director::Models::Links::LinkConsumerIntent.create(
                    link_consumer: consumer,
                    original_name: &#39;common_name&#39;,
                    type: &#39;address&#39;,
                    name: &#39;foo&#39;,
                    optional: false,
                    blocked: false,
                    serial_id: link_serial_id,
                  )
                end

                before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1567" class="js-smell-location">0</a>                  <a href="client_spec.html#L1658" class="js-smell-location">1</a>                  <a href="client_spec.html#L1756" class="js-smell-location">2</a>                  </div>  </li></ol>
                  Bosh::Director::Models::Links::Link.create(
                    name: &#39;foo&#39;,
                    link_provider_intent_id: nil,
                    link_consumer_intent_id: consumer_intent.id,
                    link_content: {
                      deployment_name: deployment_name,
                      use_short_dns_addresses: false,
                      instance_group: &#39;ig1&#39;,
                      default_network: &#39;net-a&#39;,
                      domain: &#39;bosh&#39;,
                    }.to_json,
                    created_at: Time.now,
                  )
                end

                it &#39;should generate the certificate with the SAN appended&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is certificate)::context(and it consumes `alternative_names` link)::it#should generate the certificate with the SAN appended has a flog score of 35</span>          </div>  </li></ol>
                  expect(http_client).to receive(:post).with(
                    {
                      &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                      &#39;type&#39; =&gt; &#39;certificate&#39;,
                      &#39;parameters&#39; =&gt; { &#39;ca&#39; =&gt; prepend_namespace(&#39;my_ca&#39;), &#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; %w(a.bosh.io b.bosh.io q-s0.ig1.net-a.deployment-name.bosh) },
                    }
                  ).ordered.and_return(
                    generate_success_response(
                      {
                        &quot;id&quot;: &quot;some_id2&quot;,
                      }.to_json))

                  client.generate_values(variables_obj, deployment_name)
                end

                context &#39;when wildcard flag is specified in properties&#39; do
                  let(:variables_spec) do
                    [
                      {
                        &#39;name&#39; =&gt; &#39;placeholder_b&#39;,
                        &#39;type&#39; =&gt; &#39;certificate&#39;,
                        &#39;consumes&#39; =&gt; {
                          &#39;alternative_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39;, &#39;properties&#39; =&gt; { &#39;wildcard&#39; =&gt; true } },
                        },
                        &#39;options&#39; =&gt; {
                          &#39;ca&#39; =&gt; &#39;my_ca&#39;,
                          &#39;common_name&#39; =&gt; &#39;bosh.io&#39;,
                          &#39;alternative_names&#39; =&gt; [&#39;a.bosh.io&#39;, &#39;b.bosh.io&#39;],
                        },
                      },
                    ]
                  end

                  it &#39;should generate the certificate with the SAN appended&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1617" class="js-smell-location">0</a>                  <a href="client_spec.html#L1714" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is certificate)::context(and it consumes `alternative_names` link)::context(when wildcard flag is specified in properties)::it#should generate the certificate with the SAN appended has a flog score of 42</span>          </div>  </li></ol>
                    consumer_intent.metadata = &#39;{&quot;wildcard&quot;: true}&#39;
                    consumer_intent.save

                    expect(http_client).to receive(:post).with(
                      &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                      &#39;type&#39; =&gt; &#39;certificate&#39;,
                      &#39;parameters&#39; =&gt; {
                        &#39;ca&#39; =&gt; prepend_namespace(&#39;my_ca&#39;),
                        &#39;common_name&#39; =&gt; &#39;bosh.io&#39;,
                        &#39;alternative_names&#39; =&gt; %w[a.bosh.io b.bosh.io *.ig1.net-a.deployment-name.bosh],
                      },
                    ).ordered.and_return(
                      generate_success_response(
                        {
                          &#39;id&#39;: &#39;some_id2&#39;,
                        }.to_json,
                      ),
                    )

                    client.generate_values(variables_obj, deployment_name)
                  end
                end

                context &#39;when common name and SAN is specified&#39; do
                  let(:variables_spec) do
                    [
                      {
                        &#39;name&#39; =&gt; &#39;placeholder_b&#39;,
                        &#39;type&#39; =&gt; &#39;certificate&#39;,
                        &#39;consumes&#39; =&gt; {
                          &#39;alternative_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39;, &#39;properties&#39; =&gt; { &#39;wildcard&#39; =&gt; true } },
                          &#39;common_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; },
                        },
                        &#39;options&#39; =&gt; {
                          &#39;ca&#39; =&gt; &#39;my_ca&#39;,
                        },
                      },
                    ]
                  end

                  before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1567" class="js-smell-location">0</a>                  <a href="client_spec.html#L1658" class="js-smell-location">1</a>                  <a href="client_spec.html#L1756" class="js-smell-location">2</a>                  </div>  </li></ol>
                    Bosh::Director::Models::Links::Link.create(
                      name: &#39;foo&#39;,
                      link_provider_intent_id: nil,
                      link_consumer_intent_id: consumer_intent2.id,
                      link_content: {
                        deployment_name: deployment_name,
                        use_short_dns_addresses: false,
                        instance_group: &#39;ig1&#39;,
                        default_network: &#39;net-a&#39;,
                        domain: &#39;bosh&#39;,
                      }.to_json,
                      created_at: Time.now,
                    )
                  end

                  it &#39;should generate the certificate with the common name and SAN&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1674" class="js-smell-location">0</a>                  <a href="client_spec.html#L1772" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is certificate)::context(and it consumes `alternative_names` link)::context(when common name and SAN is specified)::it#should generate the certificate with the common name and SAN has a flog score of 42</span>          </div>  </li></ol>
                    consumer_intent.metadata = &#39;{&quot;wildcard&quot;: true}&#39;
                    consumer_intent.save

                    expect(http_client).to receive(:post).with(
                      &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                      &#39;type&#39; =&gt; &#39;certificate&#39;,
                      &#39;parameters&#39; =&gt; {
                        &#39;ca&#39; =&gt; prepend_namespace(&#39;my_ca&#39;),
                        &#39;common_name&#39; =&gt; &#39;q-s0.ig1.net-a.deployment-name.bosh&#39;,
                        &#39;alternative_names&#39; =&gt; %w[*.ig1.net-a.deployment-name.bosh],
                      },
                    ).ordered.and_return(
                      generate_success_response(
                        {
                          &#39;id&#39;: &#39;some_id2&#39;,
                        }.to_json,
                      ),
                    )
                    client.generate_values(variables_obj, deployment_name)
                  end

                  context &#39;when wildcard flag is specified in properties&#39; do
                    let(:variables_spec) do
                      [
                        {
                          &#39;name&#39; =&gt; &#39;placeholder_b&#39;,
                          &#39;type&#39; =&gt; &#39;certificate&#39;,
                          &#39;consumes&#39; =&gt; {
                            &#39;common_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39;, &#39;properties&#39; =&gt; { &#39;wildcard&#39; =&gt; true } },
                            &#39;alternative_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; },
                          },
                          &#39;options&#39; =&gt; {
                            &#39;ca&#39; =&gt; &#39;my_ca&#39;,
                            &#39;alternative_names&#39; =&gt; [&#39;a.bosh.io&#39;, &#39;b.bosh.io&#39;],
                          },
                        },
                      ]
                    end

                    it &#39;should generate the certificate with the SAN appended&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1617" class="js-smell-location">0</a>                  <a href="client_spec.html#L1714" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is certificate)::context(and it consumes `alternative_names` link)::context(when common name and SAN is specified)::context(when wildcard flag is specified in properties)::it#should generate the certificate with the SAN appended has a flog score of 44</span>          </div>  </li></ol>
                      consumer_intent2.metadata = &#39;{&quot;wildcard&quot;: true}&#39;
                      consumer_intent2.save

                      expect(http_client).to receive(:post).with(
                        &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                        &#39;type&#39; =&gt; &#39;certificate&#39;,
                        &#39;parameters&#39; =&gt; {
                          &#39;ca&#39; =&gt; prepend_namespace(&#39;my_ca&#39;),
                          &#39;common_name&#39; =&gt; &#39;*.ig1.net-a.deployment-name.bosh&#39;,
                          &#39;alternative_names&#39; =&gt; %w[a.bosh.io b.bosh.io q-s0.ig1.net-a.deployment-name.bosh],
                        },
                      ).ordered.and_return(
                        generate_success_response(
                          {
                            &#39;id&#39;: &#39;some_id2&#39;,
                          }.to_json,
                        ),
                      )

                      client.generate_values(variables_obj, deployment_name)
                    end
                  end

                  context &#39;when common name is also specified in options&#39; do
                    let(:variables_spec) do
                      [
                        {
                          &#39;name&#39; =&gt; &#39;placeholder_b&#39;,
                          &#39;type&#39; =&gt; &#39;certificate&#39;,
                          &#39;consumes&#39; =&gt; {
                            &#39;alternative_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39;, &#39;properties&#39; =&gt; { &#39;wildcard&#39; =&gt; true } },
                            &#39;common_name&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; },
                          },
                          &#39;options&#39; =&gt; {
                            &#39;ca&#39; =&gt; &#39;my_ca&#39;,
                            &#39;common_name&#39; =&gt; &#39;bosh.io&#39;,
                          },
                        },
                      ]
                    end

                    before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1567" class="js-smell-location">0</a>                  <a href="client_spec.html#L1658" class="js-smell-location">1</a>                  <a href="client_spec.html#L1756" class="js-smell-location">2</a>                  </div>  </li></ol>
                      Bosh::Director::Models::Links::Link.create(
                        name: &#39;foo&#39;,
                        link_provider_intent_id: nil,
                        link_consumer_intent_id: consumer_intent2.id,
                        link_content: {
                          deployment_name: deployment_name,
                          use_short_dns_addresses: false,
                          instance_group: &#39;ig1&#39;,
                          default_network: &#39;net-a&#39;,
                          domain: &#39;bosh&#39;,
                        }.to_json,
                        created_at: Time.now,
                      )
                    end

                    it &#39;should generate the certificate with options version of the common name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1674" class="js-smell-location">0</a>                  <a href="client_spec.html#L1772" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is certificate)::context(and it consumes `alternative_names` link)::context(when common name and SAN is specified)::context(when common name is also specified in options)::it#should generate the certificate with options version of the common name has a flog score of 44</span>          </div>  </li></ol>
                      consumer_intent.metadata = &#39;{&quot;wildcard&quot;: true}&#39;
                      consumer_intent.save

                      expect(http_client).to receive(:post).with(
                        &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                        &#39;type&#39; =&gt; &#39;certificate&#39;,
                        &#39;parameters&#39; =&gt; {
                          &#39;ca&#39; =&gt; prepend_namespace(&#39;my_ca&#39;),
                          &#39;common_name&#39; =&gt; &#39;bosh.io&#39;,
                          &#39;alternative_names&#39; =&gt; %w[*.ig1.net-a.deployment-name.bosh],
                        },
                      ).ordered.and_return(
                        generate_success_response(
                          {
                            &#39;id&#39;: &#39;some_id2&#39;,
                          }.to_json,
                        ),
                      )

                      client.generate_values(variables_obj, deployment_name)
                    end
                  end
                end
              end
            end

            context &#39;when variable type is certificate &amp; ca is relative&#39; do
              let(:variables_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1800" class="js-smell-location">0</a>                  <a href="client_spec.html#L1835" class="js-smell-location">1</a>                  <a href="client_spec.html#L1970" class="js-smell-location">2</a>                  </div>  </li></ol>
                [
                    {&#39;name&#39; =&gt; &#39;placeholder_b&#39;, &#39;type&#39; =&gt; &#39;certificate&#39;, &#39;options&#39; =&gt; {&#39;ca&#39; =&gt; &#39;my_ca&#39;, &#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; [&#39;a.bosh.io&#39;, &#39;b.bosh.io&#39;]}},
                ]
              end

              let(:variables_obj) do
                Bosh::Director::DeploymentPlan::Variables.new(variables_spec)
              end

              it &#39;namespaces the ca reference for a variable with type certificate&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is certificate & ca is relative)::it#namespaces the ca reference for a variable with type certificate has a flog score of 35</span>          </div>  </li></ol>
                expect(http_client).to receive(:post).with(
                    {
                        &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                        &#39;type&#39; =&gt; &#39;certificate&#39;,
                        &#39;parameters&#39; =&gt; {
                          &#39;ca&#39; =&gt; prepend_namespace(&#39;my_ca&#39;),
                          &#39;common_name&#39; =&gt; &#39;bosh.io&#39;,
                          &#39;alternative_names&#39; =&gt; %w[a.bosh.io b.bosh.io],
                        },
                    }
                ).ordered.and_return(
                  generate_success_response(
                    {
                      &#39;id&#39;: &#39;some_id2&#39;,
                    }.to_json,
                  ),
                )

                client.generate_values(variables_obj, deployment_name)
              end

            end

            context &#39;when variable type is certificate &amp; ca is absolute&#39; do
              let(:variables_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1800" class="js-smell-location">0</a>                  <a href="client_spec.html#L1835" class="js-smell-location">1</a>                  <a href="client_spec.html#L1970" class="js-smell-location">2</a>                  </div>  </li></ol>
                [
                    {&#39;name&#39; =&gt; &#39;placeholder_b&#39;, &#39;type&#39; =&gt; &#39;certificate&#39;, &#39;options&#39; =&gt; {&#39;ca&#39; =&gt; &#39;/my_ca&#39;, &#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; [&#39;a.bosh.io&#39;, &#39;b.bosh.io&#39;]}},
                ]
              end

              let(:variables_obj) do
                Bosh::Director::DeploymentPlan::Variables.new(variables_spec)
              end

              it &#39;namespaces the ca reference for a variable with type certificate&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is certificate & ca is absolute)::it#namespaces the ca reference for a variable with type certificate has a flog score of 32</span>          </div>  </li></ol>
                expect(http_client).to receive(:post).with(
                    {
                        &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                        &#39;type&#39; =&gt; &#39;certificate&#39;,
                        &#39;parameters&#39; =&gt; {&#39;ca&#39; =&gt; (&#39;/my_ca&#39;), &#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; %w(a.bosh.io b.bosh.io)}
                    }
                ).ordered.and_return(
                    generate_success_response(
                        {
                            &quot;id&quot;: &quot;some_id2&quot;,
                        }.to_json))

                client.generate_values(variables_obj, deployment_name)
              end

            end

            context &#39;when variable type is NOT certificate&#39; do
              let(:variables_spec) do
                [
                    {&#39;name&#39; =&gt; &#39;placeholder_a&#39;, &#39;type&#39; =&gt; &#39;something-else&#39;,&#39;options&#39; =&gt; {&#39;ca&#39; =&gt; &#39;some_ca_value&#39;}},
                ]
              end

              let(:variables_obj) do
                Bosh::Director::DeploymentPlan::Variables.new(variables_spec)
              end

              it &#39;it passes options through to config server without modification&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when variable options contains a CA key)::context(when variable type is NOT certificate)::it#it passes options through to config server without modification has a flog score of 32</span>          </div>  </li></ol>
                expect(http_client).to receive(:post).with(
                    {
                        &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_a&#39;),
                        &#39;type&#39; =&gt; &#39;something-else&#39;,
                        &#39;parameters&#39; =&gt; {&#39;ca&#39; =&gt; &#39;some_ca_value&#39;}
                    }
                ).ordered.and_return(
                    generate_success_response(
                        {
                            &quot;id&quot;: &quot;some_id1&quot;,
                        }.to_json))

                client.generate_values(variables_obj, deployment_name)
              end
            end
          end

          context &#39;when config server throws an error while generating&#39; do
            before do
              allow(http_client).to receive(:post).with(
                {
                  &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_a&#39;),
                  &#39;type&#39; =&gt; &#39;password&#39;,
                  &#39;parameters&#39; =&gt; {}
                }
              ).ordered.and_return(SampleForbiddenResponse.new)
            end

            it &#39;should throw an error, log it, and record event&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when config server throws an error while generating)::it#should throw an error, log it, and record event has a flog score of 98</span>          </div>  </li></ol>
              expect(logger).to receive(:error)

              expect {
                client.generate_values(variables_obj, deployment_name)
              }.to raise_error(
                Bosh::Director::ConfigServerGenerationError,
                &quot;Config Server failed to generate value for &#39;/smurf_director_name/deployment_name/placeholder_a&#39; with type &#39;password&#39;. HTTP Code &#39;403&#39;, Error: &#39;There was a problem&#39;&quot;
              )

              expect(Bosh::Director::Models::Event.count).to eq(1)

              error_event = Bosh::Director::Models::Event.first
              expect(error_event.user).to eq(&#39;user&#39;)
              expect(error_event.action).to eq(&#39;create&#39;)
              expect(error_event.object_type).to eq(&#39;variable&#39;)
              expect(error_event.object_name).to eq(&#39;/smurf_director_name/deployment_name/placeholder_a&#39;)
              expect(error_event.task).to eq(&quot;#{task_id}&quot;)
              expect(error_event.deployment).to eq(deployment_name)
              expect(error_event.instance).to eq(nil)
              expect(error_event.error).to eq(&quot;Config Server failed to generate value for &#39;/smurf_director_name/deployment_name/placeholder_a&#39; with type &#39;password&#39;. HTTP Code &#39;403&#39;, Error: &#39;There was a problem&#39;&quot;)
            end
          end

          context &#39;when config server response is NOT in JSON format&#39; do
            before do
              response = SampleSuccessResponse.new
              response.body = &#39;NOT JSON!!!&#39;

              allow(http_client).to receive(:post).and_return(response)
            end

            it &#39;should throw an error and log it&#39; do
              expect(logger).to_not receive(:error)

              expect{
                client.generate_values(variables_obj, deployment_name)
              }.to raise_error(
                     Bosh::Director::ConfigServerGenerationError,
                     &quot;Config Server returned a NON-JSON body while generating value for &#39;/smurf_director_name/deployment_name/placeholder_a&#39; with type &#39;password&#39;&quot;
                   )
            end
          end

          context &#39;but variable set is not writable&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context#but variable set is not writable has a flog score of 48</span>          </div>  </li></ol>
            let(:deployment_lookup){ instance_double(Bosh::Director::Api::DeploymentLookup) }
            let(:variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

            before do
              allow(Bosh::Director::Api::DeploymentLookup).to receive(:new).and_return(deployment_lookup)
              allow(deployment_lookup).to receive(:by_name).and_return(deployment_model)
              allow(deployment_model).to receive(:current_variable_set).and_return(variable_set)
              allow(variable_set).to receive(:writable).and_return(false)
            end

            it &#39;should raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(but variable set is not writable)::it#should raise an error has a flog score of 35</span>          </div>  </li></ol>
              models = Bosh::Director::Models::Variable.all

              expect(models.length).to eq(0)
              expect{
                client.generate_values(variables_obj, deployment_name)
              }.to raise_error(Bosh::Director::ConfigServerGenerationError, &quot;Variable &#39;#{prepend_namespace(&#39;placeholder_a&#39;)}&#39; cannot be generated. Variable generation allowed only during deploy action&quot;)
              expect(models.length).to eq(0)
            end
          end

          context &#39;when converge_variables is true&#39; do
            let(:variables_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1800" class="js-smell-location">0</a>                  <a href="client_spec.html#L1835" class="js-smell-location">1</a>                  <a href="client_spec.html#L1970" class="js-smell-location">2</a>                  </div>  </li></ol>
              [{&#39;name&#39; =&gt; &#39;placeholder_b&#39;, &#39;type&#39; =&gt; &#39;certificate&#39;, &#39;options&#39; =&gt; {&#39;ca&#39; =&gt; &#39;/my_ca&#39;, &#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; [&#39;a.bosh.io&#39;, &#39;b.bosh.io&#39;]}},]
            end

            it &#39;should set the mode to converge&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::describe(#generate_values)::context(when given a variables object)::context(when ALL variable names syntax are correct)::context(when converge_variables is true)::it#should set the mode to converge has a flog score of 30</span>          </div>  </li></ol>
              expect(http_client).to receive(:post).with(
                {
                  &#39;name&#39; =&gt; prepend_namespace(&#39;placeholder_b&#39;),
                  &#39;type&#39; =&gt; &#39;certificate&#39;,
                  &#39;parameters&#39; =&gt; {&#39;ca&#39; =&gt; (&#39;/my_ca&#39;), &#39;common_name&#39; =&gt; &#39;bosh.io&#39;, &#39;alternative_names&#39; =&gt; %w(a.bosh.io b.bosh.io)},
                  &#39;mode&#39; =&gt; &#39;converge&#39;
                }
              ).ordered.and_return(
                generate_success_response(
                  {
                    &quot;id&quot;: &quot;some_id2&quot;,
                  }.to_json))
              client.generate_values(variables_obj, deployment_name, true)
            end
          end
        end
      end
    end

    def generate_success_response(body)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer#generate_success_response doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      result = SampleSuccessResponse.new
      result.body = body
      result
    end
  end

  class SampleSuccessResponse &lt; Net::HTTPOK<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::SampleSuccessResponse has no descriptive comment</span>          </div>  </li></ol>
    attr_accessor :body<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::SampleSuccessResponse#body is a writable attribute</span>          </div>  </li></ol>

    def initialize
      super(nil, &#39;200&#39;, nil)
    end
  end

  class SampleNotFoundResponse &lt; Net::HTTPNotFound<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::SampleNotFoundResponse has no descriptive comment</span>          </div>  </li></ol>
    def initialize
      super(nil, &#39;404&#39;, &#39;&#39;)
    end

    def body
      &#39;{&quot;error&quot;: &quot;Name not found&quot;}&#39;
    end
  end

  class SampleForbiddenResponse &lt; Net::HTTPForbidden<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::ConfigServer::SampleForbiddenResponse has no descriptive comment</span>          </div>  </li></ol>
    def initialize
      super(nil, &#39;403&#39;, &#39;&#39;)
    end

    def body
      &#39;{&quot;error&quot;: &quot;There was a problem&quot;}&#39;
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
