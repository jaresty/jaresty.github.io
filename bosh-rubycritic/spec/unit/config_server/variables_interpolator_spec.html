<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/config_server /</small> variables_interpolator_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">666</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">20</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1132.68</span><small> complexity</small></div>
              <div><span class="metric">457</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                32
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

describe Bosh::Director::ConfigServer::VariablesInterpolator do
  subject(:variables_interpolator) { described_class.new }

  let(:client_factory) { double(Bosh::Director::ConfigServer::ClientFactory) }
  let(:config_server_client) { instance_double(Bosh::Director::ConfigServer::ConfigServerClient) }
  let(:deployment_name) {&#39;my_deployment_name&#39;}

  before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L10" class="js-smell-location">0</a>                  <a href="../disk/persistent_disk_comparators_spec.html#L8" class="js-smell-location">1</a>                  <a href="../disk_manager_spec.html#L578" class="js-smell-location">2</a>                  </div>  </li></ol>
    allow(Bosh::Director::ConfigServer::ClientFactory).to receive(:create).and_return(client_factory)
    allow(client_factory).to receive(:create_client).and_return(config_server_client)
  end

  describe &#39;#interpolate_template_spec_properties&#39; do
    let(:job_1_properties) do
      {
        &#39;prop_1&#39; =&gt; &#39;((smurf_1_placeholder))&#39;,
        &#39;prop_2&#39; =&gt; &#39;((smurf_2_placeholder))&#39;,
        &#39;prop_3&#39; =&gt; {
          &#39;prop_3_1&#39; =&gt; &#39;((smurf_3_1_placeholder))&#39;
        }
      }
    end

    let(:job_2_properties) do
      {
        &#39;prop_4&#39; =&gt; &#39;((smurf_4_placeholder))&#39;,
        &#39;prop_5&#39; =&gt; &#39;((smurf_5_placeholder))&#39;,
        &#39;prop_6&#39; =&gt; {
          &#39;prop_6_1&#39; =&gt; &#39;((smurf_6_1_placeholder))&#39;
        }
      }
    end

    let(:properties_spec)  do
      {
        &#39;job_1&#39; =&gt; job_1_properties,
        &#39;job_2&#39; =&gt; job_2_properties
      }
    end

    let(:interpolated_job_1_properties) do
      {
        &#39;prop_1&#39; =&gt; &#39;smurf_1_value&#39;,
        &#39;prop_2&#39; =&gt; &#39;smurf_2_value&#39;,
        &#39;prop_3&#39; =&gt; {
          &#39;prop_3_1&#39; =&gt; &#39;smurf_3_1_value&#39;
        }
      }
    end

    let(:interpolated_job_2_properties) do
      {
        &#39;prop_4&#39; =&gt; &#39;smurf_4_value&#39;,
        &#39;prop_5&#39; =&gt; &#39;smurf_5_value&#39;,
        &#39;prop_6&#39; =&gt; {
          &#39;prop_6_1&#39; =&gt; &#39;smurf_6_1_value&#39;
        }
      }
    end

    let(:interpolated_properties_spec)  do
      {
        &#39;job_1&#39; =&gt; interpolated_job_1_properties,
        &#39;job_2&#39; =&gt; interpolated_job_2_properties
      }
    end

    let(:given_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

    it &#39;interpolates the hash given to it&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_template_spec_properties)::it#interpolates the hash given to it has a flog score of 52</span>          </div>  </li></ol>
      expect(config_server_client).to receive(:interpolate_with_versioning).with(job_1_properties, given_variable_set).and_return(interpolated_job_1_properties)
      expect(config_server_client).to receive(:interpolate_with_versioning).with(job_2_properties, given_variable_set).and_return(interpolated_job_2_properties)

      expect(subject.interpolate_template_spec_properties(properties_spec, deployment_name, given_variable_set)).to eq(interpolated_properties_spec)
    end

    it &#39;interpolates using the variable set passed in&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_template_spec_properties)::it#interpolates using the variable set passed in has a flog score of 52</span>          </div>  </li></ol>
      deployment_model = Bosh::Director::Models::Deployment.make({ id: 1, name: deployment_name })
      variable_set = Bosh::Director::Models::VariableSet.make(id: 42, deployment: deployment_model)
      expect(config_server_client).to receive(:interpolate_with_versioning).with(job_1_properties, variable_set).and_return(interpolated_job_1_properties)
      expect(config_server_client).to receive(:interpolate_with_versioning).with(job_2_properties, variable_set).and_return(interpolated_job_2_properties)

      expect(subject.interpolate_template_spec_properties(properties_spec, deployment_name, variable_set)).to eq(interpolated_properties_spec)
    end

    context &#39;when src hash is nil&#39; do
      it &#39;returns the src as is&#39; do
        expect(subject.interpolate_template_spec_properties(nil, deployment_name, given_variable_set)).to eq(nil)
      end
    end

    context &#39;when deployment name is nil&#39; do
      it &#39;raises an error&#39; do
        expect{
          subject.interpolate_template_spec_properties(properties_spec, nil, given_variable_set)
        }.to raise_error(Bosh::Director::ConfigServerDeploymentNameMissing, &quot;Deployment name missing while interpolating jobs&#39; properties&quot;)
      end
    end

    context &#39;when config server returns errors while interpolating properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_template_spec_properties)::context#when config server returns errors while interpolating properties has a flog score of 36</span>          </div>  </li></ol>
      before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L103" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L425" class="js-smell-location">1</a>                  </div>  </li></ol>
        allow(config_server_client).to receive(:interpolate_with_versioning).with(job_1_properties, anything).and_raise Exception, &lt;&lt;-EOF
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_2_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_3_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
        EOF

        allow(config_server_client).to receive(:interpolate_with_versioning).with(job_2_properties, anything).and_raise Exception, &lt;&lt;-EOF
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_4_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_5_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_6_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
        EOF
      end

      it &#39;returns formatted error messages per job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="client_spec.html#L1209" class="js-smell-location">0</a>                  <a href="client_spec.html#L1240" class="js-smell-location">1</a>                  <a href="client_spec.html#L1319" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L117" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_template_spec_properties)::context(when config server returns errors while interpolating properties)::it#returns formatted error messages per job has a flog score of 27</span>          </div>  </li></ol>
        expected_error_msg = &lt;&lt;-EXPECTED.strip
- Unable to render templates for job &#39;job_1&#39;. Errors are:
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_2_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_3_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Unable to render templates for job &#39;job_2&#39;. Errors are:
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_4_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_5_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_6_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
        EXPECTED

        expect {
          subject.interpolate_template_spec_properties(properties_spec, deployment_name, anything)
        }.to raise_error { |error|
          expect(error.message).to eq(expected_error_msg)
        }
      end
    end
  end

  describe &#39;#interpolate_link_spec_properties&#39; do
    let(:link_1_properties) do
      {
        &#39;prop_1&#39; =&gt; &#39;((smurf_1_placeholder))&#39;,
        &#39;prop_2&#39; =&gt; &#39;((smurf_2_placeholder))&#39;,
        &#39;prop_3&#39; =&gt; {
          &#39;prop_3_1&#39; =&gt; &#39;((smurf_3_1_placeholder))&#39;
        }
      }
    end
    let(:link_2_properties) do
      {
        &#39;prop_5&#39; =&gt; &#39;smurf_5_value&#39;,
        &#39;prop_6&#39; =&gt; &#39;smurf_6_value&#39;,
        &#39;prop_7&#39; =&gt; {
          &#39;prop_7_1&#39; =&gt; &#39;smurf_7_1_value&#39;
        }
      }
    end

    let(:interpolated_link_1_properties) do
      {
        &#39;prop_1&#39; =&gt; &#39;smurf_1_value&#39;,
        &#39;prop_2&#39; =&gt; &#39;smurf_2_value&#39;,
        &#39;prop_3&#39; =&gt; {
          &#39;prop_3_1&#39; =&gt; &#39;smurf_3_1_value&#39;
        }
      }
    end
    let(:interpolated_link_2_properties) do
      {
        &#39;prop_5&#39; =&gt; &#39;smurf_5_value&#39;,
        &#39;prop_6&#39; =&gt; &#39;smurf_6_value&#39;,
        &#39;prop_7&#39; =&gt; {
          &#39;prop_7_1&#39; =&gt; &#39;smurf_7_1_value&#39;
        }
      }
    end

    let(:same_deployment_links_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L177" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L207" class="js-smell-location">1</a>                  <a href="variables_interpolator_spec.html#L238" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L268" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;link_1&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_1&#39;,
          &#39;networks&#39; =&gt; [&#39;a&#39;],
          &#39;properties&#39; =&gt; link_1_properties,
          &#39;instances&#39; =&gt; [{
            &#39;name&#39; =&gt; &#39;instance_group_1&#39;,
            &#39;index&#39; =&gt; 0,
            &#39;bootstrap&#39; =&gt; true,
            &#39;id&#39; =&gt; &#39;instance_id_1&#39;,
            &#39;az&#39; =&gt; &#39;z1&#39;,
            &#39;address&#39; =&gt; &#39;1.1.1.1&#39;
          }]
        },
        &#39;link_2&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_1&#39;,
          &#39;networks&#39; =&gt; [&#39;b&#39;],
          &#39;properties&#39; =&gt; link_2_properties,
          &#39;instances&#39; =&gt; [{
            &#39;name&#39; =&gt; &#39;instance_group_2&#39;,
            &#39;index&#39; =&gt; 0,
            &#39;bootstrap&#39; =&gt; true,
            &#39;id&#39; =&gt; &#39;instance_id_2&#39;,
            &#39;az&#39; =&gt; &#39;z1&#39;,
            &#39;address&#39; =&gt; &#39;2.2.2.2&#39;
          }]
        },
      }
    end
    let(:cross_deployment_links_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L177" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L207" class="js-smell-location">1</a>                  <a href="variables_interpolator_spec.html#L238" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L268" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;link_1&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_1&#39;,
          &#39;networks&#39; =&gt; [&#39;a&#39;],
          &#39;properties&#39; =&gt; link_1_properties,
          &#39;instances&#39; =&gt; [{
                            &#39;name&#39; =&gt; &#39;instance_group_1&#39;,
                            &#39;index&#39; =&gt; 0,
                            &#39;bootstrap&#39; =&gt; true,
                            &#39;id&#39; =&gt; &#39;instance_id_1&#39;,
                            &#39;az&#39; =&gt; &#39;z1&#39;,
                            &#39;address&#39; =&gt; &#39;1.1.1.1&#39;
                          }]
        },
        &#39;link_2&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_2&#39;,
          &#39;networks&#39; =&gt; [&#39;b&#39;],
          &#39;properties&#39; =&gt; link_2_properties,
          &#39;instances&#39; =&gt; [{
                            &#39;name&#39; =&gt; &#39;instance_group_2&#39;,
                            &#39;index&#39; =&gt; 0,
                            &#39;bootstrap&#39; =&gt; true,
                            &#39;id&#39; =&gt; &#39;instance_id_2&#39;,
                            &#39;az&#39; =&gt; &#39;z1&#39;,
                            &#39;address&#39; =&gt; &#39;2.2.2.2&#39;
                          }]
        },
      }
    end

    let(:interpolated_same_deployment_links_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L177" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L207" class="js-smell-location">1</a>                  <a href="variables_interpolator_spec.html#L238" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L268" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;link_1&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_1&#39;,
          &#39;networks&#39; =&gt; [&#39;a&#39;],
          &#39;properties&#39; =&gt; interpolated_link_1_properties,
          &#39;instances&#39; =&gt; [{
            &#39;name&#39; =&gt; &#39;instance_group_1&#39;,
            &#39;index&#39; =&gt; 0,
            &#39;bootstrap&#39; =&gt; true,
            &#39;id&#39; =&gt; &#39;instance_id_1&#39;,
            &#39;az&#39; =&gt; &#39;z1&#39;,
            &#39;address&#39; =&gt; &#39;1.1.1.1&#39;
          }]
        },
        &#39;link_2&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_1&#39;,
          &#39;networks&#39; =&gt; [&#39;b&#39;],
          &#39;properties&#39; =&gt; interpolated_link_2_properties,
          &#39;instances&#39; =&gt; [{
            &#39;name&#39; =&gt; &#39;instance_group_2&#39;,
            &#39;index&#39; =&gt; 0,
            &#39;bootstrap&#39; =&gt; true,
            &#39;id&#39; =&gt; &#39;instance_id_2&#39;,
            &#39;az&#39; =&gt; &#39;z1&#39;,
            &#39;address&#39; =&gt; &#39;2.2.2.2&#39;
          }]
        },
      }
    end
    let(:interpolated_cross_deployment_links_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L177" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L207" class="js-smell-location">1</a>                  <a href="variables_interpolator_spec.html#L238" class="js-smell-location">2</a>                  <a href="variables_interpolator_spec.html#L268" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;link_1&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_1&#39;,
          &#39;networks&#39; =&gt; [&#39;a&#39;],
          &#39;properties&#39; =&gt; interpolated_link_1_properties,
          &#39;instances&#39; =&gt; [{
                            &#39;name&#39; =&gt; &#39;instance_group_1&#39;,
                            &#39;index&#39; =&gt; 0,
                            &#39;bootstrap&#39; =&gt; true,
                            &#39;id&#39; =&gt; &#39;instance_id_1&#39;,
                            &#39;az&#39; =&gt; &#39;z1&#39;,
                            &#39;address&#39; =&gt; &#39;1.1.1.1&#39;
                          }]
        },
        &#39;link_2&#39; =&gt; {
          &#39;deployment_name&#39; =&gt; &#39;simple_2&#39;,
          &#39;networks&#39; =&gt; [&#39;b&#39;],
          &#39;properties&#39; =&gt; interpolated_link_2_properties,
          &#39;instances&#39; =&gt; [{
                            &#39;name&#39; =&gt; &#39;instance_group_2&#39;,
                            &#39;index&#39; =&gt; 0,
                            &#39;bootstrap&#39; =&gt; true,
                            &#39;id&#39; =&gt; &#39;instance_id_2&#39;,
                            &#39;az&#39; =&gt; &#39;z1&#39;,
                            &#39;address&#39; =&gt; &#39;2.2.2.2&#39;
                          }]
        },
      }
    end

    let(:consumer_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:consumer_deployment) { instance_double(Bosh::Director::Models::Deployment)}

    before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L302" class="js-smell-location">0</a>                  <a href="../deployment_plan/persistent_disk_collection_spec.html#L129" class="js-smell-location">1</a>                  <a href="../jobs/run_errand_spec.html#L431" class="js-smell-location">2</a>                  </div>  </li></ol>
      allow(consumer_variable_set).to receive(:deployment).and_return(consumer_deployment)
      allow(consumer_deployment).to receive(:name).and_return(&#39;simple_1&#39;)
    end
    context &#39;when links spec is nil&#39; do
      it &#39;returns the spec as is&#39; do
        expect(subject.interpolate_link_spec_properties(nil, consumer_variable_set)).to eq(nil)
      end
    end

    context &#39;when links spec is given&#39; do

      context &#39;when links spec is empty hash&#39; do
        it &#39;returns it as is&#39; do
          expect(subject.interpolate_link_spec_properties({}, consumer_variable_set)).to eq({})
        end
      end

      context &#39;when the properties of a link is missing&#39; do
        let(:input) do
          same_deployment_links_spec[&#39;link_1&#39;].delete(&#39;properties&#39;)
          same_deployment_links_spec
        end

        let(:result) do
          interpolated_same_deployment_links_spec[&#39;link_1&#39;].delete(&#39;properties&#39;)
          interpolated_same_deployment_links_spec
        end

        it &#39;does not add it&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L331" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L348" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is missing)::it#does not add it has a flog score of 37</span>          </div>  </li></ol>
          expect(config_server_client).to receive(:interpolate_with_versioning).with(link_2_properties, consumer_variable_set).and_return(interpolated_link_2_properties)
          expect(subject.interpolate_link_spec_properties(input, consumer_variable_set)).to eq(result)
        end
      end

      context &#39;when the properties of a link is nil&#39; do
        let(:input) do
          same_deployment_links_spec[&#39;link_1&#39;][&#39;properties&#39;] = nil
          same_deployment_links_spec
        end

        let(:result) do
          interpolated_same_deployment_links_spec[&#39;link_1&#39;][&#39;properties&#39;] = nil
          interpolated_same_deployment_links_spec
        end

        it &#39;keeps it as nil&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L331" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L348" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is nil)::it#keeps it as nil has a flog score of 37</span>          </div>  </li></ol>
          expect(config_server_client).to receive(:interpolate_with_versioning).with(link_2_properties, consumer_variable_set).and_return(interpolated_link_2_properties)
          expect(subject.interpolate_link_spec_properties(input, consumer_variable_set)).to eq(result)
        end
      end

      context &#39;when the properties of a link is present&#39; do
        context &#39;when all the links are provided by the SAME deployment&#39; do
          it &#39;interpolates the hash given to it by calling config_server_client.interpolate method&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is present)::context(when all the links are provided by the SAME deployment)::it#interpolates the hash given to it by calling config_server_client.interpolate method has a flog score of 62</span>          </div>  </li></ol>
            expect(config_server_client).to receive(:interpolate_with_versioning).with(link_1_properties, consumer_variable_set).and_return(interpolated_link_1_properties)
            expect(config_server_client).to receive(:interpolate_with_versioning).with(link_2_properties, consumer_variable_set).and_return(interpolated_link_2_properties)
            result = subject.interpolate_link_spec_properties(same_deployment_links_spec, consumer_variable_set)
            expect(result).to eq(interpolated_same_deployment_links_spec)
            expect(result).to_not equal(interpolated_same_deployment_links_spec)
          end
        end

        context &#39;when there are links provided by a DIFFERENT deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is present)::context#when there are links provided by a DIFFERENT deployment has a flog score of 50</span>          </div>  </li></ol>
          let(:provider_deployment) { instance_double(Bosh::Director::Models::Deployment)}
          let(:provider_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

          before do
            allow(Bosh::Director::Models::Deployment).to receive(:[]).with(name: &#39;simple_2&#39;).and_return(provider_deployment)
            allow(provider_deployment).to receive(:last_successful_variable_set).and_return(provider_variable_set)
            allow(config_server_client).to receive(:interpolate_with_versioning).with(link_1_properties, consumer_variable_set).and_return(interpolated_link_1_properties)
          end

          it &#39;interpolates the cross deployment link properties by calling config_server_client.interpolate_cross_deployment_link method&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is present)::context(when there are links provided by a DIFFERENT deployment)::it#interpolates the cross deployment link properties by calling config_server_client.interpolate_cross_deployment_link method has a flog score of 48</span>          </div>  </li></ol>
            expect(config_server_client).to receive(:interpolate_cross_deployment_link).with(link_2_properties, consumer_variable_set, provider_variable_set).and_return(interpolated_link_2_properties)
            result = subject.interpolate_link_spec_properties(cross_deployment_links_spec, consumer_variable_set)
            expect(result).to eq(interpolated_cross_deployment_links_spec)
            expect(result).to_not equal(interpolated_cross_deployment_links_spec)
          end

          context &#39;when provider deployment does NOT exist&#39; do
            before do
              allow(Bosh::Director::Models::Deployment).to receive(:[]).with(name: &#39;simple_2&#39;).and_return(nil)
            end

            it &#39;should raise an exception with appropriate message&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is present)::context(when there are links provided by a DIFFERENT deployment)::context(when provider deployment does NOT exist)::it#should raise an exception with appropriate message has a flog score of 29</span>          </div>  </li></ol>
              expected_error_msg = &lt;&lt;-EXPECTED.strip
- Unable to interpolate link &#39;link_2&#39; properties; provided by &#39;simple_2&#39; deployment. Errors are:
  - Deployment &#39;simple_2&#39; doesn&#39;t exist
              EXPECTED

              expect{
                subject.interpolate_link_spec_properties(cross_deployment_links_spec, consumer_variable_set)
              }.to raise_error { |error|
                expect(error.message).to eq(expected_error_msg)
              }
            end
          end

          context &#39;when provider deployment does NOT have a successful variable set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is present)::context(when there are links provided by a DIFFERENT deployment)::context#when provider deployment does NOT have a successful variable set has a flog score of 26</span>          </div>  </li></ol>
            before do
              allow(provider_deployment).to receive(:last_successful_variable_set).and_return(nil)
              allow(provider_deployment).to receive(:name).and_return(&#39;simple_2&#39;)
            end

            it &#39;should raise an exception with appropriate message&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when the properties of a link is present)::context(when there are links provided by a DIFFERENT deployment)::context(when provider deployment does NOT have a successful variable set)::it#should raise an exception with appropriate message has a flog score of 29</span>          </div>  </li></ol>
              expected_error_msg = &lt;&lt;-EXPECTED.strip
- Unable to interpolate link &#39;link_2&#39; properties; provided by &#39;simple_2&#39; deployment. Errors are:
  - Cannot consume properties from deployment &#39;simple_2&#39;. It was never successfully deployed.
              EXPECTED

              expect{
                subject.interpolate_link_spec_properties(cross_deployment_links_spec, consumer_variable_set)
              }.to raise_error { |error|
                expect(error.message).to eq(expected_error_msg)
              }
            end
          end

        end
      end

      context &#39;when config server returns errors while interpolating properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context#when config server returns errors while interpolating properties has a flog score of 38</span>          </div>  </li></ol>
        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L103" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L425" class="js-smell-location">1</a>                  </div>  </li></ol>
          allow(config_server_client).to receive(:interpolate_with_versioning).with(link_1_properties, consumer_variable_set).and_raise Exception, &lt;&lt;-EOF
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_2_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_3_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
          EOF

          allow(config_server_client).to receive(:interpolate_with_versioning).with(link_2_properties, consumer_variable_set).and_raise Exception, &lt;&lt;-EOF
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_4_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_5_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Failed to find variable &#39;/TestDirector/deployment_name/smurf_6_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
          EOF
        end

        it &#39;returns formatted error messages per job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_link_spec_properties)::context(when links spec is given)::context(when config server returns errors while interpolating properties)::it#returns formatted error messages per job has a flog score of 27</span>          </div>  </li></ol>
          expected_error_msg = &lt;&lt;-EXPECTED.strip
- Unable to interpolate link &#39;link_1&#39; properties; provided by &#39;simple_1&#39; deployment. Errors are:
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_2_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_3_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
- Unable to interpolate link &#39;link_2&#39; properties; provided by &#39;simple_1&#39; deployment. Errors are:
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_4_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_5_placeholder&#39; from config server: HTTP code &#39;404&#39;
  - Failed to find variable &#39;/TestDirector/deployment_name/smurf_6_1_placeholder&#39; from config server: HTTP code &#39;404&#39;
          EXPECTED

          expect {
            subject.interpolate_link_spec_properties(same_deployment_links_spec, consumer_variable_set)
          }.to raise_error { |error|
            expect(error.message).to eq(expected_error_msg)
          }
        end
      end
    end
  end

  describe &#39;#interpolate_deployment_manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##interpolate_deployment_manifest has a flog score of 30</span>          </div>  </li></ol>
    let(:ignored_subtrees) do
      index_type = Integer
      any_string = String

      ignored_subtrees = []
      ignored_subtrees &lt;&lt; [&#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;instance_groups&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;instance_groups&#39;, index_type, &#39;jobs&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;instance_groups&#39;, index_type, &#39;jobs&#39;, index_type, &#39;consumes&#39;, any_string, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;jobs&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;jobs&#39;, index_type, &#39;templates&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;jobs&#39;, index_type, &#39;templates&#39;, index_type, &#39;consumes&#39;, any_string, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;instance_groups&#39;, index_type, &#39;env&#39;]
      ignored_subtrees &lt;&lt; [&#39;jobs&#39;, index_type, &#39;env&#39;]
      ignored_subtrees &lt;&lt; [&#39;resource_pools&#39;, index_type, &#39;env&#39;]
      ignored_subtrees &lt;&lt; [&#39;addons&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;addons&#39;, index_type, &#39;jobs&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;addons&#39;, index_type, &#39;jobs&#39;, index_type, &#39;consumes&#39;, any_string, &#39;properties&#39;]
      ignored_subtrees
    end
    let(:current_deployment) { instance_double(Bosh::Director::Models::Deployment)}
    let(:current_variable_set) { instance_double(Bosh::Director::Models::VariableSet)}
    let(:deployment_manifest) do
      { &#39;name&#39; =&gt; &#39;smurf-deployment&#39;, &#39;properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;{{placeholder}}&#39; } }
    end

    before do
      allow(Bosh::Director::Models::Deployment).to receive(:[]).with(name: deployment_manifest[&#39;name&#39;]).and_return(current_deployment)
      allow(current_deployment).to receive(:current_variable_set).and_return(current_variable_set)
    end

    it &#39;should call interpolate_with_versioning with the correct arguments&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_deployment_manifest)::it#should call interpolate_with_versioning with the correct arguments has a flog score of 28</span>          </div>  </li></ol>
      expect(config_server_client).to receive(:interpolate_with_versioning).with(deployment_manifest, current_variable_set, subtrees_to_ignore: ignored_subtrees, must_be_absolute_name: false).and_return({&#39;name&#39; =&gt; &#39;smurf&#39;})
      result = subject.interpolate_deployment_manifest(deployment_manifest)
      expect(result).to eq({&#39;name&#39; =&gt; &#39;smurf&#39;})
    end
  end

  describe &#39;#interpolate_runtime_manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##interpolate_runtime_manifest has a flog score of 28</span>          </div>  </li></ol>
    let(:deployment_name) { &#39;some_deployment_name&#39; }
    let(:current_deployment) { instance_double(Bosh::Director::Models::Deployment)}
    let(:current_variable_set) { instance_double(Bosh::Director::Models::VariableSet)}
    let(:ignored_subtrees) do
      index_type = Integer
      any_string = String

      ignored_subtrees = []
      ignored_subtrees &lt;&lt; [&#39;addons&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;addons&#39;, index_type, &#39;jobs&#39;, index_type, &#39;properties&#39;]
      ignored_subtrees &lt;&lt; [&#39;addons&#39;, index_type, &#39;jobs&#39;, index_type, &#39;consumes&#39;, any_string, &#39;properties&#39;]
      ignored_subtrees
    end

    before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L515" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L567" class="js-smell-location">1</a>                  </div>  </li></ol>
      allow(Bosh::Director::Models::Deployment).to receive(:[]).with(name: deployment_name).and_return(current_deployment)
      allow(current_deployment).to receive(:current_variable_set).and_return(current_variable_set)
    end

    it &#39;should call interpolate with the correct arguments&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_runtime_manifest)::it#should call interpolate with the correct arguments has a flog score of 26</span>          </div>  </li></ol>
      expect(config_server_client).to receive(:interpolate_with_versioning).with({&#39;name&#39; =&gt; &#39;{{placeholder}}&#39;}, current_variable_set, {subtrees_to_ignore: ignored_subtrees, must_be_absolute_name: false}).and_return({&#39;name&#39; =&gt; &#39;smurf&#39;})
      result = subject.interpolate_runtime_manifest({&#39;name&#39; =&gt; &#39;{{placeholder}}&#39;}, deployment_name)
      expect(result).to eq({&#39;name&#39; =&gt; &#39;smurf&#39;})
    end
  end

  describe &#39;#interpolate_cloud_manifest&#39; do
    let(:cloud_manifest) do
      { &#39;name&#39; =&gt; &#39;((placeholder))&#39; }
    end
    let(:interpolated_cloud_manifest) do
      { &#39;name&#39; =&gt; &#39;kobu&#39; }
    end

    let(:ignored_subtrees) do
      index_type = Integer
      any_String = String

      ignored_subtrees = []
      ignored_subtrees &lt;&lt; [&#39;azs&#39;, index_type, &#39;cloud_properties&#39;, any_String]
      ignored_subtrees &lt;&lt; [&#39;networks&#39;, index_type, &#39;cloud_properties&#39;, any_String]
      ignored_subtrees &lt;&lt; [&#39;networks&#39;, index_type, &#39;subnets&#39;, index_type, &#39;cloud_properties&#39;, any_String]
      ignored_subtrees &lt;&lt; [&#39;vm_types&#39;, index_type, &#39;cloud_properties&#39;, any_String]
      ignored_subtrees &lt;&lt; [&#39;vm_extensions&#39;, index_type, &#39;cloud_properties&#39;, any_String]
      ignored_subtrees &lt;&lt; [&#39;disk_types&#39;, index_type, &#39;cloud_properties&#39;, any_String]
      ignored_subtrees &lt;&lt; [&#39;compilation&#39;, &#39;cloud_properties&#39;, any_String]
      ignored_subtrees
    end

    context &#39;when deployment name is nil&#39; do
      let(:deployment_name) { nil }

      it &#39;should call interpolate with the correct arguments&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_cloud_manifest)::context(when deployment name is nil)::it#should call interpolate with the correct arguments has a flog score of 34</span>          </div>  </li></ol>
        expect(config_server_client).to receive(:interpolate).
            with(cloud_manifest, {subtrees_to_ignore: ignored_subtrees}).
            and_return(interpolated_cloud_manifest)
        result = subject.interpolate_cloud_manifest(cloud_manifest, deployment_name)
        expect(result).to eq(interpolated_cloud_manifest)
      end
    end

    context &#39;when deployment name is NOT nil&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_cloud_manifest)::context#when deployment name is NOT nil has a flog score of 29</span>          </div>  </li></ol>
      let(:deployment_name) { &#39;some_deployment_name&#39; }
      let(:current_deployment) { instance_double(Bosh::Director::Models::Deployment)}
      let(:current_variable_set) { instance_double(Bosh::Director::Models::VariableSet)}

      before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L515" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L567" class="js-smell-location">1</a>                  </div>  </li></ol>
        allow(Bosh::Director::Models::Deployment).to receive(:[]).with(name: deployment_name).and_return(current_deployment)
        allow(current_deployment).to receive(:current_variable_set).and_return(current_variable_set)
      end

      it &#39;should call interpolate with the correct arguments&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_cloud_manifest)::context(when deployment name is NOT nil)::it#should call interpolate with the correct arguments has a flog score of 36</span>          </div>  </li></ol>
        expect(config_server_client).to receive(:interpolate_with_versioning).
            with(cloud_manifest, current_variable_set, {subtrees_to_ignore: ignored_subtrees, must_be_absolute_name: true}).
            and_return(interpolated_cloud_manifest)
        result = subject.interpolate_cloud_manifest(cloud_manifest, deployment_name)
        expect(result).to eq(interpolated_cloud_manifest)
      end
    end
  end

  describe &#39;#interpolate_cpi_manifest&#39; do
    let(:options) do
      {
          :subtrees_to_ignore =&gt; [
              [&#39;name&#39;],
              [&#39;type&#39;]
          ]
      }
    end
    context &#39;when there are no variables to interpolate&#39; do
      let(:raw_cpi_config) do
        {
          &#39;name&#39; =&gt; &#39;some-cpi&#39;,
          &#39;type&#39; =&gt; &#39;foo-type&#39;,
          &#39;properties&#39; =&gt; {
            &#39;someKeyFoo1&#39; =&gt; &#39;cpi-someFooVal1&#39;,
            &#39;someKeyBar2&#39; =&gt; &#39;cpi-someFooVal2&#39;,
          },
        }
      end

      it &#39;returns the original hash&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L603" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L635" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_cpi_manifest)::context(when there are no variables to interpolate)::it#returns the original hash has a flog score of 32</span>          </div>  </li></ol>
        expect(config_server_client).to receive(:interpolate)
                                            .with(raw_cpi_config, options)
                                            .and_return(raw_cpi_config)
        result = subject.interpolate_cpi_config(raw_cpi_config)
        expect(result).to eq(raw_cpi_config)
      end
    end

    context &#39;when all variables to interpolate are absolute&#39; do
      let(:raw_cpi_config) do
        {
          &#39;name&#39; =&gt; &#39;some-cpi&#39;,
          &#39;type&#39; =&gt; &#39;foo-type&#39;,
          &#39;properties&#39; =&gt; {
            &#39;someKeyFoo1&#39; =&gt; &#39;((/cpi-someFooVal1-var))&#39;,
            &#39;someKeyBar2&#39; =&gt; &#39;((/cpi-someFooVal2-var))&#39;,
          },
        }
      end

      let(:interpolated_cpi_config) do
        {
          &#39;name&#39; =&gt; &#39;some-cpi&#39;,
          &#39;type&#39; =&gt; &#39;foo-type&#39;,
          &#39;properties&#39; =&gt; {
            &#39;someKeyFoo1&#39; =&gt; &#39;cpi-someFooVal1-val&#39;,
            &#39;someKeyBar2&#39; =&gt; &#39;cpi-someFooVal2-val&#39;,
          },
        }
      end

      it &#39;returns the interpolated hash&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="variables_interpolator_spec.html#L603" class="js-smell-location">0</a>                  <a href="variables_interpolator_spec.html#L635" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_cpi_manifest)::context(when all variables to interpolate are absolute)::it#returns the interpolated hash has a flog score of 32</span>          </div>  </li></ol>
        expect(config_server_client).to receive(:interpolate)
                                            .with(raw_cpi_config, options)
                                            .and_return(interpolated_cpi_config)
        result = subject.interpolate_cpi_config(raw_cpi_config)
        expect(result).to eq(interpolated_cpi_config)
      end
    end

    context &#39;when some variables are relative&#39; do
      let(:raw_cpi_config) do
        {
          &#39;name&#39; =&gt; &#39;some-cpi&#39;,
          &#39;type&#39; =&gt; &#39;foo-type&#39;,
          &#39;properties&#39; =&gt; {
            &#39;someKeyFoo1&#39; =&gt; &#39;((cpi-someFooVal1-var))&#39;,
            &#39;someKeyBar2&#39; =&gt; &#39;((/cpi-someFooVal2-var))&#39;,
          },
        }
      end

      it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#interpolate_cpi_manifest)::context(when some variables are relative)::it#raises an error has a flog score of 29</span>          </div>  </li></ol>
        expect(config_server_client).to receive(:interpolate)
                                            .with(raw_cpi_config, options)
                                            .and_raise(&#39;Interpolation error occured&#39;)
        expect {
            subject.interpolate_cpi_config(raw_cpi_config)
        }.to raise_error
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
