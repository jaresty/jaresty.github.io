<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-03-29 13:43:06 -0400'>2018-03-29 13:43:06 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/errand /</small> errand_provider_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">570</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">32</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1968.04</span><small> complexity</small></div>
              <div><span class="metric">319</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                27
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe Errand::ErrandProvider do
    subject(:errand_provider) do
      Errand::ErrandProvider.new(logs_fetcher, instance_manager, event_manager, logger, task_result, deployment_planner_provider)
    end

    describe &#39;#get&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe##get has a flog score of 59</span>          </div>  </li></ol>
      let(:deployment_planner_provider) { instance_double(Errand::DeploymentPlannerProvider) }
      let(:deployment_planner) do
        instance_double(DeploymentPlan::Planner,
                        availability_zones: [],
                        template_blob_cache: template_blob_cache,
                        ip_provider: ip_provider,
                        use_short_dns_addresses?: false)
      end
      let(:task_result) { instance_double(TaskDBWriter) }
      let(:instance_manager) { Api::InstanceManager.new }
      let(:logs_fetcher) { instance_double LogsFetcher }
      let(:event_manager) { instance_double(Bosh::Director::Api::EventManager) }
      let(:task_writer) { StringIO.new }
      let(:event_log) { EventLog::Log.new(task_writer) }
      let(:deployment_name) { deployment_model.name }
      let(:template_blob_cache) { instance_double(Bosh::Director::Core::Templates::TemplateBlobCache) }
      let(:runner) { instance_double(Errand::Runner) }
      let(:errand_step) { instance_double(Errand::LifecycleErrandStep) }
      let(:instance) do
        instance_double(
          DeploymentPlan::Instance,
          current_job_state: double(:current_job_state),
          uuid: instance_model.uuid,
          model: instance_model,
        )
      end
      let!(:instance_model) { Models::Instance.make(deployment: deployment_model, uuid: &#39;instance-uuid&#39;) }
      let(:ip_provider) { instance_double(DeploymentPlan::IpProvider) }
      let(:keep_alive) { false }
      let(:instance_slugs) { [] }
      let(:deployment_model) { Bosh::Director::Models::Deployment.make }

      before do
        allow(deployment_planner_provider).to receive(:get_by_name)
          .with(deployment_name, be_a(Array))
          .and_return(deployment_planner)
        allow(deployment_planner).to receive(:instance_groups).and_return(instance_groups)
        allow(Config).to receive(:event_log).and_return(event_log)
        allow(deployment_planner).to receive(:instance_group)
        allow(deployment_planner).to receive(:model).and_return(deployment_model)
      end

      context &#39;when running an errand by release job name&#39; do
        let(:job_name) { &#39;errand-job-name&#39; }
        let(:job) { instance_double(DeploymentPlan::Job, name: job_name) }
        let(:instance_group) do
          instance_double(DeploymentPlan::InstanceGroup, jobs: [job], instances: [instance], bind_instances: nil, errand?: false)
        end
        let(:instance_groups) { [instance_group] }

        it &#39;provides an errand that will run on the instance in that group&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::it#provides an errand that will run on the instance in that group has a flog score of 60</span>          </div>  </li></ol>
          expect(Errand::Runner).to receive(:new)
            .with(job_name, true, task_result, instance_manager, logs_fetcher)
            .and_return(runner)
          expect(Errand::LifecycleServiceStep).to receive(:new).with(
            runner, instance, logger
          ).and_return(errand_step)
          returned_errand = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
          expect(returned_errand.steps[0]).to eq(errand_step)
        end

        context &#39;when multiple instances within multiple instance groups have that job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context#when multiple instances within multiple instance groups have that job has a flog score of 40</span>          </div>  </li></ol>
          let(:job_state1) { double(:job_state1) }
          let(:job_state2) { double(:job_state2) }
          let(:job_state3) { double(:job_state3) }
          let(:needed_instance_plans) { [] }
          let(:service_group_name) { &#39;service-group-name&#39; }
          let(:errand_group_name) { &#39;errand-group-name&#39; }

          let(:instance1_model) { Models::Instance.make(deployment: deployment_model, job: service_group_name) }
          let(:instance1) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L80" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L92" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L104" class="js-smell-location">2</a>                  </div>  </li></ol>
            instance_double(
              DeploymentPlan::Instance,
              model: instance1_model,
              instance_group_name: instance1_model.job,
              uuid: instance1_model.uuid,
              index: 1,
              current_job_state: job_state1,
            )
          end

          let(:instance2_model) { Models::Instance.make(deployment: deployment_model, job: service_group_name) }
          let(:instance2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L80" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L92" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L104" class="js-smell-location">2</a>                  </div>  </li></ol>
            instance_double(
              DeploymentPlan::Instance,
              model: instance2_model,
              instance_group_name: instance2_model.job,
              uuid: instance2_model.uuid,
              index: 2,
              current_job_state: job_state2,
            )
          end

          let(:instance3_model) { Models::Instance.make(deployment: deployment_model, job: errand_group_name) }
          let(:instance3) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L80" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L92" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L104" class="js-smell-location">2</a>                  </div>  </li></ol>
            instance_double(
              DeploymentPlan::Instance,
              model: instance3_model,
              instance_group_name: instance3_model.job,
              uuid: instance3_model.uuid,
              index: 3,
              current_job_state: job_state3,
            )
          end

          let(:instance_group1) do
            instance_double(
              DeploymentPlan::InstanceGroup,
              name: service_group_name,
              jobs: [job],
              bind_instances: nil,
              instances: [instance1, instance2],
              errand?: false,
            )
          end
          let(:instance_group2) do
            instance_double(
              DeploymentPlan::InstanceGroup,
              name: errand_group_name,
              jobs: [job],
              bind_instances: nil,
              instances: [instance3],
              errand?: true,
              needed_instance_plans: needed_instance_plans,
            )
          end
          let(:instance_groups) { [instance_group1, instance_group2] }
          let(:errand_step1) { instance_double(Errand::LifecycleServiceStep) }
          let(:errand_step2) { instance_double(Errand::LifecycleServiceStep) }
          let(:errand_step3) { instance_double(Errand::LifecycleErrandStep) }
          let(:package_compile_step) { instance_double(DeploymentPlan::Stages::PackageCompileStage) }

          before do
            allow(DeploymentPlan::Stages::PackageCompileStage).to receive(:create).and_return(package_compile_step)
            allow(package_compile_step).to receive(:perform)
            allow(instance_group2).to receive(:bind_instances)
            allow(Errand::Runner).to receive(:new).and_return(runner)
          end

          context &#39;when one instance has a matching non-errand job name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context#when one instance has a matching non-errand job name has a flog score of 37</span>          </div>  </li></ol>
            let(:instance_groups) { [instance_group1, non_errand_ig] }
            let(:non_errand_job) { instance_double(DeploymentPlan::Job, name: &#39;errand-job-name&#39;, runs_as_errand?: false) }
            let(:non_errand_step) { instance_double(Errand::LifecycleServiceStep) }
            let(:non_errand_instance_model) { Models::Instance.make(deployment: deployment_model, job: errand_group_name) }
            let(:non_errand_instance) do
              instance_double(
                DeploymentPlan::Instance,
                model: non_errand_instance_model,
                instance_group_name: non_errand_instance_model.job,
                uuid: non_errand_instance_model.uuid,
                index: 2,
                current_job_state: &#39;running&#39;,
              )
            end
            let(:non_errand_ig) do
              instance_double(DeploymentPlan::InstanceGroup,
                              name: &#39;non_errand_ig&#39;,
                              jobs: [non_errand_job],
                              instances: [non_errand_instance],
                              errand?: false,
                              needed_instance_plans: [],
                              bind_instances: nil)
            end

            before do
              allow(deployment_planner).to receive(:instance_group).with(service_group_name).and_return(instance_group1)
              allow(deployment_planner).to receive(:instance_group).with(&#39;non_errand_ig&#39;).and_return(non_errand_ig)
            end

            it &#39;tries to run all matching jobs even if some are not errands &#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when one instance has a matching non-errand job name)::it#tries to run all matching jobs even if some are not errands  has a flog score of 86</span>          </div>  </li></ol>
              expect(Errand::LifecycleServiceStep).to receive(:new)
                .with(runner, instance1, logger)
                .and_return(errand_step1)
              expect(Errand::LifecycleServiceStep).to receive(:new)
                .with(runner, instance2, logger)
                .and_return(errand_step2)
              expect(Errand::LifecycleServiceStep).to receive(:new)
                .with(runner, non_errand_instance, logger)
                .and_return(non_errand_step)

              returned_errands = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
              expect(returned_errands.steps).to contain_exactly(errand_step1, errand_step2, non_errand_step)
            end
          end

          context &#39;when a matching instance group has 0 instances&#39; do
            let(:instance_group2) do
              instance_double(
                DeploymentPlan::InstanceGroup,
                name: errand_group_name,
                jobs: [job],
                bind_instances: nil,
                instances: [],
                errand?: true,
                needed_instance_plans: needed_instance_plans,
              )
            end

            context &#39;when using an instance filter&#39; do
              let(:instance_slugs) { [{ &#39;group&#39; =&gt; &#39;service-group-name&#39; }] }

              it &#39;no-ops successfully on that instance group and continues&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L211" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L229" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when a matching instance group has 0 instances)::context(when using an instance filter)::it#no-ops successfully on that instance group and continues has a flog score of 90</span>          </div>  </li></ol>
                expect(Errand::Runner).to receive(:new)
                  .with(job_name, true, task_result, instance_manager, logs_fetcher)
                  .and_return(runner)

                expect(Errand::LifecycleServiceStep).to receive(:new)
                  .with(runner, instance1, logger)
                  .and_return(errand_step1)
                expect(Errand::LifecycleServiceStep).to receive(:new)
                  .with(runner, instance2, logger)
                  .and_return(errand_step2)

                returned_errands = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
                expect(returned_errands.steps).to contain_exactly(errand_step1, errand_step2)
              end
            end

            context &#39;without any instance filter&#39; do
              it &#39;no-ops successfully on that instance group and continues&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L211" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L229" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when a matching instance group has 0 instances)::context(without any instance filter)::it#no-ops successfully on that instance group and continues has a flog score of 86</span>          </div>  </li></ol>
                expect(Errand::Runner).to receive(:new)
                  .with(job_name, true, task_result, instance_manager, logs_fetcher)
                  .and_return(runner)

                expect(Errand::LifecycleServiceStep).to receive(:new)
                  .with(runner, instance1, logger)
                  .and_return(errand_step1)
                expect(Errand::LifecycleServiceStep).to receive(:new)
                  .with(runner, instance2, logger)
                  .and_return(errand_step2)

                returned_errands = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
                expect(returned_errands.steps).to contain_exactly(errand_step1, errand_step2)
              end
            end
          end

          context &#39;when running an errand where instance group name and the release job name are the same&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context#when running an errand where instance group name and the release job name are the same has a flog score of 119</span>          </div>  </li></ol>
            let(:ambiguous_errand_name) { &#39;ambiguous-errand-name&#39; }
            let(:job_name) { ambiguous_errand_name }
            let(:service_group_name) { ambiguous_errand_name }

            before do
              allow(Errand::Runner).to receive(:new)
                .with(job_name, true, task_result, instance_manager, logs_fetcher)
                .and_return(runner)

              allow(Errand::LifecycleServiceStep).to receive(:new)
                .with(runner, instance1, logger)
                .and_return(errand_step1)
              allow(Errand::LifecycleServiceStep).to receive(:new)
                .with(runner, instance2, logger)
                .and_return(errand_step2)
              allow(Errand::LifecycleErrandStep).to receive(:new)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L263" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L309" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L329" class="js-smell-location">2</a>                  <a href="errand_provider_spec.html#L382" class="js-smell-location">3</a>                  <a href="errand_provider_spec.html#L446" class="js-smell-location">4</a>                  <a href="errand_provider_spec.html#L469" class="js-smell-location">5</a>                  </div>  </li></ol>
                .with(runner, deployment_planner, job_name, instance3, instance_group2, keep_alive, deployment_name, logger)
                .and_return(errand_step3)
              allow(deployment_planner).to receive(:instance_group)
                .with(ambiguous_errand_name)
                .and_return(instance_group2)
            end

            it &#39;treats the name as a job name and runs the errand on all instances that have the release job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when running an errand where instance group name and the release job name are the same)::it#treats the name as a job name and runs the errand on all instances that have the release job has a flog score of 28</span>          </div>  </li></ol>
              returned_errands = subject.get(deployment_name, ambiguous_errand_name, keep_alive, instance_slugs)
              expect(returned_errands.steps).to contain_exactly(errand_step1, errand_step2, errand_step3)
            end

            it &#39;prints a warning to the task output&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when running an errand where instance group name and the release job name are the same)::it#prints a warning to the task output has a flog score of 80</span>          </div>  </li></ol>
              subject.get(deployment_name, ambiguous_errand_name, keep_alive, instance_slugs)

              output = task_writer.string
              lines = output.split(&quot;\n&quot;)

              line_0_json = JSON.parse(lines[0])
              expect(line_0_json[&#39;state&#39;]).to eq(&#39;started&#39;)
              expect(line_0_json[&#39;stage&#39;]).to eq(&#39;Preparing deployment&#39;)

              line_1_json = JSON.parse(lines[1])
              expect(line_1_json[&#39;type&#39;]).to eq(&#39;warning&#39;)
              expect(line_1_json[&#39;message&#39;]).to eq(&quot;Ambiguous request: the requested errand name &#39;ambiguous-errand-name&#39; &quot; \
                &#39;matches both a job name and an errand instance group name. Executing errand on all relevant &#39; \
                &quot;instances with job &#39;ambiguous-errand-name&#39;.&quot;)

              line_2_json = JSON.parse(lines[2])
              expect(line_2_json[&#39;state&#39;]).to eq(&#39;finished&#39;)
              expect(line_2_json[&#39;stage&#39;]).to eq(&#39;Preparing deployment&#39;)
            end
          end

          it &#39;runs the job on all instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::it#runs the job on all instances has a flog score of 114</span>          </div>  </li></ol>
            expect(Errand::Runner).to receive(:new)
              .with(job_name, true, task_result, instance_manager, logs_fetcher)
              .and_return(runner)

            expect(Errand::LifecycleServiceStep).to receive(:new)
              .with(runner, instance1, logger)
              .and_return(errand_step1)
            expect(Errand::LifecycleServiceStep).to receive(:new)
              .with(runner, instance2, logger)
              .and_return(errand_step2)
            expect(Errand::LifecycleErrandStep).to receive(:new)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L263" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L309" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L329" class="js-smell-location">2</a>                  <a href="errand_provider_spec.html#L382" class="js-smell-location">3</a>                  <a href="errand_provider_spec.html#L446" class="js-smell-location">4</a>                  <a href="errand_provider_spec.html#L469" class="js-smell-location">5</a>                  </div>  </li></ol>
              .with(runner, deployment_planner, job_name, instance3, instance_group2, keep_alive, deployment_name, logger)
              .and_return(errand_step3)

            returned_errands = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
            expect(returned_errands.steps).to contain_exactly(errand_step1, errand_step2, errand_step3)
          end

          context &#39;when a matching instance has no vm reference&#39; do
            let(:job_state2) { nil }

            it &#39;runs the jobs successfully on all remaining instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when a matching instance has no vm reference)::it#runs the jobs successfully on all remaining instances has a flog score of 112</span>          </div>  </li></ol>
              expect(Errand::Runner).to receive(:new)
                .with(job_name, true, task_result, instance_manager, logs_fetcher)
                .and_return(runner)
              expect(Errand::LifecycleServiceStep).to receive(:new)
                .with(runner, instance1, logger)
                .and_return(errand_step1)
              expect(Errand::LifecycleServiceStep).not_to receive(:new)
                .with(runner, instance2, logger)
              expect(Errand::LifecycleErrandStep).to receive(:new)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L263" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L309" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L329" class="js-smell-location">2</a>                  <a href="errand_provider_spec.html#L382" class="js-smell-location">3</a>                  <a href="errand_provider_spec.html#L446" class="js-smell-location">4</a>                  <a href="errand_provider_spec.html#L469" class="js-smell-location">5</a>                  </div>  </li></ol>
                .with(runner, deployment_planner, job_name, instance3, instance_group2, keep_alive, deployment_name, logger)
                .and_return(errand_step3)

              returned_errands = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
              expect(returned_errands.steps).to contain_exactly(errand_step1, errand_step3)
            end

            it &#39;writes to the event log that a vm2 was missing&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when a matching instance has no vm reference)::it#writes to the event log that a vm2 was missing has a flog score of 60</span>          </div>  </li></ol>
              subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
              output = task_writer.string
              lines = output.split(&quot;\n&quot;)

              line_0_json = JSON.parse(lines[0])
              expect(line_0_json[&#39;state&#39;]).to eq(&#39;started&#39;)
              expect(line_0_json[&#39;stage&#39;]).to eq(&#39;Preparing deployment&#39;)

              line_1_json = JSON.parse(lines[1])
              expect(line_1_json[&#39;message&#39;]).to eq(&quot;Skipping instance: #{instance2} &quot; \
                                                   &#39;no matching VM reference was found&#39;)
              expect(line_1_json[&#39;type&#39;]).to eq(&#39;warning&#39;)
            end
          end

          it &#39;writes to the event log&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::it#writes to the event log has a flog score of 55</span>          </div>  </li></ol>
            subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
            output = task_writer.string
            lines = output.split(&quot;\n&quot;)

            line_0_json = JSON.parse(lines[0])
            expect(line_0_json[&#39;state&#39;]).to eq(&#39;started&#39;)
            expect(line_0_json[&#39;stage&#39;]).to eq(&#39;Preparing deployment&#39;)

            line_1_json = JSON.parse(lines[1])
            expect(line_1_json[&#39;state&#39;]).to eq(&#39;finished&#39;)
            expect(line_1_json[&#39;stage&#39;]).to eq(&#39;Preparing deployment&#39;)
          end

          context &#39;when selecting an instance from a service group&#39; do
            let(:instance_slugs) { [{ &#39;group&#39; =&gt; &#39;service-group-name&#39;, &#39;id&#39; =&gt; instance2_model.uuid }] }

            it &#39;only creates an errand for the requested slug&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when selecting an instance from a service group)::it#only creates an errand for the requested slug has a flog score of 42</span>          </div>  </li></ol>
              expect(Errand::LifecycleServiceStep).to receive(:new).with(
                runner, instance2, logger
              ).and_return(errand_step2)
              returned_errands = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
              expect(returned_errands.steps).to contain_exactly(errand_step2)
            end
          end

          context &#39;when selecting an instance from a errand group&#39; do
            let(:instance_slugs) { [{ &#39;group&#39; =&gt; &#39;errand-group-name&#39; }] }
            it &#39;only creates an errand for the requested slug&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by release job name)::context(when multiple instances within multiple instance groups have that job)::context(when selecting an instance from a errand group)::it#only creates an errand for the requested slug has a flog score of 54</span>          </div>  </li></ol>
              expect(Errand::LifecycleErrandStep).to receive(:new).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L263" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L309" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L329" class="js-smell-location">2</a>                  <a href="errand_provider_spec.html#L382" class="js-smell-location">3</a>                  <a href="errand_provider_spec.html#L446" class="js-smell-location">4</a>                  <a href="errand_provider_spec.html#L469" class="js-smell-location">5</a>                  </div>  </li></ol>
                runner, deployment_planner, job_name, instance3, instance_group2, keep_alive, deployment_name, logger
              ).and_return(errand_step3)
              returned_errands = subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
              expect(returned_errands.steps).to contain_exactly(errand_step3)
            end
          end

          context &#39;when selecting an instance that does not exist&#39; do
            let(:instance_slugs) { [{ &#39;group&#39; =&gt; &#39;bogus-group-name&#39;, &#39;id&#39; =&gt; &#39;0&#39; }] }
            it &#39;only creates an errand for the requested slug&#39; do
              expect do
                subject.get(deployment_name, &#39;errand-job-name&#39;, keep_alive, instance_slugs)
              end.to raise_error(&#39;No instances match selection criteria: [{&quot;group&quot;=&gt;&quot;bogus-group-name&quot;, &quot;id&quot;=&gt;&quot;0&quot;}]&#39;)
            end
          end
        end
      end

      context &#39;when running an errand by instance group name&#39; do
        let(:ig_name) { &#39;instance-group-name&#39; }
        let(:instance_groups) { [instance_group] }
        let(:non_errand_job) { instance_double(DeploymentPlan::Job, name: &#39;non-errand-job&#39;) }
        let(:errand_job_name) { &#39;errand-job&#39; }
        let(:errand_job) { instance_double(DeploymentPlan::Job, name: errand_job_name) }
        let(:needed_instance_plans) { [] }
        let(:package_compile_step) { instance_double(DeploymentPlan::Stages::PackageCompileStage) }

        before do
          allow(deployment_planner).to receive(:instance_group).with(ig_name).and_return(instance_group)
        end

        context &#39;when there is a lifecycle: errand instance group with that name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by instance group name)::context#when there is a lifecycle: errand instance group with that name has a flog score of 52</span>          </div>  </li></ol>
          let(:dns_encoder) { instance_double(DnsEncoder) }
          let(:instance_group) do
            instance_double(DeploymentPlan::InstanceGroup,
                            name: ig_name,
                            jobs: [errand_job, non_errand_job],
                            instances: [instance],
                            errand?: true,
                            needed_instance_plans: needed_instance_plans,
                            bind_instances: nil)
          end

          before do
            allow(LocalDnsEncoderManager).to receive(:new_encoder_with_updated_index).and_return(dns_encoder)
            allow(instance).to receive(:model).and_return(instance_model)
            allow(DeploymentPlan::Stages::PackageCompileStage).to receive(:create).and_return(package_compile_step)
            allow(instance_group).to receive(:bind_instances)
            allow(package_compile_step).to receive(:perform)
          end

          it &#39;returns an errand object that will run on the first instance in that instance group&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by instance group name)::context(when there is a lifecycle: errand instance group with that name)::it#returns an errand object that will run on the first instance in that instance group has a flog score of 112</span>          </div>  </li></ol>
            expect(package_compile_step).to receive(:perform)
            expect(instance_group).to receive(:bind_instances).with(ip_provider)
            expect(JobRenderer).to receive(:render_job_instances_with_cache).with(
              needed_instance_plans,
              template_blob_cache,
              an_instance_of(DnsEncoder),
              logger,
            )
            expect(Errand::Runner).to receive(:new)
              .with(ig_name, false, task_result, instance_manager, logs_fetcher)
              .and_return(runner)
            expect(Errand::LifecycleErrandStep).to receive(:new)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L263" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L309" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L329" class="js-smell-location">2</a>                  <a href="errand_provider_spec.html#L382" class="js-smell-location">3</a>                  <a href="errand_provider_spec.html#L446" class="js-smell-location">4</a>                  <a href="errand_provider_spec.html#L469" class="js-smell-location">5</a>                  </div>  </li></ol>
              .with(runner, deployment_planner, ig_name, instance, instance_group, keep_alive, deployment_name, logger)
              .and_return(errand_step)
            returned_errand = subject.get(deployment_name, ig_name, keep_alive, instance_slugs)
            expect(returned_errand.steps[0]).to eq(errand_step)
          end

          context &#39;and the lifecycle errand instance group name is the same as the job name&#39; do
            let(:ig_name) { &#39;ig-name-matching-job-name&#39; }
            let(:errand_job_name) { ig_name }

            it &#39;returns an errand object that will run on the first instance in that instance group&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by instance group name)::context(when there is a lifecycle: errand instance group with that name)::context(and the lifecycle errand instance group name is the same as the job name)::it#returns an errand object that will run on the first instance in that instance group has a flog score of 117</span>          </div>  </li></ol>
              expect(package_compile_step).to receive(:perform)
              expect(instance_group).to receive(:bind_instances).with(ip_provider)
              expect(JobRenderer).to receive(:render_job_instances_with_cache).with(
                needed_instance_plans,
                template_blob_cache,
                an_instance_of(DnsEncoder),
                logger,
              )
              expect(Errand::Runner).to receive(:new)
                .with(ig_name, true, task_result, instance_manager, logs_fetcher)
                .and_return(runner)
              expect(Errand::LifecycleErrandStep).to receive(:new)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L263" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L309" class="js-smell-location">1</a>                  <a href="errand_provider_spec.html#L329" class="js-smell-location">2</a>                  <a href="errand_provider_spec.html#L382" class="js-smell-location">3</a>                  <a href="errand_provider_spec.html#L446" class="js-smell-location">4</a>                  <a href="errand_provider_spec.html#L469" class="js-smell-location">5</a>                  </div>  </li></ol>
                .with(runner, deployment_planner, ig_name, instance, instance_group, keep_alive, deployment_name, logger)
                .and_return(errand_step)
              returned_errand = subject.get(deployment_name, ig_name, keep_alive, instance_slugs)
              expect(returned_errand.steps[0]).to eq(errand_step)
            end

            it &#39;should NOT be a deploy action&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L476" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L492" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by instance group name)::context(when there is a lifecycle: errand instance group with that name)::context(and the lifecycle errand instance group name is the same as the job name)::it#should NOT be a deploy action has a flog score of 38</span>          </div>  </li></ol>
              expect(deployment_model.links_serial_id).to eq(0)

              subject.get(deployment_name, ig_name, keep_alive, instance_slugs)

              deployment_model.refresh
              expect(deployment_model.links_serial_id).to eq(0)
            end
          end

          context &#39;and it has stale errand links&#39; do
            before do
              deployment_model.has_stale_errand_links = true
              deployment_model.save
            end

            it &#39;still treats it as a deploy action to resolve links&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="errand_provider_spec.html#L476" class="js-smell-location">0</a>                  <a href="errand_provider_spec.html#L492" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by instance group name)::context(when there is a lifecycle: errand instance group with that name)::context(and it has stale errand links)::it#still treats it as a deploy action to resolve links has a flog score of 39</span>          </div>  </li></ol>
              expect(deployment_model.links_serial_id).to eq(0)

              subject.get(deployment_name, ig_name, keep_alive, instance_slugs)

              deployment_model.refresh
              expect(deployment_model.links_serial_id).to eq(1)
            end
          end

          context &#39;and instances are specified&#39; do
            let(:instance_slugs) { [&#39;group_name/0&#39;] }
            it &#39;raises&#39; do
              expect do
                subject.get(deployment_name, ig_name, keep_alive, instance_slugs)
              end.to raise_error(
                RunErrandError,
                &#39;Filtering by instances is not supported when running errand by instance group name&#39;,
              )
            end
          end
        end

        context &#39;when there is a lifecycle: errand instance group with that name that has no instances&#39; do
          let(:instance_group) do
            instance_double(DeploymentPlan::InstanceGroup,
                            name: ig_name,
                            jobs: [errand_job, non_errand_job],
                            instances: [],
                            errand?: true,
                            needed_instance_plans: needed_instance_plans,
                            bind_instances: nil)
          end

          it &#39;returns an errand object that will run on the first instance in that instance group&#39; do
            expect do
              subject.get(deployment_name, ig_name, keep_alive, instance_slugs)
            end.to raise_error(InstanceNotFound, &quot;Instance &#39;#{deployment_name}/instance-group-name/0&#39; doesn&#39;t exist&quot;)
          end
        end

        context &#39;when there is not a lifecycle: errand instance group with that name&#39; do
          let(:instance_group) do
            instance_double(
              DeploymentPlan::InstanceGroup,
              name: ig_name,
              jobs: [errand_job, non_errand_job],
              instances: [instance],
              errand?: false,
              needed_instance_plans: needed_instance_plans,
              bind_instances: nil,
            )
          end

          it &#39;fails&#39; do
            expect do
              subject.get(deployment_name, ig_name, keep_alive, instance_slugs)
            end.to raise_error(
              RunErrandError,
              &quot;Instance group &#39;instance-group-name&#39; is not an errand. &quot; \
              &quot;To mark an instance group as an errand set its lifecycle to &#39;errand&#39; in the deployment manifest.&quot;,
            )
          end
        end

        context &#39;when there is not a lifecycle: errand instance group with that name&#39; do
          let(:instance_group) { nil }
          let(:instance_groups) { [] }

          it &#39;fails&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#get)::context(when running an errand by instance group name)::context(when there is not a lifecycle: errand instance group with that name)::it#fails has a flog score of 39</span>          </div>  </li></ol>
            expect do
              subject.get(deployment_name, ig_name, keep_alive, instance_slugs)
            end.to raise_error(JobNotFound, &quot;Errand &#39;instance-group-name&#39; doesn&#39;t exist&quot;)
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
