<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> instance_spec_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">521</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">69</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1076.09</span><small> complexity</small></div>
              <div><span class="metric">180</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                12
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director::DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
  describe InstanceSpec do
    include Support::StemcellHelpers
    subject(:instance_spec) { described_class.create_from_instance_plan(instance_plan) }
    let(:links_manager) do
      instance_double(Bosh::Director::Links::LinksManager).tap do |double|
        allow(double).to receive(:get_links_from_deployment).and_return([])
      end
    end
    let(:job_spec) do
      { &#39;name&#39; =&gt; &#39;smurf-job&#39;, &#39;release&#39; =&gt; &#39;release&#39;, &#39;templates&#39; =&gt; [] }
    end
    let(:packages) do
      { &#39;pkg&#39; =&gt; { &#39;name&#39; =&gt; &#39;package&#39;, &#39;version&#39; =&gt; &#39;1.0&#39; } }
    end
    let(:properties) do
      { &#39;key&#39; =&gt; &#39;value&#39; }
    end
    let(:links) do
      {
        &#39;smurf-job&#39; =&gt; {
          &#39;link_name&#39; =&gt; {
            &#39;deployment_name&#39; =&gt; &#39;dep1&#39;,
            &#39;networks&#39; =&gt; [&#39;default&#39;],
            &#39;properties&#39; =&gt; {
              &#39;listen_port&#39; =&gt; &#39;Kittens&#39;,
            },
            &#39;address&#39; =&gt; &#39;some.address.com&#39;,
            &#39;instances&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;provider&#39;,
                &#39;index&#39; =&gt; 0,
                &#39;bootstrap&#39; =&gt; true,
                &#39;id&#39; =&gt; &#39;3d46803d-1527-4209-8e1f-822105fece7c&#39;,
                &#39;az&#39; =&gt; &#39;z1&#39;,
                &#39;address&#39; =&gt; &#39;10.244.0.4&#39;,
              }
            ],
            &#39;instance_group&#39; =&gt; &#39;smurf-ig&#39;,
            &#39;default_network&#39; =&gt; &#39;smurf-net&#39;,
            &#39;domain&#39; =&gt; &#39;smurf.bosh&#39;,
            &#39;non-whitelisted-key&#39; =&gt; &#39;some_value&#39;
          }
        }
      }
    end
    let(:smurf_job_links) { links[&#39;smurf-job&#39;] }

    let(:lifecycle) { InstanceGroup::DEFAULT_LIFECYCLE_PROFILE }
    let(:network_spec) do
      { &#39;name&#39; =&gt; &#39;default&#39;, &#39;subnets&#39; =&gt; [{ &#39;cloud_properties&#39; =&gt; { &#39;foo&#39; =&gt; &#39;bar&#39; }, &#39;az&#39; =&gt; &#39;foo-az&#39; }] }
    end
    let(:network) { DynamicNetwork.parse(network_spec, [AvailabilityZone.new(&#39;foo-az&#39;, {})], logger) }
    let(:instance_group) do
      instance_double(
        &#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;,
        name: &#39;fake-job&#39;,
        spec: job_spec,
        canonical_name: &#39;job&#39;,
        instances: [&#39;instance0&#39;],
        default_network: { &#39;gateway&#39; =&gt; &#39;default&#39; },
        vm_type: vm_type,
        vm_extensions: [],
        stemcell: stemcell,
        env: env,
        package_spec: packages,
        persistent_disk_collection: persistent_disk_collection,
        errand?: false,
        compilation?: false,
        update_spec: {},
        properties: properties,
        lifecycle: lifecycle,
        vm_resources: nil,
        vm_strategy: UpdateConfig::VM_STRATEGY_DELETE_CREATE,
      )
    end
    let(:index) { 0 }
    let(:instance_state) do
      {}
    end
    let(:desired_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:instance) do
      instance = Instance.create_from_instance_group(
        instance_group,
        index,
        &#39;started&#39;,
        deployment,
        instance_state,
        availability_zone,
        logger,
      )
      instance.desired_variable_set = desired_variable_set
      instance
    end
    let(:vm_type) { VmType.new(&#39;name&#39; =&gt; &#39;fake-vm-type&#39;) }
    let(:availability_zone) { Bosh::Director::DeploymentPlan::AvailabilityZone.new(&#39;foo-az&#39;, &#39;a&#39; =&gt; &#39;b&#39;) }
    let(:stemcell) { make_stemcell(name: &#39;fake-stemcell-name&#39;, version: &#39;1.0&#39;) }
    let(:env) { Env.new(&#39;key&#39; =&gt; &#39;value&#39;) }
    let(:deployment_name) { &#39;fake-deployment&#39; }
    let(:deployment) { Bosh::Director::Models::Deployment.make(name: deployment_name) }
    let(:instance_model) { Bosh::Director::Models::Instance.make(deployment: deployment, bootstrap: true, uuid: &#39;uuid-1&#39;) }
    let(:instance_plan) do
      InstancePlan.new(existing_instance: nil, desired_instance: DesiredInstance.new(instance_group), instance: instance)
    end
    let(:persistent_disk_collection) { PersistentDiskCollection.new(logger) }

    before do
      allow(Bosh::Director::Links::LinksManager).to receive(:new).and_return(links_manager)

      persistent_disk_collection.add_by_disk_size(0)

      reservation = Bosh::Director::DesiredNetworkReservation.new_dynamic(instance.model, network)
      reservation.resolve_ip(&#39;192.168.0.10&#39;)

      instance_plan.network_plans &lt;&lt; NetworkPlanner::Plan.new(reservation: reservation)
      instance.bind_existing_instance_model(instance_model)
    end

    describe &#39;#as_apply_spec&#39; do
      it &#39;returns a valid instance apply_spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#as_apply_spec)::it#returns a valid instance apply_spec has a flog score of 108</span>          </div>  </li></ol>
        network_name = network_spec[&#39;name&#39;]
        spec = instance_spec.as_apply_spec
        expect(spec[&#39;deployment&#39;]).to eq(&#39;fake-deployment&#39;)
        expect(spec[&#39;name&#39;]).to eq(&#39;fake-job&#39;)
        expect(spec[&#39;job&#39;]).to eq(job_spec)
        expect(spec[&#39;az&#39;]).to eq(&#39;foo-az&#39;)
        expect(spec[&#39;index&#39;]).to eq(index)
        expect(spec[&#39;networks&#39;]).to include(network_name)

        expect(spec[&#39;networks&#39;][network_name]).to eq(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L132" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L171" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;type&#39; =&gt; &#39;dynamic&#39;,
          &#39;cloud_properties&#39; =&gt; network_spec[&#39;subnets&#39;].first[&#39;cloud_properties&#39;],
          &#39;default&#39; =&gt; [&#39;gateway&#39;],
        )

        expect(spec[&#39;packages&#39;]).to eq(packages)
        expect(spec[&#39;persistent_disk&#39;]).to eq(0)
        expect(spec[&#39;configuration_hash&#39;]).to be_nil
        expect(spec[&#39;dns_domain_name&#39;]).to eq(&#39;bosh&#39;)
        expect(spec[&#39;id&#39;]).to eq(&#39;uuid-1&#39;)
      end

      it &#39;includes rendered_templates_archive key after rendered templates were archived&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L145" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L184" class="js-smell-location">1</a>                  </div>  </li></ol>
        instance.rendered_templates_archive =
          Bosh::Director::Core::Templates::RenderedTemplatesArchive.new(&#39;fake-blobstore-id&#39;, &#39;fake-sha1&#39;)

        expect(instance_spec.as_apply_spec[&#39;rendered_templates_archive&#39;]).to eq(
          &#39;blobstore_id&#39; =&gt; &#39;fake-blobstore-id&#39;,
          &#39;sha1&#39; =&gt; &#39;fake-sha1&#39;,
        )
      end

      it &#39;does not include rendered_templates_archive key before rendered templates were archived&#39; do
        expect(instance_spec.as_apply_spec).to_not have_key(&#39;rendered_templates_archive&#39;)
      end
    end

    describe &#39;#as_jobless_apply_spec&#39; do
      it &#39;returns a valid instance apply_spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#as_jobless_apply_spec)::it#returns a valid instance apply_spec has a flog score of 106</span>          </div>  </li></ol>
        network_name = network_spec[&#39;name&#39;]
        spec = instance_spec.as_jobless_apply_spec
        expect(spec[&#39;deployment&#39;]).to eq(&#39;fake-deployment&#39;)
        expect(spec[&#39;name&#39;]).to eq(&#39;fake-job&#39;)
        expect(spec[&#39;job&#39;]).to eq({})
        expect(spec[&#39;az&#39;]).to eq(&#39;foo-az&#39;)
        expect(spec[&#39;index&#39;]) .to eq(index)
        expect(spec[&#39;networks&#39;]).to include(network_name)

        expect(spec[&#39;networks&#39;][network_name]).to eq(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L132" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L171" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;type&#39; =&gt; &#39;dynamic&#39;,
          &#39;cloud_properties&#39; =&gt; network_spec[&#39;subnets&#39;].first[&#39;cloud_properties&#39;],
          &#39;default&#39; =&gt; [&#39;gateway&#39;],
        )

        expect(spec[&#39;packages&#39;]).to eq(packages)
        expect(spec[&#39;persistent_disk&#39;]).to eq(0)
        expect(spec[&#39;configuration_hash&#39;]).to be_nil
        expect(spec[&#39;dns_domain_name&#39;]).to eq(&#39;bosh&#39;)
        expect(spec[&#39;id&#39;]).to eq(&#39;uuid-1&#39;)
      end

      it &#39;includes rendered_templates_archive key after rendered templates were archived&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L145" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L184" class="js-smell-location">1</a>                  </div>  </li></ol>
        instance.rendered_templates_archive =
          Bosh::Director::Core::Templates::RenderedTemplatesArchive.new(&#39;fake-blobstore-id&#39;, &#39;fake-sha1&#39;)

        expect(instance_spec.as_jobless_apply_spec[&#39;rendered_templates_archive&#39;]).to eq(
          &#39;blobstore_id&#39; =&gt; &#39;fake-blobstore-id&#39;,
          &#39;sha1&#39; =&gt; &#39;fake-sha1&#39;,
        )
      end

      it &#39;does not include rendered_templates_archive key before rendered templates were archived&#39; do
        expect(instance_spec.as_jobless_apply_spec).to_not have_key(&#39;rendered_templates_archive&#39;)
      end
    end

    describe &#39;#template_spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe##template_spec has a flog score of 64</span>          </div>  </li></ol>
      let(:variables_interpolator) { double(Bosh::Director::ConfigServer::VariablesInterpolator) }
      let(:expected_links) do
        {
          &#39;smurf-job&#39; =&gt; {
            &#39;link_name&#39; =&gt; {
              &#39;properties&#39; =&gt; {
                &#39;listen_port&#39; =&gt; &#39;Kittens&#39;,
              },
              &#39;address&#39; =&gt; &#39;some.address.com&#39;,
              &#39;instances&#39; =&gt; [{
                &#39;name&#39; =&gt; &#39;provider&#39;,
                &#39;index&#39; =&gt; 0,
                &#39;bootstrap&#39; =&gt; true,
                &#39;id&#39; =&gt; &#39;3d46803d-1527-4209-8e1f-822105fece7c&#39;,
                &#39;az&#39; =&gt; &#39;z1&#39;,
                &#39;address&#39; =&gt; &#39;10.244.0.4&#39;,
              }],
              &#39;instance_group&#39; =&gt; &#39;smurf-ig&#39;,
              &#39;default_network&#39; =&gt; &#39;smurf-net&#39;,
              &#39;deployment_name&#39; =&gt; &#39;dep1&#39;,
              &#39;domain&#39; =&gt; &#39;smurf.bosh&#39;,
            },
          },
        }
      end

      before do
        allow(Bosh::Director::ConfigServer::VariablesInterpolator).to receive(:new).and_return(variables_interpolator)
        allow(variables_interpolator).to receive(:interpolate_template_spec_properties)
          .with(properties, &#39;fake-deployment&#39;, instance.desired_variable_set)
          .and_return(properties)
        allow(variables_interpolator).to receive(:interpolate_link_spec_properties)
          .with(smurf_job_links, instance.desired_variable_set)
          .and_return(smurf_job_links)

        expect(links_manager).to receive(:get_links_for_instance).and_return(links)
      end

      context &#39;links specs whitelisting&#39; do
        it &#39;respects whitelist for links spec&#39; do
          expect(instance_spec.as_template_spec[&#39;links&#39;]).to eq(expected_links)
        end
      end

      context &#39;properties interpolation&#39; do
        let(:properties) do
          {
            &#39;smurf_1&#39; =&gt; &#39;((smurf_placeholder_1))&#39;,
            &#39;smurf_2&#39; =&gt; &#39;((smurf_placeholder_2))&#39;,
          }
        end

        let(:first_link) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L252" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &#39;deployment_name&#39; =&gt; &#39;dep1&#39;,
            &#39;instances&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;v1&#39; }],
            &#39;networks&#39; =&gt; &#39;foo&#39;,
            &#39;properties&#39; =&gt; { &#39;smurf&#39; =&gt; &#39;((smurf_val1))&#39; },
          }
        end

        let(:second_link) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L252" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &#39;deployment_name&#39; =&gt; &#39;dep2&#39;,
            &#39;instances&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;v2&#39; }],
            &#39;networks&#39; =&gt; &#39;foo2&#39;,
            &#39;properties&#39; =&gt; { &#39;smurf&#39; =&gt; &#39;((smurf_val2))&#39; },
          }
        end

        let(:links) do
          {
            &#39;smurf-job&#39; =&gt; {
              &#39;link_1&#39; =&gt; first_link,
              &#39;link_2&#39; =&gt; second_link,
            },
          }
        end

        let(:resolved_properties) do
          {
            &#39;smurf_1&#39; =&gt; &#39;lazy smurf&#39;,
            &#39;smurf_2&#39; =&gt; &#39;happy smurf&#39;,
          }
        end

        let(:resolved_first_link) do
          { &#39;instances&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;v1&#39; }], &#39;properties&#39; =&gt; { &#39;smurf&#39; =&gt; &#39;strong smurf&#39; } }
        end

        let(:resolved_second_link) do
          { &#39;instances&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;v2&#39; }], &#39;properties&#39; =&gt; { &#39;smurf&#39; =&gt; &#39;sleepy smurf&#39; } }
        end

        let(:resolved_links) do
          {
            &#39;smurf-job&#39; =&gt; {
              &#39;link_1&#39; =&gt; resolved_first_link,
              &#39;link_2&#39; =&gt; resolved_second_link,
            },
          }
        end

        let(:resolved_smurf_job_links) { resolved_links[&#39;smurf-job&#39;] }

        it &#39;resolves properties and links properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#template_spec)::context(properties interpolation)::it#resolves properties and links properties has a flog score of 64</span>          </div>  </li></ol>
          expect(variables_interpolator).to receive(:interpolate_template_spec_properties)
            .with(properties, &#39;fake-deployment&#39;, instance.desired_variable_set)
            .and_return(resolved_properties)
          expect(variables_interpolator).to receive(:interpolate_link_spec_properties)
            .with(smurf_job_links, instance.desired_variable_set)
            .and_return(resolved_smurf_job_links)

          spec = instance_spec.as_template_spec
          expect(spec[&#39;properties&#39;]).to eq(resolved_properties)
          expect(spec[&#39;links&#39;]).to eq(resolved_links)
        end
      end

      context &#39;when instance_group has a manual network&#39; do
        let(:subnet_spec) do
          {
            &#39;range&#39; =&gt; &#39;192.168.0.0/24&#39;,
            &#39;gateway&#39; =&gt; &#39;192.168.0.254&#39;,
            &#39;cloud_properties&#39; =&gt; { &#39;foo&#39; =&gt; &#39;bar&#39; },
          }
        end
        let(:subnet) { ManualNetworkSubnet.parse(network_spec[&#39;name&#39;], subnet_spec, [availability_zone], []) }
        let(:network) { ManualNetwork.new(network_spec[&#39;name&#39;], [subnet], logger) }

        it &#39;returns a valid instance template_spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#template_spec)::context(when instance_group has a manual network)::it#returns a valid instance template_spec has a flog score of 145</span>          </div>  </li></ol>
          network_name = network_spec[&#39;name&#39;]
          spec = instance_spec.as_template_spec

          expect(spec[&#39;deployment&#39;]).to eq(&#39;fake-deployment&#39;)
          expect(spec[&#39;name&#39;]).to eq(&#39;fake-job&#39;)
          expect(spec[&#39;job&#39;]).to eq(job_spec)
          expect(spec[&#39;index&#39;]).to eq(index)
          expect(spec[&#39;networks&#39;]).to include(network_name)

          expect(spec[&#39;networks&#39;][network_name]).to include(
            &#39;ip&#39; =&gt; &#39;192.168.0.10&#39;,
            &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
            &#39;cloud_properties&#39; =&gt; { &#39;foo&#39; =&gt; &#39;bar&#39; },
            &#39;dns_record_name&#39; =&gt; &#39;0.smurf-job.default.fake-deployment.bosh&#39;,
            &#39;gateway&#39; =&gt; &#39;192.168.0.254&#39;,
          )

          expect(spec[&#39;persistent_disk&#39;]).to eq(0)
          expect(spec[&#39;configuration_hash&#39;]).to be_nil
          expect(spec[&#39;properties&#39;]).to eq(properties)
          expect(spec[&#39;dns_domain_name&#39;]).to eq(&#39;bosh&#39;)
          expect(spec[&#39;links&#39;]).to eq(expected_links)
          expect(spec[&#39;id&#39;]).to eq(&#39;uuid-1&#39;)
          expect(spec[&#39;az&#39;]).to eq(&#39;foo-az&#39;)
          expect(spec[&#39;bootstrap&#39;]).to eq(true)
          expect(spec[&#39;resource_pool&#39;]).to eq(&#39;fake-vm-type&#39;)
          expect(spec[&#39;address&#39;]).to eq(&#39;192.168.0.10&#39;)
          expect(spec[&#39;ip&#39;]).to eq(&#39;192.168.0.10&#39;)
        end
      end

      context &#39;when instance_group has dynamic network&#39; do
        context &#39;when vm does not have network ip assigned&#39; do
          it &#39;returns a valid instance template_spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#template_spec)::context(when instance_group has dynamic network)::context(when vm does not have network ip assigned)::it#returns a valid instance template_spec has a flog score of 154</span>          </div>  </li></ol>
            network_name = network_spec[&#39;name&#39;]
            spec = instance_spec.as_template_spec
            expect(spec[&#39;deployment&#39;]).to eq(&#39;fake-deployment&#39;)
            expect(spec[&#39;name&#39;]).to eq(&#39;fake-job&#39;)
            expect(spec[&#39;job&#39;]).to eq(job_spec)
            expect(spec[&#39;index&#39;]).to eq(index)
            expect(spec[&#39;networks&#39;]).to include(network_name)

            expect(spec[&#39;networks&#39;][network_name]).to include(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L373" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L418" class="js-smell-location">1</a>                  </div>  </li></ol>
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;ip&#39; =&gt; &#39;127.0.0.1&#39;,
              &#39;netmask&#39; =&gt; &#39;127.0.0.1&#39;,
              &#39;gateway&#39; =&gt; &#39;127.0.0.1&#39;,
              &#39;dns_record_name&#39; =&gt; &#39;0.smurf-job.default.fake-deployment.bosh&#39;,
              &#39;cloud_properties&#39; =&gt; network_spec[&#39;subnets&#39;].first[&#39;cloud_properties&#39;],
            )

            expect(spec[&#39;persistent_disk&#39;]).to eq(0)
            expect(spec[&#39;configuration_hash&#39;]).to be_nil
            expect(spec[&#39;properties&#39;]).to eq(properties)
            expect(spec[&#39;dns_domain_name&#39;]).to eq(&#39;bosh&#39;)
            expect(spec[&#39;links&#39;]).to eq(expected_links)
            expect(spec[&#39;id&#39;]).to eq(&#39;uuid-1&#39;)
            expect(spec[&#39;az&#39;]).to eq(&#39;foo-az&#39;)
            expect(spec[&#39;bootstrap&#39;]).to eq(true)
            expect(spec[&#39;resource_pool&#39;]).to eq(&#39;fake-vm-type&#39;)
            expect(spec[&#39;address&#39;]).to eq(&#39;uuid-1.fake-job.default.fake-deployment.bosh&#39;)
            expect(spec[&#39;ip&#39;]).to eq(nil)
          end
        end
        context &#39;when vm has network ip assigned&#39; do
          let(:instance_state) do
            {
              &#39;networks&#39; =&gt; {
                &#39;default&#39; =&gt; {
                  &#39;type&#39; =&gt; &#39;dynamic&#39;,
                  &#39;ip&#39; =&gt; &#39;192.0.2.19&#39;,
                  &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
                  &#39;gateway&#39; =&gt; &#39;192.0.2.1&#39;,
                },
              },
            }
          end

          it &#39;returns a valid instance template_spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#template_spec)::context(when instance_group has dynamic network)::context(when vm has network ip assigned)::it#returns a valid instance template_spec has a flog score of 162</span>          </div>  </li></ol>
            network_name = network_spec[&#39;name&#39;]
            spec = instance_spec.as_template_spec
            expect(spec[&#39;deployment&#39;]).to eq(&#39;fake-deployment&#39;)
            expect(spec[&#39;name&#39;]).to eq(&#39;fake-job&#39;)
            expect(spec[&#39;job&#39;]).to eq(job_spec)
            expect(spec[&#39;index&#39;]).to eq(index)
            expect(spec[&#39;networks&#39;]).to include(network_name)

            expect(spec[&#39;networks&#39;][network_name]).to include(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_spec_spec.html#L373" class="js-smell-location">0</a>                  <a href="instance_spec_spec.html#L418" class="js-smell-location">1</a>                  </div>  </li></ol>
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;ip&#39; =&gt; &#39;192.0.2.19&#39;,
              &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
              &#39;gateway&#39; =&gt; &#39;192.0.2.1&#39;,
              &#39;dns_record_name&#39; =&gt; &#39;0.smurf-job.default.fake-deployment.bosh&#39;,
              &#39;cloud_properties&#39; =&gt; network_spec[&#39;subnets&#39;].first[&#39;cloud_properties&#39;],
            )

            expect(spec[&#39;persistent_disk&#39;]).to eq(0)
            expect(spec[&#39;configuration_hash&#39;]).to be_nil
            expect(spec[&#39;properties&#39;]).to eq(properties)
            expect(spec[&#39;dns_domain_name&#39;]).to eq(&#39;bosh&#39;)
            expect(spec[&#39;links&#39;]).to eq(expected_links)
            expect(spec[&#39;id&#39;]).to eq(&#39;uuid-1&#39;)
            expect(spec[&#39;az&#39;]).to eq(&#39;foo-az&#39;)
            expect(spec[&#39;bootstrap&#39;]).to eq(true)
            expect(spec[&#39;resource_pool&#39;]).to eq(&#39;fake-vm-type&#39;)
            expect(spec[&#39;address&#39;]).to eq(&#39;uuid-1.fake-job.default.fake-deployment.bosh&#39;)
            expect(spec[&#39;ip&#39;]).to eq(&#39;192.0.2.19&#39;)
          end
        end
      end
    end

    describe &#39;#full_spec&#39; do
      it &#39;return correct json format&#39; do
        expected_spec = {
          &quot;deployment&quot; =&gt; &quot;fake-deployment&quot;,
          &quot;job&quot; =&gt; {
            &quot;name&quot; =&gt; &quot;smurf-job&quot;,
            &quot;release&quot; =&gt; &quot;release&quot;,
            &quot;templates&quot; =&gt; []
          },
          &quot;index&quot; =&gt; 0,
          &quot;bootstrap&quot; =&gt; true,
          &quot;lifecycle&quot; =&gt; &quot;service&quot;,
          &quot;name&quot; =&gt; &quot;fake-job&quot;,
          &quot;id&quot; =&gt; &quot;uuid-1&quot;,
          &quot;az&quot; =&gt; &quot;foo-az&quot;,
          &quot;networks&quot; =&gt; {
            &quot;default&quot; =&gt; {
              &quot;type&quot; =&gt; &quot;dynamic&quot;,
              &quot;cloud_properties&quot; =&gt; {&quot;foo&quot; =&gt; &quot;bar&quot;},
              &quot;default&quot; =&gt; [&quot;gateway&quot;]
            }
          },
          &quot;vm_type&quot; =&gt; {
            &quot;name&quot; =&gt; &quot;fake-vm-type&quot;,
            &quot;cloud_properties&quot; =&gt; {}
          },
          &quot;vm_resources&quot; =&gt; nil,
          &quot;stemcell&quot; =&gt; {
            &quot;name&quot; =&gt; &quot;fake-stemcell-name&quot;,
            &quot;version&quot; =&gt; &quot;1.0&quot;
          },
          &quot;env&quot; =&gt; {&quot;key&quot; =&gt; &quot;value&quot;},
          &quot;packages&quot; =&gt; {
            &quot;pkg&quot; =&gt; {
              &quot;name&quot; =&gt; &quot;package&quot;,
              &quot;version&quot; =&gt; &quot;1.0&quot;
            }
          },
          &quot;properties&quot; =&gt; {&quot;key&quot; =&gt; &quot;value&quot;},
          &quot;properties_need_filtering&quot; =&gt; true,
          &quot;dns_domain_name&quot; =&gt; &quot;bosh&quot;,
          &quot;address&quot; =&gt; &quot;uuid-1.fake-job.default.fake-deployment.bosh&quot;,
          &quot;update&quot; =&gt; {},
          &quot;persistent_disk&quot; =&gt; 0,
          &quot;persistent_disk_pool&quot; =&gt; {
            &quot;name&quot; =&gt; String,
            &quot;disk_size&quot; =&gt; 0,
            &quot;cloud_properties&quot; =&gt; {}
          },
          &quot;persistent_disk_type&quot; =&gt; {
            &quot;name&quot; =&gt; String,
            &quot;disk_size&quot; =&gt; 0,
            &quot;cloud_properties&quot; =&gt; {}
          }
        }
        expect(instance_spec.full_spec).to match(expected_spec)
      end

      context &#39;when CompilationJobs&#39; do
        let(:lifecycle) { nil }
        context &#39;lifecycle is not set&#39; do
          it &quot;contains &#39;nil&#39; for &#39;lifecycle&#39;&quot; do
            expect(instance_spec.full_spec[&#39;lifecycle&#39;]).to be_nil
          end
        end
      end

      InstanceGroup::VALID_LIFECYCLE_PROFILES.each do |lifecycle_value|
        context &quot;when &#39;lifecycle&#39; is set to &#39;#{lifecycle_value}&#39;&quot; do
          let(:lifecycle) { lifecycle_value }

          it &quot;contains &#39;#{lifecycle_value}&#39; for &#39;lifecycle&#39;&quot; do
            expect(instance_spec.full_spec[&#39;lifecycle&#39;]).to eq(lifecycle_value)
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
