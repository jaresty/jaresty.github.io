<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 14:40:48 -0400'>2018-05-31 14:40:48 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> assembler_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">523</span><small> lines of codes</small></div>
              <div><span class="metric">1</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1572.8</span><small> complexity/method</small></div>
              <div><span class="metric">127</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1572.83</span><small> complexity</small></div>
              <div><span class="metric">191</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                33
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe DeploymentPlan::Assembler do
    subject(:assembler) { DeploymentPlan::Assembler.new(deployment_plan, stemcell_manager, powerdns_manager) }
    let(:deployment_plan) do
      instance_double(
        Bosh::Director::DeploymentPlan::Planner,
        name: &#39;simple&#39;,
        using_global_networking?: false,
        skip_drain: BD::DeploymentPlan::AlwaysSkipDrain.new,
        recreate: false,
        model: deployment_model,
        variables: variables,
        features: Bosh::Director::DeploymentPlan::DeploymentFeatures.new,
      )
    end

    let(:variables) { Bosh::Director::DeploymentPlan::Variables.new(nil) }
    let(:deployment_model) {BD::Models::Deployment.make}
    let(:stemcell_manager) {nil}
    let(:powerdns_manager) {PowerDnsManagerProvider.create}
    let(:event_log) {Config.event_log}
    let(:links_manager) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L24" class="js-smell-location">0</a>                  <a href="../instance_group_updater_spec.html#L73" class="js-smell-location">1</a>                  <a href="../instance_group_updater_spec.html#L191" class="js-smell-location">2</a>                  </div>  </li></ol>
      instance_double(Bosh::Director::Links::LinksManager).tap do |double|
        allow(double).to receive(:resolve_deployment_links)
      end
    end
    let(:client_factory) { instance_double(Bosh::Director::ConfigServer::ClientFactory) }
    let(:config_server_client) { instance_double(Bosh::Director::ConfigServer::ConfigServerClient) }

    before do
      allow(Bosh::Director::Links::LinksManager).to receive(:new).and_return(links_manager)
      allow(links_manager).to receive(:update_provider_intents_contents)

      allow(Bosh::Director::ConfigServer::ClientFactory).to receive(:create).and_return(client_factory)
      allow(client_factory).to receive(:create_client).and_return(config_server_client)
      allow(config_server_client).to receive(:generate_values)
    end

    describe &#39;#bind_models&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe##bind_models has a flog score of 132</span>          </div>  </li></ol>
      let(:instance_model) { Models::Instance.make(job: &#39;old-name&#39;) }
      let(:instance_group) { instance_double(DeploymentPlan::InstanceGroup) }

      before do
        allow(deployment_plan).to receive(:instance_models).and_return([instance_model])
        allow(deployment_plan).to receive(:instance_groups).and_return([])
        allow(deployment_plan).to receive(:existing_instances).and_return([])
        allow(deployment_plan).to receive(:candidate_existing_instances).and_return([])
        allow(deployment_plan).to receive(:resource_pools).and_return(nil)
        allow(deployment_plan).to receive(:stemcells).and_return({})
        allow(deployment_plan).to receive(:instance_groups_starting_on_deploy).and_return([])
        allow(deployment_plan).to receive(:releases).and_return([])
        allow(deployment_plan).to receive(:uninterpolated_manifest_hash).and_return({})
        allow(deployment_plan).to receive(:mark_instance_plans_for_deletion)
        allow(deployment_plan).to receive(:deployment_wide_options).and_return({})
        allow(deployment_plan).to receive(:use_dns_addresses?).and_return(false)
        allow(deployment_plan).to receive(:use_short_dns_addresses?).and_return(false)
        allow(deployment_plan).to receive(:randomize_az_placement?).and_return(false)
      end

      it &#39;should bind releases and their templates&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::it#should bind releases and their templates has a flog score of 47</span>          </div>  </li></ol>
        r1 = instance_double(&#39;Bosh::Director::DeploymentPlan::ReleaseVersion&#39;, name: &#39;r1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'r1'</span>          </div>  </li></ol>
        r2 = instance_double(&#39;Bosh::Director::DeploymentPlan::ReleaseVersion&#39;, name: &#39;r2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'r2'</span>          </div>  </li></ol>

        allow(deployment_plan).to receive(:releases).and_return([r1, r2])

        expect(r1).to receive(:bind_model)
        expect(r2).to receive(:bind_model)

        expect(r1).to receive(:bind_templates)
        expect(r2).to receive(:bind_templates)

        expect(assembler).to receive(:with_release_locks).with([&#39;r1&#39;, &#39;r2&#39;]).and_yield
        assembler.bind_models
      end

      context &#39;overriding instances to bind&#39; do
        let(:instance_model_to_override) { instance_double(Models::Instance, job: &#39;override&#39;, vm_cid: &#39;cid&#39;, ignore: false) }

        it &#39;only binds the provided instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(overriding instances to bind)::it#only binds the provided instances has a flog score of 25</span>          </div>  </li></ol>
          agent_state_migrator = instance_double(DeploymentPlan::AgentStateMigrator)
          allow(DeploymentPlan::AgentStateMigrator).to receive(:new).and_return(agent_state_migrator)
          expect(agent_state_migrator).to receive(:get_state).with(instance_model_to_override)

          assembler.bind_models(instances: [instance_model_to_override])
        end
      end

      describe &#39;migrate_legacy_dns_records&#39; do
        it &#39;migrates legacy dns records&#39; do
          expect(powerdns_manager).to receive(:migrate_legacy_records).with(instance_model)
          assembler.bind_models
        end
      end

      it &#39;should bind stemcells&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::it#should bind stemcells has a flog score of 26</span>          </div>  </li></ol>
        sc1 = instance_double(&#39;Bosh::Director::DeploymentPlan::Stemcell&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'sc1'</span>          </div>  </li></ol>
        sc2 = instance_double(&#39;Bosh::Director::DeploymentPlan::Stemcell&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'sc2'</span>          </div>  </li></ol>

        expect(deployment_plan).to receive(:stemcells).and_return({&#39;sc1&#39; =&gt; sc1, &#39;sc2&#39; =&gt; sc2})

        expect(sc1).to receive(:bind_model)
        expect(sc2).to receive(:bind_model)

        assembler.bind_models
      end

      context &#39;contains deployment plan tags&#39; do
        before do
          allow(deployment_plan).to receive(:deployment_wide_options).and_return({
            tags: {&#39;key1&#39; =&gt; &#39;value1&#39;}
          })
        end

        it &#39;passes tags to instance plan factory&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(contains deployment plan tags)::it#passes tags to instance plan factory has a flog score of 25</span>          </div>  </li></ol>
          expected_options = {&#39;recreate&#39; =&gt; false, &#39;tags&#39; =&gt; {&#39;key1&#39; =&gt; &#39;value1&#39;}, &#39;use_dns_addresses&#39; =&gt; false, &#39;use_short_dns_addresses&#39; =&gt; false,&#39;randomize_az_placement&#39; =&gt; false}
          expect(DeploymentPlan::InstancePlanFactory).to receive(:new).with(anything, anything, anything, anything, anything, expected_options).and_call_original
          assembler.bind_models({tags: {&#39;key1&#39; =&gt; &#39;value1&#39;}})
        end
      end

      context &#39;contains deployment use_dns_addresses and randomize_az_placement features&#39; do
        context &#39;when TRUE&#39; do
          before do
            allow(deployment_plan).to receive(:use_dns_addresses?).and_return(true)
            allow(deployment_plan).to receive(:randomize_az_placement?).and_return(true)
          end

          it &#39;passes use_dns_addresses, use_short_dns_addresses and randomize_az_placement feature flags to instance plan factory&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(contains deployment use_dns_addresses and randomize_az_placement features)::context(when TRUE)::it#passes use_dns_addresses, use_short_dns_addresses and randomize_az_placement feature flags to instance plan factory has a flog score of 27</span>          </div>  </li></ol>
            expected_options = {&#39;recreate&#39; =&gt; false, &#39;tags&#39; =&gt; {}, &#39;use_dns_addresses&#39; =&gt; true, &#39;randomize_az_placement&#39; =&gt; true, &#39;use_short_dns_addresses&#39; =&gt; false}
            expect(DeploymentPlan::InstancePlanFactory).to receive(:new).with(anything, anything, anything, anything, anything, expected_options).and_call_original
            assembler.bind_models
          end

          context &#39;contains deployment use_short_dns_addresses feature as TRUE&#39; do
            before do
              allow(deployment_plan).to receive(:use_short_dns_addresses?).and_return(true)
            end

            it &#39;passes use_short_dns_addresses to instance plan factory&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(contains deployment use_dns_addresses and randomize_az_placement features)::context(when TRUE)::context(contains deployment use_short_dns_addresses feature as TRUE)::it#passes use_short_dns_addresses to instance plan factory has a flog score of 28</span>          </div>  </li></ol>
              expected_options = {&#39;recreate&#39; =&gt; false, &#39;tags&#39; =&gt; {}, &#39;use_dns_addresses&#39; =&gt; true, &#39;randomize_az_placement&#39; =&gt; true, &#39;use_short_dns_addresses&#39; =&gt; true}
              expect(DeploymentPlan::InstancePlanFactory).to receive(:new).with(anything, anything, anything, anything, anything, expected_options).and_call_original
              assembler.bind_models
            end
          end
        end

        context &#39;when FALSE&#39; do
          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L150" class="js-smell-location">0</a>                  <a href="../stopper_spec.html#L234" class="js-smell-location">1</a>                  </div>  </li></ol>
            allow(deployment_plan).to receive(:use_dns_addresses?).and_return(false)
            allow(deployment_plan).to receive(:randomize_az_placement?).and_return(false)
          end

          it &#39;passes use_dns_addresses, use_short_dns_addresses and randomize_az_placement to instance plan factory&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(contains deployment use_dns_addresses and randomize_az_placement features)::context(when FALSE)::it#passes use_dns_addresses, use_short_dns_addresses and randomize_az_placement to instance plan factory has a flog score of 27</span>          </div>  </li></ol>
            expected_options = {&#39;recreate&#39; =&gt; false, &#39;tags&#39; =&gt; {}, &#39;use_dns_addresses&#39; =&gt; false, &#39;randomize_az_placement&#39; =&gt; false, &#39;use_short_dns_addresses&#39; =&gt; false}
            expect(DeploymentPlan::InstancePlanFactory).to receive(:new).with(anything, anything, anything, anything, anything, expected_options).and_call_original
            assembler.bind_models
          end
        end
      end

      context &#39;when there are desired instance_groups&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context#when there are desired instance_groups has a flog score of 75</span>          </div>  </li></ol>
        def make_instance_group(name, template_name)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context#make_instance_group has a flog score of 27</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director#make_instance_group has approx 11 statements</span>          </div>  </li></ol>
          instance_group = DeploymentPlan::InstanceGroup.new(logger)
          instance_group.name = name
          instance_group.deployment_name = &#39;simple&#39;
          template_model = Models::Template.make(name: template_name)
          release_version = instance_double(DeploymentPlan::ReleaseVersion)
          allow(release_version).to receive(:get_template_model_by_name).and_return(template_model)
          job = DeploymentPlan::Job.new(release_version, template_name, deployment_plan.name)
          job.bind_models
          instance_group.jobs = [job]
          allow(instance_group).to receive(:validate_package_names_do_not_collide!)
          instance_group
        end

        let(:instance_group_1) { make_instance_group(&#39;ig-1&#39;, &#39;fake-instance-group-1&#39;) }
        let(:instance_group_2) { make_instance_group(&#39;ig-2&#39;, &#39;fake-instance-group-2&#39;) }

        let(:instance_group_network) { double(DeploymentPlan::JobNetwork) }

        before do
          allow(instance_group_network).to receive(:name).and_return(&#39;my-network-name&#39;)
          allow(instance_group_network).to receive(:vip?).and_return(false)
          allow(instance_group_network).to receive(:static_ips)
          allow(instance_group_1).to receive(:networks).and_return([instance_group_network])
          allow(instance_group_2).to receive(:networks).and_return([instance_group_network])

          allow(deployment_plan).to receive(:instance_groups).and_return([instance_group_1, instance_group_2])
          allow(deployment_plan).to receive(:vm_resources_cache)
        end

        it &#39;validates the instance_groups&#39; do
          expect(instance_group_1).to receive(:validate_package_names_do_not_collide!).once
          expect(instance_group_2).to receive(:validate_package_names_do_not_collide!).once

          assembler.bind_models
        end

        context &#39;links binding&#39; do
          let(:resolver_options) do
            { dry_run: false, global_use_dns_entry: boolean }
          end

          let(:provider) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="../api/controllers/link_consumers_controller_spec.html#L74" class="js-smell-location">0</a>                  <a href="../api/controllers/link_consumers_controller_spec.html#L94" class="js-smell-location">1</a>                  <a href="../api/controllers/link_consumers_controller_spec.html#L122" class="js-smell-location">2</a>                  <a href="../api/controllers/link_providers_controller_spec.html#L74" class="js-smell-location">3</a>                  <a href="../api/controllers/link_providers_controller_spec.html#L104" class="js-smell-location">4</a>                  <a href="../api/controllers/links_controller_spec.html#L73" class="js-smell-location">5</a>                  <a href="../api/controllers/links_controller_spec.html#L90" class="js-smell-location">6</a>                  <a href="assembler_spec.html#L206" class="js-smell-location">7</a>                  </div>  </li></ol>
            Models::Links::LinkProvider.make(
              deployment: deployment_model,
              instance_group: &#39;foo-ig&#39;,
              name: &#39;foo-provider&#39;,
              type: &#39;job&#39;
            )
          end

          let(:provider_intent) do
            Models::Links::LinkProviderIntent.make(
              :link_provider =&gt; provider,
              :original_name =&gt; &#39;link_original_name_1&#39;,
              :name =&gt; &#39;link_name_1&#39;,
              :type =&gt; &#39;link_type_1&#39;,
              :shared =&gt; true,
              :consumable =&gt; true,
              :content =&gt; &#39;{}&#39;,
              :metadata =&gt; {&#39;mapped_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;foo&#39;}}.to_json
            )
          end

          let(:link_providers) do
            [provider]
          end

          before do
            allow(deployment_model).to receive(:link_providers).and_return(link_providers)
          end

          it &#39;should bind links by default&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context(links binding)::it#should bind links by default has a flog score of 41</span>          </div>  </li></ol>
            expect(links_manager).to receive(:update_provider_intents_contents).with(link_providers, deployment_plan).ordered
            expect(links_manager).to receive(:resolve_deployment_links).with(deployment_plan.model, resolver_options).ordered

            assembler.bind_models(is_deploy_action: true)
          end

          it &#39;should skip links binding when should_bind_links flag is passed as false&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L243" class="js-smell-location">0</a>                  <a href="assembler_spec.html#L317" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(links_manager).to_not receive(:update_provider_intents_contents)
            expect(links_manager).to_not receive(:resolve_deployment_links)

            assembler.bind_models({:should_bind_links =&gt; false})
          end

          context &#39;when the links are stale&#39; do
            before do
              deployment_model.has_stale_errand_links = true
            end

            it &#39;should clear the errand links stale flag in the end&#39; do
              assembler.bind_models(is_deploy_action: true)

              expect(deployment_model.has_stale_errand_links).to be_falsey
            end
          end
        end

        context &#39;variables are defined for the deployment&#39; do
          let(:variables) do
            Bosh::Director::DeploymentPlan::Variables.new(
              [
                {
                  &#39;name&#39; =&gt; &#39;placeholder_a&#39;,
                  &#39;type&#39; =&gt; &#39;password&#39;,
                },
              ],
            )
          end

          context &#39;when it is a deploy action&#39; do
            let(:converge_variables) do
              false
            end

            before do
              allow(deployment_plan).to receive_message_chain(:features, :converge_variables).and_return(converge_variables)
            end

            it &#39;generates the values through config server&#39; do
              expect(config_server_client).to receive(:generate_values).with(variables, &#39;simple&#39;, false)
              assembler.bind_models(is_deploy_action: true)
            end

            context &#39;when the deployment wants to converge variables&#39; do
              let(:converge_variables) do
                true
              end

              it &#39;should generate the values through config server&#39; do
                expect(config_server_client).to receive(:generate_values).with(variables, &#39;simple&#39;, true)
                assembler.bind_models(is_deploy_action: true)
              end
            end
          end

          context &#39;when it is a NOT a deploy action&#39; do
            it &#39;should NOT generate the variables&#39; do
              expect(config_server_client).to_not receive(:generate_values)
              assembler.bind_models(is_deploy_action: false)
            end
          end
        end

        context &#39;properties binding&#39; do
          it &#39;should bind properties by default&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L310" class="js-smell-location">0</a>                  <a href="stages/update_errands_stage_spec.html#L33" class="js-smell-location">1</a>                  <a href="../jobs/run_errand_spec.html#L281" class="js-smell-location">2</a>                  <a href="../jobs/scheduled_backup_spec.html#L47" class="js-smell-location">3</a>                  <a href="../jobs/update_release_spec.html#L329" class="js-smell-location">4</a>                  </div>  </li></ol>
            expect(instance_group_1).to receive(:bind_properties)
            expect(instance_group_2).to receive(:bind_properties)

            assembler.bind_models
          end

          it &#39;should skip links binding when should_bind_properties flag is passed as false&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L243" class="js-smell-location">0</a>                  <a href="assembler_spec.html#L317" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(instance_group_1).to_not receive(:bind_properties)
            expect(instance_group_2).to_not receive(:bind_properties)

            assembler.bind_models({:should_bind_properties =&gt; false})
          end
        end

        context &#39;variable sets binding&#39; do
          before do
            deployment_plan.model.add_variable_set(:created_at =&gt; Time.now, :writable =&gt; true)
          end

          context &#39;when should_bind_new_variable_set flag is false&#39; do
            let(:should_bind_new_variable_set) { false }

            it &#39;should not bind the instance plans variable sets&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L333" class="js-smell-location">0</a>                  <a href="assembler_spec.html#L346" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context(variable sets binding)::context(when should_bind_new_variable_set flag is false)::it#should not bind the instance plans variable sets has a flog score of 34</span>          </div>  </li></ol>
              current_deployment_variable_set = deployment_plan.model.current_variable_set

              expect(instance_group_1).to_not receive(:bind_new_variable_set).with(current_deployment_variable_set)
              expect(instance_group_2).to_not receive(:bind_new_variable_set).with(current_deployment_variable_set)

              assembler.bind_models({:should_bind_new_variable_set =&gt; should_bind_new_variable_set})
            end
          end

          context &#39;when bind_new_variable_set flag is true&#39; do
            let(:should_bind_new_variable_set) { true }

            it &#39;binds the instance plans variable sets correctly&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L333" class="js-smell-location">0</a>                  <a href="assembler_spec.html#L346" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context(variable sets binding)::context(when bind_new_variable_set flag is true)::it#binds the instance plans variable sets correctly has a flog score of 34</span>          </div>  </li></ol>
              current_deployment_variable_set = deployment_plan.model.current_variable_set

              expect(instance_group_1).to receive(:bind_new_variable_set).with(current_deployment_variable_set)
              expect(instance_group_2).to receive(:bind_new_variable_set).with(current_deployment_variable_set)

              assembler.bind_models({:should_bind_new_variable_set =&gt; should_bind_new_variable_set})
            end
          end

          context &#39;when bind_new_variable_set flag is not passed&#39; do
            it &#39;defaults value to false&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context(variable sets binding)::context(when bind_new_variable_set flag is not passed)::it#defaults value to false has a flog score of 30</span>          </div>  </li></ol>
              current_deployment_variable_set = deployment_plan.model.current_variable_set

              expect(instance_group_1).to_not receive(:bind_new_variable_set).with(current_deployment_variable_set)
              expect(instance_group_2).to_not receive(:bind_new_variable_set).with(current_deployment_variable_set)

              assembler.bind_models
            end
          end
        end

        context &#39;when the instance_group validation fails&#39; do
          it &#39;propagates the exception&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context(when the instance_group validation fails)::it#propagates the exception has a flog score of 31</span>          </div>  </li></ol>
            expect(instance_group_1).to receive(:validate_package_names_do_not_collide!).once
            expect(instance_group_2).to receive(:validate_package_names_do_not_collide!).once.and_raise(&#39;Unable to deploy manifest&#39;)

            expect { assembler.bind_models }.to raise_error(&#39;Unable to deploy manifest&#39;)
          end
        end

        context &#39;when there is an instance to create-swap-delete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context#when there is an instance to create-swap-delete has a flog score of 123</span>          </div>  </li></ol>
          let(:instance_planner) { double(DeploymentPlan::InstancePlanner) }
          let(:existing_network_plan1) { DeploymentPlan::NetworkPlanner::Plan.new(reservation: anything, existing: true) }
          let(:existing_network_plan2) { DeploymentPlan::NetworkPlanner::Plan.new(reservation: anything, existing: true) }
          let(:instance_model) { Bosh::Director::Models::Instance.make(ignore: false) }
          let(:create_swap_delete_instance) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L382" class="js-smell-location">0</a>                  <a href="assembler_spec.html#L387" class="js-smell-location">1</a>                  </div>  </li></ol>
            instance_double(DeploymentPlan::Instance, model: instance_model).tap do |instance|
              expect(instance).to receive(:is_deploy_action=)
            end
          end
          let(:not_create_swap_delete_instance) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="assembler_spec.html#L382" class="js-smell-location">0</a>                  <a href="assembler_spec.html#L387" class="js-smell-location">1</a>                  </div>  </li></ol>
            instance_double(DeploymentPlan::Instance, model: instance_model).tap do |instance|
              expect(instance).to receive(:is_deploy_action=)
            end
          end
          let(:network) { instance_double(DeploymentPlan::Network, name: &#39;network&#39;) }
          let(:create_swap_delete_instance_plan) do
            DeploymentPlan::InstancePlan.new(existing_instance: instance_model, desired_instance: anything, instance: create_swap_delete_instance)
          end
          let(:not_create_swap_delete_instance_plan) do
            DeploymentPlan::InstancePlan.new(existing_instance: instance_model, desired_instance: anything, instance: not_create_swap_delete_instance)
          end

          before do
            create_swap_delete_instance_plan.network_plans &lt;&lt; existing_network_plan1
            not_create_swap_delete_instance_plan.network_plans &lt;&lt; existing_network_plan2

            allow(DeploymentPlan::InstancePlanner).to receive(:new).and_return(instance_planner)
            allow(instance_planner).to receive(:plan_instance_group_instances).and_return(create_swap_delete_instance_plan)
            allow(instance_planner).to receive(:orphan_unreusable_vms)
            allow(instance_planner).to receive(:reconcile_network_plans)
            allow(instance_planner).to receive(:plan_obsolete_instance_groups)
            allow(create_swap_delete_instance_plan).to receive(:should_create_swap_delete?).and_return(true)
            allow(not_create_swap_delete_instance_plan).to receive(:should_create_swap_delete?).and_return(false)
            allow(instance_group_network).to receive(:deployment_network).and_return(network)
            allow(instance_group_1).to receive(:sorted_instance_plans).and_return([create_swap_delete_instance_plan])
            allow(instance_group_2).to receive(:sorted_instance_plans).and_return([not_create_swap_delete_instance_plan])
          end

          context &#39;and it should be recreated for a non network reason&#39; do
            before do
              allow(create_swap_delete_instance_plan).to receive(:recreate_for_non_network_reasons?).and_return(true)
            end

            it &#39;creates a desired network reservation for each existing reservation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context(when there is an instance to create-swap-delete)::context(and it should be recreated for a non network reason)::it#creates a desired network reservation for each existing reservation has a flog score of 118</span>          </div>  </li></ol>
              assembler.bind_models

              expect(create_swap_delete_instance_plan.network_plans.size).to eq(2)
              expect(existing_network_plan1.obsolete?).to eq(true)
              expect(existing_network_plan1.existing?).to eq(false)
              expect(
                create_swap_delete_instance_plan.network_plans.map(&amp;:reservation),
              ).to include(a_kind_of(DesiredNetworkReservation))

              expect(not_create_swap_delete_instance_plan.network_plans.size).to eq(1)
              expect(existing_network_plan2.obsolete?).to eq(false)
              expect(existing_network_plan2.existing?).to eq(true)
              expect(
                not_create_swap_delete_instance_plan.network_plans.map(&amp;:reservation),
              ).to_not include(a_kind_of(DesiredNetworkReservation))
            end
          end

          context &#39;and it should not be recreated&#39; do
            before do
              allow(create_swap_delete_instance_plan).to receive(:recreate_for_non_network_reasons?).and_return(false)
            end

            it &#39;it does not change the network plan&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when there are desired instance_groups)::context(when there is an instance to create-swap-delete)::context(and it should not be recreated)::it#it does not change the network plan has a flog score of 118</span>          </div>  </li></ol>
              assembler.bind_models

              expect(create_swap_delete_instance_plan.network_plans.size).to eq(1)
              expect(existing_network_plan1.obsolete?).to eq(false)
              expect(existing_network_plan1.existing?).to eq(true)
              expect(
                create_swap_delete_instance_plan.network_plans.map(&amp;:reservation),
              ).to_not include(a_kind_of(DesiredNetworkReservation))

              expect(not_create_swap_delete_instance_plan.network_plans.size).to eq(1)
              expect(existing_network_plan2.obsolete?).to eq(false)
              expect(existing_network_plan2.existing?).to eq(true)
              expect(
                not_create_swap_delete_instance_plan.network_plans.map(&amp;:reservation),
              ).to_not include(a_kind_of(DesiredNetworkReservation))
            end
          end
        end
      end

      it &#39;configures dns&#39; do
        expect(powerdns_manager).to receive(:configure_nameserver)
        assembler.bind_models
      end

      context &#39;when agent get_state raises an error&#39; do
        [RpcTimeout, RpcRemoteException].each do |error|
          context &quot;and the error is an #{error}&quot; do
            let(:instance_model_to_override) { instance_double(Models::Instance, name: &#39;TestInstance/TestUUID&#39;, uuid: &#39;TestUUID&#39;, job: &#39;override&#39;, vm_cid: &#39;cid&#39;, ignore: false) }

            context &#39;when fix is specified&#39; do

              before do
                allow(deployment_plan).to receive(:deployment_wide_options).and_return(fix: true)
              end

              it &#39;handles it&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when agent get_state raises an error)::context(when fix is specified)::it#handles it has a flog score of 34</span>          </div>  </li></ol>
                agent_state_migrator = instance_double(DeploymentPlan::AgentStateMigrator)
                allow(DeploymentPlan::AgentStateMigrator).to receive(:new).and_return(agent_state_migrator)
                expect(agent_state_migrator).to receive(:get_state).and_raise(error)

                expect {
                  assembler.bind_models(instances: [instance_model_to_override])
                }.not_to raise_error

              end
            end

            context &#39;when fix is not specified&#39; do
              it &#39;enhances error message&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#bind_models)::context(when agent get_state raises an error)::context(when fix is not specified)::it#enhances error message has a flog score of 37</span>          </div>  </li></ol>
                agent_state_migrator = instance_double(DeploymentPlan::AgentStateMigrator)
                allow(DeploymentPlan::AgentStateMigrator).to receive(:new).and_return(agent_state_migrator)
                expect(agent_state_migrator).to receive(:get_state).and_raise(error, &#39;initial error&#39;)


                expect {
                  assembler.bind_models(instances: [instance_model_to_override])
                }.to raise_error error, &quot;#{instance_model_to_override.name}: initial error&quot;
              end
            end
          end
        end
      end
    end

    describe &#39;.create&#39; do
      it &#39;initializes a DeploymentPlan::Assembler with the correct deployment_plan and makes stemcell and dns managers&#39; do
        expect(DeploymentPlan::Assembler).to receive(:new).with(
          deployment_plan,
          an_instance_of(Api::StemcellManager),
          an_instance_of(PowerDnsManager),
        ).and_call_original

        DeploymentPlan::Assembler.create(deployment_plan)
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
