<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan/stages /</small> package_compile_stage_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">864</span><small> lines of codes</small></div>
              <div><span class="metric">5</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">429.5</span><small> complexity/method</small></div>
              <div><span class="metric">227</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2147.72</span><small> complexity</small></div>
              <div><span class="metric">384</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                43
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe DeploymentPlan::Stages::PackageCompileStage do
    include Support::StemcellHelpers

    let(:job) { double(&#39;job&#39;).as_null_object }
    let(:cloud) { instance_double(Bosh::Clouds::ExternalCpi) }
    let(:vm_deleter) { VmDeleter.new(Config.logger, false, false) }
    let(:agent_broadcaster) { AgentBroadcaster.new }
    let(:dns_encoder) { instance_double(DnsEncoder) }
    let(:vm_creator) { VmCreator.new(Config.logger, template_blob_cache, dns_encoder, agent_broadcaster) }
    let(:template_blob_cache) { instance_double(Bosh::Director::Core::Templates::TemplateBlobCache) }
    let(:release_version_model) { Models::ReleaseVersion.make(version: &#39;new&#39;) }
    let(:reuse_compilation_vms) { false }
    let(:number_of_workers) { 3 }
    let(:compilation_config) do
      compilation_spec = {
        &#39;workers&#39; =&gt; number_of_workers,
        &#39;network&#39; =&gt; &#39;default&#39;,
        &#39;env&#39; =&gt; {},
        &#39;cloud_properties&#39; =&gt; {},
        &#39;reuse_compilation_vms&#39; =&gt; reuse_compilation_vms,
        &#39;az&#39; =&gt; &#39;&#39;,
      }
      DeploymentPlan::CompilationConfig.new(compilation_spec, {}, [])
    end
    let(:deployment) { Models::Deployment.make(name: &#39;mycloud&#39;) }
    let(:plan) do
      instance_double(&#39;Bosh::Director::DeploymentPlan::Planner&#39;,
        compilation: compilation_config,
        model: deployment,
        name: &#39;mycloud&#39;,
        ip_provider: ip_provider,
        recreate: false,
        tags: {}
      )
    end
    let(:instance_reuser) { InstanceReuser.new }
    let(:instance_deleter) { instance_double(Bosh::Director::InstanceDeleter) }
    let(:ip_provider) { instance_double(DeploymentPlan::IpProvider, reserve: nil, release: nil) }
    let(:instance_provider) { DeploymentPlan::InstanceProvider.new(plan, vm_creator, logger) }
    let(:compilation_instance_pool) do
      DeploymentPlan::CompilationInstancePool.new(
        instance_reuser,
        instance_provider,
        logger,
        instance_deleter,
        compilation_config,
      )
    end
    let(:thread_pool) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../compilation_instance_pool_spec.html#L123" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L52" class="js-smell-location">1</a>                  </div>  </li></ol>
      thread_pool = instance_double(&#39;Bosh::Director::ThreadPool&#39;)
      allow(thread_pool).to receive(:wrap).and_yield(thread_pool)
      allow(thread_pool).to receive(:process).and_yield
      allow(thread_pool).to receive(:working?).and_return(false)
      thread_pool
    end
    let(:network) { instance_double(&#39;Bosh::Director::DeploymentPlan::Network&#39;, name: &#39;default&#39;, network_settings: {&#39;network_name&#39; =&gt;{&#39;property&#39; =&gt; &#39;settings&#39;}}) }
    let(:net) do
      { &#39;default&#39; =&gt; { &#39;network_name&#39; =&gt; { &#39;property&#39; =&gt; &#39;settings&#39; } } }
    end
    let(:event_manager) {Api::EventManager.new(true)}
    let(:job_task) { Bosh::Director::Models::Task.make(:id =&gt; 42, :username =&gt; &#39;user&#39;)}
    let(:task_writer) {Bosh::Director::TaskDBWriter.new(:event_output, job_task.id)}
    let(:event_log) {Bosh::Director::EventLog::Log.new(task_writer)}
    let(:update_job) {instance_double(Bosh::Director::Jobs::UpdateDeployment, username: &#39;user&#39;, task_id: job_task.id, event_manager: event_manager)}<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 9 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L67" class="js-smell-location">0</a>                  <a href="../../jobs/cleanup_artifacts_spec.html#L8" class="js-smell-location">1</a>                  <a href="../../jobs/delete_orphan_disks_spec.html#L7" class="js-smell-location">2</a>                  <a href="../../jobs/delete_vm_spec.html#L21" class="js-smell-location">3</a>                  <a href="../../jobs/orphan_disk_spec.html#L18" class="js-smell-location">4</a>                  <a href="../../jobs/scheduled_orphaned_disk_cleanup_spec.html#L26" class="js-smell-location">5</a>                  <a href="../../links/links_manager_spec.html#L12" class="js-smell-location">6</a>                  <a href="../../orphan_disk_manager_spec.html#L30" class="js-smell-location">7</a>                  <a href="../../problem_resolver_spec.html#L6" class="js-smell-location">8</a>                  </div>  </li></ol>
    let(:expected_groups) do
      [
        &#39;fake-director-name&#39;,
        &#39;mycloud&#39;,
        &#39;compilation-deadbeef&#39;,
        &#39;fake-director-name-mycloud&#39;,
        &#39;mycloud-compilation-deadbeef&#39;,
        &#39;fake-director-name-mycloud-compilation-deadbeef&#39;,
      ]
    end
    let(:initial_state) do
      {
        &#39;deployment&#39; =&gt; &#39;mycloud&#39;,
        &#39;job&#39; =&gt; {
          &#39;name&#39; =&gt; &#39;compilation-deadbeef&#39;,
        },
        &#39;index&#39; =&gt; 0,
        &#39;id&#39; =&gt; &#39;deadbeef&#39;,
        &#39;networks&#39; =&gt; net,
      }
    end

    before do
      Bosh::Director::Models::VariableSet.make(deployment: deployment)

      allow(ThreadPool).to receive_messages(new: thread_pool) # Using threads for real, even accidentally, makes debugging a nightmare

      allow(instance_deleter).to receive(:delete_instance_plan)

      @director_job = instance_double(&#39;Bosh::Director::Jobs::BaseJob&#39;)
      allow(@director_job).to receive(:task_cancelled?).and_return(false)
      allow(Config).to receive(:current_job).and_return(@director_job)

      allow(plan).to receive(:network).with(&#39;default&#39;).and_return(network)

      allow(Config).to receive(:use_compiled_package_cache?).and_return(false)

      allow(Config).to receive(:current_job).and_return(update_job)
      allow(Config).to receive(:name).and_return(&#39;fake-director-name&#39;)
      allow(Config).to receive(:cloud_options).and_return({&#39;provider&#39; =&gt; {&#39;path&#39; =&gt; &#39;/path/to/default/cpi&#39;}})
      allow(Bosh::Director::Config).to receive(:event_log).and_return(event_log)
      allow(cloud).to receive(:info)
      allow(cloud).to receive(:request_cpi_api_version=)
      allow(cloud).to receive(:request_cpi_api_version)
      allow(Bosh::Clouds::ExternalCpi).to receive(:new).and_return(cloud)
      @all_packages = []
    end

    def make_package(name, deps = [], version = &#39;0.1-dev&#39;)
      package = Models::Package.make(name: name, version: version)
      package.dependency_set = deps<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#make_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L118" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L119" class="js-smell-location">1</a>                  </div>  </li></ol>
      package.save<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#make_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L118" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L119" class="js-smell-location">1</a>                  </div>  </li></ol>
      @all_packages &lt;&lt; package
      package
    end

    def make_compiled(release_version_model, package, stemcell, sha1 = &#39;deadbeef&#39;, blobstore_id = &#39;deadcafe&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Bosh::Director#make_compiled has 5 parameters</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Parameter-Name.md" target="_blank"><b>UncommunicativeParameterName</b></a>        </span>      </div>      <span>Bosh::Director#make_compiled has the parameter name 'sha1'</span>          </div>  </li></ol>
      transitive_dependencies = PackageDependenciesManager.new(release_version_model).transitive_dependencies(package)
      package_dependency_key = KeyGenerator.new.dependency_key_from_models(package, release_version_model)
      package_cache_key = Models::CompiledPackage.create_cache_key(package, transitive_dependencies, stemcell.sha1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#make_compiled refers to 'stemcell' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L127" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L133" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L134" class="js-smell-location">2</a>                  </div>  </li></ol>

      CompileTask.new(package, stemcell, job, package_dependency_key, package_cache_key)

      Models::CompiledPackage.make(package: package,
        dependency_key: package_dependency_key,
        stemcell_os: stemcell.operating_system,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#make_compiled refers to 'stemcell' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L127" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L133" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L134" class="js-smell-location">2</a>                  </div>  </li></ol>
        stemcell_version: stemcell.version,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#make_compiled refers to 'stemcell' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L127" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L133" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L134" class="js-smell-location">2</a>                  </div>  </li></ol>
        build: 1,
        sha1: sha1,
        blobstore_id: blobstore_id)
    end

    def prepare_samples<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director#prepare_samples has a flog score of 54</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director#prepare_samples has approx 28 statements</span>          </div>  </li></ol>
      @release = instance_double(&#39;Bosh::Director::DeploymentPlan::ReleaseVersion&#39;, name: &#39;cf-release&#39;, model: release_version_model, version: &#39;new&#39;)
      @release_model = Bosh::Director::Models::Release.make(name: @release.name)
      @release_model.add_version(release_version_model)
      @stemcell_a = make_stemcell(operating_system: &#39;chrome-os&#39;, version: &#39;3146.1&#39;)
      @stemcell_b = make_stemcell(operating_system: &#39;chrome-os&#39;, version: &#39;3146.2&#39;)

      @p_common = make_package(&#39;common&#39;)
      @p_syslog = make_package(&#39;p_syslog&#39;)
      @p_dea = make_package(&#39;dea&#39;, %w(ruby common))
      @p_ruby = make_package(&#39;ruby&#39;, %w(common))
      @p_warden = make_package(&#39;warden&#39;, %w(common))
      @p_nginx = make_package(&#39;nginx&#39;, %w(common))
      @p_router = make_package(&#39;p_router&#39;, %w(ruby common))
      @p_deps_ruby = make_package(&#39;needs_ruby&#39;, %w(ruby))

      vm_type_large = instance_double(&#39;Bosh::Director::DeploymentPlan::VmType&#39;, name: &#39;large&#39;)
      vm_type_small = instance_double(&#39;Bosh::Director::DeploymentPlan::VmType&#39;, name: &#39;small&#39;)

      @t_dea = instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, release: @release, package_models: [@p_dea, @p_nginx, @p_syslog], name: &#39;dea&#39;)

      @t_warden = instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, release: @release, package_models: [@p_warden], name: &#39;warden&#39;)

      @t_nginx = instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, release: @release, package_models: [@p_nginx], name: &#39;nginx&#39;)

      @t_router = instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, release: @release, package_models: [@p_router], name: &#39;router&#39;)

      @t_deps_ruby = instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, release: @release, package_models: [@p_deps_ruby], name: &#39;needs_ruby&#39;)

      @j_dea = instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;,
        name: &#39;dea&#39;,
        release: @release,
        jobs: [@t_dea, @t_warden],
        vm_type: vm_type_large,
        stemcell: @stemcell_a
      )

      @j_router = instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;,
        name: &#39;router&#39;,
        release: @release,
        jobs: [@t_nginx, @t_router, @t_warden],
        vm_type: vm_type_small,
        stemcell: @stemcell_b
      )

      @j_deps_ruby = instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;,
        name: &#39;needs_ruby&#39;,
        release: @release,
        jobs: [@t_deps_ruby],
        vm_type: vm_type_small,
        stemcell: @stemcell_b
      )

      @package_set_a = [@p_dea, @p_nginx, @p_syslog, @p_warden, @p_common, @p_ruby]

      @package_set_b = [@p_nginx, @p_common, @p_router, @p_warden, @p_ruby]

      @package_set_c = [@p_deps_ruby]

      (@package_set_a + @package_set_b + @package_set_c).each do |package|
        release_version_model.packages &lt;&lt; package
      end
    end

    def compile_package_stub(args)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub has a flog score of 42</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub has approx 8 statements</span>          </div>  </li></ol>
      name = args[2]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L205" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">2</a>                  <a href="package_compile_stage_spec.html#L210" class="js-smell-location">3</a>                  <a href="package_compile_stage_spec.html#L211" class="js-smell-location">4</a>                  <a href="package_compile_stage_spec.html#L213" class="js-smell-location">5</a>                  </div>  </li></ol>
      dot = args[3].rindex(&#39;.&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub calls 'args[3]' 3 times</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L205" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">2</a>                  <a href="package_compile_stage_spec.html#L210" class="js-smell-location">3</a>                  <a href="package_compile_stage_spec.html#L211" class="js-smell-location">4</a>                  <a href="package_compile_stage_spec.html#L213" class="js-smell-location">5</a>                  </div>  </li></ol>
      version, build = args[3][0..dot-1], args[3][dot+1..-1]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L591" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub calls 'args[3]' 3 times</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L205" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">2</a>                  <a href="package_compile_stage_spec.html#L210" class="js-smell-location">3</a>                  <a href="package_compile_stage_spec.html#L211" class="js-smell-location">4</a>                  <a href="package_compile_stage_spec.html#L213" class="js-smell-location">5</a>                  </div>  </li></ol>

      package = Models::Package.find(name: name, version: version)
      expect(args[0]).to eq(package.blobstore_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L205" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">2</a>                  <a href="package_compile_stage_spec.html#L210" class="js-smell-location">3</a>                  <a href="package_compile_stage_spec.html#L211" class="js-smell-location">4</a>                  <a href="package_compile_stage_spec.html#L213" class="js-smell-location">5</a>                  </div>  </li></ol>
      expect(args[1]).to eq(package.sha1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L205" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">2</a>                  <a href="package_compile_stage_spec.html#L210" class="js-smell-location">3</a>                  <a href="package_compile_stage_spec.html#L211" class="js-smell-location">4</a>                  <a href="package_compile_stage_spec.html#L213" class="js-smell-location">5</a>                  </div>  </li></ol>

      expect(args[4]).to be_a(Hash)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub refers to 'args' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L205" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L206" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">2</a>                  <a href="package_compile_stage_spec.html#L210" class="js-smell-location">3</a>                  <a href="package_compile_stage_spec.html#L211" class="js-smell-location">4</a>                  <a href="package_compile_stage_spec.html#L213" class="js-smell-location">5</a>                  </div>  </li></ol>

      {
        &#39;result&#39; =&gt; {
          &#39;sha1&#39; =&gt; &quot;compiled #{package.id}&quot;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub calls 'package.id' 2 times</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L217" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L218" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;blobstore_id&#39; =&gt; &quot;blob #{package.id}&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director#compile_package_stub calls 'package.id' 2 times</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L217" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L218" class="js-smell-location">1</a>                  </div>  </li></ol>
        }
      }
    end

    context &#39;when all needed packages are compiled&#39; do
      it &quot;doesn&#39;t perform any compilation&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when all needed packages are compiled)::it#doesn't perform any compilation has a flog score of 81</span>          </div>  </li></ol>
        prepare_samples

        @package_set_a.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L227" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L232" class="js-smell-location">1</a>                  </div>  </li></ol>
          cp1 = make_compiled(release_version_model, package, @stemcell_a.models.first)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'cp1'</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L228" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L341" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L384" class="js-smell-location">2</a>                  </div>  </li></ol>
          expect(@j_dea).to receive(:use_compiled_package).with(cp1)
        end

        @package_set_b.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L227" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L232" class="js-smell-location">1</a>                  </div>  </li></ol>
          cp2 = make_compiled(release_version_model, package, @stemcell_b.models.first)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'cp2'</span>          </div>  </li></ol>
          expect(@j_router).to receive(:use_compiled_package).with(cp2)
        end

        compiler = DeploymentPlan::Stages::PackageCompileStage.new(
          deployment.name,
          [@j_dea, @j_router],
          compilation_config,
          compilation_instance_pool,
          logger,
          nil
        )

        compiler.perform
        # For @stemcell_a we need to compile:
        # [p_dea, p_nginx, p_syslog, p_warden, p_common, p_ruby] = 6
        # For @stemcell_b:
        # [p_nginx, p_common, p_router, p_ruby, p_warden] = 5
        expect(compiler.compile_tasks_count).to eq(6 + 5)
        # But they are already compiled!
        expect(compiler.compilations_performed).to eq(0)

        expect(log_string).to include(&quot;Job templates &#39;cf-release/dea&#39;, &#39;cf-release/warden&#39; need to run on stemcell &#39;#{@stemcell_a.desc}&#39;&quot;)
        expect(log_string).to include(&quot;Job templates &#39;cf-release/nginx&#39;, &#39;cf-release/router&#39;, &#39;cf-release/warden&#39; need to run on stemcell &#39;#{@stemcell_b.desc}&#39;&quot;)
      end
    end

    context &#39;when none of the packages are compiled&#39; do
      it &#39;compiles all packages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when none of the packages are compiled)::it#compiles all packages has a flog score of 186</span>          </div>  </li></ol>
        prepare_samples

        compiler = DeploymentPlan::Stages::PackageCompileStage.new(
          deployment.name,
          [@j_dea, @j_router],
          compilation_config,
          compilation_instance_pool,
          logger,
          @director_job
        )

        expect(vm_creator).to receive(:create_for_instance_plan).exactly(11).times

        metadata_updater = instance_double(&#39;Bosh::Director::MetadataUpdater&#39;, update_vm_metadata: nil)

        allow(Bosh::Director::MetadataUpdater).to receive_messages(build: metadata_updater)
        expect(metadata_updater).to receive(:update_vm_metadata).with(anything, anything, {compiling: &#39;common&#39;})
        expect(metadata_updater).to receive(:update_vm_metadata).with(anything, anything, hash_including(:compiling)).exactly(10).times

        agent_client = instance_double(&#39;Bosh::Director::AgentClient&#39;)
        allow(BD::AgentClient).to receive(:with_agent_id).and_return(agent_client)
        expect(agent_client).to receive(:compile_package).exactly(11).times do |*args|
          compile_package_stub(args)
        end

        @package_set_a.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L287" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L291" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L622" class="js-smell-location">2</a>                  </div>  </li></ol>
          expect(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{@stemcell_a.os}/#{@stemcell_a.version}&quot;, deployment.name).and_yield
        end

        @package_set_b.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L287" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L291" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L622" class="js-smell-location">2</a>                  </div>  </li></ol>
          expect(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{@stemcell_b.os}/#{@stemcell_b.version}&quot;, deployment.name).and_yield
        end

        expect(@j_dea).to receive(:use_compiled_package).exactly(6).times
        expect(@j_router).to receive(:use_compiled_package).exactly(5).times

        expect(instance_deleter).to receive(:delete_instance_plan).exactly(11).times

        expect(@director_job).to receive(:task_checkpoint).once

        compiler.perform
        expect(compiler.compilations_performed).to eq(11)

        @package_set_a.each do |package|
          expect(package.compiled_packages.size).to be &gt;= 1
        end

        @package_set_b.each do |package|
          expect(package.compiled_packages.size).to be &gt;= 1
        end
      end
    end

    context &#39;when there are compiled packages with the same major version number but different patch number&#39; do

      before do
        prepare_samples

        @j_dea = instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L320" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L409" class="js-smell-location">1</a>                  </div>  </li></ol>
          name: &#39;dea&#39;,
          release: @release,
          jobs: [@t_dea, @t_warden],
          vm_type: @vm_type_large,
          stemcell: @stemcell_b
        )
      end

      context &#39;and we are using a source release&#39; do
        it &#39;compiles all packages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when there are compiled packages with the same major version number but different patch number)::context(and we are using a source release)::it#compiles all packages has a flog score of 129</span>          </div>  </li></ol>
          compiler = DeploymentPlan::Stages::PackageCompileStage.new(
            deployment.name,
            [@j_dea],
            compilation_config,
            compilation_instance_pool,
            logger,
            @director_job
          )

          @package_set_a.each do |package|
            cp1 = make_compiled(release_version_model, package, @stemcell_a.models.first)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'cp1'</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L228" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L341" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L384" class="js-smell-location">2</a>                  </div>  </li></ol>
            expect(@j_dea).not_to receive(:use_compiled_package).with(cp1)
            expect(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{@stemcell_b.os}/#{@stemcell_b.version}&quot;, deployment.name).and_yield
          end

          expect(vm_creator).to receive(:create_for_instance_plan).exactly(6).times do |instance_plan|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L346" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L580" class="js-smell-location">1</a>                  </div>  </li></ol>
            # metadata_updater is called for every package compilation, and it expects there to be an active_vm
            instance_plan.instance.model.active_vm = Models::Vm.make(cid: instance_plan.instance.model.id, instance: instance_plan.instance.model)
          end

          agent_client = instance_double(&#39;Bosh::Director::AgentClient&#39;)
          allow(BD::AgentClient).to receive(:with_agent_id).and_return(agent_client)
          expect(agent_client).to receive(:compile_package).exactly(6).times do |*args|
            compile_package_stub(args)
          end

          expect(@director_job).to receive(:task_checkpoint).once

          compiler.perform
          # For @stemcell_b we need to compile:
          # [p_dea, p_nginx, p_syslog, p_warden, p_common, p_ruby] = 6
          expect(compiler.compile_tasks_count).to eq(6)
          # and they should be recompiled
          expect(compiler.compilations_performed).to eq(6)

          expect(log_string).to include(&quot;Job templates &#39;cf-release/dea&#39;, &#39;cf-release/warden&#39; need to run on stemcell &#39;#{@stemcell_b.desc}&#39;&quot;)
        end
      end

      context &#39;and we are using a compiled release&#39; do
        it &#39;does not compile any packages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when there are compiled packages with the same major version number but different patch number)::context(and we are using a compiled release)::it#does not compile any packages has a flog score of 76</span>          </div>  </li></ol>
          compiler = DeploymentPlan::Stages::PackageCompileStage.new(
            deployment.name,
            [@j_dea],
            compilation_config,
            compilation_instance_pool,
            logger,
            @director_job
          )

          @package_set_a.each do |package|
            package.blobstore_id = nil
            package.sha1 = nil
            cp1 = make_compiled(release_version_model, package, @stemcell_a.models.first)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'cp1'</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L228" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L341" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L384" class="js-smell-location">2</a>                  </div>  </li></ol>
            expect(@j_dea).to receive(:use_compiled_package).with(cp1)
            expect(compiler).not_to receive(:with_compile_lock).with(package.id, &quot;#{@stemcell_b.os}/#{@stemcell_b.version}&quot;, deployment.name).and_yield
          end

          compiler.perform
          # For @stemcell_b we need to compile:
          # [p_dea, p_nginx, p_syslog, p_warden, p_common, p_ruby] = 6
          expect(compiler.compile_tasks_count).to eq(6)
          # and they should be recompiled
          expect(compiler.compilations_performed).to eq(0)

          expect(log_string).to include(&quot;Job templates &#39;cf-release/dea&#39;, &#39;cf-release/warden&#39; need to run on stemcell &#39;#{@stemcell_b.desc}&#39;&quot;)
        end
      end
    end

    context &#39;when there are compiled packages that do not have a blobstore id and compiled against a different stemcell version&#39; do
      let(:invalid_package) { Models::Package.make(sha1: nil, blobstore_id: nil) }

      before do
        prepare_samples

        release_version_model.add_package(invalid_package)

        @j_dea = instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L320" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L409" class="js-smell-location">1</a>                  </div>  </li></ol>
          name: &#39;dea&#39;,
          release: @release,
          jobs: [@t_dea, @t_warden],
          vm_type: @vm_type_large,
          stemcell: @stemcell_b
        )
      end

      context &#39;and we are using a compiled release&#39; do
        it &#39;does not compile any packages&#39; do
          compiler = DeploymentPlan::Stages::PackageCompileStage.new(
            deployment.name,
            [@j_dea],
            compilation_config,
            compilation_instance_pool,
            logger,
            @director_job
          )

          expect {compiler.perform}.to raise_error PackageMissingSourceCode
        end
      end
    end

    context &#39;compiling packages with transitive dependencies&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context#compiling packages with transitive dependencies has a flog score of 90</span>          </div>  </li></ol>
      let(:agent) { instance_double(&#39;Bosh::Director::AgentClient&#39;) }
      let(:compiler) { DeploymentPlan::Stages::PackageCompileStage.new(deployment.name, [@j_deps_ruby], compilation_config, compilation_instance_pool, logger, @director_job) }
      let(:vm_cid) { &#39;vm-cid-0&#39; }

      before do
        prepare_samples

        metadata_updater = instance_double(&#39;Bosh::Director::MetadataUpdater&#39;, update_vm_metadata: nil)
        allow(Bosh::Director::MetadataUpdater).to receive_messages(build: metadata_updater)
        expect(metadata_updater).to receive(:update_vm_metadata).with(anything, anything, hash_including(:compiling))

        initial_state = {
          &#39;deployment&#39; =&gt; &#39;mycloud&#39;,
          &#39;vm_type&#39; =&gt; {},
          &#39;stemcell&#39; =&gt; {},
          &#39;networks&#39; =&gt; net
        }

        allow(AgentClient).to receive(:with_agent_id).and_return(agent)
        allow(agent).to receive(:wait_until_ready)
        allow(agent).to receive(:update_settings)
        allow(agent).to receive(:apply).with(initial_state)
        allow(agent).to receive(:compile_package) do |*args|
          name = args[2]
          {
            &#39;result&#39; =&gt; {
              &#39;sha1&#39; =&gt; &quot;compiled.#{name}.sha1&quot;,
              &#39;blobstore_id&#39; =&gt; &quot;blob.#{name}.id&quot;
            }
          }
        end

        allow(@director_job).to receive(:task_checkpoint)
        allow(compiler).to receive(:with_compile_lock).and_yield
        allow(vm_creator).to receive(:create_for_instance_plan)
      end

      it &#39;sends information about immediate dependencies of the package being compiled&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(compiling packages with transitive dependencies)::it#sends information about immediate dependencies of the package being compiled has a flog score of 55</span>          </div>  </li></ol>
        expect(agent).to receive(:compile_package).with(
          anything(), # source package blobstore id
          anything(), # source package sha1
          &#39;common&#39;, # package name
          &#39;0.1-dev.1&#39;, # package version
          {}).ordered # immediate dependencies
        expect(agent).to receive(:compile_package).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L479" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L485" class="js-smell-location">1</a>                  </div>  </li></ol>
          anything(), # source package blobstore id
          anything(), # source package sha1
          &#39;ruby&#39;, # package name
          &#39;0.1-dev.1&#39;, # package version
          {&#39;common&#39; =&gt; {&#39;name&#39; =&gt; &#39;common&#39;, &#39;version&#39; =&gt; &#39;0.1-dev.1&#39;, &#39;sha1&#39; =&gt; &#39;compiled.common.sha1&#39;, &#39;blobstore_id&#39; =&gt; &#39;blob.common.id&#39;}}).ordered # immediate dependencies
        expect(agent).to receive(:compile_package).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L479" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L485" class="js-smell-location">1</a>                  </div>  </li></ol>
          anything(), # source package blobstore id
          anything(), # source package sha1
          &#39;needs_ruby&#39;, # package name
          &#39;0.1-dev.1&#39;, # package version
          {&#39;ruby&#39; =&gt; {&#39;name&#39; =&gt; &#39;ruby&#39;, &#39;version&#39; =&gt; &#39;0.1-dev.1&#39;, &#39;sha1&#39; =&gt; &#39;compiled.ruby.sha1&#39;, &#39;blobstore_id&#39; =&gt; &#39;blob.ruby.id&#39;}}).ordered # immediate dependencies

        allow(@j_deps_ruby).to receive(:use_compiled_package)

        compiler.perform
      end
    end

    context &#39;when the deploy is cancelled&#39; do
      before { allow(SecureRandom).to receive(:uuid).and_return(&#39;deadbeef&#39;) }
      it &#39;cancels the compilation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when the deploy is cancelled)::it#cancels the compilation has a flog score of 153</span>          </div>  </li></ol>
        vm_cid = &#39;vm-cid-1&#39;
        director_job = instance_double(&#39;Bosh::Director::Jobs::BaseJob&#39;, task_checkpoint: nil, task_cancelled?: false)
        event_log_stage = instance_double(&#39;Bosh::Director::EventLog::Stage&#39;)
        allow(event_log_stage).to receive(:advance_and_track).with(anything).and_yield

        network = double(&#39;network&#39;, name: &#39;network_name&#39;)
        release_version_model = Models::ReleaseVersion.make
        release_version = instance_double(&#39;Bosh::Director::DeploymentPlan::ReleaseVersion&#39;, name: &#39;release_name&#39;, model: release_version_model, version: release_version_model.version)
        release = Models::Release.make(name: release_version.name)
        release.add_version(release_version_model)
        stemcell = make_stemcell
        instance_group = instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;, release: release_version, name: &#39;job_name&#39;, stemcell: stemcell)
        package_model = Models::Package.make(name: &#39;foobarbaz&#39;, dependency_set: [], fingerprint: &#39;deadbeef&#39;, blobstore_id: &#39;fake_id&#39;)
        job = instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, release: release_version, package_models: [package_model], name: &#39;fake_template&#39;)
        allow(instance_group).to receive_messages(jobs: [job])

        compiler = DeploymentPlan::Stages::PackageCompileStage.new(deployment.name, [instance_group], compilation_config, compilation_instance_pool, logger, director_job)
        expect(director_job).to receive(:task_cancelled?).ordered.and_return(false)
        expect(director_job).to receive(:task_cancelled?).ordered.and_return(false)
        agent = instance_double(&#39;Bosh::Director::AgentClient&#39;)

        expect(cloud).to receive(:create_vm).once.ordered.
          with(instance_of(String), stemcell.models.first.cid, {}, net, [], {&#39;bosh&#39; =&gt; {&#39;group&#39; =&gt; &#39;fake-director-name-mycloud-compilation-deadbeef&#39;, &#39;groups&#39; =&gt; expected_groups}}).
          and_return(vm_cid)

        allow(AgentClient).to receive(:with_agent_id).and_return(agent)

        expect(agent).to receive(:wait_until_ready).ordered
        expect(agent).to receive(:update_settings).ordered
        expect(agent).to receive(:apply).with(initial_state).ordered
        expect(agent).to receive(:get_state).and_return({&#39;agent-state&#39; =&gt; &#39;yes&#39;}).ordered
        expect(agent).to receive(:compile_package).and_raise(TaskCancelled).ordered

        expect {
          compiler.perform
        }.to raise_error(TaskCancelled)
      end

      # this can happen when the cancellation comes in when there is a package to be compiled,
      # and the compilation is not even in-flight. e.g.
      # - you have 3 compilation workers, but you&#39;ve got 5 packages to compile; or
      # - package &quot;bar&quot; depends on &quot;foo&quot;, deploy is cancelled when compiling &quot;foo&quot; (&quot;bar&quot; is blocked)
      context &#39;when there is a pending compilation&#39; do
        let(:reuse_compilation_vms) { true }
        let(:number_of_workers) { 1 }
        it &#39;cancels the compilation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(when the deploy is cancelled)::context(when there is a pending compilation)::it#cancels the compilation has a flog score of 60</span>          </div>  </li></ol>
          director_job = instance_double(&#39;Bosh::Director::Jobs::BaseJob&#39;, task_checkpoint: nil, task_cancelled?: true)
          event_log_stage = instance_double(&#39;Bosh::Director::EventLog::Stage&#39;)
          allow(event_log_stage).to receive(:advance_and_track).with(anything).and_yield

          network = double(&#39;network&#39;, name: &#39;network_name&#39;)
          release_version_model = Models::ReleaseVersion.make
          release_version = instance_double(&#39;Bosh::Director::DeploymentPlan::ReleaseVersion&#39;, name: &#39;release_name&#39;, model: release_version_model, version: release_version_model.version)
          release = Models::Release.make(name: release_version.name)
          release.add_version(release_version_model)
          stemcell = make_stemcell
          instance_group = instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceGroup&#39;, release: release_version, name: &#39;job_name&#39;, stemcell: stemcell)
          package_model = Models::Package.make(name: &#39;foobarbaz&#39;, dependency_set: [], fingerprint: &#39;deadbeef&#39;, blobstore_id: &#39;fake_id&#39;)
          job = instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, release: release_version, package_models: [package_model], name: &#39;fake_template&#39;)
          allow(instance_group).to receive_messages(jobs: [job])

          compiler = DeploymentPlan::Stages::PackageCompileStage.new(deployment.name, [instance_group], compilation_config, compilation_instance_pool, logger, director_job)

          expect {
            compiler.perform
          }.not_to raise_error
        end
      end
    end

    describe &#39;with reuse_compilation_vms option set&#39; do
      let(:reuse_compilation_vms) { true }
      before { allow(SecureRandom).to receive(:uuid).and_return(&#39;deadbeef&#39;) }

      let(:vm_creator) { Bosh::Director::VmCreator.new(logger, template_blob_cache, dns_encoder, agent_broadcaster) }

      it &#39;reuses compilation VMs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with reuse_compilation_vms option set)::it#reuses compilation VMs has a flog score of 178</span>          </div>  </li></ol>
        prepare_samples

        expect(vm_creator).to receive(:create_for_instance_plan).exactly(1).times do |instance_plan|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L346" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L580" class="js-smell-location">1</a>                  </div>  </li></ol>
          # metadata_updater is called for every package compilation, and it expects there to be an active_vm
          instance_plan.instance.model.active_vm = Models::Vm.make(cid: instance_plan.instance.model.id, instance: instance_plan.instance.model)
        end

        agent_client = instance_double(&#39;BD::AgentClient&#39;)
        allow(BD::AgentClient).to receive(:with_agent_id).and_return(agent_client)

        expect(agent_client).to receive(:compile_package).exactly(6).times do |*args|
          name = args[2]
          dot = args[3].rindex(&#39;.&#39;)
          version, _ = args[3][0..dot-1], args[3][dot+1..-1]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L207" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L591" class="js-smell-location">1</a>                  </div>  </li></ol>

          package = Models::Package.find(name: name, version: version)
          expect(args[0]).to eq(package.blobstore_id)
          expect(args[1]).to eq(package.sha1)

          expect(args[4]).to be_a(Hash)

          {
            &#39;result&#39; =&gt; {
              &#39;sha1&#39; =&gt; &quot;compiled #{package.id}&quot;,
              &#39;blobstore_id&#39; =&gt; &quot;blob #{package.id}&quot;
            }
          }
        end

        expect(@j_dea).to receive(:use_compiled_package).exactly(6).times

        expect(instance_deleter).to receive(:delete_instance_plan)

        expect(@director_job).to receive(:task_checkpoint).once

        compiler = DeploymentPlan::Stages::PackageCompileStage.new(
          deployment.name,
          [@j_dea],
          compilation_config,
          compilation_instance_pool,
          logger,
          @director_job
        )

        @package_set_a.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L287" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L291" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L622" class="js-smell-location">2</a>                  </div>  </li></ol>
          expect(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{@stemcell_a.os}/#{@stemcell_a.version}&quot;, deployment.name).and_yield
        end

        compiler.perform
        expect(compiler.compilations_performed).to eq(6)

        @package_set_a.each do |package|
          expect(package.compiled_packages.size).to be &gt;= 1
        end
      end

      it &#39;cleans up compilation vms if there is a failing compilation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with reuse_compilation_vms option set)::it#cleans up compilation vms if there is a failing compilation has a flog score of 91</span>          </div>  </li></ol>
        prepare_samples

        vm_cid = &#39;vm-cid-1&#39;
        agent = instance_double(&#39;Bosh::Director::AgentClient&#39;)

        expect(cloud).to receive(:create_vm).
          with(instance_of(String), @stemcell_a.models.first.cid, {}, net, [], {&#39;bosh&#39; =&gt; {&#39;group&#39; =&gt; &#39;fake-director-name-mycloud-compilation-deadbeef&#39;, &#39;groups&#39; =&gt; expected_groups}}).
          and_return(vm_cid)

        allow(AgentClient).to receive(:with_agent_id).and_return(agent)

        expect(agent).to receive(:wait_until_ready)
        expect(agent).to receive(:update_settings)
        expect(agent).to receive(:apply).with(initial_state)
        expect(agent).to receive(:get_state).and_return({&#39;agent-state&#39; =&gt; &#39;yes&#39;})
        expect(agent).to receive(:compile_package).and_raise(RuntimeError)

        compiler = DeploymentPlan::Stages::PackageCompileStage.new(
          deployment.name,
          [@j_dea],
          compilation_config,
          compilation_instance_pool,
          logger,
          @director_job
        )
        allow(compiler).to receive(:with_compile_lock).and_yield

        expect {
          compiler.perform
        }.to raise_error(RuntimeError)
      end
    end

    it &#39;should make sure a parallel deployment did not compile a package already&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::it#should make sure a parallel deployment did not compile a package already has a flog score of 51</span>          </div>  </li></ol>
      package = Models::Package.make
      stemcell = make_stemcell

      task = CompileTask.new(package, stemcell, job, &#39;fake-dependency-key&#39;, &#39;fake-cache-key&#39;)

      compiler = DeploymentPlan::Stages::PackageCompileStage.new(deployment.name, [], compilation_config, compilation_instance_pool, logger, nil)
      fake_compiled_package = instance_double(&#39;Bosh::Director::Models::CompiledPackage&#39;, name: &#39;fake&#39;)
      allow(task).to receive(:find_compiled_package).and_return(fake_compiled_package)

      allow(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{stemcell.os}/#{stemcell.version}&quot;, deployment.name).and_yield
      compiler.compile_package(task)

      expect(task.compiled_package).to eq(fake_compiled_package)
    end

    describe &#39;the global blobstore&#39; do
      let(:package) { Models::Package.make }
      let(:stemcell) { make_stemcell }
      let(:task) { CompileTask.new(package, stemcell, job, &#39;fake-dependency-key&#39;, &#39;fake-cache-key&#39;) }
      let(:compiler) { DeploymentPlan::Stages::PackageCompileStage.new(deployment.name, [], compilation_config, compilation_instance_pool, logger, nil) }
      let(:cache_key) { &#39;cache key&#39; }

      before do
        allow(task).to receive(:cache_key).and_return(cache_key)

        allow(Config).to receive(:use_compiled_package_cache?).and_return(true)
      end

      it &#39;should check if compiled package is in global blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(the global blobstore)::it#should check if compiled package is in global blobstore has a flog score of 75</span>          </div>  </li></ol>
        allow(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{stemcell.os}/#{stemcell.version}&quot;, deployment.name).and_yield<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L698" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L711" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L729" class="js-smell-location">2</a>                  </div>  </li></ol>

        expect(BlobUtil).to receive(:exists_in_global_cache?).with(package, cache_key).and_return(true)
        allow(task).to receive(:find_compiled_package)
        expect(BlobUtil).not_to receive(:save_to_global_cache)
        allow(compiler).to receive(:prepare_vm)
        compiled_package = instance_double(&#39;Bosh::Director::Models::CompiledPackage&#39;, name: &#39;fake&#39;)
        allow(Models::CompiledPackage).to receive(:create).and_return(compiled_package)

        compiler.compile_package(task)
      end

      it &#39;should save compiled package to global cache if not exists&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(the global blobstore)::it#should save compiled package to global cache if not exists has a flog score of 87</span>          </div>  </li></ol>
        expect(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{stemcell.os}/#{stemcell.version}&quot;, deployment.name).and_yield<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L698" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L711" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L729" class="js-smell-location">2</a>                  </div>  </li></ol>

        allow(task).to receive(:find_compiled_package)
        compiled_package = instance_double(
          &#39;Bosh::Director::Models::CompiledPackage&#39;,
          name: &#39;fake-package-name&#39;, package: package,
          stemcell_os: stemcell.os, stemcell_version: stemcell.version, blobstore_id: &#39;some blobstore id&#39;)
        expect(BlobUtil).to receive(:exists_in_global_cache?).with(package, cache_key).and_return(false)
        expect(BlobUtil).to receive(:save_to_global_cache).with(compiled_package, cache_key)
        allow(compiler).to receive(:prepare_vm)
        allow(Models::CompiledPackage).to receive(:create).and_return(compiled_package)

        compiler.compile_package(task)
      end

      it &#39;only checks the global cache if Config.use_compiled_package_cache? is set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(the global blobstore)::it#only checks the global cache if Config.use_compiled_package_cache? is set has a flog score of 66</span>          </div>  </li></ol>
        allow(Config).to receive(:use_compiled_package_cache?).and_return(false)

        allow(compiler).to receive(:with_compile_lock).with(package.id, &quot;#{stemcell.os}/#{stemcell.version}&quot;, deployment.name).and_yield<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="package_compile_stage_spec.html#L698" class="js-smell-location">0</a>                  <a href="package_compile_stage_spec.html#L711" class="js-smell-location">1</a>                  <a href="package_compile_stage_spec.html#L729" class="js-smell-location">2</a>                  </div>  </li></ol>

        expect(BlobUtil).not_to receive(:exists_in_global_cache?)
        expect(BlobUtil).not_to receive(:save_to_global_cache)
        allow(compiler).to receive(:prepare_vm)
        compiled_package = instance_double(&#39;Bosh::Director::Models::CompiledPackage&#39;, name: &#39;fake&#39;)
        allow(Models::CompiledPackage).to receive(:create).and_return(compiled_package)

        compiler.compile_package(task)
      end
    end

    describe &#39;#prepare_vm&#39; do
      let(:number_of_workers) { 2 }
      let(:plan) do
        deployment_model = Models::Deployment.make
        Bosh::Director::Models::VariableSet.make(deployment: deployment_model)

        instance_double(&#39;Bosh::Director::DeploymentPlan::Planner&#39;,
          compilation: compilation_config,
          model: deployment_model,
          name: &#39;fake-deployment&#39;,
          ip_provider: ip_provider,
          tags: {}
        )
      end
      let(:stemcell) { make_stemcell(cid: &#39;stemcell-cid&#39;) }
      let(:instance) { instance_double(DeploymentPlan::Instance) }

      context &#39;with reuse_compilation_vms&#39; do
        let(:reuse_compilation_vms) { true }
        let(:network) { instance_double(&#39;Bosh::Director::DeploymentPlan::ManualNetwork&#39;, name: &#39;default&#39;, network_settings: nil) }
        let(:instance_reuser) { instance_double(&#39;Bosh::Director::InstanceReuser&#39;) }
        let(:number_of_workers) { 4 }

        before do
          allow(plan).to receive(:network).with(&#39;default&#39;).and_return(network)
        end

        it &#39;should clean up the compilation vm if it failed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#prepare_vm)::context(with reuse_compilation_vms)::it#should clean up the compilation vm if it failed has a flog score of 101</span>          </div>  </li></ol>
          compiler = described_class.new(deployment.name, [], compilation_config, compilation_instance_pool, logger, @director_job)

          allow(vm_creator).to receive(:create_for_instance_plan).and_raise(RpcTimeout)

          allow(instance_reuser).to receive_messages(get_instance: nil)
          allow(instance_reuser).to receive_messages(get_num_instances: 0)
          allow(instance_reuser).to receive(:add_in_use_instance)
          allow(instance_reuser).to receive(:total_instance_count).and_return(3)
          allow(ip_provider).to receive(:reserve).with(instance_of(Bosh::Director::DesiredNetworkReservation))

          expect(instance_reuser).to receive(:remove_instance).ordered
          expect(instance_deleter).to receive(:delete_instance_plan).ordered
          allow(ip_provider).to receive(:release)

          expect {
            compiler.prepare_vm(stemcell) do
              # nothing
            end
          }.to raise_error RpcTimeout
        end
      end

      describe &#39;trusted certificate handling&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#prepare_vm)::describe#trusted certificate handling has a flog score of 58</span>          </div>  </li></ol>
        let(:compiler) { described_class.new(deployment.name, [], compilation_config, compilation_instance_pool, logger, @director_job) }
        let(:client) { instance_double(&#39;Bosh::Director::AgentClient&#39;) }

        before do
          Bosh::Director::Config.trusted_certs = DIRECTOR_TEST_CERTS

          allow(cloud).to receive(:create_vm).and_return(&#39;new-vm-cid&#39;)
          allow(AgentClient).to receive_messages(with_agent_id: client)
          allow(cloud).to receive(:delete_vm)
          allow(client).to receive(:update_settings)
          allow(client).to receive(:wait_until_ready)
          allow(client).to receive(:apply)
          allow(client).to receive(:get_state)
        end

        def self.it_should_not_update_db(method, exception)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#prepare_vm)::describe::it_should_not_update_db has a flog score of 49</span>          </div>  </li></ol>
          it &#39;should not update the DB with the new certificates&#39; do
            expect(client).to receive(method).and_raise(exception)

            begin
              compiler.prepare_vm(stemcell, &amp;Proc.new {})
            rescue exception
              #
            end

            expect(Models::Vm.find(trusted_certs_sha1: DIRECTOR_TEST_CERTS_SHA1)).to be_nil
          end
        end

        it &#39;should update the database with the new VM&#39; &#39;s trusted certs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(#prepare_vm)::describe(trusted certificate handling)::it#should update the database with the new VMs trusted certs has a flog score of 60</span>          </div>  </li></ol>
          expect {
            compiler.prepare_vm(stemcell, &amp;Proc.new {})
          }.to change {
            matching_vm = Models::Vm.find(trusted_certs_sha1: DIRECTOR_TEST_CERTS_SHA1)
            matching_vm.nil? ? 0 : Models::Instance.all.select { |i| i.active_vm == matching_vm }.count<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'i'</span>          </div>  </li></ol>
          }.from(0).to(1)
        end

        context &#39;when the new vm fails to start&#39; do
          it_should_not_update_db(:wait_until_ready, RpcTimeout)
        end

        context &#39;when task was cencelled&#39; do
          it_should_not_update_db(:wait_until_ready, TaskCancelled)
        end

        context &#39;when the update_settings method fails&#39; do
          it_should_not_update_db(:update_settings, RpcTimeout)
        end
      end
    end

    describe &#39;.create&#39; do
      it &#39;it creates a PackageCompileStage with correct injected dependencies&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(.create)::it#it creates a PackageCompileStage with correct injected dependencies has a flog score of 45</span>          </div>  </li></ol>
        prepare_samples

        allow(plan).to receive(:instance_groups).and_return([@j_dea])
        expect(DeploymentPlan::CompilationInstancePool).to receive(:create).with(plan).and_return(compilation_instance_pool)

        expect(DeploymentPlan::Stages::PackageCompileStage).to receive(:new).with(
          plan.name,
          [@j_dea],
          compilation_config,
          compilation_instance_pool,
          logger,
          nil,
        ).and_call_original

        DeploymentPlan::Stages::PackageCompileStage.create(plan)
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
