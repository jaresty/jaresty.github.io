<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> instance_group_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">977</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">141</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1759.54</span><small> complexity</small></div>
              <div><span class="metric">440</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                25
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

describe Bosh::Director::DeploymentPlan::InstanceGroup do
  subject(:instance_group) { Bosh::Director::DeploymentPlan::InstanceGroup.parse(plan, spec, event_log, logger, parse_options) }
  let(:parse_options) do
    {}
  end
  let(:event_log)  { instance_double(&#39;Bosh::Director::EventLog::Log&#39;, warn_deprecated: nil) }

  let(:deployment) { Bosh::Director::Models::Deployment.make }
  let(:fake_ip_provider) { instance_double(Bosh::Director::DeploymentPlan::IpProvider, reserve: nil, reserve_existing_ips: nil) }
  let(:plan) do
    instance_double(&#39;Bosh::Director::DeploymentPlan::Planner&#39;,
                    model: deployment,
                    name: deployment.name,
                    ip_provider: fake_ip_provider,
                    releases: {})
  end
  let(:vm_type) { Bosh::Director::DeploymentPlan::VmType.new(&#39;name&#39; =&gt; &#39;dea&#39;) }
  let(:stemcell) { instance_double(&#39;Bosh::Director::DeploymentPlan::Stemcell&#39;) }
  let(:env) { instance_double(&#39;Bosh::Director::DeploymentPlan::Env&#39;) }

  let(:network) do
    instance_double(
      &#39;Bosh::Director::DeploymentPlan::Network&#39;,
      name: &#39;fake-network-name&#39;,
      validate_reference_from_job!: true,
      has_azs?: true,
    )
  end

  let(:foo_properties) do
    {
      &#39;dea_min_memory&#39; =&gt; { &#39;default&#39; =&gt; 512 },
      &#39;deep_property.dont_override&#39; =&gt; { &#39;default&#39; =&gt; &#39;ghi&#39; },
      &#39;deep_property.new_property&#39; =&gt; { &#39;default&#39; =&gt; &#39;jkl&#39; },
    }
  end

  let(:bar_properties) do
    { &#39;dea_max_memory&#39; =&gt; { &#39;default&#39; =&gt; 2048 } }
  end

  let(:release1_foo_job) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L44" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L51" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L296" class="js-smell-location">2</a>                  </div>  </li></ol>
    r = Bosh::Director::DeploymentPlan::Job.new(release1, &#39;foo&#39;, &#39;story-152729032&#39;)
    r.bind_existing_model(release1_foo_job_model)
    r
  end
  let(:release1_foo_job_model) { Bosh::Director::Models::Template.make(name: &#39;foo&#39;, release: release1_model) }

  let(:release1_bar_job) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L44" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L51" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L296" class="js-smell-location">2</a>                  </div>  </li></ol>
    r = Bosh::Director::DeploymentPlan::Job.new(release1, &#39;bar&#39;, &#39;story-152729032&#39;)
    r.bind_existing_model(release1_bar_job_model)
    r
  end
  let(:release1_bar_job_model) { Bosh::Director::Models::Template.make(name: &#39;bar&#39;, release: release1_model) }

  let(:release1_package1_model) do
    Bosh::Director::Models::Package.make(name: &#39;same-name&#39;, release: release1_model, fingerprint: &#39;abc123&#39;)
  end

  let(:release1) do
    Bosh::Director::DeploymentPlan::ReleaseVersion.new(
      deployment,
      &#39;name&#39; =&gt; &#39;release1&#39;,
      &#39;version&#39; =&gt; &#39;1&#39;,
    )
  end

  let(:release1_model) { Bosh::Director::Models::Release.make(name: &#39;release1&#39;) }
  let(:release1_version_model) { Bosh::Director::Models::ReleaseVersion.make(version: &#39;1&#39;, release: release1_model) }
  let(:update_config) { double(Bosh::Director::DeploymentPlan::UpdateConfig) }
  let(:links_serial_id) { 7 }
  subject { described_class.new(logger) }

  let(:links_manager) { Bosh::Director::Links::LinksManager.new(links_serial_id, logger, event_log) }

  before do
    allow(Bosh::Director::DeploymentPlan::UpdateConfig).to receive(:new).and_return update_config

    allow(plan).to receive(:networks).and_return([network])
    allow(plan).to receive(:vm_type).with(&#39;dea&#39;).and_return vm_type
    allow(plan).to receive(:stemcell).with(&#39;dea&#39;).and_return stemcell
    allow(plan).to receive(:update)
    allow(plan).to receive(:links_manager).and_return(links_manager)

    allow(release1).to receive(:get_or_create_template).with(&#39;foo&#39;).and_return(release1_foo_job)
    allow(release1).to receive(:get_or_create_template).with(&#39;bar&#39;).and_return(release1_bar_job)

    allow(release1_foo_job).to receive(:properties)
    allow(release1_bar_job).to receive(:properties)

    allow(release1_foo_job).to receive(:add_properties)
    allow(release1_bar_job).to receive(:add_properties)
    allow(deployment).to receive(:current_variable_set).and_return(Bosh::Director::Models::VariableSet.make)

    release1_version_model.add_template(release1_foo_job_model)
    release1_version_model.add_template(release1_bar_job_model)
    release1_version_model.add_package(release1_package1_model)
    subject.update = update_config
  end

  describe &#39;#parse&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##parse has a flog score of 27</span>          </div>  </li></ol>
    let(:spec) do
      {
        &#39;name&#39; =&gt; &#39;foobar&#39;,
        &#39;release&#39; =&gt; &#39;appcloud&#39;,
        &#39;vm_type&#39; =&gt; &#39;dea&#39;,
        &#39;stemcell&#39; =&gt; &#39;dea&#39;,
        &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
        &#39;instances&#39; =&gt; 1,
        &#39;networks&#39;  =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
        &#39;properties&#39; =&gt; props,
        &#39;template&#39; =&gt; %w[foo bar],
        &#39;update&#39; =&gt; update,
      }
    end

    let(:props) do
      {
        &#39;cc_url&#39; =&gt; &#39;www.cc.com&#39;,
        &#39;deep_property&#39; =&gt; {
          &#39;unneeded&#39; =&gt; &#39;abc&#39;,
          &#39;dont_override&#39; =&gt; &#39;def&#39;,
        },
        &#39;dea_max_memory&#39; =&gt; 1024,
      }
    end

    before do
      allow(plan).to receive(:properties).and_return(props)
      allow(plan).to receive(:release).with(&#39;appcloud&#39;).and_return(release1)
    end

    context &#39;when parse_options contain canaries&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L135" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L150" class="js-smell-location">1</a>                  </div>  </li></ol>
      let(:parse_options) do
        { &#39;canaries&#39; =&gt; 42 }
      end
      let(:update) do
        { &#39;canaries&#39; =&gt; 22 }
      end

      it &#39;overrides canaries value with one from parse_options&#39; do
        expect(Bosh::Director::DeploymentPlan::UpdateConfig).to receive(:new)
          .with(parse_options, nil)
        instance_group
      end
    end

    context &#39;when parse_options contain max_in_flight&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L135" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L150" class="js-smell-location">1</a>                  </div>  </li></ol>
      let(:parse_options) do
        { &#39;max_in_flight&#39; =&gt; 42 }
      end
      let(:update) do
        { &#39;max_in_flight&#39; =&gt; 22 }
      end

      it &#39;overrides max_in_flight value with one from parse_options&#39; do
        expect(Bosh::Director::DeploymentPlan::UpdateConfig).to receive(:new)
          .with(parse_options, nil)
        instance_group
      end
    end
  end

  describe &#39;#bind_properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe##bind_properties has a flog score of 61</span>          </div>  </li></ol>
    let(:spec) do
      {
        &#39;name&#39; =&gt; &#39;foobar&#39;,
        &#39;release&#39; =&gt; &#39;appcloud&#39;,
        &#39;vm_type&#39; =&gt; &#39;dea&#39;,
        &#39;stemcell&#39; =&gt; &#39;dea&#39;,
        &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
        &#39;instances&#39; =&gt; 1,
        &#39;networks&#39;  =&gt; [
          { &#39;name&#39; =&gt; &#39;fake-network-name&#39;, &#39;default&#39; =&gt; %w[dns gateway] },
          { &#39;name&#39; =&gt; &#39;fake-network-name2&#39; },
        ],
        &#39;template&#39; =&gt; %w[foo bar],
      }
    end

    let(:foo_properties) do
      {
        &#39;foobar&#39; =&gt; {
          &#39;cc_url&#39; =&gt; &#39;www.cc.com&#39;,
          &#39;deep_property&#39; =&gt; {
            &#39;unneeded&#39; =&gt; &#39;abc&#39;,
            &#39;dont_override&#39; =&gt; &#39;def&#39;,
          },
        },
      }
    end

    let(:bar_properties) do
      {
        &#39;foobar&#39; =&gt; {
          &#39;vroom&#39; =&gt; &#39;smurf&#39;,
          &#39;dea_max_memory&#39; =&gt; 1024,
        },
      }
    end

    let(:options) do
      {
        dns_record_names: [
          &quot;*.foobar.fake-network-name.#{deployment.name}.bosh&quot;,
          &quot;*.foobar.fake-network-name2.#{deployment.name}.bosh&quot;,
        ],
      }
    end

    let(:network2) do
      instance_double(
        &#39;Bosh::Director::DeploymentPlan::Network&#39;,
        name: &#39;fake-network-name2&#39;,
        validate_reference_from_job!: true,
        has_azs?: true,
      )
    end

    before do
      allow(plan).to receive(:networks).and_return([network, network2])

      allow(plan).to receive(:properties).and_return({})
      allow(plan).to receive(:release).with(&#39;appcloud&#39;).and_return(release1)
      allow(release1_foo_job).to receive(:properties).and_return(foo_properties)
      allow(release1_bar_job).to receive(:properties).and_return(bar_properties)
    end

    it &#39;binds all job properties with correct parameters&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#bind_properties)::it#binds all job properties with correct parameters has a flog score of 43</span>          </div>  </li></ol>
      expect(release1_foo_job).to receive(:bind_properties).with(&#39;foobar&#39;, deployment.name, options)
      expect(release1_bar_job).to receive(:bind_properties).with(&#39;foobar&#39;, deployment.name, options)

      instance_group.bind_properties

      expect(instance_group.properties).to eq(
        &#39;foo&#39; =&gt; {
          &#39;cc_url&#39; =&gt; &#39;www.cc.com&#39;,
          &#39;deep_property&#39; =&gt; {
            &#39;unneeded&#39; =&gt; &#39;abc&#39;,
            &#39;dont_override&#39; =&gt; &#39;def&#39;,
          },
        },
        &#39;bar&#39; =&gt; {
          &#39;vroom&#39; =&gt; &#39;smurf&#39;,
          &#39;dea_max_memory&#39; =&gt; 1024,
        },
      )
    end
  end

  describe &#39;#validate_package_names_do_not_collide!&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe##validate_package_names_do_not_collide! has a flog score of 25</span>          </div>  </li></ol>
    before do
      allow(plan).to receive(:properties).and_return({})
      allow(plan).to receive(:release).with(&#39;release1&#39;).and_return(release1)
    end

    context &#39;when the templates are from the same release&#39; do
      let(:spec) do
        {
          &#39;name&#39; =&gt; &#39;foobar&#39;,
          &#39;templates&#39; =&gt; [
            { &#39;name&#39; =&gt; &#39;foo&#39;, &#39;release&#39; =&gt; &#39;release1&#39; },
            { &#39;name&#39; =&gt; &#39;bar&#39;, &#39;release&#39; =&gt; &#39;release1&#39; },
          ],
          &#39;vm_type&#39; =&gt; &#39;dea&#39;,
          &#39;stemcell&#39; =&gt; &#39;dea&#39;,
          &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
          &#39;instances&#39; =&gt; 1,
          &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
        }
      end

      context &#39;when templates depend on packages with the same name (i.e. same package)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#validate_package_names_do_not_collide!)::context(when the templates are from the same release)::context(when templates depend on packages with the same name (i.e. same package))#when templates depend on packages with the same name (i.e. same package) has a flog score of 32</span>          </div>  </li></ol>
        before do
          release1_foo_job_model.package_names = [&#39;same-name&#39;]
          release1_foo_job_model.save
          release1_bar_job_model.package_names = [&#39;same-name&#39;]
          release1_bar_job_model.save
          allow(plan).to receive(:releases).with(no_args).and_return([release1])
        end

        it &#39;does not raise an error&#39; do
          expect { instance_group.validate_package_names_do_not_collide! }.to_not raise_error
        end
      end
    end

    context &#39;when the templates are from different releases&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#validate_package_names_do_not_collide!)::context#when the templates are from different releases has a flog score of 78</span>          </div>  </li></ol>
      let(:release2) do
        Bosh::Director::DeploymentPlan::ReleaseVersion.new(deployment,
                                                           &#39;name&#39; =&gt; &#39;release2&#39;,
                                                           &#39;version&#39; =&gt; &#39;1&#39;)
      end
      let(:release2_bar_job) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L44" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L51" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L296" class="js-smell-location">2</a>                  </div>  </li></ol>
        r = Bosh::Director::DeploymentPlan::Job.new(release2, &#39;bar&#39;, &#39;story-152729032&#39;)
        r.bind_existing_model(release2_bar_job_model)
        r
      end
      let(:release2_bar_job_model) { Bosh::Director::Models::Template.make(name: &#39;bar&#39;, release: release2_model) }
      let(:release2_model) { Bosh::Director::Models::Release.make(name: &#39;release2&#39;) }
      let(:release2_version_model) { Bosh::Director::Models::ReleaseVersion.make(release: release2_model, version: 1) }
      let(:release2_package1_model) do
        Bosh::Director::Models::Package.make(
          name: release2_package1_name,
          release: release2_model,
          fingerprint: release2_package1_fingerprint,
          dependency_set_json: JSON.dump(release2_package1_dependencies),
        )
      end
      let(:release2_package1_fingerprint) { &#39;987asd&#39; }
      let(:release2_package1_name) { &#39;another-name&#39; }
      let(:release2_package1_dependencies) { [] }

      before do
        release2_version_model.add_template(release2_bar_job_model)
        release2_version_model.add_package(release2_package1_model)

        release1_foo_job_model.package_names = [release1_package1_model.name]
        release1_foo_job_model.save
        release2_bar_job_model.package_names = [release2_package1_model.name]
        release2_bar_job_model.save

        allow(plan).to receive(:releases).with(no_args).and_return([release1, release2])
        allow(plan).to receive(:release).with(&#39;release2&#39;).and_return(release2)

        allow(release2).to receive(:get_or_create_template).with(&#39;bar&#39;).and_return(release2_bar_job)
      end

      let(:spec) do
        {
          &#39;name&#39; =&gt; &#39;foobar&#39;,
          &#39;templates&#39; =&gt; [
            { &#39;name&#39; =&gt; &#39;foo&#39;, &#39;release&#39; =&gt; &#39;release1&#39; },
            { &#39;name&#39; =&gt; &#39;bar&#39;, &#39;release&#39; =&gt; &#39;release2&#39;, &#39;links&#39; =&gt; { &#39;a&#39; =&gt; &#39;x.y.z.zz&#39; } },
          ],
          &#39;vm_type&#39; =&gt; &#39;dea&#39;,
          &#39;stemcell&#39; =&gt; &#39;dea&#39;,
          &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
          &#39;instances&#39; =&gt; 1,
          &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
        }
      end

      context &#39;when templates do not depend on packages with the same name&#39; do
        before do
          link_provider = instance_double(Bosh::Director::Models::Links::LinkProvider)
          allow(links_manager).to receive(:find_or_create_provider).and_return(link_provider)
        end

        it &#39;does not raise an exception&#39; do
          expect { instance_group.validate_package_names_do_not_collide! }.to_not raise_error
        end
      end

      context &#39;when templates depend on packages with the same name&#39; do
        let(:release2_package1_name) { &#39;same-name&#39; }

        context &#39;fingerprints are different&#39; do
          let(:release2_package1_fingerprint) { &#39;987asd&#39; }

          it &#39;raises an exception because agent currently cannot collocate similarly named packages from multiple releases&#39; do
            expect do
              instance_group.validate_package_names_do_not_collide!
            end.to raise_error(
              Bosh::Director::JobPackageCollision,
              &quot;Package name collision detected in instance group &#39;foobar&#39;: &quot;\
              &quot;job &#39;release1/foo&#39; depends on package &#39;release1/same-name&#39;,&quot;\
              &quot; job &#39;release2/bar&#39; depends on &#39;release2/same-name&#39;. &quot;\
              &#39;BOSH cannot currently collocate two packages with identical names from separate releases.&#39;,
            )
          end
        end

        context &#39;fingerprints are the same&#39; do
          let(:release2_package1_fingerprint) { &#39;abc123&#39; }

          context &#39;when dependencies are the same&#39; do
            it &#39;does not raise an exception&#39; do
              instance_group.validate_package_names_do_not_collide!
            end
          end

          context &#39;when dependencies are not the same&#39; do
            let(:release2_package1_dependencies) { [&#39;whatever&#39;] }

            it &#39;raises an exception&#39; do
              expect do
                instance_group.validate_package_names_do_not_collide!
              end.to raise_error(
                Bosh::Director::JobPackageCollision,
                &quot;Package name collision detected in instance group &#39;foobar&#39;: &quot;\
                &quot;job &#39;release1/foo&#39; depends on package &#39;release1/same-name&#39;,&quot;\
                &quot; job &#39;release2/bar&#39; depends on &#39;release2/same-name&#39;. &quot;\
                &#39;BOSH cannot currently collocate two packages with identical names from separate releases.&#39;,
              )
            end
          end
        end
      end
    end
  end

  describe &#39;#spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe##spec has a flog score of 91</span>          </div>  </li></ol>
    let(:spec) do
      {
        &#39;name&#39; =&gt; &#39;job1&#39;,
        &#39;template&#39; =&gt; &#39;foo&#39;,
        &#39;release&#39; =&gt; &#39;release1&#39;,
        &#39;instances&#39; =&gt; 1,
        &#39;vm_type&#39; =&gt; &#39;dea&#39;,
        &#39;stemcell&#39; =&gt; &#39;dea&#39;,
        &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
        &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
      }
    end

    before do
      allow(release1).to receive(:name).and_return(&#39;cf&#39;)

      allow(release1_foo_job).to receive(:version).and_return(&#39;200&#39;)
      allow(release1_foo_job).to receive(:sha1).and_return(&#39;fake_sha1&#39;)
      allow(release1_foo_job).to receive(:blobstore_id).and_return(&#39;blobstore_id_for_foo_job&#39;)
      allow(release1_foo_job).to receive(:properties).and_return({})

      allow(plan).to receive(:releases).with(no_args).and_return([release1])
      allow(plan).to receive(:release).with(&#39;release1&#39;).and_return(release1)
      allow(plan).to receive(:properties).with(no_args).and_return({})
    end

    context &quot;when a template has &#39;logs&#39;&quot; do
      before do
        allow(release1_foo_job).to receive(:logs).and_return(
          &#39;filter_name1&#39; =&gt; &#39;foo/*&#39;,
        )
      end

      it &#39;contains name, release for the job, and logs spec for each template&#39; do
        expect(instance_group.spec).to eq(
          &#39;name&#39; =&gt; &#39;job1&#39;,
          &#39;templates&#39; =&gt; [
            {
              &#39;name&#39; =&gt; &#39;foo&#39;,
              &#39;version&#39; =&gt; &#39;200&#39;,
              &#39;sha1&#39; =&gt; &#39;fake_sha1&#39;,
              &#39;blobstore_id&#39; =&gt; &#39;blobstore_id_for_foo_job&#39;,
              &#39;logs&#39; =&gt; {
                &#39;filter_name1&#39; =&gt; &#39;foo/*&#39;,
              },
            },
          ],
          &#39;template&#39; =&gt; &#39;foo&#39;,
          &#39;version&#39; =&gt; &#39;200&#39;,
          &#39;sha1&#39; =&gt; &#39;fake_sha1&#39;,
          &#39;blobstore_id&#39; =&gt; &#39;blobstore_id_for_foo_job&#39;,
          &#39;logs&#39; =&gt; {
            &#39;filter_name1&#39; =&gt; &#39;foo/*&#39;,
          },
        )
      end
    end

    context &quot;when a template does not have &#39;logs&#39;&quot; do
      before do
        allow(release1_foo_job).to receive(:logs)
      end

      it &#39;contains name, release and information for each template&#39; do
        expect(instance_group.spec).to eq(
          &#39;name&#39; =&gt; &#39;job1&#39;,
          &#39;templates&#39; =&gt; [
            {
              &#39;name&#39; =&gt; &#39;foo&#39;,
              &#39;version&#39; =&gt; &#39;200&#39;,
              &#39;sha1&#39; =&gt; &#39;fake_sha1&#39;,
              &#39;blobstore_id&#39; =&gt; &#39;blobstore_id_for_foo_job&#39;,
            },
          ],
          &#39;template&#39; =&gt; &#39;foo&#39;,
          &#39;version&#39; =&gt; &#39;200&#39;,
          &#39;sha1&#39; =&gt; &#39;fake_sha1&#39;,
          &#39;blobstore_id&#39; =&gt; &#39;blobstore_id_for_foo_job&#39;,
        )
      end
    end
  end

  describe &#39;#bind_unallocated_vms&#39; do
    subject(:instance_group) { described_class.new(logger) }

    it &#39;allocates a VM to all non obsolete instances if they are not already bound to a VM&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#bind_unallocated_vms)::it#allocates a VM to all non obsolete instances if they are not already bound to a VM has a flog score of 29</span>          </div>  </li></ol>
      az = BD::DeploymentPlan::AvailabilityZone.new(&#39;az&#39;, {})
      instance0 = BD::DeploymentPlan::Instance.create_from_instance_group(instance_group, 6, &#39;started&#39;, nil, {}, az, logger)
      instance0.bind_existing_instance_model(BD::Models::Instance.make(bootstrap: true))
      instance1 = BD::DeploymentPlan::Instance.create_from_instance_group(instance_group, 6, &#39;started&#39;, nil, {}, az, logger)
      instance_plan0 = BD::DeploymentPlan::InstancePlan.new(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L497" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L502" class="js-smell-location">1</a>                  </div>  </li></ol>
        desired_instance: instance_double(Bosh::Director::DeploymentPlan::DesiredInstance),
        existing_instance: nil,
        instance: instance0,
      )
      instance_plan1 = BD::DeploymentPlan::InstancePlan.new(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L497" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L502" class="js-smell-location">1</a>                  </div>  </li></ol>
        desired_instance: instance_double(Bosh::Director::DeploymentPlan::DesiredInstance),
        existing_instance: nil,
        instance: instance1,
      )
      obsolete_plan = BD::DeploymentPlan::InstancePlan.new(desired_instance: nil, existing_instance: nil, instance: instance1)

      instance_group.add_instance_plans([instance_plan0, instance_plan1, obsolete_plan])
    end
  end

  describe &#39;#bind_instances&#39; do
    subject(:instance_group) { described_class.new(logger) }

    it &#39;makes sure theres a model and binds instance networks&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#bind_instances)::it#makes sure theres a model and binds instance networks has a flog score of 108</span>          </div>  </li></ol>
      az = BD::DeploymentPlan::AvailabilityZone.new(&#39;az&#39;, {})
      instance0 = BD::DeploymentPlan::Instance.create_from_instance_group(instance_group, 6, &#39;started&#39;, nil, {}, az, logger)
      instance0.bind_existing_instance_model(BD::Models::Instance.make(bootstrap: true))
      instance1 = BD::DeploymentPlan::Instance.create_from_instance_group(instance_group, 6, &#39;started&#39;, nil, {}, az, logger)
      instance0_reservation = BD::DesiredNetworkReservation.new_dynamic(instance0.model, network)
      instance0_obsolete_reservation = BD::DesiredNetworkReservation.new_dynamic(instance0.model, network)
      instance1_reservation = BD::DesiredNetworkReservation.new_dynamic(instance1.model, network)
      instance1_existing_reservation = BD::ExistingNetworkReservation.new(instance1.model, network, &#39;10.0.0.1&#39;, &#39;manual&#39;)
      instance_plan0 = Bosh::Director::DeploymentPlan::InstancePlan.new(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L525" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L530" class="js-smell-location">1</a>                  </div>  </li></ol>
        desired_instance: BD::DeploymentPlan::DesiredInstance.new,
        existing_instance: nil,
        instance: instance0,
      )
      instance_plan1 = Bosh::Director::DeploymentPlan::InstancePlan.new(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L525" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L530" class="js-smell-location">1</a>                  </div>  </li></ol>
        desired_instance: BD::DeploymentPlan::DesiredInstance.new,
        existing_instance: nil,
        instance: instance1,
      )
      instance_plan0.network_plans = [
        BD::DeploymentPlan::NetworkPlanner::Plan.new(reservation: instance0_reservation),
        BD::DeploymentPlan::NetworkPlanner::Plan.new(reservation: instance0_obsolete_reservation, obsolete: true),
      ]
      instance_plan1.network_plans = [
        BD::DeploymentPlan::NetworkPlanner::Plan.new(reservation: instance1_reservation),
        BD::DeploymentPlan::NetworkPlanner::Plan.new(reservation: instance1_existing_reservation),
      ]

      obsolete_plan = Bosh::Director::DeploymentPlan::InstancePlan.new(
        desired_instance: nil,
        existing_instance: nil,
        instance: instance1,
      )

      instance_group.add_instance_plans([instance_plan0, instance_plan1, obsolete_plan])

      [instance0, instance1].each do |instance|
        expect(instance).to receive(:ensure_model_bound).with(no_args).ordered
      end

      instance_group.bind_instances(fake_ip_provider)

      expect(fake_ip_provider).to have_received(:reserve).with(instance0_reservation)
      expect(fake_ip_provider).to have_received(:reserve).with(instance1_reservation)
      expect(fake_ip_provider).to_not have_received(:reserve).with(instance0_obsolete_reservation)
      expect(fake_ip_provider).to_not have_received(:reserve_existing_ips).with(instance1_existing_reservation)
    end
  end

  describe &#39;#service?&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L565" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L577" class="js-smell-location">1</a>                  </div>  </li></ol>
    context &quot;when lifecycle profile is &#39;service&#39;&quot; do
      before { subject.lifecycle = &#39;service&#39; }
      its(:service?) { should be(true) }
    end

    context &#39;when lifecycle profile is not service&#39; do
      before { subject.lifecycle = &#39;other&#39; }
      its(:service?) { should be(false) }
    end
  end

  describe &#39;#errand?&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L565" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L577" class="js-smell-location">1</a>                  </div>  </li></ol>
    context &quot;when lifecycle profile is &#39;errand&#39;&quot; do
      before { subject.lifecycle = &#39;errand&#39; }
      its(:errand?) { should be(true) }
    end

    context &#39;when lifecycle profile is not errand&#39; do
      before { subject.lifecycle = &#39;other&#39; }
      its(:errand?) { should be(false) }
    end
  end

  describe &#39;#create_swap_delete?&#39; do
    context &#39;when vm_strategy is create-swap-delete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L590" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L598" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L627" class="js-smell-location">2</a>                  </div>  </li></ol>
      before do
        allow(update_config).to receive(:vm_strategy).and_return &#39;create-swap-delete&#39;
      end

      it { should be_create_swap_delete }
    end

    context &#39;when vm_strategy is not create-swap-delete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L590" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L598" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L627" class="js-smell-location">2</a>                  </div>  </li></ol>
      before do
        allow(update_config).to receive(:vm_strategy).and_return &#39;something-else&#39;
      end

      it { should_not be_create_swap_delete }
    end
  end

  describe &#39;#should_create_swap_delete?&#39; do
    context &#39;when vm_strategy is create-swap-delete&#39; do
      before do
        allow(update_config).to receive(:vm_strategy).and_return &#39;create-swap-delete&#39;
        subject.networks = [job_network]
      end

      context &#39;when instance_group does not have static ips&#39; do
        let(:job_network) { instance_double(Bosh::Director::DeploymentPlan::JobNetwork, static?: false) }

        it { should be_should_create_swap_delete }
      end

      context &#39;when instance_group has static ips&#39; do
        let(:job_network) { instance_double(Bosh::Director::DeploymentPlan::JobNetwork, static?: true) }

        it { should_not be_should_create_swap_delete }
      end
    end

    context &#39;when vm_strategy is not create-swap-delete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L590" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L598" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L627" class="js-smell-location">2</a>                  </div>  </li></ol>
      before do
        allow(update_config).to receive(:vm_strategy).and_return &#39;something-else&#39;
      end

      it { should_not be_should_create_swap_delete }
    end
  end

  describe &#39;#add_instance_plans&#39; do
    let(:spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L637" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L715" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L798" class="js-smell-location">2</a>                  <a href="instance_group_spec.html#L835" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;name&#39; =&gt; &#39;foobar&#39;,
        &#39;release&#39; =&gt; &#39;appcloud&#39;,
        &#39;instances&#39; =&gt; 1,
        &#39;vm_type&#39; =&gt; &#39;dea&#39;,
        &#39;stemcell&#39; =&gt; &#39;dea&#39;,
        &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
        &#39;properties&#39; =&gt; {},
        &#39;template&#39; =&gt; %w[foo bar],
      }
    end

    it &#39;should sort instance plans on adding them&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#add_instance_plans)::it#should sort instance plans on adding them has a flog score of 85</span>          </div>  </li></ol>
      allow(plan).to receive(:properties).and_return({})
      allow(plan).to receive(:release).with(&#39;appcloud&#39;).and_return(release1)
      expect(SecureRandom).to receive(:uuid).and_return(&#39;y-uuid-1&#39;, &#39;b-uuid-2&#39;, &#39;c-uuid-3&#39;)

      instance1 = BD::DeploymentPlan::Instance.create_from_instance_group(
        instance_group,
        1,
        &#39;started&#39;,
        deployment,
        {},
        nil,
        logger,
      )
      instance1.bind_new_instance_model
      instance1.mark_as_bootstrap
      instance2 = BD::DeploymentPlan::Instance.create_from_instance_group(
        instance_group,
        2,
        &#39;started&#39;,
        deployment,
        {},
        nil,
        logger,
      )
      instance2.bind_new_instance_model
      instance3 = BD::DeploymentPlan::Instance.create_from_instance_group(
        instance_group,
        3,
        &#39;started&#39;,
        deployment,
        {},
        nil,
        logger,
      )
      instance3.bind_new_instance_model

      desired_instance = BD::DeploymentPlan::DesiredInstance.new
      instance_plan1 = BD::DeploymentPlan::InstancePlan.new(
        instance: instance1,
        existing_instance: nil,
        desired_instance: desired_instance,
      )
      instance_plan2 = BD::DeploymentPlan::InstancePlan.new(
        instance: instance2,
        existing_instance: nil,
        desired_instance: desired_instance,
      )
      instance_plan3 = BD::DeploymentPlan::InstancePlan.new(
        instance: instance3,
        existing_instance: nil,
        desired_instance: nil,
      )

      unsorted_plans = [instance_plan3, instance_plan1, instance_plan2]
      instance_group.add_instance_plans(unsorted_plans)

      needed_instance_plans = [instance_plan1, instance_plan2]

      expect(instance_group.needed_instance_plans).to eq(needed_instance_plans)
      expect(instance_group.obsolete_instance_plans).to eq([instance_plan3])
    end
  end

  describe &#39;#unignored_instance_plans&#39; do
    let(:spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L637" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L715" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L798" class="js-smell-location">2</a>                  <a href="instance_group_spec.html#L835" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;name&#39; =&gt; &#39;foobar&#39;,
        &#39;release&#39; =&gt; &#39;appcloud&#39;,
        &#39;instances&#39; =&gt; 1,
        &#39;vm_type&#39; =&gt; &#39;dea&#39;,
        &#39;stemcell&#39; =&gt; &#39;dea&#39;,
        &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
        &#39;properties&#39; =&gt; {},
        &#39;template&#39; =&gt; %w[foo bar],
      }
    end

    it &#39;should NOT return instance plans for ignored and detached instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#unignored_instance_plans)::it#should NOT return instance plans for ignored and detached instances has a flog score of 69</span>          </div>  </li></ol>
      allow(plan).to receive(:properties).and_return({})
      allow(plan).to receive(:release).with(&#39;appcloud&#39;).and_return(release1)
      expect(SecureRandom).to receive(:uuid).and_return(&#39;y-uuid-1&#39;, &#39;b-uuid-2&#39;)

      instance1 = BD::DeploymentPlan::Instance.create_from_instance_group(
        instance_group,
        1,
        &#39;started&#39;,
        deployment,
        {},
        nil,
        logger,
      )
      instance1.bind_new_instance_model
      instance1.mark_as_bootstrap
      instance2 = BD::DeploymentPlan::Instance.create_from_instance_group(
        instance_group,
        2,
        &#39;started&#39;,
        deployment,
        {},
        nil,
        logger,
      )
      instance2.bind_new_instance_model

      instance2.model.update(ignore: true)

      desired_instance = BD::DeploymentPlan::DesiredInstance.new
      instance_plan1 = BD::DeploymentPlan::InstancePlan.new(
        instance: instance1,
        existing_instance: nil,
        desired_instance: desired_instance,
      )
      instance_plan2 = BD::DeploymentPlan::InstancePlan.new(
        instance: instance2,
        existing_instance: nil,
        desired_instance: desired_instance,
      )
      instance_group.add_instance_plans([instance_plan1, instance_plan2])

      unignored_instance_plans = [instance_plan1]
      expect(instance_group.unignored_instance_plans).to eq(unignored_instance_plans)
    end
  end

  describe &#39;#add_job&#39; do
    context &#39;when job does not exist in instance group&#39; do
      it &#39;adds job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#add_job)::context(when job does not exist in instance group)::it#adds job has a flog score of 48</span>          </div>  </li></ol>
        subject.add_job(release1_foo_job_model)
        expect(subject.jobs.count).to eq(1)

        expect(subject.jobs.first.name).to eq(&#39;foo&#39;)
        expect(subject.jobs.first.release.name).to eq(&#39;release1&#39;)
      end
    end

    context &#39;when job does exists in instance group&#39; do
      it &#39;throws an exception&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#add_job)::context(when job does exists in instance group)::it#throws an exception has a flog score of 25</span>          </div>  </li></ol>
        subject.add_job(release1_foo_job_model)
        expect { subject.add_job(release1_foo_job_model) }.to raise_error(
          &quot;Colocated job &#39;#{release1_foo_job_model.name}&#39; is already added &quot;\
          &quot;to the instance group &#39;#{subject.name}&#39;.&quot;,
        )
      end
    end
  end

  describe &#39;#referenced_variable_sets&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe##referenced_variable_sets has a flog score of 70</span>          </div>  </li></ol>
    let(:spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L637" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L715" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L798" class="js-smell-location">2</a>                  <a href="instance_group_spec.html#L835" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;name&#39; =&gt; &#39;foobar&#39;,
        &#39;release&#39; =&gt; &#39;appcloud&#39;,
        &#39;instances&#39; =&gt; 1,
        &#39;vm_type&#39; =&gt; &#39;dea&#39;,
        &#39;stemcell&#39; =&gt; &#39;dea&#39;,
        &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
        &#39;properties&#39; =&gt; {},
        &#39;template&#39; =&gt; %w[foo bar],
      }
    end
    let(:variable_set1) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:variable_set2) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:instance1) { instance_double(Bosh::Director::DeploymentPlan::Instance) }
    let(:instance2) { instance_double(Bosh::Director::DeploymentPlan::Instance) }
    let(:instance_plan1) { instance_double(BD::DeploymentPlan::InstancePlan) }
    let(:instance_plan2) { instance_double(BD::DeploymentPlan::InstancePlan) }

    before do
      allow(plan).to receive(:properties).and_return({})
      allow(plan).to receive(:release).with(&#39;appcloud&#39;).and_return(release1)

      allow(instance1).to receive(:desired_variable_set).and_return(variable_set1)
      allow(instance2).to receive(:desired_variable_set).and_return(variable_set2)

      allow(instance_plan1).to receive(:instance).and_return(instance1)
      allow(instance_plan2).to receive(:instance).and_return(instance2)
    end

    it &#39;returns a list of variable sets referenced by the needed_instance_plans&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#referenced_variable_sets)::it#returns a list of variable sets referenced by the needed_instance_plans has a flog score of 27</span>          </div>  </li></ol>
      expect(instance_group).to receive(:needed_instance_plans).and_return([instance_plan1, instance_plan2])
      expect(instance_group.referenced_variable_sets).to contain_exactly(variable_set1, variable_set2)
    end
  end

  describe &#39;#bind_new_variable_set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe##bind_new_variable_set has a flog score of 171</span>          </div>  </li></ol>
    let(:spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L637" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L715" class="js-smell-location">1</a>                  <a href="instance_group_spec.html#L798" class="js-smell-location">2</a>                  <a href="instance_group_spec.html#L835" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;name&#39; =&gt; &#39;foobar&#39;,
        &#39;release&#39; =&gt; &#39;appcloud&#39;,
        &#39;instances&#39; =&gt; 1,
        &#39;vm_type&#39; =&gt; &#39;dea&#39;,
        &#39;stemcell&#39; =&gt; &#39;dea&#39;,
        &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
        &#39;properties&#39; =&gt; {},
        &#39;template&#39; =&gt; %w[foo bar],
      }
    end
    let(:current_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:variable_set_model_1) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:variable_set_model_2) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:variable_set_model_3) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:variable_set_model_4) { instance_double(Bosh::Director::Models::VariableSet) }
    let(:instance_model_1) { instance_double(Bosh::Director::Models::Instance) }
    let(:instance_model_2) { instance_double(Bosh::Director::Models::Instance) }
    let(:instance_model_3) { instance_double(Bosh::Director::Models::Instance) }
    let(:instance_model_4) { instance_double(Bosh::Director::Models::Instance) }
    let(:instance_1) { instance_double(Bosh::Director::DeploymentPlan::Instance) }
    let(:instance_2) { instance_double(Bosh::Director::DeploymentPlan::Instance) }
    let(:instance_3) { instance_double(Bosh::Director::DeploymentPlan::Instance) }
    let(:instance_4) { instance_double(Bosh::Director::DeploymentPlan::Instance) }
    let(:instance_plan_1) { instance_double(BD::DeploymentPlan::InstancePlan) }
    let(:instance_plan_2) { instance_double(BD::DeploymentPlan::InstancePlan) }
    let(:instance_plan_3) { instance_double(BD::DeploymentPlan::InstancePlan) }
    let(:instance_plan_4) { instance_double(BD::DeploymentPlan::InstancePlan) }

    before do
      allow(plan).to receive(:properties).and_return({})
      allow(plan).to receive(:release).with(&#39;appcloud&#39;).and_return(release1)

      allow(instance_model_1).to receive(:variable_set).and_return(variable_set_model_1)
      allow(instance_model_2).to receive(:variable_set).and_return(variable_set_model_2)
      allow(instance_model_3).to receive(:variable_set).and_return(variable_set_model_3)
      allow(instance_model_4).to receive(:variable_set).and_return(variable_set_model_4)

      allow(instance_1).to receive(:model).and_return(instance_model_1)
      allow(instance_2).to receive(:model).and_return(instance_model_2)
      allow(instance_3).to receive(:model).and_return(instance_model_3)
      allow(instance_4).to receive(:model).and_return(instance_model_4)

      allow(instance_plan_1).to receive(:instance).and_return(instance_1)
      allow(instance_plan_2).to receive(:instance).and_return(instance_2)
      allow(instance_plan_3).to receive(:instance).and_return(instance_3)
      allow(instance_plan_4).to receive(:instance).and_return(instance_4)

      allow(instance_group).to receive(:obsolete_instance_plans).and_return([instance_plan_3])
    end

    it &#39;sets the instance object desired_variable_set to the new variable set for all unignored_instance_plans&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#bind_new_variable_set)::it#sets the instance object desired_variable_set to the new variable set for all unignored_instance_plans has a flog score of 61</span>          </div>  </li></ol>
      expect(instance_group).to receive(:unignored_instance_plans).and_return([instance_plan_1, instance_plan_2])

      expect(instance_1).to receive(:desired_variable_set=).with(current_variable_set)
      expect(instance_2).to receive(:desired_variable_set=).with(current_variable_set)
      expect(instance_3).to_not receive(:desired_variable_set=).with(current_variable_set)
      expect(instance_4).to_not receive(:desired_variable_set=).with(current_variable_set)

      instance_group.bind_new_variable_set(current_variable_set)
    end
  end

  describe &#39;#default_network_name&#39; do
    before do
      subject.default_network[&#39;gateway&#39;] = &#39;gateway-default-network&#39;
      subject.default_network[&#39;dns&#39;] = &#39;dns-default-network&#39;
    end

    it &#39;returns the gateway network name&#39; do
      expect(subject.default_network_name).to eq(&#39;gateway-default-network&#39;)
    end

    context &#39;when addressable is specified&#39; do
      before do
        subject.default_network[&#39;addressable&#39;] = &#39;something&#39;
      end

      it &#39;returns the addressable network&#39; do
        expect(subject.default_network_name).to eq(&#39;something&#39;)
      end
    end
  end

  describe &#39;#unignored_instance_plans_needing_duplicate_vm&#39; do
    let(:instance_plan_instance) { instance_double(BD::DeploymentPlan::Instance, vm_created?: true, state: &#39;started&#39;) }
    let(:instance_plan) do
      instance_double(BD::DeploymentPlan::InstancePlan, instance: instance_plan_instance, new?: false, needs_duplicate_vm?: true, should_be_ignored?: false)
    end
    let(:instance_plan_sorter) { instance_double(BD::DeploymentPlan::InstancePlanSorter, sort: [instance_plan]) }

    before do
      allow(BD::DeploymentPlan::InstancePlanSorter).to receive(:new).and_return(instance_plan_sorter)
    end

    context &#39;when the plan has a created instance and needs shutting down&#39; do
      it &#39;selects the instance plan&#39; do
        expect(subject.unignored_instance_plans_needing_duplicate_vm).to eq([instance_plan])
      end
    end

    context &#39;when instance group contains detached instance plan&#39; do
      before do
        allow(instance_plan_instance).to receive(:state).and_return(&#39;detached&#39;)
      end

      it &#39;should filter detached instance plans&#39; do
        expect(subject.unignored_instance_plans_needing_duplicate_vm).to be_empty
      end
    end

    context &#39;when the instance plan should be ignored&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L947" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L957" class="js-smell-location">1</a>                  </div>  </li></ol>
      before do
        allow(instance_plan).to receive(:should_be_ignored?).and_return(true)
      end

      it &#39;should not be considered for hot swap&#39; do
        expect(subject.unignored_instance_plans_needing_duplicate_vm).to be_empty
      end
    end

    context &#39;when a new instance is added to a deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec.html#L947" class="js-smell-location">0</a>                  <a href="instance_group_spec.html#L957" class="js-smell-location">1</a>                  </div>  </li></ol>
      before do
        allow(instance_plan).to receive(:new?).and_return(true)
      end

      it &#39;should not be considered for hot swap&#39; do
        expect(subject.unignored_instance_plans_needing_duplicate_vm).to be_empty
      end
    end

    context &#39;when the instance does not need shutting down&#39; do
      before do
        allow(instance_plan).to receive(:needs_duplicate_vm?).and_return(false)
      end

      it &#39;should not be considered for hot swap&#39; do
        expect(subject.unignored_instance_plans_needing_duplicate_vm).to be_empty
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
