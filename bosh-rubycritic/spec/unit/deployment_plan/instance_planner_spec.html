<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> instance_planner_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">698</span><small> lines of codes</small></div>
              <div><span class="metric">2</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">895.2</span><small> complexity/method</small></div>
              <div><span class="metric">56</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1790.48</span><small> complexity</small></div>
              <div><span class="metric">276</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                30
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;json&#39;

describe &#39;BD::DeploymentPlan::InstancePlanner&#39; do
  include BD::IpUtil

  subject(:instance_planner) { BD::DeploymentPlan::InstancePlanner.new(instance_plan_factory, logger) }
  let(:network_reservation_repository) { BD::DeploymentPlan::NetworkReservationRepository.new(deployment, logger) }
  let(:instance_plan_factory) { BD::DeploymentPlan::InstancePlanFactory.new(instance_repo, {}, skip_drain_decider, index_assigner, network_reservation_repository, options) }
  let(:index_assigner) { BD::DeploymentPlan::PlacementPlanner::IndexAssigner.new(deployment_model) }
  let(:options) do
    {}
  end
  let(:skip_drain_decider) { BD::DeploymentPlan::AlwaysSkipDrain.new }
  let(:logger) { instance_double(Logger, debug: nil, info: nil) }
  let(:instance_repo) { BD::DeploymentPlan::InstanceRepository.new(network_reservation_repository, logger) }
  let(:deployment) { instance_double(BD::DeploymentPlan::Planner, model: deployment_model) }
  let(:deployment_model) { BD::Models::Deployment.make }
  let(:variable_set_model) { BD::Models::VariableSet.create(deployment: deployment_model) }
  let(:az) do
    BD::DeploymentPlan::AvailabilityZone.new(
      &#39;foo-az&#39;,
      {&#39;some-cloud-property&#39; =&gt; &#39;foo&#39;}
    )
  end
  let(:undesired_az) do
    BD::DeploymentPlan::AvailabilityZone.new(
      &#39;old-az&#39;,
      {&#39;some-cloud-property&#39; =&gt; &#39;foo&#39;}
    )
  end
  let(:instance_group) do
    instance_group = BD::DeploymentPlan::InstanceGroup.new(logger)
    instance_group.name = &#39;foo-instance_group&#39;
    instance_group.availability_zones &lt;&lt; az
    instance_group
  end
  let(:desired_instance) { BD::DeploymentPlan::DesiredInstance.new(instance_group, deployment) }
  let(:tracer_instance) do
    make_instance
  end
  let(:vm_resources_cache) { instance_double(BD::DeploymentPlan::VmResourcesCache) }

  before do
    allow(deployment_model).to receive(:current_variable_set).and_return(variable_set_model)
  end

  def make_instance(idx=0)
    instance = BD::DeploymentPlan::Instance.create_from_instance_group(instance_group, idx, &#39;started&#39;, deployment_model, {}, az, logger)
    instance.bind_new_instance_model
    instance
  end

  def make_instance_with_existing_model(existing_instance_model)
    instance = BD::DeploymentPlan::Instance.create_from_instance_group(instance_group, existing_instance_model.index, &#39;started&#39;, deployment_model, {}, az, logger)
    instance.bind_existing_instance_model(existing_instance_model)
    instance
  end

  describe &#39;plan_instance_group_instances&#39; do
    before do
      allow(instance_group).to receive(:networks).and_return([])
    end

    it &#39;creates instance plans for existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::it#creates instance plans for existing instances has a flog score of 112</span>          </div>  </li></ol>
      existing_instance_model = BD::Models::Instance.make(
        job: &#39;foo-instance_group&#39;,
        index: 0,
        availability_zone: az.name,
        variable_set: variable_set_model,
      )

      allow(instance_repo).to receive(:fetch_existing).with(
        existing_instance_model,
        nil,
        instance_group,
        0,
        deployment,
      ).and_return(tracer_instance)

      instance_plans = instance_planner.plan_instance_group_instances(
        instance_group,
        [desired_instance],
        [existing_instance_model],
        vm_resources_cache,
      )

      expect(instance_plans.count).to eq(1)
      existing_instance_plan = instance_plans.first

      expected_desired_instance = BD::DeploymentPlan::DesiredInstance.new(
        instance_group,
        deployment,
        az,
        0,
      )
      expect(existing_instance_plan.new?).to eq(false)
      expect(existing_instance_plan.obsolete?).to eq(false)

      expect(existing_instance_plan.desired_instance.instance_group).to eq(expected_desired_instance.instance_group)
      expect(existing_instance_plan.desired_instance.deployment).to eq(expected_desired_instance.deployment)
      expect(existing_instance_plan.desired_instance.az).to eq(expected_desired_instance.az)
      expect(existing_instance_plan.instance.bootstrap?).to eq(true)

      expect(existing_instance_plan.instance).to eq(tracer_instance)
      expect(existing_instance_plan.existing_instance).to eq(existing_instance_model)
    end

    it &#39;updates descriptions for existing instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::it#updates descriptions for existing instances has a flog score of 38</span>          </div>  </li></ol>
      existing_instance_model = BD::Models::Instance.make(
        job: &#39;foo-instance_group&#39;,
        index: 0,
        availability_zone: az.name,
        variable_set: variable_set_model,
      )
      allow(instance_repo).to receive(:fetch_existing).with(
        existing_instance_model,
        nil,
        instance_group,
        0,
        deployment,
      ).and_return(tracer_instance)
      expect(tracer_instance).to receive(:update_description)

      instance_planner.plan_instance_group_instances(
        instance_group,
        [desired_instance],
        [existing_instance_model],
        vm_resources_cache,
      )
    end

    it &#39;creates instance plans for new instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::it#creates instance plans for new instances has a flog score of 69</span>          </div>  </li></ol>
      existing_instances = []
      allow(instance_repo).to receive(:create).with(desired_instance, 0) { tracer_instance }

      instance_plans = instance_planner.plan_instance_group_instances(
        instance_group,
        [desired_instance],
        existing_instances,
        vm_resources_cache,
      )

      expect(instance_plans.count).to eq(1)
      new_instance_plan = instance_plans.first

      expect(new_instance_plan.new?).to eq(true)
      expect(new_instance_plan.obsolete?).to eq(false)
      expect(new_instance_plan.desired_instance).to eq(desired_instance)
      expect(new_instance_plan.instance).to eq(tracer_instance)
      expect(new_instance_plan.existing_instance).to be_nil
      expect(new_instance_plan).to be_new
    end

    it &#39;creates instance plans for new, existing and obsolete instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::it#creates instance plans for new, existing and obsolete instances has a flog score of 133</span>          </div>  </li></ol>
      out_of_typical_range_index = 77
      auto_picked_index = 0

      desired_existing_instance_model = BD::Models::Instance.make(
        job: &#39;foo-instance_group&#39;,
        index: out_of_typical_range_index,
        availability_zone: az.name,
        variable_set: variable_set_model,
      )

      desired_instances = [
        desired_instance,
        BD::DeploymentPlan::DesiredInstance.new(
          instance_group,
          deployment,
          az,
          out_of_typical_range_index,
        ),
      ]

      undesired_existing_instance_model = BD::Models::Instance.make(
        job: &#39;foo-instance_group&#39;,
        index: auto_picked_index,
        availability_zone: undesired_az.name,
        variable_set: variable_set_model,
      )
      existing_instances = [undesired_existing_instance_model, desired_existing_instance_model]
      allow(instance_repo).to receive(:fetch_existing).with(
        desired_existing_instance_model,
        nil,
        instance_group,
        out_of_typical_range_index,
        deployment,
      ) do
        make_instance(out_of_typical_range_index)
      end

      allow(instance_repo).to receive(:create).with(desired_instances[1], 0) { make_instance(auto_picked_index) }

      instance_plans = instance_planner.plan_instance_group_instances(
        instance_group,
        desired_instances,
        existing_instances,
        vm_resources_cache,
      )
      expect(instance_plans.count).to eq(3)

      obsolete_instance_plan = instance_plans.find(&amp;:obsolete?)
      expect(obsolete_instance_plan.new?).to eq(false)
      expect(obsolete_instance_plan.obsolete?).to eq(true)
      expect(obsolete_instance_plan.desired_instance).to be_nil
      expect(obsolete_instance_plan.existing_instance).to eq(undesired_existing_instance_model)
      expect(obsolete_instance_plan.instance).not_to be_nil

      existing_instance_plan = instance_plans.find(&amp;:existing?)
      expect(existing_instance_plan.new?).to eq(false)
      expect(existing_instance_plan.obsolete?).to eq(false)

      new_instance_plan = instance_plans.find(&amp;:new?)
      expect(new_instance_plan.new?).to eq(true)
      expect(new_instance_plan.obsolete?).to eq(false)
    end

    context &#39;when instance should skip running drain script&#39; do
      let(:skip_drain_decider) { BD::DeploymentPlan::SkipDrain.new(&#39;*&#39;) }

      it &#39;should set &quot;skip_drain&quot; on the instance plan&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L222" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L239" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(when instance should skip running drain script)::it#should set "skip_drain" on the instance plan has a flog score of 30</span>          </div>  </li></ol>
        existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, availability_zone: az.name)
        instance_plans = instance_planner.plan_instance_group_instances(
          instance_group,
          [desired_instance],
          [existing_instance_model],
          vm_resources_cache,
        )
        expect(instance_plans.select(&amp;:skip_drain).count).to eq(instance_plans.count)
      end
    end

    context &#39;when deployment is being recreated&#39; do
      let(:options) do
        { &#39;recreate&#39; =&gt; true }
      end

      it &#39;should return instance plans with &quot;recreate&quot; option set on them&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L222" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L239" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(when deployment is being recreated)::it#should return instance plans with "recreate" option set on them has a flog score of 30</span>          </div>  </li></ol>
        existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, availability_zone: az.name)

        instance_plans = instance_planner.plan_instance_group_instances(
          instance_group,
          [desired_instance],
          [existing_instance_model],
          vm_resources_cache,
        )

        expect(instance_plans.select(&amp;:recreate_deployment).count).to eq(instance_plans.count)
      end
    end

    context &#39;when there are ignored instances&#39; do
      it &#39;fails if specifically changing the state of ignored vms&#39; do
        existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, ignore: true)
        instance_group.instance_states = {&#39;0&#39; =&gt; &quot;stopped&quot;}
        expect {
          instance_planner.plan_instance_group_instances(instance_group, [desired_instance], [existing_instance_model], vm_resources_cache)
        }.to raise_error(
          Bosh::Director::JobInstanceIgnored,
          &quot;You are trying to change the state of the ignored instance &#39;foo-instance_group/#{existing_instance_model.uuid}&#39;. &quot; +
              &quot;This operation is not allowed. You need to unignore it first.&quot;
        )
      end
    end

    context &#39;when instance_group has no az&#39; do
      before { instance_group.availability_zones = [] }

      it &#39;creates instance plans for new instances with no az&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(when instance_group has no az)::it#creates instance plans for new instances with no az has a flog score of 110</span>          </div>  </li></ol>
        existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0)

        allow(instance_repo).to receive(:fetch_existing).with(existing_instance_model, nil, instance_group, 0, deployment) { tracer_instance }

        instance_plans = instance_planner.plan_instance_group_instances(instance_group, [desired_instance], [existing_instance_model], vm_resources_cache)

        expect(instance_plans.count).to eq(1)
        existing_instance_plan = instance_plans.first

        expected_desired_instance = BD::DeploymentPlan::DesiredInstance.new(
          instance_group,
          deployment,
          nil,
          0
        )
        expect(existing_instance_plan.new?).to eq(false)
        expect(existing_instance_plan.obsolete?).to eq(false)

        expect(existing_instance_plan.desired_instance.instance_group).to eq(expected_desired_instance.instance_group)
        expect(existing_instance_plan.desired_instance.deployment).to eq(expected_desired_instance.deployment)
        expect(existing_instance_plan.desired_instance.az).to eq(expected_desired_instance.az)
        expect(existing_instance_plan.instance.bootstrap?).to eq(true)

        expect(existing_instance_plan.instance).to eq(tracer_instance)
        expect(existing_instance_plan.existing_instance).to eq(existing_instance_model)
      end
    end

    context &#39;logging active vm presence&#39; do
      context &#39;when instance has active vm&#39; do
        it &#39;logs that theres is a vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(logging active vm presence)::context(when instance has active vm)::it#logs that theres is a vm has a flog score of 33</span>          </div>  </li></ol>
          existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, availability_zone: az.name)
          vm = BD::Models::Vm.make(instance: existing_instance_model)
          existing_instance_model.active_vm = vm

          expect(logger).to receive(:info).with(&quot;Existing desired instance &#39;#{existing_instance_model.job}/#{existing_instance_model.index}&#39; in az &#39;#{az.name}&#39; with active vm&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L306" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L315" class="js-smell-location">1</a>                  </div>  </li></ol>
          instance_planner.plan_instance_group_instances(instance_group, [desired_instance], [existing_instance_model], vm_resources_cache)
        end
      end

      context &#39;when instance has active vm&#39; do
        it &#39;logs that theres is no active vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(logging active vm presence)::context(when instance has active vm)::it#logs that theres is no active vm has a flog score of 31</span>          </div>  </li></ol>
          existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, availability_zone: az.name)

          expect(logger).to receive(:info).with(&quot;Existing desired instance &#39;#{existing_instance_model.job}/#{existing_instance_model.index}&#39; in az &#39;#{az.name}&#39; with no active vm&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L306" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L315" class="js-smell-location">1</a>                  </div>  </li></ol>
          instance_planner.plan_instance_group_instances(instance_group, [desired_instance], [existing_instance_model], vm_resources_cache)
        end
      end
    end

    context &#39;moving an instance to a different az&#39; do
      it &quot;should not attempt to reuse the existing instance&#39;s index&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(moving an instance to a different az)::it#should not attempt to reuse the existing instance's index has a flog score of 78</span>          </div>  </li></ol>
        existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, availability_zone: undesired_az.name, deployment: deployment_model, :variable_set =&gt; variable_set_model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L323" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L324" class="js-smell-location">1</a>                  <a href="instance_planner_spec.html#L401" class="js-smell-location">2</a>                  </div>  </li></ol>
        another_existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 1, availability_zone: undesired_az.name, deployment: deployment_model, :variable_set =&gt; variable_set_model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L323" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L324" class="js-smell-location">1</a>                  <a href="instance_planner_spec.html#L401" class="js-smell-location">2</a>                  </div>  </li></ol>
        existing_instances = [existing_instance_model, another_existing_instance_model]

        desired_instances = [desired_instance]
        expected_new_instance_index = 2
        allow(instance_repo).to receive(:create).with(desired_instances[0], expected_new_instance_index) { make_instance(2) }

        instance_plans = instance_planner.plan_instance_group_instances(instance_group, desired_instances, existing_instances, vm_resources_cache)

        expect(instance_plans.count).to eq(3)
        obsolete_instance_plans = instance_plans.select(&amp;:obsolete?)
        expect(obsolete_instance_plans.map(&amp;:existing_instance)).to eq(
            [existing_instance_model, another_existing_instance_model])

        new_instance_plan = instance_plans.find(&amp;:new?)
        expect(new_instance_plan.new?).to eq(true)
        expect(new_instance_plan.obsolete?).to eq(false)
      end
    end

    context &#39;when vm requirements are given&#39; do

      let(:instance_group) do
        instance_group = BD::DeploymentPlan::InstanceGroup.new(logger)
        instance_group.name = &#39;foo-instance_group&#39;
        instance_group.vm_resources = BD::DeploymentPlan::VmResources.new(&#39;cpu&#39; =&gt; 4, &#39;ram&#39; =&gt; 2048, &#39;ephemeral_disk_size&#39; =&gt; 100)
        instance_group.availability_zones &lt;&lt; az
        instance_group
      end

      it &#39;updates the cloud properties with the vm requirements retrieved via the CPI&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(when vm requirements are given)::it#updates the cloud properties with the vm requirements retrieved via the CPI has a flog score of 53</span>          </div>  </li></ol>
        existing_instances = []
        allow(instance_repo).to receive(:create).with(desired_instance, 0) { tracer_instance }
        allow(vm_resources_cache).to receive(:get_vm_cloud_properties).and_return({&#39;vm_resources&#39; =&gt; &#39;foo&#39;})

        instance_plans = instance_planner.plan_instance_group_instances(instance_group, [desired_instance], existing_instances, vm_resources_cache)

        expect(vm_resources_cache).to have_received(:get_vm_cloud_properties).once
        expect(instance_plans.first.instance.cloud_properties).to include({&#39;vm_resources&#39; =&gt; &#39;foo&#39;})
      end

      it &#39;does not update the cloud properties if planned instance is obsolete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(when vm requirements are given)::it#does not update the cloud properties if planned instance is obsolete has a flog score of 51</span>          </div>  </li></ol>
        existing_instances = [BD::Models::Instance.make(job: &#39;foo-instance-group&#39;, index: 0)]
        desired_instances = []
        allow(instance_repo).to receive(:create).with(desired_instance, 0) { tracer_instance }
        allow(vm_resources_cache).to receive(:get_vm_cloud_properties).and_return({&#39;vm_resources&#39; =&gt; &#39;foo&#39;})

        instance_plans = instance_planner.plan_instance_group_instances(instance_group, desired_instances, existing_instances, vm_resources_cache)

        expect(vm_resources_cache).to_not have_received(:get_vm_cloud_properties)
        expect(instance_plans.first.instance.cloud_properties).to_not include({&#39;vm_resources&#39; =&gt; &#39;foo&#39;})
      end
    end

    context &#39;resolving bootstrap nodes&#39; do
      context &#39;when existing instance is marked as bootstrap&#39; do
        it &#39;keeps bootstrap node&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(resolving bootstrap nodes)::context(when existing instance is marked as bootstrap)::it#keeps bootstrap node has a flog score of 69</span>          </div>  </li></ol>
          existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, bootstrap: true, availability_zone: az.name, :variable_set =&gt; variable_set_model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L381" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L424" class="js-smell-location">1</a>                  <a href="instance_planner_spec.html#L426" class="js-smell-location">2</a>                  </div>  </li></ol>

          existing_tracer_instance = make_instance_with_existing_model(existing_instance_model)
          allow(instance_repo).to receive(:fetch_existing).with(existing_instance_model, nil, instance_group, 0, deployment) { existing_tracer_instance }

          instance_plans = instance_planner.plan_instance_group_instances(instance_group, [desired_instance], [existing_instance_model], vm_resources_cache)

          expect(instance_plans.count).to eq(1)
          existing_instance_plan = instance_plans.first

          expect(existing_instance_plan.new?).to be_falsey
          expect(existing_instance_plan.obsolete?).to be_falsey
          expect(existing_instance_plan.instance).to eq(existing_tracer_instance)
          expect(existing_instance_plan.instance.bootstrap?).to be_truthy
        end
      end

      context &#39;when obsolete instance is marked as bootstrap&#39; do
        it &#39;picks the lowest indexed instance as new bootstrap instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(resolving bootstrap nodes)::context(when obsolete instance is marked as bootstrap)::it#picks the lowest indexed instance as new bootstrap instance has a flog score of 118</span>          </div>  </li></ol>
          existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, bootstrap: true, availability_zone: undesired_az.name, deployment: deployment_model, :variable_set =&gt; variable_set_model)
          another_existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 1, availability_zone: az.name, deployment: deployment_model, :variable_set =&gt; variable_set_model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L323" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L324" class="js-smell-location">1</a>                  <a href="instance_planner_spec.html#L401" class="js-smell-location">2</a>                  </div>  </li></ol>
          another_desired_instance = BD::DeploymentPlan::DesiredInstance.new(instance_group, deployment, az, 1)

          existing_tracer_instance = make_instance_with_existing_model(existing_instance_model)
          allow(instance_repo).to receive(:fetch_existing).with(another_existing_instance_model, nil, instance_group, another_desired_instance.index, deployment) { existing_tracer_instance }
          allow(instance_repo).to receive(:create).with(desired_instance, 2) { make_instance(2) }

          instance_plans = instance_planner.plan_instance_group_instances(instance_group, [another_desired_instance, desired_instance], [existing_instance_model, another_existing_instance_model], vm_resources_cache)

          expect(instance_plans.count).to eq(3)
          desired_existing_instance_plan = instance_plans.find(&amp;:existing?)
          desired_new_instance_plan = instance_plans.find(&amp;:new?)
          obsolete_instance_plans = instance_plans.select(&amp;:obsolete?)

          expect(obsolete_instance_plans.size).to eq(1)
          expect(desired_existing_instance_plan.instance).to eq(existing_tracer_instance)
          expect(desired_existing_instance_plan.instance.bootstrap?).to be_truthy
          expect(desired_new_instance_plan.instance.bootstrap?).to be_falsey
        end
      end

      context &#39;when several existing instances are marked as bootstrap&#39; do
        it &#39;picks the lowest indexed instance as new bootstrap instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(resolving bootstrap nodes)::context(when several existing instances are marked as bootstrap)::it#picks the lowest indexed instance as new bootstrap instance has a flog score of 99</span>          </div>  </li></ol>
          existing_instance_model_1 = BD::Models::Instance.make(job: &#39;foo-instance_group-z1&#39;, index: 0, bootstrap: true, availability_zone: az.name, :variable_set =&gt; variable_set_model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L381" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L424" class="js-smell-location">1</a>                  <a href="instance_planner_spec.html#L426" class="js-smell-location">2</a>                  </div>  </li></ol>
          desired_instance_1 = BD::DeploymentPlan::DesiredInstance.new(instance_group, deployment, az, 0)
          existing_instance_model_2 = BD::Models::Instance.make(job: &#39;foo-instance_group-z2&#39;, index: 0, bootstrap: true, availability_zone: az.name, :variable_set =&gt; variable_set_model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L381" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L424" class="js-smell-location">1</a>                  <a href="instance_planner_spec.html#L426" class="js-smell-location">2</a>                  </div>  </li></ol>
          desired_instance_2 = BD::DeploymentPlan::DesiredInstance.new(instance_group, deployment, az, 1)

          allow(instance_repo).to receive(:fetch_existing).with(existing_instance_model_1, nil, instance_group, desired_instance_1.index, deployment) { make_instance(0) }
          allow(instance_repo).to receive(:fetch_existing).with(existing_instance_model_2, nil, instance_group, desired_instance_2.index, deployment) { make_instance(1) }

          instance_plans = instance_planner.plan_instance_group_instances(instance_group, [desired_instance_1, desired_instance_2], [existing_instance_model_1, existing_instance_model_2], vm_resources_cache)

          expect(instance_plans.count).to eq(2)
          bootstrap_instance_plans = instance_plans.select { |ip| ip.instance.bootstrap? }
          expect(bootstrap_instance_plans.size).to eq(1)
          expect(bootstrap_instance_plans.first.desired_instance.index).to eq(0)
        end
      end

      context &#39;when there are no bootstrap instances&#39; do
        it &#39;assigns the instance with the lowest index as bootstrap instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(resolving bootstrap nodes)::context(when there are no bootstrap instances)::it#assigns the instance with the lowest index as bootstrap instance has a flog score of 79</span>          </div>  </li></ol>
          existing_instances = []
          another_desired_instance = BD::DeploymentPlan::DesiredInstance.new(instance_group, nil, deployment)

          allow(instance_repo).to receive(:create).with(desired_instance, 0) { tracer_instance }

          allow(instance_repo).to receive(:create).with(another_desired_instance, 1) { make_instance(1) }

          instance_plans = instance_planner.plan_instance_group_instances(instance_group, [desired_instance, another_desired_instance], existing_instances, vm_resources_cache)

          expect(instance_plans.count).to eq(2)
          new_instance_plan = instance_plans.first

          expect(new_instance_plan.new?).to be_truthy
          expect(new_instance_plan.instance.bootstrap?).to be_truthy
          expect(new_instance_plan.instance).to eq(tracer_instance)
          expect(new_instance_plan.existing_instance).to be_nil
        end
      end

      context &#39;when all instances are obsolete&#39; do
        it &#39;should not mark any instance as bootstrap instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(resolving bootstrap nodes)::context(when all instances are obsolete)::it#should not mark any instance as bootstrap instance has a flog score of 31</span>          </div>  </li></ol>
          existing_instance_model = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0, bootstrap: true, availability_zone: undesired_az.name)

          obsolete_instance = instance_double(BD::DeploymentPlan::Instance, update_description: nil)

          instance_plans = instance_planner.plan_instance_group_instances(instance_group, [], [existing_instance_model], vm_resources_cache)

          expect(instance_plans.count).to eq(1)
          obsolete_instance_plan = instance_plans.first

          expect(obsolete_instance_plan.obsolete?).to be_truthy
        end
      end
    end

    context &#39;when instance has vip networks&#39; do
      let(:vip_network) { BD::DeploymentPlan::VipNetwork.new({&#39;name&#39; =&gt; &#39;fake-network&#39;}, logger) }
      before do
        instance_group_network = BD::DeploymentPlan::JobNetwork.new(&#39;fake-network&#39;, [&#39;68.68.68.68&#39;], [], vip_network)
        allow(instance_group).to receive(:networks).and_return([instance_group_network])
      end

      it &#39;creates network plan for vip network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(plan_instance_group_instances)::context(when instance has vip networks)::it#creates network plan for vip network has a flog score of 53</span>          </div>  </li></ol>
        instance_plans = instance_planner.plan_instance_group_instances(instance_group, [desired_instance], [], vm_resources_cache)

        expect(instance_plans.count).to eq(1)
        existing_instance_plan = instance_plans.first
        expect(existing_instance_plan.network_plans.size).to eq(1)
        vip_network_plan = existing_instance_plan.network_plans.first
        expect(vip_network_plan.reservation.network).to eq(vip_network)
        expect(vip_network_plan.reservation.ip).to eq(ip_to_i(&#39;68.68.68.68&#39;))
      end
    end
  end

  describe &#39;#plan_obsolete_instance_groups&#39; do
    it &#39;returns instance plans for each instance_group&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(#plan_obsolete_instance_groups)::it#returns instance plans for each instance_group has a flog score of 42</span>          </div>  </li></ol>
      existing_instance_thats_desired = BD::Models::Instance.make(job: &#39;foo-instance_group&#39;, index: 0)
      existing_instance_thats_obsolete = BD::Models::Instance.make(job: &#39;bar-instance_group&#39;, index: 1)

      existing_instances = [existing_instance_thats_desired, existing_instance_thats_obsolete]
      instance_plans = instance_planner.plan_obsolete_instance_groups([instance_group], existing_instances)

      expect(instance_plans.count).to eq(1)

      obsolete_instance_plan = instance_plans.first
      expect(obsolete_instance_plan.instance).not_to be_nil
      expect(obsolete_instance_plan.desired_instance).to be_nil
      expect(obsolete_instance_plan.existing_instance).to eq(existing_instance_thats_obsolete)
      expect(obsolete_instance_plan).to be_obsolete
    end

    it &#39;fails when trying to delete instance groups with ignored instances&#39; do
      existing_instance_thats_desired = BD::Models::Instance.make(job: &#39;foo-instance-group&#39;, index: 0)
      existing_instance_thats_obsolete = BD::Models::Instance.make(job: &#39;bar-instance-group&#39;, index: 1, ignore: true)

      existing_instances = [existing_instance_thats_desired, existing_instance_thats_obsolete]

      expect {
        instance_planner.plan_obsolete_instance_groups([instance_group], existing_instances)
      }.to raise_error(
         Bosh::Director::DeploymentIgnoredInstancesDeletion,
         &quot;You are trying to delete instance group &#39;bar-instance-group&#39;, which contains ignored instance(s). Operation not allowed.&quot;
      )
    end
  end

  describe &#39;orphan_unreusable_vms&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe#orphan_unreusable_vms has a flog score of 41</span>          </div>  </li></ol>
    let(:instance_group) do
      instance_group = BD::DeploymentPlan::InstanceGroup.new(logger)
      instance_group.name = &#39;foo-instance_group&#39;
      instance_group.availability_zones &lt;&lt; az
      instance_group.stemcell = BD::DeploymentPlan::Stemcell.new(&#39;default&#39;, &#39;ubuntu-stemcell&#39;, &#39;ubuntu&#39;, &#39;1&#39;)
      instance_group.env = BD::DeploymentPlan::Env.new(&#39;env&#39; =&gt; &#39;env-val&#39;)
      instance_group.vm_type = BD::DeploymentPlan::VmType.new(
        &#39;name&#39; =&gt; &#39;a&#39;,
        &#39;cloud_properties&#39; =&gt; uninterpolated_cloud_properties_hash,
      )
      instance_group
    end

    let(:uninterpolated_cloud_properties_hash) do
      { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }
    end

    let(:existing_instance_model) do
      BD::Models::Instance.make(
        job: &#39;foo-instance_group&#39;,
        index: 0,
        availability_zone: az.name,
      )
    end

    let(:existing_instance_models) { [existing_instance_model] }

    let(:instance_plans) do
      [instance_plan]
    end

    let(:instance_plan) do
      instance_double(Bosh::Director::DeploymentPlan::InstancePlan)
    end

    let(:agent) { instance_double(Bosh::Director::AgentClient) }

    before do
      Bosh::Director::Config.current_job = Bosh::Director::Jobs::BaseJob.new
      Bosh::Director::Config.current_job.task_id = &#39;fake-task-id&#39;
      allow(Bosh::Director::Config.current_job).to receive(:username).and_return &#39;fake-username&#39;
      allow(instance_plan).to receive(:vm_matches_plan?).and_return false
      allow(Bosh::Director::AgentClient).to receive(:with_agent_id).with(&#39;fake-agent-id&#39;).and_return(agent)
      allow(agent).to receive(:shutdown)
    end

    it &#39;does NOT orphan active vms&#39; do
      vm = BD::Models::Vm.make(
        instance: existing_instance_model,
        active: true,
      )

      instance_planner.orphan_unreusable_vms(instance_plans, existing_instance_models)

      expect(existing_instance_model.vms).to include(vm)
    end

    it &#39;does not orphan vms that match the instance plan&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(orphan_unreusable_vms)::it#does not orphan vms that match the instance plan has a flog score of 44</span>          </div>  </li></ol>
      vm = BD::Models::Vm.make(
        instance: existing_instance_model,
        active: true,
      )
      usable_vm = BD::Models::Vm.make(instance: existing_instance_model)

      allow(instance_plan).to receive(:vm_matches_plan?).with(usable_vm).and_return true

      instance_planner.orphan_unreusable_vms(instance_plans, existing_instance_models)

      expect(existing_instance_model.vms).to include(vm)
      expect(existing_instance_model.vms).to include(usable_vm)
    end

    it &#39;orphans VMs that do not match&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(orphan_unreusable_vms)::it#orphans VMs that do not match has a flog score of 44</span>          </div>  </li></ol>
      vm = BD::Models::Vm.make(
        instance: existing_instance_model,
        active: true,
      )
      unusable_vm = BD::Models::Vm.make(
        instance: existing_instance_model,
        active: false,
        agent_id: &#39;fake-agent-id&#39;,
      )

      allow(instance_plan).to receive(:vm_matches_plan?).with(unusable_vm).and_return false

      instance_planner.orphan_unreusable_vms(instance_plans, existing_instance_models)

      expect(existing_instance_model.vms).to include(vm)
      expect(existing_instance_model.vms).to_not include(unusable_vm)
    end
  end

  describe &#39;reconcile_network_plans&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe#reconcile_network_plans has a flog score of 37</span>          </div>  </li></ol>
    let(:existing_instance) { make_instance_with_existing_model(existing_instance_model) }
    let(:existing_instance_model) do
      BD::Models::Instance.make(
        job: &#39;foo-instance_group&#39;,
        index: 0,
        bootstrap: true,
        availability_zone: az.name,
      )
    end

    before do
      BD::Models::IpAddress.make(
        address_str: ip_to_i(&#39;192.168.1.5&#39;).to_s,
        network_name: &#39;fake-network&#39;,
        instance: existing_instance_model,
      )

      allow(deployment).to receive(:network).with(&#39;fake-network&#39;) { manual_network }

      ip_repo = BD::DeploymentPlan::DatabaseIpRepo.new(logger)
      ip_provider = BD::DeploymentPlan::IpProvider.new(
        ip_repo,
        { &#39;fake-network&#39; =&gt; manual_network },
        logger,
      )
      allow(deployment).to receive(:ip_provider) { ip_provider }
      fake_job
    end

    let(:manual_network) { BD::DeploymentPlan::ManualNetwork.new(&#39;fake-network&#39;, [subnet], logger) }
    let(:subnet) do
      BD::DeploymentPlan::ManualNetworkSubnet.new(
        &#39;fake-network&#39;,
        NetAddr::CIDR.create(&#39;192.168.1.0/24&#39;),
        nil, nil, nil, nil, [&#39;foo-az&#39;], [],
        []
      )
    end

    it &#39;marks undesired existing network reservations as obsolete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L663" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L683" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(reconcile_network_plans)::it#marks undesired existing network reservations as obsolete has a flog score of 33</span>          </div>  </li></ol>
      instance_plans = instance_planner.plan_instance_group_instances(
        instance_group,
        [desired_instance],
        [existing_instance_model],
        vm_resources_cache,
      )
      instance_planner.reconcile_network_plans(instance_plans)

      expect(instance_plans.count).to eq(1)
      existing_instance_plan = instance_plans.first
      expect(existing_instance_plan.network_plans.first.obsolete?).to be_truthy
    end

    context &#39;when network reservation is needed&#39; do
      before do
        instance_group_network = BD::DeploymentPlan::JobNetwork.new(&#39;fake-network&#39;, nil, [], manual_network)
        allow(instance_group).to receive(:networks).and_return([instance_group_network])
      end

      it &#39;marks desired existing reservations as existing&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_planner_spec.html#L663" class="js-smell-location">0</a>                  <a href="instance_planner_spec.html#L683" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(BD::DeploymentPlan::InstancePlanner)::describe(reconcile_network_plans)::context(when network reservation is needed)::it#marks desired existing reservations as existing has a flog score of 35</span>          </div>  </li></ol>
        instance_plans = instance_planner.plan_instance_group_instances(
          instance_group,
          [desired_instance],
          [existing_instance_model],
          vm_resources_cache,
        )
        instance_planner.reconcile_network_plans(instance_plans)

        expect(instance_plans.count).to eq(1)
        existing_instance_plan = instance_plans.first
        expect(existing_instance_plan.network_plans.first.existing?).to be_truthy
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
