<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 13:48:29 -0700'>2018-06-22 13:48:29 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> compilation_instance_pool_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">604</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">125</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1429.11</span><small> complexity</small></div>
              <div><span class="metric">196</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                22
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require File.expand_path(&#39;../../../spec_helper&#39;, __FILE__)

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe DeploymentPlan::CompilationInstancePool do
    subject(:compilation_instance_pool) do
      DeploymentPlan::CompilationInstancePool.new(
        instance_reuser,
        instance_provider,
        logger,
        instance_deleter,
        double(:config, workers: max_instance_count, orphan_workers: orphan_workers),
      )
    end

    let(:agent_broadcaster) { AgentBroadcaster.new }
    let(:agent_client) { instance_double(&#39;Bosh::Director::AgentClient&#39;) }
    let(:another_agent_client) { instance_double(&#39;Bosh::Director::AgentClient&#39;) }
    let(:availability_zone) { nil }
    let(:cloud) { instance_double(Bosh::Clouds::ExternalCpi) }
    let(:cloud_properties) { { &#39;cloud&#39; =&gt; &#39;properties&#39; } }
    let(:create_instance_error) { RuntimeError.new(&#39;failed to create instance&#39;) }
    let(:deployment_model) { Models::Deployment.make(name: &#39;mycloud&#39;) }
    let(:dns_encoder) { DnsEncoder.new }
    let(:event_manager) { Api::EventManager.new(true) }
    let(:expected_network_settings) { { &#39;a&#39; =&gt; { &#39;a&#39; =&gt; { &#39;property&#39; =&gt; &#39;settings&#39; } } } }
    let(:instance_deleter) { instance_double(Bosh::Director::InstanceDeleter) }
    let(:instance_provider) { DeploymentPlan::InstanceProvider.new(deployment_plan, vm_creator, logger) }
    let(:instance_reuser) { InstanceReuser.new }
    let(:ip_provider) { instance_double(DeploymentPlan::IpProvider, reserve: nil, release: nil) }
    let(:max_instance_count) { 1 }
    let(:n_workers) { 3 }
    let(:network_settings) { { &#39;a&#39; =&gt; { &#39;property&#39; =&gt; &#39;settings&#39; } } }
    let(:orphan_workers) { false }
    let(:tags) { { &#39;tag1&#39; =&gt; &#39;value1&#39; } }
    let(:task_id) { 42 }
    let(:template_blob_cache) { instance_double(Bosh::Director::Core::Templates::TemplateBlobCache) }
    let(:trusted_certs) { &quot;Trust me. I know what I&#39;m doing.&quot; }
    let(:vm_creator) { VmCreator.new(Config.logger, template_blob_cache, dns_encoder, agent_broadcaster) }
    let(:vm_deleter) { VmDeleter.new(Config.logger, false, false) }
    let(:vm_resources_cache) { instance_double(Bosh::Director::DeploymentPlan::VmResourcesCache) }

    let(:update_job) do
      instance_double(Bosh::Director::Jobs::UpdateDeployment, username: &#39;user&#39;, task_id: task_id, event_manager: event_manager)
    end

    let(:subnet) do
      instance_double(&#39;Bosh::Director::DeploymentPlan::ManualNetworkSubnet&#39;, range: NetAddr::CIDR.create(&#39;192.168.0.0/24&#39;))
    end

    let(:stemcell) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L50" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L57" class="js-smell-location">1</a>                  <a href="compilation_instance_pool_spec.html#L64" class="js-smell-location">2</a>                  </div>  </li></ol>
      model = Models::Stemcell.make(cid: &#39;stemcell-cid&#39;, name: &#39;stemcell-name&#39;)
      stemcell = DeploymentPlan::Stemcell.new(&#39;stemcell-name-alias&#39;, &#39;stemcell-name&#39;, nil, model.version)
      stemcell.bind_model(deployment_model)
      stemcell
    end

    let(:another_stemcell) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L50" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L57" class="js-smell-location">1</a>                  <a href="compilation_instance_pool_spec.html#L64" class="js-smell-location">2</a>                  </div>  </li></ol>
      model = Models::Stemcell.make(cid: &#39;another-stemcell-cid&#39;, name: &#39;stemcell-name&#39;)
      stemcell = DeploymentPlan::Stemcell.new(&#39;stemcell-name-alias&#39;, &#39;stemcell-name&#39;, nil, model.version)
      stemcell.bind_model(deployment_model)
      stemcell
    end

    let(:different_stemcell) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L50" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L57" class="js-smell-location">1</a>                  <a href="compilation_instance_pool_spec.html#L64" class="js-smell-location">2</a>                  </div>  </li></ol>
      model = Models::Stemcell.make(cid: &#39;different-stemcell-cid&#39;, name: &#39;different-stemcell-name&#39;)
      stemcell = DeploymentPlan::Stemcell.new(&#39;stemcell-name-diff-alias&#39;, &#39;different-stemcell-name&#39;, nil, model.version)
      stemcell.bind_model(deployment_model)
      stemcell
    end

    let(:compilation_config) do
      compilation_spec = {
        &#39;workers&#39; =&gt; n_workers,
        &#39;network&#39; =&gt; &#39;a&#39;,
        &#39;env&#39; =&gt; compilation_env,
        &#39;cloud_properties&#39; =&gt; cloud_properties,
        &#39;reuse_compilation_vms&#39; =&gt; false,
        &#39;az&#39; =&gt; &#39;&#39;,
      }
      DeploymentPlan::CompilationConfig.new(compilation_spec, {}, [])
    end

    let(:deployment_plan) do
      instance_double(
        Bosh::Director::DeploymentPlan::Planner,
        compilation: compilation_config,
        model: deployment_model,
        name: &#39;mycloud&#39;,
        ip_provider: ip_provider,
        recreate: false,
        template_blob_cache: template_blob_cache,
        use_short_dns_addresses?: false,
        tags: tags,
        vm_resources_cache: vm_resources_cache,
      )
    end

    let(:network) do
      instance_double(&#39;Bosh::Director::DeploymentPlan::ManualNetwork&#39;, name: &#39;a&#39;, subnets: [subnet])
    end

    let(:expected_groups) do
      [
        &#39;fake-director-name&#39;,
        &#39;mycloud&#39;,
        &#39;compilation-deadbeef&#39;,
        &#39;fake-director-name-mycloud&#39;,
        &#39;mycloud-compilation-deadbeef&#39;,
        &#39;fake-director-name-mycloud-compilation-deadbeef&#39;,
      ]
    end

    let(:compilation_env) do
      {
        &#39;compilation&#39; =&gt; &#39;environment&#39;,
        &#39;bosh&#39; =&gt; {
          &#39;group&#39; =&gt; &#39;fake-director-name-mycloud-compilation-deadbeef&#39;,
          &#39;groups&#39; =&gt; expected_groups,
        },
      }
    end

    let(:thread_pool) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L123" class="js-smell-location">0</a>                  <a href="stages/package_compile_stage_spec.html#L52" class="js-smell-location">1</a>                  </div>  </li></ol>
      thread_pool = instance_double(&#39;Bosh::Director::ThreadPool&#39;)
      allow(thread_pool).to receive(:wrap).and_yield(thread_pool)
      allow(thread_pool).to receive(:process).and_yield
      allow(thread_pool).to receive(:working?).and_return(false)
      thread_pool
    end

    before do
      allow(Config).to receive(:cloud_options).and_return(&#39;provider&#39; =&gt; { &#39;path&#39; =&gt; &#39;/path/to/default/cpi&#39; })
      allow(cloud).to receive(:create_vm)
      allow(cloud).to receive(:info).and_return({})
      allow(cloud).to receive(:request_cpi_api_version=).with(1)
      allow(cloud).to receive(:request_cpi_api_version).and_return(1)
      allow(Bosh::Clouds::ExternalCpi).to receive(:new).and_return(cloud)
      allow(network).to receive(:network_settings)
        .with(instance_of(DesiredNetworkReservation), %w[dns gateway], availability_zone).and_return(network_settings)
      allow(Config).to receive(:trusted_certs).and_return(trusted_certs)
      allow(Config).to receive(:name).and_return(&#39;fake-director-name&#39;)
      allow(AgentClient).to receive(:with_agent_id).and_return(agent_client)
      allow(agent_client).to receive(:wait_until_ready)
      allow(agent_client).to receive(:update_settings)
      allow(agent_client).to receive(:get_state)
      allow(agent_client).to receive(:apply)
      allow(another_agent_client).to receive(:wait_until_ready)
      allow(another_agent_client).to receive(:update_settings)
      allow(another_agent_client).to receive(:get_state)
      allow(another_agent_client).to receive(:apply)
      allow(ThreadPool).to receive_messages(new: thread_pool)
      allow(deployment_plan).to receive(:network).with(&#39;a&#39;).and_return(network)
      allow(instance_deleter).to receive(:delete_instance_plan)
      allow(Config).to receive(:current_job).and_return(update_job)
      allow(deployment_model).to receive(:current_variable_set).and_return(Models::VariableSet.make)
    end

    shared_examples_for &#39;a compilation vm pool&#39; do
      it &#39;reserves a network for a new vm&#39; do
        expect(ip_provider).to receive(:reserve) do |reservation|
          expect(reservation.dynamic?).to be_truthy
        end

        action
      end

      it &#39;defers to the vm creator to create a vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::shared_examples_for(a compilation vm pool)::it#defers to the vm creator to create a vm has a flog score of 33</span>          </div>  </li></ol>
        allow(SecureRandom).to receive(:uuid).and_return(&#39;deadbeef&#39;, &#39;instance-uuid-1&#39;, &#39;agent-id&#39;)
        expect(cloud).to receive(:create_vm).with(
          &#39;agent-id&#39;,
          stemcell.models.first.cid,
          cloud_properties,
          expected_network_settings,
          [],
          compilation_env,
        )
        action
      end

      it &#39;applies initial vm state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::shared_examples_for(a compilation vm pool)::it#applies initial vm state has a flog score of 34</span>          </div>  </li></ol>
        allow(SecureRandom).to receive(:uuid).and_return(&#39;deadbeef&#39;, &#39;instance-uuid-1&#39;)
        expected_apply_spec = {
          &#39;deployment&#39; =&gt; &#39;mycloud&#39;,
          &#39;job&#39; =&gt; {
            &#39;name&#39; =&gt; &#39;compilation-deadbeef&#39;,
          },
          &#39;index&#39; =&gt; 0,
          &#39;id&#39; =&gt; &#39;instance-uuid-1&#39;,
          &#39;networks&#39; =&gt; expected_network_settings,
        }
        expect(agent_client).to receive(:apply).with(expected_apply_spec)

        action

        compilation_instance = Models::Instance.find(uuid: &#39;instance-uuid-1&#39;)
        expect(compilation_instance.active_vm.trusted_certs_sha1).to eq(::Digest::SHA1.hexdigest(trusted_certs))
      end

      it &#39;passes tags to vm&#39; do
        expect_any_instance_of(MetadataUpdater).to receive(:update_vm_metadata).with(anything, anything, tags, anything)
        action
      end

      it &#39;should record creation event&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::shared_examples_for(a compilation vm pool)::it#should record creation event has a flog score of 139</span>          </div>  </li></ol>
        allow(SecureRandom).to receive(:uuid).and_return(&#39;deadbeef&#39;, &#39;instance-uuid-1&#39;)
        expect do
          action
        end.to change { Bosh::Director::Models::Event.count }.from(0).to(4)

        event1 = Bosh::Director::Models::Event.order(:id).first<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'event1'</span>          </div>  </li></ol>
        expect(event1.user).to eq(&#39;user&#39;)
        expect(event1.action).to eq(&#39;create&#39;)
        expect(event1.object_type).to eq(&#39;instance&#39;)
        expect(event1.object_name).to eq(&#39;compilation-deadbeef/instance-uuid-1&#39;)
        expect(event1.task).to eq(task_id.to_s)
        expect(event1.deployment).to eq(&#39;mycloud&#39;)
        expect(event1.instance).to eq(&#39;compilation-deadbeef/instance-uuid-1&#39;)

        event2 = Bosh::Director::Models::Event.order(:id).last<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'event2'</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L219" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L279" class="js-smell-location">1</a>                  </div>  </li></ol>
        expect(event2.parent_id).to eq(1)
        expect(event2.user).to eq(&#39;user&#39;)
        expect(event2.action).to eq(&#39;create&#39;)
        expect(event2.object_type).to eq(&#39;instance&#39;)
        expect(event2.object_name).to eq(&#39;compilation-deadbeef/instance-uuid-1&#39;)
        expect(event2.task).to eq(task_id.to_s)
        expect(event2.deployment).to eq(&#39;mycloud&#39;)
        expect(event2.instance).to eq(&#39;compilation-deadbeef/instance-uuid-1&#39;)
      end

      context &#39;when vm_resources are given&#39; do
        let(:compilation_config) do
          compilation_spec = {
            &#39;workers&#39; =&gt; n_workers,
            &#39;network&#39; =&gt; &#39;a&#39;,
            &#39;vm_resources&#39; =&gt; {
              &#39;cpu&#39; =&gt; 4,
              &#39;ram&#39; =&gt; 2048,
              &#39;ephemeral_disk_size&#39; =&gt; 100,
            },
          }

          DeploymentPlan::CompilationConfig.new(compilation_spec, {}, [])
        end

        it &#39;retrieves the vm requirements from the CPI/cache and populates the cloud properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::shared_examples_for(a compilation vm pool)::context(when vm_resources are given)::it#retrieves the vm requirements from the CPI/cache and populates the cloud properties has a flog score of 40</span>          </div>  </li></ol>
          allow(SecureRandom).to receive(:uuid).and_return(&#39;deadbeef&#39;, &#39;instance-uuid-1&#39;, &#39;agent-id&#39;)
          allow(deployment_plan.vm_resources_cache).to receive(:get_vm_cloud_properties)
            .with(nil, &#39;cpu&#39; =&gt; 4, &#39;ram&#39; =&gt; 2048, &#39;ephemeral_disk_size&#39; =&gt; 100)
            .and_return(&#39;vm_resources&#39; =&gt; &#39;foo&#39;)

          allow(cloud).to receive(:create_vm) do |_, _, cloud_properties|
            expect(cloud_properties[&#39;vm_resources&#39;]).to eq(&#39;foo&#39;)
          end

          action
        end
      end

      context &#39;when instance creation fails&#39; do
        context &#39;when keep_unreachable_vms is set&#39; do
          before { Config.keep_unreachable_vms = true }

          it &#39;does not delete instance&#39; do
            expect { action_that_raises }.to raise_error(create_instance_error)
            expect(instance_deleter).to_not have_received(:delete_instance_plan)
          end
        end

        context &#39;when keep_unreachable_vms is not set&#39; do
          it &#39;deletes the instance&#39; do
            expect { action_that_raises }.to raise_error(create_instance_error)
            expect(instance_deleter).to have_received(:delete_instance_plan)
          end

          it &#39;should record creation event with error&#39; do
            expect do
              action_that_raises
            end.to raise_error RuntimeError
            event2 = Bosh::Director::Models::Event.order(:id).last<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'event2'</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L219" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L279" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(event2.error).to eq(&#39;failed to create instance&#39;)
          end
        end
      end
    end

    describe &#39;with_reused_vm&#39; do
      it_behaves_like &#39;a compilation vm pool&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L287" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L522" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:action) { compilation_instance_pool.with_reused_vm(stemcell) {} }

        let(:action_that_raises) do
          allow(vm_creator).to receive(:create_for_instance_plan).and_raise(create_instance_error)
          compilation_instance_pool.with_reused_vm(stemcell)
        end
      end

      context &#39;when the the pool is full&#39; do
        context &#39;and there are no available instances for the given stemcell&#39; do
          it &#39;destroys the idle instance made for a different stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::context(when the the pool is full)::context(and there are no available instances for the given stemcell)::it#destroys the idle instance made for a different stemcell has a flog score of 59</span>          </div>  </li></ol>
            compilation_instance_pool.with_reused_vm(stemcell) { |i| }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'i'</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L299" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L303" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(instance_deleter).to_not have_received(:delete_instance_plan)
            expect(instance_reuser.get_num_instances(stemcell)).to eq(1)

            compilation_instance_pool.with_reused_vm(different_stemcell) { |i| }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director has the variable name 'i'</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L299" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L303" class="js-smell-location">1</a>                  </div>  </li></ol>

            expect(instance_reuser.get_num_instances(stemcell)).to eq(0)
            expect(instance_reuser.get_num_instances(different_stemcell)).to eq(1)
            expect(instance_deleter).to have_received(:delete_instance_plan)
          end
        end
      end

      context &#39;after a vm is created&#39; do
        it &#39;is reused&#39; do
          original = nil
          compilation_instance_pool.with_reused_vm(stemcell) do |instance|
            original = instance
          end
          reused = nil
          compilation_instance_pool.with_reused_vm(stemcell) do |instance|
            reused = instance
          end
          expect(reused).to be(original)
        end
      end

      context &#39;when az is specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::context#when az is specified has a flog score of 89</span>          </div>  </li></ol>
        let(:compilation_config) do
          compilation_spec = {
            &#39;workers&#39; =&gt; n_workers,
            &#39;network&#39; =&gt; &#39;a&#39;,
            &#39;env&#39; =&gt; compilation_env,
            &#39;cloud_properties&#39; =&gt; cloud_properties,
            &#39;reuse_compilation_vms&#39; =&gt; false,
            &#39;az&#39; =&gt; &#39;foo-az&#39;,
          }
          DeploymentPlan::CompilationConfig.new(compilation_spec, { &#39;foo-az&#39; =&gt; availability_zone }, [])
        end

        let(:max_instance_count) { 4 }

        let(:availability_zone) { DeploymentPlan::AvailabilityZone.new(&#39;foo-az&#39;, cloud_properties) }

        let(:deployment_model) { Models::Deployment.make(name: &#39;mycloud&#39;, cloud_config: cloud_config) }
        let(:deployment_model) do
          deployment = Models::Deployment.make(name: &#39;mycloud&#39;)
          deployment.cloud_configs = [cloud_config]
          deployment
        end
        let(:cloud_config) do
          Models::Config.make(
            :cloud,
            raw_manifest: Bosh::Spec::Deployments.simple_cloud_config.merge(
              &#39;azs&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;foo-az&#39; }],
            ),
          )
        end
        let(:vm_creator) { instance_double(&#39;Bosh::Director::VmCreator&#39;) }

        before do
          expect(vm_creator).to receive(:create_for_instance_plan) do |instance_plan, ipp, disks, tags, use_existing|
            expect(instance_plan.network_settings_hash).to eq(&#39;a&#39; =&gt; { &#39;a&#39; =&gt; { &#39;property&#39; =&gt; &#39;settings&#39; } })
            expect(instance_plan.instance.cloud_properties).to eq(&#39;cloud&#39; =&gt; &#39;properties&#39;)
            expect(instance_plan.instance.env).to eq(
              &#39;compilation&#39; =&gt; &#39;environment&#39;,
              &#39;bosh&#39; =&gt;
                {
                  &#39;group&#39; =&gt; &#39;fake-director-name-mycloud-compilation-deadbeef&#39;,
                  &#39;groups&#39; =&gt; [
                    &#39;fake-director-name&#39;,
                    &#39;mycloud&#39;,
                    &#39;compilation-deadbeef&#39;,
                    &#39;fake-director-name-mycloud&#39;,
                    &#39;mycloud-compilation-deadbeef&#39;,
                    &#39;fake-director-name-mycloud-compilation-deadbeef&#39;,
                  ],
                },
            )
            expect(ipp).to eq(ip_provider)
            expect(disks).to eq([])
            expect(tags).to eq(&#39;tag1&#39; =&gt; &#39;value1&#39;)
            expect(use_existing).to eq(nil)
          end

          allow(VmCreator).to receive(:new)
            .with(logger, vm_deleter, template_blob_cache, agent_broadcaster).and_return(vm_creator)
        end

        it &#39;spins up vm in the az&#39; do
          vm_instance = nil
          compilation_instance_pool.with_reused_vm(stemcell) do |instance|
            vm_instance = instance
          end
          expect(vm_instance.availability_zone_name).to eq(&#39;foo-az&#39;)
        end

        it &#39;saves az name in database&#39; do
          allow(SecureRandom).to receive(:uuid).and_return(&#39;deadbeef&#39;, &#39;instance-uuid-1&#39;)
          compilation_instance_pool.with_reused_vm(stemcell) {}

          expect(Models::Instance.find(uuid: &#39;instance-uuid-1&#39;).availability_zone).to eq(&#39;foo-az&#39;)
        end
      end

      context &#39;when vm_type is specified&#39; do
        let(:compilation_config) do
          compilation_spec = {
            &#39;workers&#39; =&gt; n_workers,
            &#39;network&#39; =&gt; &#39;a&#39;,
            &#39;vm_type&#39; =&gt; &#39;type-a&#39;,
          }
          vm_type_spec = {
            &#39;name&#39; =&gt; &#39;type-a&#39;,
            &#39;cloud_properties&#39; =&gt; {
              &#39;instance_type&#39; =&gt; &#39;big&#39;,
            },
          }
          DeploymentPlan::CompilationConfig.new(compilation_spec, {}, [DeploymentPlan::VmType.new(vm_type_spec)])
        end

        let(:max_instance_count) { 4 }

        it &#39;spins up vm with the correct VM type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::context(when vm_type is specified)::it#spins up vm with the correct VM type has a flog score of 26</span>          </div>  </li></ol>
          expect(cloud).to receive(:create_vm).with(
            anything,
            anything,
            { &#39;instance_type&#39; =&gt; &#39;big&#39; },
            anything,
            anything,
            anything,
          )

          compilation_instance_pool.with_reused_vm(stemcell) {}
        end
      end

      context &#39;when vm raises an Rpc timeout error&#39; do
        it &#39;removes the vm from the reuser&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L437" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L447" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::context(when vm raises an Rpc timeout error)::it#removes the vm from the reuser has a flog score of 26</span>          </div>  </li></ol>
          expect(instance_reuser).to receive(:remove_instance)
          expect do
            compilation_instance_pool.with_reused_vm(stemcell) { raise create_instance_error }
          end.to raise_error(create_instance_error)
        end

        context &#39;when keep_unreachable_vms is set&#39; do
          before { Config.keep_unreachable_vms = true }

          it &#39;removes the vm from the reuser so that it is not cleaned up later when reuser deletes all instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L437" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L447" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::context(when vm raises an Rpc timeout error)::context(when keep_unreachable_vms is set)::it#removes the vm from the reuser so that it is not cleaned up later when reuser deletes all instances has a flog score of 28</span>          </div>  </li></ol>
            expect(instance_reuser).to receive(:remove_instance)
            expect do
              compilation_instance_pool.with_reused_vm(stemcell) { raise create_instance_error }
            end.to raise_error(create_instance_error)
          end
        end
      end

      context &#39;when vm raises an Rpc timeout error&#39; do
        it &#39;no longer offers that vm for reuse&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::context(when vm raises an Rpc timeout error)::it#no longer offers that vm for reuse has a flog score of 34</span>          </div>  </li></ol>
          original = nil
          compilation_instance_pool.with_reused_vm(stemcell) do |instance|
            original = instance
          end

          expect do
            compilation_instance_pool.with_reused_vm(stemcell) { raise create_instance_error }
          end.to raise_error(create_instance_error)

          different = nil
          compilation_instance_pool.with_reused_vm(stemcell) do |instance|
            different = instance
          end
          expect(different).to_not eq(original)
        end
      end

      describe &#39;delete_instances&#39; do
        let(:max_instance_count) { 2 }

        before do
          compilation_instance_pool.with_reused_vm(stemcell) {}
          compilation_instance_pool.with_reused_vm(another_stemcell) {}
        end

        it &#39;removes the vm from the reuser&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::describe(delete_instances)::it#removes the vm from the reuser has a flog score of 30</span>          </div>  </li></ol>
          expect(instance_reuser.get_num_instances(stemcell)).to eq(1)
          compilation_instance_pool.delete_instances(max_instance_count)
          expect(instance_reuser.get_num_instances(stemcell)).to eq(0)
        end

        it &#39;deletes the instance&#39; do
          compilation_instance_pool.delete_instances(max_instance_count)
          expect(instance_deleter).to have_received(:delete_instance_plan).exactly(2).times
        end
      end

      context &#39;orphan workers is enabled&#39; do
        let(:instance_plan) { instance_double(DeploymentPlan::InstancePlan) }
        let(:orphan_step) { instance_double(DeploymentPlan::Steps::OrphanVmStep) }
        let(:orphan_workers) { true }

        before do
          compilation_instance_pool.with_reused_vm(stemcell) {}
        end

        it &#39;orphans the vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_reused_vm)::context(orphan workers is enabled)::it#orphans the vm has a flog score of 78</span>          </div>  </li></ol>
          compilation_instance = Models::Instance.find(deployment_id: deployment_model.id)
          expect(compilation_instance.active_vm).to_not be_nil

          allow(instance_plan).to receive(:instance_model).and_return(compilation_instance)
          expect(instance_plan).to receive(:release_all_network_plans)
          allow(DeploymentPlan::InstancePlan).to receive(:new).and_return(instance_plan)

          allow(DeploymentPlan::Steps::OrphanVmStep).to receive(:new).with(compilation_instance.active_vm).and_return(orphan_step)
          expect(orphan_step).to receive(:perform)

          compilation_instance_pool.delete_instances(max_instance_count)
          expect(instance_deleter).to have_received(:delete_instance_plan).exactly(1).times
        end
      end
    end

    describe &#39;with_single_use_vm&#39; do
      it_behaves_like &#39;a compilation vm pool&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compilation_instance_pool_spec.html#L287" class="js-smell-location">0</a>                  <a href="compilation_instance_pool_spec.html#L522" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:action) { compilation_instance_pool.with_single_use_vm(stemcell) {} }

        let(:action_that_raises) do
          allow(vm_creator).to receive(:create_for_instance_plan).and_raise(create_instance_error)
          compilation_instance_pool.with_single_use_vm(stemcell)
        end
      end

      context &#39;orphan workers is enabled&#39; do
        let(:instance) { instance_double(Models::Instance) }
        let(:instance_memo) { instance_double(DeploymentPlan::InstanceMemo) }
        let(:instance_plan) { instance_double(DeploymentPlan::InstancePlan) }
        let(:orphan_step) { instance_double(DeploymentPlan::Steps::OrphanVmStep) }
        let(:orphan_workers) { true }
        let(:vm) { instance_double(Models::Vm) }

        it &#39;orphans the vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe(with_single_use_vm)::context(orphan workers is enabled)::it#orphans the vm has a flog score of 101</span>          </div>  </li></ol>
          allow(instance).to receive(:vms).and_return([vm])
          allow(instance_plan).to receive(:instance_model).and_return(instance)
          expect(instance_plan).to receive(:release_all_network_plans)

          allow(DeploymentPlan::InstanceMemo).to receive(:new).and_return(instance_memo)
          allow(instance_memo).to receive(:instance_plan).and_return(instance_plan)
          allow(instance_memo).to receive(:instance).and_return(instance)

          allow(DeploymentPlan::Steps::OrphanVmStep).to receive(:new).with(vm).and_return(orphan_step)
          expect(orphan_step).to receive(:perform)
          compilation_instance_pool.with_single_use_vm(stemcell) {}
          expect(instance_deleter).to have_received(:delete_instance_plan).exactly(1).times
        end
      end
    end

    describe &#39;.create&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::describe#.create has a flog score of 145</span>          </div>  </li></ol>
      let(:instance_reuser) { InstanceReuser.new }
      let(:disk_manager) { DiskManager.new(logger) }
      let(:agent_broadcaster) { AgentBroadcaster.new }
      let(:powerdns_manager) { PowerDnsManagerProvider.create }
      let(:vm_deleter) { instance_double(&#39;Bosh::Director::VmDeleter&#39;) }
      let(:vm_creator) { instance_double(&#39;Bosh::Director::VmCreator&#39;) }
      let(:instance_deleter) { instance_double(&#39;Bosh::Director::InstanceDeleter&#39;) }
      let(:instance_provider) { instance_double(&#39;Bosh::Director::DeploymentPlan::InstanceProvider&#39;) }

      before do
        allow(AgentBroadcaster).to receive(:new).and_return(agent_broadcaster)
        allow(Config).to receive(:enable_virtual_delete_vms).and_return(false)
        allow(Config).to receive(:logger).and_return(logger)
        allow(DiskManager).to receive(:new).with(logger).and_return(disk_manager)
        allow(InstanceDeleter).to receive(:new).with(ip_provider, powerdns_manager, disk_manager).and_return(instance_deleter)
        allow(InstanceReuser).to receive(:new).and_return(instance_reuser)
        allow(PowerDnsManagerProvider).to receive(:create).and_return(powerdns_manager)
        allow(VmCreator).to receive(:new).with(logger, template_blob_cache, anything, agent_broadcaster).and_return(vm_creator)
        allow(VmDeleter).to receive(:new).with(logger, false, false).and_return(vm_deleter)

        allow(DeploymentPlan::InstanceProvider).to receive(:new)
          .with(deployment_plan, vm_creator, logger)
          .and_return(instance_provider)
        allow(deployment_plan).to receive(:availability_zones).and_return([])

        Bosh::Director::App.new(Bosh::Director::Config.load_hash(SpecHelper.spec_get_director_config))
      end

      it &#39;creates the needed collaborators and news up a CompilationInstancePool&#39; do
        expect(DeploymentPlan::CompilationInstancePool).to receive(:new).with(
          instance_reuser,
          instance_provider,
          logger,
          instance_deleter,
          compilation_config,
        ).and_call_original

        DeploymentPlan::CompilationInstancePool.create(deployment_plan)
      end
    end
  end

  describe DeploymentPlan::CompilationInstanceGroup do
    it &quot;has no &#39;lifecycle&#39;&quot; do
      expect(DeploymentPlan::CompilationInstanceGroup.new(nil, nil, nil, nil, nil, nil, nil).lifecycle).to be_nil
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
