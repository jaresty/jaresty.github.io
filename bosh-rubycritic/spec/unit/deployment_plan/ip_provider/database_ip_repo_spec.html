<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan/ip_provider /</small> database_ip_repo_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">419</span><small> lines of codes</small></div>
              <div><span class="metric">3</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">317.5</span><small> complexity/method</small></div>
              <div><span class="metric">21</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">952.37</span><small> complexity</small></div>
              <div><span class="metric">1057</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                34
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director::DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
  describe DatabaseIpRepo do
    let(:ip_repo) { DatabaseIpRepo.new(logger) }
    let(:instance_model) { Bosh::Director::Models::Instance.make }
    let(:network_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L7" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L7" class="js-smell-location">1</a>                  <a href="in_memory_ip_repo_spec.html#L25" class="js-smell-location">2</a>                  <a href="../../vm_creator_spec.html#L59" class="js-smell-location">3</a>                  </div>  </li></ol>
      {
        &#39;name&#39; =&gt; &#39;my-manual-network&#39;,
        &#39;subnets&#39; =&gt; [
          {
            &#39;range&#39; =&gt; &#39;192.168.1.0/29&#39;,
            &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
            &#39;static&#39; =&gt; [],
            &#39;reserved&#39; =&gt; [],
            &#39;cloud_properties&#39; =&gt; {},
            &#39;az&#39; =&gt; &#39;az-1&#39;,
          }
        ]
      }
    end
    let(:global_network_resolver) { instance_double(GlobalNetworkResolver, reserved_ranges: Set.new) }
    let(:availability_zones) { [BD::DeploymentPlan::AvailabilityZone.new(&#39;az-1&#39;, {})] }
    let(:network) do
      ManualNetwork.parse(
        network_spec,
        availability_zones,
        global_network_resolver,
        logger
      )
    end
    let(:subnet) do
      ManualNetworkSubnet.parse(
        network.name,
        network_spec[&#39;subnets&#39;].first,
        availability_zones,
        []
      )
    end

    let(:other_network_spec) { network_spec.merge(&#39;name&#39; =&gt; &#39;my-other-manual-network&#39;) }
    let(:other_network) do
      ManualNetwork.parse(
        other_network_spec,
        availability_zones,
        global_network_resolver,
        logger
      )
    end
    let(:other_reservation) { BD::DesiredNetworkReservation.new_dynamic(instance_model, other_network) }
    let(:other_subnet) do
      ManualNetworkSubnet.parse(
        other_network.name,
        other_network_spec[&#39;subnets&#39;].first,
        availability_zones,
        []
      )
    end

    before { fake_job }

    def cidr_ip(ip)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#cidr_ip doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      NetAddr::CIDR.create(ip).to_i
    end

    context :add do
      def dynamic_reservation_with_ip(ip)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L68" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L68" class="js-smell-location">1</a>                  </div>  </li></ol>
        reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, network_without_static_pool)
        reservation.resolve_ip(ip)
        reservation.mark_reserved
        ip_repo.add(reservation)

        reservation
      end

      let(:network_without_static_pool) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L77" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L77" class="js-smell-location">1</a>                  </div>  </li></ol>
        network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = []
        ManualNetwork.parse(network_spec, availability_zones, global_network_resolver, logger)
      end

      context &#39;when reservation changes type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L82" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L82" class="js-smell-location">1</a>                  </div>  </li></ol>
        context &#39;from Static to Dynamic&#39; do
          it &#39;updates type of reservation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when reservation changes type)::context(from Static to Dynamic)::it#updates type of reservation has a flog score of 63</span>          </div>  </li></ol>
            network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]
            static_reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)
            ip_repo.add(static_reservation)

            expect(Bosh::Director::Models::IpAddress.count).to eq(1)
            original_address = Bosh::Director::Models::IpAddress.first
            expect(original_address.static).to eq(true)

            dynamic_reservation = dynamic_reservation_with_ip(&#39;192.168.1.5&#39;)
            ip_repo.add(dynamic_reservation)

            expect(Bosh::Director::Models::IpAddress.count).to eq(1)
            new_address = Bosh::Director::Models::IpAddress.first
            expect(new_address.static).to eq(false)
            expect(new_address.address_str).to eq(original_address.address_str)
          end
        end

        context &#39;from Dynamic to Static&#39; do
          it &#39;update type of reservation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when reservation changes type)::context(from Dynamic to Static)::it#update type of reservation has a flog score of 63</span>          </div>  </li></ol>
            dynamic_reservation = dynamic_reservation_with_ip(&#39;192.168.1.5&#39;)
            ip_repo.add(dynamic_reservation)

            expect(Bosh::Director::Models::IpAddress.count).to eq(1)
            original_address = Bosh::Director::Models::IpAddress.first
            expect(original_address.static).to eq(false)

            network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]
            static_reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)
            ip_repo.add(static_reservation)

            expect(Bosh::Director::Models::IpAddress.count).to eq(1)
            new_address = Bosh::Director::Models::IpAddress.first
            expect(new_address.static).to eq(true)
            expect(new_address.address_str).to eq(original_address.address_str)
          end
        end

        context &#39;from Existing to Static&#39; do
          it &#39;updates type of reservation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when reservation changes type)::context(from Existing to Static)::it#updates type of reservation has a flog score of 63</span>          </div>  </li></ol>
            dynamic_reservation = dynamic_reservation_with_ip(&#39;192.168.1.5&#39;)
            ip_repo.add(dynamic_reservation)

            expect(Bosh::Director::Models::IpAddress.count).to eq(1)
            original_address = Bosh::Director::Models::IpAddress.first
            expect(original_address.static).to eq(false)

            network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]
            existing_reservation = BD::ExistingNetworkReservation.new(instance_model, network, &#39;192.168.1.5&#39;, &#39;manual&#39;)
            ip_repo.add(existing_reservation)

            expect(Bosh::Director::Models::IpAddress.count).to eq(1)
            new_address = Bosh::Director::Models::IpAddress.first
            expect(new_address.static).to eq(true)
            expect(new_address.address_str).to eq(original_address.address_str)
          end
        end
      end

      context &#39;when reservation changes network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L144" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L144" class="js-smell-location">1</a>                  </div>  </li></ol>
        it &#39;updates network name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when reservation changes network)::it#updates network name has a flog score of 76</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]
          static_reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)
          ip_repo.add(static_reservation)

          expect(Bosh::Director::Models::IpAddress.count).to eq(1)
          original_address = Bosh::Director::Models::IpAddress.first
          expect(original_address.static).to eq(true)
          expect(original_address.network_name).to eq(network.name)

          static_reservation_on_another_network = BD::DesiredNetworkReservation.new_static(instance_model, other_network, &#39;192.168.1.5&#39;)
          ip_repo.add(static_reservation_on_another_network)

          expect(Bosh::Director::Models::IpAddress.count).to eq(1)
          original_address = Bosh::Director::Models::IpAddress.first
          expect(original_address.static).to eq(true)
          expect(original_address.network_name).to eq(other_network.name)
        end
      end

      context &#39;when IP is released by another deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L165" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L165" class="js-smell-location">1</a>                  </div>  </li></ol>
        it &#39;retries to reserve it&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when IP is released by another deployment)::it#retries to reserve it has a flog score of 65</span>          </div>  </li></ol>
          allow_any_instance_of(Bosh::Director::Models::IpAddress).to receive(:save) do
            allow_any_instance_of(Bosh::Director::Models::IpAddress).to receive(:save).and_call_original

            raise Sequel::ValidationFailed.new(&#39;address and network_name unique&#39;)
          end

          network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]
          reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)
          ip_repo.add(reservation)

          saved_address = Bosh::Director::Models::IpAddress.order(:address_str).last
          expect(saved_address.address_str).to eq(cidr_ip(&#39;192.168.1.5&#39;).to_s)
          expect(saved_address.network_name).to eq(&#39;my-manual-network&#39;)
          expect(saved_address.task_id).to eq(&#39;fake-task-id&#39;)
          expect(saved_address.created_at).to_not be_nil
        end
      end

      context &#39;when reserving an IP with any previous reservation&#39; do
        it &#39;should fail if it reserved by a different instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L186" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L186" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when reserving an IP with any previous reservation)::it#should fail if it reserved by a different instance has a flog score of 30</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]

          other_instance_model = Bosh::Director::Models::Instance.make(availability_zone: &#39;az-2&#39;)
          original_static_network_reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)
          new_static_network_reservation = BD::DesiredNetworkReservation.new_static(other_instance_model, network, &#39;192.168.1.5&#39;)

          ip_repo.add(original_static_network_reservation)

          expect {
            ip_repo.add(new_static_network_reservation)
          }.to raise_error BD::NetworkReservationAlreadyInUse
        end

        it &#39;should fail if the reserved instance does not exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when reserving an IP with any previous reservation)::it#should fail if the reserved instance does not exist has a flog score of 37</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]

          other_instance_model = Bosh::Director::Models::Instance.make(availability_zone: &#39;az-2&#39;)
          original_static_network_reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)
          new_static_network_reservation = BD::DesiredNetworkReservation.new_static(other_instance_model, network, &#39;192.168.1.5&#39;)

          ip_repo.add(original_static_network_reservation)

          vm = Bosh::Director::Models::OrphanedVm.create(cid: &#39;some-cid&#39;, orphaned_at: Time.now)
          Bosh::Director::Models::IpAddress.first.update(instance_id: nil, orphaned_vm: vm)

          expect do
            ip_repo.add(new_static_network_reservation)
          end.to raise_error BD::NetworkReservationAlreadyInUse
        end

        it &#39;should succeed if it is reserved by the same instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L200" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L217" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(add)::context(when reserving an IP with any previous reservation)::it#should succeed if it is reserved by the same instance has a flog score of 25</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]

          static_network_reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)

          ip_repo.add(static_network_reservation)

          expect {
            ip_repo.add(static_network_reservation)
          }.not_to raise_error
        end
      end
    end

    describe :allocate_dynamic_ip do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L214" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L231" class="js-smell-location">1</a>                  </div>  </li></ol>
      let(:reservation) { BD::DesiredNetworkReservation.new_dynamic(instance_model, network) }

      context &#39;when there are no IPs reserved&#39; do
        it &#39;returns the first in the range&#39; do
          ip_address = ip_repo.allocate_dynamic_ip(reservation, subnet)

          expected_ip_address = cidr_ip(&#39;192.168.1.2&#39;)
          expect(ip_address).to eq(expected_ip_address)
        end
      end

      it &#39;reserves IP as dynamic&#39; do
        ip_repo.allocate_dynamic_ip(reservation, subnet)

        saved_address = Bosh::Director::Models::IpAddress.first
        expect(saved_address.static).to eq(false)
      end

      context &#39;when reserving more than one ip&#39; do
        it &#39;should reserve the next available address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context(when reserving more than one ip)::it#should reserve the next available address has a flog score of 28</span>          </div>  </li></ol>
          first = ip_repo.allocate_dynamic_ip(reservation, subnet)
          second = ip_repo.allocate_dynamic_ip(reservation, subnet)
          expect(first).to eq(cidr_ip(&#39;192.168.1.2&#39;))
          expect(second).to eq(cidr_ip(&#39;192.168.1.3&#39;))
        end
      end

      context &#39;when there are restricted ips&#39; do
        it &#39;does not reserve them&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context(when there are restricted ips)::it#does not reserve them has a flog score of 37</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;reserved&#39;] = [&#39;192.168.1.2&#39;, &#39;192.168.1.4&#39;]

          expect(ip_repo.allocate_dynamic_ip(reservation, subnet)).to eq(cidr_ip(&#39;192.168.1.3&#39;))
          expect(ip_repo.allocate_dynamic_ip(reservation, subnet)).to eq(cidr_ip(&#39;192.168.1.5&#39;))
        end
      end

      context &#39;when there are static and restricted ips&#39; do
        it &#39;does not reserve them&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context(when there are static and restricted ips)::it#does not reserve them has a flog score of 42</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;reserved&#39;] = [&#39;192.168.1.2&#39;]
          network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.4&#39;]

          expect(ip_repo.allocate_dynamic_ip(reservation, subnet)).to eq(cidr_ip(&#39;192.168.1.3&#39;))
          expect(ip_repo.allocate_dynamic_ip(reservation, subnet)).to eq(cidr_ip(&#39;192.168.1.5&#39;))
        end
      end

      context &#39;when there are available IPs between reserved IPs&#39; do
        it &#39;returns first non-reserved IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context(when there are available IPs between reserved IPs)::it#returns first non-reserved IP has a flog score of 40</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.2&#39;, &#39;192.168.1.4&#39;]

          reservation_1 = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'reservation_1'</span>          </div>  </li></ol>
          reservation_2 = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.4&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'reservation_2'</span>          </div>  </li></ol>

          ip_repo.add(reservation_1)
          ip_repo.add(reservation_2)

          reservation_3 = BD::DesiredNetworkReservation.new_dynamic(instance_model, network)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'reservation_3'</span>          </div>  </li></ol>
          ip_address = ip_repo.allocate_dynamic_ip(reservation_3, subnet)

          expect(ip_address).to eq(cidr_ip(&#39;192.168.1.3&#39;))
        end
      end

      context &#39;when all IPs in the range are taken&#39; do
        it &#39;returns nil&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context(when all IPs in the range are taken)::it#returns nil has a flog score of 26</span>          </div>  </li></ol>
          network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.1.0/30&#39;

          ip_repo.allocate_dynamic_ip(reservation, subnet)

          expect(ip_repo.allocate_dynamic_ip(reservation, subnet)).to be_nil
        end
      end

      context &#39;when there are IPs reserved by other networks with overlapping subnet&#39; do
        it &#39;returns the next non-reserved IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context(when there are IPs reserved by other networks with overlapping subnet)::it#returns the next non-reserved IP has a flog score of 28</span>          </div>  </li></ol>
          ip_address = ip_repo.allocate_dynamic_ip(other_reservation, other_subnet)

          expected_ip_address = cidr_ip(&#39;192.168.1.2&#39;)
          expect(ip_address).to eq(expected_ip_address)

          ip_address = ip_repo.allocate_dynamic_ip(reservation, subnet)

          expected_ip_address = cidr_ip(&#39;192.168.1.3&#39;)
          expect(ip_address).to eq(expected_ip_address)
        end
      end

      context &#39;when reserving IP fails&#39; do
        def fail_saving_ips(ips, fail_error)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context#fail_saving_ips has a flog score of 38</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#fail_saving_ips has approx 10 statements</span>          </div>  </li></ol>
          original_saves = {}
          ips.each do |ip|
            ip_address = Bosh::Director::Models::IpAddress.new(
              address_str: ip.to_s,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#fail_saving_ips calls 'ip.to_s' 2 times</span>              <span>Locations:</span>                  <a href="database_ip_repo_spec.html#L324" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L330" class="js-smell-location">1</a>                  </div>  </li></ol>
              network_name: &#39;my-manual-network&#39;,
              instance: instance_model,
              task_id: Bosh::Director::Config.current_job.task_id
            )
            original_save = ip_address.method(:save)
            original_saves[ip.to_s] = original_save<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#fail_saving_ips calls 'ip.to_s' 2 times</span>              <span>Locations:</span>                  <a href="database_ip_repo_spec.html#L324" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L330" class="js-smell-location">1</a>                  </div>  </li></ol>
          end

          allow_any_instance_of(Bosh::Director::Models::IpAddress).to receive(:save) do |model|
            if ips.map(&amp;:to_s).include?(model.address_str)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#fail_saving_ips calls 'model.address_str' 2 times</span>              <span>Locations:</span>                  <a href="database_ip_repo_spec.html#L334" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L335" class="js-smell-location">1</a>                  </div>  </li></ol>
              original_save = original_saves[model.address_str]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#fail_saving_ips calls 'model.address_str' 2 times</span>              <span>Locations:</span>                  <a href="database_ip_repo_spec.html#L334" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L335" class="js-smell-location">1</a>                  </div>  </li></ol>
              original_save.call
              raise fail_error
            end
            model
          end
        end

        shared_examples :retries_on_race_condition do
          context &#39;when allocating some IPs fails&#39; do
            before do
              network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.1.0/29&#39;

              fail_saving_ips([
                  cidr_ip(&#39;192.168.1.2&#39;),
                  cidr_ip(&#39;192.168.1.3&#39;),
                  cidr_ip(&#39;192.168.1.4&#39;),
                ],
                fail_error
              )
            end

            it &#39;retries until it succeeds&#39; do
              expect(ip_repo.allocate_dynamic_ip(reservation, subnet)).to eq(cidr_ip(&#39;192.168.1.5&#39;))
            end
          end

          context &#39;when allocating any IP fails&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(allocate_dynamic_ip)::context(when reserving IP fails)::shared_examples(retries_on_race_condition)::context#when allocating any IP fails has a flog score of 27</span>          </div>  </li></ol>
            before do
              network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.1.0/29&#39;
              network_spec[&#39;subnets&#39;].first[&#39;reserved&#39;] = [&#39;192.168.1.5&#39;, &#39;192.168.1.6&#39;]

              fail_saving_ips([
                  cidr_ip(&#39;192.168.1.2&#39;),
                  cidr_ip(&#39;192.168.1.3&#39;),
                  cidr_ip(&#39;192.168.1.4&#39;)
                ],
                fail_error
              )
            end

            it &#39;retries until there are no more IPs available&#39; do
              expect(ip_repo.allocate_dynamic_ip(reservation, subnet)).to be_nil
            end
          end
        end

        context &#39;when sequel validation errors&#39; do
          let(:fail_error) { Sequel::ValidationFailed.new(&#39;address and network are not unique&#39;) }

          it_behaves_like :retries_on_race_condition
        end

        context &#39;when postgres unique errors&#39; do
          let(:fail_error) { Sequel::DatabaseError.new(&#39;duplicate key value violates unique constraint&#39;) }

          it_behaves_like :retries_on_race_condition
        end

        context &#39;when mysql unique errors&#39; do
          let(:fail_error) { Sequel::DatabaseError.new(&#39;Duplicate entry&#39;) }

          it_behaves_like :retries_on_race_condition
        end
      end
    end

    describe :delete do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="database_ip_repo_ipv6_spec.html#L385" class="js-smell-location">0</a>                  <a href="database_ip_repo_spec.html#L402" class="js-smell-location">1</a>                  </div>  </li></ol>
      before do
        network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]

        reservation = BD::DesiredNetworkReservation.new_static(instance_model, network, &#39;192.168.1.5&#39;)
        ip_repo.add(reservation)
      end

      it &#39;deletes IP address&#39; do
        expect {
          ip_repo.delete(&#39;192.168.1.5&#39;, &#39;does not matter&#39;)
        }.to change {
            Bosh::Director::Models::IpAddress.all.size
          }.by(-1)
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
