<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan/ip_provider /</small> ip_provider_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">671</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">43</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1356.28</span><small> complexity</small></div>
              <div><span class="metric">342</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                28
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director::DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
  describe IpProvider do
    let(:instance_model) { Bosh::Director::Models::Instance.make }
    let(:deployment_plan) { instance_double(Planner, name: &#39;fake-deployment&#39;, using_global_networking?: using_global_networking) }
    let(:global_network_resolver) { instance_double(GlobalNetworkResolver, reserved_ranges: Set.new) }
    let(:networks) do
      { &#39;my-manual-network&#39; =&gt; manual_network }
    end
    let(:manual_network_spec) do
      {
        &#39;name&#39; =&gt; &#39;my-manual-network&#39;,
        &#39;subnets&#39; =&gt; [
          {
            &#39;range&#39; =&gt; &#39;192.168.1.0/30&#39;,
            &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
            &#39;static&#39; =&gt; [],
            &#39;reserved&#39; =&gt; [],
            &#39;cloud_properties&#39; =&gt; {},
            &#39;az&#39; =&gt; &#39;az-1&#39;,
          },
          {
            &#39;range&#39; =&gt; &#39;192.168.2.0/30&#39;,
            &#39;gateway&#39; =&gt; &#39;192.168.2.1&#39;,
            &#39;dns&#39; =&gt; [&#39;192.168.2.1&#39;, &#39;192.168.2.2&#39;],
            &#39;static&#39; =&gt; [],
            &#39;reserved&#39; =&gt; [],
            &#39;cloud_properties&#39; =&gt; {},
            &#39;az&#39; =&gt; &#39;az-2&#39;,
          },
          {
            &#39;range&#39; =&gt; &#39;192.168.3.0/30&#39;,
            &#39;gateway&#39; =&gt; &#39;192.168.3.1&#39;,
            &#39;dns&#39; =&gt; [&#39;192.168.3.1&#39;, &#39;192.168.3.2&#39;],
            &#39;static&#39; =&gt; [],
            &#39;reserved&#39; =&gt; [],
            &#39;cloud_properties&#39; =&gt; {},
            &#39;azs&#39; =&gt; [&#39;az-2&#39;],
          },
        ],
      }
    end
    let(:manual_network) do
      ManualNetwork.parse(
        manual_network_spec,
        [
          BD::DeploymentPlan::AvailabilityZone.new(&#39;az-1&#39;, {}),
          BD::DeploymentPlan::AvailabilityZone.new(&#39;az-2&#39;, {})
        ],
        global_network_resolver,
        logger
      )
    end
    let(:another_manual_network) do
      ManualNetwork.parse(
        {
          &#39;name&#39; =&gt; &#39;my-another-network&#39;,
          &#39;subnets&#39; =&gt; [
            {
              &#39;range&#39; =&gt; &#39;192.168.1.0/24&#39;,
              &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            }
          ]
        },
        [],
        global_network_resolver,
        logger
      )
    end
    let(:vip_network_spec) do
      {
        &#39;name&#39; =&gt; &#39;my-vip-network&#39;,
        &#39;type&#39; =&gt; &#39;vip&#39;,
      }
    end
    let(:vip_network) { VipNetwork.new(vip_network_spec, logger) }
    let(:ip_reservation) { Bosh::Director::DesiredNetworkReservation.new_dynamic(instance_model, manual_network) }

    before do
      Bosh::Director::Config.current_job = Bosh::Director::Jobs::BaseJob.new
      Bosh::Director::Config.current_job.task_id = &#39;fake-task-id&#39;
    end

    shared_examples_for &#39;an ip provider with any repo&#39; do
      describe :release do
        context &#39;when reservation does not have an IP&#39; do
          it &#39;should raise an error&#39; do
            ip_reservation.mark_reserved

            expect {
              ip_provider.release(ip_reservation)
            }.to raise_error(Bosh::Director::NetworkReservationIpMissing, &quot;Can&#39;t release reservation without an IP&quot;)
          end
        end

        context &#39;when reservation has an IP&#39; do
          it &#39;should release IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(release)::context(when reservation has an IP)::it#should release IP has a flog score of 45</span>          </div>  </li></ol>
            manual_network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.2&#39;]
            instance_model = Bosh::Director::Models::Instance.make(availability_zone: &#39;az-2&#39;)
            other_instance_model = Bosh::Director::Models::Instance.make(availability_zone: &#39;az-2&#39;)

            original_reservation = Bosh::Director::DesiredNetworkReservation.new_static(instance_model, manual_network, &#39;192.168.1.2&#39;)
            new_reservation = Bosh::Director::DesiredNetworkReservation.new_static(other_instance_model, manual_network, &#39;192.168.1.2&#39;)

            ip_provider.reserve(original_reservation)
            expect {
              ip_provider.reserve(new_reservation)
            }.to raise_error(Bosh::Director::NetworkReservationAlreadyInUse)

            ip_provider.release(original_reservation)

            expect {
              ip_provider.reserve(new_reservation)
            }.not_to raise_error
          end

          context &#39;when the IP is from a previous deploy and no longer in any subnets range&#39; do
            it &#39;should release IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(release)::context(when reservation has an IP)::context(when the IP is from a previous deploy and no longer in any subnets range)::it#should release IP has a flog score of 35</span>          </div>  </li></ol>
              manual_network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.6.0/30&#39;
              manual_network_spec[&#39;subnets&#39;].first[&#39;gateway&#39;] = &#39;192.168.6.1&#39;
              manual_network_spec[&#39;subnets&#39;].first[&#39;dns&#39;] = []

              reservation_with_ip_outside_subnet = Bosh::Director::DesiredNetworkReservation.new_static(instance_model, manual_network, &#39;192.168.1.2&#39;)
              expect {
                ip_provider.release(reservation_with_ip_outside_subnet)
              }.not_to raise_error
            end
          end

          context &#39;when VipNetwork&#39; do
            it &#39;releases IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(release)::context(when reservation has an IP)::context(when VipNetwork)::it#releases IP has a flog score of 40</span>          </div>  </li></ol>
              reservation = BD::DesiredNetworkReservation.new_static(instance_model, vip_network, &#39;192.168.1.2&#39;)
              other_instance_model = Bosh::Director::Models::Instance.make(availability_zone: &#39;az-2&#39;)
              other_reservation_with_same_ip = BD::DesiredNetworkReservation.new_static(other_instance_model, vip_network, &#39;192.168.1.2&#39;)

              ip_provider.reserve(reservation)
              expect {
                ip_provider.reserve(other_reservation_with_same_ip)
              }.to raise_error

              ip_provider.release(reservation)
              expect { ip_provider.reserve(other_reservation_with_same_ip) }.not_to raise_error
            end
          end

          context &#39;when user switches network type from manual to dynamic AND deployment had a previous static IP reservation&#39; do
            it &#39;releases IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(release)::context(when reservation has an IP)::context(when user switches network type from manual to dynamic AND deployment had a previous static IP reservation)::it#releases IP has a flog score of 57</span>          </div>  </li></ol>
              manual_network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.2&#39;]
              reservation = BD::DesiredNetworkReservation.new_static(instance_model, manual_network, &#39;192.168.1.2&#39;)
              ip_provider.reserve(reservation)

              dynamic_network = DynamicNetwork.new(&#39;my-manual-network&#39;, [], logger)
              reservation = BD::ExistingNetworkReservation.new(instance_model, dynamic_network, &#39;192.168.1.2&#39;, &#39;manual&#39;)
              ip_provider.reserve_existing_ips(reservation)

              other_instance_model = Bosh::Director::Models::Instance.make(availability_zone: &#39;az-2&#39;)
              other_reservation_with_same_ip = BD::DesiredNetworkReservation.new_static(other_instance_model, manual_network, &#39;192.168.1.2&#39;)

              expect {
                ip_provider.reserve(other_reservation_with_same_ip)
              }.to raise_error

              ip_provider.release(reservation)
              expect { ip_provider.reserve(other_reservation_with_same_ip) }.not_to raise_error
            end
          end

          context &#39;when reservation is on dynamic network without IP address&#39; do
            it &#39;does not fail to release it&#39; do
              dynamic_network = DynamicNetwork.new(&#39;my-manual-network&#39;, [], logger)
              reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, dynamic_network)

              expect {
                ip_provider.release(reservation)
              }.to_not raise_error
            end
          end
        end
      end

      describe :reserve do
        context &#39;when ManualNetwork&#39; do
          context &#39;when IP is provided&#39; do
            context &#39;when reservation does not belong to any subnet&#39; do
              context &#39;when dynamic network reservation&#39; do
                let(:reservation) { BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network) }
                before { reservation.resolve_ip(&#39;192.168.2.6&#39;) }

                it &#39;raises NetworkReservationIpOutsideSubnet&#39; do
                  expect {
                    ip_provider.reserve(reservation)
                  }.to raise_error BD::NetworkReservationIpOutsideSubnet
                end
              end

              context &#39;when static network reservation&#39; do
                let(:reservation) { BD::DesiredNetworkReservation.new_static(instance_model, manual_network, &#39;192.168.2.6&#39;) }

                it &#39;raises NetworkReservationIpOutsideSubnet&#39; do
                  expect {
                    ip_provider.reserve(reservation)
                  }.to raise_error BD::NetworkReservationIpOutsideSubnet
                end
              end
            end

            context &#39;when reservation belongs to subnet&#39; do
              context &#39;when it is a dynamic reservation&#39; do
                it &#39;reserves reservation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is provided)::context(when reservation belongs to subnet)::context(when it is a dynamic reservation)::it#reserves reservation has a flog score of 46</span>          </div>  </li></ol>
                  manual_network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.1.0/24&#39;

                  reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network)

                  reservation.resolve_ip(&#39;192.168.1.6&#39;)
                  reservation.instance_model.update(availability_zone: &#39;az-1&#39;)

                  ip_provider.reserve(reservation)
                  expect(reservation.ip).to eq(NetAddr::CIDR.create(&#39;192.168.1.6&#39;).to_i)
                  expect(reservation).to be_reserved
                end

                context &#39;when that IP is now in the reserved range&#39; do
                  before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L225" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L255" class="js-smell-location">1</a>                  <a href="ip_provider_spec.html#L268" class="js-smell-location">2</a>                  </div>  </li></ol>
                    manual_network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.1.0/24&#39;
                    manual_network_spec[&#39;subnets&#39;].first[&#39;reserved&#39;] = [&#39;192.168.1.11&#39;]
                  end

                  it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is provided)::context(when reservation belongs to subnet)::context(when it is a dynamic reservation)::context(when that IP is now in the reserved range)::it#raises an error has a flog score of 27</span>          </div>  </li></ol>
                    reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network)
                    reservation.resolve_ip(NetAddr::CIDR.create(&#39;192.168.1.11&#39;).to_i)
                    expect {
                      ip_provider.reserve(reservation)
                    }.to raise_error Bosh::Director::NetworkReservationIpReserved,
                        &quot;Failed to reserve IP &#39;192.168.1.11&#39; for network &#39;my-manual-network&#39;: IP belongs to reserved range&quot;
                  end
                end

                context &#39;when user accidentally includes a static IP in the range&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L240" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L282" class="js-smell-location">1</a>                  </div>  </li></ol>
                  it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is provided)::context(when reservation belongs to subnet)::context(when it is a dynamic reservation)::context(when user accidentally includes a static IP in the range)::it#raises an error has a flog score of 28</span>          </div>  </li></ol>
                    manual_network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.2&#39;]

                    reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network)
                    reservation.resolve_ip(&#39;192.168.1.2&#39;)
                    expect {
                      ip_provider.reserve(reservation)
                    }.to raise_error Bosh::Director::NetworkReservationWrongType,
                        &quot;IP &#39;192.168.1.2&#39; on network &#39;my-manual-network&#39; does not belong to dynamic pool&quot;
                  end
                end
              end

              context &#39;when it is a static reservation&#39; do
                before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L225" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L255" class="js-smell-location">1</a>                  <a href="ip_provider_spec.html#L268" class="js-smell-location">2</a>                  </div>  </li></ol>
                  manual_network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.1.0/24&#39;
                  manual_network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.5&#39;]
                end
                let(:static_network_reservation) { BD::DesiredNetworkReservation.new_static(instance_model, manual_network, &#39;192.168.1.5&#39;) }

                it &#39;should reserve static IPs&#39; do
                  expect {
                    ip_provider.reserve(static_network_reservation)
                  }.to_not raise_error
                end

                context &#39;when IP is in reserved range&#39; do
                  before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L225" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L255" class="js-smell-location">1</a>                  <a href="ip_provider_spec.html#L268" class="js-smell-location">2</a>                  </div>  </li></ol>
                    manual_network_spec[&#39;subnets&#39;].first[&#39;range&#39;] = &#39;192.168.1.0/24&#39;
                    manual_network_spec[&#39;subnets&#39;].first[&#39;reserved&#39;] = [&#39;192.168.1.11&#39;]
                  end

                  it &#39;when IP is in reserved range, raises NetworkReservationIpReserved&#39; do
                    reservation = BD::DesiredNetworkReservation.new_static(instance_model, manual_network, &#39;192.168.1.11&#39;)
                    expect {
                      ip_provider.reserve(reservation)
                    }.to raise_error Bosh::Director::NetworkReservationIpReserved,
                        &quot;Failed to reserve IP &#39;192.168.1.11&#39; for network &#39;my-manual-network&#39;: IP belongs to reserved range&quot;
                  end
                end

                context &#39;when user accidentally assigns an IP to a job that is NOT a static IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L240" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L282" class="js-smell-location">1</a>                  </div>  </li></ol>
                  it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is provided)::context(when reservation belongs to subnet)::context(when it is a static reservation)::context(when user accidentally assigns an IP to a job that is NOT a static IP)::it#raises an error has a flog score of 28</span>          </div>  </li></ol>
                    manual_network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.2&#39;]
                    reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network)
                    reservation.resolve_ip(&#39;192.168.1.2&#39;)
                    expect {
                      ip_provider.reserve(reservation)
                    }.to raise_error Bosh::Director::NetworkReservationWrongType,
                        &quot;IP &#39;192.168.1.2&#39; on network &#39;my-manual-network&#39; does not belong to dynamic pool&quot;
                  end
                end
              end
            end

            context &#39;when there are several networks that have overlapping subnet ranges that include reservation IP&#39; do
              let(:networks) do
                {
                  &#39;my-manual-network&#39; =&gt; manual_network,
                  &#39;my-another-network&#39; =&gt; another_manual_network,
                }
              end
              let(:reservation) do
                reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network)
                reservation.resolve_ip(&#39;192.168.1.6&#39;)
                reservation
              end
              let(:manual_network_spec) do
                {
                  &#39;name&#39; =&gt; &#39;my-manual-network&#39;,
                  &#39;subnets&#39; =&gt; [
                    {
                      &#39;range&#39; =&gt; &#39;192.168.1.0/24&#39;,
                      &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                      &#39;reserved&#39; =&gt; manual_network_reserved,
                    }
                  ]
                }
              end
              let(:manual_network_reserved) { [] }

              context &#39;when reservation network has subnet that includes reservation IP&#39; do
                it &#39;marks reservation as reserved&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L323" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L517" class="js-smell-location">1</a>                  <a href="ip_provider_spec.html#L539" class="js-smell-location">2</a>                  <a href="ip_provider_spec.html#L567" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is provided)::context(when there are several networks that have overlapping subnet ranges that include reservation IP)::context(when reservation network has subnet that includes reservation IP)::it#marks reservation as reserved has a flog score of 30</span>          </div>  </li></ol>
                  ip_provider.reserve(reservation)
                  expect(reservation).to be_reserved
                  expect(reservation.network.name).to eq(&#39;my-manual-network&#39;)
                end
              end

              context &#39;when reservation network does not have subnet that includes reservation IP&#39; do
                let(:manual_network_reserved) { [&#39;192.168.1.6&#39;] }
                it &#39;fails to reserve the reservation&#39; do
                  expect {
                    ip_provider.reserve(reservation)
                  }.to raise_error BD::NetworkReservationIpReserved, &quot;Failed to reserve IP &#39;192.168.1.6&#39; for network &#39;my-manual-network&#39;: IP belongs to reserved range&quot;
                end
              end
            end
          end

          context &#39;when IP is not provided&#39; do
            context &#39;for dynamic reservation&#39; do
              let(:reservation) { BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network) }

              it &#39;allocates a dynamic IP in the correct subnet when the instance has an AZ&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is not provided)::context(for dynamic reservation)::it#allocates a dynamic IP in the correct subnet when the instance has an AZ has a flog score of 27</span>          </div>  </li></ol>
                instance_model.update(availability_zone: &#39;az-2&#39;)
                ip_provider.reserve(reservation)

                expect(NetAddr::CIDR.create(reservation.ip).to_s).to eq(&#39;192.168.2.2/32&#39;)
              end

              it &#39;allocates a dynamic IP in any subnet for an instance without an AZ&#39; do
                ip_provider.reserve(reservation)

                expect(NetAddr::CIDR.create(reservation.ip).to_s).to eq(&#39;192.168.1.2/32&#39;)
              end

              it &#39;does not allocate a static IP as a dynamic IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L358" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L366" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is not provided)::context(for dynamic reservation)::it#does not allocate a static IP as a dynamic IP has a flog score of 34</span>          </div>  </li></ol>
                manual_network_spec[&#39;subnets&#39;].first[&#39;static&#39;] &lt;&lt; &#39;192.168.1.2&#39;

                ip_provider.reserve(reservation)

                expect(NetAddr::CIDR.create(reservation.ip).to_s).not_to eq(&#39;192.168.1.2/32&#39;)
              end

              it &#39;does not allocate a reserved IP as a dynamic IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L358" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L366" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is not provided)::context(for dynamic reservation)::it#does not allocate a reserved IP as a dynamic IP has a flog score of 34</span>          </div>  </li></ol>
                manual_network_spec[&#39;subnets&#39;].first[&#39;reserved&#39;] &lt;&lt; &#39;192.168.1.2&#39;

                ip_provider.reserve(reservation)

                expect(NetAddr::CIDR.create(reservation.ip).to_s).not_to eq(&#39;192.168.1.2/32&#39;)
              end

              it &#39;allocates dynamic IPs across multiple subnets for a single AZ&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is not provided)::context(for dynamic reservation)::it#allocates dynamic IPs across multiple subnets for a single AZ has a flog score of 37</span>          </div>  </li></ol>
                instance_model.update(availability_zone: &#39;az-2&#39;)
                ip_provider.reserve(BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network))

                ip_provider.reserve(reservation)
                expect(NetAddr::CIDR.create(reservation.ip).to_s).to eq(&#39;192.168.3.2/32&#39;)
              end

              context &#39;when no subnet has enough capacity to allocate a dynamic IP&#39; do
                it &#39;raises NetworkReservationNotEnoughCapacity&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when ManualNetwork)::context(when IP is not provided)::context(for dynamic reservation)::context(when no subnet has enough capacity to allocate a dynamic IP)::it#raises NetworkReservationNotEnoughCapacity has a flog score of 27</span>          </div>  </li></ol>
                  # Trying to reserve 1 more IP than the available
                  3.times { ip_provider.reserve(BD::DesiredNetworkReservation.new_dynamic(instance_model, manual_network)) }

                  expect {
                    ip_provider.reserve(reservation)
                  }.to raise_error BD::NetworkReservationNotEnoughCapacity
                end
              end
            end
          end
        end

        context &#39;when VipNetwork&#39; do
          context &#39;when IP has already been reserved (allocated)&#39; do
            it &#39;raises NetworkReservationAlreadyInUse&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve)::context(when VipNetwork)::context(when IP has already been reserved (allocated))::it#raises NetworkReservationAlreadyInUse has a flog score of 26</span>          </div>  </li></ol>
              other_instance_model = Bosh::Director::Models::Instance.make(availability_zone: &#39;az-2&#39;)

              original_static_network_reservation = BD::DesiredNetworkReservation.new_static(instance_model, vip_network, &#39;192.168.1.2&#39;)
              new_static_network_reservation = BD::DesiredNetworkReservation.new_static(other_instance_model, vip_network, &#39;192.168.1.2&#39;)

              ip_provider.reserve(original_static_network_reservation)

              expect {
                ip_provider.reserve(new_static_network_reservation)
              }.to raise_error BD::NetworkReservationAlreadyInUse
            end
          end

          context &#39;when IP is provided and can be reserved&#39; do
            it &#39;reserves the IP as a StaticNetworkReservation&#39; do
              reservation = BD::DesiredNetworkReservation.new_static(instance_model, vip_network, &#39;192.168.1.2&#39;)

              expect {
                ip_provider.reserve(reservation)
              }.not_to raise_error
            end
          end
        end
      end

      describe :reserve_existing_ips do
        context &#39;when dynamic network&#39; do
          let(:dynamic_network) { BD::DeploymentPlan::DynamicNetwork.new(&#39;fake-dynamic-network&#39;, [], logger) }

          context &#39;when existing network type was dynamic&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L428" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L438" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:existing_network_reservation) { BD::ExistingNetworkReservation.new(instance_model, dynamic_network, &#39;192.168.1.2&#39;, &#39;dynamic&#39;) }

            it &#39;does not reserve the reservation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve_existing_ips)::context(when dynamic network)::context(when existing network type was dynamic)::it#does not reserve the reservation has a flog score of 28</span>          </div>  </li></ol>
              ip_provider.reserve_existing_ips(existing_network_reservation)
              expect(existing_network_reservation.dynamic?).to be_truthy
              expect(existing_network_reservation.reserved?).to be_truthy
            end
          end

          context &#39;when existing network type was not dynamic&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L428" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L438" class="js-smell-location">1</a>                  </div>  </li></ol>
            let(:existing_network_reservation) { BD::ExistingNetworkReservation.new(instance_model, dynamic_network, &#39;192.168.1.2&#39;, &#39;manual&#39;) }

            it &#39;does not reserve the reservation&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve_existing_ips)::context(when dynamic network)::context(when existing network type was not dynamic)::it#does not reserve the reservation has a flog score of 28</span>          </div>  </li></ol>
              ip_provider.reserve_existing_ips(existing_network_reservation)
              expect(existing_network_reservation.dynamic?).to be_falsey
              expect(existing_network_reservation.reserved?).to be_falsey
            end
          end
        end

        context &#39;when vip network&#39; do
          let(:existing_network_reservation) { BD::ExistingNetworkReservation.new(instance_model, vip_network, &#39;69.69.69.69&#39;, &#39;vip&#39;) }
          let(:vip_network) { BD::DeploymentPlan::VipNetwork.new({&#39;name&#39; =&gt; &#39;fake-network&#39;}, logger) }

          it &#39;marks reservation as reserved&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve_existing_ips)::context(when vip network)::it#marks reservation as reserved has a flog score of 27</span>          </div>  </li></ol>
            ip_provider.reserve_existing_ips(existing_network_reservation)
            expect(existing_network_reservation.static?).to be_truthy
            expect(existing_network_reservation.reserved?).to be_truthy
          end
        end

        context &#39;when manual network&#39; do
          let(:existing_network_reservation) { BD::ExistingNetworkReservation.new(instance_model, manual_network, &#39;192.168.1.2&#39;, &#39;manual&#39;) }

          context &#39;when IP is a static IP&#39; do
            it &#39;should reserve IP as static&#39; do
              manual_network_spec[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.2&#39;]
              ip_provider.reserve_existing_ips(existing_network_reservation)

              expect(existing_network_reservation.static?).to be_truthy
            end
          end

          context &#39;when IP is a dynamic IP&#39; do
            it &#39;should reserve IP as dynamic&#39; do
              ip_provider.reserve_existing_ips(existing_network_reservation)

              expect(existing_network_reservation.dynamic?).to be_truthy
            end
          end

          context &#39;when IP is in reserved range&#39; do
            it &#39;should not reserve IP&#39; do
              manual_network_spec[&#39;subnets&#39;].first[&#39;reserved&#39;] = [&#39;192.168.1.2&#39;]
              ip_provider.reserve_existing_ips(existing_network_reservation)

              expect(existing_network_reservation).not_to be_reserved
            end
          end

          context &#39;when reservation network has subnet that includes reservation IP&#39; do
            it &#39;reserves IP&#39; do
              ip_provider.reserve_existing_ips(existing_network_reservation)
              expect(existing_network_reservation).to be_reserved
            end
          end

          context &#39;when reservation network does not have subnet that includes reservation IP&#39; do
            let(:manual_network_spec) do
              {
                &#39;name&#39; =&gt; &#39;my-manual-network&#39;,
                &#39;subnets&#39; =&gt; [
                  {
                    &#39;range&#39; =&gt; &#39;10.10.10.0/24&#39;,
                    &#39;gateway&#39; =&gt; &#39;10.10.10.1&#39;,
                  }
                ]
              }
            end

            context &#39;when another network has subnet that includes that IP&#39; do
              let(:networks) do
                {
                  &#39;my-manual-network&#39; =&gt; manual_network,
                  &#39;my-another-network&#39; =&gt; another_manual_network,
                }
              end

              it &#39;reserves IP and updates reservation network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L323" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L517" class="js-smell-location">1</a>                  <a href="ip_provider_spec.html#L539" class="js-smell-location">2</a>                  <a href="ip_provider_spec.html#L567" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve_existing_ips)::context(when manual network)::context(when reservation network does not have subnet that includes reservation IP)::context(when another network has subnet that includes that IP)::it#reserves IP and updates reservation network has a flog score of 30</span>          </div>  </li></ol>
                ip_provider.reserve_existing_ips(existing_network_reservation)
                expect(existing_network_reservation).to be_reserved
                expect(existing_network_reservation.network.name).to eq(&#39;my-another-network&#39;)
              end
            end

            context &#39;when there are NO networks with subnets that can fit existing IP&#39; do
              it &#39;should not reserve IP&#39; do
                reservation_outside_subnet = BD::ExistingNetworkReservation.new(instance_model, manual_network, &#39;10.0.0.1&#39;, &#39;manual&#39;)
                ip_provider.reserve_existing_ips(reservation_outside_subnet)

                expect(reservation_outside_subnet).not_to be_reserved
              end
            end
          end

          context &#39;when reservation network was deleted&#39; do
            let(:networks) do
              { &#39;my-another-network&#39; =&gt; another_manual_network }
            end

            it &#39;finds the network that has subnet that includes reservation IP&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L323" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L517" class="js-smell-location">1</a>                  <a href="ip_provider_spec.html#L539" class="js-smell-location">2</a>                  <a href="ip_provider_spec.html#L567" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve_existing_ips)::context(when manual network)::context(when reservation network was deleted)::it#finds the network that has subnet that includes reservation IP has a flog score of 29</span>          </div>  </li></ol>
              ip_provider.reserve_existing_ips(existing_network_reservation)
              expect(existing_network_reservation).to be_reserved
              expect(existing_network_reservation.network.name).to eq(&#39;my-another-network&#39;)
            end
          end

          context &#39;when there are several networks that have overlapping subnet ranges that include reservation IP&#39; do
            let(:networks) do
              {
                &#39;my-manual-network&#39; =&gt; manual_network,
                &#39;my-another-network&#39; =&gt; another_manual_network,
              }
            end

            let(:manual_network_spec) do
              {
                &#39;name&#39; =&gt; &#39;my-manual-network&#39;,
                &#39;subnets&#39; =&gt; [
                  {
                    &#39;range&#39; =&gt; &#39;192.168.1.0/24&#39;,
                    &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                    &#39;reserved&#39; =&gt; [&#39;192.168.1.2&#39;]
                  }
                ]
              }
            end

            it &#39;picks the network that has subnet that does not have reservation IP in reserved range&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L323" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L517" class="js-smell-location">1</a>                  <a href="ip_provider_spec.html#L539" class="js-smell-location">2</a>                  <a href="ip_provider_spec.html#L567" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::shared_examples_for(an ip provider with any repo)::describe(reserve_existing_ips)::context(when manual network)::context(when there are several networks that have overlapping subnet ranges that include reservation IP)::it#picks the network that has subnet that does not have reservation IP in reserved range has a flog score of 29</span>          </div>  </li></ol>
              ip_provider.reserve_existing_ips(existing_network_reservation)
              expect(existing_network_reservation).to be_reserved
              expect(existing_network_reservation.network.name).to eq(&#39;my-another-network&#39;)
            end
          end

          context &#39;when there are 2 networks with the same subnet but different reserved ranges&#39; do
            let(:manual_network_spec) do
              {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L576" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L591" class="js-smell-location">1</a>                  </div>  </li></ol>
                &#39;name&#39; =&gt; &#39;my-manual-network&#39;,
                &#39;subnets&#39; =&gt; [
                  {
                    &#39;range&#39; =&gt; &#39;192.168.1.0/24&#39;,
                    &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                    &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                    &#39;reserved&#39; =&gt; [&#39;192.168.1.2-192.168.1.30&#39;],
                  }
                ]
              }
            end

            let(:another_manual_network) do
              ManualNetwork.parse(
                {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="ip_provider_spec.html#L576" class="js-smell-location">0</a>                  <a href="ip_provider_spec.html#L591" class="js-smell-location">1</a>                  </div>  </li></ol>
                  &#39;name&#39; =&gt; &#39;my-another-network&#39;,
                  &#39;subnets&#39; =&gt; [
                    {
                      &#39;range&#39; =&gt; &#39;192.168.1.0/24&#39;,
                      &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                      &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                      &#39;reserved&#39; =&gt; [&#39;192.168.1.2-192.168.1.40&#39;],
                    }
                  ]
                },
                [],
                global_network_resolver,
                logger
              )
            end

            let(:networks) do
              {
                &#39;my-manual-network&#39; =&gt; manual_network,
                &#39;my-another-network&#39; =&gt; another_manual_network,
              }
            end

            let(:existing_network_reservation) { BD::ExistingNetworkReservation.new(instance_model, another_manual_network, &#39;192.168.1.41&#39;, &#39;manual&#39;) }

            it &#39;should keep existing IP on existing network (it should not switch to a different network)&#39; do
              ip_provider.reserve_existing_ips(existing_network_reservation)

              expect(existing_network_reservation.network.name).to eq(&#39;my-another-network&#39;)
            end
          end
        end
      end
    end

    describe &#39;with an in-memory repo&#39; do
      let(:ip_repo) { InMemoryIpRepo.new(logger) }
      let(:ip_provider) { IpProvider.new(ip_repo, networks, logger) }
      it_should_behave_like &#39;an ip provider with any repo&#39;

      describe :reserve_existing_ips do
        context &#39;when ExistingNetworkReservation&#39; do
          let(:existing_network_reservation) { BD::ExistingNetworkReservation.new(instance_model, manual_network, &#39;192.168.1.2&#39;, &#39;manual&#39;) }

          it &#39;should add existing IP to list of reserved IPs&#39; do
            ip_provider.reserve_existing_ips(existing_network_reservation)

            expect {
              ip_provider.reserve_existing_ips(existing_network_reservation)
            }.to raise_error BD::NetworkReservationAlreadyInUse
          end
        end
      end
    end

    describe &#39;with a database-backed repo&#39; do
      let(:ip_repo) { DatabaseIpRepo.new(logger) }
      let(:ip_provider) { IpProvider.new(ip_repo, networks, logger) }
      it_should_behave_like &#39;an ip provider with any repo&#39;

      describe :reserve_existing_ips do
        context &#39;when ExistingNetworkReservation&#39; do
          let(:existing_network_reservation) { BD::ExistingNetworkReservation.new(instance_model, manual_network, &#39;192.168.1.2&#39;, &#39;manual&#39;) }

          it &#39;fails when trying to reserve for another instance&#39; do
            ip_provider.reserve_existing_ips(existing_network_reservation)

            other_instance_model = Bosh::Director::Models::Instance.make
            new_reservation_wanting_existing_ip = BD::DesiredNetworkReservation.new_dynamic(other_instance_model, manual_network)
            new_reservation_wanting_existing_ip.resolve_ip(&#39;192.168.1.2&#39;)

            expect {
              ip_provider.reserve_existing_ips(new_reservation_wanting_existing_ip)
            }.to raise_error /already reserved/
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
