<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:37:13 -0700'>2018-05-31 11:37:13 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> instance_plan_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">1609</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">122</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">2923.81</span><small> complexity</small></div>
              <div><span class="metric">1402</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                38
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director::DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
  describe InstancePlan do
    subject(:instance_plan) do
      InstancePlan.new(
        existing_instance: existing_instance,
        desired_instance: desired_instance,
        instance: instance,
        network_plans: network_plans,
        use_dns_addresses: use_dns_addresses,
        use_short_dns_addresses: use_short_dns_addresses,
        logger: logger,
        tags: tags)
    end

    let(:instance_group) { InstanceGroup.parse(deployment_plan, instance_group_spec, BD::Config.event_log, logger) }

    let!(:variable_set_model) { BD::Models::VariableSet.make(deployment: deployment_model) }
    let(:instance_model) do
      instance_model = BD::Models::Instance.make(
        uuid: &#39;fake-uuid-1&#39;,
        bootstrap: true,
        deployment: deployment_model,
        spec: spec,
        variable_set: variable_set_model,
        job: &#39;instance-group-name&#39;
      )
      BD::Models::Vm.make(instance: instance_model, active: true, agent_id: &#39;active-vm-agent-id&#39;)
      instance_model
    end
    let(:spec) do
      {
        &#39;vm_type&#39; =&gt;
        {&#39;name&#39; =&gt; &#39;original_vm_type_name&#39;,
          &#39;cloud_properties&#39; =&gt; {&#39;old&#39; =&gt; &#39;value&#39;}
        },
        &#39;env&#39; =&gt; {&#39;bosh&#39; =&gt; {&#39;password&#39; =&gt; &#39;foobar&#39;}},
        &#39;networks&#39; =&gt; network_settings,
        &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;1&#39;}
      }
    end

    let(:use_dns_addresses) { false }
    let(:use_short_dns_addresses) { false }
    let(:tags) do
      {&#39;key1&#39; =&gt; &#39;value1&#39;}
    end

    let(:desired_instance) { DesiredInstance.new(instance_group, deployment_plan, availability_zone) }
    let(:current_state) do
      { &#39;current&#39; =&gt; &#39;state&#39;, &#39;job&#39; =&gt; instance_group_spec, &#39;job_state&#39; =&gt; job_state }
    end
    let(:availability_zone) { AvailabilityZone.new(&#39;foo-az&#39;, {&#39;a&#39; =&gt; &#39;b&#39;}) }
    let(:instance) { Instance.create_from_instance_group(instance_group, 1, instance_state, deployment_plan.model, current_state, availability_zone, logger) }
    let(:instance_state) { &#39;started&#39; }
    let(:network_resolver) { GlobalNetworkResolver.new(deployment_plan, [], logger) }
    let(:network) { ManualNetwork.parse(network_spec, [availability_zone], network_resolver, logger) }
    let(:reservation) do
      reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, network)
      reservation.resolve_ip(&#39;192.168.1.3&#39;)
      reservation
    end
    let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
    let(:network_plans) do
      [
        NetworkPlanner::Plan.new(reservation: reservation, existing: true),
      ]
    end
    let(:job_state) { &#39;running&#39; }
    let(:existing_instance) { instance_model }

    let(:instance_group_spec) do
      instance_group = Bosh::Spec::NewDeployments.simple_instance_group
      instance_group[&#39;env&#39;] = { &#39;bosh&#39; =&gt; { &#39;password&#39; =&gt; &#39;foobar&#39; } }
      instance_group
    end

    let(:network_spec) { Bosh::Spec::Deployments.simple_cloud_config[&#39;networks&#39;].first }
    let(:cloud_config_manifest) { Bosh::Spec::NewDeployments.simple_cloud_config }
    let(:deployment_manifest) { Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups }
    let(:deployment_model) do
      cloud_config = BD::Models::Config.make(:cloud, content: YAML.dump(cloud_config_manifest))
      deployment = BD::Models::Deployment.make(
        name: deployment_manifest[&#39;name&#39;],
        manifest: YAML.dump(deployment_manifest),
      )
      deployment.cloud_configs = [cloud_config]
      deployment
    end
    let(:deployment_plan) do
      planner_factory = PlannerFactory.create(logger)
      plan = planner_factory.create_from_model(deployment_model)
      Assembler.create(plan).bind_models
      plan
    end
    let(:network_settings) do
      { &#39;a&#39; =&gt; { &#39;type&#39; =&gt; &#39;dynamic&#39;, &#39;cloud_properties&#39; =&gt; {}, &#39;dns&#39; =&gt; [&#39;10.0.0.1&#39;], &#39;default&#39; =&gt; %w[dns gateway] } }
    end

    before do
      fake_app
      fake_locks
      prepare_deploy(deployment_manifest)
      instance.bind_existing_instance_model(instance_model)
      instance_group.add_instance_plans([instance_plan])
    end

    describe &#39;#initialize&#39; do
      context &#39;with defaults&#39; do
        it &#39;correctly sets instance variables&#39; do
          expect(instance_plan.recreate_deployment).to eq(false)
          expect(instance_plan.skip_drain).to eq(false)
        end
      end

      context &#39;with given values&#39; do
        it &#39;correctly sets instance variables&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#initialize)::context(with given values)::it#correctly sets instance variables has a flog score of 54</span>          </div>  </li></ol>
          expect(instance_plan.desired_instance).to eq(desired_instance)
          expect(instance_plan.existing_instance).to eq(existing_instance)
          expect(instance_plan.instance).to eq(instance)
          expect(instance_plan.network_plans).to eq(network_plans)
          expect(instance_plan.tags).to eq({&#39;key1&#39; =&gt; &#39;value1&#39;})
        end
      end
    end

    describe &#39;networks_changed?&#39; do
      context &#39;when the instance plan has desired network plans&#39; do
        let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;existing-network&#39;, [subnet], logger) }
        let(:existing_reservation) { reservation = BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }
        let(:network_plans) do
          [
            NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true),
            NetworkPlanner::Plan.new(reservation: reservation),
          ]
        end
        let(:network_settings) do
          {
            &#39;existing-network&#39; =&gt;{
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt;{},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            },
            &#39;obsolete-network&#39; =&gt;{
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt;{},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            }
          }
        end

        it &#39;should return true&#39; do
          expect(instance_plan.networks_changed?).to be_truthy
        end

        it &#39;should log the changes&#39; do
          allow(logger).to receive(:debug)
          expect(logger).to receive(:debug).with(
            &quot;networks_changed? desired reservations: [#{reservation.to_s}]&quot;
          )

          instance_plan.networks_changed?
        end

        context &#39;when dns_record_name exists in network_settings&#39; do
          let(:network_plans) do
            [
              NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true),
              NetworkPlanner::Plan.new(reservation: reservation, existing: true),
            ]
          end
          let(:network_settings) do
            {
              &#39;existing-network&#39; =&gt; {
                &#39;type&#39; =&gt; &#39;dynamic&#39;,
                &#39;cloud_properties&#39; =&gt; {},
                &#39;dns_record_name&#39; =&gt; &#39;0.job-1.my-network.deployment.bosh&#39;,
                &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
              },
              &#39;a&#39; =&gt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L182" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L293" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1258" class="js-smell-location">2</a>                  </div>  </li></ol>
                &#39;type&#39; =&gt; &#39;manual&#39;,
                &#39;ip&#39; =&gt; &#39;192.168.1.3&#39;,
                &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
                &#39;cloud_properties&#39; =&gt; {},
                &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
                &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;
              }
            }
          end

          it &#39;should ignore dns_record_name when comparing old and new network_settings&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(networks_changed?)::context(when the instance plan has desired network plans)::context(when dns_record_name exists in network_settings)::it#should ignore dns_record_name when comparing old and new network_settings has a flog score of 27</span>          </div>  </li></ol>
            allow(logger).to receive(:debug)
            expect(logger).to_not receive(:debug).with(
              /networks_changed\? network settings changed FROM:/
            )

            expect(instance_plan.networks_changed?).to be(false)
          end
        end

        context &#39;when there are obsolete plans&#39; do
          let(:network_plans) do
            [
              NetworkPlanner::Plan.new(reservation: existing_reservation, obsolete: true),
            ]
          end
          let(:existing_reservation) do
            reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, existing_network)
            reservation.resolve_ip(&#39;10.0.0.5&#39;)
            reservation
          end

          it &#39;logs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L216" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L237" class="js-smell-location">1</a>                  </div>  </li></ol>
            allow(logger).to receive(:debug)
            expect(logger).to receive(:debug).with(
              &quot;networks_changed? obsolete reservations: [{type=dynamic, ip=10.0.0.5, network=existing-network, instance=#{instance_model}}]&quot;
            )
            instance_plan.networks_changed?
          end
        end

        context &#39;when there are desired plans&#39; do
          let(:network_plans) do
            [
              NetworkPlanner::Plan.new(reservation: desired_reservation),
            ]
          end
          let(:desired_reservation) do
            reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, existing_network)
            reservation.resolve_ip(&#39;10.0.0.5&#39;)
            reservation
          end

          it &#39;logs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L216" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L237" class="js-smell-location">1</a>                  </div>  </li></ol>
            allow(logger).to receive(:debug)
            expect(logger).to receive(:debug).with(
              &quot;networks_changed? desired reservations: [{type=dynamic, ip=10.0.0.5, network=existing-network, instance=#{instance_model}}]&quot;
            )
            instance_plan.networks_changed?
          end
        end

        context &#39;when instance is being deployed for the first time&#39; do
          let(:existing_instance) { nil }

          it &#39;should return true&#39; do
            expect(instance_plan.networks_changed?).to be_truthy
          end
        end
      end
    end

    describe &#39;network_settings_changed?&#39; do
      context &#39;when the instance plan has desired network plans&#39; do
        let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;existing-network&#39;, [subnet], logger) }
        let(:existing_reservation) { reservation = BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }
        let(:network_plans) do
          [
            NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true),
            NetworkPlanner::Plan.new(reservation: reservation),
          ]
        end
        let(:network_settings) do
          {
            &#39;existing-network&#39; =&gt;{
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt;{},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            },
            &#39;obsolete-network&#39; =&gt;{
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt;{},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            }
          }
        end

        it &#39;should return true&#39; do
          expect(instance_plan.network_settings_changed?).to be_truthy
        end

        it &#39;should log the changes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(network_settings_changed?)::context(when the instance plan has desired network plans)::it#should log the changes has a flog score of 26</span>          </div>  </li></ol>
          new_network_settings = {
            &#39;existing-network&#39; =&gt;{
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt;{},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            },
            &#39;a&#39; =&gt;{<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L182" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L293" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1258" class="js-smell-location">2</a>                  </div>  </li></ol>
              &#39;type&#39; =&gt; &#39;manual&#39;,
              &#39;ip&#39; =&gt; &#39;192.168.1.3&#39;,
              &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
              &#39;cloud_properties&#39; =&gt;{},
              &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
              &#39;dns&#39; =&gt;[&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
              &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            }
          }

          allow(logger).to receive(:debug)
          expect(logger).to receive(:debug).with(
            &quot;network_settings_changed? network settings changed FROM: #{network_settings} TO: #{new_network_settings} on instance #{instance_plan.existing_instance}&quot;
          )

          instance_plan.network_settings_changed?
        end

        context &#39;when network spec is changed during second deployment&#39; do
          let(:network_settings) do
            {
              &#39;existing-network&#39; =&gt; {
                &#39;type&#39; =&gt; &#39;dynamic&#39;,
                &#39;cloud_properties&#39; =&gt; {},
                &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
              }
            }
          end
          let(:subnet) { DynamicNetworkSubnet.new(&#39;8.8.8.8&#39;, subnet_cloud_properties, [&#39;foo-az&#39;]) }
          let(:network_plans) { [NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true)] }
          let(:subnet_cloud_properties) do
            {}
          end

          context &#39;when dns is changed&#39; do
            it &#39;should return true&#39; do
              expect(instance_plan.network_settings_changed?).to be_truthy
            end
          end

          context &#39;when variables exist in the spec&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(network_settings_changed?)::context(when the instance plan has desired network plans)::context(when network spec is changed during second deployment)::context#when variables exist in the spec has a flog score of 142</span>          </div>  </li></ol>
            let(:current_networks_hash) do
              { &#39;a&#39; =&gt; { &#39;b&#39; =&gt; &#39;((a_var))&#39; } }
            end

            let(:interpolated_current_networks_hash) do
              { &#39;a&#39; =&gt; { &#39;b&#39; =&gt; &#39;smurf&#39; } }
            end

            let(:desired_networks_hash) do
              { &#39;a&#39; =&gt; { &#39;b&#39; =&gt; &#39;((a_var))&#39; } }
            end

            let(:interpolated_desired_networks_hash) do
              { &#39;a&#39; =&gt; { &#39;b&#39; =&gt; &#39;gargamel&#39; } }
            end

            let(:client_factory) { instance_double(Bosh::Director::ConfigServer::ClientFactory) }
            let(:config_server_client) { instance_double(Bosh::Director::ConfigServer::ConfigServerClient) }

            let(:mock_network_settings) { instance_double(Bosh::Director::DeploymentPlan::NetworkSettings) }
            let(:mock_instance) { instance_double(Bosh::Director::DeploymentPlan::Instance) }
            let(:mock_desired_instance) { instance_double(Bosh::Director::DeploymentPlan::DesiredInstance) }
            let(:mock_existing_instance) { instance_double(Bosh::Director::Models::Instance) }
            let(:simple_instance_plan) { InstancePlan.new(existing_instance: mock_existing_instance, desired_instance: mock_desired_instance, instance: mock_instance) }

            let(:previous_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }
            let(:desired_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

            before do
              allow(Bosh::Director::ConfigServer::ClientFactory).to receive(:create).and_return(client_factory)
              allow(client_factory).to receive(:create_client).and_return(config_server_client)

              allow(mock_instance).to receive_message_chain(:model, :deployment, :name)
              allow(mock_instance).to receive(:instance_group_name)
              allow(mock_instance).to receive(:current_networks)
              allow(mock_instance).to receive(:availability_zone)
              allow(mock_instance).to receive(:index)
              allow(mock_instance).to receive(:uuid)
              allow(mock_instance).to receive(:previous_variable_set).and_return(previous_variable_set)
              allow(mock_instance).to receive(:desired_variable_set).and_return(desired_variable_set)

              allow(mock_desired_instance).to receive_message_chain(:instance_group, :default_network)

              allow(mock_existing_instance).to receive(:spec_p).and_return(current_networks_hash)

              allow(Bosh::Director::DeploymentPlan::NetworkSettings).to receive(:new).and_return(mock_network_settings)
              allow(mock_network_settings).to receive(:to_hash).and_return(desired_networks_hash)
            end

            it &#39;compares the interpolated cloud_properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(network_settings_changed?)::context(when the instance plan has desired network plans)::context(when network spec is changed during second deployment)::context(when variables exist in the spec)::it#compares the interpolated cloud_properties has a flog score of 49</span>          </div>  </li></ol>
              expect(config_server_client).to receive(:interpolate_with_versioning)
                .with(
                  current_networks_hash,
                  previous_variable_set,
                ).and_return(interpolated_current_networks_hash)
              expect(config_server_client).to receive(:interpolate_with_versioning).with(desired_networks_hash, desired_variable_set).and_return(interpolated_desired_networks_hash)

              expect(simple_instance_plan.network_settings_changed?).to be_truthy
            end

            it &#39;does not log the interpolated cloud property changes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(network_settings_changed?)::context(when the instance plan has desired network plans)::context(when network spec is changed during second deployment)::context(when variables exist in the spec)::it#does not log the interpolated cloud property changes has a flog score of 65</span>          </div>  </li></ol>
              allow(config_server_client).to receive(:interpolate_with_versioning).with(current_networks_hash, previous_variable_set).and_return(interpolated_current_networks_hash)
              allow(config_server_client).to receive(:interpolate_with_versioning).with(desired_networks_hash, desired_variable_set).and_return(interpolated_desired_networks_hash)

              expect(logger).to receive(:debug).with(
                &quot;network_settings_changed? network settings changed FROM: #{current_networks_hash} TO: #{desired_networks_hash} on instance #{mock_existing_instance}&quot;
              )
              expect(simple_instance_plan.network_settings_changed?).to be_truthy
            end
          end
        end
      end
    end

    describe &#39;#needs_shutting_down?&#39; do
      context &#39;when instance_plan is obsolete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L410" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L766" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:instance_plan) { InstancePlan.new(existing_instance: existing_instance, desired_instance: nil, instance: nil, network_plans: network_plans) }
        it &#39;shuts down the instance&#39; do
          expect(instance_plan.needs_shutting_down?).to be_truthy
        end
      end

      context &#39;when deployment is being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L417" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L583" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L773" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L915" class="js-smell-location">3</a>                  <a href="instance_plan_spec.html#L925" class="js-smell-location">4</a>                  <a href="instance_plan_spec.html#L1060" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:deployment) { instance_double(Planner, recreate: true) }
        it &#39;shuts down the instance&#39; do
          expect(instance_plan.needs_shutting_down?).to be_truthy
        end
      end

      context &#39;when the vm type name has changed&#39; do
        let(:subnet) { DynamicNetworkSubnet.new([&#39;10.0.0.1&#39;], {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;a&#39;, [subnet], logger) }
        let(:existing_reservation) { reservation = BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }

        let(:network_plans) { [NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true)] }

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L431" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L787" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L939" class="js-smell-location">2</a>                  </div>  </li></ol>
          instance_plan.existing_instance.update(spec: spec.merge({
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}}
          }))
        end

        it &#39;returns false&#39; do
          # because cloud_properties is the only part that matters
          expect(instance_plan.needs_shutting_down?).to be(false)
        end
      end

      context &#39;when the stemcell version has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L443" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L533" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L799" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L865" class="js-smell-location">3</a>                  </div>  </li></ol>
        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}},
            &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;2&#39;},
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.needs_shutting_down?).to be(true)
        end

        it &#39;logs the change reason&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#needs_shutting_down?)::context(when the stemcell version has changed)::it#logs the change reason has a flog score of 31</span>          </div>  </li></ol>
          expect(logger).to receive(:debug).with(&#39;stemcell_changed? changed FROM: &#39; +
            &#39;version: 2 &#39; +
            &#39;TO: &#39; +
            &#39;version: 1&#39; +
            &#39; on instance &#39; + &quot;#{instance_plan.existing_instance}&quot;
          )
          instance_plan.needs_shutting_down?
        end
      end

      context &#39;when the network has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L466" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L822" class="js-smell-location">1</a>                  </div>  </li></ol>
        # everything else should be the same
        let(:availability_zone) { AvailabilityZone.new(&#39;foo-az&#39;, {&#39;old&#39; =&gt; &#39;value&#39;}) }
        let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;existing-network&#39;, [subnet], logger) }
        let(:existing_reservation) { reservation = BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }

        let(:network_plans) do
          [
            NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true),
            NetworkPlanner::Plan.new(reservation: reservation),
          ]
        end
        let(:network_settings) do
          {
            &#39;existing-network&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            },
            &#39;obsolete-network&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            }
          }
        end

        it &#39;should return true&#39; do
          expect(instance_plan.needs_shutting_down?).to be(true)
        end
      end

      context &#39;when the network settings have changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L499" class="js-smell-location">0</a>                  <a href="instance_spec.html#L267" class="js-smell-location">1</a>                  </div>  </li></ol>
        # everything else should be the same
        let(:availability_zone) { AvailabilityZone.new(&#39;foo-az&#39;, {&#39;old&#39; =&gt; &#39;value&#39;}) }

        it &#39;should return true&#39; do
          expect(instance_plan.needs_shutting_down?).to be(true)
        end
      end

      context &#39;when the network settings have NOT changed&#39; do
        # everything else should be the same
        let(:network) { DynamicNetwork.parse(network_spec, [availability_zone], logger) }
        let(:network_spec) do
          {
            &#39;name&#39; =&gt; &#39;a&#39;,
            &#39;type&#39; =&gt; &#39;dynamic&#39;,
            &#39;subnets&#39; =&gt; [
              {
                &#39;range&#39; =&gt; &#39;10.0.0.0/24&#39;,
                &#39;gateway&#39; =&gt; &#39;10.0.0.1&#39;,
                &#39;az&#39; =&gt; &#39;foo-az&#39;,
                &#39;dns&#39; =&gt; [&#39;10.0.0.1&#39;],
                &#39;cloud_properties&#39; =&gt; {}
              }
            ]
          }
        end
        let(:availability_zone) { AvailabilityZone.new(&#39;foo-az&#39;, { &#39;old&#39; =&gt; &#39;value&#39; }) }

        it &#39;should return false&#39; do
          expect(instance_plan.needs_shutting_down?).to be(false)
        end
      end

      context &#39;when the stemcell name has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L443" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L533" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L799" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L865" class="js-smell-location">3</a>                  </div>  </li></ol>
        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}},
            &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell-old&#39;, &#39;version&#39; =&gt; &#39;1&#39;},
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.needs_shutting_down?).to be(true)
        end

        it &#39;logs the change reason&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#needs_shutting_down?)::context(when the stemcell name has changed)::it#logs the change reason has a flog score of 31</span>          </div>  </li></ol>
          expect(logger).to receive(:debug).with(&#39;stemcell_changed? changed FROM: &#39; +
            &#39;ubuntu-stemcell-old &#39; +
            &#39;TO: &#39; +
            &#39;ubuntu-stemcell&#39; +
            &#39; on instance &#39; + &quot;#{instance_plan.existing_instance}&quot;
          )
          instance_plan.needs_shutting_down?
        end
      end

      context &#39;when the env has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L556" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L888" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:instance_group_spec) do
          instance_group = Bosh::Spec::NewDeployments.simple_instance_group
          instance_group[&#39;env&#39;] = { &#39;key&#39; =&gt; &#39;changed-value&#39; }
          instance_group
        end

        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}},
            &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;1&#39;},
            &#39;env&#39; =&gt; {&#39;key&#39; =&gt; &#39;previous-value&#39;},
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.needs_shutting_down?).to be(true)
        end

        it &#39;log the change reason&#39; do
          expect(logger).to receive(:debug).with(
            &#39;env_changed? changed FROM: {&quot;key&quot;=&gt;&quot;previous-value&quot;} TO: {&quot;key&quot;=&gt;&quot;changed-value&quot;}&#39; +
              &#39; on instance &#39; + &quot;#{instance_plan.existing_instance}&quot;)
          instance_plan.needs_shutting_down?
        end
      end

      context &#39;when the instance is being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L417" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L583" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L773" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L915" class="js-smell-location">3</a>                  <a href="instance_plan_spec.html#L925" class="js-smell-location">4</a>                  <a href="instance_plan_spec.html#L1060" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:deployment) { instance_double(Planner, recreate: true) }

        it &#39;shuts down the instance&#39; do
          expect(instance_plan.needs_shutting_down?).to be_truthy
        end
      end
    end

    describe &#39;#vm_matches_plan?&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe##vm_matches_plan? has a flog score of 72</span>          </div>  </li></ol>
      let(:instance_group) do
        instance_group = BD::DeploymentPlan::InstanceGroup.new(logger)
        instance_group.name = &#39;foo-instance_group&#39;
        instance_group.availability_zones &lt;&lt; availability_zone
        instance_group.env = BD::DeploymentPlan::Env.new(&#39;env&#39; =&gt; &#39;env-val&#39;)
        instance_group.vm_type = BD::DeploymentPlan::VmType.new(
          &#39;name&#39; =&gt; &#39;a&#39;,
          &#39;cloud_properties&#39; =&gt; uninterpolated_cloud_properties_hash,
        )
        instance_group
      end

      let(:client_factory) { instance_double(Bosh::Director::ConfigServer::ClientFactory) }

      let(:config_server_client) { instance_double(Bosh::Director::ConfigServer::ConfigServerClient) }

      let(:uninterpolated_cloud_properties_hash) do
        { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }
      end

      let(:desired_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

      let(:previous_variable_set) { instance_double(Bosh::Director::Models::VariableSet) }

      let(:desired_cloud_properties_hash) do
        { &#39;cloud&#39; =&gt; &#39;prop&#39; }
      end

      let(:previous_cloud_properties_hash) do
        { &#39;cloud&#39; =&gt; &#39;prop&#39; }
      end

      let(:simple_instance_plan) do
        InstancePlan.new(
          existing_instance: mock_existing_instance,
          desired_instance: mock_desired_instance,
          instance: mock_instance,
        )
      end

      let(:mock_desired_instance) do
        instance_double(
          Bosh::Director::DeploymentPlan::DesiredInstance,
          instance_group: instance_group,
          availability_zone: availability_zone,
        )
      end

      let(:mock_existing_instance) do
        instance_double(
          Bosh::Director::Models::Instance,
        )
      end

      let(:mock_instance) do
        instance_double(
          Bosh::Director::DeploymentPlan::Instance,
          previous_variable_set: previous_variable_set,
          desired_variable_set: desired_variable_set,
          stemcell: instance_double(Bosh::Director::Models::Stemcell, name: &#39;ubuntu-stemcell&#39;, version: &#39;1&#39;),
          cloud_properties: uninterpolated_cloud_properties_hash,
        )
      end

      before do
        allow(client_factory).to receive(:create_client).and_return(config_server_client)
        allow(Bosh::Director::ConfigServer::ClientFactory).to receive(:create).and_return(client_factory)

        allow(instance_group.vm_type).to receive(:cloud_properties).and_return(uninterpolated_cloud_properties_hash)
        allow(config_server_client).to receive(:interpolate_with_versioning).with(
          uninterpolated_cloud_properties_hash,
          desired_variable_set,
        ).and_return(desired_cloud_properties_hash)
        allow(config_server_client).to receive(:interpolate_with_versioning).with(
          uninterpolated_cloud_properties_hash,
          previous_variable_set,
        ).and_return(previous_cloud_properties_hash)
      end

      it &#39;should match if all properties are the same&#39; do
        expect(
          simple_instance_plan.vm_matches_plan?(
            BD::Models::Vm.make(
              instance: existing_instance,
              stemcell_name: &#39;ubuntu-stemcell&#39;,
              stemcell_version: &#39;1&#39;,
              env_json: { &#39;env&#39; =&gt; &#39;env-val&#39; }.to_json,
              cloud_properties_json: { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }.to_json,
              active: true,
            ),
          ),
        ).to eq(true)
      end

      it &#39;should not match if stemcell differs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#vm_matches_plan?)::it#should not match if stemcell differs has a flog score of 37</span>          </div>  </li></ol>
        expect(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L688" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L701" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L716" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L749" class="js-smell-location">3</a>                  </div>  </li></ol>
          simple_instance_plan.vm_matches_plan?(
            BD::Models::Vm.make(
              instance: existing_instance,
              stemcell_name: &#39;other-stemcell&#39;,
              stemcell_version: &#39;1&#39;,
              env_json: { &#39;env&#39; =&gt; &#39;env-val&#39; }.to_json,
              cloud_properties_json: { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }.to_json,
              active: true,
            ),
          ),
        ).to eq(false)

        expect(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L688" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L701" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L716" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L749" class="js-smell-location">3</a>                  </div>  </li></ol>
          simple_instance_plan.vm_matches_plan?(
            BD::Models::Vm.make(
              instance: existing_instance,
              stemcell_name: &#39;ubuntu-stemcell&#39;,
              stemcell_version: &#39;5&#39;,
              env_json: { &#39;env&#39; =&gt; &#39;env-val&#39; }.to_json,
              cloud_properties_json: { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }.to_json,
              active: true,
            ),
          ),
        ).to eq(false)
      end

      it &#39;should not match if env properties differ&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#vm_matches_plan?)::it#should not match if env properties differ has a flog score of 37</span>          </div>  </li></ol>
        expect(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L688" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L701" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L716" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L749" class="js-smell-location">3</a>                  </div>  </li></ol>
          simple_instance_plan.vm_matches_plan?(
            BD::Models::Vm.make(
              instance: existing_instance,
              stemcell_name: &#39;ubuntu-stemcell&#39;,
              stemcell_version: &#39;1&#39;,
              env_json: { &#39;other-env&#39; =&gt; &#39;other-env-val&#39; }.to_json,
              cloud_properties_json: { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }.to_json,
              active: true,
            ),
          ),
        ).to eq(false)

        expect(
          simple_instance_plan.vm_matches_plan?(
            BD::Models::Vm.make(
              instance: existing_instance,
              stemcell_name: &#39;ubuntu-stemcell&#39;,
              stemcell_version: &#39;1&#39;,
              env_json: {}.to_json,
              cloud_properties_json: { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }.to_json,
              active: true,
            ),
          ),
        ).to eq(false)
      end

      context &#39;when cloud properties differ&#39; do
        let(:desired_cloud_properties_hash) do
          { &#39;cloud&#39; =&gt; &#39;new-prop&#39; }
        end

        it &#39;should not match&#39; do
          expect(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L688" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L701" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L716" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L749" class="js-smell-location">3</a>                  </div>  </li></ol>
            simple_instance_plan.vm_matches_plan?(
              BD::Models::Vm.make(
                instance: existing_instance,
                stemcell_name: &#39;ubuntu-stemcell&#39;,
                stemcell_version: &#39;1&#39;,
                env_json: { &#39;env&#39; =&gt; &#39;env-val&#39; }.to_json,
                cloud_properties_json: { &#39;cloud&#39; =&gt; &#39;((interpolated_prop))&#39; }.to_json,
                active: true,
              ),
            ),
          ).to eq(false)
        end
      end
    end

    describe &#39;#needs_duplicate_vm?&#39; do
      context &#39;when instance_plan is obsolete&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L410" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L766" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:instance_plan) { InstancePlan.new(existing_instance: existing_instance, desired_instance: nil, instance: nil, network_plans: network_plans) }
        it &#39;shuts down the instance&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be_truthy
        end
      end

      context &#39;when deployment is being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L417" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L583" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L773" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L915" class="js-smell-location">3</a>                  <a href="instance_plan_spec.html#L925" class="js-smell-location">4</a>                  <a href="instance_plan_spec.html#L1060" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:deployment) { instance_double(Planner, recreate: true) }
        it &#39;shuts down the instance&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be_truthy
        end
      end

      context &#39;when the vm type name has changed&#39; do
        let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;a&#39;, [subnet], logger) }
        let(:existing_reservation) { reservation = BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }

        let(:network_plans) { [NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true)] }

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L431" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L787" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L939" class="js-smell-location">2</a>                  </div>  </li></ol>
          instance_plan.existing_instance.update(spec: spec.merge({
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}}
          }))
        end

        it &#39;returns false&#39; do
          # because cloud_properties is the only part that matters
          expect(instance_plan.needs_duplicate_vm?).to be(false)
        end
      end

      context &#39;when the stemcell version has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L443" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L533" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L799" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L865" class="js-smell-location">3</a>                  </div>  </li></ol>
        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}},
            &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;2&#39;},
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be(true)
        end

        it &#39;logs the change reason&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#needs_duplicate_vm?)::context(when the stemcell version has changed)::it#logs the change reason has a flog score of 31</span>          </div>  </li></ol>
          expect(logger).to receive(:debug).with(&#39;stemcell_changed? changed FROM: &#39; +
            &#39;version: 2 &#39; +
            &#39;TO: &#39; +
            &#39;version: 1&#39; +
            &#39; on instance &#39; + &quot;#{instance_plan.existing_instance}&quot;
          )
          instance_plan.needs_duplicate_vm?
        end
      end

      context &#39;when the network has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L466" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L822" class="js-smell-location">1</a>                  </div>  </li></ol>
        # everything else should be the same
        let(:availability_zone) { AvailabilityZone.new(&#39;foo-az&#39;, {&#39;old&#39; =&gt; &#39;value&#39;}) }
        let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;existing-network&#39;, [subnet], logger) }
        let(:existing_reservation) { reservation = BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }

        let(:network_plans) do
          [
            NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true),
            NetworkPlanner::Plan.new(reservation: reservation),
          ]
        end
        let(:network_settings) do
          {
            &#39;existing-network&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            },
            &#39;obsolete-network&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            }
          }
        end

        it &#39;should return true&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be(true)
        end

      end

      context &#39;when the network settings have changed&#39; do
        # # everything else should be the same
        let(:availability_zone) { AvailabilityZone.new(&#39;foo-az&#39;, {&#39;old&#39; =&gt; &#39;value&#39;}) }

        it &#39;should still return false&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be(false)
        end
      end

      context &#39;when the stemcell name has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L443" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L533" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L799" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L865" class="js-smell-location">3</a>                  </div>  </li></ol>
        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}},
            &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell-old&#39;, &#39;version&#39; =&gt; &#39;1&#39;},
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be(true)
        end

        it &#39;logs the change reason&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#needs_duplicate_vm?)::context(when the stemcell name has changed)::it#logs the change reason has a flog score of 31</span>          </div>  </li></ol>
          expect(logger).to receive(:debug).with(&#39;stemcell_changed? changed FROM: &#39; +
            &#39;ubuntu-stemcell-old &#39; +
            &#39;TO: &#39; +
            &#39;ubuntu-stemcell&#39; +
            &#39; on instance &#39; + &quot;#{instance_plan.existing_instance}&quot;
          )
          instance_plan.needs_duplicate_vm?
        end
      end

      context &#39;when the env has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L556" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L888" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:instance_group_spec) do
          instance_group = Bosh::Spec::NewDeployments.simple_instance_group
          instance_group[&#39;env&#39;] = { &#39;key&#39; =&gt; &#39;changed-value&#39; }
          instance_group
        end

        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}},
            &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;1&#39;},
            &#39;env&#39; =&gt; {&#39;key&#39; =&gt; &#39;previous-value&#39;},
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be(true)
        end

        it &#39;log the change reason&#39; do
          expect(logger).to receive(:debug).with(
            &#39;env_changed? changed FROM: {&quot;key&quot;=&gt;&quot;previous-value&quot;} TO: {&quot;key&quot;=&gt;&quot;changed-value&quot;}&#39; +
              &#39; on instance &#39; + &quot;#{instance_plan.existing_instance}&quot;)
          instance_plan.needs_duplicate_vm?
        end
      end

      context &#39;when the instance is being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L417" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L583" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L773" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L915" class="js-smell-location">3</a>                  <a href="instance_plan_spec.html#L925" class="js-smell-location">4</a>                  <a href="instance_plan_spec.html#L1060" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:deployment) { instance_double(Planner, recreate: true) }

        it &#39;shuts down the instance&#39; do
          expect(instance_plan.needs_duplicate_vm?).to be_truthy
        end
      end
    end

    describe &#39;recreate_for_non_network_reasons?&#39; do
      context &#39;when deployment is being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L417" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L583" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L773" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L915" class="js-smell-location">3</a>                  <a href="instance_plan_spec.html#L925" class="js-smell-location">4</a>                  <a href="instance_plan_spec.html#L1060" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:deployment) { instance_double(Planner, recreate: true) }
        it &#39;shuts down the instance&#39; do
          expect(instance_plan.recreate_for_non_network_reasons?).to be_truthy
        end
      end

      context &#39;when the vm type name has changed&#39; do
        let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;a&#39;, [subnet], logger) }
        let(:existing_reservation) { BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }

        let(:network_plans) { [NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true)] }

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L431" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L787" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L939" class="js-smell-location">2</a>                  </div>  </li></ol>
          instance_plan.existing_instance.update(spec: spec.merge(
            &#39;vm_type&#39; =&gt; { &#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;b&#39; } },
          ))
        end

        it &#39;returns false&#39; do
          # because cloud_properties is the only part that matters
          expect(instance_plan.recreate_for_non_network_reasons?).to be(false)
        end
      end

      context &#39;when the stemcell version has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L951" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1008" class="js-smell-location">1</a>                  </div>  </li></ol>
        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; { &#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;b&#39; } },
            &#39;stemcell&#39; =&gt; { &#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;2&#39; },
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.recreate_for_non_network_reasons?).to be(true)
        end

        it &#39;logs the change reason&#39; do
          expect(logger).to receive(:debug).with(
            &#39;stemcell_changed? changed FROM: &#39; \
            &#39;version: 2 &#39; \
            &#39;TO: &#39; \
            &#39;version: 1&#39; \
            &quot; on instance #{instance_plan.existing_instance}&quot;,
          )
          instance_plan.recreate_for_non_network_reasons?
        end
      end

      context &#39;when the network has changed&#39; do
        # everything else should be the same
        let(:availability_zone) { AvailabilityZone.new(&#39;foo-az&#39;, &#39;old&#39; =&gt; &#39;value&#39;) }
        let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
        let(:existing_network) { DynamicNetwork.new(&#39;existing-network&#39;, [subnet], logger) }
        let(:existing_reservation) { BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }

        let(:network_plans) do
          [
            NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true),
            NetworkPlanner::Plan.new(reservation: reservation),
          ]
        end
        let(:network_settings) do
          {
            &#39;existing-network&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            },
            &#39;obsolete-network&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;dynamic&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;dns&#39; =&gt; &#39;10.0.0.1&#39;,
            },
          }
        end

        it &#39;should return false&#39; do
          expect(instance_plan.recreate_for_non_network_reasons?).to be(false)
        end
      end

      context &#39;when the stemcell name has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L951" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1008" class="js-smell-location">1</a>                  </div>  </li></ol>
        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; { &#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;b&#39; } },
            &#39;stemcell&#39; =&gt; { &#39;name&#39; =&gt; &#39;ubuntu-stemcell-old&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.recreate_for_non_network_reasons?).to be(true)
        end

        it &#39;logs the change reason&#39; do
          expect(logger).to receive(:debug).with(
            &#39;stemcell_changed? changed FROM: &#39; \
            &#39;ubuntu-stemcell-old &#39; \
            &#39;TO: &#39; \
            &#39;ubuntu-stemcell&#39; \
            &quot; on instance #{instance_plan.existing_instance}&quot;,
          )
          instance_plan.recreate_for_non_network_reasons?
        end
      end

      context &#39;when the env has changed&#39; do
        let(:instance_group_spec) do
          instance_group = Bosh::Spec::NewDeployments.simple_instance_group
          instance_group[&#39;env&#39;] = { &#39;key&#39; =&gt; &#39;changed-value&#39; }
          instance_group
        end

        before do
          instance_plan.existing_instance.update(spec: {
            &#39;vm_type&#39; =&gt; { &#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;b&#39; } },
            &#39;stemcell&#39; =&gt; { &#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
            &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;previous-value&#39; },
          })
        end

        it &#39;returns true&#39; do
          expect(instance_plan.recreate_for_non_network_reasons?).to be(true)
        end

        it &#39;log the change reason&#39; do
          expect(logger).to receive(:debug).with(
            &#39;env_changed? changed FROM: {&quot;key&quot;=&gt;&quot;previous-value&quot;} TO: {&quot;key&quot;=&gt;&quot;changed-value&quot;}&#39; \
            &quot; on instance #{instance_plan.existing_instance}&quot;,
          )
          instance_plan.recreate_for_non_network_reasons?
        end
      end

      context &#39;when the instance is being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L417" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L583" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L773" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L915" class="js-smell-location">3</a>                  <a href="instance_plan_spec.html#L925" class="js-smell-location">4</a>                  <a href="instance_plan_spec.html#L1060" class="js-smell-location">5</a>                  </div>  </li></ol>
        let(:deployment) { instance_double(Planner, recreate: true) }

        it &#39;shuts down the instance&#39; do
          expect(instance_plan.recreate_for_non_network_reasons?).to be_truthy
        end
      end

      context &#39;when the existing instance does not have a stemcell&#39; do
        before do
          instance_plan.existing_instance.update(spec: spec.merge(
            &#39;vm_type&#39; =&gt; { &#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;b&#39; } },
            &#39;stemcell&#39; =&gt; nil,
          ))
        end

        it &#39;returns false for stemcell changed&#39; do
          expect(instance_plan.recreate_for_non_network_reasons?).to be_falsey
        end
      end
    end

    describe &#39;#persist_current_spec&#39; do
      let(:subnet) { DynamicNetworkSubnet.new(&#39;10.0.0.1&#39;, {}, [&#39;foo-az&#39;]) }
      let(:existing_network) { DynamicNetwork.new(&#39;a&#39;, [subnet], logger) }
      let(:existing_reservation) { reservation = BD::DesiredNetworkReservation.new_dynamic(existing_instance, existing_network) }

      let(:network_plans) do
        [
          NetworkPlanner::Plan.new(reservation: existing_reservation, existing: true),
          NetworkPlanner::Plan.new(reservation: reservation),
        ]
      end

      before do
        instance_plan.existing_instance.update(spec: {
          &#39;vm_type&#39; =&gt; {&#39;name&#39; =&gt; &#39;old&#39;, &#39;cloud_properties&#39; =&gt; {&#39;a&#39; =&gt; &#39;b&#39;}}
        })
      end

      it &#39;should write the current spec to the database&#39; do
        instance_plan.persist_current_spec
        vm_type = instance_plan.existing_instance.reload.spec_p(&#39;vm_type&#39;)
        expect(vm_type).to eq({&#39;name&#39; =&gt; &#39;a&#39;, &#39;cloud_properties&#39; =&gt; {}})
      end
    end

    describe &#39;#recreation_requested?&#39; do
      describe &#39;when nothing changes&#39; do
        it &#39;should return false&#39; do
          expect(instance_plan.recreation_requested?).to eq(false)
        end
      end

      describe &#39;when deployment is being recreated&#39; do
        let(:instance_plan) { InstancePlan.new(existing_instance: existing_instance, desired_instance: desired_instance, instance: instance, network_plans: network_plans, recreate_deployment: true) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1115" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1162" class="js-smell-location">1</a>                  </div>  </li></ol>

        it &#39;should return changed&#39; do
          expect(instance_plan.recreation_requested?).to be_truthy
        end

        it &#39;should log the change reason&#39; do
          expect(logger).to receive(:debug).with(&#39;recreation_requested? job deployment is configured with &quot;recreate&quot; state&#39;)
          instance_plan.recreation_requested?
        end
      end

      context &#39;when instance is being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1127" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1135" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1143" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L1153" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:instance_state) { &#39;recreate&#39; }

        it &#39;should return true when desired instance is in &quot;recreate&quot; state&#39; do
          expect(instance_plan.recreation_requested?).to be_truthy
        end
      end

      context &#39;when instance is not being recreated&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1127" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1135" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1143" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L1153" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:instance_state) { &#39;stopped&#39; }

        it &#39;should return false when desired instance is in any another state&#39; do
          expect(instance_plan.recreation_requested?).to be_falsey
        end
      end

      context &#39;when instance has unresponsive agent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1127" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1135" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1143" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L1153" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:job_state) { &#39;unresponsive&#39; }

        it &#39;should return true&#39; do
          expect(instance_plan.recreation_requested?).to be_truthy
        end
      end
    end

    describe &#39;#unresponsive_agent?&#39; do
      context &#39;when instance has unresponsive agent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1127" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1135" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1143" class="js-smell-location">2</a>                  <a href="instance_plan_spec.html#L1153" class="js-smell-location">3</a>                  </div>  </li></ol>
        let(:job_state) { &#39;unresponsive&#39; }

        it &#39;should return true&#39; do
          expect(instance_plan.unresponsive_agent?).to be_truthy
        end
      end

      context &#39;when instance is ok&#39; do
        let(:instance_plan) { InstancePlan.new(existing_instance: existing_instance, desired_instance: desired_instance, instance: instance, network_plans: network_plans, recreate_deployment: true) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1115" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1162" class="js-smell-location">1</a>                  </div>  </li></ol>

        it &#39;should return false&#39; do
          expect(instance_plan.unresponsive_agent?).to be_falsey
        end
      end

      context &#39;when instance is nil&#39; do
        let(:instance_plan) { InstancePlan.new(existing_instance: existing_instance, desired_instance: desired_instance, instance: nil, network_plans: network_plans, recreate_deployment: true) }

        it &#39;should return false&#39; do
          expect(instance_plan.unresponsive_agent?).to be_falsey
        end
      end
    end

    describe &#39;#persistent_disk_changed?&#39; do
      let(:cloud_config_manifest) do
        cloud_config = Bosh::Spec::NewDeployments.simple_cloud_config
        cloud_config[&#39;disk_types&#39;] = [{
          &#39;name&#39; =&gt; &#39;disk_a&#39;,
          &#39;disk_size&#39; =&gt; 24,
          &#39;cloud_properties&#39; =&gt; {
            &#39;new&#39; =&gt; &#39;properties&#39;
          }
        }]
        cloud_config
      end

      let(:instance_group_spec) do
        instance_group_spec = Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups[&#39;instance_groups&#39;].first
        instance_group_spec[&#39;persistent_disk_pool&#39;] = &#39;disk_a&#39;
        instance_group_spec
      end

      context &#39;when there is a change&#39; do
        before do
          persistent_disk = BD::Models::PersistentDisk.make(size: 42, cloud_properties: {&#39;new&#39; =&gt; &#39;properties&#39;})
          instance_plan.instance.model.add_persistent_disk(persistent_disk)
        end

        it &#39;should return true&#39; do
          expect(instance_plan.persistent_disk_changed?).to be(true)
        end

        it &#39;should log&#39; do
          allow(logger).to receive(:debug)

          expect(logger).to receive(:debug).with(&#39;persistent_disk_changed? changed FROM: {:name=&gt;&quot;&quot;, :size=&gt;42, :cloud_properties=&gt;{&quot;new&quot;=&gt;&quot;properties&quot;}} TO: {:name=&gt;&quot;&quot;, :size=&gt;24, :cloud_properties=&gt;{&quot;new&quot;=&gt;&quot;properties&quot;}} on instance foobar/fake-uuid-1 (1)&#39;)

          instance_plan.persistent_disk_changed?
        end

        context &#39;variables interpolation&#39; do
          let(:desired_variable_set) { instance_double(BD::Models::VariableSet) }

          before do
            instance.desired_variable_set = desired_variable_set
          end

          it &#39;should create PersistentDiskCollection with the correct variable sets&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#persistent_disk_changed?)::context(when there is a change)::context(variables interpolation)::it#should create PersistentDiskCollection with the correct variable sets has a flog score of 30</span>          </div>  </li></ol>
            expect(BD::DeploymentPlan::PersistentDiskCollection).to receive(:changed_disk_pairs).with(
              anything,
              instance.model.variable_set,
              anything,
              desired_variable_set
            ).and_return([])

            instance_plan.persistent_disk_changed?
          end
        end
      end

      context &#39;when instance is obsolete&#39; do
        let(:obsolete_instance_plan) { InstancePlan.new(existing_instance: existing_instance, desired_instance: nil, instance: nil) }

        it &#39;should return true if instance had a persistent disk&#39; do
          persistent_disk = BD::Models::PersistentDisk.make(active: true, size: 2)
          obsolete_instance_plan.existing_instance.add_persistent_disk(persistent_disk)

          expect(obsolete_instance_plan.persistent_disk_changed?).to be_truthy
        end

        it &#39;should return false if instance had no persistent disk&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#persistent_disk_changed?)::context(when instance is obsolete)::it#should return false if instance had no persistent disk has a flog score of 25</span>          </div>  </li></ol>
          expect(obsolete_instance_plan.existing_instance.active_persistent_disks.any?).to eq(false)

          expect(obsolete_instance_plan.persistent_disk_changed?).to be_falsey
        end
      end
    end

    describe &#39;#network_settings_hash&#39; do
      let(:network_plans) { [NetworkPlanner::Plan.new(reservation: reservation)] }

      it &#39;generates network settings from the job and desired reservations&#39; do
        expect(instance_plan.network_settings_hash).to eq({
          &#39;a&#39; =&gt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L182" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L293" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1258" class="js-smell-location">2</a>                  </div>  </li></ol>
            &#39;type&#39; =&gt; &#39;manual&#39;,
            &#39;ip&#39; =&gt; &#39;192.168.1.3&#39;,
            &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
            &#39;cloud_properties&#39; =&gt; {},
            &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
            &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
            &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
          }
        }
        )
      end
    end

    describe &#39;#network_address&#39; do
      let(:network_plans) { [NetworkPlanner::Plan.new(reservation: reservation)] }
      let(:network_settings) { instance_double(Bosh::Director::DeploymentPlan::NetworkSettings) }

      context &#39;when use_short_dns_addresses is true&#39; do
        let(:use_short_dns_addresses) { true }

        it &#39;forwards that option to the settings&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#network_address)::context(when use_short_dns_addresses is true)::it#forwards that option to the settings has a flog score of 30</span>          </div>  </li></ol>
          expect(Bosh::Director::DeploymentPlan::NetworkSettings).to receive(:new).with(
            anything,
            anything,
            anything,
            anything,
            anything,
            anything,
            anything,
            anything,
            anything,
            true
          )

          instance_plan.network_settings
        end
      end

      before do
        allow(Bosh::Director::DeploymentPlan::NetworkSettings).to receive(:new).and_return(network_settings)
      end

      context &#39;when use_dns_addresses is FALSE&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1301" class="js-smell-location">0</a>                  <a href="../errand/lifecycle_errand_step_spec.html#L54" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:use_dns_addresses) { false }

        it &#39;calls it with correct value&#39; do
          expect(network_settings).to receive(:network_address).with(use_dns_addresses)
          instance_plan.network_address
        end
      end

      context &#39;when use_dns_addresses is TRUE&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1310" class="js-smell-location">0</a>                  <a href="../errand/lifecycle_errand_step_spec.html#L46" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:use_dns_addresses) { true }

        it &#39;calls it with correct value&#39; do
          expect(network_settings).to receive(:network_address).with(use_dns_addresses)
          instance_plan.network_address
        end
      end
    end

    describe &#39;#root_domain&#39; do
      it &#39;fetches root domain&#39; do
        expect(instance_plan.root_domain).to eq(&#39;bosh&#39;)
      end
    end

    describe &#39;#job_changed?&#39; do
      let(:network) { instance_double(&#39;Bosh::Director::DeploymentPlan::Network&#39;, name: &#39;fake-network&#39;) }

      context &#39;when an instance exists (with the same job name &amp; instance index)&#39; do
        let(:current_state) do
          { &#39;job&#39; =&gt; instance_group.spec }
        end

        context &#39;that fully matches the job spec&#39; do
          before { allow(instance).to receive(:current_job_spec).and_return(instance_group.spec) }

          it &#39;returns false&#39; do
            expect(instance_plan.job_changed?).to eq(false)
          end
        end

        context &#39;that does not match the job spec&#39; do
          before do
            instance_group.jobs = [job]
            allow(instance).to receive(:current_job_spec).and_return({})
          end
          let(:job) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#job_changed?)::context(when an instance exists (with the same job name & instance index))::context(that does not match the job spec)::let#job has a flog score of 27</span>          </div>  </li></ol>
            instance_double(&#39;Bosh::Director::DeploymentPlan::Job&#39;, {
              name: state[&#39;job&#39;][&#39;name&#39;],
              version: state[&#39;job&#39;][&#39;version&#39;],
              sha1: state[&#39;job&#39;][&#39;sha1&#39;],
              blobstore_id: state[&#39;job&#39;][&#39;blobstore_id&#39;],
              properties: {},
              logs: nil,
            })
          end
          let(:state) do
            {
              &#39;job&#39; =&gt; {
                &#39;name&#39; =&gt; &#39;hbase_slave&#39;,
                &#39;template&#39; =&gt; &#39;hbase_slave&#39;,
                &#39;version&#39; =&gt; &#39;0+dev.9&#39;,
                &#39;sha1&#39; =&gt; &#39;a8ab636b7c340f98891178096a44c09487194f03&#39;,
                &#39;blobstore_id&#39; =&gt; &#39;e2e4e58e-a40e-43ec-bac5-fc50457d5563&#39;
              }
            }
          end

          let(:current_state) do
            { &#39;job&#39; =&gt; instance_group.spec.merge(&#39;version&#39; =&gt; &#39;old-version&#39;) }
          end

          it &#39;returns true&#39; do
            expect(instance_plan.job_changed?).to eq(true)
          end

          it &#39;logs the change&#39; do
            expect(logger).to receive(:debug).with(/job_changed\? changed FROM: .* TO: .*/)
            instance_plan.job_changed?
          end
        end
      end
    end

    describe &#39;#packages_changed?&#39; do
      describe &#39;when packages have changed&#39; do
        let(:instance_model) do
          instance_model = BD::Models::Instance.make(
            bootstrap: true,
            deployment: deployment_model,
            uuid: &#39;uuid-1&#39;,
            variable_set: variable_set_model,
            spec: {&#39;vm_type&#39; =&gt; {
              &#39;name&#39; =&gt; &#39;original_vm_type_name&#39;,
              &#39;cloud_properties&#39; =&gt; {&#39;old&#39; =&gt; &#39;value&#39;}
            },
              &#39;packages&#39; =&gt; {&#39;changed&#39; =&gt; &#39;value&#39;},
              &#39;networks&#39; =&gt; network_settings,
              &#39;stemcell&#39; =&gt; {&#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;, &#39;version&#39; =&gt; &#39;1&#39;}}
          )
          instance_model
        end

        it &#39;should return true&#39; do
          expect(instance_plan.packages_changed?).to eq(true)
        end

        it &#39;should log changes&#39; do
          expect(logger).to receive(:debug).with(&#39;packages_changed? changed FROM: {&quot;changed&quot;=&gt;&quot;value&quot;} TO: {} on instance foobar/uuid-1 (1)&#39;)
          instance_plan.packages_changed?
        end
      end

      describe &#39;when packages have not changed&#39; do
        before { allow(instance).to receive(:current_packages).and_return({}) }

        it &#39;should return false&#39; do
          expect(instance_plan.packages_changed?).to eq(false)
        end
      end
    end

    describe &#39;#configuration_changed?&#39; do
      describe &#39;when the configuration has changed&#39; do
        let(:spec) do
          {&#39;configuration_hash&#39; =&gt; {&#39;old&#39; =&gt; &#39;config&#39;}}
        end

        it &#39;should return true&#39; do
          instance.configuration_hash = {&#39;changed&#39; =&gt; &#39;config&#39;}
          expect(instance_plan.configuration_changed?).to eq(true)
        end

        it &#39;should log the configuration changed reason&#39; do
          instance.configuration_hash = {&#39;changed&#39; =&gt; &#39;config&#39;}

          expect(logger).to receive(:debug).with(&quot;configuration_changed? changed FROM: {\&quot;old\&quot;=&gt;\&quot;config\&quot;} TO: {\&quot;changed\&quot;=&gt;\&quot;config\&quot;} on instance foobar/#{instance.model.uuid} (1)&quot;)
          instance_plan.configuration_changed?
        end
      end

      describe &#39;when the configuration has not changed&#39; do
        it &#39;should return false&#39; do
          expect(instance_plan.configuration_changed?).to eq(false)
        end
      end
    end

    describe &#39;#changes&#39; do
      context &#39;when the spec_json is nil&#39; do
        before do
          instance_plan.existing_instance.update(spec_json: nil)
        end

        it &#39;should report changes&#39; do
          expect(instance_plan.changes).to_not be_empty
        end
      end

      context &#39;when the spec_json is empty hash&#39; do
        before do
          instance_plan.existing_instance.update(spec_json: &#39;{}&#39;)
        end

        it &#39;should report changes&#39; do
          expect(instance_plan.changes).to_not be_empty
        end
      end
    end

    describe &#39;#should_be_ignored&#39; do
      context &#39;when the instance model has ignore flag as false, default&#39; do
        it &#39;should return true&#39; do
          expect(instance_plan.should_be_ignored?).to eq(false)
        end
      end

      context &#39;when the instance model has ignore flag as true&#39; do
        before do
          instance_plan.existing_instance.update(ignore: true)
        end

        it &#39;should return true&#39; do
          expect(instance_plan.should_be_ignored?).to eq(true)
        end
      end
    end

    context &#39;when there have been changes on the instance&#39; do
      describe &#39;#dns_changed?&#39; do
        let(:network_plans) { [NetworkPlanner::Plan.new(reservation: reservation)] }

        before do
          new_spec = spec
          new_spec[&#39;networks&#39;][&#39;a&#39;] = spec[&#39;networks&#39;][&#39;a&#39;].merge({&#39;ip&#39; =&gt; &#39;192.168.1.3&#39;})
          existing_instance.spec = new_spec
        end

        describe &#39;when the index dns record for the instance is not found&#39; do
          let(:changed_instance) { BD::Models::Instance.all.last }

          it &#39;#dns_changed? should return true&#39; do
            expect(instance_plan.dns_changed?).to be(true)
          end

          it &#39;should log the dns changes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1506" class="js-smell-location">0</a>                  <a href="../jobs/fetch_logs_spec.html#L145" class="js-smell-location">1</a>                  <a href="../problem_scanner/vm_scan_stage_spec.html#L312" class="js-smell-location">2</a>                  </div>  </li></ol>
            expect(logger).to receive(:debug).with(&quot;dns_changed? The requested dns record with name &#39;1.foobar.a.simple.bosh&#39; and ip &#39;192.168.1.3&#39; was not found in the db.&quot;)
            expect(logger).to receive(:debug).with(&quot;local_dns_changed? changed FROM: [] TO: [{:ip=&gt;\&quot;192.168.1.3\&quot;, :instance_id=&gt;4, :az=&gt;nil, :network=&gt;\&quot;a\&quot;, :deployment=&gt;\&quot;simple\&quot;, :instance_group=&gt;\&quot;instance-group-name\&quot;, :agent_id=&gt;\&quot;active-vm-agent-id\&quot;, :domain=&gt;\&quot;bosh\&quot;}] on instance foobar/fake-uuid-1 (1)&quot;)
            instance_plan.dns_changed?
          end
        end

        describe &#39;when the uuid and index dns record for the instance is found, but the local dns record has changed&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::context(when there have been changes on the instance)::describe(#dns_changed?)::describe#when the uuid and index dns record for the instance is found, but the local dns record has changed has a flog score of 27</span>          </div>  </li></ol>
          before do
            Bosh::Director::Models::LocalDnsRecord.make(instance_id: instance_model.id, ip: &#39;dummy-ip&#39;)
            BD::Models::Dns::Record.create(:name =&gt; &#39;1.foobar.a.simple.bosh&#39;, :type =&gt; &#39;A&#39;, :content =&gt; &#39;192.168.1.3&#39;)
            BD::Models::Dns::Record.create(:name =&gt; &#39;fake-uuid-1.foobar.a.simple.bosh&#39;, :type =&gt; &#39;A&#39;, :content =&gt; &#39;192.168.1.3&#39;)
            allow(BD::Config).to receive(:local_dns_enabled?).and_return(true)
            allow(logger).to receive(:debug)
          end

          it &#39;#dns_changed? should return true&#39; do
            expect(instance_plan.dns_changed?).to be(true)
          end

          it &#39;should log the dns changes&#39; do
            expect(logger).to receive(:debug).with(&quot;local_dns_changed? changed FROM: [{:ip=&gt;\&quot;dummy-ip\&quot;, :az=&gt;nil, :instance_group=&gt;nil, :network=&gt;nil, :deployment=&gt;nil, :instance_id=&gt;4, :agent_id=&gt;nil, :domain=&gt;nil}] TO: [{:ip=&gt;\&quot;192.168.1.3\&quot;, :instance_id=&gt;4, :az=&gt;nil, :network=&gt;\&quot;a\&quot;, :deployment=&gt;\&quot;simple\&quot;, :instance_group=&gt;\&quot;instance-group-name\&quot;, :agent_id=&gt;\&quot;active-vm-agent-id\&quot;, :domain=&gt;\&quot;bosh\&quot;}] on instance foobar/fake-uuid-1 (1)&quot;)
            instance_plan.dns_changed?
          end
        end

        describe &#39;when the id dns record for the instance is not found&#39; do
          let(:changed_instance) { BD::Models::Instance.all.last }

          before do
            Bosh::Director::Models::LocalDnsRecord.make(instance_id: instance_model.id, ip: &#39;192.168.1.3&#39;, deployment: &#39;simple&#39;, network: &#39;a&#39;, instance_group: &#39;instance-group-name&#39;, agent_id: &#39;active-vm-agent-id&#39;, domain: &#39;bosh&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1536" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1552" class="js-smell-location">1</a>                  </div>  </li></ol>
            BD::Models::Dns::Record.create(:name =&gt; &quot;#{changed_instance}.foobar.a.simple.bosh&quot;, :type =&gt; &#39;A&#39;, :content =&gt; &#39;192.168.1.3&#39;)
          end

          it &#39;#dns_changed? should return true&#39; do
            expect(instance_plan.dns_changed?).to be(true)
          end

          it &#39;should log the dns changes&#39; do
            expect(logger).to receive(:debug).with(&quot;dns_changed? The requested dns record with name &#39;1.foobar.a.simple.bosh&#39; and ip &#39;192.168.1.3&#39; was not found in the db.&quot;)
            instance_plan.dns_changed?
          end
        end

        describe &#39;when the dns records for the instance are found&#39; do
          before do
            Bosh::Director::Models::LocalDnsRecord.make(instance_id: instance_model.id, ip: &#39;192.168.1.3&#39;, deployment: &#39;simple&#39;, network: &#39;a&#39;, instance_group: &#39;instance-group-name&#39;, agent_id: &#39;active-vm-agent-id&#39;, domain: &#39;bosh&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1536" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1552" class="js-smell-location">1</a>                  </div>  </li></ol>
            BD::Models::Dns::Record.create(:name =&gt; &#39;1.foobar.a.simple.bosh&#39;, :type =&gt; &#39;A&#39;, :content =&gt; &#39;192.168.1.3&#39;)
            BD::Models::Dns::Record.create(:name =&gt; &quot;#{instance.uuid}.foobar.a.simple.bosh&quot;, :type =&gt; &#39;A&#39;, :content =&gt; &#39;192.168.1.3&#39;)
          end

          it &#39;#dns_changed? should return false&#39; do
            expect(instance_plan.dns_changed?).to be(false)
          end
        end
      end
    end

    describe &#39;#remove_network_plans_for_ips&#39; do
      let(:plan1) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1565" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1572" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1586" class="js-smell-location">2</a>                  </div>  </li></ol>
        reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, network)
        reservation.resolve_ip(&#39;192.168.1.25&#39;)

        NetworkPlanner::Plan.new(reservation: reservation, existing: false, obsolete: true)
      end

      let(:plan2) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1565" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1572" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1586" class="js-smell-location">2</a>                  </div>  </li></ol>
        reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, network)
        reservation.resolve_ip(&#39;192.168.1.26&#39;)

        NetworkPlanner::Plan.new(reservation: reservation, existing: false, obsolete: true)
      end

      let(:plan3) do
        reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, network)
        reservation.resolve_ip(&#39;192.168.1.4&#39;)

        NetworkPlanner::Plan.new(reservation: reservation, existing: true)
      end

      let(:plan4) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_plan_spec.html#L1565" class="js-smell-location">0</a>                  <a href="instance_plan_spec.html#L1572" class="js-smell-location">1</a>                  <a href="instance_plan_spec.html#L1586" class="js-smell-location">2</a>                  </div>  </li></ol>
        reservation = BD::DesiredNetworkReservation.new_dynamic(instance_model, network)
        reservation.resolve_ip(&#39;10.0.0.1&#39;)

        NetworkPlanner::Plan.new(reservation: reservation, existing: false, obsolete: true)
      end

      let(:network_plans) { [plan1, plan2, plan3, plan4] }

      let(:ip1) { NetAddr::CIDR.create(&#39;192.168.1.25&#39;).to_i }
      let(:ip2) { NetAddr::CIDR.create(&#39;192.168.1.26&#39;).to_i }

      let(:ip_address1) { Bosh::Director::Models::IpAddress.make(address_str: ip1.to_s) }
      let(:ip_address2) { Bosh::Director::Models::IpAddress.make(address_str: ip2.to_s) }

      describe &#39;when there are ips specified&#39; do
        it &#39;releases obsolete network plans of the specified ips&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#remove_network_plans_for_ips)::describe(when there are ips specified)::it#releases obsolete network plans of the specified ips has a flog score of 25</span>          </div>  </li></ol>
          instance_plan.remove_obsolete_network_plans_for_ips([ip_address1.address_str, ip_address2.address_str])
          expect(instance_plan.network_plans).to contain_exactly(plan3, plan4)
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
