<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> planner_factory_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">422</span><small> lines of codes</small></div>
              <div><span class="metric">3</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">330.5</span><small> complexity/method</small></div>
              <div><span class="metric">85</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">991.56</span><small> complexity</small></div>
              <div><span class="metric">122</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                25
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh
  module Director
    module DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
      describe PlannerFactory do
        subject { PlannerFactory.new(deployment_manifest_migrator, manifest_validator, deployment_repo, logger) }
        let(:deployment_repo) { DeploymentRepo.new }
        let(:deployment_name) { &#39;simple&#39; }
        let(:manifest_hash) { Bosh::Spec::Deployments.simple_manifest }
        let(:deployment_manifest_migrator) { instance_double(ManifestMigrator) }
        let(:manifest_validator) { Bosh::Director::DeploymentPlan::ManifestValidator.new }
        let(:cloud_configs) { [Models::Config.make(:cloud, content: YAML.dump(cloud_config_hash))] }
        let(:runtime_config_models) { [instance_double(Bosh::Director::Models::Config)] }
        let(:runtime_config_consolidator) { instance_double(Bosh::Director::RuntimeConfig::RuntimeConfigsConsolidator) }
        let(:cloud_config_hash) { Bosh::Spec::Deployments.simple_cloud_config }
        let(:runtime_config_hash) { Bosh::Spec::Deployments.simple_runtime_config }
        let(:manifest_with_config_keys) { Bosh::Spec::Deployments.simple_manifest.merge(&#39;name&#39; =&gt; &#39;with_keys&#39;) }
        let(:manifest) { Manifest.new(manifest_hash, YAML.dump(manifest_hash), cloud_config_hash, runtime_config_hash) }
        let(:plan_options) do
          {}
        end
        let(:event_log_io) { StringIO.new(&#39;&#39;) }
        let(:logger_io) { StringIO.new(&#39;&#39;) }
        let(:event_log) { Bosh::Director::EventLog::Log.new(event_log_io) }
        let(:logger) do
          logger = Logging::Logger.new(&#39;PlannerFactorySpecs&#39;)
          logger.add_appenders(
            Logging.appenders.io(
              &#39;PlannerFactorySpecs IO&#39;,
              logger_io,
              layout: Logging.layouts.pattern(pattern: &#39;%m\n&#39;)
            )
          )
          logger
        end

        before do
          allow(deployment_manifest_migrator).to receive(:migrate) { |deployment_manifest, cloud_config| [deployment_manifest, cloud_config] }
          allow(Bosh::Director::RuntimeConfig::RuntimeConfigsConsolidator).to receive(:new).with(runtime_config_models).and_return(runtime_config_consolidator)
          allow(runtime_config_consolidator).to receive(:interpolate_manifest_for_deployment).with(&#39;simple&#39;).and_return({})
          allow(runtime_config_consolidator).to receive(:tags).and_return({})
          allow(runtime_config_consolidator).to receive(:have_runtime_configs?).and_return(false)
          allow(runtime_config_consolidator).to receive(:runtime_configs)
          upload_releases
          upload_stemcell
          configure_config
          fake_locks
        end

        describe &#39;#create_from_manifest&#39; do
          let(:planner) do
            subject.create_from_manifest(manifest, cloud_configs, runtime_config_models, plan_options)
          end

          it &#39;returns a planner&#39; do
            expect(planner).to be_a(Planner)
            expect(planner.name).to eq(&#39;simple&#39;)
          end

          it &#39;migrates the deployment manifest to handle legacy structure&#39; do
            allow(deployment_manifest_migrator).to receive(:migrate) do |manifest, cloud_config|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L62" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L97" class="js-smell-location">1</a>                  </div>  </li></ol>
              manifest.manifest_hash[&#39;name&#39;] = &#39;migrated_name&#39;
              [manifest, cloud_config]
            end

            expect(planner.name).to eq(&#39;migrated_name&#39;)
          end

          it &#39;resolves aliases in manifest&#39; do
            manifest_hash[&#39;releases&#39;].first[&#39;version&#39;] = &#39;latest&#39;
            planner
            expect(manifest_hash[&#39;releases&#39;].first[&#39;version&#39;]).to eq(&#39;0.1-dev&#39;)
          end

          context &#39;plan_options&#39; do
            let(:plan_options) do
              { &#39;canaries&#39; =&gt; &#39;10%&#39;, &#39;max_in_flight&#39; =&gt; &#39;3&#39; }
            end
            it &#39;uses plan options&#39; do
              deployment = planner
              expect(deployment.update.canaries_before_calculation).to eq(&#39;10%&#39;)
              expect(deployment.update.max_in_flight_before_calculation).to eq(&#39;3&#39;)
            end

            context &#39;when option value is incorrect&#39; do
              let(:plan_options) do
                { &#39;canaries&#39; =&gt; &#39;wrong&#39; }
              end
              it &#39;raises an error&#39; do
                expect { planner }.to raise_error &#39;canaries value should be integer or percent&#39;
              end
            end
          end

          it &#39;logs the migrated manifests&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::it#logs the migrated manifests has a flog score of 33</span>          </div>  </li></ol>
            allow(deployment_manifest_migrator).to receive(:migrate) do |manifest, cloud_config|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L62" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L97" class="js-smell-location">1</a>                  </div>  </li></ol>
              manifest.manifest_hash[&#39;name&#39;] = &#39;migrated_name&#39;
              [manifest, cloud_config]
            end

            planner
            expected_deployment_manifest_log = &lt;&lt;~LOGMESSAGE
              Migrated deployment manifest:
              {&quot;name&quot;=&gt;&quot;migrated_name&quot;, &quot;director_uuid&quot;=&gt;&quot;deadbeef&quot;, &quot;releases&quot;=&gt;[{&quot;name&quot;=&gt;&quot;bosh-release&quot;, &quot;version&quot;=&gt;&quot;0.1-dev&quot;}], &quot;update&quot;=&gt;{&quot;canaries&quot;=&gt;2, &quot;canary_watch_time&quot;=&gt;4000, &quot;max_in_flight&quot;=&gt;1, &quot;update_watch_time&quot;=&gt;20}, &quot;jobs&quot;=&gt;[{&quot;name&quot;=&gt;&quot;foobar&quot;, &quot;templates&quot;=&gt;[{&quot;name&quot;=&gt;&quot;foobar&quot;}], &quot;resource_pool&quot;=&gt;&quot;a&quot;, &quot;instances&quot;=&gt;3, &quot;networks&quot;=&gt;[{&quot;name&quot;=&gt;&quot;a&quot;}], &quot;properties&quot;=&gt;{}}]}
LOGMESSAGE
            expected_cloud_manifest_log = &lt;&lt;~LOGMESSAGE
              Migrated cloud config manifest:
              {&quot;networks&quot;=&gt;[{&quot;name&quot;=&gt;&quot;a&quot;, &quot;subnets&quot;=&gt;[{&quot;range&quot;=&gt;&quot;192.168.1.0/24&quot;, &quot;gateway&quot;=&gt;&quot;192.168.1.1&quot;, &quot;dns&quot;=&gt;[&quot;192.168.1.1&quot;, &quot;192.168.1.2&quot;], &quot;static&quot;=&gt;[&quot;192.168.1.10&quot;], &quot;reserved&quot;=&gt;[], &quot;cloud_properties&quot;=&gt;{}}]}], &quot;compilation&quot;=&gt;{&quot;workers&quot;=&gt;1, &quot;network&quot;=&gt;&quot;a&quot;, &quot;cloud_properties&quot;=&gt;{}}, &quot;resource_pools&quot;=&gt;[{&quot;name&quot;=&gt;&quot;a&quot;, &quot;cloud_properties&quot;=&gt;{}, &quot;stemcell&quot;=&gt;{&quot;name&quot;=&gt;&quot;ubuntu-stemcell&quot;, &quot;version&quot;=&gt;&quot;1&quot;}, &quot;env&quot;=&gt;{&quot;bosh&quot;=&gt;{&quot;password&quot;=&gt;&quot;foobar&quot;}}}]}
LOGMESSAGE
            expect(logger_io.string).to include(expected_deployment_manifest_log)
            expect(logger_io.string).to include(expected_cloud_manifest_log)
          end

          it &#39;raises error when manifest has cloud_config properties&#39; do
            manifest_hash[&#39;vm_types&#39;] = &#39;foo&#39;
            expect do
              subject.create_from_manifest(manifest, cloud_configs, runtime_config_models, plan_options)
            end.to raise_error(Bosh::Director::DeploymentInvalidProperty)
          end

          context &#39;Planner.new&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::context#Planner.new has a flog score of 33</span>          </div>  </li></ol>
            let(:deployment_model) { Models::Deployment.make(name: &#39;simple&#39;) }
            let(:expected_attrs) do
              { name: &#39;simple&#39;, properties: {} }
            end
            let(:expected_plan_options) do
              {
                &#39;is_deploy_action&#39; =&gt; false,
                &#39;recreate&#39; =&gt; false,
                &#39;fix&#39; =&gt; false,
                &#39;skip_drain&#39; =&gt; nil,
                &#39;job_states&#39; =&gt; {},
                &#39;max_in_flight&#39; =&gt; nil,
                &#39;canaries&#39; =&gt; nil,
                &#39;tags&#39; =&gt; {},
              }
            end

            before do
              allow(deployment_repo).to receive(:find_or_create_by_name).with(deployment_name, plan_options).and_return(deployment_model)
              allow(runtime_config_consolidator).to receive(:runtime_configs).and_return(runtime_config_models)
            end

            it &#39;calls planner new with appropriate arguments&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::context(Planner.new)::it#calls planner new with appropriate arguments has a flog score of 30</span>          </div>  </li></ol>
              expect(Planner).to receive(:new).with(expected_attrs, manifest_hash,  YAML.dump(manifest_hash), cloud_configs, runtime_config_models, deployment_model, expected_plan_options).and_call_original
              planner
            end
          end

          describe &#39;attributes of the planner&#39; do
            it &#39;has a backing model&#39; do
              expect(planner.model.name).to eq(&#39;simple&#39;)
            end

            describe &#39;tags&#39; do
              before do
                allow(runtime_config_consolidator).to receive(:tags).and_return(&#39;runtime_tag&#39; =&gt; &#39;dryer&#39;)
              end

              it &#39;sets tag values from manifest and from runtime_config&#39; do
                manifest_hash[&#39;tags&#39;] = { &#39;deployment_tag&#39; =&gt; &#39;sears&#39; }
                runtime_config_hash[&#39;tags&#39;] = { &#39;runtime_tag&#39; =&gt; &#39;dryer&#39; }

                expect(planner.tags).to eq(&#39;deployment_tag&#39; =&gt; &#39;sears&#39;, &#39;runtime_tag&#39; =&gt; &#39;dryer&#39;)
              end

              it &#39;passes deployment name to get interpolated runtime_config tags&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::describe(attributes of the planner)::describe(tags)::it#passes deployment name to get interpolated runtime_config tags has a flog score of 25</span>          </div>  </li></ol>
                runtime_config_hash[&#39;tags&#39;] = { &#39;runtime_tag&#39; =&gt; &#39;((some_variable))&#39; }

                expect(runtime_config_consolidator).to receive(:tags).with(&#39;simple&#39;).and_return(&#39;runtime_tag&#39; =&gt; &#39;some_interpolated_value&#39;)
                expect(planner.tags).to eq(&#39;runtime_tag&#39; =&gt; &#39;some_interpolated_value&#39;)
              end

              it &#39;gives deployment manifest tags precedence over runtime_config tags&#39; do
                manifest_hash[&#39;tags&#39;] = { &#39;tag_key&#39; =&gt; &#39;sears&#39; }
                allow(runtime_config_consolidator).to receive(:tags).and_return(&#39;tag_key&#39; =&gt; &#39;dryer&#39;)

                expect(planner.tags).to eq(&#39;tag_key&#39; =&gt; &#39;sears&#39;)
              end
            end

            describe &#39;properties&#39; do
              it &#39;comes from the deployment_manifest&#39; do
                expected = {
                  &#39;foo&#39; =&gt; 1,
                  &#39;bar&#39; =&gt; { &#39;baz&#39; =&gt; 2 }
                }
                manifest_hash[&#39;properties&#39;] = expected
                expect(planner.properties).to eq(expected)
              end

              it &#39;has a sensible default&#39; do
                manifest_hash.delete(&#39;properties&#39;)
                expect(planner.properties).to eq({})
              end
            end

            describe &#39;releases&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::describe(attributes of the planner)::describe#releases has a flog score of 28</span>          </div>  </li></ol>
              let(:manifest_hash) do
                manifest_hash = Bosh::Spec::Deployments.simple_manifest.merge(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L201" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L283" class="js-smell-location">1</a>                  </div>  </li></ol>
                  &#39;releases&#39; =&gt; [
                    { &#39;name&#39; =&gt; &#39;bosh-release&#39;, &#39;version&#39; =&gt; 1 },
                    { &#39;name&#39; =&gt; &#39;bar-release&#39;, &#39;version&#39; =&gt; 2 }
                  ]
                )

                manifest_hash[&#39;jobs&#39;].first[&#39;release&#39;] = &#39;bosh-release&#39;
                manifest_hash
              end

              before do
                allow(runtime_config_consolidator).to receive(:have_runtime_configs?).and_return(true)
                allow(runtime_config_consolidator).to receive(:interpolate_manifest_for_deployment).with(&#39;simple&#39;).and_return(runtime_config_hash)
              end

              context &#39;and the runtime config does not have any applicable jobs&#39; do
                it &#39;has the releases from the deployment manifest&#39; do
                  expect(planner.releases.map { |r| [r.name, r.version] }).to match_array(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'r'</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L219" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L243" class="js-smell-location">1</a>                  </div>  </li></ol>
                    [
                      [&#39;bosh-release&#39;, &#39;1&#39;],
                      [&#39;bar-release&#39;, &#39;2&#39;],
                    ],
                  )
                end
              end

              context &#39;and the runtime config does has applicable jobs&#39; do
                let(:runtime_config_hash) do
                  Bosh::Spec::Deployments.simple_runtime_config.merge(
                    &#39;addons&#39; =&gt; [
                      {
                        &#39;name&#39; =&gt; &#39;first_addon&#39;,
                        &#39;jobs&#39; =&gt; [
                          { &#39;name&#39; =&gt; &#39;my_template&#39;, &#39;release&#39; =&gt; &#39;test_release_2&#39; },
                        ],
                      },
                    ],
                  )
                end

                it &#39;has the releases from the deployment manifest and relevant addon releases&#39; do
                  expect(planner.releases.map { |r| [r.name, r.version] }).to match_array(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'r'</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L219" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L243" class="js-smell-location">1</a>                  </div>  </li></ol>
                    [
                      %w[bosh-release 1],
                      %w[bar-release 2],
                      %w[test_release_2 2],
                    ],
                  )
                end
              end

              context &#39;with runtime variables&#39; do
                let(:runtime_config_hash) do
                  Bosh::Spec::Deployments.simple_runtime_config.merge(
                    &#39;variables&#39; =&gt; [{
                      &#39;name&#39; =&gt; &#39;/dns_healthcheck_server_tlsX&#39;,
                      &#39;type&#39; =&gt; &#39;certificate&#39;,
                      &#39;options&#39; =&gt; { &#39;is_ca&#39; =&gt; true, &#39;common_name&#39; =&gt; &#39;health.bosh-dns&#39;, &#39;extended_key_usage&#39; =&gt; [&#39;server_auth&#39;] }
                    },
                                    {
                                      &#39;name&#39; =&gt; &#39;/dns_healthcheck_tls&#39;,
                                      &#39;type&#39; =&gt; &#39;certificate&#39;,
                                      &#39;options&#39; =&gt; { &#39;ca&#39; =&gt; &#39;/dns_healthcheck_server_tlsX&#39; }

                                    },
                                    {
                                      &#39;name&#39; =&gt; &#39;/dns_healthcheck_password&#39;,
                                      &#39;type&#39; =&gt; &#39;password&#39;
                                    }]
                  )
                end
                it &#39;has variables from runtime config&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::describe(attributes of the planner)::describe(releases)::context(with runtime variables)::it#has variables from runtime config has a flog score of 73</span>          </div>  </li></ol>
                  expect(planner.variables.spec[0]).to eq(runtime_config_hash[&#39;variables&#39;][0])
                  expect(planner.variables.spec[1]).to eq(runtime_config_hash[&#39;variables&#39;][1])
                  expect(planner.variables.spec[2]).to eq(runtime_config_hash[&#39;variables&#39;][2])
                end
              end
            end

            describe &#39;disk_pools&#39; do
              let(:cloud_config_hash) do
                Bosh::Spec::Deployments.simple_cloud_config.merge(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L201" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L283" class="js-smell-location">1</a>                  </div>  </li></ol>
                  &#39;disk_pools&#39; =&gt; [
                    { &#39;name&#39; =&gt; &#39;disk_pool1&#39;, &#39;disk_size&#39; =&gt; 3000 },
                    { &#39;name&#39; =&gt; &#39;disk_pool2&#39;, &#39;disk_size&#39; =&gt; 1000 }
                  ]
                )
              end

              it &#39;has disk_pools from the cloud config manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::describe(attributes of the planner)::describe(disk_pools)::it#has disk_pools from the cloud config manifest has a flog score of 40</span>          </div>  </li></ol>
                expect(planner.disk_types.length).to eq(2)
                expect(planner.disk_type(&#39;disk_pool1&#39;).disk_size).to eq(3000)
                expect(planner.disk_type(&#39;disk_pool2&#39;).disk_size).to eq(1000)
              end
            end

            describe &#39;jobs&#39; do
              let(:cloud_config_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::describe(attributes of the planner)::describe(jobs)::let#cloud_config_hash has a flog score of 34</span>          </div>  </li></ol>
                hash = Bosh::Spec::Deployments.simple_cloud_config.merge(
                  &#39;azs&#39; =&gt; [
                    { &#39;name&#39; =&gt; &#39;zone1&#39;, &#39;cloud_properties&#39; =&gt; { foo: &#39;bar&#39; } },
                    { &#39;name&#39; =&gt; &#39;zone2&#39;, &#39;cloud_properties&#39; =&gt; { foo: &#39;baz&#39; } }
                  ]
                )
                hash[&#39;compilation&#39;][&#39;az&#39;] = &#39;zone1&#39;

                first_subnet = hash[&#39;networks&#39;][0][&#39;subnets&#39;]
                first_subnet &lt;&lt; Bosh::Spec::Deployments.subnet(
                  &#39;range&#39; =&gt; &#39;192.168.2.0/24&#39;,
                  &#39;gateway&#39; =&gt; &#39;192.168.2.1&#39;,
                  &#39;dns&#39; =&gt; [&#39;192.168.2.1&#39;, &#39;192.168.2.2&#39;],
                  &#39;static&#39; =&gt; [&#39;192.168.2.10&#39;],
                  &#39;reserved&#39; =&gt; [],
                  &#39;cloud_properties&#39; =&gt; {}
                )

                hash[&#39;networks&#39;].first[&#39;subnets&#39;][0][&#39;az&#39;] = &#39;zone1&#39;
                hash[&#39;networks&#39;].first[&#39;subnets&#39;][1][&#39;az&#39;] = &#39;zone2&#39;
                hash
              end

              let(:manifest_hash) do
                Bosh::Spec::Deployments.simple_manifest.merge(
                  &#39;jobs&#39; =&gt; [
                    Bosh::Spec::Deployments.simple_job.merge(&#39;azs&#39; =&gt; %w[zone1 zone2])
                  ]
                )
              end

              context &#39;when there is one job with two availability zones&#39; do
                it &#39;has azs as specified by users&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::describe(attributes of the planner)::describe(jobs)::context(when there is one job with two availability zones)::it#has azs as specified by users has a flog score of 60</span>          </div>  </li></ol>
                  expect(planner.instance_groups.length).to eq(1)
                  expect(planner.instance_groups.first.availability_zones.map(&amp;:name)).to eq(%w[zone1 zone2])
                  expect(planner.instance_groups.first.availability_zones.map(&amp;:cloud_properties)).to eq([{ foo: &#39;bar&#39; }, { foo: &#39;baz&#39; }])
                end
              end

              context &#39;when there are two jobs with two availability zones&#39; do
                let(:manifest_hash) do
                  Bosh::Spec::Deployments.simple_manifest.merge(
                    &#39;jobs&#39; =&gt; [
                      Bosh::Spec::Deployments.simple_job.merge(&#39;azs&#39; =&gt; [&#39;zone1&#39;]),
                      Bosh::Spec::Deployments.simple_job(name: &#39;bar&#39;).merge(&#39;azs&#39; =&gt; [&#39;zone2&#39;])
                    ]
                  )
                end
                it &#39;has azs as specified by users&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#create_from_manifest)::describe(attributes of the planner)::describe(jobs)::context(when there are two jobs with two availability zones)::it#has azs as specified by users has a flog score of 125</span>          </div>  </li></ol>
                  expect(planner.instance_groups.length).to eq(2)
                  expect(planner.instance_groups[0].availability_zones.map(&amp;:name)).to eq([&#39;zone1&#39;])
                  expect(planner.instance_groups[0].availability_zones.map(&amp;:cloud_properties)).to eq([{ foo: &#39;bar&#39; }])

                  expect(planner.instance_groups.length).to eq(2)
                  expect(planner.instance_groups[1].availability_zones.map(&amp;:name)).to eq([&#39;zone2&#39;])
                  expect(planner.instance_groups[1].availability_zones.map(&amp;:cloud_properties)).to eq([{ foo: &#39;baz&#39; }])
                end
              end
            end
          end

          context &#39;runtime config&#39; do
            before do
              allow(runtime_config_consolidator).to receive(:have_runtime_configs?).and_return(true)
            end

            it &quot;throws an error if the version of a release is &#39;latest&#39;&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L366" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L377" class="js-smell-location">1</a>                  </div>  </li></ol>
              invalid_manifest = Bosh::Spec::Deployments.runtime_config_latest_release
              allow(runtime_config_consolidator).to receive(:interpolate_manifest_for_deployment).with(String).and_return(invalid_manifest)

              expect do
                planner
              end.to raise_error Bosh::Director::RuntimeInvalidReleaseVersion,
                                 &quot;Runtime manifest contains the release &#39;bosh-release&#39; with version as &#39;latest&#39;. &quot; \
                                 &#39;Please specify the actual version string.&#39;
            end

            it &#39;throws an error if the release used by an addon is not listed in the releases section&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L366" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L377" class="js-smell-location">1</a>                  </div>  </li></ol>
              invalid_manifest = Bosh::Spec::Deployments.runtime_config_release_missing
              allow(runtime_config_consolidator).to receive(:interpolate_manifest_for_deployment).with(String).and_return(invalid_manifest)

              expect do
                planner
              end.to raise_error Bosh::Director::AddonReleaseNotListedInReleases,
                                 &quot;Manifest specifies job &#39;job_using_pkg_2&#39; which is defined in &#39;release2&#39;, &quot; \
                                 &quot;but &#39;release2&#39; is not listed in the runtime releases section.&quot;
            end
          end
        end

        def configure_config
          allow(Config).to receive(:dns).and_return(&#39;address&#39; =&gt; &#39;foo&#39;)
          Bosh::Director::Config.current_job = Bosh::Director::Jobs::BaseJob.new
          Bosh::Director::Config.current_job.task_id = &#39;fake-task-id&#39;
        end

        def upload_releases<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases has a flog score of 43</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases has approx 13 statements</span>          </div>  </li></ol>
          manifest_hash[&#39;releases&#39;].each do |release_entry|
            job = manifest_hash[&#39;jobs&#39;].first
            release = Models::Release.make(name: release_entry[&#39;name&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'Models::Release.make(name: release_entry['name'])' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'release_entry['name']' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases refers to 'release_entry' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">1</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">2</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">3</a>                  </div>  </li></ol>
            template = Models::Template.make(name: job[&#39;templates&#39;].first[&#39;name&#39;], release: release)
            template2 = Models::Template.make(name: &#39;provides_job&#39;, release: release, spec: { properties: { &#39;a&#39; =&gt; { default: &#39;b&#39; } } })<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases has the variable name 'template2'</span>          </div>  </li></ol>
            release_version = Models::ReleaseVersion.make(release: release, version: release_entry[&#39;version&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'Models::ReleaseVersion.make(release: release, version: release_entry['version'])' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'release_entry['version']' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases refers to 'release_entry' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">1</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">2</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">3</a>                  </div>  </li></ol>
            release_version.add_template(template)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'release_version.add_template(template)' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L403" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L411" class="js-smell-location">1</a>                  </div>  </li></ol>
            release_version.add_template(template2)
          end

          runtime_config_hash[&#39;releases&#39;].each do |release_entry|
            release = Models::Release.make(name: release_entry[&#39;name&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'Models::Release.make(name: release_entry['name'])' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'release_entry['name']' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases refers to 'release_entry' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">1</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">2</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">3</a>                  </div>  </li></ol>
            template = Models::Template.make(name: &#39;my_template&#39;, release: release)
            release_version = Models::ReleaseVersion.make(release: release, version: release_entry[&#39;version&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'Models::ReleaseVersion.make(release: release, version: release_entry['version'])' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'release_entry['version']' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases refers to 'release_entry' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L399" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L402" class="js-smell-location">1</a>                  <a href="planner_factory_spec.html#L408" class="js-smell-location">2</a>                  <a href="planner_factory_spec.html#L410" class="js-smell-location">3</a>                  </div>  </li></ol>
            release_version.add_template(template)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_releases calls 'release_version.add_template(template)' 2 times</span>              <span>Locations:</span>                  <a href="planner_factory_spec.html#L403" class="js-smell-location">0</a>                  <a href="planner_factory_spec.html#L411" class="js-smell-location">1</a>                  </div>  </li></ol>
          end
        end

        def upload_stemcell
          stemcell_entry = cloud_config_hash[&#39;resource_pools&#39;].first[&#39;stemcell&#39;]
          Models::Stemcell.make(name: stemcell_entry[&#39;name&#39;], version: stemcell_entry[&#39;version&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#upload_stemcell refers to 'stemcell_entry' more than self (maybe move it to another class?)</span>          </div>  </li></ol>
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
