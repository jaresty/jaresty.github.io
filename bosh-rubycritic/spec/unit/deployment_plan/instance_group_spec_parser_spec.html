<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/deployment_plan /</small> instance_group_spec_parser_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">1826</span><small> lines of codes</small></div>
              <div><span class="metric">2</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1700.6</span><small> complexity/method</small></div>
              <div><span class="metric">109</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">3401.28</span><small> complexity</small></div>
              <div><span class="metric">803</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                64
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;

module Bosh::Director
  module DeploymentPlan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has no descriptive comment</span>          </div>  </li></ol>
    describe InstanceGroupSpecParser do
      subject(:parser) { described_class.new(deployment_plan, event_log, logger) }

      let(:deployment_plan) do
        instance_double(
          Planner,
          model: deployment_model,
          properties: {},
          update: UpdateConfig.new(
            &#39;canaries&#39; =&gt; 2,
            &#39;max_in_flight&#39; =&gt; 4,
            &#39;canary_watch_time&#39; =&gt; 60_000,
            &#39;update_watch_time&#39; =&gt; 30_000,
            &#39;serial&#39; =&gt; true,
          ),
          name: &#39;fake-deployment&#39;,
          networks: [network],
          releases: {},
        )
      end
      let(:deployment_model) { Models::Deployment.make }
      let(:network) { ManualNetwork.new(&#39;fake-network-name&#39;, [], logger) }
      let(:task) { Models::Task.make(id: 42) }
      let(:task_writer) { Bosh::Director::TaskDBWriter.new(:event_output, task.id) }
      let(:event_log) { Bosh::Director::EventLog::Log.new(task_writer) }

      let(:disk_collection) { PersistentDiskCollection.new(logger) }

      let(:links_parser) do
        instance_double(Bosh::Director::Links::LinksParser).tap do |mock|
          allow(mock).to receive(:parse_consumers_from_job)
          allow(mock).to receive(:parse_providers_from_job)
          allow(mock).to receive(:parse_provider_from_disk)
        end
      end

      before do
        allow(Bosh::Director::Links::LinksParser).to receive(:new).and_return(links_parser)
      end

      describe &#39;#parse&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe##parse has a flog score of 76</span>          </div>  </li></ol>
        before do
          allow(deployment_plan).to receive(:resource_pool).and_return(resource_pool)
          allow(resource_pool).to receive(:name).and_return(&#39;fake-vm-type&#39;)
          allow(resource_pool).to receive(:cloud_properties).and_return({})
          allow(resource_pool).to receive(:stemcell).and_return(
            Stemcell.parse(
              &#39;name&#39; =&gt; &#39;fake-stemcell-name&#39;,
              &#39;version&#39; =&gt; 1,
            ),
          )
          allow(deployment_plan).to receive(:disk_type).and_return(disk_type)
          allow(deployment_plan).to receive(:release).and_return(job_rel_ver)
          allow(PersistentDiskCollection).to receive(:new).and_return(disk_collection)
        end
        let(:parse_options) do
          { &#39;is_deploy_action&#39; =&gt; true }
        end
        let(:parsed_instance_group) { parser.parse(instance_group_spec, parse_options) }
        let(:resource_pool_env) do
          { &#39;key&#39; =&gt; &#39;value&#39; }
        end
        let(:uninterpolated_resource_pool_env) do
          { &#39;key&#39; =&gt; &#39;((value_placeholder))&#39; }
        end
        let(:resource_pool) do
          instance_double(ResourcePool, env: resource_pool_env)
        end
        let(:disk_type) { instance_double(DiskType) }
        let(:job_rel_ver) { instance_double(ReleaseVersion, template: nil) }

        let(:instance_group_spec) do
          {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L77" class="js-smell-location">0</a>                  <a href="stages/update_active_vm_cpis_stage_spec.html#L57" class="js-smell-location">1</a>                  </div>  </li></ol>
            &#39;name&#39; =&gt; &#39;instance-group-name&#39;,
            &#39;jobs&#39; =&gt; [],
            &#39;release&#39; =&gt; &#39;fake-release-name&#39;,
            &#39;resource_pool&#39; =&gt; &#39;fake-resource-pool-name&#39;,
            &#39;instances&#39; =&gt; 1,
            &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
          }
        end

        it &#39;sets deployment name to instance group&#39; do
          instance_group = parsed_instance_group
          expect(instance_group.deployment_name).to eq(&#39;fake-deployment&#39;)
        end

        describe &#39;name key&#39; do
          it &#39;parses name&#39; do
            instance_group = parsed_instance_group
            expect(instance_group.name).to eq(&#39;instance-group-name&#39;)
          end
        end

        describe &#39;lifecycle key&#39; do
          InstanceGroup::VALID_LIFECYCLE_PROFILES.each do |profile|
            it &quot;is able to parse &#39;#{profile}&#39; as lifecycle profile&quot; do
              instance_group_spec[&#39;lifecycle&#39;] = profile
              instance_group = parsed_instance_group
              expect(instance_group.lifecycle).to eq(profile)
            end
          end

          it &quot;defaults lifecycle profile to &#39;service&#39;&quot; do
            instance_group_spec.delete(&#39;lifecycle&#39;)
            instance_group = parsed_instance_group
            expect(instance_group.lifecycle).to eq(&#39;service&#39;)
          end

          it &#39;raises an error if lifecycle profile value is not known&#39; do
            instance_group_spec[&#39;lifecycle&#39;] = &#39;unknown&#39;

            expect do
              parsed_instance_group
            end.to raise_error(
              JobInvalidLifecycle,
              &quot;Invalid lifecycle &#39;unknown&#39; for &#39;instance-group-name&#39;, valid lifecycle profiles are: service, errand&quot;,
            )
          end
        end

        describe &#39;release key&#39; do
          it &#39;parses release&#39; do
            instance_group = parsed_instance_group
            expect(instance_group.release).to eq(job_rel_ver)
          end

          it &#39;complains about unknown release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L132" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L506" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1015" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L1042" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L1212" class="js-smell-location">4</a>                  </div>  </li></ol>
            instance_group_spec[&#39;release&#39;] = &#39;unknown-release-name&#39;
            expect(deployment_plan).to receive(:release)
              .with(&#39;unknown-release-name&#39;)
              .and_return(nil)

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupUnknownRelease,
              &quot;Instance group &#39;instance-group-name&#39; references an unknown release &#39;unknown-release-name&#39;&quot;,
            )
          end

          context &#39;when there is no job-level release defined&#39; do
            before { instance_group_spec.delete(&#39;release&#39;) }

            context &#39;when the deployment has zero releases&#39;

            context &#39;when the deployment has exactly one release&#39; do
              it &quot;picks the deployment&#39;s release&quot; do
                deployment_release = instance_double(ReleaseVersion, name: &#39;&#39;)
                allow(deployment_plan).to receive(:releases).and_return([deployment_release])

                instance_group = parsed_instance_group
                expect(instance_group.release).to eq(deployment_release)
              end
            end

            context &#39;when the deployment has more than one release&#39; do
              it &#39;does not pick a release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(release key)::context(when there is no job-level release defined)::context(when the deployment has more than one release)::it#does not pick a release has a flog score of 28</span>          </div>  </li></ol>
                instance_group_spec.delete(&#39;release&#39;)

                allow(deployment_plan).to receive(:releases).and_return([instance_double(ReleaseVersion, name: &#39;&#39;), instance_double(ReleaseVersion, name: &#39;&#39;)])

                instance_group = parsed_instance_group
                expect(instance_group.release).to be_nil
              end
            end
          end
        end

        describe &#39;job key&#39; do
          before { instance_group_spec.delete(&#39;jobs&#39;) }

          it &#39;parses a single job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(job key)::it#parses a single job has a flog score of 48</span>          </div>  </li></ol>
            instance_group_spec[&#39;template&#39;] = &#39;job-name&#39;

            expect(deployment_plan).to receive(:release)
              .with(&#39;fake-release-name&#39;)
              .and_return(job_rel_ver)

            job = make_job(&#39;job-name&#39;, job_rel_ver)
            expect(job).to receive(:add_properties)
              .with({}, &#39;instance-group-name&#39;)
            expect(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;job-name&#39;)
              .and_return(job)

            instance_group = parsed_instance_group
            expect(instance_group.jobs).to eq([job])
          end

          it &#39;does not issue a deprecation warning when Template has a single value&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(job key)::it#does not issue a deprecation warning when Template has a single value has a flog score of 45</span>          </div>  </li></ol>
            instance_group_spec[&#39;template&#39;] = &#39;fake-template-name&#39;

            allow(deployment_plan).to receive(:release)
              .with(&#39;fake-release-name&#39;)
              .and_return(job_rel_ver)

            job1 = make_job(&#39;fake-template-name&#39;, job_rel_ver)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job1'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L202" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L220" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L245" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L304" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L586" class="js-smell-location">4</a>                  </div>  </li></ol>
            allow(job1).to receive(:add_properties)

            allow(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;fake-template-name&#39;)
              .and_return(job1)

            expect(Config.event_log).not_to receive(:warn_deprecated)
            parsed_instance_group
          end

          it &#39;parses multiple templates&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(job key)::it#parses multiple templates has a flog score of 70</span>          </div>  </li></ol>
            instance_group_spec[&#39;template&#39;] = %w[fake-template1-name fake-template2-name]

            expect(deployment_plan).to receive(:release)
              .with(&#39;fake-release-name&#39;)
              .and_return(job_rel_ver)

            job1 = make_job(&#39;fake-template1-name&#39;, job_rel_ver)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job1'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L202" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L220" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L245" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L304" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L586" class="js-smell-location">4</a>                  </div>  </li></ol>
            expect(job1).to receive(:add_properties)
              .with({}, &#39;instance-group-name&#39;)
            expect(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;fake-template1-name&#39;)
              .and_return(job1)

            job2 = make_job(&#39;fake-template2-name&#39;, job_rel_ver)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job2'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L227" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L252" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L315" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L599" class="js-smell-location">3</a>                  </div>  </li></ol>
            expect(job2).to receive(:add_properties)
              .with({}, &#39;instance-group-name&#39;)
            expect(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;fake-template2-name&#39;)
              .and_return(job2)

            instance_group = parsed_instance_group
            expect(instance_group.jobs).to eq([job1, job2])
          end

          it &#39;issues a deprecation warning when Template has an array value&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(job key)::it#issues a deprecation warning when Template has an array value has a flog score of 67</span>          </div>  </li></ol>
            instance_group_spec[&#39;template&#39;] = %w[fake-template1-name fake-template2-name]

            allow(deployment_plan).to receive(:release)
              .with(&#39;fake-release-name&#39;)
              .and_return(job_rel_ver)

            job1 = make_job(&#39;fake-template1-name&#39;, job_rel_ver)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job1'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L202" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L220" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L245" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L304" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L586" class="js-smell-location">4</a>                  </div>  </li></ol>
            allow(job1).to receive(:add_properties)

            allow(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;fake-template1-name&#39;)
              .and_return(job1)

            job2 = make_job(&#39;fake-template2-name&#39;, job_rel_ver)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job2'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L227" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L252" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L315" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L599" class="js-smell-location">3</a>                  </div>  </li></ol>
            allow(job2).to receive(:add_properties)

            allow(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;fake-template2-name&#39;)
              .and_return(job2)

            expect(event_log).to receive(:warn_deprecated).with(
              &quot;Please use &#39;templates&#39; when specifying multiple templates for a job. &quot;\
                &quot;&#39;template&#39; for multiple templates will soon be unsupported.&quot;,
            )
            parsed_instance_group
          end

          it &#39;raises an error when a job has no release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(job key)::it#raises an error when a job has no release has a flog score of 29</span>          </div>  </li></ol>
            instance_group_spec[&#39;template&#39;] = &#39;fake-template-name&#39;
            instance_group_spec.delete(&#39;release&#39;)

            fake_releases = 2.times.map do
              instance_double(
                ReleaseVersion,
                template: nil,
              )
            end
            expect(deployment_plan).to receive(:releases).and_return(fake_releases)

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupMissingRelease,
              &quot;Cannot tell what release job &#39;instance-group-name&#39; is supposed to use, please explicitly specify one&quot;,
            )
          end

          it &#39;adds merged global &amp; instance group properties to template(s)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(job key)::it(adds merged global & instance group properties to template(s))#adds merged global & instance group properties to template(s) has a flog score of 80</span>          </div>  </li></ol>
            allow(deployment_plan).to receive(:properties)
              .and_return(
                &#39;property_1&#39; =&gt; &#39;woof&#39;,
                &#39;deployment_plan_property_1&#39; =&gt; &#39;smurf&#39;,
              )

            instance_group_spec[&#39;template&#39;] = %w[fake-template1-name fake-template2-name]

            instance_group_spec[&#39;properties&#39;] = {
              &#39;instance_group_property_1&#39; =&gt; &#39;moop&#39;,
              &#39;property_1&#39; =&gt; &#39;meow&#39;,
            }

            expect(deployment_plan).to receive(:release)
              .with(&#39;fake-release-name&#39;)
              .and_return(job_rel_ver)

            job1 = make_job(&#39;fake-template1-name&#39;, job_rel_ver)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job1'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L202" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L220" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L245" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L304" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L586" class="js-smell-location">4</a>                  </div>  </li></ol>
            expect(job1).to receive(:add_properties)
              .with({
                &#39;instance_group_property_1&#39; =&gt; &#39;moop&#39;,
                &#39;property_1&#39; =&gt; &#39;meow&#39;,
                &#39;deployment_plan_property_1&#39; =&gt; &#39;smurf&#39;,
              }, &#39;instance-group-name&#39;)
            allow(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;fake-template1-name&#39;)
              .and_return(job1)

            job2 = make_job(&#39;fake-template2-name&#39;, job_rel_ver)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job2'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L227" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L252" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L315" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L599" class="js-smell-location">3</a>                  </div>  </li></ol>
            expect(job2).to receive(:add_properties)
              .with({
                &#39;instance_group_property_1&#39; =&gt; &#39;moop&#39;,
                &#39;property_1&#39; =&gt; &#39;meow&#39;,
                &#39;deployment_plan_property_1&#39; =&gt; &#39;smurf&#39;,
              }, &#39;instance-group-name&#39;)
            allow(job_rel_ver).to receive(:get_or_create_template)
              .with(&#39;fake-template2-name&#39;)
              .and_return(job2)

            instance_group = parsed_instance_group
            expect(instance_group.jobs).to eq([job1, job2])
          end
        end

        shared_examples_for &#39;templates/jobs key&#39; do
          before { instance_group_spec.delete(&#39;jobs&#39;) }

          # TODO LINKS: Add tests to ensure links_manager&#39;s methods get invoked.
          context &#39;when value is an array of hashes&#39; do
            context &#39;when one of the hashes specifies a release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context#when one of the hashes specifies a release has a flog score of 27</span>          </div>  </li></ol>
              before do
                instance_group_spec[keyword] = [{
                  &#39;name&#39; =&gt; &#39;job-name&#39;,
                  &#39;release&#39; =&gt; &#39;fake-release&#39;,
                  &#39;consumes&#39; =&gt; { &#39;a&#39; =&gt; { &#39;from&#39; =&gt; &#39;link_name&#39; } },
                }]
                release_model_1 = Models::Release.make(name: &#39;fake-release-1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'release_model_1'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L343" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L565" class="js-smell-location">1</a>                  </div>  </li></ol>
                version = Models::ReleaseVersion.make(version: &#39;1.0.0&#39;)
                release_model_1.add_version(version)

                release_model_2 = Models::Release.make(name: &#39;fake-release-2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'release_model_2'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L347" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L569" class="js-smell-location">1</a>                  </div>  </li></ol>
                fake_release_version_model = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model_2)
                fake_release_version_model.add_template(Models::Template.make(
                  name: &#39;job-name&#39;,
                  release: release_model_2,
                  spec: {consumes: [{&#39;name&#39; =&gt; &quot;a&quot;, &#39;type&#39; =&gt; &quot;db&quot;}]}
                ))

                deployment_model = Models::Deployment.make(name: &#39;deployment&#39;)
                version.add_deployment(deployment_model)
              end

              let(:rel_ver) { instance_double(ReleaseVersion, name: &#39;fake-release-2&#39;, version: &#39;1&#39;) }

              context &#39;when job specifies a release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when one of the hashes specifies a release)::context#when job specifies a release has a flog score of 47</span>          </div>  </li></ol>
                let(:job) { make_job(&#39;job-name&#39;, rel_ver) }

                before do
                  instance_group_spec[&#39;release&#39;] = &#39;fake-release&#39;
                  allow(deployment_plan).to receive(:release)
                    .with(&#39;fake-release&#39;)
                    .and_return(rel_ver)

                  allow(rel_ver).to receive(:get_or_create_template)
                    .with(&#39;job-name&#39;)
                    .and_return(job)
                  allow(job).to receive(:add_properties)
                end

                it &#39;sets job template from release specified in a hash&#39; do
                  instance_group = parsed_instance_group
                  expect(instance_group.jobs).to eq([job])
                end
              end

              context &#39;when job does not specify a release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when one of the hashes specifies a release)::context#when job does not specify a release has a flog score of 90</span>          </div>  </li></ol>
                let(:deployment_rel_ver) { instance_double(ReleaseVersion, name: &#39;&#39;) }
                let(:job) { make_job(&#39;job-name&#39;, nil) }

                let(:provides_job) { instance_double(Job, name: &#39;z&#39;) }
                let(:provides_instance_group) { instance_double(InstanceGroup, name: &#39;y&#39;) }

                before do
                  instance_group_spec.delete(&#39;release&#39;)
                  allow(deployment_plan).to receive(:releases).and_return([deployment_rel_ver])
                  allow(deployment_plan).to receive(:release)
                    .with(&#39;fake-release&#39;)
                    .and_return(rel_ver)

                  allow(provides_instance_group).to receive(:jobs).and_return([provides_job])
                  allow(deployment_plan).to receive(:instance_groups).and_return([provides_instance_group])

                  allow(rel_ver).to receive(:get_or_create_template)
                    .with(&#39;job-name&#39;)
                    .and_return(job)
                  allow(job).to receive(:add_properties)
                end

                it &#39;sets job template from release specified in a hash&#39; do
                  instance_group = parsed_instance_group
                  expect(instance_group.jobs).to eq([job])
                end
              end
            end

            context &#39;when one of the hashes does not specify a release&#39; do
              let(:job_rel_ver) do
                instance_double(
                  ReleaseVersion,
                  name: &#39;fake-template-release&#39;,
                  version: &#39;1&#39;,
                  template: nil,
                )
              end

              before do
                instance_group_spec[keyword] = [{ &#39;name&#39; =&gt; &#39;job-name&#39;, &#39;links&#39; =&gt; { &#39;db&#39; =&gt; &#39;a.b.c&#39; } }]
                release_model = Models::Release.make(name: &#39;fake-template-release&#39;)
                release_version_model = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model)
                release_version_model.add_template(Models::Template.make(name: &#39;job-name&#39;, release: release_model))
              end

              context &#39;when job specifies a release&#39; do
                before { instance_group_spec[&#39;release&#39;] = &#39;fake-job-release&#39; }

                it &#39;sets job template from job release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when one of the hashes does not specify a release)::context(when job specifies a release)::it#sets job template from job release has a flog score of 49</span>          </div>  </li></ol>
                  allow(deployment_plan).to receive(:release)
                    .with(&#39;fake-job-release&#39;)
                    .and_return(job_rel_ver)

                  job = make_job(&#39;job-name&#39;, nil)
                  allow(job).to receive(:add_properties)
                  expect(job_rel_ver).to receive(:get_or_create_template)
                    .with(&#39;job-name&#39;)
                    .and_return(job)

                  instance_group = parsed_instance_group
                  expect(instance_group.jobs).to eq([job])
                end
              end

              context &#39;when job does not specify a release&#39; do
                before { instance_group_spec.delete(&#39;release&#39;) }

                context &#39;when deployment has multiple releases&#39; do
                  before { allow(deployment_plan).to receive(:releases).and_return([deployment_rel_ver, deployment_rel_ver]) }
                  let(:deployment_rel_ver) { instance_double(ReleaseVersion, name: &#39;&#39;) }

                  it &#39;raises an error because there is not default release specified&#39; do
                    expect do
                      parsed_instance_group
                    end.to raise_error(
                      InstanceGroupMissingRelease,
                      &quot;Cannot tell what release template &#39;job-name&#39; (instance group &#39;instance-group-name&#39;) is supposed to use, please explicitly specify one&quot;,
                    )
                  end
                end

                context &#39;when deployment has a single release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when one of the hashes does not specify a release)::context(when job does not specify a release)::context#when deployment has a single release has a flog score of 27</span>          </div>  </li></ol>
                  let(:deployment_rel_ver) { instance_double(ReleaseVersion, name: &#39;fake-template-release&#39;, version: &#39;1&#39;) }
                  let(:job) { make_job(&#39;job-name&#39;, nil) }
                  before do
                    allow(deployment_plan).to receive(:releases).and_return([deployment_rel_ver])
                    allow(job).to receive(:add_properties)
                  end

                  it &#39;sets job template from deployment release because first release assumed as default&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when one of the hashes does not specify a release)::context(when job does not specify a release)::context(when deployment has a single release)::it#sets job template from deployment release because first release assumed as default has a flog score of 31</span>          </div>  </li></ol>
                    expect(deployment_rel_ver).to receive(:get_or_create_template)
                      .with(&#39;job-name&#39;)
                      .and_return(job)

                    instance_group = parsed_instance_group
                    expect(instance_group.jobs).to eq([job])
                  end
                end

                context &#39;when deployment has 0 releases&#39; do
                  before { allow(deployment_plan).to receive(:releases).and_return([]) }

                  it &#39;raises an error because there is not default release specified&#39; do
                    expect do
                      parsed_instance_group
                    end.to raise_error(
                      InstanceGroupMissingRelease,
                      &quot;Cannot tell what release template &#39;job-name&#39; (instance group &#39;instance-group-name&#39;) is supposed to use, please explicitly specify one&quot;,
                    )
                  end
                end
              end
            end

            context &#39;when one of the hashes specifies a release not specified in a deployment&#39; do
              before do
                instance_group_spec[keyword] = [{
                  &#39;name&#39; =&gt; &#39;job-name&#39;,
                  &#39;release&#39; =&gt; &#39;fake-release&#39;,
                }]
              end

              it &#39;raises an error because all referenced releases need to be specified under releases&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L132" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L506" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1015" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L1042" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L1212" class="js-smell-location">4</a>                  </div>  </li></ol>
                instance_group_spec[&#39;name&#39;] = &#39;instance-group-name&#39;

                expect(deployment_plan).to receive(:release)
                  .with(&#39;fake-release&#39;)
                  .and_return(nil)

                expect do
                  parsed_instance_group
                end.to raise_error(
                  InstanceGroupUnknownRelease,
                  &quot;Job &#39;job-name&#39; (instance group &#39;instance-group-name&#39;) references an unknown release &#39;fake-release&#39;&quot;,
                )
              end
            end

            context &#39;when multiple hashes have the same name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context#when multiple hashes have the same name has a flog score of 58</span>          </div>  </li></ol>
              before do
                instance_group_spec[keyword] = [
                  { &#39;name&#39; =&gt; &#39;job-name1&#39; },
                  { &#39;name&#39; =&gt; &#39;job-name2&#39; },
                  { &#39;name&#39; =&gt; &#39;job-name1&#39; },
                ]
              end

              before do # resolve release and template objs
                instance_group_spec[&#39;release&#39;] = &#39;fake-job-release&#39;

                release_model = Models::Release.make(name: &#39;fake-release&#39;)
                release_version_model = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model)
                release_version_model.add_template(Models::Template.make(name: &#39;job-name1&#39;, release: release_model))
                release_version_model.add_template(Models::Template.make(name: &#39;job-name2&#39;, release: release_model))
                release_version_model.add_template(Models::Template.make(name: &#39;job-name3&#39;, release: release_model))

                job_rel_ver = instance_double(ReleaseVersion, name: &#39;fake-release&#39;, version: &#39;1&#39;)
                allow(deployment_plan).to receive(:release)
                  .with(&#39;fake-job-release&#39;)
                  .and_return(job_rel_ver)

                allow(job_rel_ver).to receive(:get_or_create_template) do |name|
                  job = instance_double(Job, name: name)
                  allow(job).to receive(:add_properties)
                  job
                end
              end

              it &#39;raises an error because job dirs on a VM will become ambiguous&#39; do
                instance_group_spec[&#39;name&#39;] = &#39;fake-instance-group-name&#39;
                expect do
                  parsed_instance_group
                end.to raise_error(
                  InstanceGroupInvalidTemplates,
                  &quot;Colocated job &#39;job-name1&#39; is already added to the instance group &#39;fake-instance-group-name&#39;&quot;,
                )
              end
            end

            context &#39;when multiple hashes reference different releases&#39; do
              before do
                release_model_1 = Models::Release.make(name: &#39;release1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'release_model_1'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L343" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L565" class="js-smell-location">1</a>                  </div>  </li></ol>
                release_version_model_1 = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model_1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'release_version_model_1'</span>          </div>  </li></ol>
                release_version_model_1.add_template(Models::Template.make(name: &#39;job-name1&#39;, release: release_model_1))

                release_model_2 = Models::Release.make(name: &#39;release2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'release_model_2'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L347" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L569" class="js-smell-location">1</a>                  </div>  </li></ol>
                release_version_model_2 = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model_2)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'release_version_model_2'</span>          </div>  </li></ol>
                release_version_model_2.add_template(Models::Template.make(name: &#39;job-name2&#39;, release: release_model_2))
              end

              it &#39;uses the correct release for each template&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when multiple hashes reference different releases)::it#uses the correct release for each template has a flog score of 74</span>          </div>  </li></ol>
                instance_group_spec[keyword] = [
                  { &#39;name&#39; =&gt; &#39;job-name1&#39;, &#39;release&#39; =&gt; &#39;release1&#39;, &#39;links&#39; =&gt; {} },
                  { &#39;name&#39; =&gt; &#39;job-name2&#39;, &#39;release&#39; =&gt; &#39;release2&#39;, &#39;links&#39; =&gt; {} },
                ]

                # resolve first release and template obj
                rel_ver1 = instance_double(ReleaseVersion, name: &#39;release1&#39;, version: &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'rel_ver1'</span>          </div>  </li></ol>
                allow(deployment_plan).to receive(:release)
                  .with(&#39;release1&#39;)
                  .and_return(rel_ver1)

                job1 = make_job(&#39;job1&#39;, rel_ver1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job1'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L202" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L220" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L245" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L304" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L586" class="js-smell-location">4</a>                  </div>  </li></ol>
                allow(job1).to receive(:add_properties)

                expect(rel_ver1).to receive(:get_or_create_template)
                  .with(&#39;job-name1&#39;)
                  .and_return(job1)

                # resolve second release and template obj
                rel_ver2 = instance_double(ReleaseVersion, name: &#39;release2&#39;, version: &#39;1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'rel_ver2'</span>          </div>  </li></ol>
                allow(deployment_plan).to receive(:release)
                  .with(&#39;release2&#39;)
                  .and_return(rel_ver2)

                job2 = make_job(&#39;job2&#39;, rel_ver2)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'job2'</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L227" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L252" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L315" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L599" class="js-smell-location">3</a>                  </div>  </li></ol>
                allow(job2).to receive(:add_properties)

                expect(rel_ver2).to receive(:get_or_create_template)
                  .with(&#39;job-name2&#39;)
                  .and_return(job2)

                instance_group_spec[&#39;name&#39;] = &#39;instance-group-name&#39;
                parsed_instance_group
              end
            end

            context &#39;when one of the hashes is missing a name&#39; do
              it &#39;raises an error because that is how template will be found&#39; do
                instance_group_spec[keyword] = [{}]
                expect do
                  parsed_instance_group
                end.to raise_error(
                  ValidationMissingField,
                  &quot;Required property &#39;name&#39; was not specified in object ({})&quot;,
                )
              end
            end

            context &#39;when one of the elements is not a hash&#39; do
              it &#39;raises an error&#39; do
                instance_group_spec[keyword] = [&#39;not-a-hash&#39;]
                expect do
                  parsed_instance_group
                end.to raise_error(
                  ValidationInvalidType,
                  %{Object (&quot;not-a-hash&quot;) did not match the required type &#39;Hash&#39;},
                )
              end
            end

            context &#39;when properties are provided in the job hash&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L635" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L786" class="js-smell-location">1</a>                  </div>  </li></ol>
              let(:job_rel_ver) do
                instance_double(
                  ReleaseVersion,
                  name: &#39;fake-release&#39;,
                  version: &#39;1&#39;,
                  template: nil,
                )
              end

              before do
                instance_group_spec[&#39;templates&#39;] = [
                  {
                    &#39;name&#39; =&gt; &#39;job-name&#39;,
                    &#39;links&#39; =&gt; { &#39;db&#39; =&gt; &#39;a.b.c&#39; },
                    &#39;properties&#39; =&gt; {
                      &#39;property_1&#39; =&gt; &#39;property_1_value&#39;,
                      &#39;property_2&#39; =&gt; {
                        &#39;life&#39; =&gt; &#39;life_value&#39;,
                      },
                    },
                  },
                ]
                instance_group_spec[&#39;release&#39;] = &#39;fake-release&#39;

                release_model = Models::Release.make(name: &#39;fake-release&#39;)
                release_version_model = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model)
                release_version_model.add_template(Models::Template.make(name: &#39;job-name&#39;, release: release_model))
              end

              it &#39;assigns those properties to the intended template&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when properties are provided in the job hash)::it#assigns those properties to the intended template has a flog score of 41</span>          </div>  </li></ol>
                allow(deployment_plan).to receive(:release)
                  .with(&#39;fake-release&#39;)
                  .and_return(job_rel_ver)

                job = make_job(&#39;job-name&#39;, nil)
                allow(job_rel_ver).to receive(:get_or_create_template)
                  .with(&#39;job-name&#39;)
                  .and_return(job)
                expect(job).to receive(:add_properties)
                  .with({ &#39;property_1&#39; =&gt; &#39;property_1_value&#39;, &#39;property_2&#39; =&gt; { &#39;life&#39; =&gt; &#39;life_value&#39; } }, &#39;instance-group-name&#39;)

                parsed_instance_group
              end
            end

            context &#39;when properties are not provided in the job hash&#39; do
              let(:job_rel_ver) do
                instance_double(
                  ReleaseVersion,
                  name: &#39;fake-release-version&#39;,
                  version: &#39;1&#39;,
                  template: nil,
                )
              end

              let (:props) do
                {
                  &#39;smurf&#39; =&gt; &#39;lazy&#39;,
                  &#39;cat&#39; =&gt; {
                    &#39;color&#39; =&gt; &#39;black&#39;,
                  },
                }
              end

              before do
                instance_group_spec[&#39;templates&#39;] = [
                  {
                    &#39;name&#39; =&gt; &#39;job-name&#39;,
                    &#39;links&#39; =&gt; { &#39;db&#39; =&gt; &#39;a.b.c&#39; }
                  },
                ]

                instance_group_spec[&#39;properties&#39;] = props
                instance_group_spec[&#39;release&#39;] = &#39;fake-job-release&#39;

                release_model = Models::Release.make(name: &#39;fake-release-version&#39;)
                release_version_model = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model)
                release_version_model.add_template(Models::Template.make(name: &#39;job-name&#39;, release: release_model))
              end

              it &#39;assigns merged global &amp; instance group properties to the intended template&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when properties are not provided in the job hash)::it#assigns merged global & instance group properties to the intended template has a flog score of 43</span>          </div>  </li></ol>
                allow(deployment_plan).to receive(:release)
                  .with(&#39;fake-job-release&#39;)
                  .and_return(job_rel_ver)

                job = make_job(&#39;fake-template-name&#39;, nil)
                allow(job_rel_ver).to receive(:get_or_create_template)
                  .with(&#39;job-name&#39;)
                  .and_return(job)
                expect(job).to receive(:add_properties)
                  .with(props, &#39;instance-group-name&#39;)

                parsed_instance_group
              end

              context &#39;property mapping&#39; do
                let(:props) do
                  {
                    &#39;ccdb&#39; =&gt; {
                      &#39;user&#39; =&gt; &#39;admin&#39;,
                      &#39;password&#39; =&gt; &#39;12321&#39;,
                      &#39;unused&#39; =&gt; &#39;yada yada&#39;,
                    },
                    &#39;dea&#39; =&gt; {
                      &#39;max_memory&#39; =&gt; 2048,
                    },
                  }
                end

                let(:mapped_props) do
                  {
                    &#39;ccdb&#39; =&gt; {
                      &#39;user&#39; =&gt; &#39;admin&#39;,
                      &#39;password&#39; =&gt; &#39;12321&#39;,
                      &#39;unused&#39; =&gt; &#39;yada yada&#39;,
                    },
                    &#39;dea&#39; =&gt; {
                      &#39;max_memory&#39; =&gt; 2048,
                    },
                    &#39;db&#39; =&gt; {
                      &#39;user&#39; =&gt; &#39;admin&#39;,
                      &#39;password&#39; =&gt; &#39;12321&#39;,
                      &#39;unused&#39; =&gt; &#39;yada yada&#39;,
                    },
                    &#39;mem&#39; =&gt; 2048,
                  }
                end

                it &#39;supports it&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when properties are not provided in the job hash)::context(property mapping)::it#supports it has a flog score of 53</span>          </div>  </li></ol>
                  instance_group_spec[&#39;properties&#39;] = props
                  instance_group_spec[&#39;property_mappings&#39;] = { &#39;db&#39; =&gt; &#39;ccdb&#39;, &#39;mem&#39; =&gt; &#39;dea.max_memory&#39; }

                  instance_group_spec[&#39;release&#39;] = &#39;fake-job-release&#39;

                  allow(deployment_plan).to receive(:release)
                    .with(&#39;fake-job-release&#39;)
                    .and_return(job_rel_ver)

                  job = make_job(&#39;job-name&#39;, nil)
                  allow(job_rel_ver).to receive(:get_or_create_template)
                    .with(&#39;job-name&#39;)
                    .and_return(job)
                  expect(job).to receive(:add_properties)
                    .with(mapped_props, &#39;instance-group-name&#39;)

                  parsed_instance_group
                end
              end
            end

            context &#39;when consumes_json and provides_json in template model have value &quot;null&quot;&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L635" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L786" class="js-smell-location">1</a>                  </div>  </li></ol>
              let(:job_rel_ver) do
                instance_double(
                  ReleaseVersion,
                  name: &#39;fake-release&#39;,
                  version: &#39;1&#39;,
                  template: nil,
                )
              end

              before do
                instance_group_spec[&#39;templates&#39;] = [
                  {
                    &#39;name&#39; =&gt; &#39;job-name&#39;,
                    &#39;links&#39; =&gt; { &#39;db&#39; =&gt; &#39;a.b.c&#39; },
                    &#39;properties&#39; =&gt; {
                      &#39;property_1&#39; =&gt; &#39;property_1_value&#39;,
                      &#39;property_2&#39; =&gt; {
                        &#39;life&#39; =&gt; &#39;life_value&#39;,
                      },
                    },
                  },
                ]
                instance_group_spec[&#39;release&#39;] = &#39;fake-job-release&#39;

                release_model = Models::Release.make(name: &#39;fake-release&#39;)
                release_version_model = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model)
                release_version_model.add_template(Models::Template.make(name: &#39;job-name&#39;, release: release_model))
              end

              it &#39;does not throw an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context(when consumes_json and provides_json in template model have value "null")::it#does not throw an error has a flog score of 41</span>          </div>  </li></ol>
                allow(deployment_plan).to receive(:release)
                  .with(&#39;fake-job-release&#39;)
                  .and_return(job_rel_ver)

                job = make_job(&#39;job-name&#39;, nil)
                allow(job_rel_ver).to receive(:get_or_create_template)
                  .with(&#39;job-name&#39;)
                  .and_return(job)
                allow(job).to receive(:add_properties)
                  .with({ &#39;property_1&#39; =&gt; &#39;property_1_value&#39;, &#39;property_2&#39; =&gt; { &#39;life&#39; =&gt; &#39;life_value&#39; } }, &#39;instance-group-name&#39;)

                parsed_instance_group
              end
            end

            context &#39;when the manifest specifies a job&#39; do
              it &#39;will parse the links using links parser&#39; do
                # TODO LINKS
              end
            end

            context &#39;link parsing&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::shared_examples_for(templates/jobs key)::context(when value is an array of hashes)::context#link parsing has a flog score of 61</span>          </div>  </li></ol>
              let(:rel_ver) { instance_double(ReleaseVersion, name: &#39;fake-release&#39;, version: &#39;1&#39;) }
              let(:job) { make_job(&#39;job-name&#39;, nil) }

              before do
                instance_group_spec[keyword] = [
                  {
                    &#39;name&#39; =&gt; &#39;job-name&#39;,
                    &#39;release&#39; =&gt; &#39;fake-release&#39;,
                  },
                ]
                release_model = Models::Release.make(name: &#39;fake-release&#39;)
                version = Models::ReleaseVersion.make(version: &#39;1&#39;, release: release_model)
                version.add_template(Models::Template.make(
                  name: &#39;job-name&#39;,
                  release: release_model,
                  spec: {}
                ))
                release_model.add_version(version)

                deployment_model = Models::Deployment.make(name: &#39;deployment&#39;)
                version.add_deployment(deployment_model)

                allow(deployment_plan).to receive(:release)
                  .with(&#39;fake-release&#39;)
                  .and_return(rel_ver)

                allow(rel_ver).to receive(:get_or_create_template)
                  .with(&#39;job-name&#39;)
                  .and_return(job)
                allow(job).to receive(:add_properties)
              end

              it &#39;should parse providers with LinksParser&#39; do
                expect(links_parser).to receive(:parse_providers_from_job)
                parsed_instance_group
              end

              it &#39;should parse consumers with LinksParser&#39; do
                expect(links_parser).to receive(:parse_consumers_from_job)
                parsed_instance_group
              end

              context &#39;when it is not a deploy action&#39; do
                let(:parse_options) do
                  { &#39;is_deploy_action&#39; =&gt; false }
                end

                it &#39;should skip parsing providers with LinksParser&#39; do
                  expect(links_parser).to_not receive(:parse_providers_from_job)
                  parsed_instance_group
                end

                it &#39;should skip parsing consumers with LinksParser&#39; do
                  expect(links_parser).to_not receive(:parse_consumers_from_job)
                  parsed_instance_group
                end
              end
            end
          end

          context &#39;when value is not an array&#39; do
            it &#39;raises an error&#39; do
              instance_group_spec[keyword] = &#39;not-an-array&#39;
              expect do
                parsed_instance_group
              end.to raise_error(
                ValidationInvalidType,
                %{Property &#39;#{keyword}&#39; value (&quot;not-an-array&quot;) did not match the required type &#39;Array&#39;},
              )
            end
          end
        end

        describe &#39;templates key&#39; do
          let(:keyword) { &#39;templates&#39; }
          it_behaves_like &#39;templates/jobs key&#39;
        end

        describe &#39;jobs key&#39; do
          let(:keyword) { &#39;jobs&#39; }
          it_behaves_like &#39;templates/jobs key&#39;
        end

        describe &#39;validating job templates&#39; do
          context &#39;when both template and templates are specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L923" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L937" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              instance_group_spec[&#39;templates&#39;] = []
              instance_group_spec[&#39;template&#39;] = []
            end

            it &#39;raises&#39; do
              expect { parsed_instance_group }.to raise_error(
                InstanceGroupInvalidTemplates,
                &quot;Instance group &#39;instance-group-name&#39; specifies both template and templates keys, only one is allowed&quot;,
              )
            end
          end

          context &#39;when both jobs and templates are specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L923" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L937" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              instance_group_spec[&#39;templates&#39;] = []
              instance_group_spec[&#39;jobs&#39;] = []
            end

            it &#39;raises&#39; do
              expect { parsed_instance_group }.to raise_error(
                InstanceGroupInvalidTemplates,
                &quot;Instance group &#39;instance-group-name&#39; specifies both templates and jobs keys, only one is allowed&quot;,
              )
            end
          end

          context &#39;when neither key is specified&#39; do
            before do
              instance_group_spec.delete(&#39;templates&#39;)
              instance_group_spec.delete(Job)
              instance_group_spec.delete(&#39;jobs&#39;)
            end

            it &#39;raises&#39; do
              expect { parsed_instance_group }.to raise_error(
                ValidationMissingField,
                &quot;Instance group &#39;instance-group-name&#39; does not specify jobs key&quot;,
              )
            end
          end
        end

        describe &#39;persistent_disk key&#39; do
          it &#39;parses persistent disk if present&#39; do
            instance_group_spec[&#39;persistent_disk&#39;] = 300

            expect(
              parsed_instance_group.persistent_disk_collection.generate_spec[&#39;persistent_disk&#39;],
            ).to eq 300
          end

          it &#39;does not add a persistent disk if the size is 0&#39; do
            instance_group_spec[&#39;persistent_disk&#39;] = 0

            expect(
              parsed_instance_group.persistent_disk_collection.collection,
            ).to be_empty
          end

          it &#39;allows persistent disk to be nil&#39; do
            instance_group_spec.delete(&#39;persistent_disk&#39;)

            expect(
              parsed_instance_group.persistent_disk_collection.generate_spec[&#39;persistent_disk&#39;],
            ).to eq 0
          end

          it &#39;raises an error if the disk size is less than zero&#39; do
            instance_group_spec[&#39;persistent_disk&#39;] = -300
            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupInvalidPersistentDisk,
              &quot;Instance group &#39;instance-group-name&#39; references an invalid persistent disk size &#39;-300&#39;&quot;,
            )
          end
        end

        describe &#39;persistent_disk_type key&#39; do
          it &#39;parses persistent_disk_type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(persistent_disk_type key)::it#parses persistent_disk_type has a flog score of 29</span>          </div>  </li></ol>
            instance_group_spec[&#39;persistent_disk_type&#39;] = &#39;fake-disk-pool-name&#39;
            expect(deployment_plan).to receive(:disk_type)
              .with(&#39;fake-disk-pool-name&#39;)
              .and_return(disk_type)

            expect(disk_collection).to receive(:add_by_disk_type).with(disk_type)

            parsed_instance_group
          end

          it &#39;complains about unknown disk type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L132" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L506" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1015" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L1042" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L1212" class="js-smell-location">4</a>                  </div>  </li></ol>
            instance_group_spec[&#39;persistent_disk_type&#39;] = &#39;unknown-disk-pool&#39;
            expect(deployment_plan).to receive(:disk_type)
              .with(&#39;unknown-disk-pool&#39;)
              .and_return(nil)

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupUnknownDiskType,
              &quot;Instance group &#39;instance-group-name&#39; references an unknown disk type &#39;unknown-disk-pool&#39;&quot;,
            )
          end
        end

        describe &#39;persistent_disk_pool key&#39; do
          it &#39;parses persistent_disk_pool&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(persistent_disk_pool key)::it#parses persistent_disk_pool has a flog score of 27</span>          </div>  </li></ol>
            instance_group_spec[&#39;persistent_disk_pool&#39;] = &#39;fake-disk-pool-name&#39;
            expect(deployment_plan).to receive(:disk_type)
              .with(&#39;fake-disk-pool-name&#39;)
              .and_return(disk_type)

            expect(PersistentDiskCollection).to receive_message_chain(:new, :add_by_disk_type).with(disk_type)

            parsed_instance_group
          end

          it &#39;complains about unknown disk pool&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L132" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L506" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1015" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L1042" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L1212" class="js-smell-location">4</a>                  </div>  </li></ol>
            instance_group_spec[&#39;persistent_disk_pool&#39;] = &#39;unknown-disk-pool&#39;
            expect(deployment_plan).to receive(:disk_type)
              .with(&#39;unknown-disk-pool&#39;)
              .and_return(nil)

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupUnknownDiskType,
              &quot;Instance group &#39;instance-group-name&#39; references an unknown disk pool &#39;unknown-disk-pool&#39;&quot;,
            )
          end
        end

        describe &#39;persistent_disks&#39; do
          let(:disk_type_small) { instance_double(DiskType) }
          let(:disk_type_large) { instance_double(DiskType) }
          let(:disk_collection) { instance_double(PersistentDiskCollection) }

          context &#39;when persistent disks are well formatted&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(persistent_disks)::context#when persistent disks are well formatted has a flog score of 59</span>          </div>  </li></ol>
            before do
              instance_group_spec[&#39;persistent_disks&#39;] = [
                { &#39;name&#39; =&gt; &#39;my-disk&#39;, &#39;type&#39; =&gt; &#39;disk-type-small&#39; },
                { &#39;name&#39; =&gt; &#39;my-favourite-disk&#39;, &#39;type&#39; =&gt; &#39;disk-type-large&#39; },
              ]
              expect(deployment_plan).to receive(:disk_type)
                .with(&#39;disk-type-small&#39;)
                .and_return(disk_type_small)
              expect(deployment_plan).to receive(:disk_type)
                .with(&#39;disk-type-large&#39;)
                .and_return(disk_type_large)
              expect(disk_collection).to receive(:add_by_disk_name_and_type)
                .with(&#39;my-favourite-disk&#39;, disk_type_large)
              expect(disk_collection).to receive(:add_by_disk_name_and_type)
                .with(&#39;my-disk&#39;, disk_type_small)
            end

            it &#39;should call LinksParser to create disk providers for each specified disk&#39; do
              expect(links_parser).to receive(:parse_provider_from_disk).twice
              parsed_instance_group
            end
          end

          context &#39;when persistent disks are NOT well formatted&#39; do
            it &#39;complains about empty names&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1087" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1720" class="js-smell-location">1</a>                  </div>  </li></ol>
              instance_group_spec[&#39;persistent_disks&#39;] = [{ &#39;name&#39; =&gt; &#39;&#39;, &#39;type&#39; =&gt; &#39;disk-type-small&#39; }]
              expect do
                parsed_instance_group
              end.to raise_error InstanceGroupInvalidPersistentDisk,
                                 &quot;Instance group &#39;instance-group-name&#39; persistent_disks&#39;s section contains a disk with no name&quot;
            end

            it &#39;complains about two disks with the same name&#39; do
              instance_group_spec[&#39;persistent_disks&#39;] = [
                { &#39;name&#39; =&gt; &#39;same&#39;, &#39;type&#39; =&gt; &#39;disk-type-small&#39; },
                { &#39;name&#39; =&gt; &#39;same&#39;, &#39;type&#39; =&gt; &#39;disk-type-small&#39; },
              ]

              expect do
                parsed_instance_group
              end.to raise_error InstanceGroupInvalidPersistentDisk,
                &quot;Instance group &#39;instance-group-name&#39; persistent_disks&#39;s section contains duplicate names&quot;
            end

            it &#39;complains about unknown disk type&#39; do
              instance_group_spec[&#39;persistent_disks&#39;] = [
                { &#39;name&#39; =&gt; &#39;disk-name-0&#39;, &#39;type&#39; =&gt; &#39;disk-type-small&#39; },
              ]
              expect(deployment_plan).to receive(:disk_type)
                .with(&#39;disk-type-small&#39;)
                .and_return(nil)

              expect do
                parsed_instance_group
              end.to raise_error(
                InstanceGroupUnknownDiskType,
                &quot;Instance group &#39;instance-group-name&#39; persistent_disks&#39;s section references an unknown disk type &#39;disk-type-small&#39;&quot;,
              )
            end
          end
        end

        context &#39;when job has multiple persistent_disks keys&#39; do
          it &#39;raises an error if persistent_disk and persistent_disk_pool are both present&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1126" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1138" class="js-smell-location">1</a>                  </div>  </li></ol>
            instance_group_spec[&#39;persistent_disk&#39;] = 300
            instance_group_spec[&#39;persistent_disk_pool&#39;] = &#39;fake-disk-pool-name&#39;

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupInvalidPersistentDisk,
              &quot;Instance group &#39;instance-group-name&#39; specifies more than one of the following keys: &#39;persistent_disk&#39;, &#39;persistent_disk_type&#39;, &#39;persistent_disk_pool&#39; and &#39;persistent_disks&#39;. Choose one.&quot;,
            )
          end

          it &#39;raises an error if persistent_disk and persistent_disk_type are both present&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1126" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1138" class="js-smell-location">1</a>                  </div>  </li></ol>
            instance_group_spec[&#39;persistent_disk&#39;] = 300
            instance_group_spec[&#39;persistent_disk_type&#39;] = &#39;fake-disk-pool-name&#39;

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupInvalidPersistentDisk,
              &quot;Instance group &#39;instance-group-name&#39; specifies more than one of the following keys: &#39;persistent_disk&#39;, &#39;persistent_disk_type&#39;, &#39;persistent_disk_pool&#39; and &#39;persistent_disks&#39;. Choose one.&quot;,
            )
          end

          it &#39;raises an error if persistent_disk_type and persistent_disk_pool are both present&#39; do
            instance_group_spec[&#39;persistent_disk_type&#39;] = &#39;fake-disk-pool-name&#39;
            instance_group_spec[&#39;persistent_disk_pool&#39;] = &#39;fake-disk-pool-name&#39;

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupInvalidPersistentDisk,
              &quot;Instance group &#39;instance-group-name&#39; specifies more than one of the following keys: &#39;persistent_disk&#39;, &#39;persistent_disk_type&#39;, &#39;persistent_disk_pool&#39; and &#39;persistent_disks&#39;. Choose one.&quot;,
            )
          end
        end

        describe &#39;resource_pool key&#39; do
          it &#39;parses resource pool&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(resource_pool key)::it#parses resource pool has a flog score of 64</span>          </div>  </li></ol>
            expect(deployment_plan).to receive(:resource_pool)
              .with(&#39;fake-resource-pool-name&#39;)
              .and_return(resource_pool)

            instance_group = parsed_instance_group
            expect(instance_group.vm_type.name).to eq(&#39;fake-vm-type&#39;)
            expect(instance_group.vm_type.cloud_properties).to eq({})
            expect(instance_group.stemcell.name).to eq(&#39;fake-stemcell-name&#39;)
            expect(instance_group.stemcell.version).to eq(&#39;1&#39;)
            expect(instance_group.env.spec).to eq(&#39;key&#39; =&gt; &#39;value&#39;)
          end

          context &#39;when env is also declared in the job spec&#39; do
            before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1178" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1199" class="js-smell-location">1</a>                  </div>  </li></ol>
              instance_group_spec[&#39;env&#39;] = { &#39;env1&#39; =&gt; &#39;something&#39; }
              expect(deployment_plan).to receive(:resource_pool)
                .with(&#39;fake-resource-pool-name&#39;)
                .and_return(resource_pool)
            end

            it &#39;complains&#39; do
              expect do
                parsed_instance_group
              end.to raise_error(
                InstanceGroupAmbiguousEnv,
                &quot;Instance group &#39;instance-group-name&#39; and resource pool: &#39;fake-resource-pool-name&#39; both declare env properties&quot;,
              )
            end
          end

          context &#39;when the job declares env, and the resource pool does not&#39; do
            let(:resource_pool_env) do
              {}
            end
            before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1178" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1199" class="js-smell-location">1</a>                  </div>  </li></ol>
              instance_group_spec[&#39;env&#39;] = { &#39;job&#39; =&gt; &#39;env&#39; }
              expect(deployment_plan).to receive(:resource_pool)
                .with(&#39;fake-resource-pool-name&#39;)
                .and_return(resource_pool)
            end

            it &#39;should assign the job env to the job&#39; do
              instance_group = parsed_instance_group
              expect(instance_group.env.spec).to eq(&#39;job&#39; =&gt; &#39;env&#39;)
            end
          end

          it &#39;complains about unknown resource pool&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 5 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L132" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L506" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1015" class="js-smell-location">2</a>                  <a href="instance_group_spec_parser_spec.html#L1042" class="js-smell-location">3</a>                  <a href="instance_group_spec_parser_spec.html#L1212" class="js-smell-location">4</a>                  </div>  </li></ol>
            instance_group_spec[&#39;resource_pool&#39;] = &#39;unknown-resource-pool&#39;
            expect(deployment_plan).to receive(:resource_pool)
              .with(&#39;unknown-resource-pool&#39;)
              .and_return(nil)

            expect do
              parsed_instance_group
            end.to raise_error(
              InstanceGroupUnknownResourcePool,
              &quot;Instance group &#39;instance-group-name&#39; references an unknown resource pool &#39;unknown-resource-pool&#39;&quot;,
            )
          end
        end

        describe &#39;vm type and stemcell key&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe#vm type and stemcell key has a flog score of 32</span>          </div>  </li></ol>
          before do
            allow(deployment_plan).to receive(:vm_type).with(&#39;fake-vm-type&#39;).and_return(
              VmType.new(
                &#39;name&#39; =&gt; &#39;fake-vm-type&#39;,
                &#39;cloud_properties&#39; =&gt; {},
              ),
            )
            allow(deployment_plan).to receive(:stemcell).with(&#39;fake-stemcell&#39;).and_return(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1235" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1305" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1433" class="js-smell-location">2</a>                  </div>  </li></ol>
              Stemcell.parse(
                &#39;alias&#39; =&gt; &#39;fake-stemcell&#39;,
                &#39;os&#39; =&gt; &#39;fake-os&#39;,
                &#39;version&#39; =&gt; 1,
              ),
            )
          end

          let(:instance_group_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1244" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1413" class="js-smell-location">1</a>                  </div>  </li></ol>
            {
              &#39;name&#39; =&gt; &#39;instance-group-name&#39;,
              &#39;templates&#39; =&gt; [],
              &#39;release&#39; =&gt; &#39;fake-release-name&#39;,
              &#39;vm_type&#39; =&gt; &#39;fake-vm-type&#39;,
              &#39;stemcell&#39; =&gt; &#39;fake-stemcell&#39;,
              &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
              &#39;instances&#39; =&gt; 1,
              &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
            }
          end

          it &#39;parses vm type and stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(vm type and stemcell key)::it#parses vm type and stemcell has a flog score of 50</span>          </div>  </li></ol>
            instance_group = parsed_instance_group
            expect(instance_group.vm_type.name).to eq(&#39;fake-vm-type&#39;)
            expect(instance_group.vm_type.cloud_properties).to eq({})
            expect(instance_group.stemcell.alias).to eq(&#39;fake-stemcell&#39;)
            expect(instance_group.stemcell.version).to eq(&#39;1&#39;)
            expect(instance_group.env.spec).to eq(&#39;key&#39; =&gt; &#39;value&#39;)
          end

          context &#39;vm type cannot be found&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1266" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1279" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              allow(deployment_plan).to receive(:vm_type).with(&#39;fake-vm-type&#39;).and_return(nil)
            end

            it &#39;errors out&#39; do
              expect { parsed_instance_group }.to raise_error(
                InstanceGroupUnknownVmType,
                &quot;Instance group &#39;instance-group-name&#39; references an unknown vm type &#39;fake-vm-type&#39;&quot;,
              )
            end
          end

          context &#39;stemcell cannot be found&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1266" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1279" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              allow(deployment_plan).to receive(:stemcell).with(&#39;fake-stemcell&#39;).and_return(nil)
            end

            it &#39;errors out&#39; do
              expect { parsed_instance_group }.to raise_error(
                InstanceGroupUnknownStemcell,
                &quot;Instance group &#39;instance-group-name&#39; references an unknown stemcell &#39;fake-stemcell&#39;&quot;,
              )
            end
          end
        end

        describe &#39;vm resources&#39; do
          let(:vm_resources) do
            {
              &#39;vm_resources&#39; =&gt; {
                &#39;cpu&#39; =&gt; 4,
                &#39;ram&#39; =&gt; 2048,
                &#39;ephemeral_disk_size&#39; =&gt; 100,
              },
            }
          end

          before do
            allow(deployment_plan).to receive(:stemcell).with(&#39;fake-stemcell&#39;).and_return(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1235" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1305" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1433" class="js-smell-location">2</a>                  </div>  </li></ol>
              Stemcell.parse(
                &#39;alias&#39; =&gt; &#39;fake-stemcell&#39;,
                &#39;os&#39; =&gt; &#39;fake-os&#39;,
                &#39;version&#39; =&gt; 1,
              ),
            )
          end

          let(:instance_group_spec) do
            {
              &#39;name&#39; =&gt; &#39;instance-group-name&#39;,
              &#39;templates&#39; =&gt; [],
              &#39;release&#39; =&gt; &#39;fake-release-name&#39;,
              &#39;stemcell&#39; =&gt; &#39;fake-stemcell&#39;,
              &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
              &#39;instances&#39; =&gt; 1,
              &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
            }
          end

          context &#39;when vm_resources are given&#39; do
            before do
              instance_group_spec.merge!(vm_resources)
            end

            it &#39;parses the vm resources&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(vm resources)::context(when vm_resources are given)::it#parses the vm resources has a flog score of 41</span>          </div>  </li></ol>
              instance_group = nil
              expect do
                instance_group = parsed_instance_group
              end.to_not raise_error
              expect(instance_group.vm_resources.cpu).to eq(4)
              expect(instance_group.vm_resources.ram).to eq(2048)
              expect(instance_group.vm_resources.ephemeral_disk_size).to eq(100)
            end
          end

          context &#39;when more than one vm config is given&#39; do
            let(:resource_pool_config) do
              { &#39;resource_pool&#39; =&gt; &#39;fake-resource-pool&#39; }
            end
            let(:vm_type) do
              { &#39;vm_type&#39; =&gt; &#39;fake-vm-type&#39; }
            end

            before do
              allow(deployment_plan).to receive(:vm_type).with(&#39;fake-vm-type&#39;).and_return(
                VmType.new(&#39;name&#39; =&gt; &#39;fake-vm-type&#39;, &#39;cloud_properties&#39; =&gt; {}),
              )
            end

            it &#39;raises an error for vm_type, vm_resources, resource_pool&#39; do
              instance_group_spec.merge!(resource_pool_config).merge!(vm_type).merge!(vm_resources)

              expect do
                parsed_instance_group
              end.to raise_error(InstanceGroupBadVmConfiguration, &quot;Instance group &#39;instance-group-name&#39; can only specify one of &#39;resource_pool&#39;, &#39;vm_type&#39; or &#39;vm_resources&#39; keys.&quot;)
            end

            it &#39;raises an error for vm_type, vm_resources&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1364" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1372" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1380" class="js-smell-location">2</a>                  </div>  </li></ol>
              instance_group_spec.merge!(vm_type).merge!(vm_resources)

              expect do
                parsed_instance_group
              end.to raise_error(InstanceGroupBadVmConfiguration, &quot;Instance group &#39;instance-group-name&#39; can only specify one of &#39;resource_pool&#39;, &#39;vm_type&#39; or &#39;vm_resources&#39; keys.&quot;)
            end

            it &#39;raises an error for resource_pool, vm_resources&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1364" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1372" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1380" class="js-smell-location">2</a>                  </div>  </li></ol>
              instance_group_spec.merge!(resource_pool_config).merge!(vm_resources)

              expect do
                parsed_instance_group
              end.to raise_error(InstanceGroupBadVmConfiguration, &quot;Instance group &#39;instance-group-name&#39; can only specify one of &#39;resource_pool&#39;, &#39;vm_type&#39; or &#39;vm_resources&#39; keys.&quot;)
            end

            it &#39;raises an error for resource_pool, vm_type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1364" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1372" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1380" class="js-smell-location">2</a>                  </div>  </li></ol>
              instance_group_spec.merge!(resource_pool_config).merge!(vm_type)

              expect do
                parsed_instance_group
              end.to raise_error(InstanceGroupBadVmConfiguration, &quot;Instance group &#39;instance-group-name&#39; can only specify one of &#39;resource_pool&#39;, &#39;vm_type&#39; or &#39;vm_resources&#39; keys.&quot;)
            end
          end

          context &#39;when neither vm type, vm resources nor resource pool are given&#39; do
            it &#39;raises an error&#39; do
              expect do
                parsed_instance_group
              end.to raise_error(InstanceGroupBadVmConfiguration, &quot;Instance group &#39;instance-group-name&#39; is missing either &#39;vm_type&#39; or &#39;vm_resources&#39; or &#39;resource_pool&#39; section.&quot;)
            end
          end
        end

        describe &#39;vm_extensions key&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe#vm_extensions key has a flog score of 64</span>          </div>  </li></ol>
          let(:vm_extension_1) do
            {
              &#39;name&#39; =&gt; &#39;vm_extension_1&#39;,
              &#39;cloud_properties&#39; =&gt; { &#39;property&#39; =&gt; &#39;value&#39; },
            }
          end

          let(:vm_extension_2) do
            {
              &#39;name&#39; =&gt; &#39;vm_extension_2&#39;,
              &#39;cloud_properties&#39; =&gt; { &#39;another_property&#39; =&gt; &#39;value1&#39;, &#39;property&#39; =&gt; &#39;value2&#39; },
            }
          end

          let(:instance_group_spec) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1244" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1413" class="js-smell-location">1</a>                  </div>  </li></ol>
            {
              &#39;name&#39; =&gt; &#39;instance-group-name&#39;,
              &#39;templates&#39; =&gt; [],
              &#39;release&#39; =&gt; &#39;fake-release-name&#39;,
              &#39;vm_type&#39; =&gt; &#39;fake-vm-type&#39;,
              &#39;stemcell&#39; =&gt; &#39;fake-stemcell&#39;,
              &#39;env&#39; =&gt; { &#39;key&#39; =&gt; &#39;value&#39; },
              &#39;instances&#39; =&gt; 1,
              &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
            }
          end

          before do
            allow(deployment_plan).to receive(:vm_type).with(&#39;fake-vm-type&#39;).and_return(
              VmType.new(
                &#39;name&#39; =&gt; &#39;fake-vm-type&#39;,
                &#39;cloud_properties&#39; =&gt; {},
              ),
            )
            allow(deployment_plan).to receive(:stemcell).with(&#39;fake-stemcell&#39;).and_return(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1235" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1305" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1433" class="js-smell-location">2</a>                  </div>  </li></ol>
              Stemcell.parse(
                &#39;alias&#39; =&gt; &#39;fake-stemcell&#39;,
                &#39;os&#39; =&gt; &#39;fake-os&#39;,
                &#39;version&#39; =&gt; 1,
              ),
            )
            allow(deployment_plan).to receive(:vm_extension).with(&#39;vm_extension_1&#39;).and_return(
              VmExtension.new(vm_extension_1),
            )
            allow(deployment_plan).to receive(:vm_extension).with(&#39;vm_extension_2&#39;).and_return(
              VmExtension.new(vm_extension_2),
            )
          end

          context &#39;job has one vm_extension&#39; do
            it &#39;parses the vm_extension&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(vm_extensions key)::context(job has one vm_extension)::it#parses the vm_extension has a flog score of 38</span>          </div>  </li></ol>
              instance_group_spec[&#39;vm_extensions&#39;] = [&#39;vm_extension_1&#39;]

              instance_group = parsed_instance_group
              expect(instance_group.vm_extensions.size).to eq(1)
              expect(instance_group.vm_extensions.first.name).to eq(&#39;vm_extension_1&#39;)
              expect(instance_group.vm_extensions.first.cloud_properties).to eq(&#39;property&#39; =&gt; &#39;value&#39;)
            end
          end
        end

        describe &#39;properties key&#39; do
          context &#39;properties mapping&#39; do
            it &#39;complains about unsatisfiable property mappings&#39; do
              props = { &#39;foo&#39; =&gt; &#39;bar&#39; }

              instance_group_spec[&#39;properties&#39;] = props
              instance_group_spec[&#39;property_mappings&#39;] = { &#39;db&#39; =&gt; &#39;ccdb&#39; }

              allow(deployment_plan).to receive(:properties).and_return(props)

              expect do
                parsed_instance_group
              end.to raise_error(
                InstanceGroupInvalidPropertyMapping,
              )
            end

            it &#39;maps properties correctly&#39; do
              props = {
                &#39;ccdb&#39; =&gt; {
                  &#39;user&#39; =&gt; &#39;admin&#39;,
                  &#39;password&#39; =&gt; &#39;12321&#39;,
                  &#39;unused&#39; =&gt; &#39;yada yada&#39;,
                },
                &#39;dea&#39; =&gt; {
                  &#39;max_memory&#39; =&gt; 2048,
                },
              }

              instance_group_spec[&#39;properties&#39;] = props
              instance_group_spec[&#39;property_mappings&#39;] = { &#39;db&#39; =&gt; &#39;ccdb&#39;, &#39;mem&#39; =&gt; &#39;dea.max_memory&#39; }

              allow(deployment_plan).to receive(:properties).and_return(props)

              parsed_instance_group
            end
          end
        end

        describe &#39;instances key&#39; do
          it &#39;parses out desired instances&#39; do
            instance_group = parsed_instance_group

            expected_instances = [
              DesiredInstance.new(instance_group, deployment_plan),
            ]
            expect(instance_group.desired_instances).to eq(expected_instances)
          end
        end

        describe &#39;networks key&#39; do
          before { instance_group_spec[&#39;networks&#39;].first[&#39;static_ips&#39;] = &#39;10.0.0.2 - 10.0.0.4&#39; } # 2,3,4

          context &#39;when the number of static ips is less than number of instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1513" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1525" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1678" class="js-smell-location">2</a>                  </div>  </li></ol>
            it &#39;raises an exception because if a job uses static ips all instances must have a static ip&#39; do
              instance_group_spec[&#39;instances&#39;] = 4
              expect do
                parsed_instance_group
              end.to raise_error(
                InstanceGroupNetworkInstanceIpMismatch,
                &quot;Instance group &#39;instance-group-name&#39; has 4 instances but was allocated 3 static IPs in network &#39;fake-network-name&#39;&quot;,
              )
            end
          end

          context &#39;when the number of static ips is greater the number of instances&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1513" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1525" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1678" class="js-smell-location">2</a>                  </div>  </li></ol>
            it &#39;raises an exception because the extra ip is wasted&#39; do
              instance_group_spec[&#39;instances&#39;] = 2
              expect do
                parsed_instance_group
              end.to raise_error(
                InstanceGroupNetworkInstanceIpMismatch,
                &quot;Instance group &#39;instance-group-name&#39; has 2 instances but was allocated 3 static IPs in network &#39;fake-network-name&#39;&quot;,
              )
            end
          end

          context &#39;when number of static ips matches the number of instances&#39; do
            it &#39;does not raise an exception&#39; do
              instance_group_spec[&#39;instances&#39;] = 3
              expect { parsed_instance_group }.to_not raise_error
            end
          end

          context &#39;when there are multiple networks specified as default for a property&#39; do
            it &#39;errors&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(networks key)::context(when there are multiple networks specified as default for a property)::it#errors has a flog score of 45</span>          </div>  </li></ol>
              instance_group_spec[&#39;instances&#39;] = 3
              instance_group_spec[&#39;networks&#39;].first[&#39;default&#39;] = %w[gateway dns]
              instance_group_spec[&#39;networks&#39;] &lt;&lt; instance_group_spec[&#39;networks&#39;].first.merge(&#39;name&#39; =&gt; &#39;duped-network&#39;) # dupe it
              duped_network = ManualNetwork.new(&#39;duped-network&#39;, [], logger)
              allow(deployment_plan).to receive(:networks).and_return([duped_network, network])

              expect do
                parsed_instance_group
              end.to raise_error(
                JobNetworkMultipleDefaults,
                &quot;Instance group &#39;instance-group-name&#39; specified more than one network to contain default. &quot; \
                  &quot;&#39;dns&#39; has default networks: &#39;fake-network-name&#39;, &#39;duped-network&#39;. &quot; \
                  &quot;&#39;gateway&#39; has default networks: &#39;fake-network-name&#39;, &#39;duped-network&#39;.&quot;,
              )
            end
          end

          context &#39;when there are no networks specified as default for a property&#39; do
            context &#39;when there is only one network&#39; do
              it &#39;picks the only network as default&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(networks key)::context(when there are no networks specified as default for a property)::context(when there is only one network)::it#picks the only network as default has a flog score of 37</span>          </div>  </li></ol>
                instance_group_spec[&#39;instances&#39;] = 3
                allow(deployment_plan).to receive(:networks).and_return([network])
                instance_group = parsed_instance_group

                expect(instance_group.default_network[&#39;dns&#39;]).to eq(&#39;fake-network-name&#39;)
                expect(instance_group.default_network[&#39;gateway&#39;]).to eq(&#39;fake-network-name&#39;)
              end
            end

            context &#39;when there are two networks, each being a separate default&#39; do
              let(:network2) { ManualNetwork.new(&#39;fake-network-name-2&#39;, [], logger) }

              it &#39;picks the only network as default&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(networks key)::context(when there are no networks specified as default for a property)::context(when there are two networks, each being a separate default)::it#picks the only network as default has a flog score of 53</span>          </div>  </li></ol>
                instance_group_spec[&#39;networks&#39;].first[&#39;default&#39;] = [&#39;dns&#39;]
                instance_group_spec[&#39;networks&#39;] &lt;&lt; { &#39;name&#39; =&gt; &#39;fake-network-name-2&#39;, &#39;default&#39; =&gt; [&#39;gateway&#39;] }
                instance_group_spec[&#39;instances&#39;] = 3
                allow(deployment_plan).to receive(:networks).and_return([network, network2])
                instance_group = parsed_instance_group

                expect(instance_group.default_network[&#39;dns&#39;]).to eq(&#39;fake-network-name&#39;)
                expect(instance_group.default_network[&#39;gateway&#39;]).to eq(&#39;fake-network-name-2&#39;)
              end
            end
          end
        end

        describe &#39;azs key&#39; do
          context &#39;when there is a key but empty values&#39; do
            it &#39;raises an exception&#39; do
              instance_group_spec[&#39;azs&#39;] = []

              expect do
                parsed_instance_group
              end.to raise_error(
                JobMissingAvailabilityZones, &quot;Instance group &#39;instance-group-name&#39; has empty availability zones&quot;
              )
            end
          end

          context &#39;when there is a key with values&#39; do
            it &#39;parses each value into the AZ on the deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(azs key)::context(when there is a key with values)::it#parses each value into the AZ on the deployment has a flog score of 27</span>          </div>  </li></ol>
              zone1, zone2 = set_up_azs!(%w[zone1 zone2], instance_group_spec, deployment_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'zone1'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan has the variable name 'zone2'</span>          </div>  </li></ol>
              allow(network).to receive(:has_azs?).and_return(true)
              expect(parsed_instance_group.availability_zones).to eq([zone1, zone2])
            end

            it &#39;raises an exception if the value are not strings&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(azs key)::context(when there is a key with values)::it#raises an exception if the value are not strings has a flog score of 33</span>          </div>  </li></ol>
              instance_group_spec[&#39;azs&#39;] = [&#39;valid_zone&#39;, 3]
              allow(network).to receive(:has_azs?).and_return(true)
              allow(deployment_plan).to receive(:availability_zone).with(&#39;valid_zone&#39;) { instance_double(AvailabilityZone) }

              expect do
                parsed_instance_group
              end.to raise_error(
                JobInvalidAvailabilityZone, &quot;Instance group &#39;instance-group-name&#39; has invalid availability zone &#39;3&#39;, string expected&quot;
              )
            end

            it &#39;raises an exception if the referenced AZ doesnt exist in the deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(azs key)::context(when there is a key with values)::it#raises an exception if the referenced AZ doesnt exist in the deployment has a flog score of 42</span>          </div>  </li></ol>
              instance_group_spec[&#39;azs&#39;] = %w[existent_zone nonexistent_zone]
              allow(network).to receive(:has_azs?).and_return(true)
              allow(deployment_plan).to receive(:availability_zone).with(&#39;existent_zone&#39;) { instance_double(AvailabilityZone) }
              allow(deployment_plan).to receive(:availability_zone).with(&#39;nonexistent_zone&#39;) { nil }

              expect do
                parsed_instance_group
              end.to raise_error(
                JobUnknownAvailabilityZone, &quot;Instance group &#39;instance-group-name&#39; references unknown availability zone &#39;nonexistent_zone&#39;&quot;
              )
            end

            it &#39;raises an error if the referenced AZ is not specified on networks&#39; do
              allow(network).to receive(:has_azs?).and_return(false)

              expect do
                parsed_instance_group
              end.to raise_error(
                JobNetworkMissingRequiredAvailabilityZone,
                &quot;Instance group &#39;instance-group-name&#39; must specify availability zone that matches availability zones of network &#39;fake-network-name&#39;&quot;,
              )
            end

            describe &#39;validating AZs against the networks of the job&#39; do
              it &#39;validates that every network satisfies job AZ requirements&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(azs key)::context(when there is a key with values)::describe(validating AZs against the networks of the job)::it#validates that every network satisfies job AZ requirements has a flog score of 39</span>          </div>  </li></ol>
                set_up_azs!(%w[zone1 zone2], instance_group_spec, deployment_plan)
                instance_group_spec[&#39;networks&#39;] = [
                  { &#39;name&#39; =&gt; &#39;first-network&#39; },
                  { &#39;name&#39; =&gt; &#39;second-network&#39;, &#39;default&#39; =&gt; %w[dns gateway] },
                ]

                first_network = instance_double(
                  ManualNetwork,
                  name: &#39;first-network&#39;,
                  has_azs?: true,
                  validate_reference_from_job!: true,
                )
                second_network = instance_double(
                  ManualNetwork,
                  name: &#39;second-network&#39;,
                  has_azs?: true,
                  validate_reference_from_job!: true,
                )
                allow(deployment_plan).to receive(:networks).and_return([first_network, second_network])

                parsed_instance_group

                expect(first_network).to have_received(:has_azs?).with(%w[zone1 zone2])
                expect(second_network).to have_received(:has_azs?).with(%w[zone1 zone2])
              end
            end
          end

          context &#39;when there is a key with the wrong type&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1513" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1525" class="js-smell-location">1</a>                  <a href="instance_group_spec_parser_spec.html#L1678" class="js-smell-location">2</a>                  </div>  </li></ol>
            it &#39;an exception is raised&#39; do
              instance_group_spec[&#39;azs&#39;] = 3

              expect do
                parsed_instance_group
              end.to raise_error(
                ValidationInvalidType, &quot;Property &#39;azs&#39; value (3) did not match the required type &#39;Array&#39;&quot;
              )
            end
          end
        end

        describe &#39;migrated_from&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe#migrated_from has a flog score of 36</span>          </div>  </li></ol>
          let(:instance_group_spec) do
            {
              &#39;name&#39; =&gt; &#39;instance-group-name&#39;,
              &#39;templates&#39; =&gt; [],
              &#39;release&#39; =&gt; &#39;fake-release-name&#39;,
              &#39;resource_pool&#39; =&gt; &#39;fake-resource-pool-name&#39;,
              &#39;instances&#39; =&gt; 1,
              &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;fake-network-name&#39; }],
              &#39;migrated_from&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;job-1&#39;, &#39;az&#39; =&gt; &#39;z1&#39; }, { &#39;name&#39; =&gt; &#39;job-2&#39;, &#39;az&#39; =&gt; &#39;z2&#39; }],
              &#39;azs&#39; =&gt; %w[z1 z2],
            }
          end
          before do
            allow(network).to receive(:has_azs?).and_return(true)
            allow(deployment_plan).to receive(:availability_zone).with(&#39;z1&#39;) { AvailabilityZone.new(&#39;z1&#39;, {}) }
            allow(deployment_plan).to receive(:availability_zone).with(&#39;z2&#39;) { AvailabilityZone.new(&#39;z2&#39;, {}) }
          end

          it &#39;sets migrated_from on a job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::describe(#parse)::describe(migrated_from)::it#sets migrated_from on a job has a flog score of 52</span>          </div>  </li></ol>
            instance_group = parsed_instance_group
            expect(instance_group.migrated_from[0].name).to eq(&#39;job-1&#39;)
            expect(instance_group.migrated_from[0].availability_zone).to eq(&#39;z1&#39;)
            expect(instance_group.migrated_from[1].name).to eq(&#39;job-2&#39;)
            expect(instance_group.migrated_from[1].availability_zone).to eq(&#39;z2&#39;)
          end

          context &#39;when az is specified&#39; do
            context &#39;when migrated job refers to az that is not in the list of availaibility_zones key&#39; do
              it &#39;raises an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1087" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1720" class="js-smell-location">1</a>                  </div>  </li></ol>
                instance_group_spec[&#39;migrated_from&#39;] = [{ &#39;name&#39; =&gt; &#39;job-1&#39;, &#39;az&#39; =&gt; &#39;unknown_az&#39; }]

                expect do
                  parsed_instance_group
                end.to raise_error(
                  DeploymentInvalidMigratedFromJob,
                  &quot;Instance group &#39;job-1&#39; specified for migration to instance group &#39;instance-group-name&#39; refers to availability zone &#39;unknown_az&#39;. &quot; \
                    &quot;Az &#39;unknown_az&#39; is not in the list of availability zones of instance group &#39;instance-group-name&#39;.&quot;,
                )
              end
            end
          end
        end

        describe &#39;remove_dev_tools&#39; do
          let(:resource_pool_env) do
            {}
          end
          before { allow(Config).to receive(:remove_dev_tools).and_return(false) }

          it &#39;does not add remove_dev_tools by default&#39; do
            instance_group = parsed_instance_group
            expect(instance_group.env.spec[&#39;bosh&#39;]).to eq(nil)
          end

          it &#39;does what the job env says&#39; do
            instance_group_spec[&#39;env&#39;] = { &#39;bosh&#39; =&gt; { &#39;remove_dev_tools&#39; =&gt; &#39;custom&#39; } }
            instance_group = parsed_instance_group
            expect(instance_group.env.spec[&#39;bosh&#39;][&#39;remove_dev_tools&#39;]).to eq(&#39;custom&#39;)
          end

          describe &#39;when director manifest specifies director.remove_dev_tools&#39; do
            before { allow(Config).to receive(:remove_dev_tools).and_return(true) }

            it &#39;should do what director wants&#39; do
              instance_group = parsed_instance_group
              expect(instance_group.env.spec[&#39;bosh&#39;][&#39;remove_dev_tools&#39;]).to eq(true)
            end
          end

          describe &#39;when both the job and director specify&#39; do
            before do
              allow(Config).to receive(:remove_dev_tools).and_return(true)
              instance_group_spec[&#39;env&#39;] = { &#39;bosh&#39; =&gt; { &#39;remove_dev_tools&#39; =&gt; false } }
            end

            it &#39;defers to the job&#39; do
              instance_group = parsed_instance_group
              expect(instance_group.env.spec[&#39;bosh&#39;][&#39;remove_dev_tools&#39;]).to eq(false)
            end
          end
        end

        describe &#39;update&#39; do
          let(:update) do
            {}
          end

          before do
            instance_group_spec[&#39;update&#39;] = update
          end

          it &#39;can be overridden by canaries option&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1783" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1789" class="js-smell-location">1</a>                  </div>  </li></ol>
            parse_options[&#39;canaries&#39;] = 7

            expect(parsed_instance_group.update.canaries(nil)).to eq(7)
          end

          it &#39;can be overridden by max-in-flight option&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_group_spec_parser_spec.html#L1783" class="js-smell-location">0</a>                  <a href="instance_group_spec_parser_spec.html#L1789" class="js-smell-location">1</a>                  </div>  </li></ol>
            parse_options[&#39;max_in_flight&#39;] = 8

            expect(parsed_instance_group.update.max_in_flight(nil)).to eq(8)
          end

          context &#39;when provided an instance_group_spec with a vm_strategy&#39; do
            let(:update) do
              { &#39;vm_strategy&#39; =&gt; &#39;create-swap-delete&#39; }
            end

            it &#39;should set the instance_group strategy as create-swap-delete&#39; do
              expect(parsed_instance_group.update.vm_strategy).to eq(&#39;create-swap-delete&#39;)
            end
          end
        end

        def set_up_azs!(azs, instance_group_spec, deployment_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan#set_up_azs! has approx 6 statements</span>          </div>  </li></ol>
          instance_group_spec[&#39;azs&#39;] = azs
          azs.map do |az_name|
            fake_az = instance_double(AvailabilityZone, name: az_name)
            allow(deployment_plan).to receive(:availability_zone).with(az_name) { fake_az }
            fake_az
          end
        end

        def make_job(name, rel_ver)
          instance_double(
            Job,
            name: name,
            release: rel_ver,
            link_infos: {},
          )
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
