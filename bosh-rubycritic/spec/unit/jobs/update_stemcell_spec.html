<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-03-16 10:31:11 -0400'>2018-03-16 10:31:11 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/jobs /</small> update_stemcell_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">570</span><small> lines of codes</small></div>
              <div><span class="metric">1</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1991.9</span><small> complexity/method</small></div>
              <div><span class="metric">70</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1991.89</span><small> complexity</small></div>
              <div><span class="metric">355</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                28
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;net/http&#39;

describe Bosh::Director::Jobs::UpdateStemcell do
  describe &#39;DJ job class expectations&#39; do
    let(:job_type) { :update_stemcell }
    let(:queue) { :normal }
    it_behaves_like &#39;a DJ job&#39;
  end

  describe &#39;#perform&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe##perform has a flog score of 91</span>          </div>  </li></ol>
    let(:cloud) { instance_double(Bosh::Clouds::ExternalCpi) }

    let(:event_log) { Bosh::Director::EventLog::Log.new }
    let(:event_log_stage) { instance_double(Bosh::Director::EventLog::Stage) }
    let(:verify_multidigest_exit_status) { instance_double(Process::Status, exitstatus: 0) }

    before do
      allow(Bosh::Director::Config).to receive(:event_log).and_return(event_log)
      allow(Bosh::Director::Config).to receive(:uuid).and_return(&#39;meow-uuid&#39;)
      allow(Bosh::Director::Config).to receive(:cloud_options).and_return({&#39;provider&#39; =&gt; {&#39;path&#39; =&gt; &#39;/path/to/default/cpi&#39;}})
      allow(Bosh::Director::Config).to receive(:verify_multidigest_path).and_return(&#39;some/path&#39;)
      allow(Bosh::Clouds::ExternalCpi).to receive(:new).with(&#39;/path/to/default/cpi&#39;, &#39;meow-uuid&#39;, stemcell_api_version: nil).and_return(cloud)
      allow(cloud).to receive(:request_cpi_api_version=)
      allow(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])

      allow(event_log).to receive(:begin_stage).and_return(event_log_stage)
      allow(event_log_stage).to receive(:advance_and_track).and_yield [nil]
      allow(Open3).to receive(:capture3).and_return([nil, &#39;some error&#39;, verify_multidigest_exit_status])
    end

    context &#39;when the stemcell tarball is valid&#39; do
      before do
        manifest = {
          &#39;name&#39; =&gt; &#39;jeos&#39;,
          &#39;version&#39; =&gt; 5,
          &#39;operating_system&#39; =&gt; &#39;jeos-5&#39;,
          &#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;],
          &#39;cloud_properties&#39; =&gt; { &#39;ram&#39; =&gt; &#39;2gb&#39; },
          &#39;sha1&#39; =&gt; &#39;shawone&#39;,
        }
        stemcell_contents = create_stemcell(manifest, &#39;image contents&#39;)
        @stemcell_file = Tempfile.new(&#39;stemcell_contents&#39;)
        File.open(@stemcell_file.path, &#39;w&#39;) { |f| f.write(stemcell_contents) }
        @stemcell_url = &quot;file://#{@stemcell_file.path}&quot;
      end
      after { FileUtils.rm_rf(@stemcell_file.path) }

      context &#39;uploading a local stemcell&#39; do
        it &#39;should upload a local stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(uploading a local stemcell)::it#should upload a local stemcell has a flog score of 101</span>          </div>  </li></ol>
          expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
            contents = File.open(image, &amp;:read)
            expect(contents).to eq(&#39;image contents&#39;)
            &#39;stemcell-cid&#39;
          end

          expected_steps = 5
          expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
          expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps).times

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)
          update_stemcell_job.perform

          stemcell = Bosh::Director::Models::Stemcell.find(name: &#39;jeos&#39;, version: &#39;5&#39;)
          expect(stemcell).not_to be_nil
          expect(stemcell.cid).to eq(&#39;stemcell-cid&#39;)
          expect(stemcell.sha1).to eq(&#39;shawone&#39;)
          expect(stemcell.operating_system).to eq(&#39;jeos-5&#39;)
          expect(stemcell.api_version).to be_nil
        end

        context &#39;when provided an incorrect sha1&#39; do
          let(:verify_multidigest_exit_status) { instance_double(Process::Status, exitstatus: 1) }

          it &#39;fails to upload a stemcell&#39; do
            update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path, &#39;sha1&#39; =&gt; &#39;abcd1234&#39;)
            expect { update_stemcell_job.perform }.to raise_exception(Bosh::Director::StemcellSha1DoesNotMatch)
          end
        end

        context &#39;when provided a correct sha1&#39; do
          it &#39;should upload a local stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(uploading a local stemcell)::context(when provided a correct sha1)::it#should upload a local stemcell has a flog score of 101</span>          </div>  </li></ol>
            expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
            expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
              contents = File.open(image, &amp;:read)
              expect(contents).to eq(&#39;image contents&#39;)
              &#39;stemcell-cid&#39;
            end

            expected_steps = 6
            expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
            expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps).times

            update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(
              @stemcell_file.path,
              &#39;sha1&#39; =&gt; &#39;eeaec4f77e2014966f7f01e949c636b9f9992757&#39;,
            )
            update_stemcell_job.perform

            stemcell = Bosh::Director::Models::Stemcell.find(name: &#39;jeos&#39;, version: &#39;5&#39;)
            expect(stemcell).not_to be_nil
            expect(stemcell.cid).to eq(&#39;stemcell-cid&#39;)
            expect(stemcell.sha1).to eq(&#39;shawone&#39;)
            expect(stemcell.operating_system).to eq(&#39;jeos-5&#39;)
            expect(stemcell.api_version).to be_nil
          end
        end
      end

      context &#39;uploading a remote stemcell&#39; do
        it &#39;should upload a remote stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(uploading a remote stemcell)::it#should upload a remote stemcell has a flog score of 113</span>          </div>  </li></ol>
          expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
            contents = File.open(image, &amp;:read)
            expect(contents).to eql(&#39;image contents&#39;)
            &#39;stemcell-cid&#39;
          end

          expected_steps = 6
          expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
          expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps).times

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(&#39;fake-stemcell-url&#39;, &#39;remote&#39; =&gt; true)
          expect(update_stemcell_job).to receive(:download_remote_file) do |resource, url, path|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L125" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L148" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L176" class="js-smell-location">2</a>                  </div>  </li></ol>
            expect(resource).to eq(&#39;stemcell&#39;)
            expect(url).to eq(&#39;fake-stemcell-url&#39;)
            FileUtils.mv(@stemcell_file.path, path)
          end
          update_stemcell_job.perform

          stemcell = Bosh::Director::Models::Stemcell.find(name: &#39;jeos&#39;, version: &#39;5&#39;)
          expect(stemcell).not_to be_nil
          expect(stemcell.cid).to eq(&#39;stemcell-cid&#39;)
          expect(stemcell.sha1).to eq(&#39;shawone&#39;)
          expect(stemcell.api_version).to be_nil
        end

        context &#39;when provided an incorrect sha1&#39; do
          let(:verify_multidigest_exit_status) { instance_double(Process::Status, exitstatus: 1) }

          it &#39;fails to upload a stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(uploading a remote stemcell)::context(when provided an incorrect sha1)::it#fails to upload a stemcell has a flog score of 34</span>          </div>  </li></ol>
            update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(
              &#39;fake-stemcell-url&#39;,
              &#39;remote&#39; =&gt; true,
              &#39;sha1&#39; =&gt; &#39;abcd1234&#39;,
            )
            expect(update_stemcell_job).to receive(:download_remote_file) do |resource, url, path|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L125" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L148" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L176" class="js-smell-location">2</a>                  </div>  </li></ol>
              expect(resource).to eq(&#39;stemcell&#39;)
              expect(url).to eq(&#39;fake-stemcell-url&#39;)
              FileUtils.mv(@stemcell_file.path, path)
            end

            expect { update_stemcell_job.perform }.to raise_exception(Bosh::Director::StemcellSha1DoesNotMatch)
          end
        end

        context &#39;when provided a correct sha1&#39; do
          it &#39;should upload a remote stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(uploading a remote stemcell)::context(when provided a correct sha1)::it#should upload a remote stemcell has a flog score of 113</span>          </div>  </li></ol>
            expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
            expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
              contents = File.open(image, &amp;:read)
              expect(contents).to eql(&#39;image contents&#39;)
              &#39;stemcell-cid&#39;
            end

            expected_steps = 7
            expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
            expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps).times

            update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(
              &#39;fake-stemcell-url&#39;,
              &#39;remote&#39; =&gt; true,
              &#39;sha1&#39; =&gt; &#39;eeaec4f77e2014966f7f01e949c636b9f9992757&#39;,
            )
            expect(update_stemcell_job).to receive(:download_remote_file) do |resource, url, path|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L125" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L148" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L176" class="js-smell-location">2</a>                  </div>  </li></ol>
              expect(resource).to eq(&#39;stemcell&#39;)
              expect(url).to eq(&#39;fake-stemcell-url&#39;)
              FileUtils.mv(@stemcell_file.path, path)
            end
            update_stemcell_job.perform

            stemcell = Bosh::Director::Models::Stemcell.find(name: &#39;jeos&#39;, version: &#39;5&#39;)
            expect(stemcell).not_to be_nil
            expect(stemcell.cid).to eq(&#39;stemcell-cid&#39;)
            expect(stemcell.sha1).to eq(&#39;shawone&#39;)
            expect(stemcell.api_version).to be_nil
          end
        end
      end

      it &#39;should cleanup the stemcell file&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::it#should cleanup the stemcell file has a flog score of 48</span>          </div>  </li></ol>
        expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
        expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
          contents = File.open(image, &amp;:read)
          expect(contents).to eql(&#39;image contents&#39;)
          &#39;stemcell-cid&#39;
        end

        update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)
        update_stemcell_job.perform

        expect(File.exist?(@stemcell_file.path)).to be(false)
      end

      context &#39;when stemcell already exists&#39; do
        before do
          Bosh::Director::Models::Stemcell.make(name: &#39;jeos&#39;, version: &#39;5&#39;, cid: &#39;old-stemcell-cid&#39;)
        end

        it &#39;should quietly ignore duplicate upload and not create a stemcell in the cloud&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(when stemcell already exists)::it#should quietly ignore duplicate upload and not create a stemcell in the cloud has a flog score of 45</span>          </div>  </li></ol>
          expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expected_steps = 5
          expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
          expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps).times

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)
          expect(update_stemcell_job.perform).to eq(&#39;/stemcells/jeos/5&#39;)
        end

        it &#39;should quietly ignore duplicate remote uploads and not create a stemcell in the cloud&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(when stemcell already exists)::it#should quietly ignore duplicate remote uploads and not create a stemcell in the cloud has a flog score of 54</span>          </div>  </li></ol>
          expected_steps = 6
          expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
          expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps).times

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_url, &#39;remote&#39; =&gt; true)
          expect(update_stemcell_job).to receive(:download_remote_file) do |_, remote_file, local_file|
            uri = URI.parse(remote_file)
            FileUtils.cp(uri.path, local_file)
          end
          expect(update_stemcell_job.perform).to eq(&#39;/stemcells/jeos/5&#39;)
        end

        it &#39;should upload stemcell and update db with --fix option set&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(when stemcell already exists)::it#should upload stemcell and update db with --fix option set has a flog score of 69</span>          </div>  </li></ol>
          expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(cloud).to receive(:create_stemcell).and_return &#39;new-stemcell-cid&#39;
          expected_steps = 5
          expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
          expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps).times

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path, &#39;fix&#39; =&gt; true)
          expect { update_stemcell_job.perform }.to_not raise_error

          stemcell = Bosh::Director::Models::Stemcell.find(name: &#39;jeos&#39;, version: &#39;5&#39;)
          expect(stemcell).not_to be_nil
          expect(stemcell.cid).to eq(&#39;new-stemcell-cid&#39;)
        end
      end

      it &#39;should fail if cannot extract stemcell&#39; do
        result = Bosh::Exec::Result.new(&#39;cmd&#39;, &#39;output&#39;, 1)
        expect(Bosh::Exec).to receive(:sh).and_return(result)

        update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)

        expect do
          update_stemcell_job.perform
        end.to raise_exception(Bosh::Director::StemcellInvalidArchive)
      end

      context &#39;when having multiple cpis&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context#when having multiple cpis has a flog score of 51</span>          </div>  </li></ol>
        let(:cloud_factory) { instance_double(BD::CloudFactory) }
        let(:cloud1) { cloud }
        let(:cloud2) { cloud }
        let(:cloud3) { cloud }

        before do
          allow(BD::CloudFactory).to receive(:create).and_return(cloud_factory)
          allow(cloud_factory).to receive(:get_cpi_aliases).with(&#39;cloud1&#39;).and_return([&#39;cloud1&#39;])
          allow(cloud_factory).to receive(:get_cpi_aliases).with(&#39;cloud2&#39;).and_return([&#39;cloud2&#39;])
          allow(cloud_factory).to receive(:get_cpi_aliases).with(&#39;cloud3&#39;).and_return([&#39;cloud3&#39;])
        end

        it &#39;creates multiple stemcell records with different cpi attributes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(when having multiple cpis)::it#creates multiple stemcell records with different cpi attributes has a flog score of 307</span>          </div>  </li></ol>
          expect(cloud1).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;).and_return(&#39;stemcell-cid1&#39;)
          expect(cloud3).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;).and_return(&#39;stemcell-cid3&#39;)

          expect(cloud1).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(cloud2).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy1&#39;])
          expect(cloud3).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])

          expect(cloud_factory).to receive(:all_names).twice.and_return(%w[cloud1 cloud2 cloud3])
          expect(cloud_factory).to receive(:get).with(&#39;cloud1&#39;).and_return(cloud1)
          expect(cloud_factory).to receive(:get).with(&#39;cloud2&#39;).and_return(cloud2)
          expect(cloud_factory).to receive(:get).with(&#39;cloud3&#39;).and_return(cloud3)

          expected_steps = 11
          expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)

          step_messages = [
            &#39;Checking if this stemcell already exists (cpi: cloud1)&#39;,
            &#39;Checking if this stemcell already exists (cpi: cloud3)&#39;,
            &#39;Uploading stemcell jeos/5 to the cloud (cpi: cloud1)&#39;,
            &#39;Uploading stemcell jeos/5 to the cloud (cpi: cloud3)&#39;,
            &#39;Save stemcell jeos/5 (stemcell-cid1) (cpi: cloud1)&#39;,
            &#39;Save stemcell jeos/5 (stemcell-cid3) (cpi: cloud3)&#39;,
          ]

          step_messages.each do |msg|
            expect(event_log_stage).to receive(:advance_and_track).with(msg)
          end
          # seems that rspec already subtracts the expected messages above, so we have to subtract them from the expected overall count
          expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps - step_messages.count - 3).times

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)
          update_stemcell_job.perform

          stemcells = Bosh::Director::Models::Stemcell.where(name: &#39;jeos&#39;, version: &#39;5&#39;).all

          expect(stemcells.count).to eq(2)
          expect(stemcells[0]).not_to be_nil
          expect(stemcells[0].sha1).to eq(&#39;shawone&#39;)
          expect(stemcells[0].operating_system).to eq(&#39;jeos-5&#39;)
          expect(stemcells[0].cpi).to eq(&#39;cloud1&#39;)
          expect(stemcells[0].cid).to eq(&#39;stemcell-cid1&#39;)
          expect(stemcells[0].api_version).to be_nil

          expect(stemcells[1]).not_to be_nil
          expect(stemcells[1].sha1).to eq(&#39;shawone&#39;)
          expect(stemcells[1].operating_system).to eq(&#39;jeos-5&#39;)
          expect(stemcells[1].cpi).to eq(&#39;cloud3&#39;)
          expect(stemcells[1].cid).to eq(&#39;stemcell-cid3&#39;)
          expect(stemcells[1].api_version).to be_nil

          stemcell_uploads = Bosh::Director::Models::StemcellUpload.where(name: &#39;jeos&#39;, version: &#39;5&#39;).all
          expect(stemcell_uploads.map(&amp;:cpi)).to contain_exactly(&#39;cloud1&#39;, &#39;cloud2&#39;, &#39;cloud3&#39;)
        end

        it &#39;skips creating a stemcell match when a CPI fails&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(when having multiple cpis)::it#skips creating a stemcell match when a CPI fails has a flog score of 73</span>          </div>  </li></ol>
          expect(cloud1).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;).and_raise(&#39;I am flaky&#39;)
          expect(cloud1).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(cloud_factory).to receive(:get).with(&#39;cloud1&#39;).and_return(cloud1)
          expect(cloud_factory).to receive(:all_names).twice.and_return([&#39;cloud1&#39;])

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)
          expect { update_stemcell_job.perform }.to raise_error &#39;I am flaky&#39;

          expect(BD::Models::StemcellUpload.all.count).to eq(0)
        end

        context &#39;when the stemcell has already been uploaded&#39; do
          before do
            BD::Models::Stemcell.make(name: &#39;jeos&#39;, version: &#39;5&#39;, cpi: &#39;cloud1&#39;)
            BD::Models::StemcellUpload.make(name: &#39;jeos&#39;, version: &#39;5&#39;, cpi: &#39;cloud2&#39;)
          end

          it &#39;creates one stemcell and one stemcell match per cpi&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(when having multiple cpis)::context(when the stemcell has already been uploaded)::it#creates one stemcell and one stemcell match per cpi has a flog score of 166</span>          </div>  </li></ol>
            expect(cloud_factory).to receive(:all_names).twice.and_return(%w[cloud1 cloud2 cloud3])
            expect(cloud_factory).to receive(:get).with(&#39;cloud1&#39;).and_return(cloud1)
            expect(cloud_factory).to receive(:get).with(&#39;cloud2&#39;).and_return(cloud2)
            expect(cloud_factory).to receive(:get).with(&#39;cloud3&#39;).and_return(cloud3)

            expect(cloud1).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
            expect(cloud2).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy1&#39;])
            expect(cloud3).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])

            expect(cloud3).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;).and_return(&#39;stemcell-cid3&#39;)

            expect(BD::Models::Stemcell.all.count).to eq(1)
            expect(BD::Models::StemcellUpload.all.count).to eq(1)

            update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)
            update_stemcell_job.perform

            expect(BD::Models::Stemcell.all.map do |s|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L366" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L373" class="js-smell-location">1</a>                  </div>  </li></ol>
              { name: s.name, version: s.version, cpi: s.cpi }
            end).to contain_exactly(
              { name: &#39;jeos&#39;, version: &#39;5&#39;, cpi: &#39;cloud1&#39; },
              { name: &#39;jeos&#39;, version: &#39;5&#39;, cpi: &#39;cloud3&#39; },
            )

            expect(BD::Models::StemcellUpload.all.map do |s|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L366" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L373" class="js-smell-location">1</a>                  </div>  </li></ol>
              { name: s.name, version: s.version, cpi: s.cpi }
            end).to contain_exactly(
              { name: &#39;jeos&#39;, version: &#39;5&#39;, cpi: &#39;cloud1&#39; },
              { name: &#39;jeos&#39;, version: &#39;5&#39;, cpi: &#39;cloud2&#39; },
              { name: &#39;jeos&#39;, version: &#39;5&#39;, cpi: &#39;cloud3&#39; },
            )
          end
        end

        it &#39;still works with the default cpi&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell tarball is valid)::context(when having multiple cpis)::it#still works with the default cpi has a flog score of 182</span>          </div>  </li></ol>
          expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;).and_return(&#39;stemcell-cid&#39;)

          expect(cloud_factory).to receive(:get_cpi_aliases).with(&#39;&#39;).and_return([&#39;&#39;])
          expect(cloud_factory).to receive(:all_names).twice.and_return([&#39;&#39;])
          expect(cloud_factory).to receive(:get).with(&#39;&#39;).and_return(cloud)

          expected_steps = 5
          expect(event_log).to receive(:begin_stage).with(&#39;Update stemcell&#39;, expected_steps)
          expect(event_log_stage).to receive(:advance_and_track).with(&#39;Checking if this stemcell already exists&#39;)
          expect(event_log_stage).to receive(:advance_and_track).with(&#39;Uploading stemcell jeos/5 to the cloud&#39;)
          expect(event_log_stage).to receive(:advance_and_track).with(&#39;Save stemcell jeos/5 (stemcell-cid)&#39;)
          # seems that rspec already subtracts the expected messages above, so we have to subtract them from the expected overall count
          expect(event_log_stage).to receive(:advance_and_track).exactly(expected_steps - 3).times

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)
          update_stemcell_job.perform

          stemcells = Bosh::Director::Models::Stemcell.where(name: &#39;jeos&#39;, version: &#39;5&#39;).all

          expect(stemcells.count).to eq(1)
          expect(stemcells[0]).not_to be_nil
          expect(stemcells[0].sha1).to eq(&#39;shawone&#39;)
          expect(stemcells[0].operating_system).to eq(&#39;jeos-5&#39;)
          expect(stemcells[0].cpi).to eq(&#39;&#39;)
          expect(stemcells[0].api_version).to be_nil
        end
      end
    end

    context &#39;when information about stemcell formats is not enough&#39; do
      context &#39;when stemcell does not have stemcell formats&#39; do
        it &#39;should not fail&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when information about stemcell formats is not enough)::context(when stemcell does not have stemcell formats)::it#should not fail has a flog score of 54</span>          </div>  </li></ol>
          manifest = {
            &#39;name&#39; =&gt; &#39;jeos&#39;,
            &#39;version&#39; =&gt; 5,
            &#39;cloud_properties&#39; =&gt; { &#39;ram&#39; =&gt; &#39;2gb&#39; },
            &#39;sha1&#39; =&gt; &#39;shawone&#39;,
          }
          stemcell_contents = create_stemcell(manifest, &#39;image contents&#39;)
          @stemcell_file = Tempfile.new(&#39;stemcell_contents&#39;)

          File.open(@stemcell_file.path, &#39;w&#39;) { |f| f.write(stemcell_contents) }
          expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
          expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
            contents = File.open(image, &amp;:read)
            expect(contents).to eql(&#39;image contents&#39;)
            &#39;stemcell-cid&#39;
          end

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)

          expect { update_stemcell_job.perform }.not_to raise_error
        end
      end

      context &#39;when cpi does not have stemcell formats&#39; do
        it &#39;should not fail&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when information about stemcell formats is not enough)::context(when cpi does not have stemcell formats)::it#should not fail has a flog score of 54</span>          </div>  </li></ol>
          manifest = {
            &#39;name&#39; =&gt; &#39;jeos&#39;,
            &#39;version&#39; =&gt; 5,
            &#39;cloud_properties&#39; =&gt; { &#39;ram&#39; =&gt; &#39;2gb&#39; },
            &#39;sha1&#39; =&gt; &#39;shawone&#39;,
          }
          stemcell_contents = create_stemcell(manifest, &#39;image contents&#39;)
          @stemcell_file = Tempfile.new(&#39;stemcell_contents&#39;)

          File.open(@stemcell_file.path, &#39;w&#39;) { |f| f.write(stemcell_contents) }
          expect(cloud).to receive(:info).and_return({})
          expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
            contents = File.open(image, &amp;:read)
            expect(contents).to eql(&#39;image contents&#39;)
            &#39;stemcell-cid&#39;
          end

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)

          expect { update_stemcell_job.perform }.not_to raise_error
        end
      end

      context &#39;when cpi does not support stemcell formats&#39; do
        it &#39;should not fail&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when information about stemcell formats is not enough)::context(when cpi does not support stemcell formats)::it#should not fail has a flog score of 54</span>          </div>  </li></ol>
          manifest = {
            &#39;name&#39; =&gt; &#39;jeos&#39;,
            &#39;version&#39; =&gt; 5,
            &#39;cloud_properties&#39; =&gt; { &#39;ram&#39; =&gt; &#39;2gb&#39; },
            &#39;sha1&#39; =&gt; &#39;shawone&#39;,
          }
          stemcell_contents = create_stemcell(manifest, &#39;image contents&#39;)
          @stemcell_file = Tempfile.new(&#39;stemcell_contents&#39;)

          File.open(@stemcell_file.path, &#39;w&#39;) { |f| f.write(stemcell_contents) }
          expect(cloud).to receive(:info).and_raise(Bosh::Clouds::NotImplemented)
          expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
            contents = File.open(image, &amp;:read)
            expect(contents).to eql(&#39;image contents&#39;)
            &#39;stemcell-cid&#39;
          end

          update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)

          expect { update_stemcell_job.perform }.not_to raise_error
        end
      end
    end

    context &#39;when the stemcell metadata lacks a value for operating_system&#39; do
      before do
        manifest = {
          &#39;name&#39; =&gt; &#39;jeos&#39;,
          &#39;version&#39; =&gt; 5,
          &#39;cloud_properties&#39; =&gt; { &#39;ram&#39; =&gt; &#39;2gb&#39; },
          &#39;sha1&#39; =&gt; &#39;shawone&#39;,
        }
        stemcell_contents = create_stemcell(manifest, &#39;image contents&#39;)
        @stemcell_file = Tempfile.new(&#39;stemcell_contents&#39;)
        File.open(@stemcell_file.path, &#39;w&#39;) { |f| f.write(stemcell_contents) }
      end

      it &#39;should not fail&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when the stemcell metadata lacks a value for operating_system)::it#should not fail has a flog score of 44</span>          </div>  </li></ol>
        expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
        expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
          contents = File.open(image, &amp;:read)
          expect(contents).to eql(&#39;image contents&#39;)
          &#39;stemcell-cid&#39;
        end

        update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(@stemcell_file.path)

        expect { update_stemcell_job.perform }.not_to raise_error
      end
    end

    context &#39;when api_version is provided&#39; do
      before do
        manifest = {
          &#39;name&#39; =&gt; &#39;jeos&#39;,
          &#39;version&#39; =&gt; 5,
          &#39;operating_system&#39; =&gt; &#39;jeos-5&#39;,
          &#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;],
          &#39;cloud_properties&#39; =&gt; { &#39;ram&#39; =&gt; &#39;2gb&#39; },
          &#39;sha1&#39; =&gt; &#39;shawone&#39;,
          &#39;api_version&#39; =&gt; 2,
        }
        stemcell_contents = create_stemcell(manifest, &#39;image contents&#39;)
        @stemcell_file = Tempfile.new(&#39;stemcell_contents&#39;)
        File.open(@stemcell_file.path, &#39;w&#39;) { |f| f.write(stemcell_contents) }
      end

      it &#39;should update api_version&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(#perform)::context(when api_version is provided)::it#should update api_version has a flog score of 75</span>          </div>  </li></ol>
        expect(cloud).to receive(:info).and_return(&#39;stemcell_formats&#39; =&gt; [&#39;dummy&#39;])
        expect(cloud).to receive(:create_stemcell).with(anything, &#39;ram&#39; =&gt; &#39;2gb&#39;) do |image, _|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 10 nodes</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L52" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L85" class="js-smell-location">1</a>                  <a href="update_stemcell_spec.html#L114" class="js-smell-location">2</a>                  <a href="update_stemcell_spec.html#L161" class="js-smell-location">3</a>                  <a href="update_stemcell_spec.html#L194" class="js-smell-location">4</a>                  <a href="update_stemcell_spec.html#L428" class="js-smell-location">5</a>                  <a href="update_stemcell_spec.html#L453" class="js-smell-location">6</a>                  <a href="update_stemcell_spec.html#L478" class="js-smell-location">7</a>                  <a href="update_stemcell_spec.html#L506" class="js-smell-location">8</a>                  <a href="update_stemcell_spec.html#L536" class="js-smell-location">9</a>                  </div>  </li></ol>
          contents = File.open(image, &amp;:read)
          expect(contents).to eq(&#39;image contents&#39;)
          &#39;stemcell-cid&#39;
        end


        update_stemcell_job = Bosh::Director::Jobs::UpdateStemcell.new(
          @stemcell_file.path,
          &#39;sha1&#39; =&gt; &#39;eeaec4f77e2014966f7f01e949c636b9f9992757&#39;,
        )
        update_stemcell_job.perform

        stemcell = Bosh::Director::Models::Stemcell.find(name: &#39;jeos&#39;, version: &#39;5&#39;)
        expect(stemcell).not_to be_nil
        expect(stemcell.cid).to eq(&#39;stemcell-cid&#39;)
        expect(stemcell.sha1).to eq(&#39;shawone&#39;)
        expect(stemcell.operating_system).to eq(&#39;jeos-5&#39;)
        expect(stemcell.api_version).to eq(2)
      end
    end

    def create_stemcell(manifest, image)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>create_stemcell has approx 8 statements</span>          </div>  </li></ol>
      io = StringIO.new

      Archive::Tar::Minitar::Writer.open(io) do |tar|
        tar.add_file(&#39;stemcell.MF&#39;, mode: &#39;0644&#39;, mtime: 0) { |os, _| os.write(manifest.to_yaml) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>create_stemcell refers to 'os' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L562" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L563" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>create_stemcell refers to 'tar' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L562" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L563" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>create_stemcell contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L562" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L563" class="js-smell-location">1</a>                  </div>  </li></ol>
        tar.add_file(&#39;image&#39;, mode: &#39;0644&#39;, mtime: 0) { |os, _| os.write(image) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>create_stemcell refers to 'os' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L562" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L563" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>create_stemcell refers to 'tar' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L562" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L563" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>create_stemcell contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L562" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L563" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      io.close<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>create_stemcell refers to 'io' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L566" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L567" class="js-smell-location">1</a>                  </div>  </li></ol>
      gzip(io.string)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>create_stemcell refers to 'io' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_stemcell_spec.html#L566" class="js-smell-location">0</a>                  <a href="update_stemcell_spec.html#L567" class="js-smell-location">1</a>                  </div>  </li></ol>
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
