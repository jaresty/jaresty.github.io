<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-21 09:26:03 -0700'>2018-06-21 09:26:03 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/jobs /</small> export_release_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">587</span><small> lines of codes</small></div>
              <div><span class="metric">1</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1354.2</span><small> complexity/method</small></div>
              <div><span class="metric">73</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1354.19</span><small> complexity</small></div>
              <div><span class="metric">291</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                20
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;rubygems&#39;
require &#39;rubygems/package&#39;
require &#39;spec_helper&#39;

module Bosh::Director<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director has no descriptive comment</span>          </div>  </li></ol>
  describe Jobs::ExportRelease do
    include Support::FakeLocks

    let(:multi_digest) { instance_double(BoshDigest::MultiDigest) }
    let(:sha2) { nil }

    let(:task) {Bosh::Director::Models::Task.make(:id =&gt; 42, :username =&gt; &#39;user&#39;)}
    let(:task_result) { Bosh::Director::TaskDBWriter.new(:result_output, task.id) }
    let(:package_compile_step) { instance_double(DeploymentPlan::Stages::PackageCompileStage)}

    let(:planner_model) { instance_double(Bosh::Director::Models::Deployment) }
    let(:assembler) { instance_double(DeploymentPlan::Assembler, bind_models: nil) }

    let(:options) do
      {}
    end

    before do
      fake_locks
      allow(BoshDigest::MultiDigest).to receive(:new).and_return(multi_digest)
      Bosh::Director::Config.current_job = job
      Bosh::Director::Config.current_job.task_id = task.id
      allow(job).to receive(:task_cancelled?) { false }
      blobstore = double(:blobstore)
      blobstores = instance_double(Bosh::Director::Blobstores, blobstore: blobstore)
      app = instance_double(App, blobstores: blobstores)
      allow(App).to receive(:instance).and_return(app)
      allow(multi_digest).to receive(:create).and_return(&#39;expected-sha1&#39;)
      allow(Config).to receive(:result).and_return(task_result)
      allow(planner_model).to receive(:add_variable_set)

      allow(DeploymentPlan::Assembler).to receive(:create).and_return(assembler)
    end

    subject(:job) { described_class.new(deployment_manifest[&#39;name&#39;], release_name, manifest_release_version, &#39;ubuntu&#39;, &#39;1&#39;, sha2, options) }

    def create_stemcell<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director#create_stemcell doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      Bosh::Director::Models::Stemcell.create(
          name: &#39;ubuntu-stemcell&#39;,
          version: &#39;1&#39;,
          operating_system: &#39;ubuntu&#39;,
          cid: &#39;cloud-id-a&#39;,
      )
    end

    let(:release_name) { deployment_manifest[&#39;releases&#39;].first[&#39;name&#39;] }
    let(:manifest_release_version) { deployment_manifest[&#39;releases&#39;].first[&#39;version&#39;] }
    let(:deployment_manifest) { Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups }

    it &#39;raises an error when the targeted deployment is not found&#39; do
      create_stemcell
      expect {
        job.perform
      }.to raise_error(Bosh::Director::DeploymentNotFound)
    end

    context &#39;with a valid deployment targeted&#39; do
      let(:cloud_config) { Bosh::Spec::NewDeployments.simple_cloud_config }

      let!(:deployment_model) do
        deployment = Models::Deployment.make(
          name: deployment_manifest[&#39;name&#39;],
          manifest: YAML.dump(deployment_manifest),
        )
        deployment.cloud_configs = [Models::Config.make(:cloud, content: YAML.dump(cloud_config))]
        deployment
      end

      before do
        Models::VariableSet.create(deployment: deployment_model)

        allow(job).to receive(:with_deployment_lock).and_yield
      end

      it &#39;raises an error when the requested release does not exist&#39; do
        create_stemcell
        expect {
          job.perform
        }.to raise_error(Bosh::Director::ReleaseNotFound)
      end

      context &#39;when the requested release exists but version does not match&#39; do
        it &#39;raises an error&#39; do
          create_stemcell
          release = Bosh::Director::Models::Release.create(name: release_name)
          release.add_version(:version =&gt; &#39;0.2-dev&#39;)
          expect {
            job.perform
          }.to raise_error(Bosh::Director::ReleaseVersionNotFound)
        end
      end

      context &#39;when the requested release exists but exporting version does not match&#39; do
        let(:manifest_release_version) { &#39;0.5-dev&#39; }
        let(:exported_release_version) { &#39;0.1-dev&#39; }

        it &#39;raises an error&#39; do
          create_stemcell
          release = Bosh::Director::Models::Release.create(name: release_name)
          release.add_version(:version =&gt; exported_release_version)
          release.add_version(:version =&gt; manifest_release_version)
          expect {
            job.perform
          }.to raise_error(Bosh::Director::ReleaseNotMatchingManifest)
        end
      end

      context &#39;when the requested release and version exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context#when the requested release and version exist has a flog score of 34</span>          </div>  </li></ol>
        before do
          release = Bosh::Director::Models::Release.create(name: release_name)
          release_version = release.add_version(:version =&gt; &#39;0.1-dev&#39;)
          release_version.add_package(Bosh::Director::Models::Package.make(name: &#39;foo&#39;))
          release_version.add_package(Bosh::Director::Models::Package.make(name: &#39;bar&#39;))
          release_version.add_template(
            :name =&gt; deployment_manifest[&#39;instance_groups&#39;].first[&#39;jobs&#39;].first[&#39;name&#39;],
            :version =&gt; &#39;template_a_version&#39;,
            :release_id =&gt; release.id,
            :blobstore_id =&gt; &#39;template_a_blobstore_id&#39;,
            :sha1 =&gt; &#39;template_a_sha1&#39;,
            :package_names_json =&gt; &#39;[&quot;foo&quot;, &quot;bar&quot;]&#39;)
        end

        it &#39;raises an error if the requested stemcell is not found&#39; do
          expect {
            job.perform
          }.to raise_error(Bosh::Director::StemcellNotFound)
        end

        context &#39;and the requested stemcell is found&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when the requested release and version exist)::context#and the requested stemcell is found has a flog score of 31</span>          </div>  </li></ol>
          before do
            create_stemcell
            allow(DeploymentPlan::Stages::PackageCompileStage).to receive(:create).and_return(package_compile_step)
            allow(job).to receive(:create_tarball)
            allow(package_compile_step).to receive(:perform)
          end

          it &#39;locks the deployment, release, and selected stemcell&#39; do
            lock_timeout = {:timeout=&gt;900} # 15 minutes. 15 * 60
            expect(job).to receive(:with_deployment_lock).with(deployment_manifest[&#39;name&#39;], lock_timeout).and_yield

            job.perform
          end

          it &#39;succeeds&#39; do
            expect(package_compile_step).to receive(:perform).with no_args

            job.perform
          end

          context &#39;when using vm_types, stemcells, and azs&#39; do
            let(:cloud_config) do
              config = Bosh::Spec::NewDeployments.simple_cloud_config
              config[&#39;azs&#39;] = [{&#39;name&#39; =&gt; &#39;z1&#39;, &#39;cloud_properties&#39; =&gt; {}}]
              config[&#39;networks&#39;].first[&#39;subnets&#39;].first[&#39;az&#39;] = &#39;z1&#39;
              config[&#39;vm_types&#39;] =  [Bosh::Spec::NewDeployments.vm_type]
              config[&#39;compilation&#39;][&#39;az&#39;] = &#39;z1&#39;
              config
            end

            let(:deployment_manifest) do
              manifest = Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups
              stemcell = {
                &#39;alias&#39; =&gt; &#39;ubuntu&#39;,
                &#39;os&#39; =&gt; &#39;ubuntu&#39;,
                &#39;version&#39; =&gt; &#39;1&#39;,
              }
              manifest[&#39;stemcells&#39;] = [stemcell]
              instance_group = manifest[&#39;instance_groups&#39;].first
              instance_group[&#39;stemcell&#39;] = stemcell[&#39;alias&#39;]
              instance_group[&#39;vm_type&#39;] = Bosh::Spec::NewDeployments.vm_type[&#39;name&#39;]
              instance_group[&#39;azs&#39;] = [&#39;z1&#39;]
              manifest
            end

            it &#39;succeeds&#39; do
              expect(package_compile_step).to receive(:perform).with no_args

              job.perform
            end
          end

          context &#39;and multiple stemcells match the requested stemcell&#39; do
            before {
              Bosh::Director::Models::Stemcell.create(
                  name: &#39;z-name-stemcell&#39;,
                  version: &#39;stemcell_version&#39;,
                  operating_system: &#39;stemcell_os&#39;,
                  cid: &#39;cloud-id-b&#39;,
              )
              allow(package_compile_step).to receive(:perform)
            }

            it &#39;succeeds&#39; do
              expect {
                job.perform
              }.to_not raise_error
            end

            context &#39;when dealing with links&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when the requested release and version exist)::context(and the requested stemcell is found)::context(and multiple stemcells match the requested stemcell)::context#when dealing with links has a flog score of 68</span>          </div>  </li></ol>
              let(:planner_factory) { instance_double(Bosh::Director::DeploymentPlan::PlannerFactory)}
              let(:planner) { instance_double(Bosh::Director::DeploymentPlan::Planner)}
              let(:deployment_job) { instance_double(DeploymentPlan::InstanceGroup)}

              before {
                allow(DeploymentPlan::PlannerFactory).to receive(:create).and_return(planner_factory)
                allow(planner_factory).to receive(:create_from_model).and_return(planner)
                allow(planner).to receive(:model).and_return(Bosh::Director::Models::Deployment.make(name: &#39;foo&#39;))
                allow(planner).to receive(:release)
                allow(planner).to receive(:add_instance_group)
                allow(job).to receive(:create_compilation_instance_group)
              }

              it &#39;skips links binding&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="export_release_spec.html#L218" class="js-smell-location">0</a>                  <a href="update_deployment_spec.html#L211" class="js-smell-location">1</a>                  </div>  </li></ol>
                expect(assembler).to receive(:bind_models).with({:should_bind_links =&gt; false, :should_bind_properties=&gt;false})
                job.perform
              end
            end

            it &#39;chooses the first stemcell alphabetically by name&#39; do
              job.perform
              expect(log_string).to match /Will compile with stemcell: ubuntu-stemcell/
            end
          end
        end
      end

      context &#39;when creating a tarball&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context#when creating a tarball has a flog score of 152</span>          </div>  </li></ol>
        let(:blobstore_client) { instance_double(&#39;Bosh::Blobstore::BaseClient&#39;) }
        let(:archiver) { instance_double(&#39;Bosh::Director::Core::TarGzipper&#39;) }
        let(:planner_factory) { DeploymentPlan::PlannerFactory.create(logger) }
        let(:planner) { planner_factory.create_from_model(deployment_model) }
        let(:task_dir) { Dir.mktmpdir }
        let(:release) {Bosh::Director::Models::Release.create(name: release_name)}
        let(:release_version) {release.add_version(:version =&gt; &#39;0.1-dev&#39;)}

        before do
          release_version.add_package(
            Bosh::Director::Models::Package.make(
              name: &#39;foo&#39;,
              dependency_set_json: JSON.generate([&#39;postgres&#39;]),
            ),
          )
          release_version.add_package(Bosh::Director::Models::Package.make(name: &#39;bar&#39;))

          release_version.add_template(
            :name =&gt; deployment_manifest[&#39;instance_groups&#39;].first[&#39;jobs&#39;].first[&#39;name&#39;],
            :version =&gt; &#39;foo_version&#39;,
            :release_id =&gt; release.id,
            fingerprint: &#39;foobar_fingerprint&#39;,
            :blobstore_id =&gt; &#39;foobar_blobstore_id&#39;,
            :sha1 =&gt; &#39;foo_sha1&#39;,
            :package_names_json =&gt; &#39;[&quot;foo&quot;, &quot;bar&quot;]&#39;)

          release_version.add_template(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="export_release_spec.html#L259" class="js-smell-location">0</a>                  <a href="export_release_spec.html#L268" class="js-smell-location">1</a>                  </div>  </li></ol>
            :name =&gt; &#39;foobaz&#39;,
            :version =&gt; &#39;foo_version&#39;,
            :release_id =&gt; release.id,
            fingerprint: &#39;foobaz_fingerprint&#39;,
            :blobstore_id =&gt; &#39;foobaz_blobstore_id&#39;,
            :sha1 =&gt; &#39;foo_sha1&#39;,
            :package_names_json =&gt; &#39;[&quot;foo&quot;, &quot;bar&quot;]&#39;)

          release_version.add_template(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="export_release_spec.html#L259" class="js-smell-location">0</a>                  <a href="export_release_spec.html#L268" class="js-smell-location">1</a>                  </div>  </li></ol>
            :name =&gt; &#39;foofoo&#39;,
            :version =&gt; &#39;foo_version&#39;,
            :release_id =&gt; release.id,
            fingerprint: &#39;foofoo_fingerprint&#39;,
            :blobstore_id =&gt; &#39;foofoo_blobstore_id&#39;,
            :sha1 =&gt; &#39;foo_sha1&#39;,
            :package_names_json =&gt; &#39;[&quot;foo&quot;, &quot;bar&quot;]&#39;)

          create_stemcell

          package_ruby = release_version.add_package(
              name: &#39;ruby&#39;,
              version: &#39;ruby_version&#39;,
              fingerprint: &#39;ruby_fingerprint&#39;,
              release_id: release.id,
              blobstore_id: &#39;ruby_package_blobstore_id&#39;,
              sha1: &#39;rubypackagesha1&#39;,
              dependency_set_json: [].to_json,
          )
          package_ruby.add_compiled_package(
              sha1: &#39;rubycompiledpackagesha1&#39;,
              blobstore_id: &#39;ruby_compiled_package_blobstore_id&#39;,
              dependency_key: [].to_json,
              build: 23,
              stemcell_os: &#39;ubuntu&#39;,
              stemcell_version: &#39;1&#39;
          )

          package_postgres = release_version.add_package(
              name: &#39;postgres&#39;,
              version: &#39;postgres_version&#39;,
              fingerprint: &#39;postgres_fingerprint&#39;,
              release_id: release.id,
              blobstore_id: &#39;postgres_package_blobstore_id&#39;,
              sha1: &#39;postgres_package_sha1&#39;,
              dependency_set_json: [&#39;ruby&#39;].to_json,
          )
          package_postgres.add_compiled_package(
              sha1: &#39;postgrescompiledpackagesha1&#39;,
              blobstore_id: &#39;postgres_package_blobstore_id&#39;,
              dependency_key: &#39;[[&quot;ruby&quot;,&quot;ruby_version&quot;]]&#39;,
              build: 23,
              stemcell_os: &#39;ubuntu&#39;,
              stemcell_version: &#39;1&#39;
          )

          allow(App).to receive_message_chain(:instance, :blobstores, :blobstore).and_return(blobstore_client)
          allow(Bosh::Director::Core::TarGzipper).to receive(:new).and_return(archiver)
          allow(Config).to receive(:event_log).and_return(EventLog::Log.new)
          allow(DeploymentPlan::PlannerFactory).to receive(:create).and_return(planner_factory)
          allow(planner_factory).to receive(:create_from_model).and_return(planner)
          allow(DeploymentPlan::Stages::PackageCompileStage).to receive(:create).and_return(package_compile_step)
          allow(package_compile_step).to receive(:perform).with no_args
        end

        it &#39;should order the files in the tarball&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::it#should order the files in the tarball has a flog score of 37</span>          </div>  </li></ol>
          allow(blobstore_client).to receive(:get)
          allow(blobstore_client).to receive(:create).and_return(&#39;blobstore_id&#39;)
          expect(archiver).to receive(:compress) { |download_dir, sources, output_path|
            expect(sources).to eq([&#39;./release.MF&#39;, &#39;./jobs&#39;, &#39;./compiled_packages&#39;])
            File.write(output_path, &#39;Some glorious content&#39;)
          }
          job.perform
        end

        context &#39;when specific jobs are not specified&#39; do
          it &#39;should contain all compiled packages &amp; jobs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::context(when specific jobs are not specified)::it#should contain all compiled packages & jobs has a flog score of 122</span>          </div>  </li></ol>
            allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
              files = Dir.entries(download_dir)
              expect(files).to include(&#39;compiled_packages&#39;, &#39;release.MF&#39;, &#39;jobs&#39;)

              files = Dir.entries(File.join(download_dir, &#39;compiled_packages&#39;))
              expect(files).to include(&#39;postgres.tgz&#39;)

              files = Dir.entries(File.join(download_dir, &#39;jobs&#39;))
              expect(files).to include(&#39;foobar.tgz&#39;)

              File.write(output_path, &#39;Some glorious content&#39;)
            }

            expect(blobstore_client).to receive(:create).and_return(&#39;blobstore_id&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;ruby_compiled_package_blobstore_id&#39;, anything, sha1: &#39;rubycompiledpackagesha1&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;postgres_package_blobstore_id&#39;, anything, sha1: &#39;postgrescompiledpackagesha1&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;foobar_blobstore_id&#39;, anything, sha1: &#39;foo_sha1&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;foobaz_blobstore_id&#39;, anything, sha1: &#39;foo_sha1&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;foofoo_blobstore_id&#39;, anything, sha1: &#39;foo_sha1&#39;)
            job.perform
          end

          it &#39;creates a manifest file that contains the sha1, fingerprint and blobstore_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="export_release_spec.html#L358" class="js-smell-location">0</a>                  <a href="export_release_spec.html#L476" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::context(when specific jobs are not specified)::it#creates a manifest file that contains the sha1, fingerprint and blobstore_id has a flog score of 77</span>          </div>  </li></ol>
            allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
              manifest_hash = YAML.load_file(File.join(download_dir, &#39;release.MF&#39;))
              expected_manifest_hash = YAML.load(%q(---
compiled_packages:
- name: postgres
  version: postgres_version
  fingerprint: postgres_fingerprint
  sha1: postgrescompiledpackagesha1
  stemcell: ubuntu/1
  dependencies:
  - ruby
- name: ruby
  version: ruby_version
  fingerprint: ruby_fingerprint
  sha1: rubycompiledpackagesha1
  stemcell: ubuntu/1
  dependencies: []
jobs:
- name: foobar
  version: foo_version
  fingerprint: foobar_fingerprint
  sha1: foo_sha1
- name: foobaz
  version: foo_version
  fingerprint: foobaz_fingerprint
  sha1: foo_sha1
- name: foofoo
  version: foo_version
  fingerprint: foofoo_fingerprint
  sha1: foo_sha1
commit_hash: unknown
uncommitted_changes: false
name: bosh-release
version: 0.1-dev
))

              File.write(output_path, &#39;Some glorious content&#39;)

              expect(manifest_hash[&#39;compiled_packages&#39;]).to match_array(expected_manifest_hash[&#39;compiled_packages&#39;])
              expect(manifest_hash[&#39;jobs&#39;]).to match_array(expected_manifest_hash[&#39;jobs&#39;])

              manifest_hash.delete(&#39;compiled_packages&#39;)
              expected_manifest_hash.delete(&#39;compiled_packages&#39;)
              manifest_hash.delete(&#39;jobs&#39;)
              expected_manifest_hash.delete(&#39;jobs&#39;)

              expect(manifest_hash).to eq(expected_manifest_hash)
            }

            allow(blobstore_client).to receive(:get)
            allow(blobstore_client).to receive(:create).and_return(&#39;blobstore_id&#39;)

            job.perform
          end
        end

        context &#39;when an empty list of jobs are specified&#39; do
          let(:deployment_manifest) { Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups }
          let(:options) do
            {
              &#39;jobs&#39; =&gt; [],
            }
          end

          it &#39;should contain all jobs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::context(when an empty list of jobs are specified)::it#should contain all jobs has a flog score of 92</span>          </div>  </li></ol>
            allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
              files = Dir.entries(download_dir)
              expect(files).to include(&#39;compiled_packages&#39;, &#39;release.MF&#39;, &#39;jobs&#39;)

              files = Dir.entries(File.join(download_dir, &#39;compiled_packages&#39;))
              expect(files).to include(&#39;postgres.tgz&#39;)

              files = Dir.entries(File.join(download_dir, &#39;jobs&#39;))
              expect(files).to contain_exactly(&#39;.&#39;, &#39;..&#39;, &#39;foobaz.tgz&#39;, &#39;foobar.tgz&#39;, &#39;foofoo.tgz&#39;)

              File.write(output_path, &#39;Some glorious content&#39;)
            }

            expect(blobstore_client).to receive(:create).and_return(&#39;blobstore_id&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;ruby_compiled_package_blobstore_id&#39;, anything, sha1: &#39;rubycompiledpackagesha1&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;postgres_package_blobstore_id&#39;, anything, sha1: &#39;postgrescompiledpackagesha1&#39;)
            allow(blobstore_client).to receive(:get)
            job.perform
          end
        end

        context &#39;when specific jobs are specified&#39; do
          let(:deployment_manifest) { Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups }

          let(:options) do
            {
              &#39;jobs&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;foobaz&#39; }],
            }
          end

          it &#39;should contain only specified jobs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::context(when specific jobs are specified)::it#should contain only specified jobs has a flog score of 103</span>          </div>  </li></ol>
            allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
              files = Dir.entries(download_dir)
              expect(files).to include(&#39;compiled_packages&#39;, &#39;release.MF&#39;, &#39;jobs&#39;)

              files = Dir.entries(File.join(download_dir, &#39;compiled_packages&#39;))
              expect(files).to include(&#39;postgres.tgz&#39;)

              files = Dir.entries(File.join(download_dir, &#39;jobs&#39;))
              expect(files).to include(&#39;foobaz.tgz&#39;)
              expect(files).not_to include(&#39;foobar.tgz&#39;, &#39;foofoo.tgz&#39;)

              File.write(output_path, &#39;Some glorious content&#39;)
            }

            expect(blobstore_client).to receive(:create).and_return(&#39;blobstore_id&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;ruby_compiled_package_blobstore_id&#39;, anything, sha1: &#39;rubycompiledpackagesha1&#39;)
            expect(blobstore_client).to receive(:get).with(&#39;postgres_package_blobstore_id&#39;, anything, sha1: &#39;postgrescompiledpackagesha1&#39;)
            allow(blobstore_client).to receive(:get)
            job.perform
          end

          it &#39;creates a manifest file that contains the sha1, fingerprint and blobstore_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="export_release_spec.html#L358" class="js-smell-location">0</a>                  <a href="export_release_spec.html#L476" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::context(when specific jobs are specified)::it#creates a manifest file that contains the sha1, fingerprint and blobstore_id has a flog score of 77</span>          </div>  </li></ol>
            allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
              manifest_hash = YAML.load_file(File.join(download_dir, &#39;release.MF&#39;))
              expected_manifest_hash = YAML.load(%q(---
compiled_packages:
- name: postgres
  version: postgres_version
  fingerprint: postgres_fingerprint
  sha1: postgrescompiledpackagesha1
  stemcell: ubuntu/1
  dependencies:
  - ruby
- name: ruby
  version: ruby_version
  fingerprint: ruby_fingerprint
  sha1: rubycompiledpackagesha1
  stemcell: ubuntu/1
  dependencies: []
jobs:
- name: foobaz
  version: foo_version
  fingerprint: foobaz_fingerprint
  sha1: foo_sha1
commit_hash: unknown
uncommitted_changes: false
name: bosh-release
version: 0.1-dev
))

              File.write(output_path, &#39;Some glorious content&#39;)

              expect(manifest_hash[&#39;compiled_packages&#39;]).to match_array(expected_manifest_hash[&#39;compiled_packages&#39;])
              expect(manifest_hash[&#39;jobs&#39;]).to match_array(expected_manifest_hash[&#39;jobs&#39;])

              manifest_hash.delete(&#39;compiled_packages&#39;)
              expected_manifest_hash.delete(&#39;compiled_packages&#39;)
              manifest_hash.delete(&#39;jobs&#39;)
              expected_manifest_hash.delete(&#39;jobs&#39;)

              expect(manifest_hash).to eq(expected_manifest_hash)
            }

            allow(blobstore_client).to receive(:get)
            allow(blobstore_client).to receive(:create).and_return(&#39;blobstore_id&#39;)

            job.perform
          end
        end

        it &#39;should put a tarball in the blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::it#should put a tarball in the blobstore has a flog score of 30</span>          </div>  </li></ol>
          allow(blobstore_client).to receive(:get)
          allow(blobstore_client).to receive(:create).and_return(&quot;77da2388-ecf7-4cf6-be52-b054a07ea307&quot;)
          allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
             File.write(output_path, &#39;Some glorious content&#39;)
           }

          job.perform
        end

        it &#39;should calculate the digest of the generated archive using the sha1 algorithm by default&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="export_release_spec.html#L535" class="js-smell-location">0</a>                  <a href="export_release_spec.html#L550" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::it#should calculate the digest of the generated archive using the sha1 algorithm by default has a flog score of 44</span>          </div>  </li></ol>
          expected_blobstore_id = &#39;77da2388-ecf7-4cf6-be52-b054a07ea307&#39;

          allow(blobstore_client).to receive(:get)
          allow(blobstore_client).to receive(:create).and_return(expected_blobstore_id)
          allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
            File.write(output_path, &#39;Some glorious content&#39;)
            expect(multi_digest).to receive(:create).with([&#39;sha1&#39;], output_path).and_return(&#39;expected-sha1&#39;)
          }

          job.perform
        end

        context &#39;when the sha2 constructor arg is truthy&#39; do
          let(:sha2) { &quot;true&quot; }
          it &#39;should calculate the digest of the generated archive using the sha256 algorithm when sha2&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="export_release_spec.html#L535" class="js-smell-location">0</a>                  <a href="export_release_spec.html#L550" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::context(when the sha2 constructor arg is truthy)::it#should calculate the digest of the generated archive using the sha256 algorithm when sha2 has a flog score of 47</span>          </div>  </li></ol>
            expected_blobstore_id = &#39;77da2388-ecf7-4cf6-be52-b054a07ea307&#39;

            allow(blobstore_client).to receive(:get)
            allow(blobstore_client).to receive(:create).and_return(expected_blobstore_id)
            allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
              File.write(output_path, &#39;Some glorious content&#39;)
              expect(multi_digest).to receive(:create).with([&#39;sha256&#39;], output_path).and_return(&#39;expected-sha2&#39;)
            }

            job.perform
          end
        end

        context &#39;that is successfully placed in the blobstore&#39; do
          it &#39;should record the blobstore id of the created tarball in the blobs table&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::context(with a valid deployment targeted)::context(when creating a tarball)::context(that is successfully placed in the blobstore)::it#should record the blobstore id of the created tarball in the blobs table has a flog score of 64</span>          </div>  </li></ol>
            expected_blobstore_id = &#39;77da2388-ecf7-4cf6-be52-b054a07ea307&#39;

            allow(blobstore_client).to receive(:get)
            allow(blobstore_client).to receive(:create).and_return(expected_blobstore_id)
            allow(archiver).to receive(:compress) { |download_dir, sources, output_path|
              File.write(output_path, &#39;Some glorious content&#39;)
            }

            expect {
              job.perform
            }.to change(Bosh::Director::Models::Blob, :count).from(0).to(1)

            exported_release_blob = Bosh::Director::Models::Blob.first
            expect(exported_release_blob.blobstore_id).to eq(expected_blobstore_id)
            expect(exported_release_blob.sha1).to eq(&#39;expected-sha1&#39;)
            expect(exported_release_blob.type).to eq(&#39;exported-release&#39;)
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
