<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 16:57:24 +0200'>2018-06-22 16:57:24 +0200</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/unit/api/controllers /</small> deployments_controller_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">2510</span><small> lines of codes</small></div>
              <div><span class="metric">7</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">785.3</span><small> complexity/method</small></div>
              <div><span class="metric">158</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">5497.05</span><small> complexity</small></div>
              <div><span class="metric">2451</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                125
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;rack/test&#39;

module Bosh::Director
  module Api<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::Api has no descriptive comment</span>          </div>  </li></ol>
    describe Controllers::DeploymentsController do
      include IpUtil
      include Rack::Test::Methods

      subject(:app) { linted_rack_app(described_class.new(config)) }

      let(:config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 15 nodes</span>              <span>Locations:</span>                  <a href="cloud_configs_controller_spec.html#L10" class="js-smell-location">0</a>                  <a href="configs_controller_spec.html#L10" class="js-smell-location">1</a>                  <a href="cpi_configs_controller_spec.html#L10" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L12" class="js-smell-location">3</a>                  <a href="jobs_controller_spec.html#L10" class="js-smell-location">4</a>                  <a href="link_address_controller_spec.html#L10" class="js-smell-location">5</a>                  <a href="link_consumers_controller_spec.html#L10" class="js-smell-location">6</a>                  <a href="link_providers_controller_spec.html#L10" class="js-smell-location">7</a>                  <a href="links_controller_spec.html#L10" class="js-smell-location">8</a>                  <a href="locks_controller_spec.html#L10" class="js-smell-location">9</a>                  <a href="releases_controller_spec.html#L10" class="js-smell-location">10</a>                  <a href="runtime_configs_controller_spec.html#L10" class="js-smell-location">11</a>                  <a href="stemcells_controller_spec.html#L9" class="js-smell-location">12</a>                  <a href="tasks_controller_spec.html#L19" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L9" class="js-smell-location">14</a>                  </div>  </li></ol>
        config = Config.load_hash(SpecHelper.spec_get_director_config)
        identity_provider = Support::TestIdentityProvider.new(config.get_uuid_provider)
        allow(config).to receive(:identity_provider).and_return(identity_provider)
        config
      end

      def manifest_with_errand_hash(deployment_name=&#39;errand&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::Api#manifest_with_errand_hash doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
        manifest_hash = Bosh::Spec::NewDeployments.manifest_with_errand
        manifest_hash[&#39;name&#39;] = deployment_name
        manifest_hash[&#39;instance_groups&#39;] &lt;&lt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L22" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1772" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;name&#39; =&gt; &#39;another-errand&#39;,
          &#39;jobs&#39; =&gt; [{&#39;name&#39; =&gt; &#39;errand1&#39;}],
          &#39;stemcell&#39; =&gt; &#39;default&#39;,
          &#39;lifecycle&#39; =&gt; &#39;errand&#39;,
          &#39;vm_type&#39; =&gt; &#39;a&#39;,
          &#39;instances&#39; =&gt; 1,
          &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;a&#39;}]
        }
        manifest_hash
      end

      def manifest_with_errand(deployment_name=&#39;errand&#39;)
        YAML.dump(manifest_with_errand_hash(deployment_name))
      end

      let(:cloud_config) { Models::Config.make(:cloud_with_manifest) }
      let (:time) {Time.now}

      before do
        App.new(config)
        basic_authorize &#39;admin&#39;, &#39;admin&#39;
      end

      describe &#39;the date header&#39; do
        it &#39;is present&#39; do
          basic_authorize &#39;reader&#39;, &#39;reader&#39;
          get &#39;/&#39;
          expect(last_response.headers[&#39;Date&#39;]).to be
        end
      end

      describe &#39;API calls&#39; do
        describe &#39;creating a deployment&#39; do
          context &#39;authenticated access&#39; do
            it &#39;expects compressed deployment file&#39; do
              post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
              expect_redirect_to_queued_task(last_response)
            end

            it &#39;accepts a context ID header&#39; do
              context_id = &#39;example-context-id&#39;
              header(&#39;X-Bosh-Context-Id&#39;, context_id)
              post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
              task = expect_redirect_to_queued_task(last_response)
              expect(task.context_id).to eq(context_id)
            end

            it &#39;defaults to no context ID&#39; do
              post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
              task = expect_redirect_to_queued_task(last_response)
              expect(task.context_id).to eq(&#39;&#39;)
            end

            it &#39;only consumes text/yaml&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L76" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L301" class="js-smell-location">1</a>                  </div>  </li></ol>
              post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/plain&#39;}
              expect(last_response.status).to eq(404)
            end

            it &#39;gives a nice error when request body is not a valid yml&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::it#gives a nice error when request body is not a valid yml has a flog score of 46</span>          </div>  </li></ol>
              post &#39;/&#39;, &quot;}}}i&#39;m not really yaml, hah!&quot;, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

              expect(last_response.status).to eq(400)
              expect(JSON.parse(last_response.body)[&#39;code&#39;]).to eq(440001)
              expect(JSON.parse(last_response.body)[&#39;description&#39;]).to include(&#39;Incorrect YAML structure of the uploaded manifest: &#39;)
            end

            it &#39;gives a nice error when request body is empty&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="cloud_configs_controller_spec.html#L60" class="js-smell-location">0</a>                  <a href="cloud_configs_controller_spec.html#L258" class="js-smell-location">1</a>                  <a href="cpi_configs_controller_spec.html#L60" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L89" class="js-smell-location">3</a>                  <a href="runtime_configs_controller_spec.html#L57" class="js-smell-location">4</a>                  <a href="runtime_configs_controller_spec.html#L309" class="js-smell-location">5</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::it#gives a nice error when request body is empty has a flog score of 27</span>          </div>  </li></ol>
              post &#39;/&#39;, &#39;&#39;, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

              expect(last_response.status).to eq(400)
              expect(JSON.parse(last_response.body)).to eq(
                &#39;code&#39; =&gt; 440001,
                &#39;description&#39; =&gt; &#39;Manifest should not be empty&#39;,
              )
            end

            it &#39;gives a nice error when deployment manifest does not have a name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::it#gives a nice error when deployment manifest does not have a name has a flog score of 29</span>          </div>  </li></ol>
              post &#39;/&#39;, YAML.dump({}), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

              expect(last_response.status).to eq(400)
              expect(JSON.parse(last_response.body)).to eq(
                &#39;code&#39; =&gt; 40001,
                &#39;description&#39; =&gt; &quot;Deployment manifest must have a &#39;name&#39; key&quot;,
              )
              end

            it &#39;gives a nice error when deployment manifest is not a Hash&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::it#gives a nice error when deployment manifest is not a Hash has a flog score of 29</span>          </div>  </li></ol>
              post &#39;/&#39;, YAML.dump(true), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

              expect(last_response.status).to eq(400)
              expect(JSON.parse(last_response.body)).to eq(
                &#39;code&#39; =&gt; 440001,
                &#39;description&#39; =&gt; &#39;Manifest should be a hash&#39;,
              )
            end

            context &#39;when provided cloud configs and runtime configs context to work within&#39; do
              it &#39;should use the provided context instead of using the latest runtime and cloud config&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(when provided cloud configs and runtime configs context to work within)::it#should use the provided context instead of using the latest runtime and cloud config has a flog score of 56</span>          </div>  </li></ol>
                cloud_config = Models::Config.make(:cloud_with_manifest)
                runtime_config1 = Models::Config.make(type: &#39;runtime&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'runtime_config1'</span>          </div>  </li></ol>
                runtime_config2 = Models::Config.make(type: &#39;runtime&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'runtime_config2'</span>          </div>  </li></ol>

                Models::Config.make(:cloud_with_manifest)
                Models::Config.make(type: &#39;runtime&#39;)

                deployment_context = [[
                  &#39;context&#39;,
                  JSON.dump(
                    &#39;cloud_config_ids&#39; =&gt; [cloud_config.id],
                    &#39;runtime_config_ids&#39; =&gt; [runtime_config1.id, runtime_config2.id],
                  ),
                ]]

                expect_any_instance_of(DeploymentManager)
                  .to receive(:create_deployment)
                  .with(
                    anything,
                    anything,
                    [cloud_config],
                    a_collection_containing_exactly(runtime_config1, runtime_config2),
                    anything,
                    anything,
                    anything,
                  ).and_return(Models::Task.make)

                post &quot;/?#{URI.encode_www_form(deployment_context)}&quot;, spec_asset(&#39;test_conf.yaml&#39;), &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;
                expect_redirect_to_queued_task(last_response)
              end

              context &#39;with an authorized team&#39; do
                before { basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39; }

                let(:runtime_config_1) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}) }
                let(:runtime_config_2) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}) }
                let(:runtime_config_3) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}, name: &#39;smurf&#39;) }
                let(:cloud_config) { Models::Config.make(:cloud, raw_manifest: {&#39;azs&#39; =&gt; []}) }

                let(:dev_team) { Models::Team.make(name: &#39;dev&#39;) }
                let(:other_team) { Models::Team.make(name: &#39;other&#39;) }

                let!(:dev_runtime_config) { Models::Config.make(name: &#39;dev-runtime&#39;, type: &#39;runtime&#39;, team_id: dev_team.id) }
                let!(:other_runtime_config) { Models::Config.make(name: &#39;other-runtime&#39;, type: &#39;runtime&#39;, team_id: other_team.id) }

                let!(:dev_cloud_config) { Models::Config.make(name: &#39;dev-cloud&#39;, type: &#39;cloud&#39;, team_id: dev_team.id) }
                let!(:other_cloud_config) { Models::Config.make(name: &#39;other-cloud&#39;, type: &#39;cloud&#39;, team_id: other_team.id) }

                it &#39;should error if the user references a cloud config from another team&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(when provided cloud configs and runtime configs context to work within)::context(with an authorized team)::it#should error if the user references a cloud config from another team has a flog score of 36</span>          </div>  </li></ol>
                  deployment_context = [[&#39;context&#39;, JSON.dump({&#39;cloud_config_ids&#39; =&gt; [dev_cloud_config.id, other_cloud_config.id], &#39;runtime_config_ids&#39; =&gt; []})]]

                  response = post &quot;/?#{URI.encode_www_form(deployment_context)}&quot;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                  expect(response.status).to eq(400)
                  expect(response.body).to match(/Context includes invalid config ID/)
                end

                it &#39;should error if the user references a runtime config from another team&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(when provided cloud configs and runtime configs context to work within)::context(with an authorized team)::it#should error if the user references a runtime config from another team has a flog score of 36</span>          </div>  </li></ol>
                  deployment_context = [[&#39;context&#39;, JSON.dump({&#39;cloud_config_ids&#39; =&gt; [], &#39;runtime_config_ids&#39; =&gt; [dev_runtime_config.id, other_runtime_config.id]})]]

                  response = post &quot;/?#{URI.encode_www_form(deployment_context)}&quot;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                  expect(response.status).to eq(400)
                  expect(response.body).to match(/Context includes invalid config ID/)
                end

                it &#39;should accept global and team-specific cloud and runtime configs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(when provided cloud configs and runtime configs context to work within)::context(with an authorized team)::it#should accept global and team-specific cloud and runtime configs has a flog score of 78</span>          </div>  </li></ol>
                  deployment_context = [[&#39;context&#39;, JSON.dump({&#39;cloud_config_ids&#39; =&gt; [cloud_config.id, dev_cloud_config.id], &#39;runtime_config_ids&#39; =&gt; [runtime_config_3.id, dev_runtime_config.id]})]]

                  expect_any_instance_of(DeploymentManager)
                    .to receive(:create_deployment)
                          .with(
                            anything,
                            anything,
                            contain_exactly(cloud_config, dev_cloud_config),
                            contain_exactly(runtime_config_3, dev_runtime_config),
                            anything,
                            anything,
                            anything
                          )
                          .and_return(Models::Task.make)

                  response = post &quot;/?#{URI.encode_www_form(deployment_context)}&quot;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

                  expect(response.status).to eq(302)
                end
              end
            end

            context &#39;when using cloud config and runtime config&#39; do
              it &#39;should persist these relations when persisting the deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(when using cloud config and runtime config)::it#should persist these relations when persisting the deployment has a flog score of 30</span>          </div>  </li></ol>
                cloud_config = Models::Config.make(:cloud_with_manifest)
                runtime_config = Models::Config.make(type: &#39;runtime&#39;)

                post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

                expect_redirect_to_queued_task(last_response)
                deployment = Models::Deployment.first
                expect(deployment.cloud_configs).to contain_exactly(cloud_config)
                expect(deployment.runtime_configs).to contain_exactly(runtime_config)
              end
            end

            context &#39;when doing a deploy with dry-run&#39; do
              it &#39;should queue a dry run task&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(when doing a deploy with dry-run)::it#should queue a dry run task has a flog score of 34</span>          </div>  </li></ol>
                expect(Models::Task.all).to be_empty

                post &#39;/?dry_run=true&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

                expect_redirect_to_queued_task(last_response)

                expect(Models::Task.count).to eq(1)
                expect(Models::Task.first.description).to eq(&#39;create deployment (dry run)&#39;)
              end
            end

            context &#39;no existing context provided&#39; do
              let(:runtime_config_1) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}) }
              let(:runtime_config_2) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}) }
              let(:runtime_config_3) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}, name: &#39;smurf&#39;) }
              let(:cloud_config) { Models::Config.make(:cloud, raw_manifest: {&#39;azs&#39; =&gt; []}) }

              let(:dev_team) { Models::Team.make(name: &#39;dev&#39;) }
              let(:other_team) { Models::Team.make(name: &#39;other&#39;) }

              let!(:dev_runtime_config) { Models::Config.make(name: &#39;dev-runtime&#39;, type: &#39;runtime&#39;, team_id: dev_team.id) }
              let!(:other_runtime_config) { Models::Config.make(name: &#39;other-runtime&#39;, type: &#39;runtime&#39;, team_id: other_team.id) }

              let!(:dev_cloud_config) { Models::Config.make(name: &#39;dev-cloud&#39;, type: &#39;cloud&#39;, team_id: dev_team.id) }
              let!(:other_cloud_config) { Models::Config.make(name: &#39;other-cloud&#39;, type: &#39;cloud&#39;, team_id: other_team.id) }

              context &#39;with team-specific user&#39; do
                before { basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39; }

                it &#39;filter cloud and runtime configs for team&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L253" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L276" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(no existing context provided)::context(with team-specific user)::it#filter cloud and runtime configs for team has a flog score of 59</span>          </div>  </li></ol>
                  expect_any_instance_of(DeploymentManager)
                    .to receive(:create_deployment)
                          .with(
                            anything,
                            anything,
                            a_collection_containing_exactly(dev_cloud_config, cloud_config),
                            a_collection_containing_exactly(dev_runtime_config, runtime_config_2, runtime_config_3),
                            anything,
                            anything,
                            anything
                          )
                          .and_return(Models::Task.make)

                  response = post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

                  expect(response.status).to eq(302)
                end
              end

              context &#39;existing team deployment&#39; do
                let!(:deployment) { Models::Deployment.make(name: &#39;deployment-name&#39;).tap { |d| d.teams = [dev_team] } }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'd'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L274" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L424" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2043" class="js-smell-location">2</a>                  </div>  </li></ol>

                it &#39;uses the teams of the existing deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L253" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L276" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(creating a deployment)::context(authenticated access)::context(no existing context provided)::context(existing team deployment)::it#uses the teams of the existing deployment has a flog score of 59</span>          </div>  </li></ol>
                  expect_any_instance_of(DeploymentManager)
                    .to receive(:create_deployment)
                          .with(
                            anything,
                            anything,
                            contain_exactly(dev_cloud_config, cloud_config),
                            contain_exactly(dev_runtime_config, runtime_config_2, runtime_config_3),
                            anything,
                            anything,
                            anything
                          )
                          .and_return(Models::Task.make)

                  response = post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

                  expect(response.status).to eq(302)
                end
              end
            end
          end

          context &#39;accessing with invalid credentials&#39; do
            before { authorize &#39;invalid-user&#39;, &#39;invalid-password&#39; }

            it &#39;returns 401&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L76" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L301" class="js-smell-location">1</a>                  </div>  </li></ol>
              post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
              expect(last_response.status).to eq(401)
            end
          end
        end

        describe &#39;updating a deployment&#39; do
          let!(:deployment) { Models::Deployment.create(:name =&gt; &#39;my-test-deployment&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;})) }

          context &#39;without the &quot;skip_drain&quot; param&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L311" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L355" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;does not skip draining&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(updating a deployment)::context(without the "skip_drain" param)::it#does not skip draining has a flog score of 39</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager)
                .to receive(:create_deployment)
                .with(anything(), anything(), anything(), anything(), anything(), hash_excluding(&#39;skip_drain&#39;), anything())
                .and_return(OpenStruct.new(:id =&gt; 1))
              post &#39;/&#39;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect(last_response).to be_redirect
            end
          end

          context &#39;with the &quot;skip_drain&quot; param as &quot;*&quot;&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L322" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L333" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;skips draining&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(updating a deployment)::context(with the "skip_drain" param as "*")::it#skips draining has a flog score of 39</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager)
                .to receive(:create_deployment)
                .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;skip_drain&#39; =&gt; &#39;*&#39;),  anything())
                .and_return(OpenStruct.new(:id =&gt; 1))
              post &#39;/?skip_drain=*&#39;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect(last_response).to be_redirect
            end
          end

          context &#39;with the &quot;skip_drain&quot; param as &quot;job_one,job_two&quot;&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L322" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L333" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;skips draining&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(updating a deployment)::context(with the "skip_drain" param as "job_one,job_two")::it#skips draining has a flog score of 39</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager)
                .to receive(:create_deployment)
                .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;skip_drain&#39; =&gt; &#39;job_one,job_two&#39;), anything())
                .and_return(OpenStruct.new(:id =&gt; 1))
              post &#39;/?skip_drain=job_one,job_two&#39;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect(last_response).to be_redirect
            end
          end

          context &#39;with the &quot;fix&quot; param&#39; do
            it &#39;passes the parameter&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(updating a deployment)::context(with the "fix" param)::it#passes the parameter has a flog score of 39</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L346" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L376" class="js-smell-location">1</a>                  </div>  </li></ol>
                .to receive(:create_deployment)
                .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;fix&#39; =&gt; true), anything())
                .and_return(OpenStruct.new(:id =&gt; 1))
              post &#39;/?fix=true&#39;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
              expect(last_response).to be_redirect
            end
          end

          context &#39;updates using a manifest with deployment name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L311" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L355" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;calls create deployment with deployment name&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(updating a deployment)::context(updates using a manifest with deployment name)::it#calls create deployment with deployment name has a flog score of 39</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager)
                  .to receive(:create_deployment)
                          .with(anything(), anything(), anything(), anything(), deployment, hash_excluding(&#39;skip_drain&#39;), anything())
                          .and_return(OpenStruct.new(:id =&gt; 1))
              post &#39;/&#39;, spec_asset(&#39;test_manifest.yml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect(last_response).to be_redirect
            end
          end

          context &#39;sets `new` option&#39; do
            it &#39;to false&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(updating a deployment)::context(sets `new` option)::it#to false has a flog score of 34</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager)
                  .to receive(:create_deployment)
                          .with(anything(), anything(), anything(), anything(), deployment, hash_including(&#39;new&#39; =&gt; false), anything())
                          .and_return(OpenStruct.new(:id =&gt; 1))
              post &#39;/&#39;, spec_asset(&#39;test_manifest.yml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
            end

            it &#39;to true&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(updating a deployment)::context(sets `new` option)::it#to true has a flog score of 37</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L346" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L376" class="js-smell-location">1</a>                  </div>  </li></ol>
                  .to receive(:create_deployment)
                          .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;new&#39; =&gt; true), anything())
                          .and_return(OpenStruct.new(:id =&gt; 1))
               Models::Deployment.first.delete
              post &#39;/&#39;, spec_asset(&#39;test_manifest.yml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
            end
          end
        end

        describe &#39;deleting deployment&#39; do
          it &#39;deletes the deployment&#39; do
            deployment = Models::Deployment.create(:name =&gt; &#39;test_deployment&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))

            delete &#39;/test_deployment&#39;
            expect_redirect_to_queued_task(last_response)
          end

          it &#39;accepts a context id&#39; do
            context_id = &#39;example-context-id&#39;
            deployment = Models::Deployment.create(:name =&gt; &#39;test_deployment&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))

            header(&#39;X-Bosh-Context-Id&#39;, context_id)
            delete &#39;/test_deployment&#39;

            task = expect_redirect_to_queued_task(last_response)
            expect(task.context_id).to eq(context_id)
          end
        end

        describe &#39;job management&#39; do
          context &#39;when team-authorized&#39; do
            before do
              basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39;
              Models::Config.make(name: &#39;other-runtime&#39;, type: &#39;runtime&#39;, team_id: other_team.id)
              Models::Config.make(name: &#39;other-cloud&#39;, type: &#39;cloud&#39;, team_id: other_team.id)
              Models::PersistentDisk.create(instance: instance, disk_cid: &#39;disk_cid&#39;)
            end

            let!(:runtime_config) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}) }
            let!(:cloud_config) { Models::Config.make(:cloud, raw_manifest: {&#39;azs&#39; =&gt; []}) }

            let!(:dev_team) { Models::Team.make(name: &#39;dev&#39;) }
            let!(:dev_runtime_config) { Models::Config.make(name: &#39;dev-runtime&#39;, type: &#39;runtime&#39;, team_id: dev_team.id) }
            let!(:dev_cloud_config) { Models::Config.make(name: &#39;dev-cloud&#39;, type: &#39;cloud&#39;, team_id: dev_team.id) }
            let!(:other_team) { Models::Team.make(name: &#39;other&#39;) }

            let!(:deployment) do
              Models::Deployment.make(name: &#39;foo&#39;, manifest: YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;})).tap { |d| d.teams = [dev_team] }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'd'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L274" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L424" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2043" class="js-smell-location">2</a>                  </div>  </li></ol>
            end

            let!(:instance) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L427" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L731" class="js-smell-location">1</a>                  </div>  </li></ol>
              Models::Instance.make(
                deployment: deployment,
                job: &#39;dea&#39;,
                index: &#39;2&#39;,
                uuid: &#39;0B949287-CDED-4761-9002-FC4035E11B21&#39;,
                state: &#39;started&#39;,
                :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
              )
            end

            it &#39;uses the correct configs when updating instance groups&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L438" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L453" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::context(when team-authorized)::it#uses the correct configs when updating instance groups has a flog score of 45</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager).to receive(:create_deployment).
                with(
                  anything,
                  anything,
                  contain_exactly(cloud_config, dev_cloud_config),
                  contain_exactly(runtime_config, dev_runtime_config),
                  deployment,
                  anything,
                ).and_return(Models::Task.make)

              put &#39;/foo/jobs/*?state=stopped&#39;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect_redirect_to_queued_task(last_response)
            end

            it &#39;uses the correct configs when updating an instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L438" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L453" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::context(when team-authorized)::it#uses the correct configs when updating an instance has a flog score of 45</span>          </div>  </li></ol>
              expect_any_instance_of(DeploymentManager).to receive(:create_deployment).
                with(
                  anything,
                  anything,
                  contain_exactly(cloud_config, dev_cloud_config),
                  contain_exactly(runtime_config, dev_runtime_config),
                  deployment,
                  anything,
                ).and_return(Models::Task.make)

              put &#39;/foo/jobs/dea/0B949287-CDED-4761-9002-FC4035E11B21?state=stopped&#39;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect_redirect_to_queued_task(last_response)
            end
          end

          shared_examples &#39;change state&#39; do
            it &#39;allows to change state&#39; do
              deployment = Models::Deployment.create(name: &#39;foo&#39;, manifest: YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
              instance = Models::Instance.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L472" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L494" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L669" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L695" class="js-smell-location">3</a>                  </div>  </li></ol>
                deployment: deployment,
                job: &#39;dea&#39;,
                index: &#39;2&#39;,
                uuid: &#39;0B949287-CDED-4761-9002-FC4035E11B21&#39;,
                state: &#39;started&#39;,
                :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
              )
              Models::PersistentDisk.create(instance: instance, disk_cid: &#39;disk_cid&#39;)
              put &quot;#{path}&quot;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect_redirect_to_queued_task(last_response)
            end

            it &#39;allows to change state with content_length of 0&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::shared_examples(change state)::it#allows to change state with content_length of 0 has a flog score of 59</span>          </div>  </li></ol>
              RSpec::Matchers.define :not_to_have_body do |unexpected|
                match { |actual| actual != unexpected }
              end
              manifest = spec_asset(&#39;test_conf.yaml&#39;)
              expect_any_instance_of(DeploymentManager).to receive(:create_deployment).
                  with(anything(), not_to_have_body(manifest), anything(), anything(), anything(), anything()).
                  and_return(OpenStruct.new(:id =&gt; &#39;no_content_length&#39;))
              deployment = Models::Deployment.create(name: &#39;foo&#39;, manifest: YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
              instance = Models::Instance.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L472" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L494" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L669" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L695" class="js-smell-location">3</a>                  </div>  </li></ol>
                deployment: deployment,
                job: &#39;dea&#39;,
                index: &#39;2&#39;,
                uuid: &#39;0B949287-CDED-4761-9002-FC4035E11B21&#39;,
                state: &#39;started&#39;,
                variable_set: Models::VariableSet.create(deployment: deployment)
              )
              Models::PersistentDisk.create(instance: instance, disk_cid: &#39;disk_cid&#39;)
              put &quot;#{path}&quot;, manifest, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;, &#39;CONTENT_LENGTH&#39; =&gt; &#39;0&#39;}
              match = last_response.location.match(%r{/tasks/no_content_length})
              expect(match).to_not be_nil
            end

            it &#39;should return 404 if the manifest cannot be found&#39; do
              put &quot;#{path}&quot;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect(last_response.status).to eq(404)
            end
          end

          context &#39;for all jobs in deployment&#39; do
            let (:path) { &#39;/foo/jobs/*?state=stopped&#39; }
            it_behaves_like &#39;change state&#39;
          end
          context &#39;for one job in deployment&#39; do
            let (:path) { &#39;/foo/jobs/dea?state=stopped&#39; }
            it_behaves_like &#39;change state&#39;
          end
          context &#39;for job instance in deployment by index&#39; do
            let (:path) { &#39;/foo/jobs/dea/2?state=stopped&#39; }
            it_behaves_like &#39;change state&#39;
          end
          context &#39;for job instance in deployment by id&#39; do
            let (:path) { &#39;/foo/jobs/dea/0B949287-CDED-4761-9002-FC4035E11B21?state=stopped&#39; }
            it_behaves_like &#39;change state&#39;
          end

          let(:deployment) do
            Models::Deployment.create(name: &#39;foo&#39;, manifest: YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
          end

          it &#39;allows putting the job instance into different resurrection_paused values&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::it#allows putting the job instance into different resurrection_paused values has a flog score of 31</span>          </div>  </li></ol>
            instance = Models::Instance.<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L536" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L560" class="js-smell-location">1</a>                  </div>  </li></ol>
                create(:deployment =&gt; deployment, :job =&gt; &#39;dea&#39;,
                       :index =&gt; &#39;0&#39;, :state =&gt; &#39;started&#39;, :variable_set =&gt; Models::VariableSet.create(deployment: deployment))
            put &#39;/foo/jobs/dea/0/resurrection&#39;, JSON.generate(&#39;resurrection_paused&#39; =&gt; true), { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }
            expect(last_response.status).to eq(200)
            expect(instance.reload.resurrection_paused).to be(true)
          end

          it &#39;allows putting the job instance into different ignore state&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::it#allows putting the job instance into different ignore state has a flog score of 61</span>          </div>  </li></ol>
            instance = Models::Instance.<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L545" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L588" class="js-smell-location">1</a>                  </div>  </li></ol>
                create(:deployment =&gt; deployment, :job =&gt; &#39;dea&#39;,
                       :index =&gt; &#39;0&#39;, :state =&gt; &#39;started&#39;, :uuid =&gt; &#39;0B949287-CDED-4761-9002-FC4035E11B21&#39;,
                       :variable_set =&gt; Models::VariableSet.create(deployment: deployment))
            expect(instance.ignore).to be(false)
            put &#39;/foo/instance_groups/dea/0B949287-CDED-4761-9002-FC4035E11B21/ignore&#39;, JSON.generate(&#39;ignore&#39; =&gt; true), { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }
            expect(last_response.status).to eq(200)
            expect(instance.reload.ignore).to be(true)

            put &#39;/foo/instance_groups/dea/0B949287-CDED-4761-9002-FC4035E11B21/ignore&#39;, JSON.generate(&#39;ignore&#39; =&gt; false), { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }
            expect(last_response.status).to eq(200)
            expect(instance.reload.ignore).to be(false)
          end

          it &#39;gives a nice error when uploading non valid manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::it#gives a nice error when uploading non valid manifest has a flog score of 51</span>          </div>  </li></ol>
            instance = Models::Instance.<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L536" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L560" class="js-smell-location">1</a>                  </div>  </li></ol>
                create(:deployment =&gt; deployment, :job =&gt; &#39;dea&#39;,
                       :index =&gt; &#39;0&#39;, :state =&gt; &#39;started&#39;, :variable_set =&gt; Models::VariableSet.create(deployment: deployment))

            put &#39;/foo/jobs/dea&#39;, &quot;}}}i&#39;m not really yaml, hah!&quot;, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

            expect(last_response.status).to eq(400)
            expect(JSON.parse(last_response.body)[&#39;code&#39;]).to eq(440001)
            expect(JSON.parse(last_response.body)[&#39;description&#39;]).to include(&#39;Incorrect YAML structure of the uploaded manifest: &#39;)
          end

          it &#39;should not validate body content when content.length is zero&#39; do
            Models::Instance.
                create(:deployment =&gt; deployment, :job =&gt; &#39;dea&#39;,
                       :index =&gt; &#39;0&#39;, :state =&gt; &#39;started&#39;, :variable_set =&gt; Models::VariableSet.create(deployment: deployment))

            put &#39;/foo/jobs/dea/0?state=started&#39;, &quot;}}}i&#39;m not really yaml, hah!&quot;, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;, &#39;CONTENT_LENGTH&#39; =&gt; &#39;0&#39;}

            expect(last_response.status).to eq(302)
          end

          it &#39;returns a &quot;bad request&quot; if index_or_id parameter of a PUT is neither a number nor a string with uuid format&#39; do
            deployment
            put &#39;/foo/jobs/dea/snoopy?state=stopped&#39;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
            expect(last_response.status).to eq(400)
          end

          it &#39;can get job information&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::it#can get job information has a flog score of 34</span>          </div>  </li></ol>
            instance = Models::Instance.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L545" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L588" class="js-smell-location">1</a>                  </div>  </li></ol>
              deployment: deployment,
              job: &#39;nats&#39;,
              index: &#39;0&#39;,
              uuid: &#39;fake_uuid&#39;,
              state: &#39;started&#39;,
              :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
            )
            Models::PersistentDisk.create(instance: instance, disk_cid: &#39;disk_cid&#39;)

            get &#39;/foo/jobs/nats/0&#39;, {}

            expect(last_response.status).to eq(200)
            expected = {
                &#39;deployment&#39; =&gt; &#39;foo&#39;,
                &#39;job&#39; =&gt; &#39;nats&#39;,
                &#39;index&#39; =&gt; 0,
                &#39;id&#39; =&gt; &#39;fake_uuid&#39;,
                &#39;state&#39; =&gt; &#39;started&#39;,
                &#39;disks&#39; =&gt; %w[disk_cid]
            }

            expect(JSON.parse(last_response.body)).to eq(expected)
          end

          it &#39;should return 404 if the instance cannot be found&#39; do
            get &#39;/foo/jobs/nats/0&#39;, {}
            expect(last_response.status).to eq(404)
          end

          context &#39;with a &quot;canaries&quot; param&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L618" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L631" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;overrides the canaries value from the manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::context(with a "canaries" param)::it#overrides the canaries value from the manifest has a flog score of 39</span>          </div>  </li></ol>
              deployment
              expect_any_instance_of(DeploymentManager)
                .to receive(:create_deployment)
                  .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;canaries&#39;=&gt;&#39;42&#39;) )
                  .and_return(OpenStruct.new(:id =&gt; 1))

              put &#39;/foo/jobs/dea?canaries=42&#39;, JSON.generate(&#39;value&#39; =&gt; &#39;baz&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect(last_response).to be_redirect
            end
          end

          context &#39;with a &quot;max_in_flight&quot; param&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L618" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L631" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;overrides the &quot;max_in_flight&quot; value from the manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::context(with a "max_in_flight" param)::it#overrides the "max_in_flight" value from the manifest has a flog score of 39</span>          </div>  </li></ol>
              deployment
              expect_any_instance_of(DeploymentManager)
                .to receive(:create_deployment)
                      .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;max_in_flight&#39;=&gt;&#39;42&#39;) )
                      .and_return(OpenStruct.new(:id =&gt; 1))

              put &#39;/foo/jobs/dea?max_in_flight=42&#39;, JSON.generate(&#39;value&#39; =&gt; &#39;baz&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
              expect(last_response).to be_redirect
            end
          end

          context &#39;with a &quot;fix&quot; param&#39; do
            it &#39;passes the parameter&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::context(with a "fix" param)::it#passes the parameter has a flog score of 39</span>          </div>  </li></ol>
              deployment
              expect_any_instance_of(DeploymentManager)
                .to receive(:create_deployment)
                .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;fix&#39; =&gt; true))
                .and_return(OpenStruct.new(:id =&gt; 1))

              put &#39;/foo/jobs/dea?fix=true&#39;, JSON.generate(&#39;value&#39; =&gt; &#39;baz&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
              expect(last_response).to be_redirect
            end
          end

          describe &#39;recreating&#39; do
            shared_examples_for &#39;recreates with configs&#39; do
              it &#39;recreates with the latest configs if you send a manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::describe(recreating)::shared_examples_for(recreates with configs)::it#recreates with the latest configs if you send a manifest has a flog score of 63</span>          </div>  </li></ol>
                cc_old = Models::Config.create(:name =&gt; &#39;cc&#39;, :type =&gt;&#39;cloud&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;old-cc&#39;}))
                cc_new = Models::Config.create(:name =&gt; &#39;cc&#39;, :type =&gt;&#39;cloud&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;new-cc&#39;}))
                runtime_old = Models::Config.create(:name =&gt; &#39;runtime&#39;, :type =&gt;&#39;runtime&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;old-runtime&#39;}))
                runtime_new = Models::Config.create(:name =&gt; &#39;runtime&#39;, :type =&gt;&#39;runtime&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;new-runtime&#39;}))

                deployment = Models::Deployment.create(name: &#39;foo&#39;, manifest: YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
                deployment.cloud_configs = [cc_old]
                deployment.runtime_configs = [runtime_old]

                instance = Models::Instance.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L472" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L494" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L669" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L695" class="js-smell-location">3</a>                  </div>  </li></ol>
                  deployment: deployment,
                  job: &#39;dea&#39;,
                  index: &#39;2&#39;,
                  uuid: &#39;0B949287-CDED-4761-9002-FC4035E11B21&#39;,
                  state: &#39;started&#39;,
                  :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
                )
                expect_any_instance_of(DeploymentManager)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L677" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L703" class="js-smell-location">1</a>                  </div>  </li></ol>
                    .to receive(:create_deployment)
                            .with(anything(), anything(), [cc_new], [runtime_new], deployment, hash_including(options))
                            .and_return(OpenStruct.new(:id =&gt; 1))
                put &quot;#{path}&quot;, JSON.generate(&#39;value&#39; =&gt; &#39;baz&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                expect(last_response).to be_redirect
              end

              it &#39;recreates with the previous configs rather than the latest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::describe(recreating)::shared_examples_for(recreates with configs)::it#recreates with the previous configs rather than the latest has a flog score of 61</span>          </div>  </li></ol>
                cc_old = Models::Config.create(:name =&gt; &#39;cc&#39;, :type =&gt;&#39;cloud&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;old-cc&#39;}))
                cc_new = Models::Config.create(:name =&gt; &#39;cc&#39;, :type =&gt;&#39;cloud&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;new-cc&#39;}))
                runtime_old = Models::Config.create(:name =&gt; &#39;runtime&#39;, :type =&gt;&#39;runtime&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;old-runtime&#39;}))
                runtime_new = Models::Config.create(:name =&gt; &#39;runtime&#39;, :type =&gt;&#39;runtime&#39;, :content =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;new-runtime&#39;}))

                deployment = Models::Deployment.create(name: &#39;foo&#39;, manifest: YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
                deployment.cloud_configs = [cc_old]
                deployment.runtime_configs = [runtime_old]

                instance = Models::Instance.create(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 4 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L472" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L494" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L669" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L695" class="js-smell-location">3</a>                  </div>  </li></ol>
                  deployment: deployment,
                  job: &#39;dea&#39;,
                  index: &#39;2&#39;,
                  uuid: &#39;0B949287-CDED-4761-9002-FC4035E11B21&#39;,
                  state: &#39;started&#39;,
                  :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
                )
                expect_any_instance_of(DeploymentManager)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L677" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L703" class="js-smell-location">1</a>                  </div>  </li></ol>
                    .to receive(:create_deployment)
                            .with(anything(), anything(), [cc_old], [runtime_old], deployment, hash_including(options))
                            .and_return(OpenStruct.new(:id =&gt; 1))
                put &quot;#{path}&quot;, &#39;&#39;, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                expect(last_response).to be_redirect
              end
            end

            context &#39;with an instance_group&#39; do
              let(:path) {&#39;/foo/jobs/dea?state=recreate&#39;}
              let(:options) do
                { &#39;job_states&#39; =&gt; { &#39;dea&#39; =&gt; { &#39;state&#39; =&gt; &#39;recreate&#39; } } }
              end
              it_behaves_like &#39;recreates with configs&#39;
            end

            context &#39;with an index or ID&#39; do
              let(:path) {&#39;/foo/jobs/dea/2?state=recreate&#39;}
              let(:options) do
                { &#39;job_states&#39; =&gt; { &#39;dea&#39; =&gt; { &#39;instance_states&#39; =&gt; { 2 =&gt; &#39;recreate&#39; } } } }
              end
              it_behaves_like &#39;recreates with configs&#39;
            end
          end

          describe &#39;draining&#39; do
            let(:deployment) { Models::Deployment.create(:name =&gt; &#39;test_deployment&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;})) }
            let(:instance) { Models::Instance.create(deployment: deployment, job: &#39;job_name&#39;, index: &#39;0&#39;, uuid: &#39;0B949287-CDED-4761-9002-FC4035E11B21&#39;, state: &#39;started&#39;, :variable_set =&gt; Models::VariableSet.create(deployment: deployment)) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L427" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L731" class="js-smell-location">1</a>                  </div>  </li></ol>
            before do
              Models::PersistentDisk.create(instance: instance, disk_cid: &#39;disk_cid&#39;)
            end

            shared_examples &#39;skip_drain&#39; do
              it &#39;drains&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::describe(draining)::shared_examples(skip_drain)::it#drains has a flog score of 58</span>          </div>  </li></ol>
                expect_any_instance_of(DeploymentManager)
                  .to receive(:create_deployment).twice
                  .with(anything(), anything(), anything(), anything(), anything(), hash_excluding(&#39;skip_drain&#39;))
                  .and_return(OpenStruct.new(:id =&gt; 1))

                put &quot;#{path}&quot;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                expect(last_response).to be_redirect

                put &#39;/test_deployment/jobs/job_name/0B949287-CDED-4761-9002-FC4035E11B21&#39;, spec_asset(&#39;test_conf.yaml&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }
                expect(last_response).to be_redirect
              end

              it &#39;skips draining&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(job management)::describe(draining)::shared_examples(skip_drain)::it#skips draining has a flog score of 50</span>          </div>  </li></ol>
                expect_any_instance_of(DeploymentManager)
                  .to receive(:create_deployment)
                  .with(anything(), anything(), anything(), anything(), anything(), hash_including(&#39;skip_drain&#39; =&gt; &quot;#{drain_target}&quot;))
                  .and_return(OpenStruct.new(:id =&gt; 1))

                put &quot;#{path + drain_option}&quot;, spec_asset(&#39;test_conf.yaml&#39;), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                expect(last_response).to be_redirect
              end
            end

            context &#39;when there is a job instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L761" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L768" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L775" class="js-smell-location">2</a>                  </div>  </li></ol>
              let(:path) { &#39;/test_deployment/jobs/job_name/0&#39; }
              let(:drain_option) { &#39;?skip_drain=true&#39; }
              let(:drain_target) { &#39;job_name&#39; }
              it_behaves_like &#39;skip_drain&#39;
            end

            context &#39;when there is a  job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L761" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L768" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L775" class="js-smell-location">2</a>                  </div>  </li></ol>
              let(:path) { &#39;/test_deployment/jobs/job_name?state=stop&#39; }
              let(:drain_option) { &#39;&amp;skip_drain=true&#39; }
              let(:drain_target) { &#39;job_name&#39; }
              it_behaves_like &#39;skip_drain&#39;
            end

            context &#39;when  deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L761" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L768" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L775" class="js-smell-location">2</a>                  </div>  </li></ol>
              let(:path) { &#39;/test_deployment/jobs/*?state=stop&#39; }
              let(:drain_option) { &#39;&amp;skip_drain=true&#39; }
              let(:drain_target) { &#39;*&#39; }
              it_behaves_like &#39;skip_drain&#39;
            end
          end
        end

        describe &#39;log management&#39; do
          it &#39;allows fetching logs from a particular instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L785" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L799" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L813" class="js-smell-location">2</a>                  </div>  </li></ol>
            deployment = Models::Deployment.create(:name =&gt; &#39;foo&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
            instance = Models::Instance.create(
              :deployment =&gt; deployment,
              :job =&gt; &#39;nats&#39;,
              :index =&gt; &#39;0&#39;,
              :state =&gt; &#39;started&#39;,
              :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
            )
            Models::Vm.make(agent_id: &#39;random-id&#39;, instance_id: instance.id, active: true)
            get &#39;/foo/jobs/nats/0/logs&#39;, {}
            expect_redirect_to_queued_task(last_response)
          end

          it &#39;allows fetching logs from all instances of particular job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L785" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L799" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L813" class="js-smell-location">2</a>                  </div>  </li></ol>
            deployment = Models::Deployment.create(:name =&gt; &#39;foo&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
            instance = Models::Instance.create(
                :deployment =&gt; deployment,
                :job =&gt; &#39;nats&#39;,
                :index =&gt; &#39;0&#39;,
                :state =&gt; &#39;started&#39;,
                :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
            )
            Models::Vm.make(agent_id: &#39;random-id&#39;, instance_id: instance.id, active: true)
            get &#39;/foo/jobs/nats/*/logs&#39;, {}
            expect_redirect_to_queued_task(last_response)
          end

          it &#39;allows fetching logs from all instances of particular deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L785" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L799" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L813" class="js-smell-location">2</a>                  </div>  </li></ol>
            deployment = Models::Deployment.create(:name =&gt; &#39;foo&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
            instance = Models::Instance.create(
                :deployment =&gt; deployment,
                :job =&gt; &#39;nats&#39;,
                :index =&gt; &#39;0&#39;,
                :state =&gt; &#39;started&#39;,
                :variable_set =&gt; Models::VariableSet.create(deployment: deployment)
            )
            Models::Vm.make(agent_id: &#39;random-id&#39;, instance_id: instance.id, active: true)
            get &#39;/foo/jobs/*/*/logs&#39;, {}
            expect_redirect_to_queued_task(last_response)
          end

          it &#39;404 if no instance&#39; do
            get &#39;/baz/jobs/nats/0/logs&#39;, {}
            expect(last_response.status).to eq(404)
          end

          it &#39;404 if no deployment&#39; do
            deployment = Models::Deployment.
              create(:name =&gt; &#39;bar&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
            get &#39;/bar/jobs/nats/0/logs&#39;, {}
            expect(last_response.status).to eq(404)
          end
        end

        describe &#39;listing deployments&#39; do
          let(:deployment) { Models::Deployment.make(name: &#39;b&#39;) }

          before { basic_authorize &#39;reader&#39;, &#39;reader&#39; }

          context &#39;with deployment info&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(listing deployments)::context#with deployment info has a flog score of 72</span>          </div>  </li></ol>
            before do
              release_1 = Models::Release.create(:name =&gt; &#39;release-1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'release_1'</span>          </div>  </li></ol>
              release_1_1 = Models::ReleaseVersion.create(:release =&gt; release_1, :version =&gt; 1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'release_1_1'</span>          </div>  </li></ol>
              release_1_2 = Models::ReleaseVersion.create(:release =&gt; release_1, :version =&gt; 2)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'release_1_2'</span>          </div>  </li></ol>
              release_2 = Models::Release.create(:name =&gt; &#39;release-2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'release_2'</span>          </div>  </li></ol>
              release_2_1 = Models::ReleaseVersion.create(:release =&gt; release_2, :version =&gt; 1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'release_2_1'</span>          </div>  </li></ol>

              stemcell_1_1 = Models::Stemcell.create(name: &#39;stemcell-1&#39;, version: 1, cid: 123)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'stemcell_1_1'</span>          </div>  </li></ol>
              stemcell_1_2 = Models::Stemcell.create(name: &#39;stemcell-1&#39;, version: 2, cid: 123)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'stemcell_1_2'</span>          </div>  </li></ol>
              stemcell_2_1 = Models::Stemcell.create(name: &#39;stemcell-2&#39;, version: 1, cid: 124)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'stemcell_2_1'</span>          </div>  </li></ol>

              old_cloud_config = Models::Config.make(:cloud, raw_manifest: {}, created_at: Time.now - 60)
              new_cloud_config = Models::Config.make(:cloud, raw_manifest: {})
              new_other_cloud_config = Models::Config.make(:cloud, name: &#39;other-config&#39;, raw_manifest: {})

              good_team = Models::Team.create(name: &#39;dabest&#39;)
              bad_team = Models::Team.create(name: &#39;daworst&#39;)

              Models::Deployment.create(
                name: &#39;deployment-3&#39;,
              ).tap do |deployment|
                deployment.teams = [bad_team]
              end

              Models::Deployment.create(
                name: &#39;deployment-2&#39;,
              ).tap do |deployment|
                deployment.add_stemcell(stemcell_1_1)
                deployment.add_stemcell(stemcell_1_2)
                deployment.add_release_version(release_1_1)
                deployment.add_release_version(release_2_1)
                deployment.teams = [good_team]
                deployment.cloud_configs = [new_other_cloud_config, new_cloud_config]
              end

              Models::Deployment.create(
                name: &#39;deployment-1&#39;,
              ).tap do |deployment|
                deployment.add_stemcell(stemcell_1_1)
                deployment.add_stemcell(stemcell_2_1)
                deployment.add_release_version(release_1_1)
                deployment.add_release_version(release_1_2)
                deployment.teams = [good_team, bad_team]
                deployment.cloud_configs = [old_cloud_config]
              end
            end

            it &#39;lists in name order&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(listing deployments)::context(with deployment info)::it#lists in name order has a flog score of 25</span>          </div>  </li></ol>
              get &#39;/&#39;, {}, {}
              expect(last_response.status).to eq(200)

              body = JSON.parse(last_response.body)
              expect(body).to eq(
                [
                  {
                    &#39;name&#39; =&gt; &#39;deployment-1&#39;,
                    &#39;releases&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;release-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;release-1&#39;, &#39;version&#39; =&gt; &#39;2&#39; },
                    ],
                    &#39;stemcells&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;stemcell-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;stemcell-2&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                    ],
                    &#39;cloud_config&#39; =&gt; &#39;outdated&#39;,
                    &#39;teams&#39; =&gt; %w[dabest daworst],
                  },
                  {
                    &#39;name&#39; =&gt; &#39;deployment-2&#39;,
                    &#39;releases&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;release-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;release-2&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                    ],
                    &#39;stemcells&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;stemcell-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;stemcell-1&#39;, &#39;version&#39; =&gt; &#39;2&#39; },
                    ],
                    &#39;cloud_config&#39; =&gt; &#39;latest&#39;,
                    &#39;teams&#39; =&gt; [&#39;dabest&#39;],
                  },
                  {
                    &#39;name&#39; =&gt; &#39;deployment-3&#39;,
                    &#39;releases&#39; =&gt; [],
                    &#39;stemcells&#39; =&gt; [],
                    &#39;cloud_config&#39; =&gt; &#39;none&#39;,
                    &#39;teams&#39; =&gt; [&#39;daworst&#39;],
                  },
                ],
              )
            end

            it &#39;lists without configs if specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(listing deployments)::context(with deployment info)::it#lists without configs if specified has a flog score of 25</span>          </div>  </li></ol>
              get &#39;/?exclude_configs=true&#39;, {}, {}
              expect(last_response.status).to eq(200)

              body = JSON.parse(last_response.body)
              expect(body).to eq(
                [
                  {
                    &#39;name&#39; =&gt; &#39;deployment-1&#39;,
                    &#39;releases&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;release-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;release-1&#39;, &#39;version&#39; =&gt; &#39;2&#39; },
                    ],
                    &#39;stemcells&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;stemcell-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;stemcell-2&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                    ],
                    &#39;teams&#39; =&gt; %w[dabest daworst],
                  },
                  {
                    &#39;name&#39; =&gt; &#39;deployment-2&#39;,
                    &#39;releases&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;release-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;release-2&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                    ],
                    &#39;stemcells&#39; =&gt; [
                      { &#39;name&#39; =&gt; &#39;stemcell-1&#39;, &#39;version&#39; =&gt; &#39;1&#39; },
                      { &#39;name&#39; =&gt; &#39;stemcell-1&#39;, &#39;version&#39; =&gt; &#39;2&#39; },
                    ],
                    &#39;teams&#39; =&gt; [&#39;dabest&#39;],
                  },
                  {
                    &#39;name&#39; =&gt; &#39;deployment-3&#39;,
                    &#39;releases&#39; =&gt; [],
                    &#39;stemcells&#39; =&gt; [],
                    &#39;teams&#39; =&gt; [&#39;daworst&#39;],
                  },
                ],
              )
            end

            it &#39;lists without configs,stemcells and releases if specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(listing deployments)::context(with deployment info)::it#lists without configs,stemcells and releases if specified has a flog score of 25</span>          </div>  </li></ol>
              get &#39;/?exclude_configs=true&amp;exclude_stemcells=true&amp;exclude_releases=true&#39;, {}, {}
              expect(last_response.status).to eq(200)

              body = JSON.parse(last_response.body)
              expect(body).to eq(
                [
                  {
                    &#39;name&#39; =&gt; &#39;deployment-1&#39;,
                    &#39;teams&#39; =&gt; %w[dabest daworst],
                  },
                  {
                    &#39;name&#39; =&gt; &#39;deployment-2&#39;,
                    &#39;teams&#39; =&gt; [&#39;dabest&#39;],
                  },
                  {
                    &#39;name&#39; =&gt; &#39;deployment-3&#39;,
                    &#39;teams&#39; =&gt; [&#39;daworst&#39;],
                  },
                ],
              )
            end
          end

          it &#39;orders the associations&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(listing deployments)::it#orders the associations has a flog score of 108</span>          </div>  </li></ol>
            release2 = Models::Release.make(name: &#39;r2&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'release2'</span>          </div>  </li></ol>
            release1 = Models::Release.make(name: &#39;r1&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'release1'</span>          </div>  </li></ol>

            deployment.add_release_version(Models::ReleaseVersion.make(version: &#39;3&#39;, release_id: release1.id))
            deployment.add_release_version(Models::ReleaseVersion.make(version: &#39;2&#39;, release_id: release1.id))
            deployment.add_release_version(Models::ReleaseVersion.make(version: &#39;1&#39;, release_id: release2.id))

            deployment.add_team(Models::Team.make(name: &#39;team2&#39;))
            deployment.add_team(Models::Team.make(name: &#39;team3&#39;))
            deployment.add_team(Models::Team.make(name: &#39;team1&#39;))

            deployment.add_stemcell(Models::Stemcell.make(name: &#39;stemcell2&#39;, version: &#39;4&#39;))
            deployment.add_stemcell(Models::Stemcell.make(name: &#39;stemcell1&#39;, version: &#39;1&#39;))
            deployment.add_stemcell(Models::Stemcell.make(name: &#39;stemcell2&#39;, version: &#39;3&#39;))
            deployment.add_stemcell(Models::Stemcell.make(name: &#39;stemcell3&#39;, version: &#39;2&#39;))

            get &#39;/&#39;, {}, {}
            expect(last_response.status).to eq(200)

            body = JSON.parse(last_response.body)

            expect(body.first[&#39;releases&#39;]).to eq([{&#39;name&#39; =&gt; &#39;r1&#39;, &#39;version&#39; =&gt; &#39;2&#39;}, {&#39;name&#39; =&gt; &#39;r1&#39;, &#39;version&#39; =&gt; &#39;3&#39;}, {&#39;name&#39; =&gt; &#39;r2&#39;, &#39;version&#39; =&gt; &#39;1&#39;}])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1024" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2117" class="js-smell-location">1</a>                  </div>  </li></ol>
            expect(body.first[&#39;stemcells&#39;]).to eq([<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1025" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2126" class="js-smell-location">1</a>                  </div>  </li></ol>
                {&#39;name&#39; =&gt; &#39;stemcell1&#39;, &#39;version&#39; =&gt; &#39;1&#39;},
                {&#39;name&#39; =&gt; &#39;stemcell2&#39;, &#39;version&#39; =&gt; &#39;3&#39;},
                {&#39;name&#39; =&gt; &#39;stemcell2&#39;, &#39;version&#39; =&gt; &#39;4&#39;},
                {&#39;name&#39; =&gt; &#39;stemcell3&#39;, &#39;version&#39; =&gt; &#39;2&#39;}])
            expect(body.first[&#39;teams&#39;]).to eq(%w(team1 team2 team3))
          end

          context &#39;when authorized as a team reader&#39; do
            let!(:permitted_deployment) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1034" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1042" class="js-smell-location">1</a>                  </div>  </li></ol>
              Models::Deployment.create(
                name: &#39;deployment-1&#39;,
              ).tap do |deployment|
                deployment.teams = [dev_team]
                deployment.cloud_configs = [dev_cloud_config]
              end
            end
            let!(:unauthorized_deployment) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1034" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1042" class="js-smell-location">1</a>                  </div>  </li></ol>
              Models::Deployment.create(
                name: &#39;deployment-2&#39;,
              ).tap do |deployment|
                deployment.teams = [other_team]
                deployment.cloud_configs = [other_cloud_config]
              end
            end
            let(:other_team) { Models::Team.make(name: &#39;footeam&#39;) }
            let(:dev_team) { Models::Team.make(name: &#39;dev&#39;) }
            let(:dev_cloud_config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1052" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1055" class="js-smell-location">1</a>                  </div>  </li></ol>
              Models::Config.make(name: &#39;dev-team-config&#39;, type: &#39;cloud&#39;, raw_manifest: {}, team_id: dev_team.id)
            end
            let(:other_cloud_config) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1052" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1055" class="js-smell-location">1</a>                  </div>  </li></ol>
              Models::Config.make(name: &#39;other-team-config&#39;, type: &#39;cloud&#39;, raw_manifest: {}, team_id: other_team.id)
            end

            before { basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39; }

            #TODO(tv, cd) fixup this it description
            it &#39;returns the deployments that the user has access to with correct cloud-config status&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(listing deployments)::context(when authorized as a team reader)::it#returns the deployments that the user has access to with correct cloud-config status has a flog score of 25</span>          </div>  </li></ol>
              get &#39;/&#39;, {}, {}
              expect(last_response.status).to eq(200)

              body = JSON.parse(last_response.body)
              expect(body).to eq([
                {
                  &#39;name&#39; =&gt; &#39;deployment-1&#39;,
                  &#39;releases&#39; =&gt; [],
                  &#39;stemcells&#39; =&gt; [],
                  &#39;cloud_config&#39; =&gt; &#39;latest&#39;,
                  &#39;teams&#39; =&gt; [&#39;dev&#39;],
                },
              ])
            end
          end
        end

        describe &#39;getting deployment info&#39; do
          before { basic_authorize &#39;reader&#39;, &#39;reader&#39; }

          it &#39;returns manifest&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment info)::it#returns manifest has a flog score of 31</span>          </div>  </li></ol>
            deployment = Models::Deployment.
                create(:name =&gt; &#39;test_deployment&#39;,
                       :manifest_text =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;}))
            get &#39;/test_deployment&#39;

            expect(last_response.status).to eq(200)
            body = JSON.parse(last_response.body)
            expect(YAML.load(body[&#39;manifest&#39;])).to eq(&#39;foo&#39; =&gt; &#39;bar&#39;)
          end
        end

        describe &#39;getting deployment vms info&#39; do
          before { basic_authorize &#39;reader&#39;, &#39;reader&#39; }

          let(:deployment) { Models::Deployment.create(:name =&gt; &#39;test_deployment&#39;, :manifest =&gt; YAML.dump({&#39;foo&#39; =&gt; &#39;bar&#39;})) }

          it &#39;returns a list of instances with vms (vm_cid != nil)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment vms info)::it(returns a list of instances with vms (vm_cid != nil))#returns a list of instances with vms (vm_cid != nil) has a flog score of 85</span>          </div>  </li></ol>
            8.times do |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
              instance_params = {
                &#39;deployment_id&#39; =&gt; deployment.id,
                &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                &#39;index&#39; =&gt; i,
                &#39;state&#39; =&gt; &#39;started&#39;,
                &#39;uuid&#39; =&gt; &quot;instance-#{i}&quot;,
                &#39;variable_set_id&#39; =&gt; (Models::VariableSet.create(deployment: deployment).id),
                &#39;spec&#39; =&gt; {&#39;networks&#39; =&gt; {&#39;network1&#39; =&gt; {&#39;ip&#39; =&gt; &quot;#{i}.#{i}.#{i}.#{i}&quot;}}},<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1109" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1121" class="js-smell-location">1</a>                  </div>  </li></ol>
              }

              instance_params[&#39;availability_zone&#39;] = &#39;az0&#39; if i == 0
              instance_params[&#39;availability_zone&#39;] = &#39;az1&#39; if i == 1
              instance = Models::Instance.create(instance_params)
              2.times do |j|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'j'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1115" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1188" class="js-smell-location">1</a>                  </div>  </li></ol>
                vm_params = {
                  &#39;agent_id&#39; =&gt; &quot;agent-#{i}-#{j}&quot;,
                  &#39;cid&#39; =&gt; &quot;cid-#{i}-#{j}&quot;,
                  &#39;instance_id&#39; =&gt; instance.id,
                  &#39;created_at&#39; =&gt; time,
                  &#39;network_spec&#39; =&gt; {&#39;network1&#39; =&gt; {&#39;ip&#39; =&gt; &quot;#{i}.#{i}.#{j}.#{j}&quot;}},<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1109" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1121" class="js-smell-location">1</a>                  </div>  </li></ol>
                }

                vm = Models::Vm.create(vm_params)

                if j == 0
                  instance.active_vm = vm
                end
              end
            end

            get &#39;/test_deployment/vms&#39;

            expect(last_response.status).to eq(200)
            body = JSON.parse(last_response.body)
            expect(body.size).to eq(16)
            body.sort_by{|instance| instance[&#39;agent_id&#39;]}.each_with_index do |instance_with_vm, i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
              instance_idx = i / 2
              vm_by_instance = i % 2
              vm_is_active = vm_by_instance == 0
              expect(instance_with_vm).to eq(
                &#39;agent_id&#39; =&gt; &quot;agent-#{instance_idx}-#{vm_by_instance}&quot;,
                &#39;job&#39; =&gt; &quot;job-#{instance_idx}&quot;,
                &#39;index&#39; =&gt; instance_idx,
                &#39;cid&#39; =&gt; &quot;cid-#{instance_idx}-#{vm_by_instance}&quot;,
                &#39;id&#39; =&gt; &quot;instance-#{instance_idx}&quot;,
                &#39;active&#39; =&gt; vm_is_active,
                &#39;az&#39; =&gt; {0 =&gt; &#39;az0&#39;, 1 =&gt; &#39;az1&#39;, nil =&gt; nil}[instance_idx],
                &#39;ips&#39; =&gt; [&quot;#{instance_idx}.#{instance_idx}.#{vm_by_instance}.#{vm_by_instance}&quot;],
                &#39;vm_created_at&#39; =&gt; time.utc.iso8601,
              )
            end
          end

          context &#39;with full format requested&#39; do
            before do
              deployment
            end

            it &#39;redirects to a delayed job&#39; do
              expect_any_instance_of(Api::InstanceManager).to receive(:fetch_instances_with_vm) do
                Bosh::Director::Models::Task.make(id: 10002)
              end

              get &#39;/test_deployment/vms?format=full&#39;

              task = expect_redirect_to_queued_task(last_response)
              expect(task.id).to eq 10002
            end
          end

          context &#39;ips&#39; do
            it &#39;returns ip addresses for each vm&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment vms info)::context(ips)::it#returns ip addresses for each vm has a flog score of 102</span>          </div>  </li></ol>
              9.times do |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                instance_params = {
                  &#39;deployment_id&#39; =&gt; deployment.id,
                  &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                  &#39;index&#39; =&gt; i,
                  &#39;state&#39; =&gt; &#39;started&#39;,
                  &#39;uuid&#39; =&gt; &quot;instance-#{i}&quot;,
                  &#39;variable_set_id&#39; =&gt; (Models::VariableSet.create(deployment: deployment).id)
                }

                instance_params[&#39;availability_zone&#39;] = &#39;az0&#39; if i == 0
                instance_params[&#39;availability_zone&#39;] = &#39;az1&#39; if i == 1
                instance = Models::Instance.create(instance_params)

                2.times do |j|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'j'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1115" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1188" class="js-smell-location">1</a>                  </div>  </li></ol>
                  vm_params = {
                    &#39;agent_id&#39; =&gt; &quot;agent-#{i}-#{j}&quot;,
                    &#39;cid&#39; =&gt; &quot;cid-#{i}-#{j}&quot;,
                    &#39;instance_id&#39; =&gt; instance.id,
                    &#39;created_at&#39; =&gt; time,
                  }

                  vm = Models::Vm.create(vm_params)

                  if j == 0
                    instance.active_vm = vm
                  end

                  ip_addresses_params = {
                    &#39;instance_id&#39; =&gt; instance.id,
                    &#39;task_id&#39; =&gt; i.to_s,
                    &#39;address_str&#39; =&gt; ip_to_i(&quot;1.2.#{i}.#{j}&quot;).to_s,
                    &#39;vm_id&#39; =&gt; vm.id,
                  }
                  Models::IpAddress.create(ip_addresses_params)
                end
              end

              get &#39;/test_deployment/vms&#39;

              expect(last_response.status).to eq(200)
              body = JSON.parse(last_response.body)
              expect(body.size).to eq(18)

              body.sort_by { |instance| instance[&#39;agent_id&#39;] }.each_with_index do |instance_with_vm, i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                instance_idx = i / 2
                vm_by_instance = i % 2
                vm_is_active = vm_by_instance == 0
                expect(instance_with_vm).to eq(
                  &#39;agent_id&#39; =&gt; &quot;agent-#{instance_idx}-#{vm_by_instance}&quot;,
                  &#39;job&#39; =&gt; &quot;job-#{instance_idx}&quot;,
                  &#39;index&#39; =&gt; instance_idx,
                  &#39;cid&#39; =&gt; &quot;cid-#{instance_idx}-#{vm_by_instance}&quot;,
                  &#39;id&#39; =&gt; &quot;instance-#{instance_idx}&quot;,
                  &#39;active&#39; =&gt; vm_is_active,
                  &#39;az&#39; =&gt; { 0 =&gt; &#39;az0&#39;, 1 =&gt; &#39;az1&#39;, nil =&gt; nil }[instance_idx],
                  &#39;ips&#39; =&gt; [&quot;1.2.#{instance_idx}.#{vm_by_instance}&quot;],
                  &#39;vm_created_at&#39; =&gt; time.utc.iso8601,
                )
              end
            end

            it &#39;returns network spec ip addresses&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment vms info)::context(ips)::it#returns network spec ip addresses has a flog score of 82</span>          </div>  </li></ol>
              15.times do |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                instance_params = {
                  &#39;deployment_id&#39; =&gt; deployment.id,
                  &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                  &#39;index&#39; =&gt; i,
                  &#39;state&#39; =&gt; &#39;started&#39;,
                  &#39;variable_set_id&#39; =&gt; (Models::VariableSet.create(deployment: deployment).id),
                  &#39;uuid&#39; =&gt; &quot;instance-#{i}&quot;,
                }

                instance_params[&#39;availability_zone&#39;] = &#39;az0&#39; if i == 0
                instance_params[&#39;availability_zone&#39;] = &#39;az1&#39; if i == 1
                instance = Models::Instance.create(instance_params)
                vm_params = {
                  &#39;agent_id&#39; =&gt; &quot;agent-#{i}&quot;,
                  &#39;cid&#39; =&gt; &quot;cid-#{i}&quot;,
                  &#39;instance_id&#39; =&gt; instance.id,
                  &#39;created_at&#39; =&gt; time,
                  &#39;network_spec&#39; =&gt; {&#39;network1&#39; =&gt; {&#39;ip&#39; =&gt; &quot;1.2.3.#{i}&quot;}},
                }

                vm = Models::Vm.create(vm_params)
                if i &lt; 8
                  instance.active_vm = vm
                end
              end

              get &#39;/test_deployment/vms&#39;

              expect(last_response.status).to eq(200)
              body = JSON.parse(last_response.body)
              expect(body.size).to eq(15)

              body.sort_by{|instance| instance[&#39;index&#39;]}.each_with_index do |instance_with_vm, i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                vm_is_active = i &lt; 8
                expect(instance_with_vm).to eq(
                  &#39;agent_id&#39; =&gt; &quot;agent-#{i}&quot;,
                  &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                  &#39;index&#39; =&gt; i,
                  &#39;cid&#39; =&gt; &quot;cid-#{i}&quot;,
                  &#39;id&#39; =&gt; &quot;instance-#{i}&quot;,
                  &#39;active&#39; =&gt; vm_is_active,
                  &#39;az&#39; =&gt; {0 =&gt; &#39;az0&#39;, 1 =&gt; &#39;az1&#39;, nil =&gt; nil}[i],
                  &#39;ips&#39; =&gt; [&quot;1.2.3.#{i}&quot;],
                  &#39;vm_created_at&#39; =&gt; time.utc.iso8601
                )
              end
            end
          end
        end

        describe &#39;getting deployment instances&#39; do
          before do
            basic_authorize &#39;reader&#39;, &#39;reader&#39;
            release = Models::Release.create(:name =&gt; &#39;test_release&#39;)
            version = Models::ReleaseVersion.create(:release =&gt; release, :version =&gt; 1)
            version.add_template(Models::Template.make(name: &#39;job_using_pkg_1&#39;, release: release))
          end
          let(:deployment) { Models::Deployment.create(:name =&gt; &#39;test_deployment&#39;, :manifest =&gt; manifest) }
          let(:default_manifest) { Bosh::Spec::Deployments.remote_stemcell_manifest(&#39;stemcell_url&#39;, &#39;stemcell_sha1&#39;) }

          context &#39;multiple instances&#39; do
            let(:manifest) do
              jobs = []
              15.times do |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                jobs &lt;&lt; {
                  &#39;name&#39; =&gt; &quot;job-#{i}&quot;,
                  &#39;spec&#39; =&gt; { &#39;templates&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;job_using_pkg_1&#39; }] },
                  &#39;instances&#39; =&gt; 1,
                  &#39;resource_pool&#39; =&gt; &#39;a&#39;,
                  &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;a&#39; }],
                }
              end
              YAML.dump(default_manifest.merge(&#39;jobs&#39; =&gt; jobs))
            end

            it &#39;returns all&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment instances)::context(multiple instances)::it#returns all has a flog score of 91</span>          </div>  </li></ol>
              15.times do |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                instance_params = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1315" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1381" class="js-smell-location">1</a>                  </div>  </li></ol>
                    &#39;deployment_id&#39; =&gt; deployment.id,
                    &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                    &#39;index&#39; =&gt; i,
                    &#39;state&#39; =&gt; &#39;started&#39;,
                    &#39;variable_set_id&#39; =&gt; (Models::VariableSet.create(deployment: deployment).id),
                    &#39;uuid&#39; =&gt; &quot;instance-#{i}&quot;,
                    &#39;spec_json&#39; =&gt; &#39;{ &quot;lifecycle&quot;: &quot;service&quot; }&#39;,
                }

                instance_params[&#39;availability_zone&#39;] = &#39;az0&#39; if i == 0
                instance_params[&#39;availability_zone&#39;] = &#39;az1&#39; if i == 1
                instance = Models::Instance.create(instance_params)
                if i &lt; 6
                  vm_params = {
                    &#39;agent_id&#39; =&gt; &quot;agent-#{i}&quot;,
                    &#39;cid&#39; =&gt; &quot;cid-#{i}&quot;,
                    &#39;instance_id&#39; =&gt; instance.id,
                    &#39;created_at&#39; =&gt; time,
                    &#39;network_spec&#39; =&gt; {}
                  }

                  vm = Models::Vm.create(vm_params)
                  instance.active_vm = vm
                end

              end

              get &#39;/test_deployment/instances&#39;

              expect(last_response.status).to eq(200)
              body = JSON.parse(last_response.body)
              expect(body.size).to eq(15)

              body.sort_by{|instance| instance[&#39;index&#39;]}.each_with_index do |instance, i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                if i &lt; 6
                  expect(instance).to eq(
                    &#39;agent_id&#39; =&gt; &quot;agent-#{i}&quot;,
                    &#39;cid&#39; =&gt; &quot;cid-#{i}&quot;,
                    &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                    &#39;index&#39; =&gt; i,
                    &#39;id&#39; =&gt; &quot;instance-#{i}&quot;,
                    &#39;az&#39; =&gt; {0 =&gt; &#39;az0&#39;, 1 =&gt; &#39;az1&#39;, nil =&gt; nil}[i],
                    &#39;ips&#39; =&gt; [],
                    &#39;vm_created_at&#39; =&gt; time.utc.iso8601,
                    &#39;expects_vm&#39; =&gt; true
                  )
                else
                  expect(instance).to eq(
                    &#39;agent_id&#39; =&gt; nil,
                    &#39;cid&#39; =&gt; nil,
                    &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                    &#39;index&#39; =&gt; i,
                    &#39;id&#39; =&gt; &quot;instance-#{i}&quot;,
                    &#39;az&#39; =&gt; {0 =&gt; &#39;az0&#39;, 1 =&gt; &#39;az1&#39;, nil =&gt; nil}[i],
                    &#39;ips&#39; =&gt; [],
                    &#39;vm_created_at&#39; =&gt; nil,
                    &#39;expects_vm&#39; =&gt; true
                  )
                end
              end
            end

            context &#39;ips&#39; do
              it &#39;returns no ips if there are no vms for the instance&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment instances)::context(multiple instances)::context(ips)::it#returns no ips if there are no vms for the instance has a flog score of 73</span>          </div>  </li></ol>
                15.times do |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                  instance_params = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1315" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1381" class="js-smell-location">1</a>                  </div>  </li></ol>
                      &#39;deployment_id&#39; =&gt; deployment.id,
                      &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                      &#39;index&#39; =&gt; i,
                      &#39;state&#39; =&gt; &#39;started&#39;,
                      &#39;variable_set_id&#39; =&gt; (Models::VariableSet.create(deployment: deployment).id),
                      &#39;uuid&#39; =&gt; &quot;instance-#{i}&quot;,
                      &#39;spec_json&#39; =&gt; &#39;{ &quot;lifecycle&quot;: &quot;service&quot; }&#39;,
                  }

                  instance_params[&#39;availability_zone&#39;] = &#39;az0&#39; if i == 0
                  instance_params[&#39;availability_zone&#39;] = &#39;az1&#39; if i == 1
                  instance = Models::Instance.create(instance_params)

                  ip_addresses_params  = {
                    &#39;instance_id&#39; =&gt; instance.id,
                    &#39;task_id&#39; =&gt; &quot;#{i}&quot;,
                    &#39;address_str&#39; =&gt; ip_to_i(&quot;1.2.3.#{i}&quot;).to_s,
                  }
                  Models::IpAddress.create(ip_addresses_params)
                end

                get &#39;/test_deployment/instances&#39;

                expect(last_response.status).to eq(200)
                body = JSON.parse(last_response.body)
                expect(body.size).to eq(15)

                body.sort_by{|instance| instance[&#39;index&#39;]}.each_with_index do |instance, i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                  expect(instance).to eq(
                                          &#39;agent_id&#39; =&gt; nil,
                                          &#39;cid&#39; =&gt; nil,
                                          &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                                          &#39;index&#39; =&gt; i,
                                          &#39;id&#39; =&gt; &quot;instance-#{i}&quot;,
                                          &#39;az&#39; =&gt; {0 =&gt; &#39;az0&#39;, 1 =&gt; &#39;az1&#39;, nil =&gt; nil}[i],
                                          &#39;ips&#39; =&gt; [],
                                          &#39;vm_created_at&#39; =&gt; nil,
                                          &#39;expects_vm&#39; =&gt; true
                                      )
                end
              end

              it &#39;returns no ips even if there is a network spec ip addresses&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment instances)::context(multiple instances)::context(ips)::it#returns no ips even if there is a network spec ip addresses has a flog score of 65</span>          </div>  </li></ol>
                15.times do |i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                  instance_params = {
                      &#39;deployment_id&#39; =&gt; deployment.id,
                      &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                      &#39;index&#39; =&gt; i,
                      &#39;state&#39; =&gt; &#39;started&#39;,
                      &#39;variable_set_id&#39; =&gt; (Models::VariableSet.create(deployment: deployment).id),
                      &#39;uuid&#39; =&gt; &quot;instance-#{i}&quot;,
                      &#39;spec_json&#39; =&gt; &quot;{ \&quot;lifecycle\&quot;: \&quot;service\&quot;, \&quot;networks\&quot;: [ [ \&quot;a\&quot;, { \&quot;ip\&quot;: \&quot;1.2.3.#{i}\&quot; } ] ] }&quot;,
                  }

                  instance_params[&#39;availability_zone&#39;] = &#39;az0&#39; if i == 0
                  instance_params[&#39;availability_zone&#39;] = &#39;az1&#39; if i == 1
                  Models::Instance.create(instance_params)
                end

                get &#39;/test_deployment/instances&#39;

                expect(last_response.status).to eq(200)
                body = JSON.parse(last_response.body)
                expect(body.size).to eq(15)

                body.sort_by{|instance| instance[&#39;index&#39;]}.each_with_index do |instance, i|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'i'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1101" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1137" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L1174" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L1218" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L1237" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L1270" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L1301" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L1314" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L1349" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L1380" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L1409" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L1425" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L1447" class="js-smell-location">12</a>                  </div>  </li></ol>
                  expect(instance).to eq(
                                          &#39;agent_id&#39; =&gt; nil,
                                          &#39;cid&#39; =&gt; nil,
                                          &#39;job&#39; =&gt; &quot;job-#{i}&quot;,
                                          &#39;index&#39; =&gt; i,
                                          &#39;id&#39; =&gt; &quot;instance-#{i}&quot;,
                                          &#39;az&#39; =&gt; {0 =&gt; &#39;az0&#39;, 1 =&gt; &#39;az1&#39;, nil =&gt; nil}[i],
                                          &#39;ips&#39; =&gt; [],
                                          &#39;vm_created_at&#39; =&gt; nil,
                                          &#39;expects_vm&#39; =&gt; true
                                      )
                end
              end
            end
          end

          context &#39;instance lifecycle&#39; do
            let(:job_state) { &#39;started&#39; }
            before do
              Models::Instance.create({
                                          &#39;deployment_id&#39; =&gt; deployment.id,
                                          &#39;job&#39; =&gt; &#39;job&#39;,
                                          &#39;index&#39; =&gt; 1,
                                          &#39;state&#39; =&gt; job_state,
                                          &#39;variable_set_id&#39; =&gt; (Models::VariableSet.create(deployment: deployment).id),
                                          &#39;uuid&#39; =&gt; &#39;instance-1&#39;,
                                          &#39;spec_json&#39; =&gt; &quot;{ \&quot;lifecycle\&quot;: \&quot;#{instance_lifecycle}\&quot; }&quot;,
                                      })
            end

            context &#39;is &quot;service&quot;&#39; do
              let(:manifest) { YAML.dump(default_manifest.merge(Bosh::Spec::Deployments.test_release_job)) }
              let(:instance_lifecycle) { &#39;service&#39; }

              context &#39;and state is either &quot;started&quot; or &quot;stopped&quot;&#39; do
                it &#39;sets &quot;expects_vm&quot; to &quot;true&quot;&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment instances)::context(instance lifecycle)::context(is "service")::context(and state is either "started" or "stopped")::it#sets "expects_vm" to "true" has a flog score of 38</span>          </div>  </li></ol>

                  get &#39;/test_deployment/instances&#39;

                  expect(last_response.status).to eq(200)
                  body = JSON.parse(last_response.body)
                  expect(body.size).to eq(1)

                  expect(body[0]).to eq(
                                         &#39;agent_id&#39; =&gt; nil,
                                         &#39;cid&#39; =&gt; nil,
                                         &#39;job&#39; =&gt; &#39;job&#39;,
                                         &#39;index&#39; =&gt; 1,
                                         &#39;id&#39; =&gt; &#39;instance-1&#39;,
                                         &#39;az&#39; =&gt; nil,
                                         &#39;ips&#39; =&gt; [],
                                         &#39;vm_created_at&#39; =&gt; nil,
                                         &#39;expects_vm&#39; =&gt; true
                                     )
                end
              end

              context &#39;and state is &quot;detached&quot;&#39; do
                let(:job_state) { &#39;detached&#39;}
                it &#39;sets &quot;expects_vm&quot; to &quot;false&quot;&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1507" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1534" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment instances)::context(instance lifecycle)::context(is "service")::context(and state is "detached")::it#sets "expects_vm" to "false" has a flog score of 39</span>          </div>  </li></ol>

                  get &#39;/test_deployment/instances&#39;

                  expect(last_response.status).to eq(200)
                  body = JSON.parse(last_response.body)
                  expect(body.size).to eq(1)

                  expect(body[0]).to eq(
                                         &#39;agent_id&#39; =&gt; nil,
                                         &#39;cid&#39; =&gt; nil,
                                         &#39;job&#39; =&gt; &#39;job&#39;,
                                         &#39;index&#39; =&gt; 1,
                                         &#39;id&#39; =&gt; &#39;instance-1&#39;,
                                         &#39;az&#39; =&gt; nil,
                                         &#39;ips&#39; =&gt; [],
                                         &#39;vm_created_at&#39; =&gt; nil,
                                         &#39;expects_vm&#39; =&gt; false
                                     )
                end
              end
            end

            context &#39;is &quot;errand&quot;&#39; do
              let(:manifest) { YAML.dump(default_manifest.merge(Bosh::Spec::Deployments.test_release_job)) }
              let(:instance_lifecycle) { &#39;errand&#39; }

              it &#39;sets &quot;expects_vm&quot; to &quot;false&quot;&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1507" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1534" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(getting deployment instances)::context(instance lifecycle)::context(is "errand")::it#sets "expects_vm" to "false" has a flog score of 38</span>          </div>  </li></ol>
                get &#39;/test_deployment/instances&#39;

                expect(last_response.status).to eq(200)
                body = JSON.parse(last_response.body)
                expect(body.size).to eq(1)

                expect(body[0]).to eq(
                                       &#39;agent_id&#39; =&gt; nil,
                                       &#39;cid&#39; =&gt; nil,
                                       &#39;job&#39; =&gt; &#39;job&#39;,
                                       &#39;index&#39; =&gt; 1,
                                       &#39;id&#39; =&gt; &#39;instance-1&#39;,
                                       &#39;az&#39; =&gt; nil,
                                       &#39;ips&#39; =&gt; [],
                                       &#39;vm_created_at&#39; =&gt; nil,
                                       &#39;expects_vm&#39; =&gt; false
                                   )
              end
            end
          end
        end

        describe &#39;property management&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe#property management has a flog score of 132</span>          </div>  </li></ol>

          it &#39;REST API for creating, updating, getting and deleting &#39; +
                 &#39;deployment properties&#39; do

            deployment = Models::Deployment.make(:name =&gt; &#39;mycloud&#39;)

            get &#39;/mycloud/properties/foo&#39;
            expect(last_response.status).to eq(404)

            get &#39;/othercloud/properties/foo&#39;
            expect(last_response.status).to eq(404)

            post &#39;/mycloud/properties&#39;, JSON.generate(&#39;name&#39; =&gt; &#39;foo&#39;, &#39;value&#39; =&gt; &#39;bar&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }
            expect(last_response.status).to eq(204)

            get &#39;/mycloud/properties/foo&#39;
            expect(last_response.status).to eq(200)
            expect(JSON.parse(last_response.body)[&#39;value&#39;]).to eq(&#39;bar&#39;)

            get &#39;/othercloud/properties/foo&#39;
            expect(last_response.status).to eq(404)

            put &#39;/mycloud/properties/foo&#39;, JSON.generate(&#39;value&#39; =&gt; &#39;baz&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }
            expect(last_response.status).to eq(204)

            get &#39;/mycloud/properties/foo&#39;
            expect(JSON.parse(last_response.body)[&#39;value&#39;]).to eq(&#39;baz&#39;)

            delete &#39;/mycloud/properties/foo&#39;
            expect(last_response.status).to eq(204)

            get &#39;/mycloud/properties/foo&#39;
            expect(last_response.status).to eq(404)
          end
        end

        describe &#39;problem management&#39; do
          let!(:deployment) { Models::Deployment.make(:name =&gt; &#39;mycloud&#39;) }
          let(:job_class) do
            Class.new(Jobs::CloudCheck::ScanAndFix) do
              define_method :perform do
                &#39;foo&#39;
              end
              @queue = :normal
            end
          end
          let (:db_job) { Jobs::DBJob.new(job_class, task.id, args)}

          it &#39;exposes problem managent REST API&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(problem management)::it#exposes problem managent REST API has a flog score of 51</span>          </div>  </li></ol>
            get &#39;/mycloud/problems&#39;
            expect(last_response.status).to eq(200)
            expect(JSON.parse(last_response.body)).to eq([])

            post &#39;/mycloud/scans&#39;
            expect_redirect_to_queued_task(last_response)

            put &#39;/mycloud/problems&#39;, JSON.generate(&#39;solutions&#39; =&gt; { 42 =&gt; &#39;do_this&#39;, 43 =&gt; &#39;do_that&#39;, 44 =&gt; nil }), { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }
            expect_redirect_to_queued_task(last_response)

            problem = Models::DeploymentProblem.
                create(:deployment_id =&gt; deployment.id, :resource_id =&gt; 2,
                       :type =&gt; &#39;test&#39;, :state =&gt; &#39;open&#39;, :data =&gt; {})

            put &#39;/mycloud/problems&#39;, JSON.generate(&#39;solution&#39; =&gt; &#39;default&#39;), { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }
            expect_redirect_to_queued_task(last_response)
          end
        end

        describe &#39;resurrection&#39; do
          let!(:deployment) { Models::Deployment.make(:name =&gt; &#39;mycloud&#39;) }

          def should_not_enqueue_scan_and_fix
            expect(Bosh::Director::Jobs::DBJob).not_to receive(:new).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1630" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1641" class="js-smell-location">1</a>                  </div>  </li></ol>
              Jobs::CloudCheck::ScanAndFix,
              kind_of(Numeric),
              [&#39;mycloud&#39;,
              [[&#39;job&#39;, 0]], false])
            expect(Delayed::Job).not_to receive(:enqueue)
            put &#39;/mycloud/scan_and_fix&#39;, JSON.dump(&#39;jobs&#39; =&gt; {&#39;job&#39; =&gt; [0]}), {&#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39;}
            expect(last_response).not_to be_redirect
          end

          def should_enqueue_scan_and_fix
            expect(Bosh::Director::Jobs::DBJob).to receive(:new).with(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1630" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1641" class="js-smell-location">1</a>                  </div>  </li></ol>
              Jobs::CloudCheck::ScanAndFix,
              kind_of(Numeric),
              [&#39;mycloud&#39;,
              [[&#39;job&#39;, 0]], false])
            expect(Delayed::Job).to receive(:enqueue)
            put &#39;/mycloud/scan_and_fix&#39;,  JSON.generate(&#39;jobs&#39; =&gt; {&#39;job&#39; =&gt; [0]}), {&#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39;}
            expect_redirect_to_queued_task(last_response)
          end

          context &#39;when global resurrection is not set&#39; do
            it &#39;scans and fixes problems&#39; do
              Models::Instance.make(deployment: deployment, job: &#39;job&#39;, index: 0)
              should_enqueue_scan_and_fix
            end
          end

          context &#39;when global resurrection is set&#39; do
            before { Models::DirectorAttribute.make(name: &#39;resurrection_paused&#39;, value: resurrection_paused) }

            context &#39;when global resurrection is on&#39; do
              let (:resurrection_paused) {&#39;false&#39;}

              it &#39;does not run scan_and_fix task if instances resurrection is off&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1664" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1678" class="js-smell-location">1</a>                  </div>  </li></ol>
                Models::Instance.make(deployment: deployment, job: &#39;job&#39;, index: 0, resurrection_paused: true)
                should_not_enqueue_scan_and_fix
              end

              it &#39;runs scan_and_fix task if instances resurrection is on&#39; do
                Models::Instance.make(deployment: deployment, job: &#39;job&#39;, index: 0)
                should_enqueue_scan_and_fix
              end
            end

            context &#39;when global resurrection is off&#39; do
              let (:resurrection_paused) {&#39;true&#39;}

              it &#39;does not run scan_and_fix task if instances resurrection is off&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1664" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1678" class="js-smell-location">1</a>                  </div>  </li></ol>
                Models::Instance.make(deployment: deployment, job: &#39;job&#39;, index: 0, resurrection_paused: true)
                should_not_enqueue_scan_and_fix
              end
            end
          end

          context &#39;when there are only ignored vms&#39; do
            it &#39;does not call the resurrector&#39; do
              Models::Instance.make(deployment: deployment, job: &#39;job&#39;, index: 0, resurrection_paused: false, ignore: true)

              put &#39;/mycloud/scan_and_fix&#39;, JSON.generate(&#39;jobs&#39; =&gt; {&#39;job&#39; =&gt; [0]}), {&#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39;}
              expect(last_response).not_to be_redirect
            end
          end
        end

        describe &#39;snapshots&#39; do
          before do
            deployment = Models::Deployment.make(name: &#39;mycloud&#39;)

            instance = Models::Instance.make(deployment: deployment, job: &#39;job&#39;, index: 0, uuid: &#39;abc123&#39;)
            disk = Models::PersistentDisk.make(disk_cid: &#39;disk0&#39;, instance: instance, active: true)
            Models::Snapshot.make(persistent_disk: disk, snapshot_cid: &#39;snap0a&#39;)

            instance = Models::Instance.make(deployment: deployment, job: &#39;job&#39;, index: 1)
            disk = Models::PersistentDisk.make(disk_cid: &#39;disk1&#39;, instance: instance, active: true)
            Models::Snapshot.make(persistent_disk: disk, snapshot_cid: &#39;snap1a&#39;)
            Models::Snapshot.make(persistent_disk: disk, snapshot_cid: &#39;snap1b&#39;)
          end

          describe &#39;creating&#39; do
            it &#39;should create a snapshot for a job&#39; do
              post &#39;/mycloud/jobs/job/1/snapshots&#39;
              expect_redirect_to_queued_task(last_response)
            end

            it &#39;should create a snapshot for a deployment&#39; do
              post &#39;/mycloud/snapshots&#39;
              expect_redirect_to_queued_task(last_response)
            end

            it &#39;should create a snapshot for a job and id&#39; do
              post &#39;/mycloud/jobs/job/abc123/snapshots&#39;
              expect_redirect_to_queued_task(last_response)
            end
          end

          describe &#39;deleting&#39; do
            it &#39;should delete all snapshots of a deployment&#39; do
              delete &#39;/mycloud/snapshots&#39;
              expect_redirect_to_queued_task(last_response)
            end

            it &#39;should delete a snapshot&#39; do
              delete &#39;/mycloud/snapshots/snap1a&#39;
              expect_redirect_to_queued_task(last_response)
            end

            it &#39;should raise an error if the snapshot belongs to a different deployment&#39; do
              snap = Models::Snapshot.make(snapshot_cid: &#39;snap2b&#39;)
              delete &quot;/#{snap.persistent_disk.instance.deployment.name}/snapshots/snap2a&quot;
              expect(last_response.status).to eq(400)
            end
          end

          describe &#39;listing&#39; do
            it &#39;should list all snapshots for a job&#39; do
              get &#39;/mycloud/jobs/job/0/snapshots&#39;
              expect(last_response.status).to eq(200)
            end

            it &#39;should list all snapshots for a deployment&#39; do
              get &#39;/mycloud/snapshots&#39;
              expect(last_response.status).to eq(200)
            end
          end
        end

        describe &#39;errands&#39; do
          describe &#39;GET&#39;, &#39;/:deployment_name/errands&#39; do
            before { Config.base_dir = Dir.mktmpdir }
            after { FileUtils.rm_rf(Config.base_dir) }

            def perform
              get(
                &#39;/fake-dep-name/errands&#39;,
                { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; },
              )
            end

            let(:cloud_config) { Models::Config.make(:cloud, content: YAML.dump(Bosh::Spec::NewDeployments.simple_cloud_config)) }

            let(:service_errand) do
              {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L22" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1772" class="js-smell-location">1</a>                  </div>  </li></ol>
                &#39;name&#39; =&gt; &#39;service_errand_job&#39;,
                &#39;jobs&#39; =&gt; [{&#39;name&#39; =&gt; &#39;job_with_bin_run&#39;}],
                &#39;lifecycle&#39; =&gt; &#39;service&#39;,
                &#39;vm_type&#39; =&gt; &#39;a&#39;,
                &#39;stemcell&#39; =&gt; &#39;default&#39;,
                &#39;instances&#39; =&gt; 1,
                &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;a&#39;}]
              }
            end

            let!(:deployment_model) do
              manifest_hash = manifest_with_errand_hash
              manifest_hash[&#39;instance_groups&#39;] &lt;&lt; service_errand
              model = Models::Deployment.make(
                name: &#39;fake-dep-name&#39;,
                manifest: YAML.dump(manifest_hash)
              )
              model.cloud_configs = [cloud_config]
              model
            end

            context &#39;authenticated access&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(errands)::describe(GET)::context#authenticated access has a flog score of 29</span>          </div>  </li></ol>
              before do
                authorize &#39;admin&#39;, &#39;admin&#39;
                deployment = Models::Deployment.make(name: &#39;errand&#39;)
                Models::VariableSet.make(deployment_id: deployment.id)
                release = Models::Release.make(name: &#39;bosh-release&#39;)
                template1 = Models::Template.make(name: &#39;foobar&#39;, release: release)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'template1'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1800" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2150" class="js-smell-location">1</a>                  </div>  </li></ol>
                template2 = Models::Template.make(name: &#39;errand1&#39;, release: release)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'template2'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1801" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2151" class="js-smell-location">1</a>                  </div>  </li></ol>
                template3 = Models::Template.make(name: &#39;job_with_bin_run&#39;, release: release, spec: {templates: {&#39;foo&#39; =&gt; &#39;bin/run&#39;}})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'template3'</span>          </div>  </li></ol>
                release_version = Models::ReleaseVersion.make(version: &#39;0.1-dev&#39;, release: release)
                release_version.add_template(template1)
                release_version.add_template(template2)
                release_version.add_template(template3)
              end

              it &#39;returns errands in deployment&#39; do
                expect(perform.body).to eq(&#39;[{&quot;name&quot;:&quot;fake-errand-name&quot;},{&quot;name&quot;:&quot;another-errand&quot;},{&quot;name&quot;:&quot;job_with_bin_run&quot;}]&#39;)
                expect(last_response.status).to eq(200)
              end
            end

            context &#39;accessing with invalid credentials&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1815" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2080" class="js-smell-location">1</a>                  <a href="events_controller_spec.html#L577" class="js-smell-location">2</a>                  <a href="packages_controller_spec.html#L194" class="js-smell-location">3</a>                  <a href="releases_controller_spec.html#L209" class="js-smell-location">4</a>                  <a href="releases_controller_spec.html#L219" class="js-smell-location">5</a>                  <a href="stemcells_controller_spec.html#L158" class="js-smell-location">6</a>                  </div>  </li></ol>
              before { authorize &#39;invalid-user&#39;, &#39;invalid-password&#39; }
              it &#39;returns 401&#39; do
                perform
                expect(last_response.status).to eq(401)
              end
            end
          end

          describe &#39;POST&#39;, &#39;/:deployment_name/errands/:name/runs&#39; do
            before { Config.base_dir = Dir.mktmpdir }
            after { FileUtils.rm_rf(Config.base_dir) }

            let!(:deployment) { Models::Deployment.make(name: &#39;fake-dep-name&#39;)}

            def perform(post_body)
              post(
                &#39;/fake-dep-name/errands/fake-errand-name/runs&#39;,
                JSON.dump(post_body),
                { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; },
              )
            end

            context &#39;authenticated access&#39; do
              before { authorize &#39;admin&#39;, &#39;admin&#39; }

              it &#39;returns a task&#39; do
                perform({})
                expect_redirect_to_queued_task(last_response)
              end

              context &#39;running the errand&#39; do
                let(:task) { instance_double(&#39;Bosh::Director::Models::Task&#39;, id: 1) }
                let(:job_queue) { instance_double(&#39;Bosh::Director::JobQueue&#39;, enqueue: task) }
                before { allow(JobQueue).to receive(:new).and_return(job_queue) }

                it &#39;enqueues a RunErrand task&#39; do
                  expect(job_queue).to receive(:enqueue).with(
                    &#39;admin&#39;,
                    Jobs::RunErrand,
                    &#39;run errand fake-errand-name from deployment fake-dep-name&#39;,
                    [&#39;fake-dep-name&#39;, &#39;fake-errand-name&#39;, false, false, []],
                    deployment,
                    &#39;&#39;
                  ).and_return(task)

                  perform({})
                end

                it &#39;sets context id on the RunErrand task&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(errands)::describe(POST)::context(authenticated access)::context(running the errand)::it#sets context id on the RunErrand task has a flog score of 26</span>          </div>  </li></ol>
                  context_id = &#39;example-context-id&#39;
                  expect(job_queue).to receive(:enqueue).with(
                    &#39;admin&#39;,
                    Jobs::RunErrand,
                    &#39;run errand fake-errand-name from deployment fake-dep-name&#39;,
                    [&#39;fake-dep-name&#39;, &#39;fake-errand-name&#39;, false, false, []],
                    deployment,
                    context_id
                  ).and_return(task)

                  header(&#39;X-Bosh-Context-Id&#39;, context_id)
                  post(
                    &#39;/fake-dep-name/errands/fake-errand-name/runs&#39;,
                    JSON.dump({}),
                    {
                      &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39;
                    }
                  )
                end

                it &#39;enqueues a keep-alive task&#39; do
                  expect(job_queue).to receive(:enqueue).with(
                    &#39;admin&#39;,
                    Jobs::RunErrand,
                    &#39;run errand fake-errand-name from deployment fake-dep-name&#39;,
                    [&#39;fake-dep-name&#39;, &#39;fake-errand-name&#39;, true, false, []],
                    deployment,
                    &#39;&#39;
                  ).and_return(task)

                  perform({&#39;keep-alive&#39; =&gt; true})
                end

                it &#39;enqueues a when-changed task&#39; do
                  expect(job_queue).to receive(:enqueue).with(
                    &#39;admin&#39;,
                    Jobs::RunErrand,
                    &#39;run errand fake-errand-name from deployment fake-dep-name&#39;,
                    [&#39;fake-dep-name&#39;, &#39;fake-errand-name&#39;, false, true, []],
                    deployment,
                    &#39;&#39;
                  ).and_return(task)

                  perform({&#39;when-changed&#39; =&gt; true})
                end

                it &#39;enqueues a task to be run on select instances&#39; do
                  expect(job_queue).to receive(:enqueue).with(
                    &#39;admin&#39;,
                    Jobs::RunErrand,
                    &#39;run errand fake-errand-name from deployment fake-dep-name&#39;,
                    [&#39;fake-dep-name&#39;, &#39;fake-errand-name&#39;, false, false, [&#39;group1/uuid1&#39;, &#39;group2/uuid2&#39;]],
                    deployment,
                    &#39;&#39;
                  ).and_return(task)

                  perform({&#39;instances&#39; =&gt; [&#39;group1/uuid1&#39;, &#39;group2/uuid2&#39;]})
                end
              end
            end

            context &#39;accessing with invalid credentials&#39; do
              before { authorize &#39;invalid-user&#39;, &#39;invalid-password&#39; }

              it &#39;returns 401&#39; do
                perform({})
                expect(last_response.status).to eq(401)
              end
            end
          end
        end

        describe &#39;diff&#39; do
          def perform
            post(
              &#39;/fake-dep-name/diff&#39;,
              &quot;---\nname: fake-dep-name\nreleases: [{&#39;name&#39;:&#39;simple&#39;,&#39;version&#39;:5}]&quot;,
              { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; },
            )
          end
          let(:runtime_config_1) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}) }
          let(:runtime_config_2) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}) }
          let(:runtime_config_3) { Models::Config.make(type: &#39;runtime&#39;, raw_manifest: {&#39;addons&#39; =&gt; []}, name: &#39;smurf&#39;) }
          let(:cloud_config) { Models::Config.make(:cloud, raw_manifest: {&#39;azs&#39; =&gt; []}) }

          before do
            deployment = Models::Deployment.create(
              :name =&gt; &#39;fake-dep-name&#39;,
              :manifest =&gt; YAML.dump({&#39;instance_groups&#39; =&gt; [], &#39;releases&#39; =&gt; [{&#39;name&#39; =&gt; &#39;simple&#39;, &#39;version&#39; =&gt; 5}]})
            )
            deployment.cloud_configs = [cloud_config]
            deployment.runtime_configs = [runtime_config_1, runtime_config_2, runtime_config_3]
          end

          context &#39;authenticated access&#39; do
            before { authorize &#39;admin&#39;, &#39;admin&#39; }

            let(:manifest_hash) do
              { &#39;instance_groups&#39; =&gt; [], &#39;releases&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;simple&#39;, &#39;version&#39; =&gt; 5 }] }
            end

            let(:dev_team) { Models::Team.make(name: &#39;dev&#39;) }
            let(:other_team) { Models::Team.make(name: &#39;other&#39;) }

            let!(:dev_runtime_config) { Models::Config.make(name: &#39;dev-runtime&#39;, type: &#39;runtime&#39;, team_id: dev_team.id) }
            let!(:other_runtime_config) { Models::Config.make(name: &#39;other-runtime&#39;, type: &#39;runtime&#39;, team_id: other_team.id) }

            let!(:dev_cloud_config) { Models::Config.make(name: &#39;dev-cloud&#39;, type: &#39;cloud&#39;, team_id: dev_team.id) }
            let!(:other_cloud_config) { Models::Config.make(name: &#39;other-cloud&#39;, type: &#39;cloud&#39;, team_id: other_team.id) }

            it &#39;returns diff with resolved aliases&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(diff)::context(authenticated access)::it#returns diff with resolved aliases has a flog score of 57</span>          </div>  </li></ol>
              perform

              body = JSON.parse(last_response.body)
              expect(body[&#39;context&#39;]).to_not be_nil
              expect(body[&#39;context&#39;][&#39;cloud_config_ids&#39;]).to contain_exactly(cloud_config.id)
              expect(body[&#39;context&#39;][&#39;runtime_config_ids&#39;]).to contain_exactly(
                runtime_config_2.id,
                runtime_config_3.id,
              )
              expect(body[&#39;diff&#39;]).to eq([[&#39;instance_groups: []&#39;, &#39;removed&#39;], [&#39;&#39;, nil], [&#39;name: fake-dep-name&#39;, &#39;added&#39;]])
            end

            it &#39;gives a nice error when request body is not a valid yml&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1988" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1996" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(diff)::context(authenticated access)::it#gives a nice error when request body is not a valid yml has a flog score of 48</span>          </div>  </li></ol>
              post &#39;/fake-dep-name/diff&#39;, &quot;}}}i&#39;m not really yaml, hah!&quot;, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

              expect(last_response.status).to eq(200)
              expect(JSON.parse(last_response.body)[&#39;error&#39;]).to include(&#39;Unable to diff manifest: &#39;)
              expect(JSON.parse(last_response.body)[&#39;error&#39;]).to include(&#39;Incorrect YAML structure of the uploaded manifest: &#39; )
            end

            it &#39;gives a nice error when request body is empty&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1988" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L1996" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(diff)::context(authenticated access)::it#gives a nice error when request body is empty has a flog score of 48</span>          </div>  </li></ol>
              post &#39;/fake-dep-name/diff&#39;, &#39;&#39;, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

              expect(last_response.status).to eq(200)
              expect(JSON.parse(last_response.body)[&#39;error&#39;]).to include(&#39;Unable to diff manifest: &#39;)
              expect(JSON.parse(last_response.body)[&#39;error&#39;]).to include(&#39;Manifest should not be empty&#39; )
            end

            it &#39;returns 200 with an empty diff and an error message if the diffing fails&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(diff)::context(authenticated access)::it#returns 200 with an empty diff and an error message if the diffing fails has a flog score of 61</span>          </div>  </li></ol>
              allow(Bosh::Director::Manifest).to receive_message_chain(:load_from_model, :resolve_aliases)
              allow(Bosh::Director::Manifest).to receive_message_chain(:load_from_model, :diff).and_raise(&#39;Oooooh crap&#39;)

              post &#39;/fake-dep-name/diff&#39;, {}.to_yaml, {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

              expect(last_response.status).to eq(200)
              expect(JSON.parse(last_response.body)[&#39;diff&#39;]).to eq([])
              expect(JSON.parse(last_response.body)[&#39;error&#39;]).to include(&#39;Unable to diff manifest&#39;)
            end

            context &#39;when cloud config exists&#39; do
              let(:manifest_hash) do
                {
                  &#39;instance_groups&#39; =&gt; [],
                  &#39;releases&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;simple&#39;, &#39;version&#39; =&gt; 5 }],
                  &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;non-cloudy-network&#39; }],
                }
              end

              it &#39;ignores cloud config if network section exists&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(diff)::context(authenticated access)::context(when cloud config exists)::it#ignores cloud config if network section exists has a flog score of 35</span>          </div>  </li></ol>
                Models::Deployment.create(
                  :name =&gt; &#39;fake-dep-name-no-cloud-conf&#39;,
                  :manifest =&gt; YAML.dump(manifest_hash)
                )

                Models::Config.make(:cloud, raw_manifest: {&#39;networks&#39;=&gt;[{&#39;name&#39;=&gt;&#39;very-cloudy-network&#39;}]})

                manifest_hash[&#39;networks&#39;] = [{&#39;name&#39;=&gt; &#39;network2&#39;}]
                diff = post &#39;/fake-dep-name-no-cloud-conf/diff&#39;, YAML.dump(manifest_hash), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}

                expect(diff).not_to match /very-cloudy-network/
                expect(diff).to match /non-cloudy-network/
                expect(diff).to match /network2/
              end
            end

            context &#39;existing deployment&#39; do
              let(:deployment) do
                Models::Deployment.make(name: &#39;existing-name&#39;, manifest: &#39;{}&#39;).tap { |d| d.teams = [dev_team] }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'd'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L274" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L424" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2043" class="js-smell-location">2</a>                  </div>  </li></ol>
              end

              it &#39;provides team-specific runtime and cloud configs in context&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(diff)::context(authenticated access)::context(existing deployment)::it#provides team-specific runtime and cloud configs in context has a flog score of 68</span>          </div>  </li></ol>
                response = post &quot;/#{deployment.name}/diff&quot;, YAML.dump(manifest_hash), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                expect(response.status).to eq(200)

                diff = JSON.parse(response.body)

                expect(diff[&#39;context&#39;][&#39;cloud_config_ids&#39;]).to contain_exactly(dev_cloud_config.id, cloud_config.id)
                expect(diff[&#39;context&#39;][&#39;runtime_config_ids&#39;]).to contain_exactly(
                  dev_runtime_config.id,
                  runtime_config_2.id,
                  runtime_config_3.id,
                )
              end
            end

            context &#39;team-specific for non-existent deployment&#39; do
              before { basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39; }

              it &#39;provides team-specific runtime and cloud configs in context&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(diff)::context(authenticated access)::context(team-specific for non-existent deployment)::it#provides team-specific runtime and cloud configs in context has a flog score of 64</span>          </div>  </li></ol>
                response = post &#39;/fake-dep-name-no-cloud-conf/diff&#39;, YAML.dump(manifest_hash), {&#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39;}
                expect(response.status).to eq(200)

                diff = JSON.parse(response.body)

                expect(diff[&#39;context&#39;][&#39;cloud_config_ids&#39;]).to contain_exactly(dev_cloud_config.id, cloud_config.id)
                expect(diff[&#39;context&#39;][&#39;runtime_config_ids&#39;]).to contain_exactly(
                  dev_runtime_config.id,
                  runtime_config_2.id,
                  runtime_config_3.id,
                )
              end
            end
          end

          context &#39;accessing with invalid credentials&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 7 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1815" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2080" class="js-smell-location">1</a>                  <a href="events_controller_spec.html#L577" class="js-smell-location">2</a>                  <a href="packages_controller_spec.html#L194" class="js-smell-location">3</a>                  <a href="releases_controller_spec.html#L209" class="js-smell-location">4</a>                  <a href="releases_controller_spec.html#L219" class="js-smell-location">5</a>                  <a href="stemcells_controller_spec.html#L158" class="js-smell-location">6</a>                  </div>  </li></ol>
            before { authorize &#39;invalid-user&#39;, &#39;invalid-password&#39; }

            it &#39;returns 401&#39; do
              perform
              expect(last_response.status).to eq(401)
            end
          end
        end

        describe &#39;variables&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe#variables has a flog score of 54</span>          </div>  </li></ol>
          let(:deployment_1) { Models::Deployment.make(name: &#39;test_deployment_1&#39;, manifest: &#39;&#39;) }
          let(:deployment_2) { Models::Deployment.make(name: &#39;test_deployment_2&#39;, manifest: &#39;&#39;) }

          let(:variable_set_1) { Models::VariableSet.make(id: 1, deployment: deployment_1) }
          let(:variable_set_2) { Models::VariableSet.make(id: 2, deployment: deployment_1) }
          let(:variable_set_3) { Models::VariableSet.make(id: 12, deployment: deployment_2) }
          let(:variable_set_4) { Models::VariableSet.make(id: 13, deployment: deployment_2) }

          before do
            basic_authorize &#39;admin&#39;, &#39;admin&#39;

            Models::Variable.make(id: 1, variable_id: &#39;var_id_1&#39;, variable_name: &#39;var_name_1&#39;, variable_set_id: variable_set_1.id)
            Models::Variable.make(id: 2, variable_id: &#39;var_id_2&#39;, variable_name: &#39;var_name_2&#39;, variable_set_id: variable_set_1.id)
            Models::Variable.make(id: 3, variable_id: &#39;var_id_1&#39;, variable_name: &#39;var_name_1&#39;, variable_set_id: variable_set_2.id)
            Models::Variable.make(id: 4, variable_id: &#39;var_id_3&#39;, variable_name: &#39;var_name_3&#39;, variable_set_id: variable_set_2.id)

            Models::Variable.make(id: 5, variable_id: &#39;var_id_1&#39;, variable_name: &#39;var_name_1&#39;, variable_set_id: variable_set_3.id)
            Models::Variable.make(id: 6, variable_id: &#39;var_id_2&#39;, variable_name: &#39;var_name_2&#39;, variable_set_id: variable_set_3.id)
            Models::Variable.make(id: 7, variable_id: &#39;var_id_3&#39;, variable_name: &#39;var_name_3&#39;, variable_set_id: variable_set_4.id)
            Models::Variable.make(id: 8, variable_id: &#39;var_id_4&#39;, variable_name: &#39;var_name_4&#39;, variable_set_id: variable_set_4.id)
          end

          it &#39;returns a unique list of variable ids and names&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(variables)::it#returns a unique list of variable ids and names has a flog score of 46</span>          </div>  </li></ol>
            get &#39;/test_deployment_1/variables&#39;
            expect(last_response.status).to eq(200)
            vars_1 = JSON.parse(last_response.body)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'vars_1'</span>          </div>  </li></ol>
            expect(vars_1).to match_array([<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1024" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2117" class="js-smell-location">1</a>                  </div>  </li></ol>
              {&#39;id&#39; =&gt; &#39;var_id_1&#39;, &#39;name&#39; =&gt; &#39;var_name_1&#39;},
              {&#39;id&#39; =&gt; &#39;var_id_2&#39;, &#39;name&#39; =&gt; &#39;var_name_2&#39;},
              {&#39;id&#39; =&gt; &#39;var_id_3&#39;, &#39;name&#39; =&gt; &#39;var_name_3&#39;}
            ])

            get &#39;/test_deployment_2/variables&#39;
            expect(last_response.status).to eq(200)
            vars_2 = JSON.parse(last_response.body)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'vars_2'</span>          </div>  </li></ol>
            expect(vars_2).to match_array([<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1025" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2126" class="js-smell-location">1</a>                  </div>  </li></ol>
              {&#39;id&#39; =&gt; &#39;var_id_1&#39;, &#39;name&#39; =&gt; &#39;var_name_1&#39;},
              {&#39;id&#39; =&gt; &#39;var_id_2&#39;, &#39;name&#39; =&gt; &#39;var_name_2&#39;},
              {&#39;id&#39; =&gt; &#39;var_id_3&#39;, &#39;name&#39; =&gt; &#39;var_name_3&#39;},
              {&#39;id&#39; =&gt; &#39;var_id_4&#39;, &#39;name&#39; =&gt; &#39;var_name_4&#39;}
            ])
          end

          context &#39;when deployment does not have variables&#39; do
            before { Models::Deployment.make(name: &#39;test_deployment_3&#39;, manifest: &#39;&#39;) }

            it &#39;returns an empty array&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(API calls)::describe(variables)::context(when deployment does not have variables)::it#returns an empty array has a flog score of 25</span>          </div>  </li></ol>
              get &#39;/test_deployment_3/variables&#39;
              expect(last_response.status).to eq(200)
              vars_3 = JSON.parse(last_response.body)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'vars_3'</span>          </div>  </li></ol>
              expect(vars_3).to be_empty
            end
          end
        end
      end

      describe &#39;authorization&#39; do
        before do
          release = Models::Release.make(name: &#39;bosh-release&#39;)
          template1 = Models::Template.make(name: &#39;foobar&#39;, release: release)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'template1'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1800" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2150" class="js-smell-location">1</a>                  </div>  </li></ol>
          template2 = Models::Template.make(name: &#39;errand1&#39;, release: release)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Api has the variable name 'template2'</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L1801" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2151" class="js-smell-location">1</a>                  </div>  </li></ol>
          release_version = Models::ReleaseVersion.make(version: &#39;0.1-dev&#39;, release: release)
          release_version.add_template(template1)
          release_version.add_template(template2)
        end

        let(:dev_team) { Models::Team.create(:name =&gt; &#39;dev&#39;) }
        let(:other_team) { Models::Team.create(:name =&gt; &#39;other&#39;) }
        let!(:owned_deployment) { Models::Deployment.create_with_teams(:name =&gt; &#39;owned_deployment&#39;, teams: [dev_team], manifest: manifest_with_errand(&#39;owned_deployment&#39;), cloud_configs: [cloud_config]) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2159" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2160" class="js-smell-location">1</a>                  </div>  </li></ol>
        let!(:other_deployment) { Models::Deployment.create_with_teams(:name =&gt; &#39;other_deployment&#39;, teams: [other_team], manifest: manifest_with_errand(&#39;other_deployment&#39;), cloud_configs: [cloud_config]) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2159" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2160" class="js-smell-location">1</a>                  </div>  </li></ol>
        describe &#39;when a user has dev team admin membership&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(authorization)::describe#when a user has dev team admin membership has a flog score of 25</span>          </div>  </li></ol>

          before {
            instance = Models::Instance.create(:deployment =&gt; owned_deployment, :job =&gt; &#39;dea&#39;, :index =&gt; 0, :state =&gt; :started, :uuid =&gt; &#39;F0753566-CA8E-4B28-AD63-7DB3903CD98C&#39;, :variable_set =&gt; Models::VariableSet.create(deployment: owned_deployment))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2164" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2165" class="js-smell-location">1</a>                  </div>  </li></ol>
            Models::Instance.create(:deployment =&gt; other_deployment, :job =&gt; &#39;dea&#39;, :index =&gt; 0, :state =&gt; :started, :uuid =&gt; &#39;72652FAA-1A9C-4803-8423-BBC3630E49C6&#39;, :variable_set =&gt; Models::VariableSet.create(deployment: other_deployment))<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2164" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2165" class="js-smell-location">1</a>                  </div>  </li></ol>
            Models::Vm.make(agent_id: &#39;random-id&#39;, instance_id: instance.id, active: true)
          }

          # dev-team-member has scopes [&#39;bosh.teams.dev.admin&#39;]
          before { basic_authorize &#39;dev-team-member&#39;, &#39;dev-team-member&#39; }

          context &#39;GET /:deployment/jobs/:job/:index_or_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/jobs/dea/0&#39;).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/jobs/dea/0&#39;).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/jobs/:job&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2182" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2192" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/jobs/dea?state=running&#39;, nil, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/jobs/dea?state=running&#39;, nil, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/jobs/:job/:index_or_id&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2182" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2192" class="js-smell-location">1</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/jobs/dea/0&#39;, nil, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/jobs/dea/0&#39;, nil, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/jobs/:job/:index_or_id/logs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/jobs/dea/0/logs&#39;).status).to eq(302)
            end
            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/jobs/dea/0/logs&#39;).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/snapshots&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/snapshots&#39;).status).to eq(200)
            end
            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/snapshots&#39;).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/jobs/:job/:index/snapshots&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/jobs/dea/0/snapshots&#39;).status).to eq(200)
            end
            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/jobs/dea/0/snapshots&#39;).status).to eq(401)
            end
          end

          context &#39;POST /:deployment/snapshots&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(post(&#39;/owned_deployment/snapshots&#39;).status).to eq(302)
            end
            it &#39;denies access to other deployment&#39; do
              expect(post(&#39;/other_deployment/snapshots&#39;).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/jobs/:job/:index_or_id/resurrection&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/jobs/dea/0/resurrection&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(200)
            end
            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/jobs/dea/0/resurrection&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/instance_groups/:instancegroup/:id/ignore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/instance_groups/dea/F0753566-CA8E-4B28-AD63-7DB3903CD98C/ignore&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(200)
            end
            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/instance_groups/dea/72652FAA-1A9C-4803-8423-BBC3630E49C6/ignore&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;POST /:deployment/jobs/:job/:index_or_id/snapshots&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(post(&#39;/owned_deployment/jobs/dea/0/snapshots&#39;).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(post(&#39;/other_deployment/jobs/dea/0/snapshots&#39;).status).to eq(401)
            end
          end

          context &#39;DELETE /:deployment/snapshots&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(delete(&#39;/owned_deployment/snapshots&#39;).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(delete(&#39;/other_deployment/snapshots&#39;).status).to eq(401)
            end
          end

          context &#39;DELETE /:deployment/snapshots/:cid&#39; do
            before do
              instance = Models::Instance.make(deployment: owned_deployment)
              persistent_disk = Models::PersistentDisk.make(instance: instance)
              Models::Snapshot.make(persistent_disk: persistent_disk, snapshot_cid: &#39;cid-1&#39;)
            end

            it &#39;allows access to owned deployment&#39; do
              expect(delete(&#39;/owned_deployment/snapshots/cid-1&#39;).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(delete(&#39;/other_deployment/snapshots/cid-1&#39;).status).to eq(401)
            end
          end

          context &#39;GET /:deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment&#39;).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment&#39;).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/vms&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/vms&#39;).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/vms&#39;).status).to eq(401)
            end
          end

          context &#39;DELETE /:deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(delete(&#39;/owned_deployment&#39;).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(delete(&#39;/other_deployment&#39;).status).to eq(401)
            end
          end

          context &#39;POST /:deployment/ssh&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(post(&#39;/owned_deployment/ssh&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(post(&#39;/other_deployment/ssh&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/properties&#39;).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/properties&#39;).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/properties/:property&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2342" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2374" class="js-smell-location">1</a>                  </div>  </li></ol>
            before { Models::DeploymentProperty.make(deployment: owned_deployment, name: &#39;prop&#39;, value: &#39;value&#39;) }
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/properties/prop&#39;).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/properties/prop&#39;).status).to eq(401)
            end
          end

          context &#39;POST /:deployment/properties&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(post(&#39;/owned_deployment/properties&#39;, &#39;{&quot;name&quot;: &quot;prop&quot;, &quot;value&quot;: &quot;bingo&quot;}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(204)
            end

            it &#39;denies access to other deployment&#39; do
              expect(post(&#39;/other_deployment/properties&#39;, &#39;{&quot;name&quot;: &quot;prop&quot;, &quot;value&quot;: &quot;bingo&quot;}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/properties/:property&#39; do
            before { Models::DeploymentProperty.make(deployment: owned_deployment, name: &#39;prop&#39;, value: &#39;value&#39;) }
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/properties/prop&#39;, &#39;{&quot;value&quot;: &quot;bingo&quot;}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(204)
            end

            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/properties/prop&#39;, &#39;{&quot;value&quot;: &quot;bingo&quot;}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;DELETE /:deployment/properties/:property&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2342" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2374" class="js-smell-location">1</a>                  </div>  </li></ol>
            before { Models::DeploymentProperty.make(deployment: owned_deployment, name: &#39;prop&#39;, value: &#39;value&#39;) }
            it &#39;allows access to owned deployment&#39; do
              expect(delete(&#39;/owned_deployment/properties/prop&#39;).status).to eq(204)
            end

            it &#39;denies access to other deployment&#39; do
              expect(delete(&#39;/other_deployment/properties/prop&#39;).status).to eq(401)
            end
          end

          context &#39;POST /:deployment/scans&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(post(&#39;/owned_deployment/scans&#39;).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(post(&#39;/other_deployment/scans&#39;).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/problems&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2172" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2202" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2211" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2220" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2229" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2256" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2266" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2292" class="js-smell-location">7</a>                  <a href="deployments_controller_spec.html#L2302" class="js-smell-location">8</a>                  <a href="deployments_controller_spec.html#L2312" class="js-smell-location">9</a>                  <a href="deployments_controller_spec.html#L2332" class="js-smell-location">10</a>                  <a href="deployments_controller_spec.html#L2385" class="js-smell-location">11</a>                  <a href="deployments_controller_spec.html#L2395" class="js-smell-location">12</a>                  <a href="../extensions/scoping_spec.html#L34" class="js-smell-location">13</a>                  <a href="../extensions/scoping_spec.html#L54" class="js-smell-location">14</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/problems&#39;).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/problems&#39;).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/problems&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/problems&#39;, &#39;{&quot;resolutions&quot;: {}}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/problems&#39;, &#39;&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/problems&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/problems&#39;, &#39;{&quot;resolutions&quot;: {}}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/problems&#39;, &#39;{&quot;resolutions&quot;: {}}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;PUT /:deployment/scan_and_fix&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(put(&#39;/owned_deployment/scan_and_fix&#39;, &#39;{&quot;jobs&quot;: []}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(put(&#39;/other_deployment/scan_and_fix&#39;, &#39;{&quot;jobs&quot;: []}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          describe &#39;POST /&#39; do
            it &#39;allows&#39; do
              expect(post(&#39;/&#39;, manifest_with_errand, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(302)
            end
          end

          context &#39;POST /:deployment/diff&#39; do
            it &#39;allows access to new deployment&#39; do
              expect(post(&#39;/new_deployment/diff&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(200)
            end

            it &#39;allows access to owned deployment&#39; do
              expect(post(&#39;/owned_deployment/diff&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(post(&#39;/other_deployment/diff&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(401)
            end
          end

          context &#39;POST /:deployment/errands/:errand_name/runs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 8 nodes</span>              <span>Locations:</span>                  <a href="deployments_controller_spec.html#L2238" class="js-smell-location">0</a>                  <a href="deployments_controller_spec.html#L2247" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2322" class="js-smell-location">2</a>                  <a href="deployments_controller_spec.html#L2353" class="js-smell-location">3</a>                  <a href="deployments_controller_spec.html#L2405" class="js-smell-location">4</a>                  <a href="deployments_controller_spec.html#L2415" class="js-smell-location">5</a>                  <a href="deployments_controller_spec.html#L2425" class="js-smell-location">6</a>                  <a href="deployments_controller_spec.html#L2455" class="js-smell-location">7</a>                  </div>  </li></ol>
            it &#39;allows access to owned deployment&#39; do
              expect(post(&#39;/owned_deployment/errands/errand_job/runs&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(302)
            end

            it &#39;denies access to other deployment&#39; do
              expect(post(&#39;/other_deployment/errands/errand_job/runs&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39; }).status).to eq(401)
            end
          end

          context &#39;GET /:deployment/errands&#39; do

            let(:cloud_config) { Models::Config.make(:cloud, content: YAML.dump(Bosh::Spec::NewDeployments.simple_cloud_config)) }

            it &#39;allows access to owned deployment&#39; do
              expect(get(&#39;/owned_deployment/errands&#39;).status).to eq(200)
            end

            it &#39;denies access to other deployment&#39; do
              expect(get(&#39;/other_deployment/errands&#39;).status).to eq(401)
            end
          end

          context &#39;GET /&#39; do
            it &#39;allows access to owned deployments&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(authorization)::describe(when a user has dev team admin membership)::context(GET /)::it#allows access to owned deployments has a flog score of 29</span>          </div>  </li></ol>
              response = get(&#39;/&#39;)
              expect(response.status).to eq(200)
              expect(response.body).to include(&#39;&quot;owned_deployment&quot;&#39;)
              expect(response.body).to_not include(&#39;&quot;other_deployment&quot;&#39;)
            end
          end
        end

        describe &#39;when the user has bosh.read scope&#39; do
          describe &#39;read endpoints&#39; do
            before { basic_authorize &#39;reader&#39;, &#39;reader&#39; }

            it &#39;allows access&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Api::describe(authorization)::describe(when the user has bosh.read scope)::describe(read endpoints)::it#allows access has a flog score of 41</span>          </div>  </li></ol>
              expect(get(&#39;/&#39;,).status).to eq(200)
              expect(get(&#39;/owned_deployment&#39;).status).to eq(200)
              expect(get(&#39;/owned_deployment/vms&#39;).status).to eq(200)
              expect(get(&#39;/no_deployment/errands&#39;).status).to eq(404)
            end
          end
        end
      end

      describe &#39;when the user merely has team read scope&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="cloud_configs_controller_spec.html#L71" class="js-smell-location">0</a>                  <a href="cloud_configs_controller_spec.html#L79" class="js-smell-location">1</a>                  <a href="deployments_controller_spec.html#L2502" class="js-smell-location">2</a>                  </div>  </li></ol>
        before { basic_authorize &#39;dev-team-read-member&#39;, &#39;dev-team-read-member&#39; }
        it &#39;denies access to POST /&#39; do
          expect(post(&#39;/&#39;, &#39;{}&#39;, { &#39;CONTENT_TYPE&#39; =&gt; &#39;text/yaml&#39; }).status).to eq(401)
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
