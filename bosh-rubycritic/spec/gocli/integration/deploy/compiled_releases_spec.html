<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-04-18 17:03:11 -0700'>2018-04-18 17:03:11 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/gocli/integration/deploy /</small> compiled_releases_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">202</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">1</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">308.11</span><small> complexity</small></div>
              <div><span class="metric">98</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                6
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;spec_helper&#39;
require &#39;fileutils&#39;

describe &#39;compiled releases&#39;, type: :integration do
  with_reset_sandbox_before_each

  context &#39;release and stemcell have been uploaded&#39; do
    before do
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)
    end

    context &#39;it uploads the compiled release when there is no corresponding stemcell&#39; do
      it &#39;should not raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(compiled releases)::context(release and stemcell have been uploaded)::context(it uploads the compiled release when there is no corresponding stemcell)::it#should not raise an error has a flog score of 36</span>          </div>  </li></ol>
        bosh_runner.run(&#39;delete-stemcell bosh-aws-xen-hvm-centos-7-go_agent/3001&#39;)
        bosh_runner.run(&#39;delete-release test_release&#39;)
        expect do
          bosh_runner.run(
            &quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;,
          )
        end.to_not raise_exception
        output = bosh_runner.run(&#39;inspect-release test_release/1&#39;, json: true)
        expect(table(output)).to include(
          &#39;package&#39; =&gt; &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;,
          &#39;blobstore_id&#39; =&gt; /[a-f0-9\-]{36}/,
          &#39;digest&#39; =&gt; &#39;735987b52907d970106f38413825773eec7cc577&#39;,
          &#39;compiled_for&#39; =&gt; &#39;centos-7/3001&#39;,
        )
        expect(table(output)).to include(
          &#39;package&#39; =&gt; &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;,
          &#39;blobstore_id&#39; =&gt; &#39;&#39;,
          &#39;digest&#39; =&gt; &#39;&#39;,
          &#39;compiled_for&#39; =&gt; &#39;(source)&#39;,
        )
      end
    end

    context &#39;when older compiled and newer non-compiled (source release) versions of the same release are uploaded&#39; do
      before do
        upload_cloud_config
      end

      context &#39;and they contain identical packages&#39; do
        let(:manifest) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compiled_releases_spec.html#L44" class="js-smell-location">0</a>                  <a href="compiled_releases_spec.html#L66" class="js-smell-location">1</a>                  </div>  </li></ol>
          manifest = Bosh::Spec::NewDeployments.test_deployment_manifest_with_job(&#39;job_using_pkg_5&#39;)
          manifest[&#39;stemcells&#39;].first.delete(&#39;os&#39;)
          manifest[&#39;stemcells&#39;].first[&#39;name&#39;] = &#39;bosh-aws-xen-hvm-centos-7-go_agent&#39;
          manifest[&#39;stemcells&#39;].first[&#39;version&#39;] = &#39;3001&#39;
          manifest[&#39;releases&#39;][0][&#39;version&#39;] = &#39;4&#39;
          manifest
        end

        before do
          release_path = spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-4-same-packages-as-1.tgz&#39;)
          bosh_runner.run(&quot;upload-release #{release_path}&quot;)
        end

        it &#39;does not compile any packages&#39; do
          output = deploy(manifest_hash: manifest)

          expect(output).to_not include(&#39;Started compiling packages&#39;)
        end
      end

      context &#39;and they contain one different package&#39; do
        let(:manifest) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compiled_releases_spec.html#L44" class="js-smell-location">0</a>                  <a href="compiled_releases_spec.html#L66" class="js-smell-location">1</a>                  </div>  </li></ol>
          manifest = Bosh::Spec::NewDeployments.test_deployment_manifest_with_job(&#39;job_using_pkg_5&#39;)
          manifest[&#39;stemcells&#39;].first.delete(&#39;os&#39;)
          manifest[&#39;stemcells&#39;].first[&#39;name&#39;] = &#39;bosh-aws-xen-hvm-centos-7-go_agent&#39;
          manifest[&#39;stemcells&#39;].first[&#39;version&#39;] = &#39;3001&#39;
          manifest[&#39;releases&#39;][0][&#39;version&#39;] = &#39;3&#39;
          manifest
        end

        before do
          release_path = spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-3-pkg1-updated.tgz&#39;)
          bosh_runner.run(&quot;upload-release #{release_path}&quot;)
        end

        it &#39;compiles only the package with the different version and those that depend on it&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(compiled releases)::context(release and stemcell have been uploaded)::context(when older compiled and newer non-compiled (source release) versions of the same release are uploaded)::context(and they contain one different package)::it#compiles only the package with the different version and those that depend on it has a flog score of 40</span>          </div>  </li></ol>
          out = deploy(manifest_hash: manifest)
          expect(out).to include(&#39;Compiling packages: pkg_1/b0fe23fce97e2dc8fd9da1035dc637ecd8fc0a0f&#39;)
          expect(out).to include(&#39;Compiling packages: pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;)

          expect(out).to_not include(&#39;Compiling packages: pkg_2/&#39;)
          expect(out).to_not include(&#39;Compiling packages: pkg_3_depends_on_2/&#39;)
          expect(out).to_not include(&#39;Compiling packages: pkg_4_depends_on_3/&#39;)
        end
      end

      context &#39;when deploying with a stemcell that does not match the compiled release&#39; do
        before do
          # switch deployment to use &quot;ubuntu-stemcell/1&quot;
          bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell.tgz&#39;)}&quot;)
          upload_cloud_config
        end

        it &#39;fails with an error message saying there is no way to compile for that stemcell&#39; do
          out = deploy(
            manifest_hash: Bosh::Spec::NewDeployments.test_deployment_manifest_with_job(&#39;job_using_pkg_5&#39;),
            failure_expected: true,
          )
          expect(out).to include(&#39;Error:&#39;)

          expect(out).to match_output &lt;&lt;~OUTPUT.strip
            Can&#39;t use release &#39;test_release/1&#39;. It references packages without source code and are not compiled against stemcell &#39;ubuntu-stemcell/1&#39;:
             - &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;
             - &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;
             - &#39;pkg_3_depends_on_2/413e3e9177f0037b1882d19fb6b377b5b715be1c&#39;
             - &#39;pkg_4_depends_on_3/9207b8a277403477e50cfae52009b31c840c49d4&#39;
             - &#39;pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;
          OUTPUT
        end

        context &#39;and multiple releases are referenced in the current deployment&#39; do
          before do
            release_path = spec_asset(&#39;compiled_releases/release-test_release_a-1-on-centos-7-stemcell-3001.tgz&#39;)
            bosh_runner.run(&quot;upload-release #{release_path}&quot;)
          end

          it &#39;fails with an error message saying there is no way to compile the releases for that stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(compiled releases)::context(release and stemcell have been uploaded)::context(when older compiled and newer non-compiled (source release) versions of the same release are uploaded)::context(when deploying with a stemcell that does not match the compiled release)::context(and multiple releases are referenced in the current deployment)::it#fails with an error message saying there is no way to compile the releases for that stemcell has a flog score of 28</span>          </div>  </li></ol>
            out = deploy(
              manifest_hash: Bosh::Spec::NewDeployments.test_deployment_manifest_referencing_multiple_releases,
              failure_expected: true,
            )
            expect(out).to include(&#39;Error:&#39;)

            expect(out).to match_output &lt;&lt;~OUTPUT.strip
              Can&#39;t use release &#39;test_release/1&#39;. It references packages without source code and are not compiled against stemcell &#39;ubuntu-stemcell/1&#39;:
               - &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;
               - &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;
            OUTPUT

            expect(out).to match_output &lt;&lt;~OUTPUT.strip
              Can&#39;t use release &#39;test_release_a/1&#39;. It references packages without source code and are not compiled against stemcell &#39;ubuntu-stemcell/1&#39;:
               - &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;
               - &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;
               - &#39;pkg_3_depends_on_2/413e3e9177f0037b1882d19fb6b377b5b715be1c&#39;
               - &#39;pkg_4_depends_on_3/9207b8a277403477e50cfae52009b31c840c49d4&#39;
               - &#39;pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;
            OUTPUT
          end
        end
      end
    end
  end

  context &#39;it exercises the entire compiled release lifecycle&#39; do
    let(:manifest) do
      Bosh::Spec::NewDeployments.manifest_with_release.merge(
        &#39;instance_groups&#39; =&gt; [
          {
            &#39;name&#39; =&gt; &#39;job_with_many_packages&#39;,
            &#39;templates&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;job_with_many_packages&#39;,
              },
            ],
            &#39;vm_type&#39; =&gt; &#39;a&#39;,
            &#39;instances&#39; =&gt; 1,
            &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;a&#39; }],
            &#39;stemcell&#39; =&gt; &#39;default&#39;,
          },
        ],<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="compiled_releases_spec.html#L164" class="js-smell-location">0</a>                  <a href="../package_dependencies_spec.html#L19" class="js-smell-location">1</a>                  </div>  </li></ol>
      )
    end

    it &#39;exports, deletes deployment &amp; stemcell, uploads compiled, uploads patch-level stemcell, deploys&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(compiled releases)::context(it exercises the entire compiled release lifecycle)::it#exports, deletes deployment & stemcell, uploads compiled, uploads patch-level stemcell, deploys has a flog score of 71</span>          </div>  </li></ol>
      upload_cloud_config

      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell.tgz&#39;)}&quot;)

      [
        &#39;jobs/job_with_blocking_compilation&#39;,
        &#39;packages/blocking_package&#39;,
        &#39;jobs/fails_with_too_much_output&#39;,
        &#39;packages/fails_with_too_much_output&#39;,
      ].each do |release_path|
        FileUtils.rm_rf(File.join(ClientSandbox.test_release_dir, release_path))
      end

      create_and_upload_test_release(force: true)

      manifest[&#39;stemcells&#39;].first[&#39;version&#39;] = &#39;latest&#39;
      deploy(manifest_hash: manifest)

      bosh_runner.run(&#39;export-release -d simple bosh-release/0.1-dev toronto-os/1&#39;)

      bosh_runner.run(&#39;delete-deployment -d simple&#39;)
      bosh_runner.run(&#39;delete-release bosh-release&#39;)
      bosh_runner.run(&#39;delete-stemcell ubuntu-stemcell/1&#39;)

      release_path = File.join(Bosh::Dev::Sandbox::Workspace.dir, &#39;client-sandbox&#39;, &#39;bosh_work_dir&#39;)
      bosh_runner.run(&quot;upload-release #{release_path}/bosh-release-0.1-dev-toronto-os-1-*.tgz&quot;)
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell_1_1.tgz&#39;)}&quot;)

      create_call_count = current_sandbox.cpi.invocations_for_method(&#39;create_vm&#39;).size
      deploy(manifest_hash: manifest)
      expect(current_sandbox.cpi.invocations_for_method(&#39;create_vm&#39;).size).to eq(create_call_count + 1)
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
