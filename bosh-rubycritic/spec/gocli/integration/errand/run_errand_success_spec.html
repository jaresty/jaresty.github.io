<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/gocli/integration/errand /</small> run_errand_success_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">586</span><small> lines of codes</small></div>
              <div><span class="metric">1</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">993.2</span><small> complexity/method</small></div>
              <div><span class="metric">59</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">993.23</span><small> complexity</small></div>
              <div><span class="metric">556</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                18
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require_relative &#39;../../spec_helper&#39;

#Errand failure/success were split up so that they can be run on different rspec:parallel threads
describe &#39;run-errand success&#39;, type: :integration, with_tmp_dir: true do
  let(:manifest_hash) { Bosh::Spec::NewDeployments.manifest_with_errand }
  let(:deployment_name) { manifest_hash[&#39;name&#39;] }

  context &#39;while errand is running&#39; do
    with_reset_sandbox_before_each

    let(:manifest_hash_errand) do
      manifest_hash[&#39;properties&#39;] = {
        &#39;errand1&#39; =&gt; {
          &#39;blocking_errand&#39; =&gt; true,
        },
      }
      manifest_hash
    end

    it &#39;creates a deployment lock&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(while errand is running)::it#creates a deployment lock has a flog score of 66</span>          </div>  </li></ol>
      deploy_from_scratch(manifest_hash: manifest_hash_errand, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)

      output = bosh_runner.run(&#39;run-errand fake-errand-name&#39;, deployment_name: deployment_name, no_track: true)
      task_id = Bosh::Spec::OutputParser.new(output).task_id(&#39;*&#39;)
      expect(director.wait_for_vm(&#39;fake-errand-name&#39;, &#39;0&#39;, 150, deployment_name: deployment_name)).to_not be_nil

      output = JSON.parse(bosh_runner.run_until_succeeds(&#39;locks --json&#39;))
      expect(output[&#39;Tables&#39;][0][&#39;Rows&#39;]).to include({&#39;type&#39; =&gt; &#39;deployment&#39;, &#39;resource&#39; =&gt; &#39;errand&#39;, &#39;expires_at&#39; =&gt; anything, &#39;task_id&#39; =&gt; /^[\d]*$/})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../cli_locks_spec.html#L13" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L28" class="js-smell-location">1</a>                  </div>  </li></ol>

      errand_instance = director.instances(deployment_name: deployment_name).find { |instance| instance.instance_group_name == &#39;fake-errand-name&#39; &amp;&amp; instance.index == &#39;0&#39; }
      expect(errand_instance).to_not be_nil

      errand_instance.unblock_errand(&#39;errand1&#39;)
      bosh_runner.run(&quot;task #{task_id}&quot;)
    end
  end

  context &#39;when multiple errands exist in the deployment manifest&#39; do
    with_reset_sandbox_before_each

    let(:manifest_hash) { Bosh::Spec::NewDeployments.manifest_with_errand }

    let(:errand_requiring_2_instances) do
      {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L44" class="js-smell-location">0</a>                  <a href="../../../support/new_deployments.html#L553" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;name&#39; =&gt; &#39;second-errand-name&#39;,
        &#39;jobs&#39; =&gt; [{
          &#39;release&#39; =&gt; &#39;bosh-release&#39;,
          &#39;name&#39; =&gt; &#39;errand1&#39;,
          &#39;properties&#39; =&gt; {
            &#39;errand1&#39; =&gt; {
              &#39;exit_code&#39; =&gt; 0,
              &#39;stdout&#39; =&gt; &#39;second-errand-stdout&#39;,
              &#39;stderr&#39; =&gt; &#39;second-errand-stderr&#39;,
              &#39;run_package_file&#39; =&gt; true,
            },
          },
        }],
        &#39;lifecycle&#39; =&gt; &#39;errand&#39;,
        &#39;vm_type&#39; =&gt; &#39;a&#39;,
        &#39;instances&#39; =&gt; 2,
        &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;a&#39;}],
        &#39;stemcell&#39; =&gt; &#39;default&#39;,
      }
    end

    context &#39;with a fixed size resource pool size&#39; do
      let(:cloud_config_hash) do
        cloud_config_hash = Bosh::Spec::NewDeployments.simple_cloud_config
        cloud_config_hash[&#39;vm_types&#39;].find { |type| type[&#39;name&#39;] == &#39;a&#39; }[&#39;size&#39;] = 3
        cloud_config_hash
      end

      it &quot;reuses vms when keep-alive is set and cleans them up when it&#39;s not&quot; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L73" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L111" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when multiple errands exist in the deployment manifest)::context(with a fixed size resource pool size)::it#reuses vms when keep-alive is set and cleans them up when it's not has a flog score of 99</span>          </div>  </li></ol>
        manifest_with_second_errand = manifest_hash
        manifest_with_second_errand[&#39;instance_groups&#39;] &lt;&lt; errand_requiring_2_instances
        deploy_from_scratch(cloud_config_hash: cloud_config_hash, manifest_hash: manifest_with_second_errand)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1}, {deployment_name: deployment_name})
        expect_errands(&#39;fake-errand-name&#39;, &#39;second-errand-name&#39;)

        # with keep alive, does not delete/create errand vms (always exactly 1 fake-errand-name/0)
        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name --keep-alive&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;fake-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1, &#39;fake-errand-name&#39; =&gt; 1}, {deployment_name: deployment_name})

        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name --keep-alive&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;fake-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1, &#39;fake-errand-name&#39; =&gt; 1}, {deployment_name: deployment_name})

        # without keep alive, deletes vm (no fake-errand-name/0)
        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;fake-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1}, {deployment_name: deployment_name})

        output, exit_code = bosh_runner.run(&#39;run-errand second-errand-name&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;second-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1}, {deployment_name: deployment_name})
      end
    end

    context &#39;with a dynamically sized resource pool size&#39; do
      let(:cloud_config_hash) do
        cloud_config_hash = Bosh::Spec::NewDeployments.simple_cloud_config
        cloud_config_hash[&#39;vm_types&#39;].find { |type| type[&#39;name&#39;] == &#39;a&#39; }.delete(&#39;size&#39;)
        cloud_config_hash
      end

      it &#39;allocates and de-allocates errand vms for each errand run&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L73" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L111" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when multiple errands exist in the deployment manifest)::context(with a dynamically sized resource pool size)::it#allocates and de-allocates errand vms for each errand run has a flog score of 99</span>          </div>  </li></ol>
        manifest_with_second_errand = manifest_hash
        manifest_with_second_errand[&#39;instance_groups&#39;] &lt;&lt; errand_requiring_2_instances
        deploy_from_scratch(cloud_config_hash: cloud_config_hash, manifest_hash: manifest_with_second_errand)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1}, {deployment_name: deployment_name})

        expect_errands(&#39;fake-errand-name&#39;, &#39;second-errand-name&#39;)

        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name --keep-alive&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;fake-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1, &#39;fake-errand-name&#39; =&gt; 1}, {deployment_name: deployment_name})

        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name --keep-alive&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;fake-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1, &#39;fake-errand-name&#39; =&gt; 1}, {deployment_name: deployment_name})

        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;fake-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1}, {deployment_name: deployment_name})

        output, exit_code = bosh_runner.run(&#39;run-errand second-errand-name&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;second-errand-stdout&#39;)
        expect(exit_code).to eq(0)
        expect_running_vms_with_names_and_count({&#39;foobar&#39; =&gt; 1}, {deployment_name: deployment_name})
      end
    end
  end

  context &#39;when the --when-changed flag is specified&#39; do
    with_reset_sandbox_before_each

    before do
      deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)
      bosh_runner.run(&#39;run-errand fake-errand-name&#39;, return_exit_code: true, deployment_name: deployment_name)
    end

    context &#39;when the errand configuration has not changed&#39; do
      it &#39;does not re-run the errand&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when the --when-changed flag is specified)::context(when the errand configuration has not changed)::it#does not re-run the errand has a flog score of 30</span>          </div>  </li></ol>
        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name --when-changed&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(exit_code).to eq(0)
        errand_task_id = bosh_runner.get_most_recent_task_id
        task_result = bosh_runner.run(&quot;task #{errand_task_id} --result&quot;, deployment_name: deployment_name)
        expect(task_result).to_not include(&#39;{&quot;exit_code&quot;:0,&quot;stdout&quot;:&quot;&quot;,&quot;stderr&quot;:&quot;&quot;,&quot;logs&quot;:{}}&#39;)
        expect(output).not_to match(&#39;Creating missing vms&#39;)
      end
    end

    context &#39;when the errand configuration has changed&#39; do
      it &#39;reruns the errand&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when the --when-changed flag is specified)::context(when the errand configuration has changed)::it#reruns the errand has a flog score of 49</span>          </div>  </li></ol>
        manifest_hash[&#39;instance_groups&#39;].find { |instance_group| instance_group[&#39;name&#39;] == &#39;fake-errand-name&#39; }[&#39;jobs&#39;].first[&#39;properties&#39;] = {
          &#39;errand1&#39; =&gt; {
            &#39;exit_code&#39; =&gt; 0,
            &#39;stdout&#39; =&gt; &quot;new-stdout\nadditional-stdout&quot;,
            &#39;stderr&#39; =&gt; &#39;new-stderr&#39;,
            &#39;run_package_file&#39; =&gt; true,
          }
        }

        deploy_simple_manifest(manifest_hash: manifest_hash)

        output, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name --when-changed&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(exit_code).to eq(0)
        expect(output).to match(&#39;Creating missing vms&#39;) # output should indicate errand runs
        errand_task_id = bosh_runner.get_most_recent_task_id
        task_result = bosh_runner.run(&quot;task #{errand_task_id} --result&quot;, deployment_name: deployment_name)
        expect(task_result).to match(&#39;&quot;exit_code&quot;:0&#39;)
        expect(task_result).to match(/&quot;stdout&quot;:&quot;job=fake-errand-name index=0 id=.{36}\\nnew-stdout\\nadditional-stdout/)
      end
    end
  end

  describe &#39;network update is required for the job vm&#39; do
    with_reset_sandbox_before_each

    context &#39;when running an errand will require to recreate vm&#39; do
      let(:static_ip) { &#39;192.168.1.13&#39; }
      let(:manifest_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::describe(network update is required for the job vm)::context(when running an errand will require to recreate vm)::let#manifest_hash has a flog score of 29</span>          </div>  </li></ol>
        # This test setup depends on questionable bosh behavior.
        # The vm for the errand will be created at deploy time,
        # but it will not have the requested static ip.
        # When the errand is run, a network update will be required.
        # The network update will fail, by default dummy CPI will
        # raise NotSupported, like the aws cpi.
        manifest_hash = Bosh::Spec::NewDeployments.manifest_with_errand

        # get rid of the non-errand job, it&#39;s not important
        manifest_hash[&#39;instance_groups&#39;].delete(manifest_hash[&#39;instance_groups&#39;].find { |i| i[&#39;name&#39;] == &#39;foobar&#39; })
        errand_job = manifest_hash[&#39;instance_groups&#39;].find { |i| i[&#39;name&#39;] == &#39;fake-errand-name&#39; }
        errand_job_network_a = errand_job[&#39;networks&#39;].find { |i| i[&#39;name&#39;] == &#39;a&#39; }
        errand_job_network_a[&#39;static_ips&#39;] = [static_ip]

        manifest_hash
      end

      let(:cloud_config_hash) do
        cloud_config_hash = Bosh::Spec::NewDeployments.simple_cloud_config
        # set the errand job to have a static ip to trigger the network update
        # at errand run time.
        network_a = cloud_config_hash[&#39;networks&#39;].find { |i| i[&#39;name&#39;] == &#39;a&#39; }
        network_a_subnet = network_a[&#39;subnets&#39;].first
        network_a_subnet[&#39;reserved&#39;] = [
          &#39;192.168.1.2 - 192.168.1.10&#39;,
          &#39;192.168.1.14 - 192.168.1.254&#39;
        ]
        network_a_subnet[&#39;static&#39;] = [static_ip]

        # setting the size of the pool causes the empty vm to be created
        # at deploy time, and this vm will not have the static IP the job has requested
        # When the errand runs it will try to reuse this unassigned vm and it will
        # require network update since it has static IP.
        vm_type_a = cloud_config_hash[&#39;vm_types&#39;].find { |i| i[&#39;name&#39;] == &#39;a&#39; }
        vm_type_a[&#39;size&#39;] = 1
        cloud_config_hash
      end

      it &#39;should tear down the VM successfully after running the errand&#39; do
        deploy_from_scratch(cloud_config_hash: cloud_config_hash, manifest_hash: manifest_hash)

        _, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(exit_code).to eq(0)
      end
    end

    context &#39;when the number of dynamic IPs is equal to the total number of vms&#39; do
      let(:manifest_hash) do
        Bosh::Spec::NewDeployments.manifest_with_release.merge({
          &#39;instance_groups&#39; =&gt; [{
            &#39;name&#39; =&gt; &#39;fake-errand-name&#39;,
            &#39;jobs&#39; =&gt; [{
              &#39;release&#39; =&gt; &#39;bosh-release&#39;,
              &#39;name&#39; =&gt; &#39;errand_without_package&#39;
            }],
            &#39;vm_type&#39; =&gt; &#39;fake-vm-type&#39;,
            &#39;instances&#39; =&gt; 1,
            &#39;lifecycle&#39; =&gt; &#39;errand&#39;,
            &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;fake-network&#39;}],
            &#39;stemcell&#39; =&gt; &#39;default&#39;,
          }]
        })
      end

      let(:cloud_config_hash) do
        {
          &#39;compilation&#39; =&gt; {
            &#39;workers&#39; =&gt; 1,
            &#39;network&#39; =&gt; &#39;fake-network&#39;,
            &#39;cloud_properties&#39; =&gt; {},
          },
          &#39;networks&#39; =&gt; [
            {
              &#39;name&#39; =&gt; &#39;fake-network&#39;,
              &#39;subnets&#39; =&gt; [
                {
                  &#39;range&#39; =&gt; &#39;192.168.1.0/24&#39;,
                  &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                  &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                  &#39;reserved&#39; =&gt;
                    [&#39;192.168.1.2 - 192.168.1.12&#39;,
                      &#39;192.168.1.14 - 192.168.1.254&#39;],
                  &#39;cloud_properties&#39; =&gt; {}
                }
              ]
            }
          ],
          &#39;vm_types&#39; =&gt; [
            {
              &#39;name&#39; =&gt; &#39;fake-vm-type&#39;,
              &#39;size&#39; =&gt; 1,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;network&#39; =&gt; &#39;fake-network&#39;,
              &#39;stemcell&#39; =&gt; {
                &#39;name&#39; =&gt; &#39;ubuntu-stemcell&#39;,
                &#39;version&#39; =&gt; &#39;1&#39;,
              },
            }
          ]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../../../../bosh-director/spec/unit/deployment_plan/placement_planner/static_ips_availability_zone_picker_spec.html#L74" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L289" class="js-smell-location">1</a>                  </div>  </li></ol>
        }
      end

      before { deploy_from_scratch(cloud_config_hash: cloud_config_hash, manifest_hash: manifest_hash) }

      it &#39;should have enough IPs to recreate the vm&#39; do
        _, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(exit_code).to eq(0)
      end
    end
  end

  context &#39;when errand script exits with 0 exit code&#39; do
    with_reset_sandbox_before_all
    with_tmp_dir_before_all

    it &#39;returns 0 as exit code from the cli and indicates that errand ran successfully&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when errand script exits with 0 exit code)::it#returns 0 as exit code from the cli and indicates that errand ran successfully has a flog score of 66</span>          </div>  </li></ol>
      deploy_from_scratch(manifest_hash: Bosh::Spec::NewDeployments.manifest_with_errand, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)
      expect_errands(&#39;fake-errand-name&#39;)

      @output, @exit_code = bosh_runner.run(&#39;run-errand fake-errand-name&#39;,
        {return_exit_code: true, json: true, deployment_name: &#39;errand&#39;})

      output = scrub_random_ids(table(@output))

      expect(output[0][&#39;instance&#39;]).to match(&#39;fake-errand-name/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#39;)
      expect(output[0][&#39;stdout&#39;]).to match(&#39;fake-errand-stdout&#39;)
      expect(output[0][&#39;stderr&#39;]).to match(&#39;fake-errand-stderr&#39;)
      expect(output[0][&#39;exit_code&#39;]).to match(&#39;0&#39;)

      expect(@exit_code).to eq(0)
      output = bosh_runner.run(&#39;events --object-type errand&#39;, deployment_name: &#39;errand&#39;, json: true)
      events = scrub_event_time(scrub_random_cids(scrub_random_ids(table(output))))
      expect(events).to contain_exactly(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L323" class="js-smell-location">0</a>                  <a href="../orphaned_disks_spec.html#L78" class="js-smell-location">1</a>                  </div>  </li></ol>
        {&#39;id&#39; =&gt; /[0-9]{1,3} &lt;- [0-9]{1,3}/, &#39;time&#39; =&gt; &#39;xxx xxx xx xx:xx:xx UTC xxxx&#39;, &#39;user&#39; =&gt; &#39;test&#39;, &#39;action&#39; =&gt; &#39;run&#39;, &#39;object_type&#39; =&gt; &#39;errand&#39;, &#39;task_id&#39; =&gt; /[0-9]{1,3}/, &#39;object_name&#39; =&gt; &#39;fake-errand-name&#39;, &#39;deployment&#39; =&gt; &#39;errand&#39;, &#39;instance&#39; =&gt; &#39;fake-errand-name/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx (0)&#39;, &#39;context&#39; =&gt; &#39;exit_code: 0&#39;, &#39;error&#39; =&gt; &#39;&#39;},
        {&#39;id&#39; =&gt; /[0-9]{1,3}/, &#39;time&#39; =&gt; &#39;xxx xxx xx xx:xx:xx UTC xxxx&#39;, &#39;user&#39; =&gt; &#39;test&#39;, &#39;action&#39; =&gt; &#39;run&#39;, &#39;object_type&#39; =&gt; &#39;errand&#39;, &#39;task_id&#39; =&gt; /[0-9]{1,3}/, &#39;object_name&#39; =&gt; &#39;fake-errand-name&#39;, &#39;deployment&#39; =&gt; &#39;errand&#39;, &#39;instance&#39; =&gt; &#39;fake-errand-name/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx (0)&#39;, &#39;context&#39; =&gt; &#39;&#39;, &#39;error&#39; =&gt; &#39;&#39;},
      )
    end

    context &#39;when downloading logs&#39; do
      context &#39;regular errand&#39; do
        before(:all) do
          deploy_from_scratch(manifest_hash: Bosh::Spec::NewDeployments.manifest_with_errand, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)
          expect_errands(&#39;fake-errand-name&#39;)

          @output, @exit_code = bosh_runner.run(&quot;run-errand fake-errand-name --download-logs --logs-dir #{@tmp_dir}&quot;,
            {return_exit_code: true, json: true, deployment_name: &#39;errand&#39;})
        end

        it &#39;shows bin/run stdout and stderr&#39; do
          expect(@output).to include(&#39;fake-errand-stdout&#39;)
          expect(@output).to include(&#39;fake-errand-stderr&#39;)
        end

        it &#39;shows output generated by package script which proves dependent packages are included&#39; do
          expect(@output).to include(&#39;stdout-from-errand1-package&#39;)
        end

        it &#39;downloads errand logs and shows downloaded location&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when errand script exits with 0 exit code)::context(when downloading logs)::context(regular errand)::it#downloads errand logs and shows downloaded location has a flog score of 25</span>          </div>  </li></ol>
          expect(@output =~ /Downloading resource .* to &#39;(.*fake-errand-name[0-9-]*\.tgz)&#39;/).to_not(be_nil, @output)
          logs_file = Bosh::Spec::TarFileInspector.new($1)
          expect(logs_file.file_names).to match_array(%w(./errand1/stdout.log ./custom.log))
          expect(logs_file.smallest_file_size).to be &gt; 0
        end
      end

      context &#39;utf8 errand output&#39; do
        before do
          manifest = Bosh::Spec::NewDeployments.manifest_with_errand
          manifest[&#39;instance_groups&#39;] = [{
            &#39;name&#39; =&gt; &#39;fake-errand-name&#39;,
            &#39;jobs&#39; =&gt; [
              {
                &#39;release&#39; =&gt; &#39;bosh-release&#39;,
                &#39;name&#39; =&gt; &#39;emoji-errand&#39;
              }
            ],
            &#39;lifecycle&#39; =&gt; &#39;errand&#39;,
            &#39;vm_type&#39; =&gt; &#39;a&#39;,
            &#39;instances&#39; =&gt; 1,
            &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;a&#39;}],
            &#39;stemcell&#39; =&gt; &#39;default&#39;
          }]

          deploy_from_scratch(manifest_hash: manifest, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)
          expect_errands(&#39;fake-errand-name&#39;)

          @output, @exit_code = bosh_runner.run(&quot;run-errand fake-errand-name --download-logs --logs-dir #{@tmp_dir}&quot;,
            {return_exit_code: true, json: false, deployment_name: &#39;errand&#39;})
        end

        it &#39;shows output&#39; do
          # until #147467271, we can&#39;t confidently know if the mysql database server can properly handle utf8.
          # since that is scheduled soon, avoid crazy hacks to have separate tests here
          expect(@output).to match(/errand is (&lt;bosh-non-ascii-char&gt;|\u{1F600})/)
        end
      end
    end
  end

  context &#39;when manifest file is greater than 64Kb&#39; do
    with_reset_sandbox_before_each

    let(:manifest_hash) do
      large_property = 64.times.inject(&#39;&#39;) { |p| p &lt;&lt; &#39;a&#39;*1024 } # generates 64Kb string
      manifest = {&#39;large_property&#39; =&gt; large_property}
      manifest.merge(Bosh::Spec::NewDeployments.manifest_with_errand)
    end

    it &#39;deploys successfully&#39; do
      deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)

      _, exit_code = bosh_runner.run(&#39;run-errand fake-errand-name&#39;, {return_exit_code: true, deployment_name: deployment_name})
      expect(exit_code).to eq(0)
    end
  end

  context &#39;when configured with addons&#39; do
    with_reset_sandbox_before_each
    with_tmp_dir_before_all

    let(:runtime_config_hash) do
      config_hash = Bosh::Spec::Deployments.runtime_config_with_addon
      config_hash[&#39;releases&#39;][0][&#39;name&#39;] = &#39;bosh-release&#39;
      config_hash[&#39;releases&#39;][0][&#39;version&#39;] = &#39;0.1-dev&#39;
      config_hash[&#39;addons&#39;][0][&#39;jobs&#39;] = [{ &#39;name&#39; =&gt; &#39;has_drain_script&#39;, &#39;release&#39; =&gt; &#39;bosh-release&#39; }]
      config_hash
    end

    let(:manifest_with_errand) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L419" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L451" class="js-smell-location">1</a>                  </div>  </li></ol>
      errand = Bosh::Spec::NewDeployments.manifest_with_errand
      errand[&#39;instance_groups&#39;][1][&#39;jobs&#39;] &lt;&lt; {
        &#39;release&#39; =&gt; &#39;bosh-release&#39;,
        &#39;name&#39; =&gt; &#39;foobar_without_packages&#39;,
      }
      errand
    end

    it &#39;does not stop jobs after the errand has run&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when configured with addons)::it#does not stop jobs after the errand has run has a flog score of 96</span>          </div>  </li></ol>
      deploy_from_scratch(manifest_hash: manifest_with_errand,
        runtime_config_hash: runtime_config_hash,
        cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)
      _, exit_code = bosh_runner.run(&quot;run-errand --keep-alive fake-errand-name --download-logs --logs-dir #{@tmp_dir}&quot;, {return_exit_code: true, deployment_name: deployment_name})
      expect(exit_code).to eq(0)

      instance = director.instance(&#39;fake-errand-name&#39;, &#39;0&#39;, deployment_name: deployment_name)

      expect(instance.last_known_state).to eq(&#39;running&#39;)

      agent_log = File.read(&quot;#{current_sandbox.agent_tmp_path}/agent.#{instance.agent_id}.log&quot;)
      expect(agent_log.scan(&#39;{&quot;protocol&quot;:3,&quot;method&quot;:&quot;drain&quot;&#39;).size).to eq(1)
      expect(agent_log.scan(&#39;{&quot;protocol&quot;:3,&quot;method&quot;:&quot;stop&quot;&#39;).size).to eq(1)
      expect(agent_log.scan(&#39;{&quot;protocol&quot;:3,&quot;method&quot;:&quot;run_script&quot;,&quot;arguments&quot;:[&quot;pre-start&quot;,&#39;).size).to eq(1)
      expect(agent_log.scan(&#39;{&quot;protocol&quot;:3,&quot;method&quot;:&quot;start&quot;&#39;).size).to eq(1)
      expect(agent_log.scan(&#39;{&quot;protocol&quot;:3,&quot;method&quot;:&quot;run_script&quot;,&quot;arguments&quot;:[&quot;post-start&quot;,&#39;).size).to eq(1)
      expect(agent_log.scan(&#39;{&quot;protocol&quot;:3,&quot;method&quot;:&quot;run_errand&quot;,&#39;).size).to eq(1)
      expect(agent_log.scan(&#39;{&quot;protocol&quot;:3,&quot;method&quot;:&quot;fetch_logs&quot;,&#39;).size).to eq(1)
    end
  end

  context &#39;errand name != first job&#39; do
    let(:manifest_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L419" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L451" class="js-smell-location">1</a>                  </div>  </li></ol>
      manifest_hash = Bosh::Spec::NewDeployments.manifest_with_errand_on_service_instance
      manifest_hash[&#39;instance_groups&#39;][0][&#39;jobs&#39;].unshift(
        {&#39;release&#39; =&gt; &#39;bosh-release&#39;, &#39;name&#39; =&gt; &#39;foobar&#39;}
      )
      manifest_hash
    end

    with_reset_sandbox_before_each

    it &#39;should run the requested bin/run on the first instance&#39; do
      deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)

      output, exit_code = bosh_runner.run(&#39;run-errand errand1&#39;, return_exit_code: true, deployment_name: deployment_name)
      expect(output).to include(&#39;fake-errand-stdout&#39;)
      expect(exit_code).to eq(0)
    end
  end

  context &#39;when instance lifecycle = service&#39; do
    with_reset_sandbox_before_each

    let(:manifest_hash) do
      Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups.merge({&#39;instance_groups&#39; =&gt; [
        {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L475" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L496" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;name&#39; =&gt; &#39;service-with-errand&#39;,
          &#39;jobs&#39; =&gt; [{
            &#39;release&#39; =&gt; &#39;bosh-release&#39;,
            &#39;name&#39; =&gt; &#39;errand1&#39;,
            &#39;properties&#39; =&gt; {
              &#39;errand1&#39; =&gt; {
                &#39;exit_code&#39; =&gt; 0,
                &#39;stdout&#39; =&gt; &#39;service-errand-stdout&#39;,
                &#39;stderr&#39; =&gt; &#39;service-errand-stderr&#39;,
                &#39;run_package_file&#39; =&gt; true,
              },
            },

          }],
          &#39;lifecycle&#39; =&gt; &#39;service&#39;,
          &#39;vm_type&#39; =&gt; &#39;a&#39;,
          &#39;stemcell&#39; =&gt; &#39;default&#39;,
          &#39;instances&#39; =&gt; 2,
          &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;a&#39;}],
        },
        {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="run_errand_success_spec.html#L475" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L496" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;name&#39; =&gt; &#39;errand-with-same-errand-and-multiple-instances&#39;,
          &#39;jobs&#39; =&gt; [{
            &#39;release&#39; =&gt; &#39;bosh-release&#39;,
            &#39;name&#39; =&gt; &#39;errand1&#39;,
            &#39;properties&#39; =&gt; {
              &#39;errand1&#39; =&gt; {
                &#39;exit_code&#39; =&gt; 0,
                &#39;stdout&#39; =&gt; &#39;service-errand-stdout&#39;,
                &#39;stderr&#39; =&gt; &#39;service-errand-stderr&#39;,
                &#39;run_package_file&#39; =&gt; true,
              },
            },
          }],
          &#39;lifecycle&#39; =&gt; &#39;errand&#39;,
          &#39;vm_type&#39; =&gt; &#39;a&#39;,
          &#39;stemcell&#39; =&gt; &#39;default&#39;,
          &#39;instances&#39; =&gt; 2,
          &#39;networks&#39; =&gt; [{&#39;name&#39; =&gt; &#39;a&#39;}],
        }
      ]})
    end

    context &#39;running with /first&#39; do
      it &#39;runs the errand on the first instance (ordered by uuid)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(run-errand success)::context(when instance lifecycle = service)::context(running with /first)::it(runs the errand on the first instance (ordered by uuid))#runs the errand on the first instance (ordered by uuid) has a flog score of 46</span>          </div>  </li></ol>
        deploy_from_scratch(manifest_hash: manifest_hash)
        first = director.instances.select{ |i| i.instance_group_name == &#39;service-with-errand&#39; }.map(&amp;:id).sort.first

        # with keep alive, does not delete/create errand vms (always exactly 1 fake-errand-name/0)
        output, exit_code = bosh_runner.run(&#39;run-errand errand1 --instance service-with-errand/first&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;service-errand-stdout&#39;)
        expect(output).to include(&quot;Instance   service-with-errand/#{first}&quot;)
        expect(exit_code).to eq(0)
      end
    end
  end

  describe &#39;behavior on older stemcells&#39; do
    let(:cloud_properties) do
      { &#39;legacy_agent_path&#39; =&gt; get_legacy_agent_path(&#39;before-info-endpoint-20170719&#39;) }
    end

    let(:manifest_hash) do
      Bosh::Spec::NewDeployments.manifest_with_errand_on_service_instance
    end

    let(:cloud_config_hash) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../create_swap_delete_update_spec.html#L25" class="js-smell-location">0</a>                  <a href="run_errand_success_spec.html#L542" class="js-smell-location">1</a>                  </div>  </li></ol>
      cloud_config_hash = Bosh::Spec::NewDeployments.simple_cloud_config
      cloud_config_hash[&#39;vm_types&#39;][0][&#39;cloud_properties&#39;] = cloud_properties
      cloud_config_hash
    end

    let(:agent_binary) { &#39;legacy-agent-name&#39; }

    with_reset_sandbox_before_each(nats_allow_legacy_clients: true)

    context &#39;errand name = first job&#39; do
      it &#39;should run the errand on the first instance&#39; do
        deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: cloud_config_hash)

        output, exit_code = bosh_runner.run(&#39;run-errand errand1&#39;, return_exit_code: true, deployment_name: deployment_name)
        expect(output).to include(&#39;fake-errand-stdout&#39;)
        expect(exit_code).to eq(0)
      end
    end

    context &#39;errand name != first job&#39; do
      let(:manifest_hash_with_later_errand) do
        manifest_hash[&#39;instance_groups&#39;][0][&#39;jobs&#39;].unshift(
          {&#39;release&#39; =&gt; &#39;bosh-release&#39;, &#39;name&#39; =&gt; &#39;foobar&#39;}
        )
        manifest_hash
      end

      it &#39;errors with helpful message&#39; do
        deploy_from_scratch(manifest_hash: manifest_hash_with_later_errand, cloud_config_hash: cloud_config_hash)

        output, exit_code = bosh_runner.run(&#39;run-errand errand1&#39;, return_exit_code: true, deployment_name: deployment_name, failure_expected: true)
        expect(output).to include(&#39;Multiple jobs are configured on an older stemcell, and &quot;errand1&quot; is not the first job&#39;)
        expect(exit_code).to eq(1)
      end
    end
  end

  def expect_errands(*expected_errands)
    output, _ = bosh_runner.run(&#39;errands&#39;, deployment_name: &#39;errand&#39;)
    expected_errands.each do |errand|
      expect(output).to include(errand)
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
