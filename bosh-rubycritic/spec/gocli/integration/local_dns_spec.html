<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/gocli/integration /</small> local_dns_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">433</span><small> lines of codes</small></div>
              <div><span class="metric">9</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">92.9</span><small> complexity/method</small></div>
              <div><span class="metric">44</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">836.51</span><small> complexity</small></div>
              <div><span class="metric">228</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                16
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require_relative &#39;../spec_helper&#39;
require &#39;fileutils&#39;

describe &#39;local DNS&#39;, type: :integration do
  with_reset_sandbox_before_each(dns_enabled: false, local_dns: {&#39;enabled&#39; =&gt; true, &#39;include_index&#39; =&gt; false})

  let(:cloud_config) { Bosh::Spec::NewDeployments.simple_cloud_config_with_multiple_azs }
  let(:network_name) { &#39;local-dns&#39; }

  before do
    cloud_config[&#39;networks&#39;][0][&#39;name&#39;] = network_name
    cloud_config[&#39;compilation&#39;][&#39;network&#39;] = network_name
    upload_cloud_config({cloud_config_hash: cloud_config})
    upload_stemcell
    create_and_upload_test_release(force: true)
  end

  let(:ip_regexp) { /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/ }
  let(:instance_group_name) { &#39;job_to_test_local_dns&#39; }
  let(:canonical_instance_group_name) { &#39;job-to-test-local-dns&#39; }
  let(:deployment_name) { &#39;simple.local_dns&#39; }
  let(:canonical_deployment_name) { &#39;simplelocal-dns&#39; }
  let(:canonical_network_name) { &#39;local-dns&#39; }

  context &#39;small 1 instance deployment&#39; do
    it &#39;sends sync_dns action agent and updates /etc/hosts&#39; do
      initial_deployment(1)
    end
  end

  it &#39;sends records for vms that have not yet been created&#39; do
    initial_manifest = initial_manifest(2, 1)
    initial_manifest[&#39;instance_groups&#39;][0][&#39;jobs&#39;] = [&#39;name&#39; =&gt; &#39;local_dns_records_json&#39;]
    deploy_simple_manifest(manifest_hash: initial_manifest)

    instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)

    recordsHash = JSON.parse(instance.read_file(&#39;records-at-prestart.json&#39;))
    expect(recordsHash[&#39;records&#39;].size).to equal(2)
  end

  context &#39;upgrade and downgrade increasing concurrency&#39; do
    context &#39;upgrade deployment from 1 to 10 instances&#39; do
      it &#39;sends sync_dns action to all agents and updates agent dns config&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(local DNS)::context(upgrade and downgrade increasing concurrency)::context(upgrade deployment from 1 to 10 instances)::it#sends sync_dns action to all agents and updates agent dns config has a flog score of 61</span>          </div>  </li></ol>
        manifest_deployment = initial_deployment(1, 5)
        manifest_deployment[&#39;instance_groups&#39;][0][&#39;instances&#39;] = 10
        deploy_simple_manifest(manifest_hash: manifest_deployment)

        etc_hosts = parse_agent_etc_hosts(9)
        expect(etc_hosts.size).to eq(10), &quot;expected etc_hosts to have 10 lines, got contents #{etc_hosts} with size #{etc_hosts.size}&quot;
        expect(etc_hosts).to match_array(generate_instance_dns)


        (0..9).each do |index|
          records_json = parse_agent_records_json(index)
          expect(records_json[&#39;records&#39;]).to match_array(generate_instance_records)
          expect(records_json[&#39;record_keys&#39;]).to match_array([&#39;id&#39;, &#39;num_id&#39;, &#39;instance_group&#39;, &#39;group_ids&#39;, &#39;az&#39;, &#39;az_id&#39;, &#39;network&#39;, &#39;network_id&#39;, &#39;deployment&#39;, &#39;ip&#39;, &#39;domain&#39;, &#39;agent_id&#39;, &#39;instance_index&#39;])
          expect(records_json[&#39;record_infos&#39;]).to match_array(generate_instance_record_infos)
          expect(records_json[&#39;version&#39;]).to eq(10)
        end
      end
    end

    context &#39;concurrency tests&#39; do
      let(:manifest_deployment) { initial_deployment(10, 5) }

      it &#39;deploys and downgrades with max_in_flight&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(local DNS)::context(upgrade and downgrade increasing concurrency)::context(concurrency tests)::it#deploys and downgrades with max_in_flight has a flog score of 54</span>          </div>  </li></ol>
        manifest_deployment[&#39;instance_groups&#39;][0][&#39;instances&#39;] = 5
        deploy_simple_manifest(manifest_hash: manifest_deployment)
        etc_hosts = parse_agent_etc_hosts(4)
        expect(etc_hosts.size).to eq(5), &quot;expected etc_hosts to have 5 lines, got contents #{etc_hosts} with size #{etc_hosts.size}&quot;
        expect(etc_hosts).to match_array(generate_instance_dns)

        manifest_deployment[&#39;instance_groups&#39;][0][&#39;instances&#39;] = 6
        deploy_simple_manifest(manifest_hash: manifest_deployment)
        etc_hosts = parse_agent_etc_hosts(5)
        expect(etc_hosts.size).to eq(6), &quot;expected etc_hosts to have 6 lines, got contents #{etc_hosts} with size #{etc_hosts.size}&quot;
        expect(etc_hosts).to match_array(generate_instance_dns)
      end
    end
  end

  context &#39;recreate&#39; do
    context &#39;recreates VMs and updates all agents /etc/hosts&#39; do
      context &#39;manual networking&#39; do
        it &#39;updates /etc/hosts with the new info for an instance hostname&#39; do
          manifest_deployment = initial_deployment(5)

          deploy_simple_manifest(manifest_hash: manifest_deployment, recreate: true)
          etc_hosts = parse_agent_etc_hosts(4)
          expect(etc_hosts.size).to eq(5), &quot;expected etc_hosts to have 5 lines, got contents #{etc_hosts} with size #{etc_hosts.size}&quot;
          expect(etc_hosts).to match_array(generate_instance_dns)
        end
      end

      context &#39;dynamic networking&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(local DNS)::context(recreate)::context(recreates VMs and updates all agents /etc/hosts)::context#dynamic networking has a flog score of 44</span>          </div>  </li></ol>
        before do
          cloud_config[&#39;networks&#39;][0][&#39;type&#39;] = &#39;dynamic&#39;
          cloud_config[&#39;networks&#39;][0][&#39;subnets&#39;][0][&#39;range&#39;] = &#39;&#39;
          cloud_config[&#39;networks&#39;][0][&#39;subnets&#39;][0][&#39;dns&#39;] = []
          cloud_config[&#39;networks&#39;][0][&#39;subnets&#39;][0][&#39;static&#39;] = []

          upload_cloud_config({:cloud_config_hash =&gt; cloud_config})
        end

        # Skipping in create-swap-deleted mode: we are currently not deleting orphaned VMs
        it &#39;updates /etc/hosts with the new info for an instance hostname&#39;, no_create_swap_delete: true do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(local DNS)::context(recreate)::context(recreates VMs and updates all agents /etc/hosts)::context(dynamic networking)::it#updates /etc/hosts with the new info for an instance hostname has a flog score of 45</span>          </div>  </li></ol>
          manifest_deployment = initial_deployment(5)
          old_ips = current_sandbox.cpi.all_ips

          deploy_simple_manifest(manifest_hash: manifest_deployment, recreate: true)

          current_sandbox.cpi.all_ips.each do |new_ip|
            expect(old_ips).to_not include(new_ip)
          end

          etc_hosts = parse_agent_etc_hosts(4)
          expect(etc_hosts.size).to eq(5), &quot;expected etc_hosts to have 5 lines, got contents #{etc_hosts} with size #{etc_hosts.size}&quot;
          expect(etc_hosts).to match_array(generate_instance_dns)
        end
      end
    end

    context &#39;recreates missing VMs with cck&#39; do
      let(:runner) { bosh_runner_in_work_dir(ClientSandbox.test_release_dir) }

      it &#39;automatically recreates missing VMs when cck --auto is used&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(local DNS)::context(recreate)::context(recreates missing VMs with cck)::it#automatically recreates missing VMs when cck --auto is used has a flog score of 73</span>          </div>  </li></ol>
        manifest_deployment = initial_deployment(5)

        current_sandbox.cpi.vm_cids.each do |vm_cid|
          current_sandbox.cpi.delete_vm(vm_cid)
        end

        cloudcheck_response = bosh_run_cck_with_auto
        expect(cloudcheck_response).to match(regexp(&#39;missing.&#39;))
        expect(cloudcheck_response).to match(regexp(&#39;Applying problem resolutions&#39;))
        expect(cloudcheck_response).to match(regexp(&#39;Succeeded&#39;))
        expect(cloudcheck_response).to_not match(regexp(&#39;0 problems&#39;))
        expect(cloudcheck_response).to_not match(regexp(&#39;1. Skip for now
  2. Reboot VM
  3. Recreate VM using last known apply spec
  4. Delete VM
  5. Delete VM reference (DANGEROUS!)&#39;))

        expect(runner.run(&#39;cloud-check --report&#39;, deployment_name: deployment_name)).to match(regexp(&#39;0 problems&#39;))

        etc_hosts = parse_agent_etc_hosts(4)
        expect(etc_hosts).to match_array(generate_instance_dns)
      end
    end
  end

  context &#39;ordering of tombstone deletion&#39; do
    let(:manifest_deployment) { initial_deployment(2, 1) }

    it &#39;deploys and downgrades with max_in_flight&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(local DNS)::context(ordering of tombstone deletion)::it#deploys and downgrades with max_in_flight has a flog score of 41</span>          </div>  </li></ol>
      manifest_deployment[&#39;instance_groups&#39;][0][&#39;instances&#39;] = 1
      deploy_simple_manifest(manifest_hash: manifest_deployment)

      output = bosh_runner.run(&#39;task --debug 5&#39;)

      logpos = /Deleting local dns records for /.match(output).begin(0)
      expect(logpos).to be &gt; 0

      deletepos = /DELETE FROM [&quot;`]local_dns_records[&quot;`] WHERE [&quot;`]id[&quot;`] = 2/.match(output).begin(0)
      expect(deletepos).to be &gt; logpos

      insertpos = /INSERT INTO [&quot;`]local_dns_records[&quot;`] /.match(output).begin(0)
      expect(insertpos).to be &gt; deletepos
    end
  end

  context &#39;spec.address should respect use_dns_addresses director and deployment level flag (manual networks only)&#39; do
    it &#39;uses an IP address by default (use_dns_addresses director flag is false by default)&#39; do
      dep_manifest = initial_manifest(1, 1)
      deploy_simple_manifest(manifest_hash: dep_manifest, deployment_name: deployment_name)

      instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
      template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
      expect(template).to include(&#39;spec.address=192.168.1.2&#39;)
    end

    context &#39;when flag at deployment level is true&#39; do
      let(:features_hash) do
        { &#39;use_dns_addresses&#39; =&gt; true, &#39;use_short_dns_addresses&#39; =&gt; use_short_dns_addresses }
      end
      let(:use_short_dns_addresses) { false }

      before do
        dep_manifest = initial_manifest(1, 1)
        dep_manifest[&#39;features&#39;] = features_hash
        deploy_simple_manifest(manifest_hash: dep_manifest, deployment_name: deployment_name)
      end

      it &#39;uses DNS address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L195" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L206" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L221" class="js-smell-location">2</a>                  </div>  </li></ol>
        instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
        template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
        expect(template).to include(&quot;spec.address=#{instance.id}.job-to-test-local-dns.local-dns.simplelocal-dns.bosh&quot;)
      end

      context &#39;when instance is recreated&#39; do
        before do
          bosh_runner.run(&#39;recreate job_to_test_local_dns/0&#39;, deployment_name: deployment_name)
        end

        it &#39;renders with the same value&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L195" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L206" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L221" class="js-smell-location">2</a>                  </div>  </li></ol>
          instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
          expect(template).to include(&quot;spec.address=#{instance.id}.job-to-test-local-dns.local-dns.simplelocal-dns.bosh&quot;)
        end
      end

      context &#39;when resurrected&#39;, hm: true do
        with_reset_hm_before_each

        before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L216" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L252" class="js-smell-location">1</a>                  </div>  </li></ol>
          vm = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          director.kill_vm_and_wait_for_resurrection(vm, deployment_name: deployment_name)
        end

        it &#39;renders with the same value&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L195" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L206" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L221" class="js-smell-location">2</a>                  </div>  </li></ol>
          instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
          expect(template).to include(&quot;spec.address=#{instance.id}.job-to-test-local-dns.local-dns.simplelocal-dns.bosh&quot;)
        end
      end

      context &#39;when deployment also specifies use_short_dns_addresses&#39; do
        let(:use_short_dns_addresses) { true }

        it &#39;uses DNS address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L231" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L242" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L257" class="js-smell-location">2</a>                  </div>  </li></ol>
          instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
          expect(template).to match(/spec.address=q-m\dn\ds0\.q-g\d\.bosh/)
        end

        context &#39;when instance is recreated&#39; do
          before do
            bosh_runner.run(&#39;recreate job_to_test_local_dns/0&#39;, deployment_name: deployment_name)
          end

          it &#39;renders with short addresses still&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L231" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L242" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L257" class="js-smell-location">2</a>                  </div>  </li></ol>
            instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
            template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
            expect(template).to match(/spec.address=q-m\dn\ds0\.q-g\d\.bosh/)
          end
        end

        context &#39;when resurrected&#39;, hm: true do
          with_reset_hm_before_each

          before do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L216" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L252" class="js-smell-location">1</a>                  </div>  </li></ol>
            vm = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
            director.kill_vm_and_wait_for_resurrection(vm, deployment_name: deployment_name)
          end

          it &#39;renders with short addresses still&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L231" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L242" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L257" class="js-smell-location">2</a>                  </div>  </li></ol>
            instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
            template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
            expect(template).to match(/spec.address=q-m\dn\ds0\.q-g\d\.bosh/)
          end
        end
      end
    end

    context &#39;when flag at deployment level is false&#39; do
      it &#39;uses an IP address by default&#39; do
        dep_manifest = initial_manifest(1, 1)
        dep_manifest[&#39;features&#39;] = {&#39;use_dns_addresses&#39; =&gt; false}
        deploy_simple_manifest(manifest_hash: dep_manifest, deployment_name: deployment_name)

        instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
        template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
        expect(template).to include(&#39;spec.address=192.168.1.2&#39;)
      end

      context &#39;when instance is recreated&#39; do
        before do
          dep_manifest = initial_manifest(1, 1)
          dep_manifest[&#39;features&#39;] = {&#39;use_dns_addresses&#39; =&gt; false}
          deploy_simple_manifest(manifest_hash: dep_manifest, deployment_name: deployment_name)

          bosh_runner.run(&#39;recreate job_to_test_local_dns/0&#39;, deployment_name: deployment_name)
        end

        it &#39;renders with the same value&#39;, no_create_swap_delete: true do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L286" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L292" class="js-smell-location">1</a>                  </div>  </li></ol>
          instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
          expect(template).to include(&#39;spec.address=192.168.1.2&#39;)
        end

        it &#39;renders a different value&#39;, create_swap_delete: true do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L286" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L292" class="js-smell-location">1</a>                  </div>  </li></ol>
          instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
          expect(template).to include(&#39;spec.address=192.168.1.3&#39;)
        end
      end

      context &#39;when resurrected&#39;, hm: true do
        with_reset_hm_before_each

        before do
          dep_manifest = initial_manifest(1, 1)
          dep_manifest[&#39;features&#39;] = {&#39;use_dns_addresses&#39; =&gt; false}
          deploy_simple_manifest(manifest_hash: dep_manifest, deployment_name: deployment_name)

          vm = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          director.kill_vm_and_wait_for_resurrection(vm, deployment_name: deployment_name)
        end

        it &#39;renders with the same value&#39; do
          instance = director.instance(&#39;job_to_test_local_dns&#39;, &#39;0&#39;, deployment_name: deployment_name)
          template = instance.read_job_template(&#39;foobar&#39;, &#39;bin/foobar_ctl&#39;)
          expect(template).to include(&#39;spec.address=192.168.1.2&#39;)
        end
      end
    end
  end

  def initial_manifest(number_of_instances, max_in_flight)
    manifest_deployment = Bosh::Spec::NewDeployments.test_release_manifest_with_stemcell
    manifest_deployment.merge!(
      &#39;update&#39; =&gt; {
        &#39;canaries&#39; =&gt; 2,
        &#39;canary_watch_time&#39; =&gt; 4000,
        &#39;max_in_flight&#39; =&gt; max_in_flight,
        &#39;update_watch_time&#39; =&gt; 20
      },

      &#39;instance_groups&#39; =&gt; [
        Bosh::Spec::NewDeployments.simple_instance_group(
          name: instance_group_name,
          instances: number_of_instances,
          azs: [&#39;z1&#39;, &#39;z2&#39;]
        )
      ]
    )
    manifest_deployment[&#39;name&#39;] = deployment_name
    manifest_deployment[&#39;instance_groups&#39;][0][&#39;networks&#39;][0][&#39;name&#39;] = network_name
    manifest_deployment
  end

  def initial_deployment(number_of_instances, max_in_flight=1)
    manifest_deployment = initial_manifest(number_of_instances, max_in_flight)
    deploy_simple_manifest(manifest_hash: manifest_deployment)

    etc_hosts = parse_agent_etc_hosts(number_of_instances - 1)
    expect(etc_hosts.size).to eq(number_of_instances), &quot;expected etc_hosts to have #{number_of_instances} lines, got contents #{etc_hosts} with size #{etc_hosts.size}&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>initial_deployment calls 'etc_hosts.size' 2 times</span>          </div>  </li></ol>
    manifest_deployment
  end

  def parse_agent_etc_hosts(instance_index)
    instance = director.instance(&#39;job_to_test_local_dns&#39;, instance_index.to_s, deployment_name: deployment_name)

    instance.read_etc_hosts.lines.map do |line|
      words = line.strip.split(&#39; &#39;)
      {&#39;hostname&#39; =&gt; words[1], &#39;ip&#39; =&gt; words[0]}
    end
  end

  def parse_agent_records_json(instance_index)
    instance = director.instance(&#39;job_to_test_local_dns&#39;, instance_index.to_s, deployment_name: deployment_name)
    instance.dns_records
  end

  def generate_instance_dns
    director.instances(deployment_name: deployment_name).map do |instance|
      host_name = [
        instance.id,
        canonical_instance_group_name,
        canonical_network_name,
        canonical_deployment_name,
        &#39;bosh&#39;
      ].join(&#39;.&#39;)
      {
        &#39;hostname&#39; =&gt; host_name,
        &#39;ip&#39; =&gt; instance.ips[0],
      }
    end
  end

  def generate_instance_records
    director.instances(deployment_name: deployment_name).map do |instance|
      [instance.ips[0], &quot;#{instance.id}.#{canonical_instance_group_name}.#{canonical_network_name}.#{canonical_deployment_name}.bosh&quot;]
    end
  end

  def generate_instance_record_infos<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe#generate_instance_record_infos has a flog score of 30</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>generate_instance_record_infos has approx 6 statements</span>          </div>  </li></ol>
    director.instances(deployment_name: deployment_name).map do |instance|
      if instance.availability_zone.empty?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>generate_instance_record_infos calls 'instance.availability_zone' 2 times</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>generate_instance_record_infos refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L398" class="js-smell-location">2</a>                  <a href="local_dns_spec.html#L400" class="js-smell-location">3</a>                  <a href="local_dns_spec.html#L407" class="js-smell-location">4</a>                  <a href="local_dns_spec.html#L409" class="js-smell-location">5</a>                  <a href="local_dns_spec.html#L410" class="js-smell-location">6</a>                  </div>  </li></ol>
        az = nil
        az_index = nil
      else
        az = instance.availability_zone<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>generate_instance_record_infos calls 'instance.availability_zone' 2 times</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>generate_instance_record_infos refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L398" class="js-smell-location">2</a>                  <a href="local_dns_spec.html#L400" class="js-smell-location">3</a>                  <a href="local_dns_spec.html#L407" class="js-smell-location">4</a>                  <a href="local_dns_spec.html#L409" class="js-smell-location">5</a>                  <a href="local_dns_spec.html#L410" class="js-smell-location">6</a>                  </div>  </li></ol>
        az_index = Regexp.new(/\d+/)
      end
      [
        instance.id,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>generate_instance_record_infos refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L398" class="js-smell-location">2</a>                  <a href="local_dns_spec.html#L400" class="js-smell-location">3</a>                  <a href="local_dns_spec.html#L407" class="js-smell-location">4</a>                  <a href="local_dns_spec.html#L409" class="js-smell-location">5</a>                  <a href="local_dns_spec.html#L410" class="js-smell-location">6</a>                  </div>  </li></ol>
        Regexp.new(/\d/),
        Bosh::Director::Canonicalizer.canonicalize(instance.instance_group_name),<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>generate_instance_record_infos refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L398" class="js-smell-location">2</a>                  <a href="local_dns_spec.html#L400" class="js-smell-location">3</a>                  <a href="local_dns_spec.html#L407" class="js-smell-location">4</a>                  <a href="local_dns_spec.html#L409" class="js-smell-location">5</a>                  <a href="local_dns_spec.html#L410" class="js-smell-location">6</a>                  </div>  </li></ol>
        [&#39;1&#39;],
        az,
        az_index,
        Bosh::Director::Canonicalizer.canonicalize(&#39;local_dns&#39;),
        Regexp.new(/\d/),
        Bosh::Director::Canonicalizer.canonicalize(&#39;simple.local_dns&#39;),
        instance.ips[0],<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>generate_instance_record_infos refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L398" class="js-smell-location">2</a>                  <a href="local_dns_spec.html#L400" class="js-smell-location">3</a>                  <a href="local_dns_spec.html#L407" class="js-smell-location">4</a>                  <a href="local_dns_spec.html#L409" class="js-smell-location">5</a>                  <a href="local_dns_spec.html#L410" class="js-smell-location">6</a>                  </div>  </li></ol>
        &#39;bosh&#39;,
        instance.agent_id,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>generate_instance_record_infos refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L398" class="js-smell-location">2</a>                  <a href="local_dns_spec.html#L400" class="js-smell-location">3</a>                  <a href="local_dns_spec.html#L407" class="js-smell-location">4</a>                  <a href="local_dns_spec.html#L409" class="js-smell-location">5</a>                  <a href="local_dns_spec.html#L410" class="js-smell-location">6</a>                  </div>  </li></ol>
        instance.index.to_i<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>generate_instance_record_infos refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="local_dns_spec.html#L390" class="js-smell-location">0</a>                  <a href="local_dns_spec.html#L394" class="js-smell-location">1</a>                  <a href="local_dns_spec.html#L398" class="js-smell-location">2</a>                  <a href="local_dns_spec.html#L400" class="js-smell-location">3</a>                  <a href="local_dns_spec.html#L407" class="js-smell-location">4</a>                  <a href="local_dns_spec.html#L409" class="js-smell-location">5</a>                  <a href="local_dns_spec.html#L410" class="js-smell-location">6</a>                  </div>  </li></ol>
      ]
    end
  end

  def check_ip(ip, ips)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>check_ip doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    case ips
      when String
        return true if ip == ips
      when Array
        return ips.include?(ip)
      else
        return false
    end
  end

  def bosh_run_cck_with_auto
    output = bosh_runner.run(&quot;cloud-check --auto&quot;, deployment_name: deployment_name)
    if $?.exitstatus != 0
      fail(&quot;Cloud check failed, output: #{output}&quot;)
    end
    output
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
