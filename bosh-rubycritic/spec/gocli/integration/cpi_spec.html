<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 11:26:55 -0700'>2018-05-31 11:26:55 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/gocli/integration /</small> cpi_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">864</span><small> lines of codes</small></div>
              <div><span class="metric">1</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1519.5</span><small> complexity/method</small></div>
              <div><span class="metric">65</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1519.52</span><small> complexity</small></div>
              <div><span class="metric">900</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                18
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require_relative &#39;../spec_helper&#39;

describe &#39;CPI calls&#39;, type: :integration do
  with_reset_sandbox_before_each

  def expect_name(invocation)
    expect(invocation.inputs[&#39;metadata&#39;][&#39;name&#39;]).to eq(&quot;#{invocation.inputs[&#39;metadata&#39;][&#39;job&#39;]}/#{invocation.inputs[&#39;metadata&#39;][&#39;id&#39;]}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>expect_name calls 'invocation.inputs' 3 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>expect_name calls 'invocation.inputs['metadata']' 3 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>expect_name refers to 'invocation' more than self (maybe move it to another class?)</span>          </div>  </li></ol>
  end

  describe &#39;deploy&#39; do
    let(:expected_groups) do
      [&#39;testdirector&#39;, &#39;simple&#39;, &#39;first-job&#39;, &#39;testdirector-simple&#39;, &#39;simple-first-job&#39;, &#39;testdirector-simple-first-job&#39;]
    end
    let(:expected_group) { &#39;testdirector-simple-first-job&#39; }

    let(:ca_cert) do
      File.read(current_sandbox.nats_certificate_paths[&#39;ca_path&#39;])
    end

    let(:expected_mbus) do
      {
        &#39;cert&#39; =&gt; {
          &#39;ca&#39; =&gt; ca_cert,
          &#39;certificate&#39; =&gt;  String,
          &#39;private_key&#39; =&gt; String,
        },
      }
    end

    it &#39;sends correct CPI requests&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(CPI calls)::describe(deploy)::it#sends correct CPI requests has a flog score of 316</span>          </div>  </li></ol>
      manifest_hash = Bosh::Spec::NetworkingManifest.deployment_manifest(instances: 1)
      manifest_hash[&#39;instance_groups&#39;].first[&#39;env&#39;] = {&#39;bosh&#39; =&gt; {&#39;password&#39; =&gt; &#39;foobar&#39;}}
      deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: Bosh::Spec::NewDeployments.simple_cloud_config)

      invocations = current_sandbox.cpi.invocations

      expect(invocations[0].method_name).to eq(&#39;info&#39;)
      expect(invocations[0].inputs).to be_nil

      expect(invocations[2].method_name).to eq(&#39;create_stemcell&#39;)
      expect(invocations[2].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L41" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L504" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;image_path&#39; =&gt; String,
        &#39;cloud_properties&#39; =&gt; {&#39;property1&#39; =&gt; &#39;test&#39;, &#39;property2&#39; =&gt; &#39;test&#39;}
      })

      expect(invocations[4].method_name).to eq(&#39;create_vm&#39;)
      expect(invocations[4].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L47" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L117" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;agent_id&#39; =&gt; String,
        &#39;stemcell_id&#39; =&gt; String,
        &#39;cloud_properties&#39; =&gt; {},
        &#39;networks&#39; =&gt; {
          &#39;a&#39; =&gt; {
            &#39;type&#39; =&gt; &#39;manual&#39;,
            &#39;ip&#39; =&gt; &#39;192.168.1.3&#39;,
            &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
            &#39;cloud_properties&#39; =&gt; {},
            &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
            &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
            &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
          }
        },
        &#39;disk_cids&#39; =&gt; [],
        &#39;env&#39; =&gt; {
          &#39;bosh&#39; =&gt; {
            &#39;mbus&#39; =&gt; expected_mbus,
            &#39;dummy_agent_key_merged&#39; =&gt; &#39;This key must be sent to agent&#39;, # merged from the director yaml configuration (agent.env.bosh key)
            &#39;group&#39; =&gt; String,
            &#39;groups&#39; =&gt; Array
          }
        }
      })

      agent_id = invocations[4].inputs[&#39;agent_id&#39;]
      raw_cert = invocations[4].inputs[&#39;env&#39;][&#39;bosh&#39;][&#39;mbus&#39;][&#39;cert&#39;][&#39;certificate&#39;]
      cert = OpenSSL::X509::Certificate.new raw_cert
      cn = cert.subject.to_a.select { |attr| attr[0] == &#39;CN&#39; }.first
      expect(&quot;#{agent_id}.agent.bosh-internal&quot;).to eq(cn[1])

      expect(invocations[6].method_name).to eq(&#39;set_vm_metadata&#39;)
      expect(invocations[6].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L80" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L144" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;vm_cid&#39; =&gt; String,
        &#39;metadata&#39; =&gt; {
          &#39;director&#39; =&gt; &#39;TestDirector&#39;,
          &#39;created_at&#39; =&gt; kind_of(String),
          &#39;deployment&#39; =&gt; &#39;simple&#39;,
          &#39;job&#39; =&gt; /compilation-.*/,
          &#39;instance_group&#39; =&gt; /compilation-.*/,
          &#39;index&#39; =&gt; &#39;0&#39;,
          &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
          &#39;name&#39; =&gt; /compilation-.*\/[0-9a-f]{8}-[0-9a-f-]{27}/
        }
      })
      expect_name(invocations[6])
      compilation_vm_id = invocations[6].inputs[&#39;vm_cid&#39;]

      expect(invocations[8].method_name).to eq(&#39;set_vm_metadata&#39;)
      expect(invocations[8].inputs).to match({
        &#39;vm_cid&#39; =&gt; compilation_vm_id,
        &#39;metadata&#39; =&gt; {
          &#39;compiling&#39; =&gt; &#39;foo&#39;,
          &#39;director&#39; =&gt; &#39;TestDirector&#39;,
          &#39;created_at&#39; =&gt; kind_of(String),
          &#39;deployment&#39; =&gt; &#39;simple&#39;,
          &#39;job&#39; =&gt; /compilation-.*/,
          &#39;instance_group&#39; =&gt; /compilation-.*/,
          &#39;index&#39; =&gt; &#39;0&#39;,
          &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
          &#39;name&#39; =&gt; /compilation-.*\/[0-9a-f]{8}-[0-9a-f-]{27}/
      }
      })
      expect_name(invocations[8])

      expect(invocations[10].method_name).to eq(&#39;delete_vm&#39;)
      expect(invocations[10].inputs).to match({&#39;vm_cid&#39; =&gt; compilation_vm_id})

      expect(invocations[12].method_name).to eq(&#39;create_vm&#39;)
      expect(invocations[12].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L47" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L117" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;agent_id&#39; =&gt; String,
        &#39;stemcell_id&#39; =&gt; String,
        &#39;cloud_properties&#39; =&gt; {},
        &#39;networks&#39; =&gt; {
          &#39;a&#39; =&gt; {
            &#39;type&#39; =&gt; &#39;manual&#39;,
            &#39;ip&#39; =&gt; &#39;192.168.1.3&#39;,
            &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
            &#39;cloud_properties&#39; =&gt; {},
            &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
            &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
            &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
          }
        },
        &#39;disk_cids&#39; =&gt; [],
        &#39;env&#39; =&gt; {
          &#39;bosh&#39; =&gt; {
            &#39;mbus&#39; =&gt; expected_mbus,
            &#39;dummy_agent_key_merged&#39; =&gt; &#39;This key must be sent to agent&#39;, # merged from the director yaml configuration (agent.env.bosh key)
            &#39;group&#39; =&gt; String,
            &#39;groups&#39; =&gt; Array,
          }
        }
      })

      expect(invocations[14].method_name).to eq(&#39;set_vm_metadata&#39;)
      expect(invocations[14].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L80" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L144" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;vm_cid&#39; =&gt; String,
        &#39;metadata&#39; =&gt; {
          &#39;director&#39; =&gt; &#39;TestDirector&#39;,
          &#39;created_at&#39; =&gt; kind_of(String),
          &#39;deployment&#39; =&gt; &#39;simple&#39;,
          &#39;job&#39; =&gt; /compilation-.*/,
          &#39;instance_group&#39; =&gt; /compilation-.*/,
          &#39;index&#39; =&gt; &#39;0&#39;,
          &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
          &#39;name&#39; =&gt; /compilation-.*\/[0-9a-f]{8}-[0-9a-f-]{27}/
        }
      })
      expect_name(invocations[14])
      compilation_vm_id = invocations[14].inputs[&#39;vm_cid&#39;]

      expect(invocations[16].method_name).to eq(&#39;set_vm_metadata&#39;)
      expect(invocations[16].inputs).to match({
        &#39;vm_cid&#39; =&gt; compilation_vm_id,
        &#39;metadata&#39; =&gt; {
          &#39;compiling&#39; =&gt; &#39;bar&#39;,
          &#39;created_at&#39; =&gt; kind_of(String),
          &#39;director&#39; =&gt; &#39;TestDirector&#39;,
          &#39;deployment&#39; =&gt; &#39;simple&#39;,
          &#39;job&#39; =&gt; /compilation-.*/,
          &#39;instance_group&#39; =&gt; /compilation-.*/,
          &#39;index&#39; =&gt; &#39;0&#39;,
          &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
          &#39;name&#39; =&gt; /compilation-.*\/[0-9a-f]{8}-[0-9a-f-]{27}/
        }
      })
      expect_name(invocations[16])

      expect(invocations[18].method_name).to eq(&#39;delete_vm&#39;)
      expect(invocations[18].inputs).to match({&#39;vm_cid&#39; =&gt; compilation_vm_id})

      expect(invocations[20].method_name).to eq(&#39;create_vm&#39;)
      expect(invocations[20].inputs).to match({
        &#39;agent_id&#39; =&gt; String,
        &#39;stemcell_id&#39; =&gt; String,
        &#39;cloud_properties&#39; =&gt;{},
        &#39;networks&#39; =&gt; {
          &#39;a&#39; =&gt; {
            &#39;type&#39; =&gt; &#39;manual&#39;,
            &#39;ip&#39; =&gt; &#39;192.168.1.2&#39;,
            &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
            &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
            &#39;cloud_properties&#39; =&gt;{},
            &#39;dns&#39; =&gt;[&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
            &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
          }
        },
        &#39;disk_cids&#39; =&gt; [],
        &#39;env&#39; =&gt; {
          &#39;bosh&#39; =&gt;{
            &#39;mbus&#39; =&gt; expected_mbus,
            &#39;dummy_agent_key_merged&#39; =&gt; &#39;This key must be sent to agent&#39;, # merged from the director yaml configuration (agent.env.bosh key)
            &#39;password&#39; =&gt; &#39;foobar&#39;,
            &#39;group&#39; =&gt; &#39;testdirector-simple-foobar&#39;,
            &#39;groups&#39; =&gt; [&#39;testdirector&#39;, &#39;simple&#39;, &#39;foobar&#39;, &#39;testdirector-simple&#39;, &#39;simple-foobar&#39;, &#39;testdirector-simple-foobar&#39;]
          }
        }
      })

      expect(invocations[22].method_name).to eq(&#39;set_vm_metadata&#39;)
      expect(invocations[22].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L209" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L540" class="js-smell-location">1</a>                  </div>  </li></ol>
        &#39;vm_cid&#39; =&gt; String,
        &#39;metadata&#39; =&gt; {
          &#39;director&#39; =&gt; &#39;TestDirector&#39;,
          &#39;created_at&#39; =&gt; kind_of(String),
          &#39;deployment&#39; =&gt; &#39;simple&#39;,
          &#39;job&#39; =&gt; &#39;foobar&#39;,
          &#39;instance_group&#39; =&gt; &#39;foobar&#39;,
          &#39;index&#39; =&gt; &#39;0&#39;,
          &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
          &#39;name&#39; =&gt; /foobar\/[0-9a-f]{8}-[0-9a-f-]{27}/
        }
      })
      expect_name(invocations[22])

      expect(invocations.size).to eq(24)
    end

    context &#39;when stemcell has api version&#39; do
      it &#39;sends correct CPI requests for select CPI calls&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(CPI calls)::describe(deploy)::context(when stemcell has api version)::it#sends correct CPI requests for select CPI calls has a flog score of 580</span>          </div>  </li></ol>
        bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell_with_api_version.tgz&#39;)}&quot;)
        manifest_hash = Bosh::Spec::NetworkingManifest.deployment_manifest
        manifest_hash[&#39;instance_groups&#39;] = [<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L231" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L328" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L485" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L583" class="js-smell-location">3</a>                  </div>  </li></ol>
          Bosh::Spec::NewDeployments.simple_instance_group(
            name: &#39;first-job&#39;,
            static_ips: [&#39;192.168.1.10&#39;],
            instances: 1,
            jobs: [&#39;name&#39; =&gt; &#39;foobar_without_packages&#39;],
            persistent_disk_type: Bosh::Spec::NewDeployments.disk_type[&#39;name&#39;]
          )
        ]
        cloud_config_hash = Bosh::Spec::NewDeployments.simple_cloud_config
        cloud_config_hash[&#39;networks&#39;].first[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;]
        cloud_config_hash[&#39;disk_types&#39;] = [Bosh::Spec::NewDeployments.disk_type]
        upload_cloud_config(cloud_config_hash: cloud_config_hash)
        create_and_upload_test_release
        deploy(manifest_hash: manifest_hash)
        first_deploy_invocations = current_sandbox.cpi.invocations

        context_without_api_version = {
          &#39;director_uuid&#39; =&gt; kind_of(String),
          &#39;request_id&#39; =&gt; kind_of(String)
        }

        context_with_api_version = {
          &#39;director_uuid&#39; =&gt; kind_of(String),
          &#39;request_id&#39; =&gt; kind_of(String),
          &#39;vm&#39; =&gt; {
            &#39;stemcell&#39; =&gt; {
              &#39;api_version&#39; =&gt; 25
            }
          }
        }

        expect(first_deploy_invocations[0].method_name).to eq(&#39;info&#39;)
        expect(first_deploy_invocations[0].inputs).to be_nil
        expect(first_deploy_invocations[0].context).to match(context_without_api_version)

        expect(first_deploy_invocations[2].method_name).to eq(&#39;create_stemcell&#39;)
        expect(first_deploy_invocations[2].context).to match(context_without_api_version)

        expect(first_deploy_invocations[4].method_name).to eq(&#39;create_vm&#39;)
        expect(first_deploy_invocations[4].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L271" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L513" class="js-smell-location">1</a>                  </div>  </li></ol>
                                                              &#39;agent_id&#39; =&gt; String,
                                                              &#39;stemcell_id&#39; =&gt; String,
                                                              &#39;cloud_properties&#39; =&gt; {},
                                                              &#39;networks&#39; =&gt; {
                                                                &#39;a&#39; =&gt; {
                                                                  &#39;type&#39; =&gt; &#39;manual&#39;,
                                                                  &#39;ip&#39; =&gt; &#39;192.168.1.10&#39;,
                                                                  &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
                                                                  &#39;cloud_properties&#39; =&gt; {},
                                                                  &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
                                                                  &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                                                                  &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                                                                }
                                                              },
                                                              &#39;disk_cids&#39; =&gt; [],
                                                              &#39;env&#39; =&gt; {
                                                                &#39;bosh&#39; =&gt; {
                                                                  &#39;mbus&#39; =&gt; expected_mbus,
                                                                  &#39;dummy_agent_key_merged&#39; =&gt; &#39;This key must be sent to agent&#39;, # merged from the director yaml configuration (agent.env.bosh key)
                                                                  &#39;group&#39; =&gt; expected_group,
                                                                  &#39;groups&#39; =&gt; expected_groups,
                                                                }
                                                              }
                                                            })
        expect(first_deploy_invocations[4].context).to match(context_with_api_version)

        expect(first_deploy_invocations[6].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(first_deploy_invocations[6].context).to match(context_without_api_version)
        expect_name(first_deploy_invocations[6])
        vm_cid = first_deploy_invocations[6].inputs[&#39;vm_cid&#39;]

        expect(first_deploy_invocations[9].method_name).to eq(&#39;create_disk&#39;)
        expect(first_deploy_invocations[9].context).to match(context_without_api_version)

        expect(first_deploy_invocations[11].method_name).to eq(&#39;attach_disk&#39;)
        expect(first_deploy_invocations[11].inputs).to match({
                                                              &#39;vm_cid&#39; =&gt; vm_cid,
                                                              &#39;disk_id&#39; =&gt; String
                                                            })
        disk_cid = first_deploy_invocations[11].inputs[&#39;disk_id&#39;]
        expect(first_deploy_invocations[11].context).to match(context_with_api_version)

        expect(first_deploy_invocations[13].method_name).to eq(&#39;set_disk_metadata&#39;)
        expect(first_deploy_invocations[13].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L315" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L571" class="js-smell-location">1</a>                  </div>  </li></ol>
                                                              &#39;disk_cid&#39; =&gt; disk_cid,
                                                              &#39;metadata&#39; =&gt; {
                                                                &#39;director&#39; =&gt; &#39;TestDirector&#39;,
                                                                &#39;attached_at&#39; =&gt; kind_of(String),
                                                                &#39;deployment&#39; =&gt; &#39;simple&#39;,
                                                                &#39;instance_group&#39; =&gt; &#39;first-job&#39;,
                                                                &#39;instance_index&#39; =&gt; &#39;0&#39;,
                                                                &#39;instance_id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
                                                              }
                                                            })
        expect(first_deploy_invocations[13].context).to match(context_without_api_version)

        manifest_hash[&#39;instance_groups&#39;] = [<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L231" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L328" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L485" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L583" class="js-smell-location">3</a>                  </div>  </li></ol>
          Bosh::Spec::NewDeployments.simple_instance_group(
            name: &#39;first-job&#39;,
            static_ips: [&#39;192.168.1.11&#39;],
            instances: 1,
            jobs: [&#39;name&#39; =&gt; &#39;foobar&#39;],
            persistent_disk_pool: Bosh::Spec::NewDeployments.disk_type[&#39;name&#39;]
          )
        ]

        # add tags
        manifest_hash.merge!({
                               &#39;tags&#39; =&gt; {
                                 &#39;tag1&#39; =&gt; &#39;value1&#39;,
                               },
                             })

        # upload runtime config with tags
        runtime_config_hash = {
          &#39;releases&#39; =&gt; [{&#39;name&#39; =&gt; &#39;test_release_2&#39;, &#39;version&#39; =&gt; &#39;2&#39;}],
          &#39;tags&#39; =&gt; {
            &#39;tag2&#39; =&gt; &#39;value2&#39;,
          },
        }

        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;test_release_2.tgz&#39;)}&quot;)
        upload_runtime_config(runtime_config_hash: runtime_config_hash)

        deploy(manifest_hash: manifest_hash)

        second_deploy_invocations = current_sandbox.cpi.invocations.drop(first_deploy_invocations.size)

        expect(second_deploy_invocations[1].method_name).to eq(&#39;create_vm&#39;)
        expect(second_deploy_invocations[1].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L361" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L391" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L616" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L671" class="js-smell-location">3</a>                  </div>  </li></ol>
                                                               &#39;agent_id&#39; =&gt; String,
                                                               &#39;stemcell_id&#39; =&gt; String,
                                                               &#39;cloud_properties&#39; =&gt; {},
                                                               &#39;networks&#39; =&gt; {
                                                                 &#39;a&#39; =&gt; {
                                                                   &#39;type&#39; =&gt; &#39;manual&#39;,
                                                                   &#39;ip&#39; =&gt; String,
                                                                   &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
                                                                   &#39;cloud_properties&#39; =&gt; {},
                                                                   &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
                                                                   &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                                                                   &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                                                                 }
                                                               },
                                                               &#39;disk_cids&#39; =&gt; [],
                                                               &#39;env&#39; =&gt; anything
                                                             })
        expect(second_deploy_invocations[1].context).to match(context_with_api_version)

        expect(second_deploy_invocations[3].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[3].context).to match(context_without_api_version)

        expect(second_deploy_invocations[5].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[5].context).to match(context_without_api_version)

        expect(second_deploy_invocations[7].method_name).to eq(&#39;delete_vm&#39;)
        expect(second_deploy_invocations[7].context).to match(context_with_api_version)

        expect(second_deploy_invocations[9].method_name).to eq(&#39;create_vm&#39;)
        expect(second_deploy_invocations[9].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L361" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L391" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L616" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L671" class="js-smell-location">3</a>                  </div>  </li></ol>
                                                               &#39;agent_id&#39; =&gt; String,
                                                               &#39;stemcell_id&#39; =&gt; String,
                                                               &#39;cloud_properties&#39; =&gt; {},
                                                               &#39;networks&#39; =&gt; {
                                                                 &#39;a&#39; =&gt; {
                                                                   &#39;type&#39; =&gt; &#39;manual&#39;,
                                                                   &#39;ip&#39; =&gt; String,
                                                                   &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
                                                                   &#39;cloud_properties&#39; =&gt; {},
                                                                   &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
                                                                   &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                                                                   &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                                                                 }
                                                               },
                                                               &#39;disk_cids&#39; =&gt; [],
                                                               &#39;env&#39; =&gt; anything
                                                             })
        expect(second_deploy_invocations[9].context).to match(context_with_api_version)

        expect(second_deploy_invocations[11].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[11].context).to match(context_without_api_version)

        expect(second_deploy_invocations[13].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[13].context).to match(context_without_api_version)

        expect(second_deploy_invocations[15].method_name).to eq(&#39;delete_vm&#39;)
        expect(second_deploy_invocations[15].context).to match(context_with_api_version)

        expect(second_deploy_invocations[17].method_name).to eq(&#39;snapshot_disk&#39;)
        expect(second_deploy_invocations[17].context).to match(context_without_api_version)

        expect(second_deploy_invocations[19].method_name).to eq(&#39;detach_disk&#39;)
        expect(second_deploy_invocations[19].context).to match(context_with_api_version)
        expect(second_deploy_invocations[19].inputs).to match({
                                                               &#39;vm_cid&#39; =&gt; vm_cid, &#39;disk_id&#39; =&gt; disk_cid
                                                             })

        expect(second_deploy_invocations[21].method_name).to eq(&#39;delete_vm&#39;)
        expect(second_deploy_invocations[21].inputs).to match({
                                                                &#39;vm_cid&#39; =&gt; vm_cid
                                                              })
        expect(second_deploy_invocations[21].context).to match(context_with_api_version)

        expect(second_deploy_invocations[23].method_name).to eq(&#39;create_vm&#39;)
        expect(second_deploy_invocations[23].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L436" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L750" class="js-smell-location">1</a>                  </div>  </li></ol>
                                                                &#39;agent_id&#39; =&gt; String,
                                                                &#39;stemcell_id&#39; =&gt; String,
                                                                &#39;cloud_properties&#39; =&gt; {},
                                                                &#39;networks&#39; =&gt; {
                                                                  &#39;a&#39; =&gt; {
                                                                    &#39;type&#39; =&gt; &#39;manual&#39;,
                                                                    &#39;ip&#39; =&gt; &#39;192.168.1.11&#39;,
                                                                    &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
                                                                    &#39;cloud_properties&#39; =&gt; {},
                                                                    &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
                                                                    &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
                                                                    &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
                                                                  }
                                                                },
                                                                &#39;disk_cids&#39; =&gt; [disk_cid],
                                                                &#39;env&#39; =&gt; {
                                                                  &#39;bosh&#39; =&gt; {
                                                                    &#39;mbus&#39; =&gt; expected_mbus,
                                                                    &#39;dummy_agent_key_merged&#39; =&gt; &#39;This key must be sent to agent&#39;, # merged from the director yaml configuration (agent.env.bosh key)
                                                                    &#39;group&#39; =&gt; expected_group,
                                                                    &#39;groups&#39; =&gt; expected_groups
                                                                  }
                                                                }
                                                              })
        expect(second_deploy_invocations[23].context).to match(context_with_api_version)

        expect(second_deploy_invocations[25].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[25].context).to match(context_without_api_version)

        expect_name(second_deploy_invocations[25])

        new_vm_cid = second_deploy_invocations[25].inputs[&#39;vm_cid&#39;]

        expect(second_deploy_invocations[27].method_name).to eq(&#39;attach_disk&#39;)
        expect(second_deploy_invocations[27].inputs).to match({
                                                                &#39;vm_cid&#39; =&gt; new_vm_cid,
                                                                &#39;disk_id&#39; =&gt; disk_cid
                                                              })
        expect(second_deploy_invocations[27].context).to match(context_with_api_version)

        expect(second_deploy_invocations[29].method_name).to eq(&#39;set_disk_metadata&#39;)
        expect(second_deploy_invocations[29].context).to match(context_without_api_version)
      end
    end

    context &#39;when deploying instances with a persistent disk&#39; do
      it &#39;recreates VM with correct CPI requests&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(CPI calls)::describe(deploy)::context(when deploying instances with a persistent disk)::it#recreates VM with correct CPI requests has a flog score of 473</span>          </div>  </li></ol>
        manifest_hash = Bosh::Spec::NetworkingManifest.deployment_manifest
        manifest_hash[&#39;instance_groups&#39;] = [<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L231" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L328" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L485" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L583" class="js-smell-location">3</a>                  </div>  </li></ol>
          Bosh::Spec::NewDeployments.simple_instance_group(
            name: &#39;first-job&#39;,
            static_ips: [&#39;192.168.1.10&#39;],
            instances: 1,
            jobs: [&#39;name&#39; =&gt; &#39;foobar_without_packages&#39;],
            persistent_disk_type: Bosh::Spec::NewDeployments.disk_type[&#39;name&#39;]
          )
        ]
        cloud_config_hash = Bosh::Spec::NewDeployments.simple_cloud_config
        cloud_config_hash[&#39;networks&#39;].first[&#39;subnets&#39;].first[&#39;static&#39;] = [&#39;192.168.1.10&#39;, &#39;192.168.1.11&#39;]
        cloud_config_hash[&#39;disk_types&#39;] = [Bosh::Spec::NewDeployments.disk_type]
        deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: cloud_config_hash)
        first_deploy_invocations = current_sandbox.cpi.invocations

        expect(first_deploy_invocations[0].method_name).to eq(&#39;info&#39;)
        expect(first_deploy_invocations[0].inputs).to be_nil

        expect(first_deploy_invocations[2].method_name).to eq(&#39;create_stemcell&#39;)
        expect(first_deploy_invocations[2].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L41" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L504" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;image_path&#39; =&gt; String,
          &#39;cloud_properties&#39; =&gt; {
            &#39;property1&#39; =&gt; &#39;test&#39;,
            &#39;property2&#39; =&gt; &#39;test&#39;
          }
        })

        expect(first_deploy_invocations[4].method_name).to eq(&#39;create_vm&#39;)
        expect(first_deploy_invocations[4].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L271" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L513" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;agent_id&#39; =&gt; String,
          &#39;stemcell_id&#39; =&gt; String,
          &#39;cloud_properties&#39; =&gt; {},
          &#39;networks&#39; =&gt; {
            &#39;a&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;manual&#39;,
              &#39;ip&#39; =&gt; &#39;192.168.1.10&#39;,
              &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
              &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
              &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            }
          },
          &#39;disk_cids&#39; =&gt; [],
          &#39;env&#39; =&gt; {
            &#39;bosh&#39; =&gt; {
              &#39;mbus&#39; =&gt; expected_mbus,
              &#39;dummy_agent_key_merged&#39; =&gt; &#39;This key must be sent to agent&#39;, # merged from the director yaml configuration (agent.env.bosh key)
              &#39;group&#39; =&gt; expected_group,
              &#39;groups&#39; =&gt; expected_groups,
            }
          }
        })

        expect(first_deploy_invocations[6].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(first_deploy_invocations[6].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L209" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L540" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;vm_cid&#39; =&gt; String,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;created_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;job&#39; =&gt; &#39;first-job&#39;,
            &#39;instance_group&#39; =&gt; &#39;first-job&#39;,
            &#39;index&#39; =&gt; &#39;0&#39;,
            &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;name&#39; =&gt; /first-job\/[0-9a-f]{8}-[0-9a-f-]{27}/
          }
        })
        expect_name(first_deploy_invocations[6])
        vm_cid = first_deploy_invocations[6].inputs[&#39;vm_cid&#39;]

        expect(first_deploy_invocations[9].method_name).to eq(&#39;create_disk&#39;)
        expect(first_deploy_invocations[9].inputs).to match({
          &#39;size&#39; =&gt; 123,
          &#39;cloud_properties&#39; =&gt; {},
          &#39;vm_locality&#39; =&gt; vm_cid
        })

        expect(first_deploy_invocations[11].method_name).to eq(&#39;attach_disk&#39;)
        expect(first_deploy_invocations[11].inputs).to match({
          &#39;vm_cid&#39; =&gt; vm_cid,
          &#39;disk_id&#39; =&gt; String
        })
        disk_cid = first_deploy_invocations[11].inputs[&#39;disk_id&#39;]

        expect(first_deploy_invocations[13].method_name).to eq(&#39;set_disk_metadata&#39;)
        expect(first_deploy_invocations[13].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L315" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L571" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;disk_cid&#39; =&gt; disk_cid,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;attached_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;instance_group&#39; =&gt; &#39;first-job&#39;,
            &#39;instance_index&#39; =&gt; &#39;0&#39;,
            &#39;instance_id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
          }
        })

        manifest_hash[&#39;instance_groups&#39;] = [<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L231" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L328" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L485" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L583" class="js-smell-location">3</a>                  </div>  </li></ol>
          Bosh::Spec::NewDeployments.simple_instance_group(
            name: &#39;first-job&#39;,
            static_ips: [&#39;192.168.1.11&#39;],
            instances: 1,
            jobs: [&#39;name&#39; =&gt; &#39;foobar&#39;],
            persistent_disk_pool: Bosh::Spec::NewDeployments.disk_type[&#39;name&#39;]
          )
        ]

        # add tags
        manifest_hash.merge!({
          &#39;tags&#39; =&gt; {
            &#39;tag1&#39; =&gt; &#39;value1&#39;,
          },
        })

        # upload runtime config with tags
        runtime_config_hash = {
          &#39;releases&#39; =&gt; [{&#39;name&#39; =&gt; &#39;test_release_2&#39;, &#39;version&#39; =&gt; &#39;2&#39;}],
          &#39;tags&#39; =&gt; {
            &#39;tag2&#39; =&gt; &#39;value2&#39;,
          },
        }

        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;test_release_2.tgz&#39;)}&quot;)
        upload_runtime_config(runtime_config_hash: runtime_config_hash)

        deploy_simple_manifest(manifest_hash: manifest_hash)

        second_deploy_invocations = current_sandbox.cpi.invocations.drop(first_deploy_invocations.size)

        expect(second_deploy_invocations[1].method_name).to eq(&#39;create_vm&#39;)
        expect(second_deploy_invocations[1].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L361" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L391" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L616" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L671" class="js-smell-location">3</a>                  </div>  </li></ol>
          &#39;agent_id&#39; =&gt; String,
          &#39;stemcell_id&#39; =&gt; String,
          &#39;cloud_properties&#39; =&gt; {},
          &#39;networks&#39; =&gt; {
            &#39;a&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;manual&#39;,
              &#39;ip&#39; =&gt; String,
              &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
              &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
              &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            }
          },
          &#39;disk_cids&#39; =&gt; [],
          &#39;env&#39; =&gt; anything
        })

        expect(second_deploy_invocations[3].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[3].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L636" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L691" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;vm_cid&#39; =&gt; String,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;created_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;job&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;instance_group&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;index&#39; =&gt; &#39;0&#39;,
            &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;name&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}\/[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;tag1&#39; =&gt; &#39;value1&#39;,
            &#39;tag2&#39; =&gt; &#39;value2&#39;
          }
        })

        expect(second_deploy_invocations[5].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[5].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L653" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L708" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;vm_cid&#39; =&gt; String,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;created_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;job&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;instance_group&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;index&#39; =&gt; &#39;0&#39;,
            &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;name&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}\/[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;compiling&#39; =&gt; &#39;foo&#39;
          }
        })

        expect(second_deploy_invocations[7].method_name).to eq(&#39;delete_vm&#39;)

        expect(second_deploy_invocations[9].method_name).to eq(&#39;create_vm&#39;)
        expect(second_deploy_invocations[9].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L361" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L391" class="js-smell-location">1</a>                  <a href="cpi_spec.html#L616" class="js-smell-location">2</a>                  <a href="cpi_spec.html#L671" class="js-smell-location">3</a>                  </div>  </li></ol>
          &#39;agent_id&#39; =&gt; String,
          &#39;stemcell_id&#39; =&gt; String,
          &#39;cloud_properties&#39; =&gt; {},
          &#39;networks&#39; =&gt; {
            &#39;a&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;manual&#39;,
              &#39;ip&#39; =&gt; String,
              &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
              &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
              &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            }
          },
          &#39;disk_cids&#39; =&gt; [],
          &#39;env&#39; =&gt; anything
        })

        expect(second_deploy_invocations[11].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[11].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L636" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L691" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;vm_cid&#39; =&gt; String,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;created_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;job&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;instance_group&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;index&#39; =&gt; &#39;0&#39;,
            &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;name&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}\/[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;tag1&#39; =&gt; &#39;value1&#39;,
            &#39;tag2&#39; =&gt; &#39;value2&#39;
          }
        })

        expect(second_deploy_invocations[13].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[13].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L653" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L708" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;vm_cid&#39; =&gt; String,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;created_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;job&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;instance_group&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;index&#39; =&gt; &#39;0&#39;,
            &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;name&#39; =&gt; /compilation-[0-9a-f]{8}-[0-9a-f-]{27}\/[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;compiling&#39; =&gt; &#39;bar&#39;
          }
        })

        expect(second_deploy_invocations[15].method_name).to eq(&#39;delete_vm&#39;)

        expect(second_deploy_invocations[17].method_name).to eq(&#39;snapshot_disk&#39;)
        expect(second_deploy_invocations[17].inputs).to match({
          &#39;disk_id&#39; =&gt; disk_cid,
          &#39;metadata&#39; =&gt; {
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;job&#39; =&gt; &#39;first-job&#39;,
            &#39;index&#39; =&gt; 0,
            &#39;director_name&#39; =&gt; &#39;TestDirector&#39;,
            &#39;director_uuid&#39; =&gt; &#39;deadbeef&#39;,
            &#39;agent_id&#39; =&gt; String,
            &#39;instance_id&#39; =&gt; String
          }
        })

        expect(second_deploy_invocations[19].method_name).to eq(&#39;detach_disk&#39;)
        expect(second_deploy_invocations[19].inputs).to match({
          &quot;vm_cid&quot; =&gt; vm_cid, &quot;disk_id&quot; =&gt; disk_cid
        })

        expect(second_deploy_invocations[21].method_name).to eq(&#39;delete_vm&#39;)
        expect(second_deploy_invocations[21].inputs).to match({
          &#39;vm_cid&#39; =&gt; vm_cid
        })

        expect(second_deploy_invocations[23].method_name).to eq(&#39;create_vm&#39;)
        expect(second_deploy_invocations[23].inputs).to match({<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="cpi_spec.html#L436" class="js-smell-location">0</a>                  <a href="cpi_spec.html#L750" class="js-smell-location">1</a>                  </div>  </li></ol>
          &#39;agent_id&#39; =&gt; String,
          &#39;stemcell_id&#39; =&gt; String,
          &#39;cloud_properties&#39; =&gt; {},
          &#39;networks&#39; =&gt; {
            &#39;a&#39; =&gt; {
              &#39;type&#39; =&gt; &#39;manual&#39;,
              &#39;ip&#39; =&gt; &#39;192.168.1.11&#39;,
              &#39;netmask&#39; =&gt; &#39;255.255.255.0&#39;,
              &#39;cloud_properties&#39; =&gt; {},
              &#39;default&#39; =&gt; [&#39;dns&#39;, &#39;gateway&#39;],
              &#39;dns&#39; =&gt; [&#39;192.168.1.1&#39;, &#39;192.168.1.2&#39;],
              &#39;gateway&#39; =&gt; &#39;192.168.1.1&#39;,
            }
          },
          &#39;disk_cids&#39; =&gt; [disk_cid],
          &#39;env&#39; =&gt; {
            &#39;bosh&#39; =&gt; {
              &#39;mbus&#39; =&gt; expected_mbus,
              &#39;dummy_agent_key_merged&#39; =&gt; &#39;This key must be sent to agent&#39;, # merged from the director yaml configuration (agent.env.bosh key)
              &#39;group&#39; =&gt; expected_group,
              &#39;groups&#39; =&gt; expected_groups
            }
          }
        })

        expect(second_deploy_invocations[25].method_name).to eq(&#39;set_vm_metadata&#39;)
        expect(second_deploy_invocations[25].inputs).to match({
          &#39;vm_cid&#39; =&gt; String,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;created_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;job&#39; =&gt; &#39;first-job&#39;,
            &#39;instance_group&#39; =&gt; &#39;first-job&#39;,
            &#39;index&#39; =&gt; &#39;0&#39;,
            &#39;id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;name&#39; =&gt; /first-job\/[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;tag1&#39; =&gt; &#39;value1&#39;,
            &#39;tag2&#39; =&gt; &#39;value2&#39;
          }
        })

        expect_name(second_deploy_invocations[25])

        new_vm_cid = second_deploy_invocations[25].inputs[&#39;vm_cid&#39;]

        expect(second_deploy_invocations[27].method_name).to eq(&#39;attach_disk&#39;)
        expect(second_deploy_invocations[27].inputs).to match({
          &#39;vm_cid&#39; =&gt; new_vm_cid,
          &#39;disk_id&#39; =&gt; disk_cid
        })

        expect(second_deploy_invocations[29].method_name).to eq(&#39;set_disk_metadata&#39;)
        expect(second_deploy_invocations[29].inputs).to match({
          &#39;disk_cid&#39; =&gt; disk_cid,
          &#39;metadata&#39; =&gt; {
            &#39;director&#39; =&gt; &#39;TestDirector&#39;,
            &#39;attached_at&#39; =&gt; kind_of(String),
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;instance_group&#39; =&gt; &#39;first-job&#39;,
            &#39;instance_index&#39; =&gt; &#39;0&#39;,
            &#39;instance_id&#39; =&gt; /[0-9a-f]{8}-[0-9a-f-]{27}/,
            &#39;tag1&#39; =&gt; &#39;value1&#39;,
            &#39;tag2&#39; =&gt; &#39;value2&#39;
          }
        })
      end
    end

    context &quot;redacting sensitive information in logs&quot; do
      it &quot;redacts certificates&quot; do
        manifest_hash = Bosh::Spec::NetworkingManifest.deployment_manifest(instances: 1)
        output = deploy_from_scratch(manifest_hash: manifest_hash)

        deployment_name = manifest_hash[&quot;name&quot;]
        task_id = Bosh::Spec::OutputParser.new(output).task_id

        expect_logs_not_to_contain(deployment_name, task_id, [&quot;-----BEGIN&quot;])
      end
    end
  end

  describe &#39;upload simple cpi config&#39; do

    before do
      cpi_path = current_sandbox.sandbox_path(Bosh::Dev::Sandbox::Main::EXTERNAL_CPI)
      cloud_config_manifest = yaml_file(&#39;cloud_manifest&#39;, Bosh::Spec::NewDeployments.simple_cloud_config_with_multiple_azs_and_cpis)
      cpi_config_manifest = yaml_file(&#39;cpi_manifest&#39;, Bosh::Spec::Deployments.multi_cpi_config(cpi_path))

      bosh_runner.run(&quot;update-cloud-config #{cloud_config_manifest.path}&quot;)
      bosh_runner.run(&quot;update-cpi-config #{cpi_config_manifest.path}&quot;)
    end

    context &#39;a cli command that invokes a cpi action&#39; do
      let(:stemcell_filename) { spec_asset(&#39;valid_stemcell.tgz&#39;) }

      before do
        bosh_runner.run(&quot;upload-stemcell #{stemcell_filename}&quot;)
      end

      it &#39;sends CPI config properties as context to the CPI&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(CPI calls)::describe(upload simple cpi config)::context(a cli command that invokes a cpi action)::it#sends CPI config properties as context to the CPI has a flog score of 65</span>          </div>  </li></ol>
        invocations = current_sandbox.cpi.invocations

        expect(invocations[0].method_name).to eq(&#39;info&#39;)
        expect(invocations[0].inputs).to eq(nil)
        expect(invocations[0].context).to include({&#39;somekey&#39; =&gt; &#39;someval&#39;})

        expect(invocations[3].method_name).to eq(&#39;info&#39;)
        expect(invocations[3].inputs).to eq(nil)
        expect(invocations[3].context).to include({&#39;somekey2&#39; =&gt; &#39;someval2&#39;})
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
