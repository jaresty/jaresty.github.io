<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2017-11-06 14:48:05 +0100'>2017-11-06 14:48:05 +0100</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/gocli/integration/release /</small> upload_release_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">551</span><small> lines of codes</small></div>
              <div><span class="metric">2</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">725.6</span><small> complexity/method</small></div>
              <div><span class="metric">23</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1451.18</span><small> complexity</small></div>
              <div><span class="metric">242</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                30
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require_relative &#39;../../spec_helper&#39;
require &#39;bosh/dev/table_parser&#39;

describe &#39;upload release&#39;, type: :integration do
  include Bosh::Spec::CreateReleaseOutputParsers
  with_reset_sandbox_before_each

  let!(:release_file) { Tempfile.new(&#39;release.tgz&#39;) }
  after { release_file.delete }

  it &#39;can upload a release&#39; do
    release_filename = spec_asset(&#39;test_release.tgz&#39;)

    bosh_runner.run(&quot;upload-release #{release_filename}&quot;)

    table_output = table(bosh_runner.run(&#39;releases&#39;, json: true))
    expect(table_output).to include({&#39;name&#39; =&gt; &#39;test_release&#39;, &#39;version&#39; =&gt; &#39;1&#39;, &#39;commit_hash&#39; =&gt; String})
    expect(table_output.length).to eq(1)
  end

  context &#39;when release tarball contents are not sorted&#39; do
    it &#39;updates job successfully&#39; do
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;unsorted-release-0+dev.1.tgz&#39;)}&quot;)

      out = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;unsorted-release-0+dev.2.tgz&#39;)}&quot;)

      expect(out).to include(&#39;Creating new jobs: foobar/&#39;)
      expect(out).to include(&#39;Processing 2 existing packages&#39;)
    end
  end

  it &#39;can upload a release without any package changes when using --rebase option&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::it#can upload a release without any package changes when using --rebase option has a flog score of 48</span>          </div>  </li></ol>
    Dir.chdir(ClientSandbox.test_release_dir) do
      FileUtils.rm_rf(&#39;dev_releases&#39;)

      bosh_runner.run_in_current_dir(&quot;create-release --tarball=#{release_file.path}&quot;)

      # upload the release for the first time
      bosh_runner.run(&quot;upload-release #{release_file.path}&quot;)

      # upload the same release with --rebase option
      bosh_runner.run(&quot;upload-release #{release_file.path} --rebase&quot;)

      # bosh should be able to generate the next version of the release
      table_output = table(bosh_runner.run(&#39;releases&#39;, json: true))
      expect(table_output).to include({&#39;name&#39;=&gt; &#39;bosh-release&#39;, &#39;version&#39;=&gt; &#39;0+dev.2&#39;, &#39;commit_hash&#39;=&gt; String})
      expect(table_output).to include({&#39;name&#39;=&gt; &#39;bosh-release&#39;, &#39;version&#39;=&gt; &#39;0+dev.1&#39;, &#39;commit_hash&#39;=&gt; String})
      expect(table_output.length).to eq(2)
    end
  end

  context &#39;when uploading a compiled release without &quot;./&quot; prefix in the tarball&#39; do
    it &#39;should upload successfully and not raise an error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L53" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L458" class="js-smell-location">1</a>                  </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001_without_dot_slash_prefix.tgz&#39;)}&quot;)
    end
  end

  it &#39;uploads the latest generated release if no release path given&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::it#uploads the latest generated release if no release path given has a flog score of 29</span>          </div>  </li></ol>
    Dir.chdir(ClientSandbox.test_release_dir) do
      FileUtils.rm_rf(&#39;dev_releases&#39;)

      bosh_runner.run_in_current_dir(&#39;create-release&#39;)
      bosh_runner.run_in_current_dir(&#39;upload-release&#39;)
    end
    table_output = table(bosh_runner.run(&#39;releases&#39;, json: true))
    expect(table_output).to include({&#39;name&#39;=&gt; &#39;bosh-release&#39;, &#39;version&#39;=&gt; &#39;0+dev.1&#39;, &#39;commit_hash&#39;=&gt; String})
    expect(table_output.length).to eq(1)
  end

  context &#39;sparsely uploading releases&#39; do
    let!(:release_file2) { Tempfile.new(&#39;release2.tgz&#39;) }
    after { release_file2.delete }

    it &#39;reuses existing jobs/packages release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::context(sparsely uploading releases)::it#reuses existing jobs/packages release has a flog score of 97</span>          </div>  </li></ol>
      Dir.chdir(ClientSandbox.test_release_dir) do
        FileUtils.rm_rf(&#39;dev_releases&#39;)

        out = bosh_runner.run_in_current_dir(&quot;create-release --tarball=#{release_file.path}&quot;)
        expect(File).to exist(release_file.path)

        bosh_runner.run(&quot;upload-release #{release_file.path}&quot;)

        new_file = File.join(&#39;src&#39;, &#39;bar&#39;, &#39;bla&#39;)
        begin
          FileUtils.touch(new_file)

          out = bosh_runner.run_in_current_dir(&quot;create-release --force --tarball=#{release_file2.path}&quot;)
          expect(File).to exist(release_file2.path)
        ensure
          FileUtils.rm_rf(new_file)
        end

        out = bosh_runner.run(&quot;upload-release #{release_file2.path}&quot;)
        expect(out).to match /Creating new packages: bar\//
        expect(out).to match /Processing 17 existing packages/
        expect(out).to match /Processing 26 existing jobs/

        table_output = table(bosh_runner.run(&#39;releases&#39;, json: true))
        expect(table_output).to include({&#39;name&#39;=&gt; &#39;bosh-release&#39;, &#39;version&#39;=&gt; &#39;0+dev.2&#39;, &#39;commit_hash&#39;=&gt; String})
        expect(table_output).to include({&#39;name&#39;=&gt; &#39;bosh-release&#39;, &#39;version&#39;=&gt; &#39;0+dev.1&#39;, &#39;commit_hash&#39;=&gt; String})
        expect(table_output.length).to eq(2)
      end
    end
  end

  it &#39;cannot upload malformed release&#39;, no_reset: true do
    release_filename = spec_asset(&#39;release_invalid_checksum.tgz&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../cli_stemcell_spec.html#L29" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L108" class="js-smell-location">1</a>                  </div>  </li></ol>
    out = bosh_runner.run(&quot;upload-release #{release_filename}&quot;, failure_expected: true)
    expect(out).to match /Error: version presence, version format/
  end

  it &#39;marks releases that have uncommitted changes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::it#marks releases that have uncommitted changes has a flog score of 46</span>          </div>  </li></ol>
    commit_hash = &#39;&#39;

    Dir.chdir(ClientSandbox.test_release_dir) do
      commit_hash = `git show-ref --head --hash=7 2&gt; /dev/null`.split.first

      new_file = File.join(&#39;src&#39;, &#39;bar&#39;, &#39;bla&#39;)
      begin
        FileUtils.touch(new_file)

        bosh_runner.run_in_current_dir(&#39;create-release --force&#39;)
        release_manifest_1 = &quot;#{Dir.pwd}/dev_releases/bosh-release/bosh-release-0+dev.1.yml&quot;
      ensure
        FileUtils.rm_rf(new_file)
      end
      release_manifest = Psych.load_file(release_manifest_1)
      expect(release_manifest[&#39;commit_hash&#39;]).to eq commit_hash
      expect(release_manifest[&#39;uncommitted_changes&#39;]).to be(true)

      bosh_runner.run_in_current_dir(&#39;upload-release&#39;)
    end

    table_output = table(bosh_runner.run(&#39;releases&#39;, json: true))
    expect(table_output).to include({&#39;name&#39;=&gt; &#39;bosh-release&#39;, &#39;version&#39;=&gt; &#39;0+dev.1&#39;, &#39;commit_hash&#39;=&gt; &quot;#{commit_hash}+&quot;})
  end

  describe &#39;uploading a release that already exists&#39; do
    context &#39;when the release is local&#39; do
      let(:local_release_path) { spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;) }
      before { bosh_runner.run(&quot;upload-release #{local_release_path}&quot;) }

      it &#39;includes no package blobs in the repacked release and uploads it to the director&#39; do
        output = bosh_runner.run(&quot;upload-release #{local_release_path}&quot;)
        expect(output).to include(&#39;Processing 5 existing packages&#39;)
        expect(output).to include(&#39;Processing 6 existing jobs&#39;)
      end
    end

    context &#39;when the release is remote&#39; do
      let(:file_server) { Bosh::Spec::LocalFileServer.new(spec_asset(&#39;&#39;), file_server_port, logger) }
      let(:file_server_port) { current_sandbox.port_provider.get_port(:releases_repo) }

      before { file_server.start }
      after { file_server.stop }

      let(:release_url) { file_server.http_url(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;) }

      before { bosh_runner.run(&quot;upload-release #{release_url}&quot;) }

      it &#39;tells the user and does not exit as a failure&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading a release that already exists)::context(when the release is remote)::it#tells the user and does not exit as a failure has a flog score of 33</span>          </div>  </li></ol>
        output = bosh_runner.run(&quot;upload-release #{release_url}&quot;)

        expect(output).to_not include(&#39;Creating new packages&#39;)
        expect(output).to_not include(&#39;Creating new jobs&#39;)
        expect(output).to include(&#39;Processing 5 existing packages&#39;)
        expect(output).to include(&#39;Processing 6 existing jobs&#39;)
      end

      it &#39;does not affect the blobstore ids of the source package blobs&#39; do
        inspect1 = bosh_runner.run(&#39;inspect-release test_release/1&#39;)
        bosh_runner.run(&quot;upload-release #{release_url}&quot;)
        inspect2 = bosh_runner.run(&#39;inspect-release test_release/1&#39;)

        expect(inspect1).to eq(inspect2)
      end
    end
  end

  describe &#39;when the release is remote&#39; do

    let(:file_server) { Bosh::Spec::LocalFileServer.new(spec_asset(&#39;&#39;), file_server_port, logger) }
    let(:file_server_port) { current_sandbox.port_provider.get_port(:releases_repo) }

    before { file_server.start }
    after { file_server.stop }

    let(:release_url) { file_server.http_url(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;) }
    let(:sha1) { &#39;14ab572f7d00333d8e528ab197a513d44c709257&#39; }

    it &#39;accepts the release when the sha1 matches&#39; do
      output = bosh_runner.run(&quot;upload-release #{release_url} --sha1 #{sha1}&quot;)

      expect(output).to include(&#39;Creating new packages&#39;)
      expect(output).to include(&#39;Creating new jobs&#39;)
    end

    it &#39;rejects the release when the sha1 does not match&#39; do
      expect {
        bosh_runner.run(&quot;upload-release #{release_url} --sha1 abcd1234&quot;)
      }.to raise_error(RuntimeError, /Expected stream to have digest &#39;abcd1234&#39; but was &#39;#{sha1}&#39;/)
    end

    it &#39;rejects the release when the sha1 is an unknown algorithm&#39; do
      expect {
        bosh_runner.run(&quot;upload-release #{release_url} --sha1 &#39;shaxyz:abcd1234&#39;&quot;)
      }.to raise_error(RuntimeError, /Computing digest from stream: Unable to create digest of unknown algorithm &#39;shaxyz&#39;/)
    end

    context &#39;when multiple digests are provided&#39; do
      context &#39;when the digest is valid&#39; do
        let(:multidigest_string) { &#39;sha256:a0fa18fba0e244c2c7c0d3f09900d56852b60ec62653babdfcd8b899cbe3d108;sha1:14ab572f7d00333d8e528ab197a513d44c709257&#39; }
        it &#39;accepts and verifies the multiple digests&#39; do
          output = bosh_runner.run(&quot;upload-release #{release_url} --sha1 &#39;#{multidigest_string}&#39;&quot;)
          expect(output).to include(&#39;Creating new packages&#39;)
          expect(output).to include(&#39;Creating new jobs&#39;)
        end
      end

      context &#39;when the digest is invalid&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../cli_stemcell_spec.html#L305" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L221" class="js-smell-location">1</a>                  </div>  </li></ol>
        let(:multidigest_string) { &#39;sha256:badsha512;sha1:14ab572f7d00333d8e528ab197a513d44c709257&#39; }

        it &#39;rejects the release&#39; do
          expect {
            bosh_runner.run(&quot;upload-release #{release_url} --sha1 &#39;#{multidigest_string}&#39;&quot;)
          }.to raise_error(RuntimeError, /Error: Expected stream to have digest &#39;sha256:badsha512&#39; but was &#39;sha256:/)
        end
      end
    end
  end

  describe &#39;re-uploading a release after it fails in a previous attempt&#39; do
    it &#39;should not throw an error, and should backfill missing items while not uploading already uploaded packages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(re-uploading a release after it fails in a previous attempt)::it#should not throw an error, and should backfill missing items while not uploading already uploaded packages has a flog score of 119</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release-1-corrupted.tgz&#39;)}&quot;)
      clean_release_out = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)

      expect(clean_release_out).to include(&#39;Creating new packages: pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;)
      expect(clean_release_out).to include(&#39;Processing 4 existing packages&#39;)
      expect(clean_release_out).to include(&#39;Creating new jobs: job_using_pkg_5/fb41300edf220b1823da5ab4c243b085f9f249af&#39;)
      expect(clean_release_out).to include(&#39;Processing 5 existing jobs&#39;)

      bosh_releases_out = table(bosh_runner.run(&#39;releases&#39;, json: true))
      expect(bosh_releases_out).to include({&#39;name&#39; =&gt; &#39;test_release&#39;, &#39;version&#39; =&gt; &#39;1&#39;, &#39;commit_hash&#39; =&gt; &#39;50e58513+&#39;})

      inspect_release_out = table(bosh_runner.run(&#39;inspect-release test_release/1&#39;, json: true))
      expect(inspect_release_out).to include({&#39;job&#39; =&gt; &#39;job_using_pkg_1/9a5f09364b2cdc18a45172c15dca21922b3ff196&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39; =&gt; &#39;a7d51f65cda79d2276dc9cc254e6fec523b07b02&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(inspect_release_out).to include({&#39;job&#39; =&gt; &#39;job_using_pkg_1_and_2/673c3689362f2adb37baed3d8d4344cf03ff7637&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39; =&gt; &#39;c9acbf245d4b4721141b54b26bee20bfa58f4b54&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(inspect_release_out).to include({&#39;job&#39; =&gt; &#39;job_using_pkg_2/8e9e3b5aebc7f15d661280545e9d1c1c7d19de74&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39; =&gt; &#39;79475b0b035fe70f13a777758065210407170ec3&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(inspect_release_out).to include({&#39;job&#39; =&gt; &#39;job_using_pkg_3/54120dd68fab145433df83262a9ba9f3de527a4b&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39; =&gt; &#39;ab4e6077ecf03399f215e6ba16153fd9ebbf1b5f&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(inspect_release_out).to include({&#39;job&#39; =&gt; &#39;job_using_pkg_4/0ebdb544f9c604e9a3512299a02b6f04f6ea6d0c&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39; =&gt; &#39;1ff32a12e0c574720dd8e5111834bac67229f5c1&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(inspect_release_out).to include({&#39;job&#39; =&gt; &#39;job_using_pkg_5/fb41300edf220b1823da5ab4c243b085f9f249af&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39; =&gt; &#39;37350e20c6f78ab96a1191e5d97981a8d2831665&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})

      expect(inspect_release_out).to include( {&#39;package&#39; =&gt; &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;, &#39;compiled_for&#39; =&gt; &#39;(source)&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39;=&gt; &#39;93fade7dd8950d8a1dd2bf5ec751e478af3150e9&#39;})
      expect(inspect_release_out).to include( {&#39;package&#39; =&gt; &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;, &#39;compiled_for&#39; =&gt; &#39;(source)&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39;=&gt; &#39;b2751daee5ef20b3e4f3ebc3452943c28f584500&#39;})
      expect(inspect_release_out).to include( {&#39;package&#39; =&gt; &#39;pkg_3_depends_on_2/413e3e9177f0037b1882d19fb6b377b5b715be1c&#39;, &#39;compiled_for&#39; =&gt; &#39;(source)&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39;=&gt; &#39;62fff2291aac72f5bd703dba0c5d85d0e23532e0&#39;})
      expect(inspect_release_out).to include( {&#39;package&#39; =&gt; &#39;pkg_4_depends_on_3/9207b8a277403477e50cfae52009b31c840c49d4&#39;, &#39;compiled_for&#39; =&gt; &#39;(source)&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39;=&gt; &#39;603f212d572b0307e4c51807c5e03c47944bb9c3&#39;})
      expect(inspect_release_out).to include( {&#39;package&#39; =&gt; &#39;pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;, &#39;compiled_for&#39; =&gt; &#39;(source)&#39;, &#39;blobstore_id&#39; =&gt; String, &#39;digest&#39;=&gt; &#39;ad733ca76ab4747747d8f9f1ddcfa568519a2e00&#39;})
    end

    it &#39;does not allow uploading same release version with different commit hash&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L261" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L297" class="js-smell-location">1</a>                  <a href="upload_release_spec.html#L305" class="js-smell-location">2</a>                  </div>  </li></ol>
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release-1-corrupted_with_different_commit.tgz&#39;)}&quot;)
      expect {
        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)
      }.to raise_error(RuntimeError, /Error: release &#39;test_release\/1&#39; has already been uploaded with commit_hash as &#39;50e58513&#39; and uncommitted_changes as &#39;true&#39;/)
    end
  end

  describe &#39;uploading a release with the same packages as some other release&#39; do
    it &#39;omits identical packages from the repacked tarball and creates new copies of the blobstore entries under the new release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading a release with the same packages as some other release)::it#omits identical packages from the repacked tarball and creates new copies of the blobstore entries under the new release has a flog score of 56</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/release_with_shared_blobs/release_with_shared_blobs-1.tgz&#39;)}&quot;)

      test_release_desc = table(bosh_runner.run(&#39;inspect-release test_release/1&#39;, json: true))
      shared_release_desc = table(bosh_runner.run(&#39;inspect-release release_with_shared_blobs/1&#39;, json: true))

      test_release_blobstore_ids = test_release_desc.map do |item|
        item[&#39;blobstore_id&#39;]
      end

      shared_release_blobstore_ids = shared_release_desc.map do |item|
        item[&#39;blobstore_id&#39;]
      end

      expect(shared_release_blobstore_ids &amp; test_release_blobstore_ids).to eq([])

      test_release_artifacts = test_release_desc.map do |item|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L287" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L290" class="js-smell-location">1</a>                  </div>  </li></ol>
        { &#39;Artifact&#39; =&gt; item.fetch(&#39;package&#39;, item[&#39;job&#39;]), &#39;digest&#39; =&gt; item[&#39;digest&#39;] }
      end
      shared_release_artifacts = shared_release_desc.map do |item|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L287" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L290" class="js-smell-location">1</a>                  </div>  </li></ol>
        { &#39;Artifact&#39; =&gt; item.fetch(&#39;package&#39;, item[&#39;job&#39;]), &#39;digest&#39; =&gt; item[&#39;digest&#39;] }
      end

      expect((shared_release_artifacts &amp; test_release_artifacts).length).to eq(test_release_artifacts.length)
    end

    it &#39;raises an error if the uploaded release version already exists but there are packages with different fingerprints&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L261" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L297" class="js-smell-location">1</a>                  <a href="upload_release_spec.html#L305" class="js-smell-location">2</a>                  </div>  </li></ol>
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)

      expect {
        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1-pkg2-updated.tgz&#39;)}&quot;)
      }.to raise_error(RuntimeError, /Error: package &#39;pkg_2&#39; had different fingerprint in previously uploaded release &#39;test_release\/1&#39;/)
    end

    it &#39;raises an error if the uploaded release version already exists but there are jobs with different fingerprints&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L261" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L297" class="js-smell-location">1</a>                  <a href="upload_release_spec.html#L305" class="js-smell-location">2</a>                  </div>  </li></ol>
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)

      expect {
        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1-job1-updated.tgz&#39;)}&quot;)
      }.to raise_error(RuntimeError, /Error: job &#39;job_using_pkg_1&#39; had different fingerprint in previously uploaded release &#39;test_release\/1&#39;/)
    end

    it &#39;allows sharing of packages across releases when the original packages does not have source&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L313" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L382" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading a release with the same packages as some other release)::it#allows sharing of packages across releases when the original packages does not have source has a flog score of 28</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)
      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/release_with_shared_blobs/release_with_shared_blobs-1.tgz&#39;)}&quot;)
      expect(output).to include(&#39;Creating new packages: pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;)
      expect(output).to include(&#39;Release has been created: release_with_shared_blobs/1&#39;)
    end
  end

  describe &#39;uploading compiled releases&#39; do
    it &#39;should not raise an error if no stemcell matched the criteria&#39; do
      expect {
        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)
      }.not_to raise_error
    end

    it &#39;should populate compiled packages for one stemcell&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#should populate compiled packages for one stemcell has a flog score of 35</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)

      expect(output).to include(&#39;Creating new packages: go-lang-1.4.2/7d4bf6e5267a46d414af2b9a62e761c2e5f33a8d&#39;)
      expect(output).to include(&#39;Creating new compiled packages: go-lang-1.4.2/7d4bf6e5267a46d414af2b9a62e761c2e5f33a8d for centos-7/3001&#39;)
      expect(output).to include(&#39;Creating new compiled packages: hello-go/03df8c27c4525622aacc0d7013af30a9f2195393 for centos-7/3001&#39;)
      expect(output).to include(&#39;Creating new jobs: hello-go/0cf937b9a063cf96bd7506fa31699325b40d2d08&#39;)
    end

    it &#39;should populate compiled packages for two matching stemcells&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#should populate compiled packages for two matching stemcells has a flog score of 40</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-centos-7-go_agent.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)

      expect(output).to include(&#39;Creating new packages: go-lang-1.4.2/7d4bf6e5267a46d414af2b9a62e761c2e5f33a8d&#39;)
      expect(output).to include(&#39;Creating new compiled packages: go-lang-1.4.2/7d4bf6e5267a46d414af2b9a62e761c2e5f33a8d for centos-7/3001&#39;)
      expect(output).to include(&#39;Creating new compiled packages: hello-go/03df8c27c4525622aacc0d7013af30a9f2195393 for centos-7/3001&#39;)
      expect(output).to include(&#39;Creating new jobs: hello-go/0cf937b9a063cf96bd7506fa31699325b40d2d08&#39;)
    end

    it &#39;upload a compiled release tarball&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#upload a compiled release tarball has a flog score of 29</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell.tgz&#39;)}&quot;)
      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-toronto-os-stemcell-1.tgz&#39;)}&quot;)
      expect(output).to include(&#39;Creating new packages: hello-go/b3df8c27c4525622aacc0d7013af30a9f2195393&#39;)
      expect(output).to include(&#39;Creating new compiled packages: hello-go/b3df8c27c4525622aacc0d7013af30a9f2195393 for toronto-os/1&#39;)
      expect(output).to include(&#39;Creating new jobs: hello-go/0cf937b9a063cf96bd7506fa31699325b40d2d08&#39;)
    end

    it &#39;should not do any expensive operations for 2nd upload of a compiled release tarball&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#should not do any expensive operations for 2nd upload of a compiled release tarball has a flog score of 46</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell.tgz&#39;)}&quot;)
      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-toronto-os-stemcell-1.tgz&#39;)}&quot;)
      expect(output).to include(&#39;Creating new packages: hello-go/&#39;)
      expect(output).to include(&#39;Creating new compiled packages: hello-go/&#39;)
      expect(output).to include(&#39;Creating new jobs: hello-go/&#39;)

      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-toronto-os-stemcell-1.tgz&#39;)}&quot;)
      #expect(output).to include(&#39;Processing 1 existing compiled package&#39;)
      expect(output).to include(&#39;Processing 1 existing job&#39;)
      expect(output).to include(&#39;Compiled Release has been created&#39;)
    end

    it &#39;should use dependencies in matching for 2nd upload of a compiled release tarball&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#should use dependencies in matching for 2nd upload of a compiled release tarball has a flog score of 40</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)
      expect(output).to include(&#39;Creating new packages&#39;)
      expect(output).to include(&#39;Creating new compiled packages&#39;)
      expect(output).to include(&#39;Creating new jobs&#39;)

      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)
      expect(output).to include(&#39;Processing 6 existing job&#39;)
    end

    it &#39;upload a new version of compiled release tarball when the compiled release is already uploaded&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L313" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L382" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#upload a new version of compiled release tarball when the compiled release is already uploaded has a flog score of 28</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-toronto-os-stemcell-1.tgz&#39;)}&quot;)

      output = bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-51-on-toronto-os-stemcell-1.tgz&#39;)}&quot;)
      expect(output).to include(&#39;Processing 1 existing package&#39;)
      expect(output).to include(&#39;Processing 1 existing job&#39;)
    end

    it &#39;backfills the source code for an already exisiting compiled release&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#backfills the source code for an already exisiting compiled release has a flog score of 33</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)

      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)

      output = table(bosh_runner.run(&#39;inspect-release test_release/1&#39;, json: true))
      output.select{|item| item.has_key? &#39;package&#39;}.each do |item|
        expect([&#39;(source)&#39;, &#39;centos-7/3001&#39;]).to include(item[&#39;compiled_for&#39;])
      end
    end

    it &#39;backfill source of an already exisitng compiled release when there is another release that has exactly same contents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#backfill source of an already exisitng compiled release when there is another release that has exactly same contents has a flog score of 106</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)

      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release_with_different_name.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)

      inspect_release_with_other_name_out = table(bosh_runner.run(&#39;inspect-release test_release_with_other_name/1&#39;, json: true))
      inspect_release_out = table(bosh_runner.run(&#39;inspect-release test_release/1&#39;, json: true))

      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;93fade7dd8950d8a1dd2bf5ec751e478af3150e9&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;735987b52907d970106f38413825773eec7cc577&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;b2751daee5ef20b3e4f3ebc3452943c28f584500&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;5b21895211d8592c129334e3d11bd148033f7b82&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_3_depends_on_2/413e3e9177f0037b1882d19fb6b377b5b715be1c&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;62fff2291aac72f5bd703dba0c5d85d0e23532e0&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_3_depends_on_2/413e3e9177f0037b1882d19fb6b377b5b715be1c&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;f5cc94a01d2365bbeea00a4765120a29cdfb3bd7&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_4_depends_on_3/9207b8a277403477e50cfae52009b31c840c49d4&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;603f212d572b0307e4c51807c5e03c47944bb9c3&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_4_depends_on_3/9207b8a277403477e50cfae52009b31c840c49d4&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;f21275861158ad864951faf76da0dce9c1b5f215&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;ad733ca76ab4747747d8f9f1ddcfa568519a2e00&#39;})
      expect(inspect_release_out).to include({&#39;package&#39;=&gt; &#39;pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;002deec46961440df01c620be491e5b12246c5df&#39;})

      # make sure the the blobstore_ids of the packages in the 2 releases are different
      inspect_release_with_other_name_packages = inspect_release_with_other_name_out.map{|item| item[&#39;blobstore_id&#39;]}
      inspect_release_packages = inspect_release_out.map{|item| item[&#39;blobstore_id&#39;]}

      expect((inspect_release_with_other_name_packages &amp; inspect_release_packages).length).to eq(0)
    end

    it &#39;allows uploading a compiled release after its source release has been uploaded&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading compiled releases)::it#allows uploading a compiled release after its source release has been uploaded has a flog score of 124</span>          </div>  </li></ol>
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-centos-7-go_agent.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;light-bosh-stemcell-3001-aws-xen-hvm-centos-7-go_agent.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)

      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/release-test_release-1-on-centos-7-stemcell-3001.tgz&#39;)}&quot;)

      output = table(bosh_runner.run(&#39;inspect-release test_release/1&#39;, json: true))
      expect(output).to include({&#39;job&#39;=&gt; &#39;job_using_pkg_1/9a5f09364b2cdc18a45172c15dca21922b3ff196&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;a7d51f65cda79d2276dc9cc254e6fec523b07b02&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(output).to include({&#39;job&#39;=&gt; &#39;job_using_pkg_1_and_2/673c3689362f2adb37baed3d8d4344cf03ff7637&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;c9acbf245d4b4721141b54b26bee20bfa58f4b54&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(output).to include({&#39;job&#39;=&gt; &#39;job_using_pkg_2/8e9e3b5aebc7f15d661280545e9d1c1c7d19de74&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;79475b0b035fe70f13a777758065210407170ec3&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(output).to include({&#39;job&#39;=&gt; &#39;job_using_pkg_3/54120dd68fab145433df83262a9ba9f3de527a4b&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;ab4e6077ecf03399f215e6ba16153fd9ebbf1b5f&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(output).to include({&#39;job&#39;=&gt; &#39;job_using_pkg_4/0ebdb544f9c604e9a3512299a02b6f04f6ea6d0c&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;1ff32a12e0c574720dd8e5111834bac67229f5c1&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})
      expect(output).to include({&#39;job&#39;=&gt; &#39;job_using_pkg_5/fb41300edf220b1823da5ab4c243b085f9f249af&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;37350e20c6f78ab96a1191e5d97981a8d2831665&#39;, &#39;links_consumed&#39; =&gt; &#39;&#39;, &#39;links_provided&#39; =&gt; &#39;&#39;})

      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;93fade7dd8950d8a1dd2bf5ec751e478af3150e9&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_1/16b4c8ef1574b3f98303307caad40227c208371f&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;735987b52907d970106f38413825773eec7cc577&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;b2751daee5ef20b3e4f3ebc3452943c28f584500&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_2/f5c1c303c2308404983cf1e7566ddc0a22a22154&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;5b21895211d8592c129334e3d11bd148033f7b82&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_3_depends_on_2/413e3e9177f0037b1882d19fb6b377b5b715be1c&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;62fff2291aac72f5bd703dba0c5d85d0e23532e0&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_3_depends_on_2/413e3e9177f0037b1882d19fb6b377b5b715be1c&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;f5cc94a01d2365bbeea00a4765120a29cdfb3bd7&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_4_depends_on_3/9207b8a277403477e50cfae52009b31c840c49d4&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;603f212d572b0307e4c51807c5e03c47944bb9c3&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_4_depends_on_3/9207b8a277403477e50cfae52009b31c840c49d4&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;f21275861158ad864951faf76da0dce9c1b5f215&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;, &#39;compiled_for&#39;=&gt; &#39;(source)&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;ad733ca76ab4747747d8f9f1ddcfa568519a2e00&#39; })
      expect(output).to include({&#39;package&#39;=&gt; &#39;pkg_5_depends_on_4_and_1/3cacf579322370734855c20557321dadeee3a7a4&#39;, &#39;compiled_for&#39;=&gt; &#39;centos-7/3001&#39;, &#39;blobstore_id&#39;=&gt; String, &#39;digest&#39;=&gt; &#39;002deec46961440df01c620be491e5b12246c5df&#39; })
    end

    it &#39;allows uploading two source releases with different version numbers but identical contents&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="upload_release_spec.html#L53" class="js-smell-location">0</a>                  <a href="upload_release_spec.html#L458" class="js-smell-location">1</a>                  </div>  </li></ol>
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-1.tgz&#39;)}&quot;)
      bosh_runner.run(&quot;upload-release #{spec_asset(&#39;compiled_releases/test_release/releases/test_release/test_release-4-same-packages-as-1.tgz&#39;)}&quot;)
    end
  end

  describe &#39;uploading release with --fix&#39; do
    def get_blob_ids(json_output)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>get_blob_ids has approx 8 statements</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>get_blob_ids doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      json = JSON.parse(json_output)
      result = []
      json[&#39;Tables&#39;].each do |table|
        blobIdColIdx = table[&#39;Header&#39;].index(&#39;blobstore_id&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>get_blob_ids has the variable name 'blobIdColIdx'</span>          </div>  </li></ol>
        table[&#39;Rows&#39;].each do |row|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>get_blob_ids contains iterators nested 2 deep</span>          </div>  </li></ol>
          blob_id = row[blobIdColIdx]
          result &lt;&lt; blob_id if blob_id != &#39;&#39;
        end
      end
      result
    end

    def search_and_delete_files(file_path, blob_files)
      if File.directory? file_path
        Dir.foreach(file_path) do |file|
          if file != &#39;.&#39; and file != &#39;..&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>search_and_delete_files refers to 'file' more than self (maybe move it to another class?)</span>          </div>  </li></ol>
            search_and_delete_files(file_path + &#39;/&#39; + file, blob_files)
          end
        end
      else
        if blob_files.include? File.basename(file_path)
          FileUtils.rm_rf(File.realpath(file_path))
        end
      end
    end

    context &#39;when uploading source package&#39; do
      it &#39;Re-uploads all packages to replace old ones and eliminates broken compiled packages&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading release with --fix)::context(when uploading source package)::it#Re-uploads all packages to replace old ones and eliminates broken compiled packages has a flog score of 71</span>          </div>  </li></ol>
        Dir.chdir(ClientSandbox.test_release_dir) do
          bosh_runner.run_in_current_dir(&#39;create-release&#39;)
          bosh_runner.run_in_current_dir(&#39;upload-release&#39;)
        end

        bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell.tgz&#39;)}&quot;)

        cloud_config_manifest = yaml_file(&#39;cloud_manifest&#39;, Bosh::Spec::NewDeployments.simple_cloud_config)
        bosh_runner.run(&quot;update-cloud-config #{cloud_config_manifest.path}&quot;)

        deployment_manifest = yaml_file(&#39;deployment_manifest&#39;, Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups)

        bosh_runner.run(&quot;deploy #{deployment_manifest.path}&quot;, deployment_name: &#39;simple&#39;)

        inspect1 = bosh_runner.run(&#39;inspect-release bosh-release/0+dev.1&#39;, json: true)
        blob_files_1 = get_blob_ids(inspect1)
        expect(blob_files_1).to_not be_empty

        # Delete all package and compiled package blob files
        search_and_delete_files(current_sandbox.blobstore_storage_dir, blob_files_1)

        Dir.chdir(ClientSandbox.test_release_dir) do
          bosh_runner.run_in_current_dir(&#39;upload-release --fix&#39;)
        end

        bosh_runner.run(&quot;deploy #{deployment_manifest.path}&quot;, deployment_name: &#39;simple&#39;)

        inspect2 = bosh_runner.run(&#39;inspect-release bosh-release/0+dev.1&#39;, json: true)
        blob_files_2 = get_blob_ids(inspect2)
        expect(blob_files_2).to_not be_empty

        expect(blob_files_2 - blob_files_1).to be_empty
      end
    end

    context &#39;when uploading compiled package&#39; do
      it &#39;Re-uploads all compiled packages to replace old ones&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(upload release)::describe(uploading release with --fix)::context(when uploading compiled package)::it#Re-uploads all compiled packages to replace old ones has a flog score of 45</span>          </div>  </li></ol>
        bosh_runner.run(&quot;upload-stemcell #{spec_asset(&#39;valid_stemcell.tgz&#39;)}&quot;)
        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-toronto-os-stemcell-1.tgz&#39;)}&quot;)

        inspect1 = bosh_runner.run(&#39;inspect-release hello-go/50&#39;, json: true)
        blob_files_1 = get_blob_ids(inspect1)
        expect(blob_files_1).to_not be_empty

        # Delete all package and compiled package blob files
        search_and_delete_files(current_sandbox.blobstore_storage_dir, blob_files_1)

        bosh_runner.run(&quot;upload-release #{spec_asset(&#39;release-hello-go-50-on-toronto-os-stemcell-1.tgz&#39;)} --fix&quot;)

        inspect2 = bosh_runner.run(&#39;inspect-release hello-go/50&#39;, json: true)
        blob_files_2 = get_blob_ids(inspect2)
        expect(blob_files_2).to_not be_empty

        expect(blob_files_2 - blob_files_1).to be_empty
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
