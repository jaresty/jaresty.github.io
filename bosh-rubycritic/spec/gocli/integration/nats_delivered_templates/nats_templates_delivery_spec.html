<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-02-05 09:46:36 -0500'>2018-02-05 09:46:36 -0500</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/gocli/integration/nats_delivered_templates /</small> nats_templates_delivery_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">215</span><small> lines of codes</small></div>
              <div><span class="metric">0</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">N/A</span><small> complexity/method</small></div>
              <div><span class="metric">13</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">331.24</span><small> complexity</small></div>
              <div><span class="metric">229</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                8
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require_relative &#39;../../spec_helper&#39;

describe &#39;deliver rendered templates through nats&#39;, type: :integration do
  with_reset_sandbox_before_each(enable_nats_delivered_templates: true)

  let(:vm_type) do
    {
      &#39;name&#39; =&gt; &#39;smurf-vm-type&#39;,
      &#39;cloud_properties&#39; =&gt; {}
    }
  end

  let(:cloud_config) do
    cloud_config_hash = Bosh::Spec::NewDeployments.simple_cloud_config
    cloud_config_hash[&#39;vm_types&#39;] = [vm_type]
    cloud_config_hash
  end

  let(:manifest_hash) do
    manifest_hash = Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups
    manifest_hash[&#39;stemcells&#39;] = [Bosh::Spec::Deployments.stemcell]
    manifest_hash[&#39;instance_groups&#39;] = [{<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../nats/nats_server_spec.html#L24" class="js-smell-location">0</a>                  <a href="nats_templates_delivery_spec.html#L22" class="js-smell-location">1</a>                  </div>  </li></ol>
       &#39;name&#39; =&gt; &#39;our_instance_group&#39;,
       &#39;jobs&#39; =&gt; [{
                    &#39;name&#39; =&gt; &#39;job_1_with_many_properties&#39;,
                    &#39;properties&#39; =&gt; job_properties
                  }],
       &#39;vm_type&#39; =&gt; &#39;smurf-vm-type&#39;,
       &#39;stemcell&#39; =&gt; &#39;default&#39;,
       &#39;instances&#39; =&gt; 3,
       &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;a&#39; }]
     }]
    manifest_hash
  end

  let(:job_properties) do
    {
      &#39;gargamel&#39; =&gt; {
        &#39;color&#39; =&gt; &#39;GARGAMEL_COLOR_IS_NOT_BLUE&#39;
      },
      &#39;smurfs&#39; =&gt; {
        &#39;happiness_level&#39; =&gt; 2000
      }
    }
  end

  it &#39;does NOT store rendered templates in the blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(deliver rendered templates through nats)::it#does NOT store rendered templates in the blobstore has a flog score of 35</span>          </div>  </li></ol>
    deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: cloud_config)

    running_instance = director.instances.select{ |instance| instance.instance_group_name == &#39;our_instance_group&#39;}.first
    template_hash = YAML.load(running_instance.read_job_template(&#39;job_1_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
    expect(template_hash[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;GARGAMEL_COLOR_IS_NOT_BLUE&#39;)

    zgrep_output = `zgrep GARGAMEL_COLOR_IS_NOT_BLUE #{current_sandbox.blobstore_storage_dir}/*`

    expect(zgrep_output.empty?).to be_truthy
  end

  it &#39;sanitizes agent_client upload_blob call in director debug logs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(deliver rendered templates through nats)::it#sanitizes agent_client upload_blob call in director debug logs has a flog score of 89</span>          </div>  </li></ol>
    deploy_output = deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: cloud_config)

    task_id = deploy_output.match(/^Task (\d+)$/)[1]

    debug_output = bosh_runner.run(&quot;task --debug #{task_id}&quot;)
    upload_blob_debug_lines = debug_output.split(&quot;\n&quot;).select{ |line| line.include?(&#39;&quot;method&quot;:&quot;upload_blob&quot;&#39;) }
    expect(upload_blob_debug_lines.count).to eq(6)

    upload_blob_debug_lines.each do |line|
      upload_blob_request = JSON.parse(line.split(/SENT: agent\.[0-9a-f]{8}-[0-9a-f-]{27} /)[1])
      expect(upload_blob_request[&#39;method&#39;]).to eq(&#39;upload_blob&#39;)
      expect(upload_blob_request[&#39;arguments&#39;].size).to eq(1)
      expect(upload_blob_request[&#39;arguments&#39;][0][&#39;checksum&#39;]).to eq(&#39;&lt;redacted&gt;&#39;)
      expect(upload_blob_request[&#39;arguments&#39;][0][&#39;payload&#39;]).to eq(&#39;&lt;redacted&gt;&#39;)
    end

    running_instance = director.instances.select{ |instance| instance.instance_group_name == &#39;our_instance_group&#39;}.first
    template_hash = YAML.load(running_instance.read_job_template(&#39;job_1_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
    expect(template_hash[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;GARGAMEL_COLOR_IS_NOT_BLUE&#39;)
  end

  context &#39;when having multiple instance groups and jobs&#39; do
    let(:job_2_properties) do
      {
        &#39;gargamel&#39; =&gt; {
          &#39;color&#39; =&gt; &#39;RED_IS_AZRIEL&#39;
        },
        &#39;smurfs&#39; =&gt; {
          &#39;happiness_level&#39; =&gt; 150
        }
      }
    end

    let(:big_manifest_hash) do
      big_manifest_hash = Bosh::Spec::NewDeployments.simple_manifest_with_instance_groups
      big_manifest_hash[&#39;instance_groups&#39;] = [{<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="nats_templates_delivery_spec.html#L95" class="js-smell-location">0</a>                  <a href="nats_templates_delivery_spec.html#L113" class="js-smell-location">1</a>                  </div>  </li></ol>
                                 &#39;name&#39; =&gt; &#39;instance_group_1&#39;,
                                 &#39;jobs&#39; =&gt; [{
                                                   &#39;name&#39; =&gt; &#39;job_1_with_many_properties&#39;,
                                                   &#39;properties&#39; =&gt; job_properties
                                                 },
                                                 {
                                                   &#39;name&#39; =&gt; &#39;job_2_with_many_properties&#39;,
                                                   &#39;properties&#39; =&gt; job_2_properties
                                                 },
                                                 {
                                                   &#39;name&#39; =&gt; &#39;errand1&#39;,
                                                   &#39;properties&#39; =&gt; { &#39;errand1&#39; =&gt; { &#39;exit_code&#39; =&gt; 10} }
                                                 }],
                                 &#39;vm_type&#39; =&gt; &#39;smurf-vm-type&#39;,
                                 &#39;stemcell&#39; =&gt; &#39;default&#39;,
                                 &#39;instances&#39; =&gt; 3,
                                 &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;a&#39; }]
                               },{<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="nats_templates_delivery_spec.html#L95" class="js-smell-location">0</a>                  <a href="nats_templates_delivery_spec.html#L113" class="js-smell-location">1</a>                  </div>  </li></ol>
                                &#39;name&#39; =&gt; &#39;instance_group_2&#39;,
                                &#39;jobs&#39; =&gt; [{
                                                  &#39;name&#39; =&gt; &#39;job_1_with_many_properties&#39;,
                                                  &#39;properties&#39; =&gt; job_2_properties
                                                },
                                                {
                                                  &#39;name&#39; =&gt; &#39;job_2_with_many_properties&#39;,
                                                  &#39;properties&#39; =&gt; job_properties
                                                },
                                                {
                                                  &#39;name&#39; =&gt; &#39;errand1&#39;,
                                                  &#39;properties&#39; =&gt; { &#39;errand1&#39; =&gt; { &#39;exit_code&#39; =&gt; 5} }
                                                }],
                                &#39;vm_type&#39; =&gt; &#39;smurf-vm-type&#39;,
                                &#39;stemcell&#39; =&gt; &#39;default&#39;,
                                &#39;instances&#39; =&gt; 2,
                                &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;a&#39; }]
                              }]
      big_manifest_hash
    end

    it &#39;should work as expected&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>describe(deliver rendered templates through nats)::context(when having multiple instance groups and jobs)::it#should work as expected has a flog score of 93</span>          </div>  </li></ol>
      deploy_from_scratch(manifest_hash: big_manifest_hash, cloud_config_hash: cloud_config)

      running_instances = director.instances

      # =========================================
      # Instance Group 1
      instance_group_1_vm = running_instances.select{ |instance| instance.instance_group_name == &#39;instance_group_1&#39;}.first

      template_1_hash_1 = YAML.load(instance_group_1_vm.read_job_template(&#39;job_1_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
      expect(template_1_hash_1[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;GARGAMEL_COLOR_IS_NOT_BLUE&#39;)

      template_1_hash_2 = YAML.load(instance_group_1_vm.read_job_template(&#39;job_2_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
      expect(template_1_hash_2[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;RED_IS_AZRIEL&#39;)

      errand_1_run_script = instance_group_1_vm.read_job_template(&#39;errand1&#39;, &#39;bin/run&#39;)
      expect(errand_1_run_script).to include(&#39;exit 10&#39;)

      # =========================================
      # Instance Group 2
      instance_group_2_vm = running_instances.select{ |instance| instance.instance_group_name == &#39;instance_group_2&#39;}.first

      template_2_hash_1 = YAML.load(instance_group_2_vm.read_job_template(&#39;job_1_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
      expect(template_2_hash_1[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;RED_IS_AZRIEL&#39;)

      template_2_hash_2 = YAML.load(instance_group_2_vm.read_job_template(&#39;job_2_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
      expect(template_2_hash_2[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;GARGAMEL_COLOR_IS_NOT_BLUE&#39;)

      errand_2_run_script = instance_group_2_vm.read_job_template(&#39;errand1&#39;, &#39;bin/run&#39;)
      expect(errand_2_run_script).to include(&#39;exit 5&#39;)

      zegrep_output = `zegrep &#39;GARGAMEL_COLOR_IS_NOT_BLUE|RED_IS_AZRIEL&#39; #{current_sandbox.blobstore_storage_dir}/*`
      expect(zegrep_output.empty?).to be_truthy
    end

  end

  context &#39;when agent does not support handling templates through nats&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="nats_templates_delivery_spec.html#L172" class="js-smell-location">0</a>                  <a href="nats_templates_delivery_spec.html#L194" class="js-smell-location">1</a>                  </div>  </li></ol>
    with_reset_sandbox_before_each(enable_nats_delivered_templates: true, nats_allow_legacy_clients: true)

    let(:vm_type) do
      {
        &#39;name&#39; =&gt; &#39;smurf-vm-type&#39;,
        &#39;cloud_properties&#39; =&gt; {&#39;legacy_agent_path&#39; =&gt; get_legacy_agent_path(&#39;no-upload-blob-action-e82bdd1c&#39;)}
      }
    end

    it &#39;should fallback to storing in the default blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(deliver rendered templates through nats)::context(when agent does not support handling templates through nats)::it#should fallback to storing in the default blobstore has a flog score of 37</span>          </div>  </li></ol>
      deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: cloud_config)

      running_instance = director.instances.select{ |instance| instance.instance_group_name == &#39;our_instance_group&#39;}.first
      template_hash = YAML.load(running_instance.read_job_template(&#39;job_1_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
      expect(template_hash[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;GARGAMEL_COLOR_IS_NOT_BLUE&#39;)

      zgrep_output = `zgrep GARGAMEL_COLOR_IS_NOT_BLUE #{current_sandbox.blobstore_storage_dir}/*`
      expect(zgrep_output.empty?).to be_falsey
    end
  end

  context &#39;when agent fails to open blob for writing&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="nats_templates_delivery_spec.html#L172" class="js-smell-location">0</a>                  <a href="nats_templates_delivery_spec.html#L194" class="js-smell-location">1</a>                  </div>  </li></ol>
    with_reset_sandbox_before_each(enable_nats_delivered_templates: true, nats_allow_legacy_clients: true)

    let(:vm_type) do
      {
        &#39;name&#39; =&gt; &#39;smurf-vm-type&#39;,
        &#39;cloud_properties&#39; =&gt; {&#39;legacy_agent_path&#39; =&gt; get_legacy_agent_path(&#39;upload-blob-action-error-file-not-found&#39;)}
      }
    end

    it &#39;should fallback to storing in the default blobstore&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(deliver rendered templates through nats)::context(when agent fails to open blob for writing)::it#should fallback to storing in the default blobstore has a flog score of 37</span>          </div>  </li></ol>
      deploy_from_scratch(manifest_hash: manifest_hash, cloud_config_hash: cloud_config)

      running_instance = director.instances.select{ |instance| instance.instance_group_name == &#39;our_instance_group&#39;}.first
      template_hash = YAML.load(running_instance.read_job_template(&#39;job_1_with_many_properties&#39;, &#39;properties_displayer.yml&#39;))
      expect(template_hash[&#39;properties_list&#39;][&#39;gargamel_color&#39;]).to eq(&#39;GARGAMEL_COLOR_IS_NOT_BLUE&#39;)

      zgrep_output = `zgrep GARGAMEL_COLOR_IS_NOT_BLUE #{current_sandbox.blobstore_storage_dir}/*`
      expect(zgrep_output.empty?).to be_falsey
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
