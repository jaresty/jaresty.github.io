<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-21 10:18:47 -0400'>2018-06-21 10:18:47 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>spec/gocli/integration /</small> links_api_spec.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">1418</span><small> lines of codes</small></div>
              <div><span class="metric">9</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">212.6</span><small> complexity/method</small></div>
              <div><span class="metric">42</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">1913.84</span><small> complexity</small></div>
              <div><span class="metric">826</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                34
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require_relative &#39;../spec_helper&#39;

describe &#39;links api&#39;, type: :integration do
  with_reset_sandbox_before_each

  def upload_links_release<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 15 nodes</span>              <span>Locations:</span>                  <a href="../../assets/upgrade/bosh-v264.8-c2b5bf268ea6420e4a3f1f657dc45b7db3720216/generate_sql_blobstore_dump_spec.html#L6" class="js-smell-location">0</a>                  <a href="errand/run_release_job_errand_spec.html#L3" class="js-smell-location">1</a>                  <a href="links/aliased_links_spec.html#L6" class="js-smell-location">2</a>                  <a href="links/broken_links_spec.html#L6" class="js-smell-location">3</a>                  <a href="links/consuming_and_providing_spec.html#L6" class="js-smell-location">4</a>                  <a href="links/cross_deployment_spec.html#L6" class="js-smell-location">5</a>                  <a href="links/export_release_spec.html#L6" class="js-smell-location">6</a>                  <a href="links/link_properties_spec.html#L6" class="js-smell-location">7</a>                  <a href="links/multiple_release_versions_spec.html#L6" class="js-smell-location">8</a>                  <a href="links/network_resolution_spec.html#L6" class="js-smell-location">9</a>                  <a href="links/optional_links_spec.html#L6" class="js-smell-location">10</a>                  <a href="links_api_spec.html#L6" class="js-smell-location">11</a>                  <a href="links_migrated_from_spec.html#L31" class="js-smell-location">12</a>                  <a href="links_spec.html#L6" class="js-smell-location">13</a>                  <a href="unmanaged_persistent_disks_spec.html#L3" class="js-smell-location">14</a>                  </div>  </li></ol>
    FileUtils.cp_r(LINKS_RELEASE_TEMPLATE, ClientSandbox.links_release_dir, preserve: true)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>upload_links_release calls 'ClientSandbox.links_release_dir' 3 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L7" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L8" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L9" class="js-smell-location">2</a>                  </div>  </li></ol>
    bosh_runner.run_in_dir(&#39;create-release --force&#39;, ClientSandbox.links_release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>upload_links_release calls 'ClientSandbox.links_release_dir' 3 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L7" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L8" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L9" class="js-smell-location">2</a>                  </div>  </li></ol>
    bosh_runner.run_in_dir(&#39;upload-release&#39;, ClientSandbox.links_release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>upload_links_release calls 'ClientSandbox.links_release_dir' 3 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L7" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L8" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L9" class="js-smell-location">2</a>                  </div>  </li></ol>
  end

  let(:manifest_hash) do
    Bosh::Spec::NewDeployments.manifest_with_release.merge(
      &#39;instance_groups&#39; =&gt; [instance_group],
      &#39;features&#39; =&gt; features
    )
  end

  let(:features) do
    {}
  end

  let(:instance_group) do
    {
      &#39;name&#39; =&gt; &#39;foobar&#39;,
      &#39;jobs&#39; =&gt; jobs,
      &#39;vm_type&#39; =&gt; &#39;a&#39;,
      &#39;stemcell&#39; =&gt; &#39;default&#39;,
      &#39;instances&#39; =&gt; 1,
      &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;a&#39; }],
      &#39;properties&#39; =&gt; {},
      &#39;persistent_disks&#39; =&gt; persistent_disks,
    }
  end

  let(:jobs) { [] }

  let(:persistent_disks) { [] }

  let(:cloud_config_hash) do
    Bosh::Spec::NewDeployments.simple_cloud_config.merge(
      &#39;disk_types&#39; =&gt; [
        {
          &#39;name&#39; =&gt; &#39;low-performance-disk-type&#39;,
          &#39;disk_size&#39; =&gt; 1024,
          &#39;cloud_properties&#39; =&gt; { &#39;type&#39; =&gt; &#39;gp2&#39; },
        },
        {
          &#39;name&#39; =&gt; &#39;high-performance-disk-type&#39;,
          &#39;disk_size&#39; =&gt; 4076,
          &#39;cloud_properties&#39; =&gt; { &#39;type&#39; =&gt; &#39;io1&#39; },
        },
      ],<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="config_server/config_server_cloud_config_spec.html#L84" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L53" class="js-smell-location">1</a>                  </div>  </li></ol>
    )
  end

  let(:explicit_provider_and_consumer) { [explicit_provider, explicit_consumer] }

  let(:explicit_provider) do
    {
      &#39;name&#39; =&gt; &#39;provider&#39;,
      &#39;provides&#39; =&gt; { &#39;provider&#39; =&gt; { &#39;as&#39; =&gt; &#39;foo&#39; } },
    }
  end

  let(:explicit_consumer) do
    {
      &#39;name&#39; =&gt; &#39;consumer&#39;,
      &#39;consumes&#39; =&gt; { &#39;provider&#39; =&gt; { &#39;from&#39; =&gt; &#39;foo&#39; } },
    }
  end

  let(:implicit_provider_and_consumer) do
    [
      { &#39;name&#39; =&gt; &#39;provider&#39; },
      { &#39;name&#39; =&gt; &#39;consumer&#39; },
    ]
  end

  let(:provider_response) do
    {
      &#39;id&#39; =&gt; String,
      &#39;name&#39; =&gt; &#39;provider&#39;,
      &#39;shared&#39; =&gt; false,
      &#39;deployment&#39; =&gt; &#39;simple&#39;,
      &#39;link_provider_definition&#39; =&gt; {
        &#39;name&#39; =&gt; &#39;provider&#39;,
        &#39;type&#39; =&gt; &#39;provider&#39;,
      },
      &#39;owner_object&#39; =&gt; {
        &#39;name&#39; =&gt; &#39;provider&#39;,
        &#39;type&#39; =&gt; &#39;job&#39;,
        &#39;info&#39; =&gt; {
          &#39;instance_group&#39; =&gt; &#39;foobar&#39;,
        },
      },
    }
  end

  def disk_provider_response(name)
    provider_response.merge(
      &#39;name&#39; =&gt; name,
      &#39;link_provider_definition&#39; =&gt; {
        &#39;name&#39; =&gt; name,
        &#39;type&#39; =&gt; &#39;disk&#39;,
      },
      &#39;owner_object&#39; =&gt; {
        &#39;name&#39; =&gt; &#39;foobar&#39;,
        &#39;type&#39; =&gt; &#39;disk&#39;,
        &#39;info&#39; =&gt; {
          &#39;instance_group&#39; =&gt; &#39;foobar&#39;,
        },
      },
    )
  end

  def consumer_response(job_name = &#39;consumer&#39;, link_name = &#39;provider&#39;)
    {
      &#39;id&#39; =&gt; String,
      &#39;name&#39; =&gt; link_name,
      &#39;optional&#39; =&gt; false,
      &#39;deployment&#39; =&gt; &#39;simple&#39;,
      &#39;owner_object&#39; =&gt; {
        &#39;name&#39; =&gt; job_name,
        &#39;type&#39; =&gt; &#39;job&#39;,
        &#39;info&#39; =&gt; {
          &#39;instance_group&#39; =&gt; &#39;foobar&#39;,
        },
      },
      &#39;link_consumer_definition&#39; =&gt; {
        &#39;name&#39; =&gt; link_name,
        &#39;type&#39; =&gt; link_name,
      },
    }
  end

  let(:links_response) do
    {
      &#39;id&#39; =&gt; &#39;1&#39;,
      &#39;name&#39; =&gt; &#39;provider&#39;,
      &#39;link_consumer_id&#39; =&gt; &#39;1&#39;,
      &#39;link_provider_id&#39; =&gt; &#39;1&#39;,
      &#39;created_at&#39; =&gt; String,
    }
  end

  def get(path, params)
    send_director_get_request(path, params)
  end

  def get_json(*args)
    JSON.parse get(*args).read_body
  end

  def get_link_providers
    get_json(&#39;/link_providers&#39;, &#39;deployment=simple&#39;)
  end

  def get_link_consumers
    get_json(&#39;/link_consumers&#39;, &#39;deployment=simple&#39;)
  end

  def get_links
    get_json(&#39;/links&#39;, &#39;deployment=simple&#39;)
  end

  before do
    upload_links_release
    upload_stemcell

    upload_cloud_config(cloud_config_hash: cloud_config_hash)
    deploy_simple_manifest(manifest_hash: manifest_hash)
  end

  def add_extra_networks_and_mark_default(cloud_config_hash, manifest_hash)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>add_extra_networks_and_mark_default doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
    new_network_b = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L176" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L962" class="js-smell-location">1</a>                  </div>  </li></ol>
      &#39;name&#39; =&gt; &#39;b&#39;,
      &#39;subnets&#39; =&gt; [{
                      &#39;range&#39; =&gt; &#39;10.0.0.0/24&#39;,
                      &#39;gateway&#39; =&gt; &#39;10.0.0.1&#39;,
                      &#39;dns&#39; =&gt; [&#39;10.0.0.1&#39;, &#39;10.0.0.2&#39;],
                      &#39;static&#39; =&gt; [&#39;10.0.0.10&#39;],
                      &#39;reserved&#39; =&gt; [],
                      &#39;cloud_properties&#39; =&gt; {},
                    }]
    }
    cloud_config_hash[&#39;networks&#39;].push(new_network_b)

    manifest_hash[&#39;instance_groups&#39;][0][&#39;networks&#39;][0][&#39;default&#39;] = [&#39;dns&#39;,&#39;gateway&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>add_extra_networks_and_mark_default calls 'manifest_hash['instance_groups']' 2 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L189" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L190" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>add_extra_networks_and_mark_default calls 'manifest_hash['instance_groups'][0]' 2 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L189" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L190" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>add_extra_networks_and_mark_default calls 'manifest_hash['instance_groups'][0]['networks']' 2 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L189" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L190" class="js-smell-location">1</a>                  </div>  </li></ol>
    manifest_hash[&#39;instance_groups&#39;][0][&#39;networks&#39;].push({&#39;name&#39; =&gt; new_network_b[&#39;name&#39;]})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>add_extra_networks_and_mark_default calls 'manifest_hash['instance_groups']' 2 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L189" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L190" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>add_extra_networks_and_mark_default calls 'manifest_hash['instance_groups'][0]' 2 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L189" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L190" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>add_extra_networks_and_mark_default calls 'manifest_hash['instance_groups'][0]['networks']' 2 times</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L189" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L190" class="js-smell-location">1</a>                  </div>  </li></ol>
  end

  context &#39;when requesting for a list of providers via link_providers endpoint&#39; do
    context &#39;when deployment has an implicit link provider&#39; do
      let(:jobs) { [{ &#39;name&#39; =&gt; &#39;provider&#39; }] }

      it &#39;should return the correct number of providers&#39; do
        expected_response = [provider_response]

        expect(get_link_providers).to match_array(expected_response)
      end
    end

    context &#39;when deployment has an explicit link provider&#39; do
      let(:jobs) { [explicit_provider] }

      it &#39;should return the correct number of providers&#39; do
        expected_response = [provider_response.merge(&#39;name&#39; =&gt; &#39;foo&#39;)]

        expect(get_link_providers).to match_array(expected_response)
      end

      context &#39;and the provider is shared&#39; do
        let(:jobs) do
          [
            {
              &#39;name&#39; =&gt; &#39;provider&#39;,
              &#39;provides&#39; =&gt; {
                &#39;provider&#39; =&gt; {
                  &#39;as&#39; =&gt; &#39;foo&#39;,
                  &#39;shared&#39; =&gt; true,
                },
              },
            },
          ]
        end

        it &#39;should set the `shared` key to true&#39; do
          expected_response = [provider_response.merge(&#39;name&#39; =&gt; &#39;foo&#39;, &#39;shared&#39; =&gt; true)]

          expect(get_link_providers).to match_array(expected_response)
        end
      end

      context &#39;then redeploying with a new alias&#39; do
        let(:updated_manifest_hash) do
          manifest_hash.tap do |mh|
            mh[&#39;instance_groups&#39;][0][&#39;jobs&#39;][0][&#39;provides&#39;][&#39;provider&#39;][&#39;as&#39;] = &#39;bar&#39;
          end
        end

        before do
          deploy_simple_manifest(manifest_hash: updated_manifest_hash)
        end

        it &#39;should return the original provider with updated information&#39; do
          expected_response = [provider_response.merge(&#39;id&#39; =&gt; &#39;1&#39;, &#39;name&#39; =&gt; &#39;bar&#39;)]

          expect(get_link_providers).to match_array(expected_response)
        end
      end
    end

    context &#39;when deployment has a custom provider definition&#39; do
      let(:jobs) do
        [
          {
            &#39;name&#39; =&gt; &#39;api_server_with_optional_db_link&#39;,
            &#39;provides&#39; =&gt; {&#39;smurf&#39; =&gt; {&#39;shared&#39; =&gt; true}},
            &#39;custom_provider_definitions&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;smurf&#39;,
                &#39;type&#39; =&gt; &#39;gargamel&#39;,
              }
            ]
          },
        ]
      end

      it &#39;should create a provider&#39; do
        expected_response = [
          {
            &#39;id&#39; =&gt; String,
            &#39;name&#39; =&gt; &#39;smurf&#39;,
            &#39;shared&#39; =&gt; true,
            &#39;deployment&#39; =&gt; &#39;simple&#39;,
            &#39;link_provider_definition&#39; =&gt; {
              &#39;name&#39; =&gt; &#39;smurf&#39;,
              &#39;type&#39; =&gt; &#39;gargamel&#39;,
            },
            &#39;owner_object&#39; =&gt; {
              &#39;name&#39; =&gt; &#39;api_server_with_optional_db_link&#39;,
              &#39;type&#39; =&gt; &#39;job&#39;,
              &#39;info&#39; =&gt; {
                &#39;instance_group&#39; =&gt; &#39;foobar&#39;,
              },
            },
          }
        ]

        expect(get_link_providers).to match_array(expected_response)
      end
    end

    context &#39;when deployment has a disk link provider&#39; do
      let(:persistent_disks) do
        [low_iops_persistent_disk, high_iops_persistent_disk]
      end

      let(:low_iops_persistent_disk) do
        {
          &#39;type&#39; =&gt; &#39;low-performance-disk-type&#39;,
          &#39;name&#39; =&gt; &#39;low-iops-persistent-disk-name&#39;,
        }
      end

      let(:high_iops_persistent_disk) do
        {
          &#39;type&#39; =&gt; &#39;high-performance-disk-type&#39;,
          &#39;name&#39; =&gt; &#39;high-iops-persistent-disk-name&#39;,
        }
      end

      it &#39;should return the disk providers&#39; do
        expected_response = [
          disk_provider_response(&#39;low-iops-persistent-disk-name&#39;),
          disk_provider_response(&#39;high-iops-persistent-disk-name&#39;),
        ]

        expect(get_link_providers).to match_array(expected_response)
      end
    end

    context &#39;when deployment has multiple providers with the same name&#39; do
      let(:persistent_disks) do
        [
          {
            &#39;type&#39; =&gt; &#39;low-performance-disk-type&#39;,
            &#39;name&#39; =&gt; &#39;provider&#39;,
          },
        ]
      end

      let(:jobs) do
        [
          { &#39;name&#39; =&gt; &#39;provider&#39; },
          {
            &#39;name&#39; =&gt; &#39;alternate_provider&#39;,
            &#39;provides&#39; =&gt; { &#39;provider&#39; =&gt; { &#39;as&#39; =&gt; &#39;provider&#39; } },
          },
        ]
      end

      it &#39;should return all providers&#39; do
        expected_response = [
          provider_response,
          provider_response.deep_merge(
            &#39;owner_object&#39; =&gt; {
              &#39;name&#39; =&gt; &#39;alternate_provider&#39;,
              &#39;info&#39; =&gt; {
                &#39;instance_group&#39; =&gt; &#39;foobar&#39;,
              },
            },
          ),
          disk_provider_response(&#39;provider&#39;),
        ]

        expect(get_link_providers).to match_array(expected_response)
      end
    end

    context &#39;when deployment does not have a link provider&#39; do
      it &#39;should return an empty list of providers&#39; do
        expected_response = []

        expect(get_link_providers).to match_array(expected_response)
      end
    end

    context &#39;when deployment is not specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L370" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L437" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L655" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &#39;should raise an error&#39; do
        actual_response = get_json(&#39;/link_providers&#39;, &#39;&#39;)

        expected_error = Bosh::Director::DeploymentRequired.new(&#39;Deployment name is required&#39;)
        expected_response = {
          &#39;code&#39; =&gt; expected_error.error_code,
          &#39;description&#39; =&gt; expected_error.message,
        }

        expect(actual_response).to match(expected_response)
      end
    end

    context &#39;when user does not have sufficient permissions&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L384" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L451" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L669" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &#39;should raise an error&#39; do
        response = send_director_get_request(&#39;/link_providers&#39;, &#39;deployment=simple&#39;, {})

        expect(response.read_body).to include(&quot;Not authorized: &#39;/link_providers&#39;&quot;)
      end
    end
  end

  context &#39;when requesting for a list of consumers via link_consumers endpoint&#39; do
    context &#39;when a job has a link consumer&#39; do
      let(:jobs) { implicit_provider_and_consumer }

      it &#39;should return the correct number of consumers&#39; do
        expected_response = [consumer_response]

        expect(get_link_consumers).to match_array(expected_response)
      end

      context &#39;and the consumer is optional&#39; do
        let(:jobs) { [{ &#39;name&#39; =&gt; &#39;api_server_with_optional_db_link&#39; }] }

        it &#39;should still create a consumer&#39; do
          expected_response = [consumer_response(&#39;api_server_with_optional_db_link&#39;, &#39;db&#39;).merge(&#39;optional&#39; =&gt; true)]

          expect(get_link_consumers).to match_array(expected_response)
        end
      end

      context &#39;when the link is provided by a new provider&#39; do
        let(:updated_manifest_hash) do
          manifest_hash.tap do |mh|
            mh[&#39;instance_groups&#39;][0][&#39;jobs&#39;][0][&#39;name&#39;] = &#39;alternate_provider&#39;
          end
        end

        it &#39;should reuse the same consumers&#39; do
          expected_response = get_link_consumers

          deploy_simple_manifest(manifest_hash: updated_manifest_hash)

          actual_response = get_link_consumers
          expect(actual_response).to match_array(expected_response)
        end
      end
    end

    context &#39;when deployment does not have a link consumer&#39; do
      it &#39;should return an empty list of consumers&#39; do
        expect(get_link_consumers).to be_empty
      end
    end

    context &#39;when deployment is not specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L370" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L437" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L655" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &#39;should raise an error&#39; do
        actual_response = get_json(&#39;/link_consumers&#39;, &#39;&#39;)

        expected_error = Bosh::Director::DeploymentRequired.new(&#39;Deployment name is required&#39;)
        expected_response = {
          &#39;code&#39; =&gt; expected_error.error_code,
          &#39;description&#39; =&gt; expected_error.message,
        }

        expect(actual_response).to match(expected_response)
      end
    end

    context &#39;when user does not have sufficient permissions&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L384" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L451" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L669" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &#39;should raise an error&#39; do
        response = send_director_get_request(&#39;/link_consumers&#39;, &#39;deployment=simple&#39;, {})

        expect(response.read_body).to include(&quot;Not authorized: &#39;/link_consumers&#39;&quot;)
      end
    end
  end

  context &#39;when requesting for a list of links via links endpoint&#39; do
    context &#39;when deployment has an implicit provider + consumer&#39; do
      let(:jobs) { implicit_provider_and_consumer }

      it &#39;should return the correct number of links&#39; do
        deploy_simple_manifest(manifest_hash: manifest_hash)

        expected_response = [links_response]

        expect(get_links).to match_array(expected_response)
      end
    end

    context &#39;when deployment has an explicit provider + consumer&#39; do
      let(:jobs) { explicit_provider_and_consumer }

      it &#39;should return the correct number of links&#39; do
        expected_response = [links_response]

        expect(get_links).to match_array(expected_response)
      end

      context &#39;and the provider is shared&#39; do
        let(:jobs) do
          [
            {
              &#39;name&#39; =&gt; &#39;provider&#39;,
              &#39;provides&#39; =&gt; {
                &#39;provider&#39; =&gt; {
                  &#39;as&#39; =&gt; &#39;foo&#39;,
                  &#39;shared&#39; =&gt; true,
                },
              },
            },
          ]
        end

        let(:consumer_manifest_hash) do
          Bosh::Spec::NewDeployments.manifest_with_release.merge(
            &#39;name&#39; =&gt; &#39;consumer-simple&#39;,
            &#39;instance_groups&#39; =&gt; [consumer_instance_group],
          )
        end

        let(:consumer_instance_group) do
          {
            &#39;name&#39; =&gt; &#39;foobar&#39;,
            &#39;jobs&#39; =&gt; [
              {
                &#39;name&#39; =&gt; &#39;consumer&#39;,
                &#39;consumes&#39; =&gt; {
                  &#39;provider&#39; =&gt; {
                    &#39;from&#39; =&gt; &#39;foo&#39;,
                    &#39;deployment&#39; =&gt; &#39;simple&#39;,
                  },
                },
              },
            ],
            &#39;vm_type&#39; =&gt; &#39;a&#39;,
            &#39;stemcell&#39; =&gt; &#39;default&#39;,
            &#39;instances&#39; =&gt; 1,
            &#39;networks&#39; =&gt; [{ &#39;name&#39; =&gt; &#39;a&#39; }],
            &#39;properties&#39; =&gt; {},
          }
        end

        it &#39;should create a link for the cross deployment link&#39; do
          deploy_simple_manifest(manifest_hash: consumer_manifest_hash)

          actual_response = get_json(&#39;/links&#39;, &#39;deployment=consumer-simple&#39;)
          expected_response = [links_response]

          expect(actual_response).to match_array(expected_response)
        end

        context &#39;when the shared provider is removed&#39; do
          before do
            deploy_simple_manifest(manifest_hash: consumer_manifest_hash)

            manifest_hash[&#39;instance_groups&#39;][0][&#39;jobs&#39;] = []
            deploy_simple_manifest(manifest_hash: manifest_hash)
            links_response[&#39;link_provider_id&#39;] = nil
          end

          it &#39;should become an orphaned link (with no provider)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L544" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L560" class="js-smell-location">1</a>                  </div>  </li></ol>
            actual_response = get_json(&#39;/links&#39;, &#39;deployment=consumer-simple&#39;)
            expected_response = [links_response]

            expect(actual_response).to match_array(expected_response)
          end
        end

        context &#39;when the shared provider deployment is removed&#39; do
          before do
            deploy_simple_manifest(manifest_hash: consumer_manifest_hash)

            bosh_runner.run(&#39;delete-deployment&#39;, deployment_name: &#39;simple&#39;)
            links_response[&#39;link_provider_id&#39;] = nil
          end

          it &#39;should become an orphaned link (with no provider)&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L544" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L560" class="js-smell-location">1</a>                  </div>  </li></ol>
            actual_response = get_json(&#39;/links&#39;, &#39;deployment=consumer-simple&#39;)
            expected_response = [links_response]

            expect(actual_response).to match_array(expected_response)
          end
        end

        context &#39;when the consumer is removed&#39; do
          before do
            deploy_simple_manifest(manifest_hash: consumer_manifest_hash)

            consumer_manifest_hash[&#39;instance_groups&#39;][0][&#39;jobs&#39;] = []
            deploy_simple_manifest(manifest_hash: consumer_manifest_hash)
          end

          it &#39;should remove the link&#39; do
            actual_response = get_json(&#39;/links&#39;, &#39;deployment=consumer-simple&#39;)
            expected_response = []
            expect(actual_response).to match_array(expected_response)
          end
        end
      end
    end

    context &#39;when deployment consuming manual link&#39; do
      let(:jobs) do
        [
          {
            &#39;name&#39; =&gt; &#39;consumer&#39;,
            &#39;consumes&#39; =&gt; {
              &#39;provider&#39; =&gt; {
                &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;teswfbquts.cabsfabuo7yr.us-east-1.rds.amazonaws.com&#39; }],
                &#39;properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;bar&#39;, &#39;c&#39; =&gt; &#39;bazz&#39; },
              },
            },
          },
        ]
      end

      it &#39;should return a single orphaned link&#39; do
        expected_response = [links_response.merge(&#39;link_provider_id&#39; =&gt; String)]
        expect(get_links).to match_array(expected_response)
      end
    end

    context &#39;when the deployment consumes a disk provider&#39; do
      let(:persistent_disks) do
        [low_iops_persistent_disk, high_iops_persistent_disk]
      end

      let(:low_iops_persistent_disk) do
        {
          &#39;type&#39; =&gt; &#39;low-performance-disk-type&#39;,
          &#39;name&#39; =&gt; &#39;low-iops-persistent-disk-name&#39;,
        }
      end

      let(:high_iops_persistent_disk) do
        {
          &#39;type&#39; =&gt; &#39;high-performance-disk-type&#39;,
          &#39;name&#39; =&gt; &#39;high-iops-persistent-disk-name&#39;,
        }
      end

      let(:jobs) do
        [
          {
            &#39;name&#39; =&gt; &#39;disk_consumer&#39;,
            &#39;consumes&#39; =&gt; {
              &#39;disk_provider&#39; =&gt; { &#39;from&#39; =&gt; &#39;low-iops-persistent-disk-name&#39; },
              &#39;backup_disk_provider&#39; =&gt; { &#39;from&#39; =&gt; &#39;high-iops-persistent-disk-name&#39; },
            },
          },
        ]
      end

      it &#39;should have one link for each disk being consumed&#39; do
        expected_response = [
          links_response.merge(
            &#39;id&#39; =&gt; String,
            &#39;name&#39; =&gt; &#39;disk_provider&#39;,
            &#39;link_provider_id&#39; =&gt; &#39;1&#39;,
          ),
          links_response.merge(
            &#39;id&#39; =&gt; String,
            &#39;name&#39; =&gt; &#39;backup_disk_provider&#39;,
            &#39;link_consumer_id&#39; =&gt; &#39;2&#39;,
            &#39;link_provider_id&#39; =&gt; &#39;2&#39;,
          ),
        ]
        expect(get_links).to match_array(expected_response)
      end
    end

    context &#39;when deployment is not specified&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L370" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L437" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L655" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &#39;should raise an error&#39; do
        actual_response = get_json(&#39;/links&#39;, &#39;&#39;)

        expected_error = Bosh::Director::DeploymentRequired.new(&#39;Deployment name is required&#39;)
        expected_response = {
          &#39;code&#39; =&gt; expected_error.error_code,
          &#39;description&#39; =&gt; expected_error.message,
        }

        expect(actual_response).to match(expected_response)
      end
    end

    context &#39;when user does not have sufficient permissions&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L384" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L451" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L669" class="js-smell-location">2</a>                  </div>  </li></ol>
      it &#39;should raise an error&#39; do
        response = send_director_get_request(&#39;/links&#39;, &#39;deployment=simple&#39;, {})

        expect(response.read_body).to include(&quot;Not authorized: &#39;/links&#39;&quot;)
      end
    end

    context &#39;when consumer is removed from deployment&#39; do
      let(:jobs) { explicit_provider_and_consumer }

      it &#39;should remove consumer data from link_consumer&#39; do
        manifest_hash[&#39;instance_groups&#39;][0][&#39;jobs&#39;].pop
        deploy_simple_manifest(manifest_hash: manifest_hash)

        expect(get_links).to be_empty
      end
    end

    context &#39;when deployment has a custom provider definition&#39; do
      context &#39;when definition satisfies a consumer&#39; do
        let(:jobs) do
          [
            {
              &#39;name&#39; =&gt; &#39;api_server_with_optional_db_link&#39;,
              &#39;custom_provider_definitions&#39; =&gt; [
                {
                  &#39;name&#39; =&gt; &#39;smurf&#39;,
                  &#39;type&#39; =&gt; &#39;db&#39;,
                }
              ]
            },
          ]
        end

        it &#39;should create a link&#39; do
          expected_response = [
            {
              &#39;id&#39; =&gt; &#39;1&#39;,
              &#39;name&#39; =&gt; &#39;db&#39;,
              &#39;link_consumer_id&#39; =&gt; &#39;1&#39;,
              &#39;link_provider_id&#39; =&gt; &#39;1&#39;,
              &#39;created_at&#39; =&gt; String,
            }
          ]

          expect(get_links).to match_array(expected_response)
        end
      end
    end
  end

  context &#39;when deployment which consumes and provides links already exist&#39; do
    let(:jobs) { explicit_provider_and_consumer }

    before do
      @expected_providers = get_link_providers
      @expected_consumers = get_link_consumers
      @expected_links = get_links
    end

    context &#39;redeploying no changes&#39; do
      before do
        deploy_simple_manifest(manifest_hash: manifest_hash)
      end

      it &#39;should use the same provider&#39; do
        expect(get_link_providers).to match_array(@expected_providers)
      end

      it &#39;should use the same consumer&#39; do
        expect(get_link_consumers).to match_array(@expected_consumers)
      end

      it &#39;should not create a new link&#39; do
        expect(get_links).to match_array(@expected_links)
      end
    end

    context &#39;recreating deployment&#39; do
      before do
        bosh_runner.run(&#39;recreate&#39;, deployment_name: &#39;simple&#39;)
      end

      it &#39;should use the same provider&#39; do
        expect(get_link_providers).to match_array(@expected_providers)
      end

      it &#39;should use the same consumer&#39; do
        expect(get_link_consumers).to match_array(@expected_consumers)
      end

      it &#39;should not create a new link&#39; do
        expect(get_links).to match_array(@expected_links)
      end
    end

    context &#39;when redeploying with change to provider&#39; do
      let(:new_jobs) do
        [
          {
            &#39;name&#39; =&gt; &#39;provider&#39;,
            &#39;provides&#39; =&gt; { &#39;provider&#39; =&gt; { &#39;as&#39; =&gt; &#39;bar&#39; } },
          },
          {
            &#39;name&#39; =&gt; &#39;consumer&#39;,
            &#39;consumes&#39; =&gt; { &#39;provider&#39; =&gt; { &#39;from&#39; =&gt; &#39;bar&#39; } },
          },
        ]
      end

      it &#39;should reuse the old links&#39; do
        manifest_hash[&#39;instance_groups&#39;][0][&#39;jobs&#39;] = new_jobs

        deploy_simple_manifest(manifest_hash: manifest_hash)

        expected_response = [links_response]
        expect(get_links).to match_array(expected_response)
      end
    end

    context &#39;when redeploying with change to provider instances&#39; do
      it &#39;should remove the old link and make a new one&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when deployment which consumes and provides links already exist)::context(when redeploying with change to provider instances)::it#should remove the old link and make a new one has a flog score of 26</span>          </div>  </li></ol>
        manifest_hash[&#39;instance_groups&#39;][0][&#39;instances&#39;] = 2

        deploy_simple_manifest(manifest_hash: manifest_hash)

        links = get_links
        expect(links.count).to eq(1)
        expect(links.first[&#39;id&#39;]).to eq(&#39;2&#39;)
      end
    end
  end

  context &#39;when doing POST request to create link&#39; do
    before do
      add_extra_networks_and_mark_default(cloud_config_hash, manifest_hash)
      upload_cloud_config(cloud_config_hash: cloud_config_hash)
      deploy_simple_manifest(manifest_hash: manifest_hash)
    end

    context &#39;when correct json is provided&#39; do
      let(:provider_id) { &#39;1&#39; }
      let(:payload_json) do
        {
          &#39;link_provider_id&#39; =&gt; provider_id,
          &#39;link_consumer&#39; =&gt; {
            &#39;owner_object&#39; =&gt; {
              &#39;name&#39; =&gt; &#39;external_consumer_1&#39;,
              &#39;type&#39; =&gt; &#39;external&#39;,
            },
          },
        }
      end
      let(:jobs) do
        [
          {
            &#39;name&#39; =&gt; &#39;provider&#39;,
            &#39;provides&#39; =&gt; {
              &#39;provider&#39; =&gt; {
                &#39;as&#39; =&gt; &#39;foo&#39;,
                &#39;shared&#39; =&gt; true,
              },
            },
          },
        ]
      end

      context &#39;when provider already exists&#39; do
        before do
          provider_response = get_link_providers
          provider_id = provider_response.first[&#39;id&#39;]
        end

        it &#39;provide link json output&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::it#provide link json output has a flog score of 33</span>          </div>  </li></ol>
          response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
          link = JSON.parse(response.read_body)

          expect(link[&#39;name&#39;]).to eq(jobs[0][&#39;name&#39;])
          expect(link[&#39;link_provider_id&#39;]).to eq(provider_id)
        end

        it &#39;create consumer_intent&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::it#create consumer_intent has a flog score of 51</span>          </div>  </li></ol>
          send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
          response = get_link_consumers

          expect(response.count).to_not eq(0)
          consumer = response[0]
          expect(consumer[&#39;deployment&#39;]).to eq(&#39;simple&#39;)
          expect(consumer[&#39;name&#39;]).to eq(&#39;foo&#39;)
          expect(consumer[&#39;owner_object&#39;][&#39;type&#39;]).to eq(&#39;external&#39;)
          expect(consumer[&#39;owner_object&#39;][&#39;info&#39;]).to be_nil
        end

        it &#39;keeps the consumer and link after redeploy&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::it#keeps the consumer and link after redeploy has a flog score of 41</span>          </div>  </li></ol>
          send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
          response = get_link_consumers

          deploy_simple_manifest(manifest_hash: manifest_hash)
          response2 = get_link_consumers

          expect(response.count).to eq(response2.count)
          consumer = response2[0]
          expect(consumer[&#39;deployment&#39;]).to eq(&#39;simple&#39;)
          expect(consumer[&#39;owner_object&#39;][&#39;type&#39;]).to eq(&#39;external&#39;)
        end

        context &#39;when provider does not change during re-deploy&#39; do
          context &#39;when multiple requests have same owner_object and provider_id&#39; do
            before do
              first_response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
              @link_1 = JSON.parse(first_response.read_body)
            end

            context &#39;when requesting link with same request parameters again&#39; do
              it &#39;should NOT create new link&#39; do
                second_response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))
                link_2 = JSON.parse(second_response.read_body)

                expect(link_2).to eq(@link_1)
              end
            end

            context &#39;when requesting link with different request parameters&#39; do
              before do
                payload_json[&#39;network&#39;] = &#39;b&#39;
              end

              it &#39;should create new link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L897" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L921" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L942" class="js-smell-location">2</a>                  </div>  </li></ol>
                second_response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))
                link_2 = JSON.parse(second_response.read_body)

                expect(link_2[&#39;id&#39;]).to_not eq(@link_1[&#39;id&#39;])
              end
            end
          end
        end

        context &#39;when provider content changes during re-deploy&#39; do
          context &#39;when multiple request have same owner_object and provider_id before and after re-deploy&#39; do
            before do
              first_response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))
              @link_1 = JSON.parse(first_response.read_body)
            end

            context &#39;when provider number of instances changes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider content changes during re-deploy)::context(when multiple request have same owner_object and provider_id before and after re-deploy)::context#when provider number of instances changes has a flog score of 26</span>          </div>  </li></ol>
              before do
                # re-deploy with provider content changes
                manifest_hash[&#39;instance_groups&#39;][0][&#39;instances&#39;] = manifest_hash[&#39;instance_groups&#39;][0][&#39;instances&#39;] + 1
                deploy_simple_manifest(manifest_hash: manifest_hash)
              end

              it &#39;should create new link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L897" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L921" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L942" class="js-smell-location">2</a>                  </div>  </li></ol>
                second_response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))
                link_2 = JSON.parse(second_response.read_body)

                expect(link_2[&#39;id&#39;]).to_not eq(@link_1[&#39;id&#39;])
              end
            end

            context &#39;when provider properties change&#39; do
              before do
                updated_properties = {
                  &#39;nested&#39; =&gt; {
                    &#39;one&#39; =&gt; &#39;updated-nested-property&#39;,
                    &#39;two&#39; =&gt; &#39;another-updated-nested-property&#39;,
                  },
                }
                manifest_hash[&#39;instance_groups&#39;][0][&#39;properties&#39;] = updated_properties
                # re-deploy with provider content changes
                deploy_simple_manifest(manifest_hash: manifest_hash)
              end

              it &#39;should create new link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 3 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L897" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L921" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L942" class="js-smell-location">2</a>                  </div>  </li></ol>
                second_response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))
                link_2 = JSON.parse(second_response.read_body)

                expect(link_2[&#39;id&#39;]).to_not eq(@link_1[&#39;id&#39;])
              end
            end

            context &#39;when provider networks change&#39; do
              before do
                provider_response = get_link_providers
                provider_id = provider_response.first[&#39;id&#39;]

                response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))
                @before_deploy_link = JSON.parse(response.read_body)
              end

              context &#39;default network stays the same&#39; do
                context &#39;new network added to cloud config and deployment&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider content changes during re-deploy)::context(when multiple request have same owner_object and provider_id before and after re-deploy)::context(when provider networks change)::context(default network stays the same)::context#new network added to cloud config and deployment has a flog score of 33</span>          </div>  </li></ol>
                  before do
                    new_network_c = {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L176" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L962" class="js-smell-location">1</a>                  </div>  </li></ol>
                      &#39;name&#39; =&gt; &#39;c&#39;,
                      &#39;subnets&#39; =&gt; [{
                                      &#39;range&#39; =&gt; &#39;10.1.0.0/24&#39;,
                                      &#39;gateway&#39; =&gt; &#39;10.1.0.1&#39;,
                                      &#39;dns&#39; =&gt; [&#39;10.1.0.1&#39;, &#39;10.1.0.2&#39;],
                                      &#39;static&#39; =&gt; [&#39;10.1.0.10&#39;],
                                      &#39;reserved&#39; =&gt; [],
                                      &#39;cloud_properties&#39; =&gt; {},
                                    }]
                    }
                    cloud_config_hash[&#39;networks&#39;].push(new_network_c)
                    upload_cloud_config(cloud_config_hash: cloud_config_hash)

                    manifest_hash[&#39;instance_groups&#39;][0][&#39;networks&#39;].push({&#39;name&#39; =&gt; new_network_c[&#39;name&#39;]})
                    # re-deploy with provider content changes
                    deploy_simple_manifest(manifest_hash: manifest_hash)
                  end

                  it &#39;creates new link using existing consumer for external link request for new network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider content changes during re-deploy)::context(when multiple request have same owner_object and provider_id before and after re-deploy)::context(when provider networks change)::context(default network stays the same)::context(new network added to cloud config and deployment)::it#creates new link using existing consumer for external link request for new network has a flog score of 44</span>          </div>  </li></ol>
                    payload_json[&#39;network&#39;] = &#39;c&#39;
                    response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))

                    expect(response.code).to eq(&#39;200&#39;)

                    after_deploy_link = JSON.parse(response.read_body)
                    expect(after_deploy_link[&#39;id&#39;]).to_not eq(@before_deploy_link[&#39;id&#39;])
                    expect(after_deploy_link[&#39;link_consumer_id&#39;]).to eq(@before_deploy_link[&#39;link_consumer_id&#39;])
                  end

                  it &#39;creates new link using existing consumer for external link request for existing network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider content changes during re-deploy)::context(when multiple request have same owner_object and provider_id before and after re-deploy)::context(when provider networks change)::context(default network stays the same)::context(new network added to cloud config and deployment)::it#creates new link using existing consumer for external link request for existing network has a flog score of 44</span>          </div>  </li></ol>
                    payload_json[&#39;network&#39;] = &#39;a&#39;
                    response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))

                    expect(response.code).to eq(&#39;200&#39;)

                    after_deploy_link = JSON.parse(response.read_body)
                    expect(after_deploy_link[&#39;id&#39;]).to_not eq(@before_deploy_link[&#39;id&#39;])
                    expect(after_deploy_link[&#39;link_consumer_id&#39;]).to eq(@before_deploy_link[&#39;link_consumer_id&#39;])
                  end
                end
              end

              context &#39;default network changes&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider content changes during re-deploy)::context(when multiple request have same owner_object and provider_id before and after re-deploy)::context(when provider networks change)::context#default network changes has a flog score of 27</span>          </div>  </li></ol>
                before do
                  manifest_hash[&#39;instance_groups&#39;][0][&#39;networks&#39;][0] = {&#39;name&#39; =&gt; &#39;a&#39;}
                  manifest_hash[&#39;instance_groups&#39;][0][&#39;networks&#39;][1] = {&#39;name&#39; =&gt; &#39;b&#39;, &#39;default&#39; =&gt; [&#39;dns&#39;,&#39;gateway&#39;]}
                  deploy_simple_manifest(manifest_hash: manifest_hash)
                end

                context &#39;requesting external link for new network&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1012" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1039" class="js-smell-location">1</a>                  </div>  </li></ol>
                  it &#39;creates new link and uses same consumer record&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider content changes during re-deploy)::context(when multiple request have same owner_object and provider_id before and after re-deploy)::context(when provider networks change)::context(default network changes)::context(requesting external link for new network)::it#creates new link and uses same consumer record has a flog score of 44</span>          </div>  </li></ol>
                    payload_json[&#39;network&#39;] = &#39;b&#39;
                    response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))

                    expect(response.code).to eq(&#39;200&#39;)

                    after_deploy_link = JSON.parse(response.read_body)
                    expect(after_deploy_link[&#39;id&#39;]).to_not eq(@before_deploy_link[&#39;id&#39;])
                    expect(after_deploy_link[&#39;link_consumer_id&#39;]).to eq(@before_deploy_link[&#39;link_consumer_id&#39;])
                  end
                end

                context &#39;requesting external link for old network&#39; do
                  before do
                    # requesting for same network &#39;a&#39;, which id default network
                    payload_json[&#39;network&#39;]=&#39;a&#39;
                    response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))

                    @old_network_link = JSON.parse(response.read_body)
                  end

                  it &#39;should not create new link with existing consumer&#39; do
                    expect(@old_network_link[&#39;id&#39;]).to eq(@before_deploy_link[&#39;id&#39;])
                    expect(@old_network_link[&#39;link_consumer_id&#39;]).to eq(@before_deploy_link[&#39;link_consumer_id&#39;])
                  end

                  context &#39;requesting external link for old network again&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1012" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1039" class="js-smell-location">1</a>                  </div>  </li></ol>
                    it &#39;returns previously created link&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider content changes during re-deploy)::context(when multiple request have same owner_object and provider_id before and after re-deploy)::context(when provider networks change)::context(default network changes)::context(requesting external link for old network)::context(requesting external link for old network again)::it#returns previously created link has a flog score of 46</span>          </div>  </li></ol>
                      payload_json[&#39;network&#39;]=&#39;a&#39;
                      response = send_director_post_request(&quot;/links&quot;, &#39;&#39;, JSON.generate(payload_json))

                      expect(response.code).to eq(&#39;200&#39;)

                      after_deploy_link = JSON.parse(response.read_body)
                      expect(after_deploy_link[&#39;id&#39;]).to eq(@old_network_link[&#39;id&#39;])
                      expect(after_deploy_link[&#39;link_consumer_id&#39;]).to eq(@old_network_link[&#39;link_consumer_id&#39;])
                    end
                  end
                end
              end
            end
          end
        end

        context &#39;when provider is NOT shared&#39; do
          let(:jobs) do
            [
              {
                &#39;name&#39; =&gt; &#39;provider&#39;,
                &#39;provides&#39; =&gt; {
                  &#39;provider&#39; =&gt; {
                    &#39;as&#39; =&gt; &#39;foo&#39;,
                    &#39;shared&#39; =&gt; false,
                  },
                },
              },
            ]
          end
          it &#39;should returns error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when provider is NOT shared)::it#should returns error has a flog score of 31</span>          </div>  </li></ol>
            response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
            error_response = JSON.parse(response.read_body)
            expect(error_response[&#39;code&#39;]).to eq(Bosh::Director::LinkProviderNotSharedError.new.error_code)
            expect(error_response[&#39;description&#39;]).to eq(&quot;Provider not `shared`&quot;)
          end
        end

        context &#39;when attempting to create the link a second time&#39; do
          before do
            response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body
            @link1 = JSON.parse(response)
          end

          it &#39;should return the existing link&#39; do
            response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body
            link2 = JSON.parse(response)
            expect(@link1).to eq(link2)
          end
        end

        context &#39;when multiple provider with same name and type exists&#39; do
          before do
            new_instance_group = Bosh::Spec::NewDeployments.simple_instance_group(
              name: &#39;new-foobar&#39;,
              jobs: jobs,
            )
            manifest_hash[&#39;instance_groups&#39;] &lt;&lt; new_instance_group
            puts &quot;Manifest: #{manifest_hash.pretty_inspect}&quot;
            deploy_simple_manifest(manifest_hash: manifest_hash)
          end

          it &#39;should create link with correct provider&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when provider already exists)::context(when multiple provider with same name and type exists)::it#should create link with correct provider has a flog score of 45</span>          </div>  </li></ol>
            all_providers = get_link_providers
            expect(all_providers.count).to eq(2)

            response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
            link = JSON.parse(response.read_body)

            expect(link[&#39;name&#39;]).to eq(jobs[0][&#39;name&#39;])
            expect(link[&#39;link_provider_id&#39;]).to eq(provider_id)
          end
        end
      end

      context &#39;when link_provider_id do not exists&#39; do
        let(:provider_id) { &#39;42&#39; }

        it &#39;returns error&#39; do
          response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
          error_response = JSON.parse(response.read_body)
          expect(error_response[&#39;description&#39;]).to eq(&quot;Invalid link_provider_id: #{provider_id}&quot;)
        end
      end

      context &#39;when link_provider_id is invalid&#39; do
        let(:provider_id) { &#39;&#39; }
        it &#39;returns error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1128" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1148" class="js-smell-location">1</a>                  </div>  </li></ol>
          response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
          error_response = JSON.parse(response.read_body)
          expect(error_response[&#39;description&#39;]).to eq(&#39;Invalid request: `link_provider_id` must be provided&#39;)
        end
      end

      context &#39;when owner_object.name is invalid&#39; do
        let(:payload_json) do
          {
            &#39;link_provider_id&#39; =&gt; provider_id,
            &#39;link_consumer&#39; =&gt; {
              &#39;owner_object&#39; =&gt; {
                &#39;name&#39; =&gt; &#39;&#39;,
                &#39;type&#39; =&gt; &#39;external&#39;,
              },
            },
          }
        end

        it &#39;returns error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1128" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1148" class="js-smell-location">1</a>                  </div>  </li></ol>
          response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
          error_response = JSON.parse(response.read_body)
          expect(error_response[&#39;description&#39;]).to eq(&#39;Invalid request: `link_consumer.owner_object.name` must not be empty&#39;)
        end
      end

      context &#39;when network name is provided&#39; do
        let(:network_name) { &#39;a&#39; }
        let(:payload_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../../../bosh-director/spec/unit/api/link_manager_spec.html#L227" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1157" class="js-smell-location">1</a>                  </div>  </li></ol>
          {
            &#39;link_provider_id&#39; =&gt; provider_id,
            &#39;link_consumer&#39; =&gt; {
              &#39;owner_object&#39; =&gt; {
                &#39;name&#39; =&gt; &#39;external_consumer_1&#39;,
                &#39;type&#39; =&gt; &#39;external&#39;,
              },
            },
            &#39;network&#39; =&gt; network_name,
          }
        end

        before do
          provider_response = get_link_providers
          provider_id = provider_response.first[&#39;id&#39;]
        end

        context &#39;when network name is valid&#39; do
          it &#39;creates links&#39; do
            response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
            link = JSON.parse(response.read_body)

            expect(link).to match(links_response)
          end
        end

        context &#39;when network name is invalid&#39; do
          let(:network_name) { &#39;invalid-network-name&#39; }

          it &#39;return error&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing POST request to create link)::context(when correct json is provided)::context(when network name is provided)::context(when network name is invalid)::it#return error has a flog score of 30</span>          </div>  </li></ol>
            response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
            error_response = JSON.parse(response.read_body)
            error_string = &quot;Can&#39;t resolve network: `#{network_name}` in provider id: #{provider_id} for `#{payload_json[&#39;link_consumer&#39;][&#39;owner_object&#39;][&#39;name&#39;]}`&quot;

            expect(error_response[&#39;description&#39;]).to eq(error_string)
          end
        end
      end
    end

    # TODO: Links API
    context &#39;when user does not have sufficient permissions&#39; do
      it &#39;should raise an error&#39; do
        response = send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate({}), {})

        expect(response.read_body).to include(&quot;Not authorized: &#39;/links&#39;&quot;)
      end
    end
  end

  context &#39;when doing DELETE request to delete link&#39; do
    let(:provider_id) { &#39;1&#39; }
    let(:payload_json) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="../../../bosh-director/spec/unit/api/controllers/links_controller_spec.html#L270" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1210" class="js-smell-location">1</a>                  </div>  </li></ol>
      {
        &#39;link_provider_id&#39; =&gt; provider_id,
        &#39;link_consumer&#39; =&gt; {
          &#39;owner_object&#39; =&gt; {
            &#39;name&#39; =&gt; &#39;external_consumer_1&#39;,
            &#39;type&#39; =&gt; &#39;external&#39;,
          },
        },
        &#39;network&#39; =&gt; &#39;a&#39;,
      }
    end
    let(:jobs) do
      [
        {
          &#39;name&#39; =&gt; &#39;provider&#39;,
          &#39;provides&#39; =&gt; {
            &#39;provider&#39; =&gt; {
              &#39;as&#39; =&gt; &#39;foo&#39;,
              &#39;shared&#39; =&gt; true,
            },
          },
        },
      ]
    end

    before do
      provider_response = get_link_providers
      provider_id = provider_response.first[&#39;id&#39;]
      send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json))
    end

    it &#39;performs a successful delete when link exists&#39; do
      response = send_director_delete_request(&#39;/links/1&#39;, &#39;&#39;)
      expect(response.body).to be_nil
      expect(response).to be_an_instance_of(Net::HTTPNoContent)
    end

    it &#39;raises error if link does not exist&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>describe(links api)::context(when doing DELETE request to delete link)::it#raises error if link does not exist has a flog score of 27</span>          </div>  </li></ol>
      response = send_director_delete_request(&#39;/links/2&#39;, &#39;&#39;)
      expect(response).to be_an_instance_of(Net::HTTPNotFound)
      parsed_body_hash = JSON.parse(response.body)
      expect(parsed_body_hash[&#39;code&#39;]).to eq(Bosh::Director::LinkLookupError.new.error_code)
      expect(parsed_body_hash[&#39;description&#39;]).to eq(&#39;Invalid link id: 2&#39;)
    end
  end

  context &#39;when doing GET for link_address&#39; do
    let(:jobs) do
      [
        {
          &#39;name&#39; =&gt; &#39;provider&#39;,
          &#39;provides&#39; =&gt; {
            &#39;provider&#39; =&gt; {
              &#39;as&#39; =&gt; &#39;foo&#39;,
              &#39;shared&#39; =&gt; true,
            },
          },
        },
        explicit_consumer,
      ]
    end

    let(:instance_group) do
      Bosh::Spec::NewDeployments.simple_instance_group(jobs: jobs, azs: [&#39;z2&#39;])
    end

    let(:cloud_config_hash) do
      Bosh::Spec::NewDeployments.simple_cloud_config_with_multiple_azs
    end

    let(:payload_json) do
      {
        &#39;link_consumer&#39; =&gt; {
          &#39;owner_object&#39; =&gt; {
            &#39;name&#39; =&gt; &#39;external_consumer_1&#39;,
            &#39;type&#39; =&gt; &#39;external&#39;,
          },
        },
      }
    end

    before do
      provider_response = get_link_providers
      provider_id = provider_response.first[&#39;id&#39;]
      payload_json[&#39;link_provider_id&#39;] = provider_id
    end

    it &#39;returns link address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1298" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1391" class="js-smell-location">1</a>                  </div>  </li></ol>
      external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
      response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&quot;)
      expect(response).to eq(&#39;address&#39; =&gt; &#39;q-s0.foobar.a.simple.bosh&#39;)
    end

    context &#39;azs&#39; do
      context &#39;when querying for a specific az&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1305" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1313" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L1323" class="js-smell-location">2</a>                  <a href="links_api_spec.html#L1331" class="js-smell-location">3</a>                  <a href="links_api_spec.html#L1339" class="js-smell-location">4</a>                  <a href="links_api_spec.html#L1347" class="js-smell-location">5</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;azs[]=z1&quot;)
          expect(response).to eq(&#39;address&#39; =&gt; &#39;q-a1s0.foobar.a.simple.bosh&#39;)
        end
      end

      context &#39;when querying for multiple azs&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1305" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1313" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L1323" class="js-smell-location">2</a>                  <a href="links_api_spec.html#L1331" class="js-smell-location">3</a>                  <a href="links_api_spec.html#L1339" class="js-smell-location">4</a>                  <a href="links_api_spec.html#L1347" class="js-smell-location">5</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;azs[]=z2&amp;azs[]=z1&quot;)
          expect(response).to eq(&#39;address&#39; =&gt; &#39;q-a1a2s0.foobar.a.simple.bosh&#39;)
        end
      end
    end

    context &#39;healthiness&#39; do
      context &#39;when querying for healthy address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1305" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1313" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L1323" class="js-smell-location">2</a>                  <a href="links_api_spec.html#L1331" class="js-smell-location">3</a>                  <a href="links_api_spec.html#L1339" class="js-smell-location">4</a>                  <a href="links_api_spec.html#L1347" class="js-smell-location">5</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;status=healthy&quot;)
          expect(response).to eq(&#39;address&#39; =&gt; &#39;q-s3.foobar.a.simple.bosh&#39;)
        end
      end

      context &#39;when querying for unhealthy address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1305" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1313" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L1323" class="js-smell-location">2</a>                  <a href="links_api_spec.html#L1331" class="js-smell-location">3</a>                  <a href="links_api_spec.html#L1339" class="js-smell-location">4</a>                  <a href="links_api_spec.html#L1347" class="js-smell-location">5</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;status=unhealthy&quot;)
          expect(response).to eq(&#39;address&#39; =&gt; &#39;q-s1.foobar.a.simple.bosh&#39;)
        end
      end

      context &#39;when querying for all address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1305" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1313" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L1323" class="js-smell-location">2</a>                  <a href="links_api_spec.html#L1331" class="js-smell-location">3</a>                  <a href="links_api_spec.html#L1339" class="js-smell-location">4</a>                  <a href="links_api_spec.html#L1347" class="js-smell-location">5</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;status=all&quot;)
          expect(response).to eq(&#39;address&#39; =&gt; &#39;q-s4.foobar.a.simple.bosh&#39;)
        end
      end

      context &#39;when querying for default address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 6 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1305" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1313" class="js-smell-location">1</a>                  <a href="links_api_spec.html#L1323" class="js-smell-location">2</a>                  <a href="links_api_spec.html#L1331" class="js-smell-location">3</a>                  <a href="links_api_spec.html#L1339" class="js-smell-location">4</a>                  <a href="links_api_spec.html#L1347" class="js-smell-location">5</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;status=default&quot;)
          expect(response).to eq(&#39;address&#39; =&gt; &#39;q-s0.foobar.a.simple.bosh&#39;)
        end
      end

      context &#39;when querying for unknown address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1355" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1363" class="js-smell-location">1</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = send_director_get_request(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;status=foobar&quot;)
          expect(response).to be_an_instance_of(Net::HTTPBadRequest)
        end
      end

      context &#39;when querying for non-string address&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1355" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1363" class="js-smell-location">1</a>                  </div>  </li></ol>
        it &#39;returns the link address&#39; do
          external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
          response = send_director_get_request(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&amp;status[]=default&quot;)
          expect(response).to be_an_instance_of(Net::HTTPBadRequest)
        end
      end
    end

    context &#39;when requesting for unknown link id&#39; do
      it &#39;should raise an error&#39; do
        response = send_director_get_request(&#39;/link_address&#39;, &#39;link_id=9999&#39;)
        expect(response).to be_an_instance_of(Net::HTTPNotFound)
      end
    end

    context &#39;when requesting for an internal link&#39; do
      it &#39;should return &#39; do
        response = get_json(&#39;/link_address&#39;, &#39;link_id=1&#39;)
        expect(response).to eq(&#39;address&#39; =&gt; &#39;q-s0.foobar.a.simple.bosh&#39;)
      end
    end

    context &#39;and the provider deployment has use_short_dns_addresses enabled&#39; do
      let(:features) do
        { &#39;use_short_dns_addresses&#39; =&gt; true }
      end

      it &#39;returns the address as a short dns entry&#39; do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="links_api_spec.html#L1298" class="js-smell-location">0</a>                  <a href="links_api_spec.html#L1391" class="js-smell-location">1</a>                  </div>  </li></ol>
        external_link_response = JSON.parse(send_director_post_request(&#39;/links&#39;, &#39;&#39;, JSON.generate(payload_json)).read_body)
        response = get_json(&#39;/link_address&#39;, &quot;link_id=#{external_link_response[&#39;id&#39;]}&quot;)
        expect(response).to eq(&#39;address&#39; =&gt; &#39;q-n1s0.q-g1.bosh&#39;)
      end
    end

    context &#39;and the link is manual&#39; do
      let(:explicit_consumer) do
        {
          &#39;name&#39; =&gt; &#39;consumer&#39;,
          &#39;consumes&#39; =&gt; {
            &#39;provider&#39; =&gt; {
              &#39;address&#39; =&gt; &#39;192.168.1.254&#39;,
              &#39;instances&#39; =&gt; [{ &#39;address&#39; =&gt; &#39;teswfbquts.cabsfabuo7yr.us-east-1.rds.amazonaws.com&#39; }],
              &#39;properties&#39; =&gt; { &#39;a&#39; =&gt; &#39;bar&#39;, &#39;c&#39; =&gt; &#39;bazz&#39; },
            },
          },
        }
      end

      it &#39;provides the address of the manual link&#39; do
        response = get_json(&#39;/link_address&#39;, &quot;link_id=1&quot;)
        expect(response).to eq(&#39;address&#39; =&gt; &#39;192.168.1.254&#39;)
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
