<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../../overview.html"><img src="../../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-22 10:12:42 -0700'>2018-06-22 10:12:42 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-dev/lib/bosh/dev/sandbox /</small> main.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">567</span><small> lines of codes</small></div>
              <div><span class="metric">40</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">9.4</span><small> complexity/method</small></div>
              <div><span class="metric">186</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">374.92</span><small> complexity</small></div>
              <div><span class="metric">68</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                53
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;benchmark&#39;
require &#39;securerandom&#39;
require &#39;bosh/director/config&#39;
require &#39;bosh/dev/sandbox/service&#39;
require &#39;bosh/dev/sandbox/http_endpoint_connector&#39;
require &#39;bosh/dev/sandbox/socket_connector&#39;
require &#39;bosh/dev/sandbox/postgresql&#39;
require &#39;bosh/dev/sandbox/mysql&#39;
require &#39;bosh/dev/sandbox/nginx&#39;
require &#39;bosh/dev/sandbox/workspace&#39;
require &#39;bosh/dev/sandbox/director_config&#39;
require &#39;bosh/dev/sandbox/port_provider&#39;
require &#39;bosh/dev/sandbox/services/director_service&#39;
require &#39;bosh/dev/sandbox/services/nginx_service&#39;
require &#39;bosh/dev/sandbox/services/uaa_service&#39;
require &#39;bosh/dev/sandbox/services/config_server_service&#39;
require &#39;bosh/dev/gnatsd_manager&#39;
require &#39;cloud/dummy&#39;
require &#39;logging&#39;

module Bosh::Dev::Sandbox
  class Main<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@agent_wait_timeout'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@config_server_enabled'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@database'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@default_update_vm_strategy'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@director_fix_stateful_nodes'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@director_ips'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@director_name'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@dns_enabled'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@drop_database'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@enable_cpi_resize_disk'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@enable_nats_delivered_templates'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@enable_post_deploy'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@generate_vm_passwords'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@health_monitor_process'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@local_dns'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@nats_process'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@nats_socket_connector'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@nats_url'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@remove_dev_tools'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@test_initial_state'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@trusted_certs'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@user_authentication'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@users_in_manifest'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@with_config_server_trusted_certs'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main assumes too much for instance variable '@with_incorrect_nats_server_ca'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Constants.md" target="_blank"><b>TooManyConstants</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main has 11 constants</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main has at least 47 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main has at least 39 methods</span>          </div>  </li></ol>
    REPO_ROOT = File.expand_path(&#39;../../../../../&#39;, File.dirname(__FILE__))

    SANDBOX_ASSETS_DIR = File.expand_path(&#39;bosh-dev/assets/sandbox&#39;, REPO_ROOT)

    HM_CONFIG = &#39;health_monitor.yml&#39;
    DEFAULT_HM_CONF_TEMPLATE_NAME = &#39;health_monitor.yml.erb&#39;

    NATS_CONFIG = &#39;nats.conf&#39;
    DEFAULT_NATS_CONF_TEMPLATE_NAME = &#39;nats.conf.erb&#39;

    EXTERNAL_CPI = &#39;cpi&#39;
    EXTERNAL_CPI_TEMPLATE = File.join(SANDBOX_ASSETS_DIR, &#39;cpi.erb&#39;)

    EXTERNAL_CPI_CONFIG = &#39;cpi.json&#39;
    EXTERNAL_CPI_CONFIG_TEMPLATE = File.join(SANDBOX_ASSETS_DIR, &#39;cpi_config.json.erb&#39;)

    UPGRADE_SPEC_ASSETS_DIR = File.expand_path(&#39;spec/assets/upgrade&#39;, REPO_ROOT)

    attr_reader :name
    attr_reader :health_monitor_process
    attr_reader :scheduler_process

    attr_reader :director_service
    attr_reader :port_provider

    alias_method :db_name, :name
    attr_reader :blobstore_storage_dir
    attr_reader :verify_multidigest_path

    attr_reader :logger, :logs_path

    attr_reader :cpi

    attr_reader :nats_log_path
    attr_reader :nats_host

    attr_reader :nats_url, :nats_user, :nats_password, :nats_allow_legacy_clients
    attr_reader :nats_needs_restart

    attr_reader :dummy_cpi_api_version

    attr_accessor :trusted_certs<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#trusted_certs is a writable attribute</span>          </div>  </li></ol>

    def self.from_env
      db_opts = {
        type: ENV[&#39;DB&#39;] || &#39;postgresql&#39;,
        tls_enabled: ENV[&#39;DB_TLS&#39;]==&#39;true&#39;
      }
      db_opts[:password] = ENV[&#39;DB_PASSWORD&#39;] if ENV[&#39;DB_PASSWORD&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#self.from_env calls 'ENV['DB_PASSWORD']' 2 times</span>          </div>  </li></ol>

      new(
        db_opts,
        ENV[&#39;DEBUG&#39;],
        ENV[&#39;TEST_ENV_NUMBER&#39;].to_i,
      )
    end

    def initialize(db_opts, debug, test_env_number)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#initialize has a flog score of 57</span>          </div>  </li></ol>
      @debug = debug
      @name = SecureRandom.uuid.gsub(&#39;-&#39;, &#39;&#39;)

      @port_provider = PortProvider.new(test_env_number)

      @logs_path = sandbox_path(&#39;logs&#39;)
      FileUtils.mkdir_p(@logs_path)

      @sandbox_log_file = File.open(sandbox_path(&#39;sandbox.log&#39;), &#39;w+&#39;)

      @sandbox_log_file = STDOUT unless ENV.fetch(&#39;LOG_STDOUT&#39;, &#39;&#39;).empty?
      @logger = Logging.logger(@sandbox_log_file)

      @logger.level = ENV.fetch(&#39;LOG_LEVEL&#39;, &#39;DEBUG&#39;)

      @dns_db_path = sandbox_path(&#39;director-dns.sqlite&#39;)
      @task_logs_dir = sandbox_path(&#39;boshdir/tasks&#39;)
      @blobstore_storage_dir = sandbox_path(&#39;bosh_test_blobstore&#39;)
      @verify_multidigest_path = File.join(REPO_ROOT, &#39;tmp&#39;, &#39;verify-multidigest&#39;, &#39;verify-multidigest&#39;)
      @dummy_cpi_api_version = nil

      @nats_user = &#39;mbus&#39;
      @nats_password = &#39;password&#39;
      @nats_allow_legacy_clients = false
      @nats_needs_restart = false
      @nats_log_path = File.join(@logs_path, &#39;nats.log&#39;)
      setup_nats

      @uaa_service = UaaService.new(@port_provider, sandbox_root, base_log_path, @logger)
      @config_server_service = ConfigServerService.new(@port_provider, base_log_path, @logger, test_env_number)
      @nginx_service = NginxService.new(sandbox_root, director_port, director_ruby_port, @uaa_service.port, @logger)

      @db_config = {
        ca_path: File.join(SANDBOX_ASSETS_DIR, &#39;database&#39;, &#39;rootCA.pem&#39;)
      }.merge(db_opts)

      setup_database(@db_config, nil)

      director_config_path = sandbox_path(DirectorService::DEFAULT_DIRECTOR_CONFIG)
      director_tmp_path = sandbox_path(&#39;boshdir&#39;)
      @director_service = DirectorService.new(
        {
          database: @database,
          director_port: director_ruby_port,
          base_log_path: base_log_path,
          director_tmp_path: director_tmp_path,
          director_config: director_config_path
        },
        @logger
      )
      setup_heath_monitor

      @scheduler_process = Service.new(
        %W[bosh-director-scheduler -c #{director_config_path}],
        {output: &quot;#{base_log_path}.scheduler.out&quot;},
        @logger,
      )

      # Note that this is not the same object
      # as dummy cpi used inside bosh-director process
      @cpi = Bosh::Clouds::Dummy.new(
        {
          &#39;dir&#39; =&gt; cloud_storage_dir,
          &#39;agent&#39; =&gt; {
            &#39;blobstore&#39; =&gt; {
              &#39;provider&#39; =&gt; &#39;local&#39;,
              &#39;options&#39; =&gt; {
                &#39;blobstore_path&#39; =&gt; @blobstore_storage_dir,
              },
            }
          },
          &#39;nats&#39; =&gt; @nats_url,
          &#39;log_buffer&#39; =&gt; @logger,
        },
        {},
        @dummy_cpi_api_version
      )

      reconfigure
    end

    def agent_tmp_path
      cloud_storage_dir
    end

    def sandbox_path(path)
      File.join(sandbox_root, path)
    end

    def start<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#start has a flog score of 25</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#start has approx 15 statements</span>          </div>  </li></ol>
      @logger.info(&quot;Debug logs are saved to #{saved_logs_path}&quot;)
      setup_sandbox_root

      FileUtils.mkdir_p(cloud_storage_dir)
      FileUtils.rm_rf(logs_path)
      FileUtils.mkdir_p(logs_path)

      @nginx_service.start

      @nats_process.start
      @nats_socket_connector.try_to_connect

      @database.create_db

      unless @test_initial_state.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#start performs a nil-check</span>          </div>  </li></ol>
        load_db_and_populate_blobstore(@test_initial_state)
      end

      @uaa_service.start if @user_authentication == &#39;uaa&#39;
      @config_server_service.start(@with_config_server_trusted_certs) if @config_server_enabled

      dir_config = director_config
      @director_name = dir_config.director_name

      @director_service.start(dir_config)
    end

    def director_name
      @director_name || raise(&quot;Test inconsistency: Director name is not set&quot;)
    end

    def director_config
      attributes = {
        agent_wait_timeout: @agent_wait_timeout,
        blobstore_storage_dir: blobstore_storage_dir,
        cloud_storage_dir: cloud_storage_dir,
        config_server_enabled: @config_server_enabled,
        database: @database,
        default_update_vm_strategy: @default_update_vm_strategy,
        director_fix_stateful_nodes: @director_fix_stateful_nodes,
        director_ips: @director_ips,
        dns_enabled: @dns_enabled,
        enable_cpi_resize_disk: @enable_cpi_resize_disk,
        enable_nats_delivered_templates: @enable_nats_delivered_templates,
        enable_post_deploy: @enable_post_deploy,
        external_cpi_config: external_cpi_config,
        generate_vm_passwords: @generate_vm_passwords,
        local_dns: @local_dns,
        nats_client_ca_certificate_path: get_nats_client_ca_certificate_path,
        nats_client_ca_private_key_path: get_nats_client_ca_private_key_path,
        nats_director_tls: nats_certificate_paths[&#39;clients&#39;][&#39;director&#39;],
        nats_server_ca_path: get_nats_server_ca_path,
        remove_dev_tools: @remove_dev_tools,
        sandbox_root: sandbox_root,
        trusted_certs: @trusted_certs,
        user_authentication: @user_authentication,
        users_in_manifest: @users_in_manifest,
        verify_multidigest_path: verify_multidigest_path,
      }
      DirectorConfig.new(attributes, @port_provider)
    end

    def reset
      time = Benchmark.realtime { do_reset }
      @logger.info(&quot;Reset took #{time} seconds&quot;)
    end

    def reconfigure_health_monitor(erb_template=DEFAULT_HM_CONF_TEMPLATE_NAME)
      @health_monitor_process.stop
      write_in_sandbox(HM_CONFIG, load_config_template(File.join(SANDBOX_ASSETS_DIR, erb_template)))
      @health_monitor_process.start
    end

    def cloud_storage_dir
      sandbox_path(&#39;bosh_cloud_test&#39;)
    end

    def saved_logs_path
      File.join(Workspace.dir, &quot;#{@name}.log&quot;)
    end

    def save_task_logs(name)
      if @debug &amp;&amp; File.directory?(task_logs_dir)
        task_name = &quot;task_#{name}_#{SecureRandom.hex(6)}&quot;
        FileUtils.mv(task_logs_dir, File.join(logs_path, task_name))
      end
    end

    def stop<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#stop has approx 12 statements</span>          </div>  </li></ol>
      @cpi.kill_agents

      @director_service.stop

      @nginx_service.stop
      @nats_process.stop

      @health_monitor_process.stop
      @uaa_service.stop

      @config_server_service.stop

      @database.drop_db

      @sandbox_log_file.close unless @sandbox_log_file == STDOUT

      FileUtils.rm_f(dns_db_path)
      FileUtils.rm_rf(agent_tmp_path)
      FileUtils.rm_rf(blobstore_storage_dir)
    end

    def run
      start
      @logger.info(&#39;Sandbox running, type ctrl+c to stop&#39;)

      loop { sleep 60 }

    # rubocop:disable HandleExceptions
    rescue Interrupt
    # rubocop:enable HandleExceptions
    ensure
      stop
      @logger.info(&#39;Stopped sandbox&#39;)
    end

    def db
      Sequel.connect(@director_service.db_config)
    end

    def nats_port
      @nats_port ||= @port_provider.get_port(:nats)
    end

    def hm_port
      @hm_port ||= @port_provider.get_port(:hm)
    end

    def director_url
      @director_url ||= &quot;https://127.0.0.1:#{director_port}&quot;
    end

    def director_port
      @director_port ||= @port_provider.get_port(:nginx)
    end

    def director_ruby_port
      @director_ruby_port ||= @port_provider.get_port(:director_ruby)
    end

    def sandbox_root<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#sandbox_root doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      File.join(Workspace.dir, &#39;sandbox&#39;)
    end

    def reconfigure(options={})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#reconfigure has a flog score of 43</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#reconfigure has approx 25 statements</span>          </div>  </li></ol>
      @user_authentication = options.fetch(:user_authentication, &#39;local&#39;)
      @config_server_enabled = options.fetch(:config_server_enabled, false)
      @drop_database = options.fetch(:drop_database, false)
      @test_initial_state = options.fetch(:test_initial_state, nil)
      @with_config_server_trusted_certs = options.fetch(:with_config_server_trusted_certs, true)
      @director_fix_stateful_nodes = options.fetch(:director_fix_stateful_nodes, false)
      @dns_enabled = options.fetch(:dns_enabled, true)
      @local_dns = options.fetch(:local_dns, {enabled: false, include_index: false, use_dns_addresses: false})
      @nginx_service.reconfigure(options[:ssl_mode])
      @uaa_service.reconfigure(options[:uaa_encryption])
      @users_in_manifest = options.fetch(:users_in_manifest, true)
      @enable_post_deploy = options.fetch(:enable_post_deploy, false)
      @enable_nats_delivered_templates = options.fetch(:enable_nats_delivered_templates, false)
      @enable_cpi_resize_disk = options.fetch(:enable_cpi_resize_disk, false)
      @default_update_vm_strategy = options.fetch(:default_update_vm_strategy, ENV[&#39;DEFAULT_UPDATE_VM_STRATEGY&#39;])
      @generate_vm_passwords = options.fetch(:generate_vm_passwords, false)
      @remove_dev_tools = options.fetch(:remove_dev_tools, false)
      @director_ips = options.fetch(:director_ips, [])
      @agent_wait_timeout = options.fetch(:agent_wait_timeout, 600)
      @with_incorrect_nats_server_ca = options.fetch(:with_incorrect_nats_server_ca, false)
      old_tls_enabled_value = @db_config[:tls_enabled]
      @db_config[:tls_enabled] = options.fetch(:tls_enabled, ENV[&#39;DB_TLS&#39;]==&#39;true&#39;)
      @dummy_cpi_api_version = options.fetch(:dummy_cpi_api_version, nil)

      check_if_nats_need_reset(options.fetch(:nats_allow_legacy_clients, false))
      setup_database(@db_config, old_tls_enabled_value)
    end

    def check_if_nats_need_reset(allow_legacy_clients)
      @nats_needs_restart = @nats_allow_legacy_clients != allow_legacy_clients
      @nats_allow_legacy_clients = allow_legacy_clients

      if @nats_allow_legacy_clients
        @nats_url = &quot;nats://#{@nats_user}:#{@nats_password}@127.0.0.1:#{nats_port}&quot;
      else
        @nats_url = &quot;nats://127.0.0.1:#{nats_port}&quot;
      end

      @cpi.options[&#39;nats&#39;] = @nats_url
    end

    def certificate_path<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#certificate_path doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      File.join(SANDBOX_ASSETS_DIR, &#39;ca&#39;, &#39;certs&#39;, &#39;rootCA.pem&#39;)
    end

    def nats_certificate_paths
      {
        &#39;ca_path&#39; =&gt; get_nats_server_ca_path,

        &#39;server&#39; =&gt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="main.html#L373" class="js-smell-location">0</a>                  <a href="main.html#L378" class="js-smell-location">1</a>                  <a href="main.html#L382" class="js-smell-location">2</a>                  <a href="main.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>
          &#39;certificate_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;nats&#39;, &#39;certificate.pem&#39;),
          &#39;private_key_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;nats&#39;, &#39;private_key&#39;),
        },
        &#39;clients&#39; =&gt; {
          &#39;director&#39; =&gt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="main.html#L373" class="js-smell-location">0</a>                  <a href="main.html#L378" class="js-smell-location">1</a>                  <a href="main.html#L382" class="js-smell-location">2</a>                  <a href="main.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>
            &#39;certificate_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;director&#39;, &#39;certificate.pem&#39;),
            &#39;private_key_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;director&#39;, &#39;private_key&#39;),
          },
          &#39;health_monitor&#39; =&gt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="main.html#L373" class="js-smell-location">0</a>                  <a href="main.html#L378" class="js-smell-location">1</a>                  <a href="main.html#L382" class="js-smell-location">2</a>                  <a href="main.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>
            &#39;certificate_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;health_monitor&#39;, &#39;certificate.pem&#39;),
            &#39;private_key_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;health_monitor&#39;, &#39;private_key&#39;),
          },
          &#39;test_client&#39; =&gt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 4 nodes</span>              <span>Locations:</span>                  <a href="main.html#L373" class="js-smell-location">0</a>                  <a href="main.html#L378" class="js-smell-location">1</a>                  <a href="main.html#L382" class="js-smell-location">2</a>                  <a href="main.html#L386" class="js-smell-location">3</a>                  </div>  </li></ol>
            &#39;certificate_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;test_client&#39;, &#39;certificate.pem&#39;),
            &#39;private_key_path&#39; =&gt; File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;test_client&#39;, &#39;private_key&#39;),
          }
        }
      }
    end

    def director_nats_config
      {
        uri: &quot;nats://127.0.0.1:#{nats_port}&quot;,
        ssl: true,
        tls: {
          :private_key_file =&gt; nats_certificate_paths[&#39;clients&#39;][&#39;test_client&#39;][&#39;private_key_path&#39;],<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#director_nats_config calls 'nats_certificate_paths['clients']' 2 times</span>              <span>Locations:</span>                  <a href="main.html#L399" class="js-smell-location">0</a>                  <a href="main.html#L400" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#director_nats_config calls 'nats_certificate_paths['clients']['test_client']' 2 times</span>              <span>Locations:</span>                  <a href="main.html#L399" class="js-smell-location">0</a>                  <a href="main.html#L400" class="js-smell-location">1</a>                  </div>  </li></ol>
          :cert_chain_file  =&gt; nats_certificate_paths[&#39;clients&#39;][&#39;test_client&#39;][&#39;certificate_path&#39;],<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#director_nats_config calls 'nats_certificate_paths['clients']' 2 times</span>              <span>Locations:</span>                  <a href="main.html#L399" class="js-smell-location">0</a>                  <a href="main.html#L400" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#director_nats_config calls 'nats_certificate_paths['clients']['test_client']' 2 times</span>              <span>Locations:</span>                  <a href="main.html#L399" class="js-smell-location">0</a>                  <a href="main.html#L400" class="js-smell-location">1</a>                  </div>  </li></ol>
          :verify_peer =&gt; true,
          :ca_file =&gt; nats_certificate_paths[&#39;ca_path&#39;],
        }
      }
    end

    private

    def load_db_and_populate_blobstore(test_initial_state)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#load_db_and_populate_blobstore has approx 8 statements</span>          </div>  </li></ol>
      @database.load_db_initial_state(File.join(UPGRADE_SPEC_ASSETS_DIR, test_initial_state))

      if @database.adapter.eql? &#39;mysql2&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#load_db_and_populate_blobstore calls '@database.adapter' 2 times</span>              <span>Locations:</span>                  <a href="main.html#L412" class="js-smell-location">0</a>                  <a href="main.html#L414" class="js-smell-location">1</a>                  </div>  </li></ol>
        tar_filename = &#39;blobstore_snapshot_with_mysql.tar.gz&#39;
      elsif @database.adapter.eql? &#39;postgres&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#load_db_and_populate_blobstore calls '@database.adapter' 2 times</span>              <span>Locations:</span>                  <a href="main.html#L412" class="js-smell-location">0</a>                  <a href="main.html#L414" class="js-smell-location">1</a>                  </div>  </li></ol>
        tar_filename = &#39;blobstore_snapshot_with_postgres.tar.gz&#39;
      else
        raise &#39;Pre-loading blobstore supported only for PostgresDB and MySQL&#39;
      end

      blobstore_snapshot_path = File.join(UPGRADE_SPEC_ASSETS_DIR, test_initial_state, tar_filename)
      @logger.info(&quot;Pre-filling blobstore `#{blobstore_storage_dir}` with blobs from `#{blobstore_snapshot_path}`&quot;)
      tar_out = `tar xzvf #{blobstore_snapshot_path} -C #{blobstore_storage_dir}  2&gt;&amp;1`
      if $?.exitstatus != 0
        raise &quot;Cannot pre-fill blobstore: #{tar_out}&quot;
      end
    end

    def external_cpi_config
      {
        name: &#39;test-cpi&#39;,
        exec_path: File.join(REPO_ROOT, &#39;bosh-director&#39;, &#39;bin&#39;, &#39;dummy_cpi&#39;),
        job_path: sandbox_path(EXTERNAL_CPI),
        config_path: sandbox_path(EXTERNAL_CPI_CONFIG),
        env_path: ENV[&#39;PATH&#39;],
        gem_home: ENV[&#39;GEM_HOME&#39;],
        gem_path: ENV[&#39;GEM_PATH&#39;],
        dummy_cpi_api_version: @dummy_cpi_api_version,
      }
    end

    def do_reset<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#do_reset has a flog score of 34</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#do_reset has approx 20 statements</span>          </div>  </li></ol>
      @cpi.kill_agents

      @director_service.stop

      if @drop_database
        @database.drop_db
        @database.create_db
      else
        @database.truncate_db
      end

      FileUtils.rm_rf(blobstore_storage_dir)
      FileUtils.mkdir_p(blobstore_storage_dir)

      unless @test_initial_state.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#do_reset performs a nil-check</span>          </div>  </li></ol>
        load_db_and_populate_blobstore(@test_initial_state)
      end

      # TODO: Move into its own service.
      if @nats_needs_restart
        @nats_process.stop
        nats_template_path = File.join(SANDBOX_ASSETS_DIR, DEFAULT_NATS_CONF_TEMPLATE_NAME)
        write_in_sandbox(NATS_CONFIG, load_config_template(nats_template_path))
        write_in_sandbox(EXTERNAL_CPI_CONFIG, load_config_template(EXTERNAL_CPI_CONFIG_TEMPLATE))
        setup_nats
        @nats_process.start
        @nats_socket_connector.try_to_connect
      end

      @uaa_service.restart_if_needed if @user_authentication == &#39;uaa&#39;
      @config_server_service.restart(@with_config_server_trusted_certs) if @config_server_enabled

      @director_service.start(director_config, @drop_database)

      @nginx_service.restart_if_needed

      @cpi.reset
    end

    def setup_sandbox_root<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#setup_sandbox_root has approx 8 statements</span>          </div>  </li></ol>
      hm_template_path = File.join(SANDBOX_ASSETS_DIR, DEFAULT_HM_CONF_TEMPLATE_NAME)
      write_in_sandbox(HM_CONFIG, load_config_template(hm_template_path))
      write_in_sandbox(EXTERNAL_CPI, load_config_template(EXTERNAL_CPI_TEMPLATE))
      write_in_sandbox(EXTERNAL_CPI_CONFIG, load_config_template(EXTERNAL_CPI_CONFIG_TEMPLATE))
      nats_template_path = File.join(SANDBOX_ASSETS_DIR, DEFAULT_NATS_CONF_TEMPLATE_NAME)
      write_in_sandbox(NATS_CONFIG, load_config_template(nats_template_path))
      FileUtils.chmod(0755, sandbox_path(EXTERNAL_CPI))
      FileUtils.mkdir_p(blobstore_storage_dir)
    end

    def read_from_sandbox(filename)
      Dir.chdir(sandbox_root) do
        File.read(filename)
      end
    end

    def write_in_sandbox(filename, contents)
      Dir.chdir(sandbox_root) do
        File.open(filename, &#39;w+&#39;) do |f|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#write_in_sandbox has the variable name 'f'</span>          </div>  </li></ol>
          f.write(contents)
        end
      end
    end

    def load_config_template(filename)
      template_contents = File.read(filename)
      template = ERB.new(template_contents)
      template.result(binding)
    end

    def setup_database(db_config, old_tls_enabled_value)
      if !@database || (db_config[:tls_enabled] != old_tls_enabled_value)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#setup_database is controlled by argument 'old_tls_enabled_value'</span>          </div>  </li></ol>
        if db_config[:type] == &#39;mysql&#39;
          @database = Mysql.new(@name, Bosh::Core::Shell.new, @logger, db_config)
        else
          postgres_options = db_config.dup

          @database = Postgresql.new(@name, Bosh::Core::Shell.new, @logger, postgres_options)
        end
      end
    end

    def setup_heath_monitor
      @health_monitor_process = Service.new(
        %W[bosh-monitor -c #{sandbox_path(HM_CONFIG)}],
        {output: &quot;#{logs_path}/health_monitor.out&quot;},
        @logger,
      )
    end

    def base_log_path
      File.join(logs_path, @name)
    end

    def setup_nats
      gnatsd_path = Bosh::Dev::GnatsdManager.executable_path
      conf = File.join(sandbox_root, NATS_CONFIG)

      @nats_process = Service.new(
        %W[#{gnatsd_path} -c #{conf} -T -D ],
        {stdout: $stdout, stderr: $stderr},
        @logger
      )

      @nats_socket_connector = SocketConnector.new(&#39;nats&#39;, &#39;localhost&#39;, nats_port, @nats_log_path, @logger)
    end

    def get_nats_server_ca_path
      if @with_incorrect_nats_server_ca
        File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;childless_rootCA.pem&#39;)
      else
        File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;rootCA.pem&#39;)
      end
    end

    def get_nats_client_ca_certificate_path<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#get_nats_client_ca_certificate_path doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;rootCA.pem&#39;)
    end

    def get_nats_client_ca_private_key_path<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::Main#get_nats_client_ca_private_key_path doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      File.join(SANDBOX_ASSETS_DIR, &#39;nats_server&#39;, &#39;certs&#39;, &#39;rootCA.key&#39;)
    end

    attr_reader :director_tmp_path, :dns_db_path, :task_logs_dir
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../../assets/javascripts/application.js'></script>
    <script src='../../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
