<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../../../overview.html"><img src="../../../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 10:14:31 -0700'>2018-05-31 10:14:31 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-dev/lib/bosh/dev/sandbox/services /</small> director_service.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">262</span><small> lines of codes</small></div>
              <div><span class="metric">18</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">11.0</span><small> complexity/method</small></div>
              <div><span class="metric">50</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">197.19</span><small> complexity</small></div>
              <div><span class="metric">88</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                25
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;bosh/dev/sandbox/database_migrator&#39;

module Bosh::Dev::Sandbox
  class DirectorService<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService assumes too much for instance variable '@database_migrated'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService assumes too much for instance variable '@monitor_workers'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Constants.md" target="_blank"><b>TooManyConstants</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService has 6 constants</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService has at least 11 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService has at least 18 methods</span>          </div>  </li></ol>

    REPO_ROOT = File.expand_path(&#39;../../../../../../&#39;, File.dirname(__FILE__))
    ASSETS_DIR = File.expand_path(&#39;bosh-dev/assets/sandbox&#39;, REPO_ROOT)

    DEFAULT_DIRECTOR_CONFIG = &#39;director_test.yml&#39;
    DIRECTOR_CONF_TEMPLATE = File.join(ASSETS_DIR, &#39;director_test.yml.erb&#39;)

    DIRECTOR_PATH = File.expand_path(&#39;bosh-director&#39;, REPO_ROOT)

    def initialize(options, logger)
      @database = options[:database]
      @logger = logger
      @director_tmp_path = options[:director_tmp_path]
      @director_config = options[:director_config]
      @base_log_path = options[:base_log_path]

      log_location = &quot;#{@base_log_path}.director.out&quot;
      @process = Service.new(
        %W[bosh-director -c #{@director_config}],
        {output: log_location},
        @logger,
      )

      @connector = HTTPEndpointConnector.new(&#39;director&#39;, &#39;localhost&#39;, options[:director_port], &#39;/info&#39;, &quot;\&quot;uuid\&quot;&quot;, log_location, @logger)

      if ENV[&#39;TMUX_DEBUG&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService tests 'ENV['TMUX_DEBUG']' at least 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L30" class="js-smell-location">0</a>                  <a href="director_service.html#L154" class="js-smell-location">1</a>                  <a href="director_service.html#L182" class="js-smell-location">2</a>                  <a href="director_service.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
        @worker_processes = 2.times.map do |index|
          Service.new(
            %W[tmux new-window -n bosh-director-worker-#{index} -d bundle exec bosh-director-worker -c #{@director_config} -i #{index}],
            {output: &quot;#{@base_log_path}.worker_#{index}.out&quot;, env: {&#39;QUEUE&#39; =&gt; &#39;normal,urgent&#39;}},
            @logger,
          )
        end
      else
        @worker_processes = 3.times.map do |index|
          Service.new(
            %W[bosh-director-worker -c #{@director_config} -i #{index}],
            {output: &quot;#{@base_log_path}.worker_#{index}.out&quot;, env: {&#39;QUEUE&#39; =&gt; &#39;normal,urgent&#39;}},
            @logger,
          )
        end
      end

      @database_migrator = DatabaseMigrator.new(DIRECTOR_PATH, @director_config, @logger)
    end

    def start(config, force_migration = false)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Boolean-Parameter.md" target="_blank"><b>BooleanParameter</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#start has boolean parameter 'force_migration'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#start has approx 8 statements</span>          </div>  </li></ol>
      write_config(config)

      migrate_database(force_migration)

      reset

      @process.start

      start_workers

      begin
        # CI does not have enough time to start bosh-director
        # for some parallel tests; increasing to 60 secs (= 300 tries).
        @connector.try_to_connect(300)
      rescue
        output_service_log(@process)
        raise
      end
    end

    def stop
      wait_for_tasks_to_finish
      stop_workers
      @process.stop
    end

    def hard_stop
      stop_workers
      @process.stop
    end

    def print_current_tasks
      @database.current_tasks.each do |current_task|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="director_service.html#L84" class="js-smell-location">0</a>                  <a href="director_service.html#L101" class="js-smell-location">1</a>                  </div>  </li></ol>
        @logger.error(&quot;#{DEBUG_HEADER} Current task &#39;#{current_task[:description]}&#39; #{DEBUG_HEADER}:&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#print_current_tasks calls 'current_task[:description]' 2 times</span>              <span>Locations:</span>                  <a href="director_service.html#L85" class="js-smell-location">0</a>                  <a href="director_service.html#L87" class="js-smell-location">1</a>                  </div>  </li></ol>
        @logger.error(File.read(File.join(current_task[:output], &#39;debug&#39;)))
        @logger.error(&quot;#{DEBUG_HEADER} End of task &#39;#{current_task[:description]}&#39; #{DEBUG_HEADER}:&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#print_current_tasks calls 'current_task[:description]' 2 times</span>              <span>Locations:</span>                  <a href="director_service.html#L85" class="js-smell-location">0</a>                  <a href="director_service.html#L87" class="js-smell-location">1</a>                  </div>  </li></ol>
      end
    end

    def wait_for_tasks_to_finish<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#wait_for_tasks_to_finish has a flog score of 31</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#wait_for_tasks_to_finish has approx 14 statements</span>          </div>  </li></ol>
      @logger.debug(&#39;Waiting for Delayed Job queue to drain...&#39;)
      attempt = 0
      delay = 0.1
      timeout = 60
      max_attempts = timeout/delay

      until delayed_job_done?
        if attempt &gt; max_attempts
          @logger.error(&quot;Delayed Job queue failed to drain in #{timeout} seconds}&quot;)
          @database.current_tasks.each do |current_task|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="director_service.html#L84" class="js-smell-location">0</a>                  <a href="director_service.html#L101" class="js-smell-location">1</a>                  </div>  </li></ol>
            @logger.error(&quot;#{DEBUG_HEADER} Current task &#39;#{current_task[:description]}&#39; #{DEBUG_HEADER}:&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#wait_for_tasks_to_finish calls 'current_task[:description]' 2 times</span>              <span>Locations:</span>                  <a href="director_service.html#L102" class="js-smell-location">0</a>                  <a href="director_service.html#L104" class="js-smell-location">1</a>                  </div>  </li></ol>
            @logger.error(File.read(File.join(current_task[:output], &#39;debug&#39;)))
            @logger.error(&quot;#{DEBUG_HEADER} End of task &#39;#{current_task[:description]}&#39; #{DEBUG_HEADER}:&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#wait_for_tasks_to_finish calls 'current_task[:description]' 2 times</span>              <span>Locations:</span>                  <a href="director_service.html#L102" class="js-smell-location">0</a>                  <a href="director_service.html#L104" class="js-smell-location">1</a>                  </div>  </li></ol>
          end

          raise &quot;Delayed Job queue failed to drain in #{timeout} seconds&quot;
        end

        attempt += 1
        sleep delay
      end
      @logger.debug(&#39;Delayed Job queue drained&#39;)
    end

    def db_config<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config has approx 15 statements</span>          </div>  </li></ol>
      connection_config = YAML.load_file(@director_config)[&#39;db&#39;]

      custom_connection_options = connection_config.delete(&#39;connection_options&#39;) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
        {}
      end
      tls_options = connection_config.delete(&#39;tls&#39;) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
        {}
      end
      if tls_options.fetch(&#39;enabled&#39;, false)
        certificate_paths = tls_options.fetch(&#39;cert&#39;)
        db_ca_path = certificate_paths.fetch(&#39;ca&#39;)

        case connection_config[&#39;adapter&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
          when &#39;mysql2&#39;
            connection_config[&#39;ssl_mode&#39;] = &#39;verify_identity&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
            connection_config[&#39;sslca&#39;] = db_ca_path<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
          when &#39;postgres&#39;
            connection_config[&#39;sslmode&#39;] = &#39;verify-full&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
            connection_config[&#39;sslrootcert&#39;] = db_ca_path<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
        end
      end

      connection_config.delete_if { |_, v| v.to_s.empty? }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config has the variable name 'v'</span>          </div>  </li></ol>
      connection_config = connection_config.merge(custom_connection_options)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#db_config refers to 'connection_config' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="director_service.html#L119" class="js-smell-location">0</a>                  <a href="director_service.html#L122" class="js-smell-location">1</a>                  <a href="director_service.html#L129" class="js-smell-location">2</a>                  <a href="director_service.html#L131" class="js-smell-location">3</a>                  <a href="director_service.html#L132" class="js-smell-location">4</a>                  <a href="director_service.html#L134" class="js-smell-location">5</a>                  <a href="director_service.html#L135" class="js-smell-location">6</a>                  <a href="director_service.html#L139" class="js-smell-location">7</a>                  <a href="director_service.html#L140" class="js-smell-location">8</a>                  </div>  </li></ol>
      connection_config
    end

    private

    def migrate_database(force_migration)
      if !@database_migrated || force_migration<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#migrate_database is controlled by argument 'force_migration'</span>          </div>  </li></ol>
        @database_migrator.migrate
        @database_migrated = true
      end
    end

    def delayed_job_ready?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#delayed_job_ready? has approx 6 statements</span>          </div>  </li></ol>
      if ENV[&#39;TMUX_DEBUG&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService tests 'ENV['TMUX_DEBUG']' at least 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L30" class="js-smell-location">0</a>                  <a href="director_service.html#L154" class="js-smell-location">1</a>                  <a href="director_service.html#L182" class="js-smell-location">2</a>                  <a href="director_service.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
        sleep 20
        return true
      end
      started = true
      @worker_processes.each do |worker|
        started = started &amp;&amp; worker.stdout_contents.include?(&#39;Starting job worker&#39;)
      end
      started
    end

    def start_workers<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#start_workers has approx 11 statements</span>          </div>  </li></ol>
      @worker_processes.each(&amp;:start)
      attempt = 0
      delay = 0.5
      timeout = 60 * 5
      max_attempts = timeout/delay

      until delayed_job_ready?
        if attempt &gt; max_attempts
          @logger.error(&quot;Delayed Job queue failed to start in #{timeout} seconds.&quot;)
          raise &quot;Delayed Job failed to start workers in #{timeout} seconds&quot;
        end

        attempt += 1
        sleep delay
      end

      if ENV[&#39;TMUX_DEBUG&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService tests 'ENV['TMUX_DEBUG']' at least 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L30" class="js-smell-location">0</a>                  <a href="director_service.html#L154" class="js-smell-location">1</a>                  <a href="director_service.html#L182" class="js-smell-location">2</a>                  <a href="director_service.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
        return
      end

      start_monitor_workers
    end

    def stop_workers<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#stop_workers has approx 10 statements</span>          </div>  </li></ol>
      if ENV[&#39;TMUX_DEBUG&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService tests 'ENV['TMUX_DEBUG']' at least 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L30" class="js-smell-location">0</a>                  <a href="director_service.html#L154" class="js-smell-location">1</a>                  <a href="director_service.html#L182" class="js-smell-location">2</a>                  <a href="director_service.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
        @worker_processes.length.times.map do |index|
          system(&quot;tmux kill-window -t :bosh-director-worker-#{index}&quot;)
        end
        return
      end
      # wait for workers in parallel for fastness
      stop_monitor_workers
      @worker_processes.map { |worker_process| Thread.new {
        child_processes = worker_process.get_child_pids
        worker_process.stop
        child_processes.each do |pid|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#stop_workers contains iterators nested 2 deep</span>          </div>  </li></ol>
          # if we kill worker children before the parent, the parent sees the
          # failed child process and marks the task as a failure which is not
          # what we are wanting to simulate with this sort of stop
          worker_process.kill_pid(pid, &#39;KILL&#39;)
        end
      } }.each(&amp;:join)
    end

    def start_monitor_workers
      @monitor_workers = true
      monitor_workers
    end

    def stop_monitor_workers
      @monitor_workers = false
    end

    def monitor_workers
      Thread.new do
        while @monitor_workers
          @worker_processes.map(&amp;:pid).each do |worker_pid|
            begin
              Process.kill(0, worker_pid)
            rescue Errno::ESRCH
              raise &quot;Worker is no longer running (PID #{worker_pid})&quot;
            end
          end
          sleep(5)
        end
      end
    end

    def reset
      FileUtils.rm_rf(@director_tmp_path)
      FileUtils.mkdir_p(@director_tmp_path)
    end

    def write_config(config)
      contents = config.render(DIRECTOR_CONF_TEMPLATE)
      File.open(@director_config, &#39;w+&#39;) do |f|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#write_config has the variable name 'f'</span>          </div>  </li></ol>
        f.write(contents)
      end
    end

    def delayed_job_done?
      @database.current_locked_jobs.count == 0
    end

    DEBUG_HEADER = &#39;*&#39; * 20

    def output_service_log(service)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#output_service_log has approx 6 statements</span>          </div>  </li></ol>
      @logger.error(&quot;#{DEBUG_HEADER} start #{service.description} stdout #{DEBUG_HEADER}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#output_service_log calls 'service.description' 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L253" class="js-smell-location">0</a>                  <a href="director_service.html#L255" class="js-smell-location">1</a>                  <a href="director_service.html#L257" class="js-smell-location">2</a>                  <a href="director_service.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>
      @logger.error(service.stdout_contents)
      @logger.error(&quot;#{DEBUG_HEADER} end #{service.description} stdout #{DEBUG_HEADER}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#output_service_log calls 'service.description' 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L253" class="js-smell-location">0</a>                  <a href="director_service.html#L255" class="js-smell-location">1</a>                  <a href="director_service.html#L257" class="js-smell-location">2</a>                  <a href="director_service.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>

      @logger.error(&quot;#{DEBUG_HEADER} start #{service.description} stderr #{DEBUG_HEADER}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#output_service_log calls 'service.description' 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L253" class="js-smell-location">0</a>                  <a href="director_service.html#L255" class="js-smell-location">1</a>                  <a href="director_service.html#L257" class="js-smell-location">2</a>                  <a href="director_service.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>
      @logger.error(service.stderr_contents)
      @logger.error(&quot;#{DEBUG_HEADER} end #{service.description} stderr #{DEBUG_HEADER}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Dev::Sandbox::DirectorService#output_service_log calls 'service.description' 4 times</span>              <span>Locations:</span>                  <a href="director_service.html#L253" class="js-smell-location">0</a>                  <a href="director_service.html#L255" class="js-smell-location">1</a>                  <a href="director_service.html#L257" class="js-smell-location">2</a>                  <a href="director_service.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../../../assets/javascripts/application.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
