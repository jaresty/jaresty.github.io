<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-14 16:08:12 -0400'>2018-05-14 16:08:12 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh/director/deployment_plan /</small> instance_group.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">415</span><small> lines of codes</small></div>
              <div><span class="metric">39</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">8.3</span><small> complexity/method</small></div>
              <div><span class="metric">180</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">322.34</span><small> complexity</small></div>
              <div><span class="metric">0</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                61
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;bosh/director/deployment_plan/instance_group_spec_parser&#39;
require &#39;bosh/template/property_helper&#39;

module Bosh::Director
  module DeploymentPlan
    class InstanceGroup<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup assumes too much for instance variable '@lifecycle'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup assumes too much for instance variable '@name'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup assumes too much for instance variable '@state'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup assumes too much for instance variable '@stemcell'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup has at least 16 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup has at least 36 methods</span>          </div>  </li></ol>
      include Bosh::Template::PropertyHelper

      VALID_LIFECYCLE_PROFILES = %w[service errand].freeze
      DEFAULT_LIFECYCLE_PROFILE = &#39;service&#39;.freeze

      # started, stopped and detached are real states
      # (persisting in DB and reflecting target instance state)
      # recreate and restart are two virtual states
      # (both set  target instance state to &quot;started&quot; and set
      # appropriate instance spec modifiers)
      VALID_STATES = %w[started stopped detached recreate restart].freeze

      # @return [String] Instance group name
      attr_accessor :name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#name is a writable attribute</span>          </div>  </li></ol>

      # @return [String] Lifecycle profile
      attr_accessor :lifecycle<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#lifecycle is a writable attribute</span>          </div>  </li></ol>

      # @return [String] Instance group canonical name (mostly for DNS)
      attr_accessor :canonical_name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#canonical_name is a writable attribute</span>          </div>  </li></ol>

      attr_accessor :persistent_disk_collection<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#persistent_disk_collection is a writable attribute</span>          </div>  </li></ol>

      # @return [DeploymentPlan::ReleaseVersion] Release this instance group belongs to
      attr_accessor :release<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#release is a writable attribute</span>          </div>  </li></ol>

      # @return [DeploymentPlan::Stemcell]
      attr_accessor :stemcell<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#stemcell is a writable attribute</span>          </div>  </li></ol>

      # @return [DeploymentPlan::VmType]
      attr_accessor :vm_type<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#vm_type is a writable attribute</span>          </div>  </li></ol>

      # @return [DeploymentPlan::VmResources]
      attr_accessor :vm_resources<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#vm_resources is a writable attribute</span>          </div>  </li></ol>

      # @return [DeploymentPlan::VmExtension]
      attr_accessor :vm_extensions<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#vm_extensions is a writable attribute</span>          </div>  </li></ol>

      # @return [DeploymentPlan::Env]
      attr_accessor :env<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#env is a writable attribute</span>          </div>  </li></ol>

      attr_accessor :default_network<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#default_network is a writable attribute</span>          </div>  </li></ol>

      # @return [Array&lt;DeploymentPlan::Job&gt;] Jobs included on the instance group
      attr_accessor :jobs<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#jobs is a writable attribute</span>          </div>  </li></ol>

      # @return [Hash] Instance group properties
      attr_accessor :properties<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#properties is a writable attribute</span>          </div>  </li></ol>

      # @return [Hash&lt;String, DeploymentPlan::Package&gt;] Packages included on the instance group
      attr_accessor :packages<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#packages is a writable attribute</span>          </div>  </li></ol>

      # @return [DeploymentPlan::UpdateConfig] Instance group update settings
      attr_accessor :update<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#update is a writable attribute</span>          </div>  </li></ol>

      # @return [Array&lt;DeploymentPlan::Instance&gt;] All instances
      attr_accessor :instances<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#instances is a writable attribute</span>          </div>  </li></ol>

      # @return [Array&lt;Models::Instance&gt;] List of excess instance models that
      #   are not needed for current deployment
      attr_accessor :unneeded_instances<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#unneeded_instances is a writable attribute</span>          </div>  </li></ol>

      # @return [String] Expected instance group state
      attr_accessor :state<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#state is a writable attribute</span>          </div>  </li></ol>

      # @return [Hash&lt;Integer, String&gt;] Individual instance expected states
      attr_accessor :instance_states<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#instance_states is a writable attribute</span>          </div>  </li></ol>

      # @return [String] deployment name the instance group belongs to
      attr_accessor :deployment_name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#deployment_name is a writable attribute</span>          </div>  </li></ol>

      attr_accessor :availability_zones<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#availability_zones is a writable attribute</span>          </div>  </li></ol>

      attr_accessor :networks<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#networks is a writable attribute</span>          </div>  </li></ol>

      attr_accessor :migrated_from<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#migrated_from is a writable attribute</span>          </div>  </li></ol>

      attr_accessor :desired_instances<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#desired_instances is a writable attribute</span>          </div>  </li></ol>

      attr_accessor :did_change<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#did_change is a writable attribute</span>          </div>  </li></ol>

      def self.parse(plan, instance_group_spec, event_log, logger, parse_options = {})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#self.parse has 5 parameters</span>          </div>  </li></ol>
        parser = InstanceGroupSpecParser.new(plan, event_log, logger)
        parser.parse(instance_group_spec, parse_options)
      end

      def initialize(logger)
        @logger = logger

        @release = nil
        @jobs = []
        @properties = nil # Actual instance group properties

        @instances = []
        @desired_instances = []
        @unneeded_instances = []
        @instance_states = {}
        @default_network = {}

        @packages = {}
        @migrated_from = []
        @availability_zones = []

        @instance_plans = []

        @did_change = false
        @persistent_disk_collection = PersistentDiskCollection.new(@logger)

        @deployment_name = nil
      end

      def self.legacy_spec?(instance_group_spec)
        !instance_group_spec.key?(&#39;templates&#39;)
      end

      def add_instance_plans(instance_plans)
        @instance_plans = instance_plans
      end

      def sorted_instance_plans
        @sorted_instance_plans ||= InstancePlanSorter.new(@logger)
                                                     .sort(@instance_plans.reject(&amp;:obsolete?))
      end

      def unignored_instance_plans_needing_duplicate_vm<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#unignored_instance_plans_needing_duplicate_vm has a flog score of 26</span>          </div>  </li></ol>
        @shutdown_instances ||= sorted_instance_plans.select { |plan| plan.instance&amp;.vm_created? }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#unignored_instance_plans_needing_duplicate_vm calls 'plan.instance' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L132" class="js-smell-location">0</a>                  <a href="instance_group.html#L136" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#unignored_instance_plans_needing_duplicate_vm performs a nil-check</span>          </div>  </li></ol>
                                                     .select(&amp;:needs_duplicate_vm?)
                                                     .reject(&amp;:new?)
                                                     .reject(&amp;:should_be_ignored?)
                                                     .reject { |plan| plan.instance.state == &#39;detached&#39; }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#unignored_instance_plans_needing_duplicate_vm calls 'plan.instance' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L132" class="js-smell-location">0</a>                  <a href="instance_group.html#L136" class="js-smell-location">1</a>                  </div>  </li></ol>
      end

      def add_job(job_to_add)
        jobs.each do |job|
          if job_to_add.name == job.name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#add_job calls 'job_to_add.name' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L141" class="js-smell-location">0</a>                  <a href="instance_group.html#L142" class="js-smell-location">1</a>                  </div>  </li></ol>
            raise &quot;Colocated job &#39;#{job_to_add.name}&#39; is already added to the instance group &#39;#{name}&#39;.&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#add_job calls 'job_to_add.name' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L141" class="js-smell-location">0</a>                  <a href="instance_group.html#L142" class="js-smell-location">1</a>                  </div>  </li></ol>
          end
        end
        jobs &lt;&lt; job_to_add
      end

      # Takes in a job spec and returns a job spec in the new format, if it
      # needs to be modified.  The new format has &quot;templates&quot; key, which is an
      # array with each template&#39;s data.  This is used for job collocation,
      # specifically for the agent&#39;s current job spec when compared to the
      # director&#39;s.  We only convert their template to a single array entry
      # because it should be impossible for the agent to have a job spec with
      # multiple templates in legacy form.
      def self.convert_from_legacy_spec(job_spec)
        return job_spec unless legacy_spec?(job_spec)
        job = {
          &#39;name&#39; =&gt; job_spec[&#39;template&#39;],
          &#39;version&#39; =&gt; job_spec[&#39;version&#39;],
          &#39;sha1&#39; =&gt; job_spec[&#39;sha1&#39;],
          &#39;blobstore_id&#39; =&gt; job_spec[&#39;blobstore_id&#39;],
        }

        # Supporting &#39;template_scoped_properties&#39; for legacy spec is going to be messy.
        # So we will support this feature if a user want to use legacy spec. If they
        # want to use properties per template, let them use the regular way of defining
        # templates, i.e. by using the &#39;templates&#39; key
        job_spec[&#39;templates&#39;] = [job]
      end

      def obsolete_instance_plans
        @instance_plans.select(&amp;:obsolete?)
      end

      # to preserve interface for UpdateStage -- switch to instance_plans eventually
      def instances
        needed_instance_plans.map(&amp;:instance)
      end

      def unignored_instance_plans
        needed_instance_plans.reject(&amp;:should_be_ignored?)
      end

      def vm_strategy
        update&amp;.vm_strategy<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#vm_strategy performs a nil-check</span>          </div>  </li></ol>
      end

      def create_swap_delete?
        vm_strategy == UpdateConfig::VM_STRATEGY_CREATE_SWAP_DELETE
      end

      def should_create_swap_delete?
        Array(networks).none?(&amp;:static?) &amp;&amp; create_swap_delete?
      end

      def needed_instance_plans
        sorted_instance_plans
      end

      def unneeded_instances
        obsolete_instance_plans.map(&amp;:instance)
      end

      # Returns instance group spec as a Hash. To be used by all instances to
      # populate agent state.
      # @return [Hash] Hash representation
      def spec<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec has approx 10 statements</span>          </div>  </li></ol>
        result = { &#39;name&#39; =&gt; @name }

        return nil if @jobs.empty?

        first_job = @jobs[0]
        result.merge!(
          &#39;templates&#39; =&gt; [],
          # --- Legacy ---
          &#39;template&#39; =&gt; first_job.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'first_job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L216" class="js-smell-location">0</a>                  <a href="instance_group.html#L217" class="js-smell-location">1</a>                  <a href="instance_group.html#L218" class="js-smell-location">2</a>                  <a href="instance_group.html#L219" class="js-smell-location">3</a>                  <a href="instance_group.html#L222" class="js-smell-location">4</a>                  </div>  </li></ol>
          &#39;version&#39; =&gt; first_job.version,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'first_job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L216" class="js-smell-location">0</a>                  <a href="instance_group.html#L217" class="js-smell-location">1</a>                  <a href="instance_group.html#L218" class="js-smell-location">2</a>                  <a href="instance_group.html#L219" class="js-smell-location">3</a>                  <a href="instance_group.html#L222" class="js-smell-location">4</a>                  </div>  </li></ol>
          &#39;sha1&#39; =&gt; first_job.sha1,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'first_job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L216" class="js-smell-location">0</a>                  <a href="instance_group.html#L217" class="js-smell-location">1</a>                  <a href="instance_group.html#L218" class="js-smell-location">2</a>                  <a href="instance_group.html#L219" class="js-smell-location">3</a>                  <a href="instance_group.html#L222" class="js-smell-location">4</a>                  </div>  </li></ol>
          &#39;blobstore_id&#39; =&gt; first_job.blobstore_id,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'first_job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L216" class="js-smell-location">0</a>                  <a href="instance_group.html#L217" class="js-smell-location">1</a>                  <a href="instance_group.html#L218" class="js-smell-location">2</a>                  <a href="instance_group.html#L219" class="js-smell-location">3</a>                  <a href="instance_group.html#L222" class="js-smell-location">4</a>                  </div>  </li></ol>
        )

        result[&#39;logs&#39;] = first_job.logs if first_job.logs<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec calls 'first_job.logs' 2 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'first_job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L216" class="js-smell-location">0</a>                  <a href="instance_group.html#L217" class="js-smell-location">1</a>                  <a href="instance_group.html#L218" class="js-smell-location">2</a>                  <a href="instance_group.html#L219" class="js-smell-location">3</a>                  <a href="instance_group.html#L222" class="js-smell-location">4</a>                  </div>  </li></ol>
        # --- /Legacy ---

        @jobs.each do |job|
          job_entry = {
            &#39;name&#39; =&gt; job.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L227" class="js-smell-location">0</a>                  <a href="instance_group.html#L228" class="js-smell-location">1</a>                  <a href="instance_group.html#L229" class="js-smell-location">2</a>                  <a href="instance_group.html#L230" class="js-smell-location">3</a>                  <a href="instance_group.html#L233" class="js-smell-location">4</a>                  </div>  </li></ol>
            &#39;version&#39; =&gt; job.version,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L227" class="js-smell-location">0</a>                  <a href="instance_group.html#L228" class="js-smell-location">1</a>                  <a href="instance_group.html#L229" class="js-smell-location">2</a>                  <a href="instance_group.html#L230" class="js-smell-location">3</a>                  <a href="instance_group.html#L233" class="js-smell-location">4</a>                  </div>  </li></ol>
            &#39;sha1&#39; =&gt; job.sha1,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L227" class="js-smell-location">0</a>                  <a href="instance_group.html#L228" class="js-smell-location">1</a>                  <a href="instance_group.html#L229" class="js-smell-location">2</a>                  <a href="instance_group.html#L230" class="js-smell-location">3</a>                  <a href="instance_group.html#L233" class="js-smell-location">4</a>                  </div>  </li></ol>
            &#39;blobstore_id&#39; =&gt; job.blobstore_id,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L227" class="js-smell-location">0</a>                  <a href="instance_group.html#L228" class="js-smell-location">1</a>                  <a href="instance_group.html#L229" class="js-smell-location">2</a>                  <a href="instance_group.html#L230" class="js-smell-location">3</a>                  <a href="instance_group.html#L233" class="js-smell-location">4</a>                  </div>  </li></ol>
          }

          job_entry[&#39;logs&#39;] = job.logs if job.logs<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec calls 'job.logs' 2 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#spec refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L227" class="js-smell-location">0</a>                  <a href="instance_group.html#L228" class="js-smell-location">1</a>                  <a href="instance_group.html#L229" class="js-smell-location">2</a>                  <a href="instance_group.html#L230" class="js-smell-location">3</a>                  <a href="instance_group.html#L233" class="js-smell-location">4</a>                  </div>  </li></ol>
          result[&#39;templates&#39;] &lt;&lt; job_entry
        end
        result
      end

      def update_spec
        update.to_hash
      end

      # Returns package specs for all packages in the instances indexed by package
      # name. To be used by all instances to populate agent state.
      # @return [Hash&lt;String, Hash&gt;] All package specs indexed by package name
      def package_spec
        result = {}
        @packages.each do |name, package|
          result[name] = package.spec
        end

        result.select { |name, _| run_time_dependencies.include? name }
      end

      def instance(index)
        @instances[index]
      end

      # Returns the state of an instance by its index
      # @param [Integer] index Instance index
      # @return [String, nil] Instance state (nil if not specified)
      def state_for_instance(instance_model)
        @instance_states[instance_model.uuid] || @instance_states[instance_model.index.to_s] || @state
      end

      # Registers compiled package with this instance.
      # @param [Models::CompiledPackage] compiled_package_model Compiled package
      # @return [void]
      def use_compiled_package(compiled_package_model)
        compiled_package = CompiledPackage.new(compiled_package_model)
        @packages[compiled_package.name] = compiled_package
      end

      # Extracts only the properties needed by this instance group. This is decoupled from
      # parsing properties because templates need to be bound to their models
      # before &#39;bind_properties&#39; is being called (as we persist instance group template
      # property definitions in DB).
      def bind_properties
        @properties = {}

        options = {
          dns_record_names: get_dns_record_names,
        }

        @jobs.each do |job|
          job.bind_properties(@name, @deployment_name, options)
          @properties[job.name] = job.properties[@name]
        end
      end

      def validate_package_names_do_not_collide!<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! has a flog score of 65</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Prima-Donna-Method.md" target="_blank"><b>PrimaDonnaMethod</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup has prima donna method 'validate_package_names_do_not_collide!'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! has approx 13 statements</span>          </div>  </li></ol>
        releases_by_package_names = {}

        jobs.each do |job|
          job.model.package_names.each do |package_name|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'job.model' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L295" class="js-smell-location">0</a>                  <a href="instance_group.html#L296" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L295" class="js-smell-location">0</a>                  <a href="instance_group.html#L296" class="js-smell-location">1</a>                  <a href="instance_group.html#L305" class="js-smell-location">2</a>                  <a href="instance_group.html#L306" class="js-smell-location">3</a>                  </div>  </li></ol>
            package = job.model.release.packages.find { |p| p.name == package_name }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'job.model' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L295" class="js-smell-location">0</a>                  <a href="instance_group.html#L296" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L295" class="js-smell-location">0</a>                  <a href="instance_group.html#L296" class="js-smell-location">1</a>                  <a href="instance_group.html#L305" class="js-smell-location">2</a>                  <a href="instance_group.html#L306" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! contains iterators nested 3 deep</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! has the variable name 'p'</span>          </div>  </li></ol>

            releases_by_package_names[package_name] ||= {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'releases_by_package_names[package_name]' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L298" class="js-smell-location">0</a>                  <a href="instance_group.html#L302" class="js-smell-location">1</a>                  </div>  </li></ol>
              usages: [],
            }

            releases_by_package_names[package_name][:usages] &lt;&lt; {<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'releases_by_package_names[package_name]' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L298" class="js-smell-location">0</a>                  <a href="instance_group.html#L302" class="js-smell-location">1</a>                  </div>  </li></ol>
              fingerprint: package.fingerprint,
              dependency_set_json: package.dependency_set_json,
              release: job.release.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L295" class="js-smell-location">0</a>                  <a href="instance_group.html#L296" class="js-smell-location">1</a>                  <a href="instance_group.html#L305" class="js-smell-location">2</a>                  <a href="instance_group.html#L306" class="js-smell-location">3</a>                  </div>  </li></ol>
              job: job.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! refers to 'job' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_group.html#L295" class="js-smell-location">0</a>                  <a href="instance_group.html#L296" class="js-smell-location">1</a>                  <a href="instance_group.html#L305" class="js-smell-location">2</a>                  <a href="instance_group.html#L306" class="js-smell-location">3</a>                  </div>  </li></ol>
            }
          end
        end

        releases_by_package_names.each do |package_name, packages|
          releases = packages[:usages].group_by { |u| u[:fingerprint] + u[:dependency_set_json] }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! contains iterators nested 2 deep</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! has the variable name 'u'</span>          </div>  </li></ol>

          next unless releases.size &gt; 1
          release1jobs, release2jobs = releases.values[0..1]

          raise JobPackageCollision,
                &quot;Package name collision detected in instance group &#39;#{@name}&#39;: &quot; \
                    &quot;job &#39;#{release1jobs[0][:release]}/#{release1jobs[0][:job]}&#39; &quot; \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release1jobs[0]' 3 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L319" class="js-smell-location">0</a>                  <a href="instance_group.html#L320" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release1jobs[0][:release]' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L319" class="js-smell-location">0</a>                  <a href="instance_group.html#L320" class="js-smell-location">1</a>                  </div>  </li></ol>
                    &quot;depends on package &#39;#{release1jobs[0][:release]}/#{package_name}&#39;, &quot; \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release1jobs[0]' 3 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L319" class="js-smell-location">0</a>                  <a href="instance_group.html#L320" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release1jobs[0][:release]' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L319" class="js-smell-location">0</a>                  <a href="instance_group.html#L320" class="js-smell-location">1</a>                  </div>  </li></ol>
                    &quot;job &#39;#{release2jobs[0][:release]}/#{release2jobs[0][:job]}&#39; &quot; \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release2jobs[0]' 3 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L321" class="js-smell-location">0</a>                  <a href="instance_group.html#L322" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release2jobs[0][:release]' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L321" class="js-smell-location">0</a>                  <a href="instance_group.html#L322" class="js-smell-location">1</a>                  </div>  </li></ol>
                    &quot;depends on &#39;#{release2jobs[0][:release]}/#{package_name}&#39;. &quot; \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release2jobs[0]' 3 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L321" class="js-smell-location">0</a>                  <a href="instance_group.html#L322" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#validate_package_names_do_not_collide! calls 'release2jobs[0][:release]' 2 times</span>              <span>Locations:</span>                  <a href="instance_group.html#L321" class="js-smell-location">0</a>                  <a href="instance_group.html#L322" class="js-smell-location">1</a>                  </div>  </li></ol>
                &#39;BOSH cannot currently collocate two packages with identical names from separate releases.&#39;
        end
      end

      def bind_instances(ip_provider)
        instances.each(&amp;:ensure_model_bound)
        bind_instance_networks(ip_provider)
      end

      # TODO: Instance group should not be responsible for reserving IPs.
      # Consider moving this somewhere else? Maybe in the consumer?
      def bind_instance_networks(ip_provider)
        needed_instance_plans
          .flat_map(&amp;:network_plans)
          .reject(&amp;:obsolete?)
          .reject(&amp;:existing?)
          .each do |network_plan|
          reservation = network_plan.reservation
          ip_provider.reserve(reservation)
        end
      end

      def bind_new_variable_set(new_variable_set)
        unignored_instance_plans.each do |instance_plan|
          instance_plan.instance.desired_variable_set = new_variable_set
        end
      end

      def network_present?(network_name)
        networks.any? do |network|
          network.name == network_name
        end
      end

      def service?
        @lifecycle == &#39;service&#39;
      end

      def errand?
        @lifecycle == &#39;errand&#39;
      end

      def instance_plans_with_missing_vms
        needed_instance_plans.reject do |instance_plan|
          instance_plan.instance.vm_created? || instance_plan.instance.state == &#39;detached&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#instance_plans_with_missing_vms calls 'instance_plan.instance' 2 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#instance_plans_with_missing_vms refers to 'instance_plan' more than self (maybe move it to another class?)</span>          </div>  </li></ol>
        end
      end

      def compilation?
        false
      end

      def has_job?(name, release)
        @jobs.any? { |job| job.name == name &amp;&amp; job.release.name == release }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#has_job? is controlled by argument 'name'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::InstanceGroup#has_job? refers to 'job' more than self (maybe move it to another class?)</span>          </div>  </li></ol>
      end

      def has_os?(os)
        @stemcell.os == os
      end

      # @return [Array&lt;Models::VariableSet&gt;] All variable sets of NON-obsolete instance_plan instances
      def referenced_variable_sets
        needed_instance_plans.map do |instance_plan|
          instance_plan.instance.desired_variable_set
        end
      end

      def default_network_name
        @default_network[&#39;addressable&#39;] || @default_network[&#39;gateway&#39;]
      end

      def has_availability_zone?(az_name)
        availability_zones.any? do |availability_zone|
          availability_zone.name == az_name
        end
      end

      private

      def run_time_dependencies
        jobs.flat_map(&amp;:package_models).uniq.map(&amp;:name)
      end

      def get_dns_record_names
        result = []
        networks.map(&amp;:name).each do |network_name|
          result &lt;&lt; DnsNameGenerator.dns_record_name(&#39;*&#39;, @name, network_name, @deployment_name, Config.root_domain)
        end
        result.sort
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
