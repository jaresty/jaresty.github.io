<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-05-31 14:40:48 -0400'>2018-05-31 14:40:48 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh/director/deployment_plan /</small> assembler.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">265</span><small> lines of codes</small></div>
              <div><span class="metric">16</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">14.1</span><small> complexity/method</small></div>
              <div><span class="metric">202</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">226.12</span><small> complexity</small></div>
              <div><span class="metric">0</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                22
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">module Bosh::Director
  # DeploymentPlan::Assembler is used to populate deployment plan with information
  # about existing deployment and information from director DB
  class DeploymentPlan::Assembler<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler has at least 5 instance variables</span>          </div>  </li></ol>
    include LockHelper
    include IpUtil
    include LegacyDeploymentHelper

    def self.create(deployment_plan)
      new(deployment_plan, Api::StemcellManager.new, PowerDnsManagerProvider.create)
    end

    def initialize(deployment_plan, stemcell_manager, powerdns_manager)
      @deployment_plan = deployment_plan
      @logger = Config.logger
      @stemcell_manager = stemcell_manager
      @powerdns_manager = powerdns_manager
      @links_manager = Bosh::Director::Links::LinksManager.new(deployment_plan.model.links_serial_id)
    end

    def bind_models(options = {})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_models has a flog score of 70</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_models has approx 43 statements</span>          </div>  </li></ol>
      @logger.info(&#39;Binding models&#39;)

      is_deploy_action = options.fetch(:is_deploy_action, false)
      should_bind_links = is_deploy_action &amp;&amp; options.fetch(:should_bind_links, true)
      should_bind_properties = options.fetch(:should_bind_properties, true)
      should_bind_new_variable_set = options.fetch(:should_bind_new_variable_set, false)
      deployment_options = @deployment_plan.deployment_wide_options
      fix = deployment_options.fetch(:fix, false)
      tags = deployment_options.fetch(:tags, {})
      instances = options.fetch(:instances, @deployment_plan.candidate_existing_instances)

      bind_releases
      bind_stemcells

      migrate_legacy_dns_records

      network_reservation_repository = Bosh::Director::DeploymentPlan::NetworkReservationRepository.new(@deployment_plan, @logger)
      states_by_existing_instance = current_states_by_instance(instances, fix)

      migrate_existing_instances_to_global_networking(network_reservation_repository, states_by_existing_instance)

      instance_repo = Bosh::Director::DeploymentPlan::InstanceRepository.new(network_reservation_repository, @logger)
      index_assigner = Bosh::Director::DeploymentPlan::PlacementPlanner::IndexAssigner.new(@deployment_plan.model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_models calls '@deployment_plan.model' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L44" class="js-smell-location">0</a>                  <a href="assembler.html#L64" class="js-smell-location">1</a>                  <a href="assembler.html#L65" class="js-smell-location">2</a>                  </div>  </li></ol>
      instance_plan_factory = Bosh::Director::DeploymentPlan::InstancePlanFactory.new(
        instance_repo,
        states_by_existing_instance,
        @deployment_plan.skip_drain,
        index_assigner,
        network_reservation_repository,
        &#39;recreate&#39; =&gt; @deployment_plan.recreate,
        &#39;use_dns_addresses&#39; =&gt; @deployment_plan.use_dns_addresses?,
        &#39;use_short_dns_addresses&#39; =&gt; @deployment_plan.use_short_dns_addresses?,
        &#39;randomize_az_placement&#39; =&gt; @deployment_plan.randomize_az_placement?,
        &#39;tags&#39; =&gt; tags,
      )
      instance_planner = Bosh::Director::DeploymentPlan::InstancePlanner.new(instance_plan_factory, @logger)
      desired_instance_groups = @deployment_plan.instance_groups

      job_migrator = Bosh::Director::DeploymentPlan::JobMigrator.new(@deployment_plan, @logger)

      desired_instance_groups.each do |desired_instance_group|
        unless desired_instance_group.migrated_from.to_a.empty?
          @links_manager.migrate_links_provider_instance_group(@deployment_plan.model, desired_instance_group)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_models calls '@deployment_plan.model' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L44" class="js-smell-location">0</a>                  <a href="assembler.html#L64" class="js-smell-location">1</a>                  <a href="assembler.html#L65" class="js-smell-location">2</a>                  </div>  </li></ol>
          @links_manager.migrate_links_consumer_instance_group(@deployment_plan.model, desired_instance_group)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_models calls '@deployment_plan.model' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L44" class="js-smell-location">0</a>                  <a href="assembler.html#L64" class="js-smell-location">1</a>                  <a href="assembler.html#L65" class="js-smell-location">2</a>                  </div>  </li></ol>
        end

        desired_instances = desired_instance_group.desired_instances
        existing_instances = job_migrator.find_existing_instances(desired_instance_group)
        instance_plans = instance_planner.plan_instance_group_instances(
          desired_instance_group,
          desired_instances,
          existing_instances,
          @deployment_plan.vm_resources_cache,
        )
        instance_planner.orphan_unreusable_vms(instance_plans, existing_instances)
        instance_planner.reconcile_network_plans(instance_plans)
        desired_instance_group.add_instance_plans(instance_plans)

        desired_instance_group.unignored_instance_plans.each do |instance_plan|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_models contains iterators nested 2 deep</span>          </div>  </li></ol>
          instance_plan.instance.is_deploy_action = is_deploy_action
        end
      end

      instance_plans_for_obsolete_instance_groups = instance_planner.plan_obsolete_instance_groups(desired_instance_groups, @deployment_plan.existing_instances)
      @deployment_plan.mark_instance_plans_for_deletion(instance_plans_for_obsolete_instance_groups)

      bind_templates
      bind_properties if should_bind_properties
      bind_new_variable_set if should_bind_new_variable_set # should_bind_new is true when doing deploy action
      bind_instance_networks
      resolve_network_plans_for_create_swap_deleted_instances(desired_instance_groups)
      bind_instance_networks
      bind_dns
      bind_links if should_bind_links
      generate_variables if is_deploy_action
    end

    private

    def bind_new_variable_set
      current_variable_set = @deployment_plan.model.current_variable_set

      @deployment_plan.instance_groups.each do |instance_group|
        instance_group.bind_new_variable_set(current_variable_set)
      end
    end

    # Binds release DB record(s) to a plan
    # @return [void]
    def bind_releases
      releases = @deployment_plan.releases
      with_release_locks(releases.map(&amp;:name)) do
        releases.each do |release|
          release.bind_model
        end
      end
    end

    def current_states_by_instance(existing_instances, fix = false)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#current_states_by_instance has a flog score of 32</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Boolean-Parameter.md" target="_blank"><b>BooleanParameter</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#current_states_by_instance has boolean parameter 'fix'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#current_states_by_instance has approx 14 statements</span>          </div>  </li></ol>
      lock = Mutex.new
      current_states_by_existing_instance = {}
      is_version_1_manifest = ignore_cloud_config?(@deployment_plan.uninterpolated_manifest_hash)

      ThreadPool.new(:max_threads =&gt; Config.max_threads).wrap do |pool|
        existing_instances.each do |existing_instance|
          if existing_instance.vm_cid &amp;&amp; (!existing_instance.ignore || is_version_1_manifest)
            pool.process do
              with_thread_name(&quot;binding agent state for (#{existing_instance}&quot;) do
                # getting current state to obtain IP of dynamic networks
                begin
                  state = DeploymentPlan::AgentStateMigrator.new(@logger).get_state(existing_instance)
                rescue Bosh::Director::RpcTimeout, Bosh::Director::RpcRemoteException =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#current_states_by_instance has the variable name 'e'</span>          </div>  </li></ol>
                  if fix<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Control-Parameter.md" target="_blank"><b>ControlParameter</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#current_states_by_instance is controlled by argument 'fix'</span>          </div>  </li></ol>
                    state = {&#39;job_state&#39; =&gt; &#39;unresponsive&#39;}
                  else
                    raise e, &quot;#{existing_instance.name}: #{e.message}&quot;
                  end
                end
                lock.synchronize do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#current_states_by_instance contains iterators nested 2 deep</span>          </div>  </li></ol>
                  current_states_by_existing_instance.merge!(existing_instance =&gt; state)
                end
              end
            end
          end
        end
      end
      current_states_by_existing_instance
    end

    def bind_instance_networks
      # CHANGEME: something about instance plan&#39;s new network plans
      @deployment_plan.instance_groups_starting_on_deploy.each do |instance_group|
        instance_group.bind_instance_networks(@deployment_plan.ip_provider)
      end
    end

    def bind_links
      @links_manager.update_provider_intents_contents(@deployment_plan.model.link_providers, @deployment_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_links calls '@deployment_plan.model' 5 times</span>              <span>Locations:</span>                  <a href="assembler.html#L159" class="js-smell-location">0</a>                  <a href="assembler.html#L166" class="js-smell-location">1</a>                  <a href="assembler.html#L167" class="js-smell-location">2</a>                  <a href="assembler.html#L168" class="js-smell-location">3</a>                  <a href="assembler.html#L169" class="js-smell-location">4</a>                  </div>  </li></ol>

      resolve_link_options = {
        dry_run: false,
        global_use_dns_entry: @deployment_plan.use_dns_addresses?
      }

      @links_manager.resolve_deployment_links(@deployment_plan.model, resolve_link_options)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_links calls '@deployment_plan.model' 5 times</span>              <span>Locations:</span>                  <a href="assembler.html#L159" class="js-smell-location">0</a>                  <a href="assembler.html#L166" class="js-smell-location">1</a>                  <a href="assembler.html#L167" class="js-smell-location">2</a>                  <a href="assembler.html#L168" class="js-smell-location">3</a>                  <a href="assembler.html#L169" class="js-smell-location">4</a>                  </div>  </li></ol>
      if @deployment_plan.model.has_stale_errand_links<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_links calls '@deployment_plan.model' 5 times</span>              <span>Locations:</span>                  <a href="assembler.html#L159" class="js-smell-location">0</a>                  <a href="assembler.html#L166" class="js-smell-location">1</a>                  <a href="assembler.html#L167" class="js-smell-location">2</a>                  <a href="assembler.html#L168" class="js-smell-location">3</a>                  <a href="assembler.html#L169" class="js-smell-location">4</a>                  </div>  </li></ol>
        @deployment_plan.model.has_stale_errand_links = false<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_links calls '@deployment_plan.model' 5 times</span>              <span>Locations:</span>                  <a href="assembler.html#L159" class="js-smell-location">0</a>                  <a href="assembler.html#L166" class="js-smell-location">1</a>                  <a href="assembler.html#L167" class="js-smell-location">2</a>                  <a href="assembler.html#L168" class="js-smell-location">3</a>                  <a href="assembler.html#L169" class="js-smell-location">4</a>                  </div>  </li></ol>
        @deployment_plan.model.save<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_links calls '@deployment_plan.model' 5 times</span>              <span>Locations:</span>                  <a href="assembler.html#L159" class="js-smell-location">0</a>                  <a href="assembler.html#L166" class="js-smell-location">1</a>                  <a href="assembler.html#L167" class="js-smell-location">2</a>                  <a href="assembler.html#L168" class="js-smell-location">3</a>                  <a href="assembler.html#L169" class="js-smell-location">4</a>                  </div>  </li></ol>
      end
    end

    def generate_variables
      config_server_client = Bosh::Director::ConfigServer::ClientFactory.create(@logger).create_client
      config_server_client.generate_values(@deployment_plan.variables, @deployment_plan.name, @deployment_plan.features.converge_variables)
    end

    # Binds template models for each release spec in the deployment plan
    # @return [void]
    def bind_templates
      @deployment_plan.releases.each do |release|
        release.bind_templates
      end

      @deployment_plan.instance_groups.each do |job|
        job.validate_package_names_do_not_collide!
      end
    end

    # Binds properties for all templates in the deployment
    # @return [void]
    def bind_properties
      @deployment_plan.instance_groups.each do |instance_group|
        instance_group.bind_properties
      end
    end

    # Binds stemcell model for each stemcell spec in
    # the deployment plan
    # @return [void]
    def bind_stemcells<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells has approx 7 statements</span>          </div>  </li></ol>
      if @deployment_plan.resource_pools &amp;&amp; @deployment_plan.resource_pools.any?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells calls '@deployment_plan.resource_pools' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L202" class="js-smell-location">0</a>                  <a href="assembler.html#L203" class="js-smell-location">1</a>                  </div>  </li></ol>
        @deployment_plan.resource_pools.each do |resource_pool|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells calls '@deployment_plan.resource_pools' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L202" class="js-smell-location">0</a>                  <a href="assembler.html#L203" class="js-smell-location">1</a>                  </div>  </li></ol>
          stemcell = resource_pool.stemcell

          if stemcell.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells performs a nil-check</span>          </div>  </li></ol>
            raise DirectorError,
              &quot;Stemcell not bound for resource pool &#39;#{resource_pool.name}&#39;&quot;
          end

          stemcell.bind_model(@deployment_plan.model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells calls '@deployment_plan.model' 2 times</span>              <span>Locations:</span>                  <a href="assembler.html#L211" class="js-smell-location">0</a>                  <a href="assembler.html#L217" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells calls 'stemcell.bind_model(@deployment_plan.model)' 2 times</span>              <span>Locations:</span>                  <a href="assembler.html#L211" class="js-smell-location">0</a>                  <a href="assembler.html#L217" class="js-smell-location">1</a>                  </div>  </li></ol>
        end
        return
      end

      @deployment_plan.stemcells.each do |_, stemcell|
        stemcell.bind_model(@deployment_plan.model)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells calls '@deployment_plan.model' 2 times</span>              <span>Locations:</span>                  <a href="assembler.html#L211" class="js-smell-location">0</a>                  <a href="assembler.html#L217" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#bind_stemcells calls 'stemcell.bind_model(@deployment_plan.model)' 2 times</span>              <span>Locations:</span>                  <a href="assembler.html#L211" class="js-smell-location">0</a>                  <a href="assembler.html#L217" class="js-smell-location">1</a>                  </div>  </li></ol>
      end
    end

    def bind_dns
      @powerdns_manager.configure_nameserver
    end

    def migrate_legacy_dns_records
      @deployment_plan.instance_models.each do |instance_model|
        @powerdns_manager.migrate_legacy_records(instance_model)
      end
    end

    def migrate_existing_instances_to_global_networking(network_reservation_repository, states_by_existing_instance)
      return unless @deployment_plan.using_global_networking?

      # in the case where this is their first transition to global networking, we need to make sure we have already
      # populated the database/models with the existing IPs. Do this first before we start any of our planning.
      @deployment_plan.instance_models.each do |existing_instance|
        network_reservation_repository.migrate_existing_instance_network_reservations(
          existing_instance,
          states_by_existing_instance[existing_instance]
        )
      end
    end

    def resolve_network_plans_for_create_swap_deleted_instances(desired_instance_groups)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances has a flog score of 32</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances has approx 11 statements</span>          </div>  </li></ol>
      network_planner = DeploymentPlan::NetworkPlanner::Planner.new(@logger)

      desired_instance_groups.each do |desired_instance_group|
        desired_instance_group.sorted_instance_plans.each do |desired_instance_plan|
          next unless desired_instance_plan.should_create_swap_delete? &amp;&amp; desired_instance_plan.recreate_for_non_network_reasons?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances refers to 'desired_instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="assembler.html#L249" class="js-smell-location">0</a>                  <a href="assembler.html#L250" class="js-smell-location">1</a>                  <a href="assembler.html#L254" class="js-smell-location">2</a>                  <a href="assembler.html#L257" class="js-smell-location">3</a>                  </div>  </li></ol>
          next unless desired_instance_plan.network_plans.select(&amp;:desired?).empty?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances calls 'desired_instance_plan.network_plans' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L250" class="js-smell-location">0</a>                  <a href="assembler.html#L254" class="js-smell-location">1</a>                  <a href="assembler.html#L257" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances refers to 'desired_instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="assembler.html#L249" class="js-smell-location">0</a>                  <a href="assembler.html#L250" class="js-smell-location">1</a>                  <a href="assembler.html#L254" class="js-smell-location">2</a>                  <a href="assembler.html#L257" class="js-smell-location">3</a>                  </div>  </li></ol>

          desired_instance_group.networks.each do |network|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances contains iterators nested 3 deep</span>              <span>Locations:</span>                  <a href="assembler.html#L252" class="js-smell-location">0</a>                  <a href="assembler.html#L257" class="js-smell-location">1</a>                  </div>  </li></ol>
            plan = network_planner.network_plan_with_dynamic_reservation(desired_instance_plan, network)
            desired_instance_plan.network_plans &lt;&lt; plan<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances calls 'desired_instance_plan.network_plans' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L250" class="js-smell-location">0</a>                  <a href="assembler.html#L254" class="js-smell-location">1</a>                  <a href="assembler.html#L257" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances refers to 'desired_instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="assembler.html#L249" class="js-smell-location">0</a>                  <a href="assembler.html#L250" class="js-smell-location">1</a>                  <a href="assembler.html#L254" class="js-smell-location">2</a>                  <a href="assembler.html#L257" class="js-smell-location">3</a>                  </div>  </li></ol>
          end

          desired_instance_plan.network_plans.select(&amp;:existing?).each do |network_plan|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances calls 'desired_instance_plan.network_plans' 3 times</span>              <span>Locations:</span>                  <a href="assembler.html#L250" class="js-smell-location">0</a>                  <a href="assembler.html#L254" class="js-smell-location">1</a>                  <a href="assembler.html#L257" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances refers to 'desired_instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="assembler.html#L249" class="js-smell-location">0</a>                  <a href="assembler.html#L250" class="js-smell-location">1</a>                  <a href="assembler.html#L254" class="js-smell-location">2</a>                  <a href="assembler.html#L257" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::DeploymentPlan::Assembler#resolve_network_plans_for_create_swap_deleted_instances contains iterators nested 3 deep</span>              <span>Locations:</span>                  <a href="assembler.html#L252" class="js-smell-location">0</a>                  <a href="assembler.html#L257" class="js-smell-location">1</a>                  </div>  </li></ol>
            network_plan.existing = false
            network_plan.obsolete = true
          end
        end
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
