<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../overview.html"><img src="../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-04-10 15:34:33 -0700'>2018-04-10 15:34:33 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh/director/jobs /</small> update_release.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating f big">
              F
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">705</span><small> lines of codes</small></div>
              <div><span class="metric">36</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">19.7</span><small> complexity/method</small></div>
              <div><span class="metric">142</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">709.75</span><small> complexity</small></div>
              <div><span class="metric">252</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                127
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;securerandom&#39;
require &#39;common/version/release_version&#39;

module Bosh::Director
  module Jobs
    class UpdateRelease &lt; BaseJob<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@commit_hash'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@compiled_release'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@manifest'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@name'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@packages_folder'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@release_model'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@release_version_model'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@uncommitted_changes'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease assumes too much for instance variable '@version'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease has at least 17 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease has at least 35 methods</span>          </div>  </li></ol>
      include LockHelper
      include DownloadHelper

      @queue = :normal
      @local_fs = true

      @compiled_release = false

      attr_accessor :release_model<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#release_model is a writable attribute</span>          </div>  </li></ol>
      attr_reader :release_path, :release_url, :sha1

      def self.job_type
        :update_release
      end

      # @param [String] release_path local path or remote url of the release archive
      # @param [Hash] options Release update options
      def initialize(release_path, options = {})
        if options[&#39;remote&#39;]
          # file will be downloaded to the release_path
          @release_path = File.join(Dir.tmpdir, &quot;release-#{SecureRandom.uuid}&quot;)
          @release_url = release_path
          @sha1 = options[&#39;sha1&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease has the variable name '@sha1'</span>          </div>  </li></ol>
        else
          # file already exists at the release_path
          @release_path = release_path
        end
        @multi_digest_verifier = BoshDigest::MultiDigest.new(logger)
        @rebase = !!options[&#39;rebase&#39;]
        @fix = !!options[&#39;fix&#39;]
      end

      # Extracts release tarball, verifies release manifest and saves release in DB
      # @return [void]
      def perform<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#perform has a flog score of 32</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#perform has approx 17 statements</span>          </div>  </li></ol>
        logger.info(&quot;Processing update release&quot;)
        logger.info(&quot;Release rebase will be performed&quot;) if @rebase

        single_step_stage(&quot;Downloading remote release&quot;) { download_remote_release } if release_url

        single_step_stage(&quot;Verifying remote release&quot;) { verify_sha } if sha1

        release_dir = nil
        single_step_stage(&quot;Extracting release&quot;) { release_dir = extract_release }

        single_step_stage(&quot;Verifying manifest&quot;) { verify_manifest(release_dir) }

        with_release_lock(@name) { process_release(release_dir) }

        &quot;Created release &#39;#{@name}/#{@version}&#39;&quot;

      rescue Exception =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#perform has the variable name 'e'</span>          </div>  </li></ol>
        raise e

      ensure
        FileUtils.rm_rf(release_dir) if release_dir
        FileUtils.rm_rf(release_path) if release_path
      end

      def download_remote_release
        download_remote_file(&#39;release&#39;, release_url, release_path)
      end

      # Extracts release tarball
      # @return [void]
      def extract_release<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#extract_release has approx 6 statements</span>          </div>  </li></ol>
        release_dir = Dir.mktmpdir

        result = Bosh::Exec.sh(&quot;tar -C #{release_dir} -xzf #{release_path} 2&gt;&amp;1&quot;, :on_error =&gt; :return)
        if result.failed?
          logger.error(&quot;Failed to extract release archive &#39;#{release_path}&#39; into dir &#39;#{release_dir}&#39;, tar returned #{result.exit_status}, output: #{result.output})&quot;)
          FileUtils.rm_rf(release_dir)
          raise ReleaseInvalidArchive, &quot;Extracting release archive failed. Check task debug log for details.&quot;
        end

        release_dir
      end

      # @param [String] release_dir local path to the unpacked release
      # @return [void]
      def verify_manifest(release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#verify_manifest has a flog score of 29</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#verify_manifest has approx 13 statements</span>          </div>  </li></ol>
        manifest_file = File.join(release_dir, &quot;release.MF&quot;)
        raise ReleaseManifestNotFound, &quot;Release manifest not found&quot; unless File.file?(manifest_file)

        @manifest = YAML.load_file(manifest_file)

        #handle compiled_release case
        @compiled_release = !!@manifest[&quot;compiled_packages&quot;]
        @packages_folder = @compiled_release ? &quot;compiled_packages&quot; : &quot;packages&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@compiled_release' at least 5 times</span>              <span>Locations:</span>                  <a href="update_release.html#L95" class="js-smell-location">0</a>                  <a href="update_release.html#L159" class="js-smell-location">1</a>                  <a href="update_release.html#L274" class="js-smell-location">2</a>                  <a href="update_release.html#L360" class="js-smell-location">3</a>                  <a href="update_release.html#L468" class="js-smell-location">4</a>                  </div>  </li></ol>

        normalize_manifest

        @name = @manifest[&quot;name&quot;]

        begin
          @version = Bosh::Common::Version::ReleaseVersion.parse(@manifest[&quot;version&quot;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#verify_manifest calls '@manifest["version"]' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L102" class="js-smell-location">0</a>                  <a href="update_release.html#L103" class="js-smell-location">1</a>                  <a href="update_release.html#L105" class="js-smell-location">2</a>                  </div>  </li></ol>
          logger.info(&quot;Formatted version &#39;#{@manifest[&quot;version&quot;]}&#39; =&gt; &#39;#{@version}&#39;&quot;) unless @version.to_s == @manifest[&quot;version&quot;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#verify_manifest calls '@manifest["version"]' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L102" class="js-smell-location">0</a>                  <a href="update_release.html#L103" class="js-smell-location">1</a>                  <a href="update_release.html#L105" class="js-smell-location">2</a>                  </div>  </li></ol>
        rescue SemiSemantic::ParseError
          raise ReleaseVersionInvalid, &quot;Release version invalid: #{@manifest[&quot;version&quot;]}&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#verify_manifest calls '@manifest["version"]' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L102" class="js-smell-location">0</a>                  <a href="update_release.html#L103" class="js-smell-location">1</a>                  <a href="update_release.html#L105" class="js-smell-location">2</a>                  </div>  </li></ol>
        end

        @commit_hash = @manifest.fetch(&quot;commit_hash&quot;, nil)
        @uncommitted_changes = @manifest.fetch(&quot;uncommitted_changes&quot;, nil)
      end

      def verify_sha
        begin
          @multi_digest_verifier.verify(release_path, sha1)
        rescue Bosh::Director::BoshDigest::ShaMismatchError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#verify_sha has the variable name 'e'</span>          </div>  </li></ol>
          raise Bosh::Director::ReleaseSha1DoesNotMatch.new(e)
        end
      end

      def compiled_release
        raise &quot;Don&#39;t know what kind of release we have until verify_release is called&quot; unless @manifest
        @compiled_release
      end

      def source_release
        !compiled_release
      end

      # Processes uploaded release, creates jobs and packages in DB if needed
      # @param [String] release_dir local path to the unpacked release
      # @return [void]
      def process_release(release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_release has a flog score of 27</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_release has approx 16 statements</span>          </div>  </li></ol>
        @release_model = Models::Release.find_or_create(:name =&gt; @name)

        @version = next_release_version if @rebase

        release_is_new = false
        @release_version_model = Models::ReleaseVersion.find_or_create(release: @release_model, version: @version.to_s) do
          release_is_new = true
        end

        if release_is_new
          @release_version_model.uncommitted_changes = @uncommitted_changes if @uncommitted_changes
          @release_version_model.commit_hash = @commit_hash if @commit_hash
          @release_version_model.save
        else
          if @release_version_model.commit_hash != @commit_hash || @release_version_model.uncommitted_changes != @uncommitted_changes
            raise ReleaseVersionCommitHashMismatch, &quot;release &#39;#{@name}/#{@version}&#39; has already been uploaded with commit_hash as &#39;#{@commit_hash}&#39; and uncommitted_changes as &#39;#{@uncommitted_changes}&#39;&quot;
          end
        end

        single_step_stage(&quot;Resolving package dependencies&quot;) do
          resolve_package_dependencies(manifest_packages)
        end

        process_packages(release_dir)
        process_jobs(release_dir)

        event_log_stage = Config.event_log.begin_stage(@compiled_release ? &quot;Compiled Release has been created&quot; : &quot;Release has been created&quot;, 1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@compiled_release' at least 5 times</span>              <span>Locations:</span>                  <a href="update_release.html#L95" class="js-smell-location">0</a>                  <a href="update_release.html#L159" class="js-smell-location">1</a>                  <a href="update_release.html#L274" class="js-smell-location">2</a>                  <a href="update_release.html#L360" class="js-smell-location">3</a>                  <a href="update_release.html#L468" class="js-smell-location">4</a>                  </div>  </li></ol>
        event_log_stage.advance_and_track(&quot;#{@name}/#{@version}&quot;) {}
      end

      # Normalizes release manifest, so all names, versions, and checksums are Strings.
      # @return [void]
      def normalize_manifest
        Bosh::Director.hash_string_vals(@manifest, &#39;name&#39;, &#39;version&#39;)

        manifest_packages.each { |p| Bosh::Director.hash_string_vals(p, &#39;name&#39;, &#39;version&#39;, &#39;sha1&#39;) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#normalize_manifest has the variable name 'p'</span>          </div>  </li></ol>
        manifest_jobs.each { |j| Bosh::Director.hash_string_vals(j, &#39;name&#39;, &#39;version&#39;, &#39;sha1&#39;) }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#normalize_manifest has the variable name 'j'</span>          </div>  </li></ol>
      end

      # Resolves package dependencies, makes sure there are no cycles
      # and all dependencies are present
      # @return [void]
      def resolve_package_dependencies(packages)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies has a flog score of 29</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies has approx 13 statements</span>          </div>  </li></ol>
        packages_by_name = {}
        packages.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'packages.each' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L177" class="js-smell-location">0</a>                  <a href="update_release.html#L188" class="js-smell-location">1</a>                  </div>  </li></ol>
          packages_by_name[package[&quot;name&quot;]] = package<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'package["name"]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L189" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L179" class="js-smell-location">1</a>                  <a href="update_release.html#L189" class="js-smell-location">2</a>                  <a href="update_release.html#L190" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'packages_by_name' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L181" class="js-smell-location">1</a>                  <a href="update_release.html#L184" class="js-smell-location">2</a>                  <a href="update_release.html#L186" class="js-smell-location">3</a>                  </div>  </li></ol>
          package[&quot;dependencies&quot;] ||= []<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'package["dependencies"]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L179" class="js-smell-location">0</a>                  <a href="update_release.html#L190" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L179" class="js-smell-location">1</a>                  <a href="update_release.html#L189" class="js-smell-location">2</a>                  <a href="update_release.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
        end
        logger.info(&quot;Resolving package dependencies for #{packages_by_name.keys.inspect}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'packages_by_name.keys' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L181" class="js-smell-location">0</a>                  <a href="update_release.html#L186" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'packages_by_name' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L181" class="js-smell-location">1</a>                  <a href="update_release.html#L184" class="js-smell-location">2</a>                  <a href="update_release.html#L186" class="js-smell-location">3</a>                  </div>  </li></ol>

        dependency_lookup = lambda do |package_name|
          packages_by_name[package_name][&quot;dependencies&quot;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'packages_by_name' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L181" class="js-smell-location">1</a>                  <a href="update_release.html#L184" class="js-smell-location">2</a>                  <a href="update_release.html#L186" class="js-smell-location">3</a>                  </div>  </li></ol>
        end
        result = Bosh::Director::CycleHelper.check_for_cycle(packages_by_name.keys, :connected_vertices =&gt; true, &amp;dependency_lookup)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'packages_by_name.keys' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L181" class="js-smell-location">0</a>                  <a href="update_release.html#L186" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'packages_by_name' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L181" class="js-smell-location">1</a>                  <a href="update_release.html#L184" class="js-smell-location">2</a>                  <a href="update_release.html#L186" class="js-smell-location">3</a>                  </div>  </li></ol>

        packages.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'packages.each' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L177" class="js-smell-location">0</a>                  <a href="update_release.html#L188" class="js-smell-location">1</a>                  </div>  </li></ol>
          name = package[&quot;name&quot;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'package["name"]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L189" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L179" class="js-smell-location">1</a>                  <a href="update_release.html#L189" class="js-smell-location">2</a>                  <a href="update_release.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
          dependencies = package[&quot;dependencies&quot;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies calls 'package["dependencies"]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L179" class="js-smell-location">0</a>                  <a href="update_release.html#L190" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#resolve_package_dependencies refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L178" class="js-smell-location">0</a>                  <a href="update_release.html#L179" class="js-smell-location">1</a>                  <a href="update_release.html#L189" class="js-smell-location">2</a>                  <a href="update_release.html#L190" class="js-smell-location">3</a>                  </div>  </li></ol>
          all_dependencies = result[:connected_vertices][name]
          logger.info(&quot;Resolved package dependencies for &#39;#{name}&#39;: #{dependencies.pretty_inspect} =&gt; #{all_dependencies.pretty_inspect}&quot;)
        end
      end

      # Finds all package definitions in the manifest and sorts them into two
      # buckets: new and existing packages, then creates new packages and points
      # current release version to the existing packages.
      # @param [String] release_dir local path to the unpacked release
      # @return [void]
      def process_packages(release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages has a flog score of 106</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages has approx 34 statements</span>          </div>  </li></ol>
        logger.info(&quot;Checking for new packages in release&quot;)

        new_packages = []
        existing_packages = []
        registered_packages = []

        manifest_packages.each do |package_meta|
          package_meta[&#39;compiled_package_sha1&#39;] = package_meta[&#39;sha1&#39;]

          # Checking whether we might have the same bits somewhere (in any release, not just the one being uploaded)
          @release_version_model.packages.select { |pv| pv.name == package_meta[&#39;name&#39;] }.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L546" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['name']' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L214" class="js-smell-location">1</a>                  <a href="update_release.html#L227" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L225" class="js-smell-location">1</a>                  <a href="update_release.html#L242" class="js-smell-location">2</a>                  <a href="update_release.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>
            if package.fingerprint != package_meta[&#39;fingerprint&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['fingerprint']' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L213" class="js-smell-location">0</a>                  <a href="update_release.html#L218" class="js-smell-location">1</a>                  </div>  </li></ol>
              raise ReleaseInvalidPackage, &quot;package &#39;#{package_meta[&#39;name&#39;]}&#39; had different fingerprint in previously uploaded release &#39;#{@name}/#{@version}&#39;&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['name']' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L214" class="js-smell-location">1</a>                  <a href="update_release.html#L227" class="js-smell-location">2</a>                  </div>  </li></ol>
            end
          end

          packages = Models::Package.where(fingerprint: package_meta[&#39;fingerprint&#39;]).order_by(:id).all<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['fingerprint']' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L213" class="js-smell-location">0</a>                  <a href="update_release.html#L218" class="js-smell-location">1</a>                  </div>  </li></ol>

          if packages.empty?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests 'packages.empty?' at least 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L220" class="js-smell-location">0</a>                  <a href="update_release.html#L290" class="js-smell-location">1</a>                  <a href="update_release.html#L309" class="js-smell-location">2</a>                  </div>  </li></ol>
            new_packages &lt;&lt; package_meta<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'new_packages << package_meta' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L221" class="js-smell-location">0</a>                  <a href="update_release.html#L266" class="js-smell-location">1</a>                  </div>  </li></ol>
            next
          end

          existing_package = packages.find do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L225" class="js-smell-location">0</a>                  <a href="update_release.html#L554" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L225" class="js-smell-location">1</a>                  <a href="update_release.html#L242" class="js-smell-location">2</a>                  <a href="update_release.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>
            package.release_id == @release_model.id &amp;&amp;
            package.name == package_meta[&#39;name&#39;] &amp;&amp;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['name']' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L214" class="js-smell-location">1</a>                  <a href="update_release.html#L227" class="js-smell-location">2</a>                  </div>  </li></ol>
            package.version == package_meta[&#39;version&#39;]
          end

          if existing_package
            # clean up &#39;broken&#39; dependency_set (a bug was including transitives)
            # dependency ordering impacts fingerprint
            # TODO: The following code can be removed after some reasonable time period (added 2014.10.06)
            if existing_package.dependency_set != package_meta[&#39;dependencies&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['dependencies']' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L235" class="js-smell-location">0</a>                  <a href="update_release.html#L236" class="js-smell-location">1</a>                  </div>  </li></ol>
              existing_package.dependency_set = package_meta[&#39;dependencies&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['dependencies']' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L235" class="js-smell-location">0</a>                  <a href="update_release.html#L236" class="js-smell-location">1</a>                  </div>  </li></ol>
              existing_package.save
            end

            if existing_package.release_versions.include?(@release_version_model)
              if existing_package.blobstore_id.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages performs a nil-check</span>              <span>Locations:</span>                  <a href="update_release.html#L241" class="js-smell-location">0</a>                  <a href="update_release.html#L243" class="js-smell-location">1</a>                  <a href="update_release.html#L260" class="js-smell-location">2</a>                  </div>  </li></ol>
                packages.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L242" class="js-smell-location">0</a>                  <a href="update_release.html#L259" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'packages.each do |package| ... end' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L242" class="js-smell-location">0</a>                  <a href="update_release.html#L259" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'packages.each' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L242" class="js-smell-location">0</a>                  <a href="update_release.html#L259" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L225" class="js-smell-location">1</a>                  <a href="update_release.html#L242" class="js-smell-location">2</a>                  <a href="update_release.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>
                  unless package.blobstore_id.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L244" class="js-smell-location">1</a>                  <a href="update_release.html#L260" class="js-smell-location">2</a>                  <a href="update_release.html#L261" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.blobstore_id.nil?' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L260" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages performs a nil-check</span>              <span>Locations:</span>                  <a href="update_release.html#L241" class="js-smell-location">0</a>                  <a href="update_release.html#L243" class="js-smell-location">1</a>                  <a href="update_release.html#L260" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests 'package.blobstore_id.nil?' at least 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L260" class="js-smell-location">1</a>                  <a href="update_release.html#L500" class="js-smell-location">2</a>                  </div>  </li></ol>
                    package_meta[&#39;blobstore_id&#39;] = package.blobstore_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L244" class="js-smell-location">1</a>                  <a href="update_release.html#L260" class="js-smell-location">2</a>                  <a href="update_release.html#L261" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['blobstore_id'] = package.blobstore_id' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L244" class="js-smell-location">0</a>                  <a href="update_release.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
                    package_meta[&#39;sha1&#39;] = package.sha1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.sha1' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L245" class="js-smell-location">0</a>                  <a href="update_release.html#L262" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['sha1'] = package.sha1' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L245" class="js-smell-location">0</a>                  <a href="update_release.html#L262" class="js-smell-location">1</a>                  </div>  </li></ol>
                    break
                  end
                end
              end
              registered_packages &lt;&lt; [existing_package, package_meta]
            else
              existing_packages &lt;&lt; [existing_package, package_meta]
            end

          else
            # We found a package with the same fingerprint but different
            # (release, name, version) tuple, so we need to make a copy
            # of the package blob and create a new db entry for it
            packages.each do |package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Identical code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L242" class="js-smell-location">0</a>                  <a href="update_release.html#L259" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'packages.each do |package| ... end' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L242" class="js-smell-location">0</a>                  <a href="update_release.html#L259" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'packages.each' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L242" class="js-smell-location">0</a>                  <a href="update_release.html#L259" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L225" class="js-smell-location">1</a>                  <a href="update_release.html#L242" class="js-smell-location">2</a>                  <a href="update_release.html#L259" class="js-smell-location">3</a>                  </div>  </li></ol>
              unless package.blobstore_id.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L244" class="js-smell-location">1</a>                  <a href="update_release.html#L260" class="js-smell-location">2</a>                  <a href="update_release.html#L261" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.blobstore_id.nil?' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L260" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages performs a nil-check</span>              <span>Locations:</span>                  <a href="update_release.html#L241" class="js-smell-location">0</a>                  <a href="update_release.html#L243" class="js-smell-location">1</a>                  <a href="update_release.html#L260" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests 'package.blobstore_id.nil?' at least 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L260" class="js-smell-location">1</a>                  <a href="update_release.html#L500" class="js-smell-location">2</a>                  </div>  </li></ol>
                package_meta[&#39;blobstore_id&#39;] = package.blobstore_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L244" class="js-smell-location">1</a>                  <a href="update_release.html#L260" class="js-smell-location">2</a>                  <a href="update_release.html#L261" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['blobstore_id'] = package.blobstore_id' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L244" class="js-smell-location">0</a>                  <a href="update_release.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
                package_meta[&#39;sha1&#39;] = package.sha1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package.sha1' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L245" class="js-smell-location">0</a>                  <a href="update_release.html#L262" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'package_meta['sha1'] = package.sha1' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L245" class="js-smell-location">0</a>                  <a href="update_release.html#L262" class="js-smell-location">1</a>                  </div>  </li></ol>
                break
              end
            end
            new_packages &lt;&lt; package_meta<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_packages calls 'new_packages << package_meta' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L221" class="js-smell-location">0</a>                  <a href="update_release.html#L266" class="js-smell-location">1</a>                  </div>  </li></ol>
          end
        end

        created_package_refs = create_packages(new_packages, release_dir)

        existing_package_refs = use_existing_packages(existing_packages, release_dir)

        if @compiled_release<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@compiled_release' at least 5 times</span>              <span>Locations:</span>                  <a href="update_release.html#L95" class="js-smell-location">0</a>                  <a href="update_release.html#L159" class="js-smell-location">1</a>                  <a href="update_release.html#L274" class="js-smell-location">2</a>                  <a href="update_release.html#L360" class="js-smell-location">3</a>                  <a href="update_release.html#L468" class="js-smell-location">4</a>                  </div>  </li></ol>
          registered_package_refs = registered_packages.map do |pkg, pkg_meta|
            {
              package: pkg,
              package_meta: pkg_meta,
            }
          end
          all_package_refs = Array(created_package_refs) | Array(existing_package_refs) | registered_package_refs
          create_compiled_packages(all_package_refs, release_dir)
        else
          backfill_source_for_packages(registered_packages, release_dir)
        end
      end

      # @return [boolean] true if sources were added to at least one package; false if the call had no effect.
      def backfill_source_for_packages(packages, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#backfill_source_for_packages has approx 9 statements</span>          </div>  </li></ol>
        return false if packages.empty?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#backfill_source_for_packages refers to 'packages' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L290" class="js-smell-location">0</a>                  <a href="update_release.html#L293" class="js-smell-location">1</a>                  <a href="update_release.html#L294" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests 'packages.empty?' at least 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L220" class="js-smell-location">0</a>                  <a href="update_release.html#L290" class="js-smell-location">1</a>                  <a href="update_release.html#L309" class="js-smell-location">2</a>                  </div>  </li></ol>

        had_effect = false
        single_step_stage(&quot;Processing #{packages.size} existing package#{&quot;s&quot; if packages.size &gt; 1}&quot;) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#backfill_source_for_packages calls 'packages.size' 2 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#backfill_source_for_packages refers to 'packages' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L290" class="js-smell-location">0</a>                  <a href="update_release.html#L293" class="js-smell-location">1</a>                  <a href="update_release.html#L294" class="js-smell-location">2</a>                  </div>  </li></ol>
          packages.each do |package, package_meta|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#backfill_source_for_packages refers to 'packages' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L290" class="js-smell-location">0</a>                  <a href="update_release.html#L293" class="js-smell-location">1</a>                  <a href="update_release.html#L294" class="js-smell-location">2</a>                  </div>  </li></ol>
            package_desc = &quot;#{package.name}/#{package.version}&quot;
            logger.info(&quot;Adding source for package &#39;#{package_desc}&#39;&quot;)
            had_effect |= save_package_source_blob(package, package_meta, release_dir)
            package.save
          end
        end

        had_effect
      end

      # Points release DB model to existing packages described by given metadata
      # @param [Array&lt;Array&gt;] packages Existing packages metadata.
      # @return [Array&lt;Hash&gt;] array of registered package models and their metadata, empty if no packages were changed.
      def use_existing_packages(packages, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#use_existing_packages has a flog score of 28</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#use_existing_packages has approx 11 statements</span>          </div>  </li></ol>
        if packages.empty?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests 'packages.empty?' at least 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L220" class="js-smell-location">0</a>                  <a href="update_release.html#L290" class="js-smell-location">1</a>                  <a href="update_release.html#L309" class="js-smell-location">2</a>                  </div>  </li></ol>
          return []
        end

        package_refs = []

        single_step_stage(&quot;Processing #{packages.size} existing package#{&quot;s&quot; if packages.size &gt; 1}&quot;) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#use_existing_packages calls 'packages.size' 2 times</span>          </div>  </li></ol>
          packages.each do |package, package_meta|
            package_desc = &quot;#{package.name}/#{package.version}&quot;
            logger.info(&quot;Using existing package &#39;#{package_desc}&#39;&quot;)
            register_package(package)

            if compiled_release
              package_refs &lt;&lt; {
                package: package,
                package_meta: package_meta,
              }
            end

            if source_release &amp;&amp; (package.blobstore_id.nil? || @fix)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#use_existing_packages performs a nil-check</span>          </div>  </li></ol>
              save_package_source_blob(package, package_meta, release_dir)
              package.save
            end
          end
        end

        return package_refs
      end

      # Creates packages using provided metadata
      # @param [Array&lt;Hash&gt;] packages Packages metadata
      # @param [String] release_dir local path to the unpacked release
      # @return [Array&lt;Hash&gt;, boolean] array of package models and their metadata, empty if no packages were changed.
      def create_packages(package_metas, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_packages has approx 12 statements</span>          </div>  </li></ol>
        if package_metas.empty?
          return []
        end

        package_refs = []

        event_log_stage = Config.event_log.begin_stage(&quot;Creating new packages&quot;, package_metas.size)

        package_metas.each do |package_meta|
          package_desc = &quot;#{package_meta[&quot;name&quot;]}/#{package_meta[&quot;version&quot;]}&quot;
          package = nil
          event_log_stage.advance_and_track(package_desc) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L354" class="js-smell-location">0</a>                  <a href="update_release.html#L580" class="js-smell-location">1</a>                  </div>  </li></ol>
            logger.info(&quot;Creating new package &#39;#{package_desc}&#39;&quot;)
            package = create_package(package_meta, release_dir)
            register_package(package)
          end

          if @compiled_release<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@compiled_release' at least 5 times</span>              <span>Locations:</span>                  <a href="update_release.html#L95" class="js-smell-location">0</a>                  <a href="update_release.html#L159" class="js-smell-location">1</a>                  <a href="update_release.html#L274" class="js-smell-location">2</a>                  <a href="update_release.html#L360" class="js-smell-location">3</a>                  <a href="update_release.html#L468" class="js-smell-location">4</a>                  </div>  </li></ol>
            package_refs &lt;&lt; {
              package: package,
              package_meta: package_meta,
            }
          end
        end

        package_refs
      end

      # @return [boolean] true if at least one job was created; false if the call had no effect.
      def create_compiled_packages(all_compiled_packages, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages has a flog score of 48</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages has approx 21 statements</span>          </div>  </li></ol>
        return false if all_compiled_packages.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages performs a nil-check</span>          </div>  </li></ol>

        event_log_stage = Config.event_log.begin_stage(&#39;Creating new compiled packages&#39;, all_compiled_packages.size)
        had_effect = false

        all_compiled_packages.each do |compiled_package_spec|
          package = compiled_package_spec[:package]
          stemcell = Models::CompiledPackage.split_stemcell_os_and_version(compiled_package_spec[:package_meta][&#39;stemcell&#39;])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages calls 'compiled_package_spec[:package_meta]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L380" class="js-smell-location">0</a>                  <a href="update_release.html#L397" class="js-smell-location">1</a>                  </div>  </li></ol>
          compiled_pkg_tgz = File.join(release_dir, &#39;compiled_packages&#39;, &quot;#{package.name}.tgz&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages calls 'package.name' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L381" class="js-smell-location">0</a>                  <a href="update_release.html#L389" class="js-smell-location">1</a>                  </div>  </li></ol>

          stemcell_os = stemcell[:os]
          stemcell_version = stemcell[:version]

          existing_compiled_packages = find_compiled_packages(package.id, stemcell_os, stemcell_version, dependency_key(package))

          if existing_compiled_packages.empty?
            package_desc = &quot;#{package.name}/#{package.version} for #{stemcell_os}/#{stemcell_version}&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages calls 'package.name' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L381" class="js-smell-location">0</a>                  <a href="update_release.html#L389" class="js-smell-location">1</a>                  </div>  </li></ol>
            event_log_stage.advance_and_track(package_desc) do
              other_compiled_packages = compiled_packages_matching(package, stemcell)
              if @fix<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@fix' at least 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L392" class="js-smell-location">0</a>                  <a href="update_release.html#L401" class="js-smell-location">1</a>                  <a href="update_release.html#L482" class="js-smell-location">2</a>                  <a href="update_release.html#L606" class="js-smell-location">3</a>                  </div>  </li></ol>
                other_compiled_packages.each do |other_compiled_package|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages contains iterators nested 2 deep</span>          </div>  </li></ol>
                  fix_compiled_package(other_compiled_package, compiled_pkg_tgz)
                end
              end
              package_sha1 = compiled_package_spec[:package_meta][&#39;compiled_package_sha1&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages calls 'compiled_package_spec[:package_meta]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L380" class="js-smell-location">0</a>                  <a href="update_release.html#L397" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_packages has the variable name 'package_sha1'</span>          </div>  </li></ol>
              create_compiled_package(package, package_sha1, stemcell_os, stemcell_version, release_dir, other_compiled_packages.first)
              had_effect = true
            end
          elsif @fix<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@fix' at least 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L392" class="js-smell-location">0</a>                  <a href="update_release.html#L401" class="js-smell-location">1</a>                  <a href="update_release.html#L482" class="js-smell-location">2</a>                  <a href="update_release.html#L606" class="js-smell-location">3</a>                  </div>  </li></ol>
            existing_compiled_package = existing_compiled_packages.first
            fix_compiled_package(existing_compiled_package, compiled_pkg_tgz)
          end
        end

        had_effect
      end

      def compiled_packages_matching(package, stemcell)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#compiled_packages_matching has approx 6 statements</span>          </div>  </li></ol>
        other_compiled_packages = []
        dependency_key = dependency_key(package)
        packages = Models::Package.where(fingerprint: package.fingerprint).order_by(:id).all
        packages.each do |pkg|
          other_compiled_packages.concat(find_compiled_packages(pkg.id, stemcell[:os], stemcell[:version], dependency_key).all)
        end
        other_compiled_packages
      end

      def create_compiled_package(package, package_sha1, stemcell_os, stemcell_version, release_dir, other_compiled_package)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package has a flog score of 30</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package has 6 parameters</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package has approx 17 statements</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Parameter-Name.md" target="_blank"><b>UncommunicativeParameterName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package has the parameter name 'package_sha1'</span>          </div>  </li></ol>
        if other_compiled_package.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package performs a nil-check</span>          </div>  </li></ol>
          tgz = File.join(release_dir, &#39;compiled_packages&#39;, &quot;#{package.name}.tgz&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package calls 'package.name' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L422" class="js-smell-location">0</a>                  <a href="update_release.html#L423" class="js-smell-location">1</a>                  <a href="update_release.html#L435" class="js-smell-location">2</a>                  <a href="update_release.html#L436" class="js-smell-location">3</a>                  </div>  </li></ol>
          validate_tgz(tgz, &quot;#{package.name}.tgz&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package calls 'package.name' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L422" class="js-smell-location">0</a>                  <a href="update_release.html#L423" class="js-smell-location">1</a>                  <a href="update_release.html#L435" class="js-smell-location">2</a>                  <a href="update_release.html#L436" class="js-smell-location">3</a>                  </div>  </li></ol>
          blobstore_id = BlobUtil.create_blob(tgz)
          sha1 = package_sha1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package has the variable name 'sha1'</span>              <span>Locations:</span>                  <a href="update_release.html#L425" class="js-smell-location">0</a>                  <a href="update_release.html#L428" class="js-smell-location">1</a>                  </div>  </li></ol>
        else
          blobstore_id = BlobUtil.copy_blob(other_compiled_package.blobstore_id)
          sha1 = other_compiled_package.sha1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package has the variable name 'sha1'</span>              <span>Locations:</span>                  <a href="update_release.html#L425" class="js-smell-location">0</a>                  <a href="update_release.html#L428" class="js-smell-location">1</a>                  </div>  </li></ol>
        end

        compiled_package = Models::CompiledPackage.new
        compiled_package.blobstore_id = blobstore_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>
        compiled_package.sha1 = sha1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>
        release_version_model_dependency_key = dependency_key(package)
        if release_version_model_dependency_key != CompiledRelease::Manifest.new(@manifest).dependency_key(package.name)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package calls 'package.name' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L422" class="js-smell-location">0</a>                  <a href="update_release.html#L423" class="js-smell-location">1</a>                  <a href="update_release.html#L435" class="js-smell-location">2</a>                  <a href="update_release.html#L436" class="js-smell-location">3</a>                  </div>  </li></ol>
          raise ReleasePackageDependencyKeyMismatch, &quot;The uploaded release contains package dependencies in &#39;#{package.name}&#39; that do not match database records.&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package calls 'package.name' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L422" class="js-smell-location">0</a>                  <a href="update_release.html#L423" class="js-smell-location">1</a>                  <a href="update_release.html#L435" class="js-smell-location">2</a>                  <a href="update_release.html#L436" class="js-smell-location">3</a>                  </div>  </li></ol>
        end
        compiled_package.dependency_key = release_version_model_dependency_key<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>

        compiled_package.build = Models::CompiledPackage.generate_build_number(package, stemcell_os, stemcell_version)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>
        compiled_package.package_id = package.id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>

        compiled_package.stemcell_os = stemcell_os<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>
        compiled_package.stemcell_version = stemcell_version<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>

        compiled_package.save<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_compiled_package refers to 'compiled_package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L432" class="js-smell-location">0</a>                  <a href="update_release.html#L433" class="js-smell-location">1</a>                  <a href="update_release.html#L438" class="js-smell-location">2</a>                  <a href="update_release.html#L440" class="js-smell-location">3</a>                  <a href="update_release.html#L441" class="js-smell-location">4</a>                  <a href="update_release.html#L443" class="js-smell-location">5</a>                  <a href="update_release.html#L444" class="js-smell-location">6</a>                  <a href="update_release.html#L446" class="js-smell-location">7</a>                  </div>  </li></ol>
      end

      # Creates package in DB according to given metadata
      # @param [Hash] package_meta Package metadata
      # @param [String] release_dir local path to the unpacked release
      # @return [void]
      def create_package(package_meta, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_package has approx 6 statements</span>          </div>  </li></ol>
        name, version = package_meta[&#39;name&#39;], package_meta[&#39;version&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_package refers to 'package_meta' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L454" class="js-smell-location">0</a>                  <a href="update_release.html#L461" class="js-smell-location">1</a>                  <a href="update_release.html#L466" class="js-smell-location">2</a>                  </div>  </li></ol>

        package_attrs = {
            :release =&gt; @release_model,
            :name =&gt; name,
            :sha1 =&gt; nil,
            :blobstore_id =&gt; nil,
            :fingerprint =&gt; package_meta[&#39;fingerprint&#39;],<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_package refers to 'package_meta' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L454" class="js-smell-location">0</a>                  <a href="update_release.html#L461" class="js-smell-location">1</a>                  <a href="update_release.html#L466" class="js-smell-location">2</a>                  </div>  </li></ol>
            :version =&gt; version
        }

        package = Models::Package.new(package_attrs)
        package.dependency_set = package_meta[&#39;dependencies&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_package refers to 'package_meta' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L454" class="js-smell-location">0</a>                  <a href="update_release.html#L461" class="js-smell-location">1</a>                  <a href="update_release.html#L466" class="js-smell-location">2</a>                  </div>  </li></ol>

        save_package_source_blob(package, package_meta, release_dir) unless @compiled_release<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@compiled_release' at least 5 times</span>              <span>Locations:</span>                  <a href="update_release.html#L95" class="js-smell-location">0</a>                  <a href="update_release.html#L159" class="js-smell-location">1</a>                  <a href="update_release.html#L274" class="js-smell-location">2</a>                  <a href="update_release.html#L360" class="js-smell-location">3</a>                  <a href="update_release.html#L468" class="js-smell-location">4</a>                  </div>  </li></ol>

        package.save
      end

      # @return [boolean] true if a new blob was created; false otherwise
      def save_package_source_blob(package, package_meta, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob has a flog score of 38</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob has approx 25 statements</span>          </div>  </li></ol>
        name = package_meta[&#39;name&#39;]
        version = package_meta[&#39;version&#39;]
        existing_blob = package_meta[&#39;blobstore_id&#39;]
        sha1 = package_meta[&#39;sha1&#39;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob has the variable name 'sha1'</span>          </div>  </li></ol>
        desc = &quot;package &#39;#{name}/#{version}&#39;&quot;
        package_tgz = File.join(release_dir, &#39;packages&#39;, &quot;#{name}.tgz&quot;)

        if @fix<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@fix' at least 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L392" class="js-smell-location">0</a>                  <a href="update_release.html#L401" class="js-smell-location">1</a>                  <a href="update_release.html#L482" class="js-smell-location">2</a>                  <a href="update_release.html#L606" class="js-smell-location">3</a>                  </div>  </li></ol>
          package.sha1 = sha1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'package.sha1 = sha1' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L483" class="js-smell-location">0</a>                  <a href="update_release.html#L501" class="js-smell-location">1</a>                  </div>  </li></ol>

          if package.blobstore_id != nil<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'package.blobstore_id' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L485" class="js-smell-location">0</a>                  <a href="update_release.html#L500" class="js-smell-location">1</a>                  </div>  </li></ol>
            delete_compiled_packages(package)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'delete_compiled_packages(package)' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L486" class="js-smell-location">0</a>                  <a href="update_release.html#L494" class="js-smell-location">1</a>                  </div>  </li></ol>
            validate_tgz(package_tgz, desc)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'validate_tgz(package_tgz, desc)' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L487" class="js-smell-location">0</a>                  <a href="update_release.html#L511" class="js-smell-location">1</a>                  </div>  </li></ol>
            fix_package(package, package_tgz)
            return true
          end

          if existing_blob
            pkg = Models::Package.where(blobstore_id: existing_blob).first
            delete_compiled_packages(package)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'delete_compiled_packages(package)' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L486" class="js-smell-location">0</a>                  <a href="update_release.html#L494" class="js-smell-location">1</a>                  </div>  </li></ol>
            fix_package(pkg, package_tgz)
            package.blobstore_id = BlobUtil.copy_blob(pkg.blobstore_id)
            return true
          end
        else
          return false unless package.blobstore_id.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'package.blobstore_id' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L485" class="js-smell-location">0</a>                  <a href="update_release.html#L500" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob performs a nil-check</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests 'package.blobstore_id.nil?' at least 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L243" class="js-smell-location">0</a>                  <a href="update_release.html#L260" class="js-smell-location">1</a>                  <a href="update_release.html#L500" class="js-smell-location">2</a>                  </div>  </li></ol>
          package.sha1 = sha1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'package.sha1 = sha1' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L483" class="js-smell-location">0</a>                  <a href="update_release.html#L501" class="js-smell-location">1</a>                  </div>  </li></ol>

          if existing_blob
            logger.info(&quot;Creating #{desc} from existing blob #{existing_blob}&quot;)
            package.blobstore_id = BlobUtil.copy_blob(existing_blob)
            return true
          end
        end

        logger.info(&quot;Creating #{desc} from provided bits&quot;)
        validate_tgz(package_tgz, desc)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#save_package_source_blob calls 'validate_tgz(package_tgz, desc)' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L487" class="js-smell-location">0</a>                  <a href="update_release.html#L511" class="js-smell-location">1</a>                  </div>  </li></ol>
        package.blobstore_id = BlobUtil.create_blob(package_tgz)

        true
      end

      def validate_tgz(tgz, desc)
        result = Bosh::Exec.sh(&quot;tar -tzf #{tgz} 2&gt;&amp;1&quot;, :on_error =&gt; :return)
        if result.failed?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#validate_tgz refers to 'result' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L519" class="js-smell-location">0</a>                  <a href="update_release.html#L520" class="js-smell-location">1</a>                  </div>  </li></ol>
          logger.error(&quot;Extracting #{desc} archive failed, tar returned #{result.exit_status}, output: #{result.output}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#validate_tgz refers to 'result' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L519" class="js-smell-location">0</a>                  <a href="update_release.html#L520" class="js-smell-location">1</a>                  </div>  </li></ol>
          raise PackageInvalidArchive, &quot;Extracting #{desc} archive failed. Check task debug log for details.&quot;
        end
      end

      # Marks package model as used by release version model
      # @param [Models::Package] package Package model
      # @return [void]
      def register_package(package)
        @release_version_model.add_package(package)
      end

      # Finds job template definitions in release manifest and sorts them into
      # two buckets: new and existing job templates, then creates new job
      # template records in the database and points release version to existing ones.
      # @param [String] release_dir local path to the unpacked release
      # @return [void]
      def process_jobs(release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs has a flog score of 53</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs has approx 16 statements</span>          </div>  </li></ol>
        logger.info(&quot;Checking for new jobs in release&quot;)

        new_jobs = []
        existing_jobs = []
        manifest_jobs = @manifest[&#39;jobs&#39;] || []

        manifest_jobs.each do |job_meta|
          # Checking whether we might have the same bits somewhere
          @release_version_model.templates.select { |t| t.name == job_meta[&quot;name&quot;] }.each do |tmpl|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L212" class="js-smell-location">0</a>                  <a href="update_release.html#L546" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs calls 'job_meta["name"]' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L546" class="js-smell-location">0</a>                  <a href="update_release.html#L548" class="js-smell-location">1</a>                  <a href="update_release.html#L556" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_release.html#L546" class="js-smell-location">0</a>                  <a href="update_release.html#L554" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs has the variable name 't'</span>          </div>  </li></ol>
            if tmpl.fingerprint != job_meta[&quot;fingerprint&quot;]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs calls 'job_meta["fingerprint"]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L547" class="js-smell-location">0</a>                  <a href="update_release.html#L552" class="js-smell-location">1</a>                  </div>  </li></ol>
              raise ReleaseExistingJobFingerprintMismatch, &quot;job &#39;#{job_meta[&quot;name&quot;]}&#39; had different fingerprint in previously uploaded release &#39;#{@name}/#{@version}&#39;&quot;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs calls 'job_meta["name"]' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L546" class="js-smell-location">0</a>                  <a href="update_release.html#L548" class="js-smell-location">1</a>                  <a href="update_release.html#L556" class="js-smell-location">2</a>                  </div>  </li></ol>
            end
          end

          jobs = Models::Template.where(fingerprint: job_meta[&quot;fingerprint&quot;]).all<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs calls 'job_meta["fingerprint"]' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L547" class="js-smell-location">0</a>                  <a href="update_release.html#L552" class="js-smell-location">1</a>                  </div>  </li></ol>

          template = jobs.find do |job|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L225" class="js-smell-location">0</a>                  <a href="update_release.html#L554" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs contains iterators nested 2 deep</span>              <span>Locations:</span>                  <a href="update_release.html#L546" class="js-smell-location">0</a>                  <a href="update_release.html#L554" class="js-smell-location">1</a>                  </div>  </li></ol>
            job.release_id == @release_model.id &amp;&amp;
            job.name == job_meta[&quot;name&quot;] &amp;&amp;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs calls 'job_meta["name"]' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L546" class="js-smell-location">0</a>                  <a href="update_release.html#L548" class="js-smell-location">1</a>                  <a href="update_release.html#L556" class="js-smell-location">2</a>                  </div>  </li></ol>
            job.version == job_meta[&quot;version&quot;]
          end

          if template.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#process_jobs performs a nil-check</span>          </div>  </li></ol>
            new_jobs &lt;&lt; job_meta
          else
            existing_jobs &lt;&lt; [template, job_meta]
          end
        end

        did_something = create_jobs(new_jobs, release_dir)
        did_something |= use_existing_jobs(existing_jobs, release_dir)

        did_something
      end

      # @return [boolean] true if at least one job was created; false if the call had no effect.
      def create_jobs(jobs, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#create_jobs has approx 9 statements</span>          </div>  </li></ol>
        return false if jobs.empty?

        event_log_stage = Config.event_log.begin_stage(&quot;Creating new jobs&quot;, jobs.size)
        jobs.each do |job_meta|
          job_desc = &quot;#{job_meta[&quot;name&quot;]}/#{job_meta[&quot;version&quot;]}&quot;
          event_log_stage.advance_and_track(job_desc) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L354" class="js-smell-location">0</a>                  <a href="update_release.html#L580" class="js-smell-location">1</a>                  </div>  </li></ol>
            logger.info(&quot;Creating new template &#39;#{job_desc}&#39;&quot;)
            template = create_job(job_meta, release_dir)
            register_template(template)
          end
        end

        true
      end

      def create_job(job_meta, release_dir)
        release_job = ReleaseJob.new(job_meta, @release_model, release_dir, logger)
        logger.info(&quot;Creating job template &#39;#{job_meta[&#39;name&#39;]}/#{job_meta[&#39;version&#39;]}&#39; &quot; +
            &#39;from provided bits&#39;)
        release_job.update
      end

      # @param [Array&lt;Array&gt;] jobs Existing jobs metadata
      # @return [boolean] true if at least one job was tied to the release version; false if the call had no effect.
      def use_existing_jobs(jobs, release_dir)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#use_existing_jobs has a flog score of 28</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#use_existing_jobs has approx 10 statements</span>          </div>  </li></ol>
        return false if jobs.empty?

        single_step_stage(&quot;Processing #{jobs.size} existing job#{&quot;s&quot; if jobs.size &gt; 1}&quot;) do<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#use_existing_jobs calls 'jobs.size' 2 times</span>          </div>  </li></ol>
          jobs.each do |template, job_meta|
            job_desc = &quot;#{template.name}/#{template.version}&quot;

            if @fix<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease tests '@fix' at least 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L392" class="js-smell-location">0</a>                  <a href="update_release.html#L401" class="js-smell-location">1</a>                  <a href="update_release.html#L482" class="js-smell-location">2</a>                  <a href="update_release.html#L606" class="js-smell-location">3</a>                  </div>  </li></ol>
              logger.info(&quot;Fixing existing job &#39;#{job_desc}&#39;&quot;)
              release_job = ReleaseJob.new(job_meta, @release_model, release_dir, logger)
              release_job.update
            else
              logger.info(&quot;Using existing job &#39;#{job_desc}&#39;&quot;)
            end

            register_template(template) unless template.release_versions.include? @release_version_model
          end
        end

        true
      end

      private

      def dependency_key(package)
        KeyGenerator.new.dependency_key_from_models(package, @release_version_model)
      end

      def find_compiled_packages(pkg_id, stemcell_os, stemcell_version, dependency_key)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#find_compiled_packages has 4 parameters</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#find_compiled_packages doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
        Models::CompiledPackage.where(
            :package_id =&gt; pkg_id,
            :stemcell_os =&gt; stemcell_os,
            :stemcell_version =&gt; stemcell_version,
            :dependency_key =&gt; dependency_key
        )
      end

      # Marks job template model as being used by release version
      # @param [Models::Template] template Job template model
      # @return [void]
      def register_template(template)
        @release_version_model.add_template(template)
      end

      def manifest_packages
        @manifest[@packages_folder] || []
      end

      def manifest_jobs
        @manifest[&#39;jobs&#39;] || []
      end

      # Returns the next release version (to be used for rebased release)
      # @return [String]
      def next_release_version
        attrs = {:release_id =&gt; @release_model.id}
        models = Models::ReleaseVersion.filter(attrs).all
        strings = models.map(&amp;:version)
        list = Bosh::Common::Version::ReleaseVersionList.parse(strings)
        list.rebase(@version)
      end

      def fix_package(package, package_tgz)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package has a flog score of 25</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package has approx 7 statements</span>          </div>  </li></ol>
        begin
          logger.info(&quot;Deleting package &#39;#{package.name}/#{package.version}&#39;&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L669" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.version' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L669" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L664" class="js-smell-location">1</a>                  <a href="update_release.html#L666" class="js-smell-location">2</a>                  <a href="update_release.html#L668" class="js-smell-location">3</a>                  <a href="update_release.html#L669" class="js-smell-location">4</a>                  <a href="update_release.html#L670" class="js-smell-location">5</a>                  <a href="update_release.html#L671" class="js-smell-location">6</a>                  </div>  </li></ol>
          BlobUtil.delete_blob(package.blobstore_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.blobstore_id' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L664" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L670" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L664" class="js-smell-location">1</a>                  <a href="update_release.html#L666" class="js-smell-location">2</a>                  <a href="update_release.html#L668" class="js-smell-location">3</a>                  <a href="update_release.html#L669" class="js-smell-location">4</a>                  <a href="update_release.html#L670" class="js-smell-location">5</a>                  <a href="update_release.html#L671" class="js-smell-location">6</a>                  </div>  </li></ol>
        rescue Bosh::Blobstore::BlobstoreError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package has the variable name 'e'</span>          </div>  </li></ol>
          logger.info(&quot;Error deleting blob &#39;#{package.blobstore_id}, #{package.name}/#{package.version}&#39;: #{e.inspect}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="snapshot_deployment.html#L42" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.blobstore_id' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L664" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L670" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L669" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.version' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L669" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L664" class="js-smell-location">1</a>                  <a href="update_release.html#L666" class="js-smell-location">2</a>                  <a href="update_release.html#L668" class="js-smell-location">3</a>                  <a href="update_release.html#L669" class="js-smell-location">4</a>                  <a href="update_release.html#L670" class="js-smell-location">5</a>                  <a href="update_release.html#L671" class="js-smell-location">6</a>                  </div>  </li></ol>
        end
        package.blobstore_id = BlobUtil.create_blob(package_tgz)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L664" class="js-smell-location">1</a>                  <a href="update_release.html#L666" class="js-smell-location">2</a>                  <a href="update_release.html#L668" class="js-smell-location">3</a>                  <a href="update_release.html#L669" class="js-smell-location">4</a>                  <a href="update_release.html#L670" class="js-smell-location">5</a>                  <a href="update_release.html#L671" class="js-smell-location">6</a>                  </div>  </li></ol>
        logger.info(&quot;Re-created package &#39;#{package.name}/#{package.version}&#39; \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L669" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.version' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L669" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L664" class="js-smell-location">1</a>                  <a href="update_release.html#L666" class="js-smell-location">2</a>                  <a href="update_release.html#L668" class="js-smell-location">3</a>                  <a href="update_release.html#L669" class="js-smell-location">4</a>                  <a href="update_release.html#L670" class="js-smell-location">5</a>                  <a href="update_release.html#L671" class="js-smell-location">6</a>                  </div>  </li></ol>
with blobstore_id &#39;#{package.blobstore_id}&#39;&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package calls 'package.blobstore_id' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L664" class="js-smell-location">0</a>                  <a href="update_release.html#L666" class="js-smell-location">1</a>                  <a href="update_release.html#L670" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L664" class="js-smell-location">1</a>                  <a href="update_release.html#L666" class="js-smell-location">2</a>                  <a href="update_release.html#L668" class="js-smell-location">3</a>                  <a href="update_release.html#L669" class="js-smell-location">4</a>                  <a href="update_release.html#L670" class="js-smell-location">5</a>                  <a href="update_release.html#L671" class="js-smell-location">6</a>                  </div>  </li></ol>
        package.save<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_package refers to 'package' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L663" class="js-smell-location">0</a>                  <a href="update_release.html#L664" class="js-smell-location">1</a>                  <a href="update_release.html#L666" class="js-smell-location">2</a>                  <a href="update_release.html#L668" class="js-smell-location">3</a>                  <a href="update_release.html#L669" class="js-smell-location">4</a>                  <a href="update_release.html#L670" class="js-smell-location">5</a>                  <a href="update_release.html#L671" class="js-smell-location">6</a>                  </div>  </li></ol>
      end
<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages has a flog score of 29</span>          </div>  </li></ol>
      def delete_compiled_packages(package)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages has approx 7 statements</span>          </div>  </li></ol>
        package.compiled_packages.each do |compiled_pkg|
          logger.info(&quot;Deleting compiled package &#39;#{compiled_pkg.name}&#39; for \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages calls 'compiled_pkg.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L679" class="js-smell-location">1</a>                  <a href="update_release.html#L683" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L677" class="js-smell-location">1</a>                  <a href="update_release.html#L679" class="js-smell-location">2</a>                  <a href="update_release.html#L680" class="js-smell-location">3</a>                  <a href="update_release.html#L683" class="js-smell-location">4</a>                  <a href="update_release.html#L685" class="js-smell-location">5</a>                  </div>  </li></ol>
&#39;#{compiled_pkg.stemcell_os}/#{compiled_pkg.stemcell_version}&#39; with blobstore_id &#39;#{compiled_pkg.blobstore_id}&#39;&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages calls 'compiled_pkg.blobstore_id' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L677" class="js-smell-location">0</a>                  <a href="update_release.html#L680" class="js-smell-location">1</a>                  <a href="update_release.html#L683" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L677" class="js-smell-location">1</a>                  <a href="update_release.html#L679" class="js-smell-location">2</a>                  <a href="update_release.html#L680" class="js-smell-location">3</a>                  <a href="update_release.html#L683" class="js-smell-location">4</a>                  <a href="update_release.html#L685" class="js-smell-location">5</a>                  </div>  </li></ol>
          begin
            logger.info(&quot;Deleting compiled package &#39;#{compiled_pkg.name}&#39;&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L679" class="js-smell-location">0</a>                  <a href="update_release.html#L690" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages calls 'compiled_pkg.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L679" class="js-smell-location">1</a>                  <a href="update_release.html#L683" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L677" class="js-smell-location">1</a>                  <a href="update_release.html#L679" class="js-smell-location">2</a>                  <a href="update_release.html#L680" class="js-smell-location">3</a>                  <a href="update_release.html#L683" class="js-smell-location">4</a>                  <a href="update_release.html#L685" class="js-smell-location">5</a>                  </div>  </li></ol>
            BlobUtil.delete_blob(compiled_pkg.blobstore_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages calls 'compiled_pkg.blobstore_id' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L677" class="js-smell-location">0</a>                  <a href="update_release.html#L680" class="js-smell-location">1</a>                  <a href="update_release.html#L683" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L677" class="js-smell-location">1</a>                  <a href="update_release.html#L679" class="js-smell-location">2</a>                  <a href="update_release.html#L680" class="js-smell-location">3</a>                  <a href="update_release.html#L683" class="js-smell-location">4</a>                  <a href="update_release.html#L685" class="js-smell-location">5</a>                  </div>  </li></ol>
          rescue Bosh::Blobstore::BlobstoreError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages has the variable name 'e'</span>          </div>  </li></ol>
            logger.info(&quot;Error deleting compiled package \
&#39;#{compiled_pkg.blobstore_id}/#{compiled_pkg.name}&#39; #{e.inspect}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages calls 'compiled_pkg.blobstore_id' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L677" class="js-smell-location">0</a>                  <a href="update_release.html#L680" class="js-smell-location">1</a>                  <a href="update_release.html#L683" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages calls 'compiled_pkg.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L679" class="js-smell-location">1</a>                  <a href="update_release.html#L683" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L677" class="js-smell-location">1</a>                  <a href="update_release.html#L679" class="js-smell-location">2</a>                  <a href="update_release.html#L680" class="js-smell-location">3</a>                  <a href="update_release.html#L683" class="js-smell-location">4</a>                  <a href="update_release.html#L685" class="js-smell-location">5</a>                  </div>  </li></ol>
          end
          compiled_pkg.destroy<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#delete_compiled_packages refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L676" class="js-smell-location">0</a>                  <a href="update_release.html#L677" class="js-smell-location">1</a>                  <a href="update_release.html#L679" class="js-smell-location">2</a>                  <a href="update_release.html#L680" class="js-smell-location">3</a>                  <a href="update_release.html#L683" class="js-smell-location">4</a>                  <a href="update_release.html#L685" class="js-smell-location">5</a>                  </div>  </li></ol>
        end<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package has a flog score of 29</span>          </div>  </li></ol>
      end

      def fix_compiled_package(compiled_pkg, compiled_pkg_tgz)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package has approx 7 statements</span>          </div>  </li></ol>
        begin<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="update_release.html#L679" class="js-smell-location">0</a>                  <a href="update_release.html#L690" class="js-smell-location">1</a>                  </div>  </li></ol>
          logger.info(&quot;Deleting compiled package &#39;#{compiled_pkg.name}/#{compiled_pkg.version}&#39; for \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L695" class="js-smell-location">1</a>                  <a href="update_release.html#L699" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.version' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L699" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
&#39;#{compiled_pkg.stemcell_os}/#{compiled_pkg.stemcell_version}&#39; with blobstore_id &#39;#{compiled_pkg.blobstore_id}&#39;&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L692" class="js-smell-location">0</a>                  <a href="update_release.html#L693" class="js-smell-location">1</a>                  <a href="update_release.html#L696" class="js-smell-location">2</a>                  <a href="update_release.html#L700" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
          BlobUtil.delete_blob compiled_pkg.blobstore_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L692" class="js-smell-location">0</a>                  <a href="update_release.html#L693" class="js-smell-location">1</a>                  <a href="update_release.html#L696" class="js-smell-location">2</a>                  <a href="update_release.html#L700" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
        rescue Bosh::Blobstore::BlobstoreError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package has the variable name 'e'</span>          </div>  </li></ol>
          logger.info(&quot;Error deleting compiled package &#39;#{compiled_pkg.name}&#39; \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L695" class="js-smell-location">1</a>                  <a href="update_release.html#L699" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
with blobstore_id &#39;#{compiled_pkg.blobstore_id}&#39; #{e.inspect}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L692" class="js-smell-location">0</a>                  <a href="update_release.html#L693" class="js-smell-location">1</a>                  <a href="update_release.html#L696" class="js-smell-location">2</a>                  <a href="update_release.html#L700" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
        end
        compiled_pkg.blobstore_id = BlobUtil.create_blob(compiled_pkg_tgz)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
        logger.info(&quot;Re-created compiled package &#39;#{compiled_pkg.name}/#{compiled_pkg.version}&#39; \<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.name' 3 times</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L695" class="js-smell-location">1</a>                  <a href="update_release.html#L699" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.version' 2 times</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L699" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
with blobstore_id &#39;#{compiled_pkg.blobstore_id}&#39;&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package calls 'compiled_pkg.blobstore_id' 4 times</span>              <span>Locations:</span>                  <a href="update_release.html#L692" class="js-smell-location">0</a>                  <a href="update_release.html#L693" class="js-smell-location">1</a>                  <a href="update_release.html#L696" class="js-smell-location">2</a>                  <a href="update_release.html#L700" class="js-smell-location">3</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
        compiled_pkg.save<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::Jobs::UpdateRelease#fix_compiled_package refers to 'compiled_pkg' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="update_release.html#L691" class="js-smell-location">0</a>                  <a href="update_release.html#L692" class="js-smell-location">1</a>                  <a href="update_release.html#L693" class="js-smell-location">2</a>                  <a href="update_release.html#L695" class="js-smell-location">3</a>                  <a href="update_release.html#L696" class="js-smell-location">4</a>                  <a href="update_release.html#L698" class="js-smell-location">5</a>                  <a href="update_release.html#L699" class="js-smell-location">6</a>                  <a href="update_release.html#L700" class="js-smell-location">7</a>                  <a href="update_release.html#L701" class="js-smell-location">8</a>                  </div>  </li></ol>
      end
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../assets/javascripts/prettify.js'></script>
    <script src='../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../assets/javascripts/application.js'></script>
    <script src='../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
