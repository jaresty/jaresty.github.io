<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../overview.html"><img src="../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2018-06-20 14:05:19 -0400'>2018-06-20 14:05:19 -0400</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh/director /</small> instance_updater.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">281</span><small> lines of codes</small></div>
              <div><span class="metric">11</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">31.5</span><small> complexity/method</small></div>
              <div><span class="metric">256</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">346.23</span><small> complexity</small></div>
              <div><span class="metric">0</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                51
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">require &#39;bosh/director/rendered_job_templates_cleaner&#39;

module Bosh::Director
  class InstanceUpdater<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Instance-Variable-Assumption.md" target="_blank"><b>InstanceVariableAssumption</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater assumes too much for instance variable '@links_manager'</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater has at least 10 instance variables</span>          </div>  </li></ol>
    MAX_RECREATE_ATTEMPTS = 3

    def self.new_instance_updater(ip_provider, template_blob_cache, dns_encoder)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#self.new_instance_updater has approx 9 statements</span>          </div>  </li></ol>
      logger = Config.logger
      disk_manager = DiskManager.new(logger)
      agent_broadcaster = AgentBroadcaster.new
      vm_deleter = VmDeleter.new(false, Config.enable_virtual_delete_vms)
      dns_state_updater = DirectorDnsStateUpdater.new(dns_encoder)
      vm_creator = VmCreator.new(logger, template_blob_cache, dns_encoder, agent_broadcaster)
      blobstore_client = App.instance.blobstores.blobstore
      rendered_templates_persistor = RenderedTemplatesPersister.new(blobstore_client, logger)
      new(
        logger,
        ip_provider,
        blobstore_client,
        dns_state_updater,
        vm_deleter,
        vm_creator,
        disk_manager,
        rendered_templates_persistor
      )
    end

    def initialize(logger,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#initialize has 8 parameters</span>          </div>  </li></ol>
                   ip_provider,
                   blobstore,
                   dns_state_updater,
                   vm_deleter,
                   vm_creator,
                   disk_manager,
                   rendered_templates_persistor)
      @logger = logger
      @blobstore = blobstore
      @dns_state_updater = dns_state_updater
      @vm_deleter = vm_deleter
      @vm_creator = vm_creator
      @disk_manager = disk_manager
      @ip_provider = ip_provider
      @rendered_templates_persistor = rendered_templates_persistor
      @current_state = {}
    end

    def update(instance_plan, options = {})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>VeryHighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update has a flog score of 247</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update has approx 70 statements</span>          </div>  </li></ol>
      instance = instance_plan.instance<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.instance' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L48" class="js-smell-location">0</a>                  <a href="instance_updater.html#L97" class="js-smell-location">1</a>                  <a href="instance_updater.html#L114" class="js-smell-location">2</a>                  </div>  </li></ol>
      @links_manager = Bosh::Director::Links::LinksManager.new(instance.deployment_model.links_serial_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.deployment_model' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L49" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L194" class="js-smell-location">2</a>                  </div>  </li></ol>
      instance_report = DeploymentPlan::Stages::Report.new.tap { |r| r.vm = instance.model.active_vm }<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.model' 5 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L50" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L80" class="js-smell-location">2</a>                  <a href="instance_updater.html#L174" class="js-smell-location">3</a>                  <a href="instance_updater.html#L192" class="js-smell-location">4</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update has the variable name 'r'</span>          </div>  </li></ol>
      action, context = get_action_and_context(instance_plan)
      parent_id = add_event(instance.deployment_model.name, action, instance.model.name, context) if instance_plan.changed?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.deployment_model' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L49" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L194" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.deployment_model.name' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L52" class="js-smell-location">0</a>                  <a href="instance_updater.html#L194" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.model' 5 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L50" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L80" class="js-smell-location">2</a>                  <a href="instance_updater.html#L174" class="js-smell-location">3</a>                  <a href="instance_updater.html#L192" class="js-smell-location">4</a>                  </div>  </li></ol>
      @logger.info(&quot;Updating instance #{instance}, changes: #{instance_plan.changes.to_a.join(&#39;, &#39;).inspect}&quot;)

      update_procedure = lambda do
        # Optimization to only update DNS if nothing else changed.
        if dns_change_only?(instance_plan)
          @logger.debug(&#39;Only change is DNS configuration&#39;)
          update_dns(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'update_dns(instance_plan)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L59" class="js-smell-location">0</a>                  <a href="instance_updater.html#L106" class="js-smell-location">1</a>                  <a href="instance_updater.html#L169" class="js-smell-location">2</a>                  </div>  </li></ol>
          return
        end

        links_bound_to_instance = false

        unless instance_plan.already_detached?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.already_detached?' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L65" class="js-smell-location">0</a>                  <a href="instance_updater.html#L96" class="js-smell-location">1</a>                  </div>  </li></ol>
          # Rendered templates are persisted here, in the case where a vm is already soft stopped
          # It will update the rendered templates on the VM
          unless Config.enable_nats_delivered_templates &amp;&amp; needs_recreate?(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'needs_recreate?(instance_plan)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L68" class="js-smell-location">0</a>                  <a href="instance_updater.html#L116" class="js-smell-location">1</a>                  </div>  </li></ol>
            @rendered_templates_persistor.persist(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls '@rendered_templates_persistor.persist(instance_plan)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L69" class="js-smell-location">0</a>                  <a href="instance_updater.html#L176" class="js-smell-location">1</a>                  </div>  </li></ol>
            @links_manager.bind_links_to_instance(instance)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls '@links_manager.bind_links_to_instance(instance)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L70" class="js-smell-location">0</a>                  <a href="instance_updater.html#L103" class="js-smell-location">1</a>                  <a href="instance_updater.html#L178" class="js-smell-location">2</a>                  </div>  </li></ol>
            instance.update_variable_set<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.update_variable_set' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L71" class="js-smell-location">0</a>                  <a href="instance_updater.html#L105" class="js-smell-location">1</a>                  <a href="instance_updater.html#L177" class="js-smell-location">2</a>                  </div>  </li></ol>
            links_bound_to_instance = true
          end

          unless instance_plan.needs_shutting_down? || instance.state == &#39;detached&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.state == 'detached'' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L75" class="js-smell-location">0</a>                  <a href="instance_updater.html#L93" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.state' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L75" class="js-smell-location">0</a>                  <a href="instance_updater.html#L86" class="js-smell-location">1</a>                  <a href="instance_updater.html#L93" class="js-smell-location">2</a>                  </div>  </li></ol>
            DeploymentPlan::Steps::PrepareInstanceStep.new(instance_plan).perform(instance_report)
          end

          # current state
          if instance.model.state != &#39;stopped&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.model' 5 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L50" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L80" class="js-smell-location">2</a>                  <a href="instance_updater.html#L174" class="js-smell-location">3</a>                  <a href="instance_updater.html#L192" class="js-smell-location">4</a>                  </div>  </li></ol>
            stop(instance_plan)
            take_snapshot(instance)
          end

          # desired state
          if instance.state == &#39;stopped&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.state' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L75" class="js-smell-location">0</a>                  <a href="instance_updater.html#L86" class="js-smell-location">1</a>                  <a href="instance_updater.html#L93" class="js-smell-location">2</a>                  </div>  </li></ol>
            # Command issued: `bosh stop`
            instance.update_state<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.update_state' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L88" class="js-smell-location">0</a>                  <a href="instance_updater.html#L104" class="js-smell-location">1</a>                  </div>  </li></ol>
            return
          end
        end

        if instance.state == &#39;detached&#39;<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.state == 'detached'' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L75" class="js-smell-location">0</a>                  <a href="instance_updater.html#L93" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.state' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L75" class="js-smell-location">0</a>                  <a href="instance_updater.html#L86" class="js-smell-location">1</a>                  <a href="instance_updater.html#L93" class="js-smell-location">2</a>                  </div>  </li></ol>
          # Command issued: `bosh stop --hard`
          @logger.info(&quot;Detaching instance #{instance}&quot;)
          unless instance_plan.already_detached?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.already_detached?' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L65" class="js-smell-location">0</a>                  <a href="instance_updater.html#L96" class="js-smell-location">1</a>                  </div>  </li></ol>
            instance_model = instance_plan.new? ? instance_plan.instance.model : instance_plan.existing_instance<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.instance' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L48" class="js-smell-location">0</a>                  <a href="instance_updater.html#L97" class="js-smell-location">1</a>                  <a href="instance_updater.html#L114" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.instance.model' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L97" class="js-smell-location">0</a>                  <a href="instance_updater.html#L114" class="js-smell-location">1</a>                  </div>  </li></ol>
            DeploymentPlan::Steps::UnmountInstanceDisksStep.new(instance_model).perform(instance_report)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'DeploymentPlan::Steps::UnmountInstanceDisksStep.new(instance_model).perform(instance_report)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L98" class="js-smell-location">0</a>                  <a href="instance_updater.html#L128" class="js-smell-location">1</a>                  </div>  </li></ol>
            DeploymentPlan::Steps::DeleteVmStep.new(true, false, Config.enable_virtual_delete_vms)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'Config.enable_virtual_delete_vms' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L99" class="js-smell-location">0</a>                  <a href="instance_updater.html#L125" class="js-smell-location">1</a>                  <a href="instance_updater.html#L156" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'DeploymentPlan::Steps::DeleteVmStep.new(true, false, Config.enable_virtual_delete_vms); .perform(instance_report)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L99" class="js-smell-location">0</a>                  <a href="instance_updater.html#L124" class="js-smell-location">1</a>                  <a href="instance_updater.html#L155" class="js-smell-location">2</a>                  </div>  </li></ol>
                                               .perform(instance_report)
          end
          instance_plan.release_obsolete_network_plans(@ip_provider)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.release_obsolete_network_plans(@ip_provider)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L102" class="js-smell-location">0</a>                  <a href="instance_updater.html#L166" class="js-smell-location">1</a>                  </div>  </li></ol>
          @links_manager.bind_links_to_instance(instance)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls '@links_manager.bind_links_to_instance(instance)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L70" class="js-smell-location">0</a>                  <a href="instance_updater.html#L103" class="js-smell-location">1</a>                  <a href="instance_updater.html#L178" class="js-smell-location">2</a>                  </div>  </li></ol>
          instance.update_state<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.update_state' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L88" class="js-smell-location">0</a>                  <a href="instance_updater.html#L104" class="js-smell-location">1</a>                  </div>  </li></ol>
          instance.update_variable_set<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.update_variable_set' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L71" class="js-smell-location">0</a>                  <a href="instance_updater.html#L105" class="js-smell-location">1</a>                  <a href="instance_updater.html#L177" class="js-smell-location">2</a>                  </div>  </li></ol>
          update_dns(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'update_dns(instance_plan)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L59" class="js-smell-location">0</a>                  <a href="instance_updater.html#L106" class="js-smell-location">1</a>                  <a href="instance_updater.html#L169" class="js-smell-location">2</a>                  </div>  </li></ol>
          return
        end

        recreated = false
        deleted_vm = false
        deleted_vm_id = -1

        instance_model = instance_plan.instance.model<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.instance' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L48" class="js-smell-location">0</a>                  <a href="instance_updater.html#L97" class="js-smell-location">1</a>                  <a href="instance_updater.html#L114" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.instance.model' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L97" class="js-smell-location">0</a>                  <a href="instance_updater.html#L114" class="js-smell-location">1</a>                  </div>  </li></ol>

        if needs_recreate?(instance_plan) || (instance_plan.should_create_swap_delete? &amp;&amp; instance_model.vms.count &gt; 1)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.vms' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  <a href="instance_updater.html#L142" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.vms.count > 1' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.vms.count' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.should_create_swap_delete?' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'needs_recreate?(instance_plan)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L68" class="js-smell-location">0</a>                  <a href="instance_updater.html#L116" class="js-smell-location">1</a>                  </div>  </li></ol>
          new_vm = instance_model.most_recent_inactive_vm || instance_model.active_vm<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.active_vm' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L117" class="js-smell-location">0</a>                  <a href="instance_updater.html#L148" class="js-smell-location">1</a>                  <a href="instance_updater.html#L167" class="js-smell-location">2</a>                  </div>  </li></ol>

          @logger.debug(&#39;Failed to update in place. Recreating VM&#39;)
          if instance_plan.unresponsive_agent?
            deleted_vm_id = instance_report.vm.id
            deleted_vm = true

            DeploymentPlan::Steps::DeleteVmStep<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'DeploymentPlan::Steps::DeleteVmStep.new(true, false, Config.enable_virtual_delete_vms); .perform(instance_report)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L99" class="js-smell-location">0</a>                  <a href="instance_updater.html#L124" class="js-smell-location">1</a>                  <a href="instance_updater.html#L155" class="js-smell-location">2</a>                  </div>  </li></ol>
              .new(true, false, Config.enable_virtual_delete_vms)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'Config.enable_virtual_delete_vms' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L99" class="js-smell-location">0</a>                  <a href="instance_updater.html#L125" class="js-smell-location">1</a>                  <a href="instance_updater.html#L156" class="js-smell-location">2</a>                  </div>  </li></ol>
              .perform(instance_report)
          else
            DeploymentPlan::Steps::UnmountInstanceDisksStep.new(instance_model).perform(instance_report)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'DeploymentPlan::Steps::UnmountInstanceDisksStep.new(instance_model).perform(instance_report)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L98" class="js-smell-location">0</a>                  <a href="instance_updater.html#L128" class="js-smell-location">1</a>                  </div>  </li></ol>
            DeploymentPlan::Steps::DetachInstanceDisksStep.new(instance_model).perform(instance_report)
          end

          tags = instance_plan.tags<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.tags' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L132" class="js-smell-location">0</a>                  <a href="instance_updater.html#L150" class="js-smell-location">1</a>                  </div>  </li></ol>

          disks = instance_model.active_persistent_disks.collection
                                .map(&amp;:model)
                                .map(&amp;:disk_cid).compact

          if instance_plan.should_create_swap_delete? &amp;&amp; instance_model.vms.count &gt; 1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.vms' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  <a href="instance_updater.html#L142" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.vms.count > 1' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.vms.count' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.should_create_swap_delete?' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  </div>  </li></ol>
            instance_report.vm = new_vm
            DeploymentPlan::Steps::ElectActiveVmStep.new.perform(instance_report)

            instance_model.vms.reject { |vm| vm.id == new_vm.id || vm.id == deleted_vm_id }.each do |inactive_vm|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.vms' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L116" class="js-smell-location">0</a>                  <a href="instance_updater.html#L138" class="js-smell-location">1</a>                  <a href="instance_updater.html#L142" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'vm.id' 2 times</span>          </div>  </li></ol>
              ips = inactive_vm.ip_addresses.map(&amp;:address_str)
              DeploymentPlan::Steps::OrphanVmStep.new(inactive_vm).perform(instance_report)
              instance_plan.remove_obsolete_network_plans_for_ips(ips)
            end

            instance_report.vm = instance_model.active_vm<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.active_vm' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L117" class="js-smell-location">0</a>                  <a href="instance_updater.html#L148" class="js-smell-location">1</a>                  <a href="instance_updater.html#L167" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_report.vm = instance_model.active_vm' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L148" class="js-smell-location">0</a>                  <a href="instance_updater.html#L167" class="js-smell-location">1</a>                  </div>  </li></ol>
            if instance_plan.needs_disk?
              DeploymentPlan::Steps::AttachInstanceDisksStep.new(instance_model, instance_plan.tags).perform(instance_report)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.tags' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L132" class="js-smell-location">0</a>                  <a href="instance_updater.html#L150" class="js-smell-location">1</a>                  </div>  </li></ol>
              DeploymentPlan::Steps::MountInstanceDisksStep.new(instance_model).perform(instance_report)
            end
          else
            unless deleted_vm
              DeploymentPlan::Steps::DeleteVmStep<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'DeploymentPlan::Steps::DeleteVmStep.new(true, false, Config.enable_virtual_delete_vms); .perform(instance_report)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L99" class="js-smell-location">0</a>                  <a href="instance_updater.html#L124" class="js-smell-location">1</a>                  <a href="instance_updater.html#L155" class="js-smell-location">2</a>                  </div>  </li></ol>
                .new(true, false, Config.enable_virtual_delete_vms)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'Config.enable_virtual_delete_vms' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L99" class="js-smell-location">0</a>                  <a href="instance_updater.html#L125" class="js-smell-location">1</a>                  <a href="instance_updater.html#L156" class="js-smell-location">2</a>                  </div>  </li></ol>
                .perform(instance_report)
            end

            @vm_creator.create_for_instance_plan(instance_plan, @ip_provider, disks, tags)
          end

          recreated = true
        end

        instance_plan.release_obsolete_network_plans(@ip_provider)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_plan.release_obsolete_network_plans(@ip_provider)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L102" class="js-smell-location">0</a>                  <a href="instance_updater.html#L166" class="js-smell-location">1</a>                  </div>  </li></ol>
        instance_report.vm = instance_model.active_vm<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_model.active_vm' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L117" class="js-smell-location">0</a>                  <a href="instance_updater.html#L148" class="js-smell-location">1</a>                  <a href="instance_updater.html#L167" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance_report.vm = instance_model.active_vm' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L148" class="js-smell-location">0</a>                  <a href="instance_updater.html#L167" class="js-smell-location">1</a>                  </div>  </li></ol>

        update_dns(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'update_dns(instance_plan)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L59" class="js-smell-location">0</a>                  <a href="instance_updater.html#L106" class="js-smell-location">1</a>                  <a href="instance_updater.html#L169" class="js-smell-location">2</a>                  </div>  </li></ol>
        @disk_manager.update_persistent_disk(instance_plan)

        instance.update_instance_settings unless recreated

        cleaner = RenderedJobTemplatesCleaner.new(instance.model, @blobstore, @logger)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.model' 5 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L50" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L80" class="js-smell-location">2</a>                  <a href="instance_updater.html#L174" class="js-smell-location">3</a>                  <a href="instance_updater.html#L192" class="js-smell-location">4</a>                  </div>  </li></ol>

        @rendered_templates_persistor.persist(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls '@rendered_templates_persistor.persist(instance_plan)' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L69" class="js-smell-location">0</a>                  <a href="instance_updater.html#L176" class="js-smell-location">1</a>                  </div>  </li></ol>
        instance.update_variable_set<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.update_variable_set' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L71" class="js-smell-location">0</a>                  <a href="instance_updater.html#L105" class="js-smell-location">1</a>                  <a href="instance_updater.html#L177" class="js-smell-location">2</a>                  </div>  </li></ol>
        @links_manager.bind_links_to_instance(instance) unless links_bound_to_instance<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls '@links_manager.bind_links_to_instance(instance)' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L70" class="js-smell-location">0</a>                  <a href="instance_updater.html#L103" class="js-smell-location">1</a>                  <a href="instance_updater.html#L178" class="js-smell-location">2</a>                  </div>  </li></ol>

        state_applier = InstanceUpdater::StateApplier.new(
          instance_plan,
          agent(instance),
          cleaner,
          @logger,
          canary: options[:canary],
        )
        state_applier.apply(instance_plan.desired_instance.instance_group.update)
      end

      InstanceUpdater::InstanceState
        .with_instance_update_and_event_creation(
          instance.model,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.model' 5 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L50" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L80" class="js-smell-location">2</a>                  <a href="instance_updater.html#L174" class="js-smell-location">3</a>                  <a href="instance_updater.html#L192" class="js-smell-location">4</a>                  </div>  </li></ol>
          parent_id,
          instance.deployment_model.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.deployment_model' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L49" class="js-smell-location">0</a>                  <a href="instance_updater.html#L52" class="js-smell-location">1</a>                  <a href="instance_updater.html#L194" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update calls 'instance.deployment_model.name' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L52" class="js-smell-location">0</a>                  <a href="instance_updater.html#L194" class="js-smell-location">1</a>                  </div>  </li></ol>
          action,
          &amp;update_procedure
        )
    end

    private

    def add_event(deployment_name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Long-Parameter-List.md" target="_blank"><b>LongParameterList</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#add_event has 6 parameters</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#add_event doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
                  action, instance_name = nil,
                  context = nil,
                  parent_id = nil,
                  error = nil)
      event = Config.current_job.event_manager.create_event(<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#add_event calls 'Config.current_job' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L207" class="js-smell-location">0</a>                  <a href="instance_updater.html#L209" class="js-smell-location">1</a>                  <a href="instance_updater.html#L213" class="js-smell-location">2</a>                  </div>  </li></ol>
        parent_id: parent_id,
        user: Config.current_job.username,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#add_event calls 'Config.current_job' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L207" class="js-smell-location">0</a>                  <a href="instance_updater.html#L209" class="js-smell-location">1</a>                  <a href="instance_updater.html#L213" class="js-smell-location">2</a>                  </div>  </li></ol>
        action: action,
        object_type: &#39;instance&#39;,
        object_name: instance_name,
        task: Config.current_job.task_id,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#add_event calls 'Config.current_job' 3 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L207" class="js-smell-location">0</a>                  <a href="instance_updater.html#L209" class="js-smell-location">1</a>                  <a href="instance_updater.html#L213" class="js-smell-location">2</a>                  </div>  </li></ol>
        deployment: deployment_name,
        instance: instance_name,
        error: error,
        context: context ? context : {},
      )
      event.id
    end

    def get_action_and_context(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context has a flog score of 31</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context has approx 12 statements</span>          </div>  </li></ol>
      changes = instance_plan.changes<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context refers to 'instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_updater.html#L223" class="js-smell-location">0</a>                  <a href="instance_updater.html#L226" class="js-smell-location">1</a>                  <a href="instance_updater.html#L234" class="js-smell-location">2</a>                  <a href="instance_updater.html#L237" class="js-smell-location">3</a>                  <a href="instance_updater.html#L238" class="js-smell-location">4</a>                  </div>  </li></ol>
      context = {}
      if changes.size == 1 &amp;&amp; %i[state restart].include?(changes.first)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'changes.first' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L225" class="js-smell-location">0</a>                  <a href="instance_updater.html#L241" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'changes.size == 1' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L225" class="js-smell-location">0</a>                  <a href="instance_updater.html#L241" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'changes.size' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L225" class="js-smell-location">0</a>                  <a href="instance_updater.html#L241" class="js-smell-location">1</a>                  </div>  </li></ol>
        action = case instance_plan.instance.virtual_state<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'instance_plan.instance' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L226" class="js-smell-location">0</a>                  <a href="instance_updater.html#L234" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'instance_plan.instance.virtual_state' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L226" class="js-smell-location">0</a>                  <a href="instance_updater.html#L234" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context refers to 'instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_updater.html#L223" class="js-smell-location">0</a>                  <a href="instance_updater.html#L226" class="js-smell-location">1</a>                  <a href="instance_updater.html#L234" class="js-smell-location">2</a>                  <a href="instance_updater.html#L237" class="js-smell-location">3</a>                  <a href="instance_updater.html#L238" class="js-smell-location">4</a>                  </div>  </li></ol>
                 when &#39;started&#39;
                   &#39;start&#39;
                 when &#39;stopped&#39;
                   &#39;stop&#39;
                 when &#39;detached&#39;
                   &#39;stop&#39;
                 else
                   instance_plan.instance.virtual_state<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'instance_plan.instance' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L226" class="js-smell-location">0</a>                  <a href="instance_updater.html#L234" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'instance_plan.instance.virtual_state' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L226" class="js-smell-location">0</a>                  <a href="instance_updater.html#L234" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context refers to 'instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_updater.html#L223" class="js-smell-location">0</a>                  <a href="instance_updater.html#L226" class="js-smell-location">1</a>                  <a href="instance_updater.html#L234" class="js-smell-location">2</a>                  <a href="instance_updater.html#L237" class="js-smell-location">3</a>                  <a href="instance_updater.html#L238" class="js-smell-location">4</a>                  </div>  </li></ol>
                 end
      else
        context[&#39;az&#39;] = instance_plan.desired_az_name if instance_plan.desired_az_name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'instance_plan.desired_az_name' 2 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context refers to 'instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_updater.html#L223" class="js-smell-location">0</a>                  <a href="instance_updater.html#L226" class="js-smell-location">1</a>                  <a href="instance_updater.html#L234" class="js-smell-location">2</a>                  <a href="instance_updater.html#L237" class="js-smell-location">3</a>                  <a href="instance_updater.html#L238" class="js-smell-location">4</a>                  </div>  </li></ol>
        if instance_plan.new?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context refers to 'instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_updater.html#L223" class="js-smell-location">0</a>                  <a href="instance_updater.html#L226" class="js-smell-location">1</a>                  <a href="instance_updater.html#L234" class="js-smell-location">2</a>                  <a href="instance_updater.html#L237" class="js-smell-location">3</a>                  <a href="instance_updater.html#L238" class="js-smell-location">4</a>                  </div>  </li></ol>
          action = &#39;create&#39;
        else
          context[&#39;changes&#39;] = changes.to_a unless changes.size == 1 &amp;&amp; changes.first == :recreate<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'changes.first' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L225" class="js-smell-location">0</a>                  <a href="instance_updater.html#L241" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'changes.size == 1' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L225" class="js-smell-location">0</a>                  <a href="instance_updater.html#L241" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#get_action_and_context calls 'changes.size' 2 times</span>              <span>Locations:</span>                  <a href="instance_updater.html#L225" class="js-smell-location">0</a>                  <a href="instance_updater.html#L241" class="js-smell-location">1</a>                  </div>  </li></ol>
          action = needs_recreate?(instance_plan) ? &#39;recreate&#39; : &#39;update&#39;
        end
      end
      [action, context]
    end

    def stop(instance_plan)
      instance = instance_plan.instance
      stopper = Stopper.new(instance_plan, instance.state, Config, @logger)
      stopper.stop
    end

    def take_snapshot(instance)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#take_snapshot doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      Api::SnapshotManager.take_snapshot(instance.model, clean: true)
    end

    def update_dns(instance_plan)
      return unless instance_plan.dns_changed?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update_dns refers to 'instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_updater.html#L259" class="js-smell-location">0</a>                  <a href="instance_updater.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>

      @dns_state_updater.update_dns_for_instance(instance_plan.instance.model, instance_plan.network_settings.dns_record_info)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#update_dns refers to 'instance_plan' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_updater.html#L259" class="js-smell-location">0</a>                  <a href="instance_updater.html#L261" class="js-smell-location">1</a>                  </div>  </li></ol>
    end

    def dns_change_only?(instance_plan)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#dns_change_only? doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      instance_plan.changes.include?(:dns) &amp;&amp; instance_plan.changes.size == 1<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#dns_change_only? calls 'instance_plan.changes' 2 times</span>          </div>  </li></ol>
    end

    def needs_recreate?(instance_plan)
      if instance_plan.needs_shutting_down?
        @logger.debug(&#39;VM needs to be shutdown before it can be updated.&#39;)
        return true
      end

      false
    end

    def agent(instance)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Director::InstanceUpdater#agent doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      AgentClient.with_agent_id(instance.model.agent_id)
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../assets/javascripts/jquery.min.js'></script>
    <script src='../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../assets/javascripts/prettify.js'></script>
    <script src='../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../assets/javascripts/application.js'></script>
    <script src='../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
