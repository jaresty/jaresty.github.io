<!DOCTYPE html>
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ruby Critic - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- StyleSheets -->
    <link href="../../../../assets/stylesheets/bootstrap.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/font-awesome.min.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  </head>

  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <a href="#menu-toggle" class="btn btn-default hidden-lg visible-sm-* hidden-md visible-xs-* pull-left" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a>
      <a href="../../../../overview.html"><img src="../../../../assets/images/logo.png" title="Ruby Critic Logo" width="55"><span class="logo">RUBYCRITIC</span></a>
    </header>
    <div id="wrapper">
      <!-- Sidebar -->
      <aside id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-item">
            <a href="../../../../overview.html" class="project-nav-item overview-nav"><i class="fa fa-dashboard"></i>Overview</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../code_index.html" class="project-nav-item code-index-nav"><i class="fa fa-code"></i>Code</a>
          </li>
          <li class="sidebar-item">
            <a href="../../../../smells_index.html" class="project-nav-item smells-index-nav"><i class="fa fa-warning"></i>Smells</a>
          </li>
        </ul>
      </aside>
      <!-- /#sidebar-wrapper -->
      <div id="page-content-wrapper">
        <div class="container-fluid">
          <div class="row">
  <!--Page Title -->
  <div class="Page_Title">
    <div class="file-time">
      <span class="committed-at">
        
          Updated <time class='js-timeago' datetime='2017-08-21 14:36:44 -0700'>2017-08-21 14:36:44 -0700</time>
        
      </span>
    </div>
    <div>
      <h3><small>bosh-monitor/lib/bosh/monitor /</small> instance_manager.rb</h3>
    </div>
  </div>
  <!--End Page Title -->
  <div class="Content_Wrapper">
    <!-- code detail -->
    <div class="code-top-detail clearfix row">
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-1">
            <div class="rating d big">
              D
            </div>
          </div>
          <div class="code-statistics col-md-11">
            <div class="col-md-3">
              <div><span class="metric">393</span><small> lines of codes</small></div>
              <div><span class="metric">36</span><small> methods</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">9.1</span><small> complexity/method</small></div>
              <div><span class="metric">43</span><small> churn</small></div>
            </div>
            <div class="col-md-3">
              <div><span class="metric">326.45</span><small> complexity</small></div>
              <div><span class="metric">34</span><small> duplications</small></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="code-tabs">
          <ul class="nav nav-pills right-to-left">
            <li><a href="#" id="toggle-code" class="toggle-button button">code</a></li>
            <li class="active">
              <a href="#" id="toggle-smells" class="toggle-button button">
                50
                smells
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <code class="prettyprint linenums lang-ruby file-code js-file-code">module Bosh::Monitor

  class InstanceManager<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank"><b>IrresponsibleModule</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager has no descriptive comment</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank"><b>TooManyInstanceVariables</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager has at least 7 instance variables</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Methods.md" target="_blank"><b>TooManyMethods</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager has at least 36 methods</span>          </div>  </li></ol>
    attr_reader :heartbeats_received
    attr_reader :alerts_received
    attr_reader :alerts_processed

    attr_accessor :processor<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank"><b>Attribute</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#processor is a writable attribute</span>          </div>  </li></ol>

    def initialize(event_processor)
      # hash of agent_id to agent for all rogue agents
      @rogue_agents = {}
      # hash of deployment_name to deployment for all managed deployments
      @deployment_name_to_deployments = {}

      @logger = Bhm.logger
      @heartbeats_received = 0
      @alerts_received = 0
      @alerts_processed = 0

      @processor = event_processor
    end

    # Get a hash of agent id -&gt; agent object for all agents associated with the deployment
    def get_agents_for_deployment(deployment_name)
      deployment = @deployment_name_to_deployments[deployment_name]
      deployment ? deployment.agent_id_to_agent : {}<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager tests 'deployment' at least 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L27" class="js-smell-location">0</a>                  <a href="instance_manager.html#L32" class="js-smell-location">1</a>                  <a href="instance_manager.html#L274" class="js-smell-location">2</a>                  </div>  </li></ol>
    end

    def get_deleted_agents_for_deployment(deployment_name)
      deployment = @deployment_name_to_deployments[deployment_name]
      deployment ? deployment.instance_id_to_agent: {}<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager tests 'deployment' at least 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L27" class="js-smell-location">0</a>                  <a href="instance_manager.html#L32" class="js-smell-location">1</a>                  <a href="instance_manager.html#L274" class="js-smell-location">2</a>                  </div>  </li></ol>
    end

    def setup_events<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#setup_events has a flog score of 26</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#setup_events has approx 10 statements</span>          </div>  </li></ol>
      @processor.enable_pruning(Bhm.intervals.prune_events)
      Bhm.plugins.each do |plugin|
        @processor.add_plugin(lookup_plugin(plugin[&#39;name&#39;], plugin[&#39;options&#39;]), plugin[&#39;events&#39;])
      end

      EM.schedule do
        Bhm.nats.subscribe(&#39;hm.agent.heartbeat.*&#39;) do |message, reply, subject|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#setup_events calls 'Bhm.nats' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L42" class="js-smell-location">0</a>                  <a href="instance_manager.html#L46" class="js-smell-location">1</a>                  <a href="instance_manager.html#L50" class="js-smell-location">2</a>                  </div>  </li></ol>
          process_event(:heartbeat, subject, message)
        end

        Bhm.nats.subscribe(&#39;hm.agent.alert.*&#39;) do |message, reply, subject|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#setup_events calls 'Bhm.nats' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L42" class="js-smell-location">0</a>                  <a href="instance_manager.html#L46" class="js-smell-location">1</a>                  <a href="instance_manager.html#L50" class="js-smell-location">2</a>                  </div>  </li></ol>
          process_event(:alert, subject, message)
        end

        Bhm.nats.subscribe(&#39;hm.agent.shutdown.*&#39;) do |message, reply, subject|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#setup_events calls 'Bhm.nats' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L42" class="js-smell-location">0</a>                  <a href="instance_manager.html#L46" class="js-smell-location">1</a>                  <a href="instance_manager.html#L50" class="js-smell-location">2</a>                  </div>  </li></ol>
          process_event(:shutdown, subject, message)
        end
      end
    end

    def agents_count
      agents = Set.new(@rogue_agents.keys)
      agents.merge(all_managed_agent_ids)
      agents.size + all_managed_deleted_agents.size
    end

    def deployments_count
      @deployment_name_to_deployments.size
    end

    # Syncs deployments list received from director
    # with HM deployments.
    # @param deployments Array list of deployments returned by director
    def sync_deployments(deployments)
      active_deployment_names = sync_active_deployments(deployments)
      remove_inactive_deployments(active_deployment_names)
    end

    def sync_deployment_state(deployment, instances_data)
      deployment_name = deployment[&#39;name&#39;]
      sync_teams(deployment)
      sync_instances(deployment_name, instances_data)
      sync_agents(deployment_name, get_instances_for_deployment(deployment_name))
    end

    def sync_instances(deployment_name, instances_data)
      deployment = @deployment_name_to_deployments[deployment_name]
      active_instance_ids = sync_active_instances(deployment, instances_data)
      remove_inactive_instances(active_instance_ids, deployment)
    end

    def sync_agents(deployment_name, instances)
      deployment = @deployment_name_to_deployments[deployment_name]
      active_agent_ids = sync_active_agents(deployment, instances)
      remove_inactive_agents(active_agent_ids, deployment)
      update_rogue_agents(active_agent_ids)
    end

    def get_instances_for_deployment(deployment_name)
      @deployment_name_to_deployments[deployment_name].instances
    end

    def analyze_agents
      @logger.info(&#39;Analyzing agents...&#39;)
      started = Time.now<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agents calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L100" class="js-smell-location">0</a>                  <a href="instance_manager.html#L102" class="js-smell-location">1</a>                  </div>  </li></ol>
      count = analyze_deployment_agents + analyze_rogue_agents
      @logger.info(&#39;Analyzed %s, took %s seconds&#39; % [pluralize(count, &#39;agent&#39;), Time.now - started])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agents calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L100" class="js-smell-location">0</a>                  <a href="instance_manager.html#L102" class="js-smell-location">1</a>                  </div>  </li></ol>
      count
    end

    def analyze_agent(agent)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent has approx 6 statements</span>          </div>  </li></ol>
      ts = Time.now.to_i

      if agent.timed_out? &amp;&amp; agent.rogue?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.rogue?' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L129" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.timed_out?' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L117" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
        # Agent has timed out but it was never
        # actually a proper member of the deployment,
        # so we don&#39;t really care about it
        remove_agent(agent.id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.id' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L113" class="js-smell-location">0</a>                  <a href="instance_manager.html#L122" class="js-smell-location">1</a>                  <a href="instance_manager.html#L133" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
        return
      end

      if agent.timed_out?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.timed_out?' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L117" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
        @processor.process(:alert,
                           severity: 2,
                           category: Events::Alert::CATEGORY_VM_HEALTH,
                           source: agent.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.name' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L121" class="js-smell-location">0</a>                  <a href="instance_manager.html#L132" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
                           title: &quot;#{agent.id} has timed out&quot;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.id' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L113" class="js-smell-location">0</a>                  <a href="instance_manager.html#L122" class="js-smell-location">1</a>                  <a href="instance_manager.html#L133" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
                           created_at: ts,
                           deployment: agent.deployment,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
                           job: agent.job,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
                           instance_id: agent.instance_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
      end

      if agent.rogue?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.rogue?' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L129" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
        @processor.process(:alert,
                           :severity =&gt; 2,
                           :source =&gt; agent.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.name' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L121" class="js-smell-location">0</a>                  <a href="instance_manager.html#L132" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
                           :title =&gt; &quot;#{agent.id} is not a part of any deployment&quot;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent calls 'agent.id' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L113" class="js-smell-location">0</a>                  <a href="instance_manager.html#L122" class="js-smell-location">1</a>                  <a href="instance_manager.html#L133" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_agent refers to 'agent' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L109" class="js-smell-location">0</a>                  <a href="instance_manager.html#L113" class="js-smell-location">1</a>                  <a href="instance_manager.html#L117" class="js-smell-location">2</a>                  <a href="instance_manager.html#L121" class="js-smell-location">3</a>                  <a href="instance_manager.html#L122" class="js-smell-location">4</a>                  <a href="instance_manager.html#L124" class="js-smell-location">5</a>                  <a href="instance_manager.html#L125" class="js-smell-location">6</a>                  <a href="instance_manager.html#L126" class="js-smell-location">7</a>                  <a href="instance_manager.html#L129" class="js-smell-location">8</a>                  <a href="instance_manager.html#L132" class="js-smell-location">9</a>                  <a href="instance_manager.html#L133" class="js-smell-location">10</a>                  </div>  </li></ol>
                           :created_at =&gt; ts)
      end

      true
    end

    def analyze_instances<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instances has approx 9 statements</span>          </div>  </li></ol>
      @logger.info(&#39;Analyzing instances...&#39;)
      started = Time.now<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instances calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L142" class="js-smell-location">0</a>                  <a href="instance_manager.html#L152" class="js-smell-location">1</a>                  </div>  </li></ol>
      count = 0

      @deployment_name_to_deployments.values.each do |deployment|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_manager.html#L145" class="js-smell-location">0</a>                  <a href="instance_manager.html#L297" class="js-smell-location">1</a>                  </div>  </li></ol>
        deployment.instances.each do |instance|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instances contains iterators nested 2 deep</span>          </div>  </li></ol>
          analyze_instance(instance)
          count += 1
        end
      end

      @logger.info(&#39;Analyzed %s, took %s seconds&#39; % [pluralize(count, &#39;instance&#39;), Time.now - started])<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instances calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L142" class="js-smell-location">0</a>                  <a href="instance_manager.html#L152" class="js-smell-location">1</a>                  </div>  </li></ol>
      count
    end

    def analyze_instance(instance)
      if instance.expects_vm? &amp;&amp; !instance.has_vm?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L157" class="js-smell-location">0</a>                  <a href="instance_manager.html#L161" class="js-smell-location">1</a>                  <a href="instance_manager.html#L162" class="js-smell-location">2</a>                  <a href="instance_manager.html#L164" class="js-smell-location">3</a>                  <a href="instance_manager.html#L165" class="js-smell-location">4</a>                  <a href="instance_manager.html#L166" class="js-smell-location">5</a>                  </div>  </li></ol>
        @processor.process(:alert,
                           severity: 2,
                           category: Events::Alert::CATEGORY_VM_HEALTH,
                           source: instance.name,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L157" class="js-smell-location">0</a>                  <a href="instance_manager.html#L161" class="js-smell-location">1</a>                  <a href="instance_manager.html#L162" class="js-smell-location">2</a>                  <a href="instance_manager.html#L164" class="js-smell-location">3</a>                  <a href="instance_manager.html#L165" class="js-smell-location">4</a>                  <a href="instance_manager.html#L166" class="js-smell-location">5</a>                  </div>  </li></ol>
                           title: &quot;#{instance.id} has no VM&quot;,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance calls 'instance.id' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L162" class="js-smell-location">0</a>                  <a href="instance_manager.html#L166" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L157" class="js-smell-location">0</a>                  <a href="instance_manager.html#L161" class="js-smell-location">1</a>                  <a href="instance_manager.html#L162" class="js-smell-location">2</a>                  <a href="instance_manager.html#L164" class="js-smell-location">3</a>                  <a href="instance_manager.html#L165" class="js-smell-location">4</a>                  <a href="instance_manager.html#L166" class="js-smell-location">5</a>                  </div>  </li></ol>
                           created_at: Time.now.to_i,
                           deployment: instance.deployment,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L157" class="js-smell-location">0</a>                  <a href="instance_manager.html#L161" class="js-smell-location">1</a>                  <a href="instance_manager.html#L162" class="js-smell-location">2</a>                  <a href="instance_manager.html#L164" class="js-smell-location">3</a>                  <a href="instance_manager.html#L165" class="js-smell-location">4</a>                  <a href="instance_manager.html#L166" class="js-smell-location">5</a>                  </div>  </li></ol>
                           job: instance.job,<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L157" class="js-smell-location">0</a>                  <a href="instance_manager.html#L161" class="js-smell-location">1</a>                  <a href="instance_manager.html#L162" class="js-smell-location">2</a>                  <a href="instance_manager.html#L164" class="js-smell-location">3</a>                  <a href="instance_manager.html#L165" class="js-smell-location">4</a>                  <a href="instance_manager.html#L166" class="js-smell-location">5</a>                  </div>  </li></ol>
                           instance_id: instance.id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance calls 'instance.id' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L162" class="js-smell-location">0</a>                  <a href="instance_manager.html#L166" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_instance refers to 'instance' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L157" class="js-smell-location">0</a>                  <a href="instance_manager.html#L161" class="js-smell-location">1</a>                  <a href="instance_manager.html#L162" class="js-smell-location">2</a>                  <a href="instance_manager.html#L164" class="js-smell-location">3</a>                  <a href="instance_manager.html#L165" class="js-smell-location">4</a>                  <a href="instance_manager.html#L166" class="js-smell-location">5</a>                  </div>  </li></ol>
      end

      true
    end

    def process_event(kind, subject, payload = {})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event has a flog score of 38</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event has approx 21 statements</span>          </div>  </li></ol>
      kind = kind.to_s<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls 'kind.to_s' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L173" class="js-smell-location">0</a>                  <a href="instance_manager.html#L201" class="js-smell-location">1</a>                  </div>  </li></ol>
      agent_id = subject.split(&#39;.&#39;, 4).last
      agent = find_managed_agent_by_id(agent_id)

      if agent.nil? &amp;&amp; @rogue_agents[agent_id]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls '@rogue_agents[agent_id]' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L177" class="js-smell-location">0</a>                  <a href="instance_manager.html#L179" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls 'agent.nil?' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L177" class="js-smell-location">0</a>                  <a href="instance_manager.html#L180" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event performs a nil-check</span>              <span>Locations:</span>                  <a href="instance_manager.html#L177" class="js-smell-location">0</a>                  <a href="instance_manager.html#L180" class="js-smell-location">1</a>                  </div>  </li></ol>
        @logger.warn(&quot;Received #{kind} from unmanaged agent: #{agent_id}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls '@logger.warn("Received #{kind} from unmanaged agent: #{agent_id}")' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L178" class="js-smell-location">0</a>                  <a href="instance_manager.html#L186" class="js-smell-location">1</a>                  </div>  </li></ol>
        agent = @rogue_agents[agent_id]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls '@rogue_agents[agent_id]' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L177" class="js-smell-location">0</a>                  <a href="instance_manager.html#L179" class="js-smell-location">1</a>                  </div>  </li></ol>
      elsif agent.nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls 'agent.nil?' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L177" class="js-smell-location">0</a>                  <a href="instance_manager.html#L180" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event performs a nil-check</span>              <span>Locations:</span>                  <a href="instance_manager.html#L177" class="js-smell-location">0</a>                  <a href="instance_manager.html#L180" class="js-smell-location">1</a>                  </div>  </li></ol>
        # There might be more than a single shutdown event,
        # we are only interested in processing it if agent
        # is still managed
        return if kind == &#39;shutdown&#39;

        @logger.warn(&quot;Received #{kind} from unmanaged agent: #{agent_id}&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls '@logger.warn("Received #{kind} from unmanaged agent: #{agent_id}")' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L178" class="js-smell-location">0</a>                  <a href="instance_manager.html#L186" class="js-smell-location">1</a>                  </div>  </li></ol>
        agent = Agent.new(agent_id)
        @rogue_agents[agent_id] = agent
      else
        @logger.debug(&quot;Received #{kind} from #{agent_id}: #{payload}&quot;)
      end

      case payload
        when String
          message = JSON.parse(payload)
        when Hash
          message = payload
      end

      deployment = @deployment_name_to_deployments[agent.deployment]
      case kind.to_s<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event calls 'kind.to_s' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L173" class="js-smell-location">0</a>                  <a href="instance_manager.html#L201" class="js-smell-location">1</a>                  </div>  </li></ol>
        when &#39;alert&#39;
          on_alert(agent, message)
        when &#39;heartbeat&#39;
          on_heartbeat(agent, deployment, message)
        when &#39;shutdown&#39;
          on_shutdown(agent)
        else
          @logger.warn(&quot;No handler found for &#39;#{kind}&#39; event&quot;)
      end

    rescue JSON::ParserError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event has the variable name 'e'</span>              <span>Locations:</span>                  <a href="instance_manager.html#L212" class="js-smell-location">0</a>                  <a href="instance_manager.html#L214" class="js-smell-location">1</a>                  </div>  </li></ol>
      @logger.error(&quot;Cannot parse incoming event: #{e}&quot;)
    rescue Bhm::InvalidEvent =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#process_event has the variable name 'e'</span>              <span>Locations:</span>                  <a href="instance_manager.html#L212" class="js-smell-location">0</a>                  <a href="instance_manager.html#L214" class="js-smell-location">1</a>                  </div>  </li></ol>
      @logger.error(&quot;Invalid event: #{e}&quot;)
    end

    def instances_count
      @deployment_name_to_deployments.values.inject(0) { |count, deployment| count + deployment.instances.size }
    end

    private

    def lookup_plugin(name, options = {})<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#lookup_plugin has approx 6 statements</span>          </div>  </li></ol>
      plugin_class = nil
      begin
        class_name = name.to_s.split(&#39;_&#39;).map(&amp;:capitalize).join
        plugin_class = Bosh::Monitor::Plugins.const_get(class_name)
      rescue NameError =&gt; e<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank"><b>UncommunicativeVariableName</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#lookup_plugin has the variable name 'e'</span>          </div>  </li></ol>
        raise PluginError, &quot;Cannot find &#39;#{name}&#39; plugin&quot;
      end

      plugin_class.new(options)
    end

    def remove_agent(agent_id)
      @logger.info(&quot;Removing agent #{agent_id} from all deployments...&quot;)
      @rogue_agents.delete(agent_id)
      @deployment_name_to_deployments.values.each { |deployment| deployment.remove_agent(agent_id) }
    end

    def remove_deployment(name)
      deployment = @deployment_name_to_deployments[name]
      deployment.agent_ids.each { |agent_id| @rogue_agents.delete(agent_id) }
      @deployment_name_to_deployments.delete(name)
    end

    def on_alert(agent, message)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_alert has approx 6 statements</span>          </div>  </li></ol>
      if message.is_a?(Hash) &amp;&amp; !message.has_key?(&#39;source&#39;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_alert refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L249" class="js-smell-location">0</a>                  <a href="instance_manager.html#L250" class="js-smell-location">1</a>                  <a href="instance_manager.html#L251" class="js-smell-location">2</a>                  <a href="instance_manager.html#L252" class="js-smell-location">3</a>                  <a href="instance_manager.html#L253" class="js-smell-location">4</a>                  </div>  </li></ol>
        message[&#39;source&#39;] = agent.name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_alert refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L249" class="js-smell-location">0</a>                  <a href="instance_manager.html#L250" class="js-smell-location">1</a>                  <a href="instance_manager.html#L251" class="js-smell-location">2</a>                  <a href="instance_manager.html#L252" class="js-smell-location">3</a>                  <a href="instance_manager.html#L253" class="js-smell-location">4</a>                  </div>  </li></ol>
        message[&#39;deployment&#39;] = agent.deployment<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_alert refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L249" class="js-smell-location">0</a>                  <a href="instance_manager.html#L250" class="js-smell-location">1</a>                  <a href="instance_manager.html#L251" class="js-smell-location">2</a>                  <a href="instance_manager.html#L252" class="js-smell-location">3</a>                  <a href="instance_manager.html#L253" class="js-smell-location">4</a>                  </div>  </li></ol>
        message[&#39;job&#39;] = agent.job<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_alert refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L249" class="js-smell-location">0</a>                  <a href="instance_manager.html#L250" class="js-smell-location">1</a>                  <a href="instance_manager.html#L251" class="js-smell-location">2</a>                  <a href="instance_manager.html#L252" class="js-smell-location">3</a>                  <a href="instance_manager.html#L253" class="js-smell-location">4</a>                  </div>  </li></ol>
        message[&#39;instance_id&#39;] = agent.instance_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_alert refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L249" class="js-smell-location">0</a>                  <a href="instance_manager.html#L250" class="js-smell-location">1</a>                  <a href="instance_manager.html#L251" class="js-smell-location">2</a>                  <a href="instance_manager.html#L252" class="js-smell-location">3</a>                  <a href="instance_manager.html#L253" class="js-smell-location">4</a>                  </div>  </li></ol>
      end

      @processor.process(:alert, message)
      @alerts_processed += 1
    end

    def on_shutdown(agent)
      @logger.info(&quot;Agent &#39;#{agent.id}&#39; shutting down...&quot;)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_shutdown calls 'agent.id' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L261" class="js-smell-location">0</a>                  <a href="instance_manager.html#L262" class="js-smell-location">1</a>                  </div>  </li></ol>
      remove_agent(agent.id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_shutdown calls 'agent.id' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L261" class="js-smell-location">0</a>                  <a href="instance_manager.html#L262" class="js-smell-location">1</a>                  </div>  </li></ol>
    end

    def on_heartbeat(agent, deployment, message)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flog/" target="_blank"><b>HighComplexity</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat has a flog score of 27</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat has approx 11 statements</span>          </div>  </li></ol>
      agent.updated_at = Time.now<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L266" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  </div>  </li></ol>

      if message.is_a?(Hash)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li></ol>
        message[&#39;timestamp&#39;] = Time.now.to_i if message[&#39;timestamp&#39;].nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat calls 'Time.now' 2 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L266" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat performs a nil-check</span>              <span>Locations:</span>                  <a href="instance_manager.html#L269" class="js-smell-location">0</a>                  <a href="instance_manager.html#L276" class="js-smell-location">1</a>                  </div>  </li></ol>
        message[&#39;agent_id&#39;] = agent.id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li></ol>
        message[&#39;deployment&#39;] = agent.deployment<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li></ol>
        message[&#39;job&#39;] = agent.job<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li></ol>
        message[&#39;instance_id&#39;] = agent.instance_id<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li></ol>
        message[&#39;teams&#39;] = deployment ? deployment.teams : []<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank"><b>RepeatedConditional</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager tests 'deployment' at least 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L27" class="js-smell-location">0</a>                  <a href="instance_manager.html#L32" class="js-smell-location">1</a>                  <a href="instance_manager.html#L274" class="js-smell-location">2</a>                  </div>  </li></ol>

        if message[&#39;instance_id&#39;].nil? || message[&#39;job&#39;].nil? || message[&#39;deployment&#39;].nil?<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat refers to 'message' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L268" class="js-smell-location">0</a>                  <a href="instance_manager.html#L269" class="js-smell-location">1</a>                  <a href="instance_manager.html#L270" class="js-smell-location">2</a>                  <a href="instance_manager.html#L271" class="js-smell-location">3</a>                  <a href="instance_manager.html#L272" class="js-smell-location">4</a>                  <a href="instance_manager.html#L273" class="js-smell-location">5</a>                  <a href="instance_manager.html#L274" class="js-smell-location">6</a>                  <a href="instance_manager.html#L276" class="js-smell-location">7</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank"><b>NilCheck</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#on_heartbeat performs a nil-check</span>              <span>Locations:</span>                  <a href="instance_manager.html#L269" class="js-smell-location">0</a>                  <a href="instance_manager.html#L276" class="js-smell-location">1</a>                  </div>  </li></ol>
          return
        end
      end

      @processor.process(:heartbeat, message)
      @heartbeats_received += 1
    end

    def analyze_rogue_agents<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_rogue_agents has approx 6 statements</span>          </div>  </li></ol>
      count = 0
      @rogue_agents.keys.each do |agent_id|
        @logger.warn(&quot;Agent #{agent_id} is not a part of any deployment&quot;)
        analyze_agent(@rogue_agents[agent_id])
        count += 1
      end
      count
    end

    def analyze_deployment_agents<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_deployment_agents has approx 6 statements</span>          </div>  </li></ol>
      count = 0
      @deployment_name_to_deployments.values.each do |deployment|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="http://docs.seattlerb.org/flay/" target="_blank"><b>DuplicateCode</b></a>        </span>      </div>      <span>Similar code found in 2 nodes</span>              <span>Locations:</span>                  <a href="instance_manager.html#L145" class="js-smell-location">0</a>                  <a href="instance_manager.html#L297" class="js-smell-location">1</a>                  </div>  </li></ol>
        deployment.agents.each do |agent|<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank"><b>NestedIterators</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#analyze_deployment_agents contains iterators nested 2 deep</span>          </div>  </li></ol>
          analyze_agent(agent)
          count += 1
        end
      end
      count
    end

    def all_managed_agent_ids
      agent_ids = Set.new
      @deployment_name_to_deployments.values.each do |deployment|
        agent_ids.merge(deployment.agent_ids)
      end
      agent_ids
    end

    def all_managed_deleted_agents
      agents = Set.new
      @deployment_name_to_deployments.values.each do |deployment|
        agents.merge(deployment.instance_id_to_agent.values)
      end
      agents
    end

    def find_managed_agent_by_id(agent_id)
      @deployment_name_to_deployments.values.each do |deployment|
        return deployment.agent(agent_id) if deployment.agent(agent_id)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#find_managed_agent_by_id calls 'deployment.agent(agent_id)' 2 times</span>          </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#find_managed_agent_by_id refers to 'deployment' more than self (maybe move it to another class?)</span>          </div>  </li></ol>
      end
      nil
    end

    def remove_inactive_deployments(active_deployment_names)
      all = Set.new(@deployment_name_to_deployments.keys)
      (all - active_deployment_names).each do |stale_deployment|
        @logger.warn(&quot;Found stale deployment #{stale_deployment}, removing...&quot;)
        remove_deployment(stale_deployment)
      end
    end

    def sync_active_deployments(deployments)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank"><b>TooManyStatements</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_deployments has approx 6 statements</span>          </div>  </li></ol>
      active_deployment_names = Set.new
      deployments.each do |deployment_data|
        deployment = Deployment.create(deployment_data)
        unless @deployment_name_to_deployments[deployment.name]<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_deployments calls 'deployment.name' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L341" class="js-smell-location">0</a>                  <a href="instance_manager.html#L342" class="js-smell-location">1</a>                  <a href="instance_manager.html#L344" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_deployments refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L341" class="js-smell-location">0</a>                  <a href="instance_manager.html#L342" class="js-smell-location">1</a>                  <a href="instance_manager.html#L344" class="js-smell-location">2</a>                  </div>  </li></ol>
          @deployment_name_to_deployments[deployment.name] = deployment<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_deployments calls 'deployment.name' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L341" class="js-smell-location">0</a>                  <a href="instance_manager.html#L342" class="js-smell-location">1</a>                  <a href="instance_manager.html#L344" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_deployments refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L341" class="js-smell-location">0</a>                  <a href="instance_manager.html#L342" class="js-smell-location">1</a>                  <a href="instance_manager.html#L344" class="js-smell-location">2</a>                  </div>  </li></ol>
        end
        active_deployment_names &lt;&lt; deployment.name<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank"><b>DuplicateMethodCall</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_deployments calls 'deployment.name' 3 times</span>              <span>Locations:</span>                  <a href="instance_manager.html#L341" class="js-smell-location">0</a>                  <a href="instance_manager.html#L342" class="js-smell-location">1</a>                  <a href="instance_manager.html#L344" class="js-smell-location">2</a>                  </div>  </li>  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank"><b>FeatureEnvy</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_deployments refers to 'deployment' more than self (maybe move it to another class?)</span>              <span>Locations:</span>                  <a href="instance_manager.html#L341" class="js-smell-location">0</a>                  <a href="instance_manager.html#L342" class="js-smell-location">1</a>                  <a href="instance_manager.html#L344" class="js-smell-location">2</a>                  </div>  </li></ol>
      end
      active_deployment_names
    end

    def remove_inactive_instances(active_instances_ids, deployment)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#remove_inactive_instances doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      (deployment.instance_ids - active_instances_ids).each do |instance_id|
        deployment.remove_instance(instance_id)
      end
    end

    def sync_active_instances(deployment, instances_data)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_instances doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      active_instances_ids = Set.new
      instances_data.each do |instance_data|
        instance = Bhm::Instance.create(instance_data)
        if deployment.add_instance(instance)
          active_instances_ids &lt;&lt; instance.id
        end
      end
      active_instances_ids
    end

    def remove_inactive_agents(active_agent_ids, deployment)
      (deployment.agent_ids - active_agent_ids).each do |agent_id|
        remove_agent(agent_id)
      end
    end

    def sync_active_agents(deployment, instances)<ol class="nocode errors smells">  <li>    <div class="description">      <div class="heading">        <span>          <i class="fa fa-warning" aria-hidden"true"=""></i>          <a href="https://github.com/troessner/reek/blob/master/docs/Utility-Function.md" target="_blank"><b>UtilityFunction</b></a>        </span>      </div>      <span>Bosh::Monitor::InstanceManager#sync_active_agents doesn't depend on instance state (maybe move it to another class?)</span>          </div>  </li></ol>
      active_agent_ids = Set.new
      instances.each do |instance|
        if deployment.upsert_agent(instance)
          active_agent_ids &lt;&lt; instance.agent_id
        end
      end
      active_agent_ids
    end

    def update_rogue_agents(deployment_agents)
      deployment_agents.each { |agent_id| @rogue_agents.delete(agent_id) }
    end

    def sync_teams(deployment)
      deployment_name = deployment[&#39;name&#39;]
      deployment_model = @deployment_name_to_deployments[deployment_name]
      deployment_model.update_teams(deployment[&#39;teams&#39;])
      @deployment_name_to_deployments[deployment_name] = deployment_model
    end
  end
end
</code>
  </div>
</div>

        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src='../../../../assets/javascripts/jquery.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo.min.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/prettify.js'></script>
    <script src='../../../../assets/javascripts/bootstrap.min.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
    <script src='../../../../assets/javascripts/jquery.filtertable.min.js'></script>
  </body>
</html>
